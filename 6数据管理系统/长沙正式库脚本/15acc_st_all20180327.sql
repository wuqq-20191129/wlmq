-----------------------------------------------
-- Export file for user ACC_ST               --
-- Created by ACC-001 on 2018/3/27, 10:56:39 --
-----------------------------------------------

set define off
spool 15acc_st_all20180327.log

prompt
prompt Creating table OP_CFG_REPORT_PASS
prompt =================================
prompt
create table ACC_ST.OP_CFG_REPORT_PASS
(
  ds_id    VARCHAR2(50) not null,
  ds_user  VARCHAR2(20) not null,
  ds_pass  VARCHAR2(200) not null,
  remark   VARCHAR2(200),
  enc_flag VARCHAR2(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_CFG_REPORT_PASS
  add constraint OP_CFG_REPORT_PASS_PK primary key (DS_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_CFG_REPORT_PASS to ACC_ST_APP;
grant select on ACC_ST.OP_CFG_REPORT_PASS to ACC_ST_DEV;
grant select on ACC_ST.OP_CFG_REPORT_PASS to ACC_ST_RPT;

prompt
prompt Creating table OP_CFG_SYS
prompt =========================
prompt
create table ACC_ST.OP_CFG_SYS
(
  type          VARCHAR2(3) not null,
  type_name     VARCHAR2(100) not null,
  type_sub      VARCHAR2(3) not null,
  type_sub_name VARCHAR2(100) not null,
  config_name   VARCHAR2(100) not null,
  config_value  VARCHAR2(550) not null,
  remark        VARCHAR2(250)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_CFG_SYS
  add constraint OP_CFG_SYS_PK primary key (TYPE, TYPE_SUB, CONFIG_NAME)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_CFG_SYS to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_CFG_SYS to ACC_ST_APP;
grant select on ACC_ST.OP_CFG_SYS to ACC_ST_DEV;
grant select on ACC_ST.OP_CFG_SYS to ACC_ST_RPT;
grant select on ACC_ST.OP_CFG_SYS to ACC_TK_APP;
grant select on ACC_ST.OP_CFG_SYS to ACC_TK_DEV;
grant select on ACC_ST.OP_CFG_SYS to ACC_TK_RPT;

prompt
prompt Creating table OP_CM_CFG_PARA_FLE_SZ
prompt ====================================
prompt
create table ACC_ST.OP_CM_CFG_PARA_FLE_SZ
(
  parm_type_id CHAR(4) not null,
  chk_operator VARCHAR2(2) not null,
  chk_size     INTEGER not null,
  check_flag   VARCHAR2(1) default '1' not null,
  remark       VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
alter table ACC_ST.OP_CM_CFG_PARA_FLE_SZ
  add constraint OP_CM_CFG_PARA_FLE_SZ_PK primary key (PARM_TYPE_ID, CHK_OPERATOR)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.OP_CM_CFG_PARA_FLE_SZ to ACC_ST_APP;
grant select on ACC_ST.OP_CM_CFG_PARA_FLE_SZ to ACC_ST_DEV;
grant select on ACC_ST.OP_CM_CFG_PARA_FLE_SZ to ACC_ST_RPT;

prompt
prompt Creating table OP_CM_DEV_CURRENT_STATUS
prompt =======================================
prompt
create table ACC_ST.OP_CM_DEV_CURRENT_STATUS
(
  line_id          VARCHAR2(2) not null,
  station_id       VARCHAR2(2) not null,
  dev_type_id      VARCHAR2(2) not null,
  device_id        VARCHAR2(4) not null,
  status_id        VARCHAR2(4),
  status_value     VARCHAR2(3),
  status_datetime  DATE,
  acc_status_value VARCHAR2(1),
  oper_id          VARCHAR2(6)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_CM_DEV_CURRENT_STATUS
  add constraint PK_OP_CM_DEV_CURRENT_STATUS primary key (LINE_ID, STATION_ID, DEV_TYPE_ID, DEVICE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_CM_DEV_CURRENT_STATUS to ACC_ST_APP;
grant select on ACC_ST.OP_CM_DEV_CURRENT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.OP_CM_DEV_CURRENT_STATUS to ACC_ST_RPT;

prompt
prompt Creating table OP_CM_DEV_ERROR_STATUS
prompt =====================================
prompt
create table ACC_ST.OP_CM_DEV_ERROR_STATUS
(
  line_id          VARCHAR2(2) not null,
  station_id       VARCHAR2(2) not null,
  dev_type_id      VARCHAR2(2) not null,
  device_id        VARCHAR2(4) not null,
  status_id        VARCHAR2(4) not null,
  status_value     VARCHAR2(3) not null,
  status_datetime  DATE,
  acc_status_value VARCHAR2(1),
  oper_id          VARCHAR2(6)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_CM_DEV_ERROR_STATUS to ACC_ST_APP;
grant select on ACC_ST.OP_CM_DEV_ERROR_STATUS to ACC_ST_DEV;
grant select on ACC_ST.OP_CM_DEV_ERROR_STATUS to ACC_ST_RPT;

prompt
prompt Creating table OP_CM_DEV_EVENT
prompt ==============================
prompt
create table ACC_ST.OP_CM_DEV_EVENT
(
  event_datetime DATE,
  line_id        VARCHAR2(2),
  station_id     VARCHAR2(2),
  dev_type_id    VARCHAR2(2),
  device_id      VARCHAR2(4),
  event_id       VARCHAR2(2),
  event_argument VARCHAR2(32)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_CM_DEV_EVENT to ACC_ST_APP;
grant select on ACC_ST.OP_CM_DEV_EVENT to ACC_ST_DEV;
grant select on ACC_ST.OP_CM_DEV_EVENT to ACC_ST_RPT;

prompt
prompt Creating table OP_CM_DEV_PARA_VER_QRY
prompt =====================================
prompt
create table ACC_ST.OP_CM_DEV_PARA_VER_QRY
(
  water_no    NUMBER(18),
  line_id     CHAR(2) not null,
  station_id  CHAR(2) not null,
  dev_type_id CHAR(2) not null,
  device_id   CHAR(3) not null,
  status      VARCHAR2(1) not null,
  query_date  DATE not null,
  send_date   DATE,
  operator_id VARCHAR2(8),
  remark      VARCHAR2(50),
  lcc_line_id CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_CM_DEV_PARA_VER_QRY to ACC_ST_APP;
grant select on ACC_ST.OP_CM_DEV_PARA_VER_QRY to ACC_ST_DEV;
grant select on ACC_ST.OP_CM_DEV_PARA_VER_QRY to ACC_ST_RPT;

prompt
prompt Creating table OP_CM_LOG_PARA_FLE_CHK
prompt =====================================
prompt
create table ACC_ST.OP_CM_LOG_PARA_FLE_CHK
(
  water_no     NUMBER(18) not null,
  parm_type_id CHAR(4) not null,
  version_no   CHAR(10) not null,
  version_type CHAR(1) not null,
  error_code   VARCHAR2(2) not null,
  check_time   DATE not null,
  remark       VARCHAR2(256)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_CM_LOG_PARA_FLE_CHK
  add constraint OP_CM_LOG_PARA_FLE_CHK_PK primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_CM_LOG_PARA_FLE_CHK to ACC_ST_APP;
grant select on ACC_ST.OP_CM_LOG_PARA_FLE_CHK to ACC_ST_DEV;
grant select on ACC_ST.OP_CM_LOG_PARA_FLE_CHK to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_AGENT
prompt ===========================
prompt
create table ACC_ST.OP_COD_AGENT
(
  agent_id    CHAR(2) not null,
  agent_name  VARCHAR2(50),
  link_man    VARCHAR2(8),
  tel         VARCHAR2(15),
  fax         VARCHAR2(15),
  record_flag CHAR(1) not null,
  version_no  CHAR(10),
  sequence    CHAR(2) default '00'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_AGENT
  is '¥˙¿Ì…Ã';
alter table ACC_ST.OP_COD_AGENT
  add constraint PK_OP_PRM_AGENT primary key (AGENT_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_AGENT to ACC_ST_APP;
grant select on ACC_ST.OP_COD_AGENT to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_AGENT to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_BTN_TYPE
prompt ==============================
prompt
create table ACC_ST.OP_COD_BTN_TYPE
(
  btn_id   CHAR(2) not null,
  btn_code VARCHAR2(20) not null,
  btn_name VARCHAR2(50) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_COD_BTN_TYPE
  add constraint PK_OP_COD_BTN_TYPE primary key (BTN_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_COD_BTN_TYPE
  add constraint UK_OP_COD_BTN_TYPE unique (BTN_NAME)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_BTN_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_BTN_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_BTN_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_COM_STATUS_MAPPING
prompt ========================================
prompt
create table ACC_ST.OP_COD_COM_STATUS_MAPPING
(
  status_id        CHAR(3) not null,
  status_value     CHAR(1) not null,
  acc_status_value CHAR(1),
  status_name      VARCHAR2(50),
  acc_status_name  VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_COM_STATUS_MAPPING
  is '(¥˙¬Î)…Ë±∏‘À”™◊¥Ã¨¥˙¬Î';
alter table ACC_ST.OP_COD_COM_STATUS_MAPPING
  add constraint PK_OP_COD_COM_STATUS_MAPPING primary key (STATUS_ID, STATUS_VALUE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_COMMU_APP;
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_COMMU_DEV;
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_ST_APP;
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_ST_RPT;
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_TK_DEV;
grant select on ACC_ST.OP_COD_COM_STATUS_MAPPING to ACC_TK_RPT;

prompt
prompt Creating table OP_COD_DAY_OF_WEEK
prompt =================================
prompt
create table ACC_ST.OP_COD_DAY_OF_WEEK
(
  day_of_week      CHAR(1) not null,
  day_chinese_desc VARCHAR2(10),
  day_english_name VARCHAR2(15)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_COD_DAY_OF_WEEK
  add constraint PK_OP_COD_DAY_OF_WEEK primary key (DAY_OF_WEEK)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_DAY_OF_WEEK to ACC_ST_APP;
grant select on ACC_ST.OP_COD_DAY_OF_WEEK to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_DAY_OF_WEEK to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_DEGRADE_TYPE
prompt ==================================
prompt
create table ACC_ST.OP_COD_DEGRADE_TYPE
(
  status_id   VARCHAR2(18) not null,
  status_name VARCHAR2(20),
  hdl_flag    CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_DEGRADE_TYPE
  is 'Ωµº∂‘À”™ƒ£ Ω';
alter table ACC_ST.OP_COD_DEGRADE_TYPE
  add constraint PK_OP_COD_DEGRADE_TYPE primary key (STATUS_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_DEGRADE_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_DEGRADE_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_DEGRADE_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_DEV_REG
prompt =============================
prompt
create table ACC_ST.OP_COD_DEV_REG
(
  dev_type_id CHAR(2) not null,
  reg_code    CHAR(3) not null,
  reg_desc    VARCHAR2(40)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_COD_DEV_REG
  add constraint KEY1 primary key (DEV_TYPE_ID, REG_CODE)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_DEV_REG to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.OP_COD_DEV_REG to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.OP_COD_DEV_REG to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_DEV_TYPE
prompt ==============================
prompt
create table ACC_ST.OP_COD_DEV_TYPE
(
  dev_type_id   CHAR(2) not null,
  dev_type_name VARCHAR2(40),
  record_flag   CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_DEV_TYPE
  is '≤Œ ˝…˙≥……Ë±∏¿‡–Õ±Ì';
comment on column ACC_ST.OP_COD_DEV_TYPE.record_flag
  is '0Œ™”––ß';
alter table ACC_ST.OP_COD_DEV_TYPE
  add constraint PK_OP_COD_DEV_TYPE primary key (DEV_TYPE_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_DEV_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_DEV_TYPE to ACC_ST_DEV;

prompt
prompt Creating table OP_COD_HOLIDAY_TYPE
prompt ==================================
prompt
create table ACC_ST.OP_COD_HOLIDAY_TYPE
(
  holiday_type VARCHAR2(3) not null,
  holiday_desc VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_HOLIDAY_TYPE
  is 'Ω⁄»’¿‡–Õ∂®“Â';
alter table ACC_ST.OP_COD_HOLIDAY_TYPE
  add constraint PK_OP_COD_HOLIDAY_TYPE primary key (HOLIDAY_TYPE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_HOLIDAY_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_HOLIDAY_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_HOLIDAY_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_LINE_TYPE
prompt ===============================
prompt
create table ACC_ST.OP_COD_LINE_TYPE
(
  type_id     VARCHAR2(2) not null,
  line_id     VARCHAR2(2) not null,
  line_name   VARCHAR2(50),
  description VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_LINE_TYPE
  is '¥Ûœﬂ¬∑«¯∑÷±Ì';
comment on column ACC_ST.OP_COD_LINE_TYPE.type_id
  is '¥Ûœﬂ¬∑ID';
comment on column ACC_ST.OP_COD_LINE_TYPE.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.OP_COD_LINE_TYPE.line_name
  is 'œﬂ¬∑√˚≥∆';
comment on column ACC_ST.OP_COD_LINE_TYPE.description
  is 'Àµ√˜';
alter table ACC_ST.OP_COD_LINE_TYPE
  add primary key (TYPE_ID, LINE_ID)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_LINE_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_LINE_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_LINE_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_PARM_DOWN_TYPE
prompt ====================================
prompt
create table ACC_ST.OP_COD_PARM_DOWN_TYPE
(
  parm_type_id        CHAR(4) not null,
  parm_type_name      VARCHAR2(50),
  parm_type_down_type VARCHAR2(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_PARM_DOWN_TYPE
  is '≤Œ ˝œ¬∑¢πÈ¿‡±Ì';
comment on column ACC_ST.OP_COD_PARM_DOWN_TYPE.parm_type_down_type
  is '1£∫œﬂÕ¯ 2£∫µ•œﬂ¬∑';
grant select, insert, update, delete on ACC_ST.OP_COD_PARM_DOWN_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_PARM_DOWN_TYPE to ACC_ST_DEV;

prompt
prompt Creating table OP_COD_PARM_TYPE
prompt ===============================
prompt
create table ACC_ST.OP_COD_PARM_TYPE
(
  parm_type_id   CHAR(4) not null,
  parm_type_name VARCHAR2(50),
  down_all_line  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_PARM_TYPE
  is '≤Œ ˝¿‡–Õ';
comment on column ACC_ST.OP_COD_PARM_TYPE.down_all_line
  is '0÷ªƒ‹œ¬∑¢À˘”– 1ø…œ¬∑¢œﬂ¬∑ 2≤ªø…œ¬∑¢';
alter table ACC_ST.OP_COD_PARM_TYPE
  add constraint PK_OP_COD_PARM_TYPE primary key (PARM_TYPE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_PARM_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_PARM_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_PARM_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_PUB_FLAG
prompt ==============================
prompt
create table ACC_ST.OP_COD_PUB_FLAG
(
  type        INTEGER not null,
  code        VARCHAR2(50) not null,
  code_text   VARCHAR2(50),
  description VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_COD_PUB_FLAG
  add constraint PK_OP_COD_PUB_FLAG primary key (TYPE, CODE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_COD_PUB_FLAG to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_COD_PUB_FLAG to ACC_ST_APP;
grant select on ACC_ST.OP_COD_PUB_FLAG to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_PUB_FLAG to ACC_ST_RPT;
grant select on ACC_ST.OP_COD_PUB_FLAG to ACC_TK_APP;
grant select on ACC_ST.OP_COD_PUB_FLAG to ACC_TK_DEV;
grant select on ACC_ST.OP_COD_PUB_FLAG to ACC_TK_RPT;

prompt
prompt Creating table OP_COD_STORE
prompt ===========================
prompt
create table ACC_ST.OP_COD_STORE
(
  store_id    VARCHAR2(5) not null,
  store_name  VARCHAR2(18),
  link_man    VARCHAR2(8),
  tel         VARCHAR2(15),
  fax         VARCHAR2(15),
  terminal_no VARCHAR2(8),
  address     VARCHAR2(50),
  record_flag CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_STORE
  is '…Ãªß';
alter table ACC_ST.OP_COD_STORE
  add constraint PK_OP_COD_STORE primary key (STORE_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_STORE to ACC_ST_APP;
grant select on ACC_ST.OP_COD_STORE to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_STORE to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_TIME
prompt ==========================
prompt
create table ACC_ST.OP_COD_TIME
(
  time_code   CHAR(1) not null,
  time_symbol VARCHAR2(18),
  time_desc   VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_COD_TIME
  add constraint PK_OP_COD_TIME primary key (TIME_CODE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_TIME to ACC_ST_APP;
grant select on ACC_ST.OP_COD_TIME to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_TIME to ACC_ST_RPT;

prompt
prompt Creating table OP_COD_TIME_SECTION
prompt ==================================
prompt
create table ACC_ST.OP_COD_TIME_SECTION
(
  time_section_id   CHAR(2) not null,
  begin_time        DATE,
  end_time          DATE,
  time_section_name VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_COD_TIME_SECTION
  is ' ±º‰∂Œ';
alter table ACC_ST.OP_COD_TIME_SECTION
  add constraint PK_OP_COD_TIME_SECTION primary key (TIME_SECTION_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_COD_TIME_SECTION to ACC_ST_APP;
grant select on ACC_ST.OP_COD_TIME_SECTION to ACC_ST_DEV;
grant select on ACC_ST.OP_COD_TIME_SECTION to ACC_ST_RPT;

prompt
prompt Creating table OP_DM_SYN_CONFIG
prompt ===============================
prompt
create table ACC_ST.OP_DM_SYN_CONFIG
(
  src_table      VARCHAR2(40) not null,
  src_db         VARCHAR2(40) not null,
  dest_table     VARCHAR2(40) not null,
  dest_db        VARCHAR2(40) not null,
  dest_table_bak VARCHAR2(40) not null,
  keep_days      INTEGER not null,
  column_names   VARCHAR2(500)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_DM_SYN_CONFIG to ACC_ST_APP;
grant select on ACC_ST.OP_DM_SYN_CONFIG to ACC_ST_DEV;
grant select on ACC_ST.OP_DM_SYN_CONFIG to ACC_ST_RPT;

prompt
prompt Creating table OP_DM_SYN_LOG
prompt ============================
prompt
create table ACC_ST.OP_DM_SYN_LOG
(
  src_db     VARCHAR2(30),
  src_table  VARCHAR2(30),
  dest_db    VARCHAR2(30),
  dest_table VARCHAR2(30),
  syn_time   DATE,
  status     INTEGER,
  nums       INTEGER,
  remark     VARCHAR2(150)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_DM_SYN_LOG.status
  is '0:≥…π¶£ª1: ß∞‹';
grant select, insert, update, delete on ACC_ST.OP_DM_SYN_LOG to ACC_ST_APP;
grant select on ACC_ST.OP_DM_SYN_LOG to ACC_ST_DEV;
grant select on ACC_ST.OP_DM_SYN_LOG to ACC_ST_RPT;

prompt
prompt Creating table OP_DM_SYS_VERSION
prompt ================================
prompt
create table ACC_ST.OP_DM_SYS_VERSION
(
  version_no  VARCHAR2(10) not null,
  operator_id VARCHAR2(10),
  valid_date  CHAR(10),
  del_desc    VARCHAR2(255),
  update_desc VARCHAR2(255),
  add_desc    VARCHAR2(255),
  note        VARCHAR2(255)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_DM_SYS_VERSION to ACC_ST_APP;

prompt
prompt Creating table OP_DM_TASK_CONFIG
prompt ================================
prompt
create table ACC_ST.OP_DM_TASK_CONFIG
(
  classname VARCHAR2(100),
  taskname  VARCHAR2(50) not null,
  interval  INTEGER,
  starttime VARCHAR2(50),
  status    INTEGER,
  remark    VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_DM_TASK_CONFIG.starttime
  is '∏Ò Ω°∞HHmm°±';
comment on column ACC_ST.OP_DM_TASK_CONFIG.status
  is '0:Õ£÷π◊¥Ã¨£ª1-‘À––◊¥Ã¨';
alter table ACC_ST.OP_DM_TASK_CONFIG
  add constraint PK_OP_DM_TASK_CONFIG primary key (TASKNAME)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_DM_TASK_CONFIG to ACC_ST_APP;
grant select on ACC_ST.OP_DM_TASK_CONFIG to ACC_ST_DEV;
grant select on ACC_ST.OP_DM_TASK_CONFIG to ACC_ST_RPT;

prompt
prompt Creating table OP_DM_TASK_LOG
prompt =============================
prompt
create table ACC_ST.OP_DM_TASK_LOG
(
  task_name   VARCHAR2(50),
  task_desc   VARCHAR2(100),
  start_time  DATE,
  end_time    DATE,
  task_result INTEGER,
  result_desc VARCHAR2(150),
  water_no    INTEGER
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_DM_TASK_LOG.task_result
  is '0:’˝≥£Ω· ¯
1:“Ï≥£Ω· ¯
2:œﬂ≥Ãπ“∆';
grant select, insert, update, delete on ACC_ST.OP_DM_TASK_LOG to ACC_ST_APP;
grant select on ACC_ST.OP_DM_TASK_LOG to ACC_ST_DEV;
grant select on ACC_ST.OP_DM_TASK_LOG to ACC_ST_RPT;

prompt
prompt Creating table OP_HIS_BLACK_LIST_MTR
prompt ====================================
prompt
create table ACC_ST.OP_HIS_BLACK_LIST_MTR
(
  gen_datetime     DATE,
  card_logical_id  VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  balance_water_no CHAR(10),
  operator_id      VARCHAR2(20),
  is_set           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_HIS_BLACK_LIST_MTR to ACC_ST_APP;
grant select on ACC_ST.OP_HIS_BLACK_LIST_MTR to ACC_ST_DEV;
grant select on ACC_ST.OP_HIS_BLACK_LIST_MTR to ACC_ST_RPT;

prompt
prompt Creating table OP_HIS_BLACK_LIST_MTR_SEC
prompt ========================================
prompt
create table ACC_ST.OP_HIS_BLACK_LIST_MTR_SEC
(
  gen_datetime     DATE,
  begin_logical_id VARCHAR2(20) not null,
  end_logical_id   VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  balance_water_no CHAR(10),
  operator_id      VARCHAR2(20),
  is_set           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_HIS_BLACK_LIST_MTR_SEC to ACC_ST_APP;
grant select on ACC_ST.OP_HIS_BLACK_LIST_MTR_SEC to ACC_ST_DEV;
grant select on ACC_ST.OP_HIS_BLACK_LIST_MTR_SEC to ACC_ST_RPT;

prompt
prompt Creating table OP_HIS_PHY_LOGIC_LIST
prompt ====================================
prompt
create table ACC_ST.OP_HIS_PHY_LOGIC_LIST
(
  physic_no   VARCHAR2(20) not null,
  logic_no    VARCHAR2(20) not null,
  insert_time DATE default SYSDATE,
  water_no    NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_HIS_PHY_LOGIC_LIST
  is 'ŒÔ¿Ìø®∫≈¬ﬂº≠ø®∫≈∂‘’’±Ì¿˙ ∑±Ì';
alter table ACC_ST.OP_HIS_PHY_LOGIC_LIST
  add constraint PK_OP_HIS_PHY_LOGIC_LIST primary key (PHYSIC_NO)
  disable;
alter table ACC_ST.OP_HIS_PHY_LOGIC_LIST
  add constraint UK_OP_HIS_PHY_LOGIC_LIST unique (LOGIC_NO)
  disable;
grant select on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_ST_APP;
grant select on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_ST_DEV;
grant select on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_ST_RPT;
grant select, insert, update, delete on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_TK_APP;
grant select on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_TK_DEV;
grant select on ACC_ST.OP_HIS_PHY_LOGIC_LIST to ACC_TK_RPT;

prompt
prompt Creating table OP_LOG_IMPORT
prompt ============================
prompt
create table ACC_ST.OP_LOG_IMPORT
(
  water_no         NUMBER(18) not null,
  operator_id      VARCHAR2(8) not null,
  op_time          DATE not null,
  op_type          INTEGER not null,
  table_name       VARCHAR2(50) not null,
  record_count     INTEGER not null,
  version_no       VARCHAR2(10) not null,
  remark           VARCHAR2(100),
  file_name        VARCHAR2(100),
  begin_logical_id VARCHAR2(20),
  end_logical_id   VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_LOG_IMPORT
  is 'µº»Î»’÷æ±Ì';
alter table ACC_ST.OP_LOG_IMPORT
  add constraint PK_OP_LOG_IMPORT primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_LOG_IMPORT to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_IMPORT to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_IMPORT to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_LEVEL
prompt ===========================
prompt
create table ACC_ST.OP_LOG_LEVEL
(
  sys_code    CHAR(1) not null,
  sys_level   CHAR(1) not null,
  set_time    DATE not null,
  operator    CHAR(6) not null,
  version_no  CHAR(10) not null,
  record_flag CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
alter table ACC_ST.OP_LOG_LEVEL
  add constraint OP_LOG_LEVEL_PK primary key (SYS_CODE, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.OP_LOG_LEVEL to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_LEVEL to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_LEVEL to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_NON_RETURN
prompt ================================
prompt
create table ACC_ST.OP_LOG_NON_RETURN
(
  operator_id        VARCHAR2(10),
  operate_time       DATE,
  operate_type       VARCHAR2(20),
  receipt_id         VARCHAR2(26),
  card_print_id      VARCHAR2(20),
  card_balance_fee   NUMBER(12,2),
  is_broken          VARCHAR2(2),
  remark             VARCHAR2(40),
  deposit_fee        NUMBER(7,2),
  penalty_fee        NUMBER(7,2),
  actual_return_bala NUMBER(12,2),
  penalty_reason     VARCHAR2(2),
  hdl_flag           CHAR(1),
  old_no             VARCHAR2(50),
  identity_type      CHAR(1),
  identity_id        VARCHAR2(18),
  return_type        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_LOG_NON_RETURN
  is '∑«º¥ ±ÕÀøÓ»’÷æ';
comment on column ACC_ST.OP_LOG_NON_RETURN.return_type
  is '0£∫º¥ ±ÕÀøÓ£ª1£∫∑«º¥ ±ÕÀøÓ£ª2£∫µ•≥Ã∆±ÕÀøÓ£ª3£∫∑«’˝≥£ƒ£ Ωµ•≥Ã∆±ÕÀøÓ 4£∫π“ ß∑«º¥ ±ÕÀøÓ';
grant select, insert, update, delete on ACC_ST.OP_LOG_NON_RETURN to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_NON_RETURN to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_NON_RETURN to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_PRM_OPERATE
prompt =================================
prompt
create table ACC_ST.OP_LOG_PRM_OPERATE
(
  water_no      NUMBER(18) not null,
  operator_id   VARCHAR2(8),
  param_type_id CHAR(4),
  op_type       CHAR(1),
  op_time       DATE,
  result        CHAR(1),
  remark        VARCHAR2(256)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_LOG_PRM_OPERATE
  is '(»’÷æ)≤Œ ˝≤Ÿ◊˜»’÷æ';
alter table ACC_ST.OP_LOG_PRM_OPERATE
  add constraint PK_OP_LOG_PRM_OPERATE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_LOG_PRM_OPERATE to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_PRM_OPERATE to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_PRM_OPERATE to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_REPORT_DETAIL
prompt ===================================
prompt
create table ACC_ST.OP_LOG_REPORT_DETAIL
(
  water_no         NUMBER(18) not null,
  report_code      VARCHAR2(6),
  report_name      VARCHAR2(50),
  report_module    VARCHAR2(6),
  report_size      INTEGER,
  is_delay         CHAR(1),
  gen_start_time   DATE,
  gen_end_time     DATE,
  use_time         INTEGER,
  gen_thread       VARCHAR2(50),
  gen_count        INTEGER,
  balance_water_no VARCHAR2(10),
  sys_level        CHAR(1),
  report_water_no  VARCHAR2(14)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_LOG_REPORT_DETAIL
  add constraint PK_OP_LOG_REPORT_DETAIL primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_LOG_REPORT_DETAIL to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_REPORT_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_REPORT_DETAIL to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_REPORT_TOTAL
prompt ==================================
prompt
create table ACC_ST.OP_LOG_REPORT_TOTAL
(
  water_no         NUMBER(18) not null,
  balance_water_no CHAR(10),
  total_num        INTEGER,
  total_delay_num  INTEGER,
  total_num_regen  INTEGER,
  total_error_num  INTEGER,
  total_size       INTEGER,
  gen_start_time   DATE,
  gen_end_time     DATE,
  use_time         INTEGER,
  sys_level        CHAR(1),
  report_water_no  VARCHAR2(14)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_LOG_REPORT_TOTAL
  add constraint PK_OP_LOG_REPORT_TOTAL primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_LOG_REPORT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_REPORT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_REPORT_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_SAM_LIST_OPERATION
prompt ========================================
prompt
create table ACC_ST.OP_LOG_SAM_LIST_OPERATION
(
  water_no       NUMBER(18) not null,
  sam_logical_id CHAR(20) not null,
  sam_type_id    CHAR(1),
  device_id      CHAR(3),
  dev_type_id    CHAR(2),
  line_id        CHAR(2),
  station_id     CHAR(2),
  op_type        INTEGER,
  op_time        DATE,
  operator       VARCHAR2(8),
  version_no     VARCHAR2(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_LOG_SAM_LIST_OPERATION
  add constraint PK_OP_LOG_SAM_LIST_OPERATION primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_LOG_SAM_LIST_OPERATION to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_SAM_LIST_OPERATION to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_SAM_LIST_OPERATION to ACC_ST_RPT;

prompt
prompt Creating table OP_LOG_USER_ACCESS
prompt =================================
prompt
create table ACC_ST.OP_LOG_USER_ACCESS
(
  flow_id         NUMBER(18) not null,
  sys_operator_id VARCHAR2(8) not null,
  login_time      DATE not null,
  logout_time     DATE,
  remark          VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_LOG_USER_ACCESS
  add constraint OP_LOG_USER_ACCESS_PK primary key (FLOW_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant insert on ACC_ST.OP_LOG_USER_ACCESS to ACC_COMMU_APP;
grant insert on ACC_ST.OP_LOG_USER_ACCESS to ACC_MONITOR_APP;
grant insert on ACC_ST.OP_LOG_USER_ACCESS to ACC_ONLINE_APP;
grant select on ACC_ST.OP_LOG_USER_ACCESS to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_LOG_USER_ACCESS to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_USER_ACCESS to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_USER_ACCESS to ACC_ST_RPT;
grant insert on ACC_ST.OP_LOG_USER_ACCESS to ACC_TK_APP;
grant select on ACC_ST.OP_LOG_USER_ACCESS to ACC_TK_DEV;
grant select on ACC_ST.OP_LOG_USER_ACCESS to ACC_TK_RPT;

prompt
prompt Creating table OP_LOG_USER_OPERATE
prompt ==================================
prompt
create table ACC_ST.OP_LOG_USER_OPERATE
(
  water_no    NUMBER(18) not null,
  operator_id CHAR(8),
  host_addr   VARCHAR2(20),
  op_type     VARCHAR2(2),
  op_time     DATE,
  app         VARCHAR2(30),
  module      VARCHAR2(50),
  content     VARCHAR2(256),
  result      CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_LOG_USER_OPERATE
  is '(»’÷æ)”√ªß≤Ÿ◊˜»’÷æ';
alter table ACC_ST.OP_LOG_USER_OPERATE
  add constraint PK_OP_LOG_USER_OPERATE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_LOG_USER_OPERATE to ACC_ST_APP;
grant select on ACC_ST.OP_LOG_USER_OPERATE to ACC_ST_DEV;
grant select on ACC_ST.OP_LOG_USER_OPERATE to ACC_ST_RPT;

prompt
prompt Creating table OP_MB_INFO
prompt =========================
prompt
create table ACC_ST.OP_MB_INFO
(
  info_no           VARCHAR2(12) not null,
  info_level        CHAR(1) not null,
  add_operator      VARCHAR2(10),
  add_date          DATE,
  audit_operator    VARCHAR2(10),
  audit_date        DATE,
  info_flag         CHAR(1) not null,
  distribute_result CHAR(1),
  distribute_date   DATE,
  distribute_memo   VARCHAR2(100),
  remark            VARCHAR2(100),
  file_name         VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on column ACC_ST.OP_MB_INFO.info_level
  is '1£∫∆’Õ® 2£∫º± 3£∫ΩÙº±';
comment on column ACC_ST.OP_MB_INFO.info_flag
  is '0£∫Œ¥…Û∫À 1£∫…Û∫ÀÕ®π˝ 2£∫…Û∫À≤ªÕ®π˝';
comment on column ACC_ST.OP_MB_INFO.distribute_result
  is '0£∫Œ¥œ¬∑¢ 1£∫œ¬∑¢ ß∞‹ 2£∫œ¬∑¢≥…π¶';
alter table ACC_ST.OP_MB_INFO
  add constraint PK_OP_MB_INFO primary key (INFO_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.OP_MB_INFO to ACC_ST_APP;

prompt
prompt Creating table OP_MB_INFO_DETAIL
prompt ================================
prompt
create table ACC_ST.OP_MB_INFO_DETAIL
(
  water_no     NUMBER(18) not null,
  info_no      VARCHAR2(12) not null,
  info_content VARCHAR2(1024) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
alter table ACC_ST.OP_MB_INFO_DETAIL
  add constraint PK_OP_MB_INFO_DETAIL primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.OP_MB_INFO_DETAIL to ACC_ST_APP;

prompt
prompt Creating table OP_NON_RETURN_TK_HIST
prompt ====================================
prompt
create table ACC_ST.OP_NON_RETURN_TK_HIST
(
  card_physical_id      CHAR(20),
  card_logical_id       CHAR(20),
  device_id             CHAR(4),
  deal_datetime         DATE,
  pay_mode_id           CHAR(2),
  deal_fee              NUMBER(8,2),
  receipt_id            CHAR(4),
  tac                   CHAR(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  deal_balance_fee      NUMBER(12,2),
  balance_water_no      CHAR(18),
  entry_datetime        DATE,
  deal_type             CHAR(1),
  red_flag              CHAR(1),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  gen_time              DATE,
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  current_balance_water CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_NON_RETURN_TK_HIST to ACC_ST_APP;
grant select on ACC_ST.OP_NON_RETURN_TK_HIST to ACC_ST_DEV;
grant select on ACC_ST.OP_NON_RETURN_TK_HIST to ACC_ST_RPT;

prompt
prompt Creating table OP_NON_RETURN_TK_TRANS_HIST
prompt ==========================================
prompt
create table ACC_ST.OP_NON_RETURN_TK_TRANS_HIST
(
  card_physical_id      CHAR(20),
  card_logical_id       CHAR(20),
  device_id             CHAR(4),
  deal_datetime         DATE,
  pay_mode_id           CHAR(2),
  deal_fee              NUMBER(8,2),
  receipt_id            CHAR(4),
  tac                   CHAR(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  deal_balance          NUMBER(12,2),
  balance_water_no      CHAR(18),
  entry_datetime        DATE,
  deal_type             CHAR(1),
  red_flag              CHAR(1),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  gen_time              DATE,
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  current_balance_water CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_NON_RETURN_TK_TRANS_HIST to ACC_ST_APP;
grant select on ACC_ST.OP_NON_RETURN_TK_TRANS_HIST to ACC_ST_DEV;
grant select on ACC_ST.OP_NON_RETURN_TK_TRANS_HIST to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_ADMIN_MANAGER_TYPE
prompt ========================================
prompt
create table ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE
(
  admin_manager_id CHAR(2) not null,
  admin_charge     VARCHAR2(4),
  record_flag      CHAR(1) not null,
  version_no       CHAR(10) not null,
  line_id          CHAR(2) not null,
  station_id       CHAR(2) default '00' not null,
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) default '00' not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE
  is '––’˛¥¶¿Ì‘≠“Ú';
comment on column ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE.admin_manager_id
  is '––’˛¥˙¬Î';
comment on column ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE.admin_charge
  is '∑£Ω£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE.line_id
  is 'œﬂ¬∑';
comment on column ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE.station_id
  is '≥µ’æ';
comment on column ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
alter table ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE
  add constraint PK_OP_PRM_ADMIN_MANAGER_TYPE primary key (ADMIN_MANAGER_ID, RECORD_FLAG, VERSION_NO, STATION_ID, CARD_SUB_ID, LINE_ID, CARD_MAIN_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_ADMIN_MANAGER_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_ADMIN_REASON
prompt ==================================
prompt
create table ACC_ST.OP_PRM_ADMIN_REASON
(
  admin_manager_id   CHAR(2) not null,
  admin_manager_name VARCHAR2(60),
  record_flag        CHAR(1) not null,
  version_no         CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_ADMIN_REASON
  is '––’˛¥¶¿Ì‘≠“Ú';
alter table ACC_ST.OP_PRM_ADMIN_REASON
  add constraint PK_OP_PRM_ADMIN_REASON primary key (ADMIN_MANAGER_ID, RECORD_FLAG, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_ADMIN_REASON to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_ADMIN_REASON to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_ADMIN_REASON to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_AGENT_RATE
prompt ================================
prompt
create table ACC_ST.OP_PRM_AGENT_RATE
(
  agent_id     CHAR(2) not null,
  version_no   CHAR(10) not null,
  service_rate NUMBER(12,2),
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_AGENT_RATE
  is '(≤Œ ˝) ÷–¯∑—¬ ';
alter table ACC_ST.OP_PRM_AGENT_RATE
  add constraint PK_OP_PRM_AGENT_RATE primary key (AGENT_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_AGENT_RATE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_AGENT_RATE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_AGENT_RATE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BASE_ZONE
prompt ===============================
prompt
create table ACC_ST.OP_PRM_BASE_ZONE
(
  b_line      CHAR(2) not null,
  b_station   CHAR(2) not null,
  e_line      CHAR(2) not null,
  e_station   CHAR(2) not null,
  record_flag CHAR(1) not null,
  version_no  CHAR(10) not null,
  pass_length NUMBER(11,7) not null,
  dir         CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_BASE_ZONE.pass_length
  is '¿Ô≥Ã';
comment on column ACC_ST.OP_PRM_BASE_ZONE.dir
  is '∑ΩœÚ 0£∫…œ–– 1£∫œ¬––';
alter table ACC_ST.OP_PRM_BASE_ZONE
  add constraint PK_OP_PRM_BASE_ZONE primary key (B_LINE, B_STATION, E_LINE, E_STATION, RECORD_FLAG, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BASE_ZONE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BASE_ZONE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BASE_ZONE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_MTR
prompt ====================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_MTR
(
  gen_datetime    DATE,
  card_logical_id VARCHAR2(20) not null,
  black_type      CHAR(2),
  remark          VARCHAR2(256),
  action_type     VARCHAR2(3),
  create_datetime DATE,
  operator_id     VARCHAR2(20),
  is_set          CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_BLACK_LIST_MTR
  is '(≤Œ ˝)µÿÃ˙∫⁄√˚µ•∂Œπ‹¿Ì';
comment on column ACC_ST.OP_PRM_BLACK_LIST_MTR.black_type
  is '≤˙…˙‘≠“Ú';
alter table ACC_ST.OP_PRM_BLACK_LIST_MTR
  add constraint PK_OP_PRM_CARD_BLACK_LIST_MTR primary key (CARD_LOGICAL_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_MTR_HIS
prompt ========================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_MTR_HIS
(
  gen_datetime     DATE,
  card_logical_id  VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2),
  version_no       CHAR(10),
  record_flag      CHAR(1),
  balance_water_no CHAR(10),
  op_time          DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_MTR_HIS to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_HIS to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_HIS to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_MTR_SEC
prompt ========================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC
(
  gen_datetime     DATE,
  begin_logical_id VARCHAR2(20) not null,
  end_logical_id   VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC
  is '(≤Œ ˝)∫⁄√˚µ•π‹¿Ì';
comment on column ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC.begin_logical_id
  is 'ø™ º¬ﬂº≠ø®∫≈';
comment on column ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC.end_logical_id
  is 'Ω· ¯¬ﬂº≠ø®∫≈';
comment on column ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC.black_type
  is '≤˙…˙‘≠“Ú';
comment on column ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC.action_type
  is '…Ë±∏¥¶¿Ì¥˙¬Î';
alter table ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC
  add constraint PK_OP_PRM_CARD_BLACK_LIST primary key (BEGIN_LOGICAL_ID, END_LOGICAL_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_MTR_SEC_HIS
prompt ============================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC_HIS
(
  gen_datetime     DATE,
  begin_logical_id VARCHAR2(20) not null,
  end_logical_id   VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2),
  version_no       CHAR(10),
  record_flag      CHAR(1),
  balance_water_no CHAR(10),
  op_time          DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC_HIS to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC_HIS to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_MTR_SEC_HIS to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_OCT
prompt ====================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_OCT
(
  gen_datetime    DATE,
  card_logical_id VARCHAR2(20) not null,
  black_type      CHAR(2),
  remark          VARCHAR2(256),
  action_type     VARCHAR2(3),
  create_datetime DATE,
  operator_id     VARCHAR2(20),
  is_set          CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_BLACK_LIST_OCT
  is '(≤Œ ˝)oct∫⁄√˚µ•π‹¿Ì';
alter table ACC_ST.OP_PRM_BLACK_LIST_OCT
  add constraint PK_OP_PRM_BLACK_LIST_OCT primary key (CARD_LOGICAL_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_OCT_HIS
prompt ========================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_OCT_HIS
(
  gen_datetime     DATE,
  card_logical_id  VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2),
  version_no       CHAR(10),
  record_flag      CHAR(1),
  balance_water_no CHAR(10),
  op_time          DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_OCT_HIS to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_HIS to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_HIS to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_OCT_SEC
prompt ========================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC
(
  gen_datetime     DATE,
  begin_logical_id VARCHAR2(20) not null,
  end_logical_id   VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC
  is '(≤Œ ˝)oct∫⁄√˚µ•∂Œπ‹¿Ì';
alter table ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC
  add constraint PK_OP_PRM_BLACK_LIST_OCT_SEC primary key (BEGIN_LOGICAL_ID, END_LOGICAL_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_BLACK_LIST_OCT_SEC_HIS
prompt ============================================
prompt
create table ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC_HIS
(
  gen_datetime     DATE,
  begin_logical_id VARCHAR2(20) not null,
  end_logical_id   VARCHAR2(20) not null,
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2),
  version_no       CHAR(10),
  record_flag      CHAR(1),
  balance_water_no CHAR(10),
  op_time          DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC_HIS to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC_HIS to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_LIST_OCT_SEC_HIS to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_OLD_MTR
prompt ===================================
prompt
create table ACC_ST.OP_PRM_BLACK_OLD_MTR
(
  gen_datetime       DATE,
  cutoff_datetime    DATE,
  card_logical_id    VARCHAR2(20) not null,
  black_type         CHAR(2),
  remark             VARCHAR2(256),
  action_type        VARCHAR2(3),
  create_datetime    DATE,
  operator_id        VARCHAR2(20),
  is_set             CHAR(2),
  balance_water_no   CHAR(10),
  delete_datetime    DATE,
  delete_operator_id VARCHAR2(20),
  delete_remark      VARCHAR2(256)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
create unique index ACC_ST.PK_OP_PRM_BLACK_LIST_OLD_MTR on ACC_ST.OP_PRM_BLACK_OLD_MTR (CARD_LOGICAL_ID, GEN_DATETIME, BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_OLD_MTR to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_OLD_MTR to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_OLD_MTR to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_OLD_MTR_SEC
prompt =======================================
prompt
create table ACC_ST.OP_PRM_BLACK_OLD_MTR_SEC
(
  gen_datetime       DATE not null,
  cutoff_datetime    DATE,
  begin_logical_id   VARCHAR2(20) not null,
  end_logical_id     VARCHAR2(20) not null,
  black_type         CHAR(2),
  remark             VARCHAR2(256),
  action_type        VARCHAR2(3),
  create_datetime    DATE,
  operator_id        VARCHAR2(20),
  is_set             CHAR(2),
  balance_water_no   CHAR(10),
  delete_datetime    DATE,
  delete_operator_id VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
create unique index ACC_ST.PK_OP_PRM_BLACK_LIST_OLD_MTR_S on ACC_ST.OP_PRM_BLACK_OLD_MTR_SEC (BEGIN_LOGICAL_ID, END_LOGICAL_ID, GEN_DATETIME, BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_OLD_MTR_SEC to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_OLD_MTR_SEC to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_OLD_MTR_SEC to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_OLD_OCT
prompt ===================================
prompt
create table ACC_ST.OP_PRM_BLACK_OLD_OCT
(
  gen_datetime       DATE,
  cutoff_datetime    DATE,
  card_logical_id    VARCHAR2(20) not null,
  black_type         CHAR(2),
  remark             VARCHAR2(256),
  action_type        VARCHAR2(3),
  create_datetime    DATE,
  operator_id        VARCHAR2(20),
  is_set             CHAR(2),
  balance_water_no   CHAR(10),
  delete_datetime    DATE,
  delete_operator_id VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
create unique index ACC_ST.PK_OP_PRM_BLACK_LIST_OLD_O on ACC_ST.OP_PRM_BLACK_OLD_OCT (CARD_LOGICAL_ID, GEN_DATETIME, BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_OLD_OCT to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_OLD_OCT to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_OLD_OCT to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_BLACK_OLD_OCT_SEC
prompt =======================================
prompt
create table ACC_ST.OP_PRM_BLACK_OLD_OCT_SEC
(
  gen_datetime       DATE,
  cutoff_datetime    DATE,
  begin_logical_id   VARCHAR2(20) not null,
  end_logical_id     VARCHAR2(20) not null,
  black_type         CHAR(2),
  remark             VARCHAR2(256),
  action_type        VARCHAR2(3),
  create_datetime    DATE,
  operator_id        VARCHAR2(20),
  is_set             CHAR(2),
  balance_water_no   CHAR(10),
  delete_datetime    DATE,
  delete_operator_id VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
create unique index ACC_ST.PK_OP_PRM_BLACK_LIST_OLD_OCT_S on ACC_ST.OP_PRM_BLACK_OLD_OCT_SEC (BEGIN_LOGICAL_ID, END_LOGICAL_ID, GEN_DATETIME, BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_BLACK_OLD_OCT_SEC to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_BLACK_OLD_OCT_SEC to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_BLACK_OLD_OCT_SEC to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_CARD_MAIN
prompt ===============================
prompt
create table ACC_ST.OP_PRM_CARD_MAIN
(
  card_main_id   CHAR(2) not null,
  version_no     CHAR(10) not null,
  card_main_name VARCHAR2(30),
  record_flag    CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_CARD_MAIN
  is '(≤Œ ˝)∆±ø®÷˜¿‡–Õ';
alter table ACC_ST.OP_PRM_CARD_MAIN
  add constraint PK_OP_PRM_CARD_MAIN primary key (CARD_MAIN_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_COMMU_APP;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_COMMU_DEV;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_CARD_MAIN to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_CARD_MAIN to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_CARD_PARA
prompt ===============================
prompt
create table ACC_ST.OP_PRM_CARD_PARA
(
  card_main_id             CHAR(2) not null,
  card_sub_id              CHAR(2) not null,
  purse_value_type         CHAR(1),
  max_store_val            VARCHAR2(6),
  is_overdraw              CHAR(1),
  overdraw_limit           VARCHAR2(6),
  is_recharge              CHAR(1),
  max_recharge_val         VARCHAR2(6),
  update_fee_type          CHAR(1),
  is_chk_cur_station       CHAR(1),
  is_chk_cur_date          CHAR(1),
  is_refund                CHAR(1),
  refund_limit             VARCHAR2(3),
  daily_trip_cnt_lmt       VARCHAR2(2),
  month_trip_cnt_lmt       VARCHAR2(4),
  exp_date                 VARCHAR2(16),
  is_allow_postpone        CHAR(1),
  extend_expire_day        VARCHAR2(4),
  deposit_amnt             VARCHAR2(6),
  card_cost                VARCHAR2(6),
  auxiliary_expenses       VARCHAR2(6),
  is_activation            CHAR(1),
  is_chk_blk               CHAR(1),
  is_chk_remain            CHAR(1),
  is_chk_valid_phy_logic   CHAR(1),
  is_chk_sequ              CHAR(1),
  is_chk_exce_time         CHAR(1),
  is_chk_exce_st           CHAR(1),
  is_limit_entry_exit      CHAR(1),
  is_limit_station         CHAR(1),
  add_val_equi_type        VARCHAR2(16),
  use_on_equi              VARCHAR2(16),
  is_limit_sale_entry      CHAR(1),
  refund_limit_balance     VARCHAR2(6),
  refund_auxiliary_expense VARCHAR2(6),
  version_no               CHAR(10) not null,
  record_flag              CHAR(1) not null,
  is_lmt_daily_trip        CHAR(1),
  is_preexamine            CHAR(1),
  preexamine_cnt_lmt       VARCHAR2(6),
  is_chk_exp_date          CHAR(1),
  is_limit_line            CHAR(1),
  limit_intime             VARCHAR2(3),
  is_limit_intime          CHAR(1),
  entry_control            CHAR(1),
  sale_equi_type           VARCHAR2(16),
  is_deposit_refund        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_CARD_PARA
  is '(≤Œ ˝)∆±ø® Ù–‘';
comment on column ACC_ST.OP_PRM_CARD_PARA.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.OP_PRM_CARD_PARA.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.OP_PRM_CARD_PARA.purse_value_type
  is '«Æ∞¸÷µ¿‡–Õ£®0Œﬁ÷µ¿‡–Õ£¨1Ω∂Ó£¨2¥Œ ˝£¨3ÃÏ ˝£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.max_store_val
  is '≥µ∆±”‡∂Ó/¥Œ…œœﬁ£®µ•Œª£∫∑÷/¥Œ£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_overdraw
  is ' «∑Ò‘ –ÌÕ∏÷ß£®0Ω˚÷π£¨1‘ –Ì£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.overdraw_limit
  is 'Õ∏÷ß∂Ó∂»£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_recharge
  is ' «∑Ò‘ –Ì≥‰÷µ£®0Ω˚÷π£¨1‘ –Ì£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.max_recharge_val
  is '√ø¥Œ≥‰÷µ…œœﬁ£®µ•Œª£∫∑÷/¥Œ£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.update_fee_type
  is '∏¸–¬ ± ’∑—∑Ω Ω£®0œ÷Ω£¨1ø®£¨2ø®ªÚœ÷Ω£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_cur_station
  is '∏∂∑—«¯∑«±æ’æ∏¸–¬ºÏ≤È±Í÷æ£®0≤ªºÏ≤È£¨1ºÏ≤È£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_cur_date
  is '∏∂∑—«¯∑«±æ»’∏¸–¬ºÏ≤È±Í÷æ£®0≤ªºÏ≤È£¨1ºÏ≤È£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_refund
  is ' «∑Ò‘ –ÌÕÀøÓ£®0Ω˚÷π£¨1‘ –Ì£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.refund_limit
  is 'ÕÀøÓ ± π”√¥Œ ˝œﬁ÷∆£®000±Ì æ≤ªœﬁ÷∆£¨ π”√¥Œ ˝Œ¥¥ÔµΩ¥Àœﬁ÷∆ ±≤ª‘ –ÌÕÀøÓ£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.daily_trip_cnt_lmt
  is '»’≥À◊¯¥Œ ˝…œœﬁ£®00±Ì æ≤ªœﬁ÷∆£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.month_trip_cnt_lmt
  is '‘¬≥À◊¯¥Œ ˝…œœﬁ£®0000±Ì æ≤ªœﬁ÷∆£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.exp_date
  is '”––ß∆⁄£®µ•Œª£∫∑÷÷”£¨¥”∑¢ € ±ø™ º∂‡…ŸÃÏƒ⁄”––ß£¨“‘∑÷÷”º∆£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_allow_postpone
  is ' «∑Ò‘ –Ì—”∆⁄£®0Ω˚÷π£¨1‘ –Ì£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.extend_expire_day
  is 'ø…—”≥§ ±º‰£®µ•Œª£∫ÃÏ£¨√ø¥Œ—”≥§”––ß∆⁄ ±ø…—”≥§µƒ ±º‰£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.deposit_amnt
  is '—∫Ω£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.card_cost
  is ' €º€£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.auxiliary_expenses
  is '∑¢ € ÷–¯∑—£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_activation
  is ' π”√«∞ «∑Ò–Ëº§ªÓ£®0≤ª–Ë“™£¨1–Ë“™£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_blk
  is ' «∑ÒºÏ≤È∫⁄√˚µ•£®0≤ªºÏ≤È£¨1ºÏ≤È£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_remain
  is ' «∑ÒºÏ≤È”‡∂Ó”‡¥Œ£®0≤ªºÏ≤È£¨1ºÏ≤È£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_valid_phy_logic
  is '¬ﬂº≠º∞ŒÔ¿Ì”––ß∆⁄ºÏ≤È£®0≤ªºÏ≤È¬ﬂº≠º∞ŒÔ¿Ì”––ß∆⁄£¨1ºÏ≤È¬ﬂº≠º∞ŒÔ¿Ì”––ß∆⁄£¨2ºÏ≤È¬ﬂº≠µ´≤ªºÏ≤ÈŒÔ¿Ì”––ß∆⁄£¨3≤ªºÏ≤È¬ﬂº≠µ´ºÏ≤ÈŒÔ¿Ì”––ß∆⁄£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_sequ
  is 'Ω¯≥ˆ’æ¥Œ–ÚºÏ≤È£®0Ω¯≥ˆ’ææ˘≤ªºÏ≤ÈΩ¯≥ˆ’æ¥Œ–Ú£¨1Ω¯≥ˆ’ææ˘ºÏ≤ÈΩ¯≥ˆ’æ¥Œ–Ú£¨2Ω¯’æ≤ªºÏ≤ÈΩ¯≥ˆ’æ¥Œ–Ú£¨≥ˆ’ΩºÏ≤ÈΩ¯≥ˆ’æ¥Œ–Ú£¨3Ω¯’æºÏ≤ÈΩ¯≥ˆ’æ¥Œ–Ú£¨≥ˆ’Ω≤ªºÏ≤ÈΩ¯≥ˆ’æ¥Œ–Ú£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_exce_time
  is ' «∑ÒºÏ≤È≥¨ ±£®0≤ªºÏ≤È£¨1ºÏ≤È£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_chk_exce_st
  is ' «∑ÒºÏ≤È≥¨≥À£®0≤ªºÏ≤È£¨1ºÏ≤È£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_limit_entry_exit
  is ' «∑Òœﬁ÷∆Ω¯≥ˆ’æµ„£®0∑Ò£¨1 «°£æﬂÃÂœﬁ÷∆µƒΩ¯≥ˆ’æ–≈œ¢÷∆∆± ±–¥‘⁄∆±ø®…œ£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_limit_station
  is ' «∑Ò÷ª‘ –Ì±æ’æΩ¯≥ˆ£®0∑Ò£¨1 «°£º¥±æ’æΩ¯µƒ÷ªƒ‹±æ’æ≥ˆ£¨≤ªƒ‹‘⁄∆‰À˚’æ≥ˆ£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.add_val_equi_type
  is '≥‰÷µ…Ë±∏£®…Ë±∏¿‡µƒ◊÷∑˚–≈œ¢¥˙¬Î£¨0≤ªø…“‘£¨1ø…“‘£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.use_on_equi
  is 'ƒƒ÷÷…Ë±∏ø…”√£®…Ë±∏¿‡µƒ◊÷∑˚–≈œ¢¥˙¬Î£¨0≤ªø…“‘£¨1ø…“‘£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_limit_sale_entry
  is '±æ’æ∑¢ €øÿ÷∆±Íº«£®0±Ì æ÷ª”–‘⁄±æ’æπ∫¬Úµƒµ•≥Ã∆±≤≈ƒ‹Ω¯’æ£¨1±Ì æ¥”∆‰À˚≥µ’æπ∫¬Úµƒµ•≥Ã∆±£¨ø…“‘‘⁄±æ’æΩ¯»Î£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.refund_limit_balance
  is 'ÕÀøÓ”‡∂Ó…œœﬁ£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.refund_auxiliary_expense
  is 'ÕÀøÓ ÷–¯∑—£®µ•Œª£∫∑÷£©';
comment on column ACC_ST.OP_PRM_CARD_PARA.sale_equi_type
  is '∑¢ €…Ë±∏';
comment on column ACC_ST.OP_PRM_CARD_PARA.is_deposit_refund
  is ' «∑Ò‘ –ÌÕÀ—∫Ω£®π§±æ∑—£©0£∫Ω˚÷π 1£∫‘ –Ì';
alter table ACC_ST.OP_PRM_CARD_PARA
  add constraint PK_OP_PRM_CARD_PARA primary key (CARD_MAIN_ID, CARD_SUB_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_CARD_PARA to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_CARD_PARA to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CARD_PARA to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CARD_PARA to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_CARD_PARA to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_CARD_PARA to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_CARD_PARA to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_CARD_STATUS_TYPE
prompt ======================================
prompt
create table ACC_ST.OP_PRM_CARD_STATUS_TYPE
(
  card_status_id   CHAR(2) not null,
  card_status_name VARCHAR2(20),
  remark           VARCHAR2(100),
  record_flag      CHAR(1) not null,
  version_no       CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_CARD_STATUS_TYPE
  is 'Ω¯’æ¿‡–Õ';
alter table ACC_ST.OP_PRM_CARD_STATUS_TYPE
  add constraint PK_OP_PRM_CARD_STATUS_TYPE primary key (CARD_STATUS_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_CARD_STATUS_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CARD_STATUS_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CARD_STATUS_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_CARD_SUB
prompt ==============================
prompt
create table ACC_ST.OP_PRM_CARD_SUB
(
  card_sub_id      CHAR(2) not null,
  card_main_id     CHAR(2) not null,
  card_sub_name    VARCHAR2(30),
  record_flag      CHAR(1) not null,
  version_no       CHAR(10) not null,
  card_sub_name_en VARCHAR2(60)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_CARD_SUB
  is '∆±ø®◊”¿‡–Õ';
alter table ACC_ST.OP_PRM_CARD_SUB
  add constraint PK_OP_PRM_CARD_SUB primary key (CARD_SUB_ID, CARD_MAIN_ID, RECORD_FLAG, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_COMMU_APP;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_COMMU_DEV;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_CARD_SUB to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_CARD_SUB to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_CARD_TCT_ATTR
prompt ===================================
prompt
create table ACC_ST.OP_PRM_CARD_TCT_ATTR
(
  card_main_id        CHAR(2) not null,
  card_sub_id         CHAR(2) not null,
  version_no          CHAR(10) not null,
  record_flag         CHAR(1) not null,
  once_charge_money   VARCHAR2(6),
  once_charge_count   VARCHAR2(4),
  add_begin_day       VARCHAR2(2),
  add_valid_day       VARCHAR2(2),
  exit_timeout_count  VARCHAR2(2),
  exit_timeout_money  VARCHAR2(4),
  entry_timeout_count VARCHAR2(2),
  entry_timeout_money VARCHAR2(4),
  field1              VARCHAR2(4),
  field2              VARCHAR2(4),
  field3              VARCHAR2(8),
  package_id          VARCHAR2(4) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.once_charge_money
  is '√ø¥Œ≥‰÷µΩ∂Ó£®µ•Œª£∫∑÷£¨ƒ¨»œ÷µŒ™£∫ø’£©';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.once_charge_count
  is '√ø¥Œ≥‰÷µ≥À¥Œ£®µ•Œª£∫¥Œ£¨ƒ¨»œ÷µŒ™£∫ø’£©';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.add_begin_day
  is 'œ¬‘¬≥‰÷µ∆ º»’£®∑∂Œß00-31£¨◊Û∂‘∆Î£¨0±Ì æŒﬁœﬁ÷∆£©±Ì æ¥”¥À»’∆⁄∆£¨÷¡±æ‘¬◊Ó∫Û“ª»’÷π£¨ø…∂‘œ¬‘¬≥À¥Œ«Æ∞¸≥‰÷µ';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.add_valid_day
  is '±æ‘¬≥‰÷µΩÿ÷π»’£®∑∂Œß00-31£¨◊Û∂‘∆Î£¨0±Ì æŒﬁœﬁ÷∆£©±Ì æ¥”±æ‘¬1»’∆£¨÷¡¥À»’∆⁄÷π£¨‘ –Ì∂‘±æ‘¬≥À¥Œ«Æ∞¸≥‰÷µ°£«“°∞±æ‘¬≥‰÷µΩÿ÷π»’°±±ÿ–Î–°”⁄°∞œ¬‘¬≥‰÷µ∆ º»’°±';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.exit_timeout_count
  is '≥ˆ’æ≥¨ ±∑£Ω-∞¥¥Œ£®µ•Œª£∫¥Œ£¨—°‘Ò∆±ø®÷ß∏∂£©';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.exit_timeout_money
  is '≥ˆ’æ≥¨ ±∑£Ω-Ω∂Ó£®µ•Œª£∫∑÷£¨—°‘Òœ÷Ω÷ß∏∂£©';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.entry_timeout_count
  is 'Ω¯’æ≥¨ ±∑£Ω-∞¥¥Œ£®µ•Œª£∫¥Œ£¨—°‘Ò∆±ø®÷ß∏∂£©';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.entry_timeout_money
  is 'Ω¯’æ≥¨ ±∑£Ω-Ω∂Ó£®µ•Œª£∫∑÷£¨—°‘Òœ÷Ω÷ß∏∂£©';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.field1
  is '‘§¡Ù◊÷∂Œ1';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.field2
  is '‘§¡Ù◊÷∂Œ2';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.field3
  is '‘§¡Ù◊÷∂Œ3';
comment on column ACC_ST.OP_PRM_CARD_TCT_ATTR.package_id
  is 'Ã◊≤ÕID';
alter table ACC_ST.OP_PRM_CARD_TCT_ATTR
  add constraint OP_PRM_CARD_TCT_ATTR_PK primary key (CARD_MAIN_ID, CARD_SUB_ID, PACKAGE_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_CARD_TCT_ATTR to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CARD_TCT_ATTR to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CARD_TCT_ATTR to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_CHANGE_DETAIL
prompt ===================================
prompt
create table ACC_ST.OP_PRM_CHANGE_DETAIL
(
  water_no            NUMBER(20) not null,
  version_no          CHAR(10),
  b_line_id           CHAR(2) not null,
  b_station_id        CHAR(2) not null,
  e_line_id           CHAR(2) not null,
  e_station_id        CHAR(2) not null,
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in      CHAR(2),
  change_line_in_dir  CHAR(1),
  proportion          NUMBER(11,8),
  record_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.CHANGE_DETAIL_IDX on ACC_ST.OP_PRM_CHANGE_DETAIL (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_CHANGE_DETAIL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CHANGE_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CHANGE_DETAIL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_CHARGESERV_CONF
prompt =====================================
prompt
create table ACC_ST.OP_PRM_CHARGESERV_CONF
(
  server_ip    VARCHAR2(15) not null,
  server_port  VARCHAR2(10) not null,
  server_desc  VARCHAR2(20),
  server_level VARCHAR2(2) not null,
  version_no   VARCHAR2(10) not null,
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_CHARGESERV_CONF
  is '≥‰÷µ÷’∂ÀÕ®—∂≤Œ ˝';
comment on column ACC_ST.OP_PRM_CHARGESERV_CONF.server_ip
  is 'ipµÿ÷∑';
comment on column ACC_ST.OP_PRM_CHARGESERV_CONF.server_port
  is '∂Àø⁄';
comment on column ACC_ST.OP_PRM_CHARGESERV_CONF.server_desc
  is '√Ë ˆ';
comment on column ACC_ST.OP_PRM_CHARGESERV_CONF.server_level
  is '÷˜±∏”≈œ»º∂ 0÷˜ £¨ 1±∏';
alter table ACC_ST.OP_PRM_CHARGESERV_CONF
  add constraint PK_OP_PRM_CHARGESERV_CONF primary key (SERVER_IP, SERVER_PORT, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_CHARGESERV_CONF to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CHARGESERV_CONF to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CHARGESERV_CONF to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_CONTC
prompt ===========================
prompt
create table ACC_ST.OP_PRM_CONTC
(
  contc_id    CHAR(2) not null,
  contc_name  VARCHAR2(50),
  link_man    CHAR(8),
  tel         VARCHAR2(15),
  fax         VARCHAR2(15),
  record_flag CHAR(1) not null,
  version_no  CHAR(10),
  sequence    CHAR(2) default '00'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_CONTC
  is '‘À”™…Ã';
alter table ACC_ST.OP_PRM_CONTC
  add constraint PK_OP_PRM_CONTC primary key (CONTC_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_CONTC to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CONTC to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CONTC to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_CONTC_SERVICE_RATE
prompt ========================================
prompt
create table ACC_ST.OP_PRM_CONTC_SERVICE_RATE
(
  contc_id     CHAR(2) not null,
  version_no   CHAR(10) not null,
  service_rate NUMBER(12,2),
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_CONTC_SERVICE_RATE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_CONTC_SERVICE_RATE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_CONTC_SERVICE_RATE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_DEAL_ASSIGN_CONTC
prompt =======================================
prompt
create table ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC
(
  version_no   CHAR(10) not null,
  b_line_id    CHAR(2) not null,
  b_station_id CHAR(2) not null,
  contc_id     CHAR(2) not null,
  e_line_id    CHAR(2) not null,
  e_station_id CHAR(2) not null,
  in_percent   NUMBER(8,6) not null,
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC
  is '(≤Œ ˝)Ωª“◊∑÷≈‰±»¿˝';
create index ACC_ST.DEAL_ASSIGN_CONTC_IDX on ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, CONTC_ID, IN_PERCENT)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC
  add constraint PK_OP_PRM_DEAL_ASSIGN primary key (VERSION_NO, B_LINE_ID, B_STATION_ID, CONTC_ID, E_LINE_ID, E_STATION_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEAL_ASSIGN_CONTC to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_DEAL_ASSIGN_LINE
prompt ======================================
prompt
create table ACC_ST.OP_PRM_DEAL_ASSIGN_LINE
(
  version_no      CHAR(10) not null,
  b_line_id       CHAR(2) not null,
  b_station_id    CHAR(2) not null,
  line_id_dispart CHAR(2) not null,
  e_line_id       CHAR(2) not null,
  e_station_id    CHAR(2) not null,
  in_percent      NUMBER(8,6) not null,
  record_flag     CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_DEAL_ASSIGN_LINE
  is '(≤Œ ˝)Ωª“◊∑÷≈‰±»¿˝-line';
create index ACC_ST.DEAL_ASSIGN_PARA_LINE_IDX on ACC_ST.OP_PRM_DEAL_ASSIGN_LINE (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, LINE_ID_DISPART, IN_PERCENT)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_DEAL_ASSIGN_LINE
  add constraint PK_OP_PRM_DEAL_ASSIGN_LINE primary key (VERSION_NO, B_LINE_ID, B_STATION_ID, LINE_ID_DISPART, E_LINE_ID, E_STATION_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_DEAL_ASSIGN_LINE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEAL_ASSIGN_LINE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEAL_ASSIGN_LINE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_DEGRADE_MODE_RECD
prompt =======================================
prompt
create table ACC_ST.OP_PRM_DEGRADE_MODE_RECD
(
  water_no        NUMBER(18) not null,
  line_id         CHAR(2),
  station_id      CHAR(2),
  degrade_mode_id CHAR(3),
  start_time      CHAR(14),
  end_time        CHAR(14),
  set_oper_id     VARCHAR2(8),
  cancel_oper_id  VARCHAR2(8),
  hdl_flag        CHAR(1),
  version_no      CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_DEGRADE_MODE_RECD
  is '(≤Œ ˝)Ωµº∂ƒ£ Ω π”√º«¬º';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.line_id
  is 'œﬂ¬∑';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.station_id
  is '≥µ’æ';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.degrade_mode_id
  is 'Ωµº∂ƒ£ Ω¿‡–Õ';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.start_time
  is '∑¢…˙Ωµº∂ƒ£ Ωµƒø™ º ±º‰YYYYMMDDHHMMSS';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.end_time
  is '∑¢…˙Ωµº∂ƒ£ ΩµƒΩ· ¯ ±º‰YYYYMMDDHHMMSS';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.set_oper_id
  is '…Ë÷√ƒ£ Ωµƒ≤Ÿ◊˜‘±';
comment on column ACC_ST.OP_PRM_DEGRADE_MODE_RECD.cancel_oper_id
  is '»°œ˚ƒ£ Ωµƒ≤Ÿ◊˜‘±';
alter table ACC_ST.OP_PRM_DEGRADE_MODE_RECD
  add constraint PK_OP_PRM_DEGRADE_MODE_RECD primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_DEGRADE_MODE_RECD to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEGRADE_MODE_RECD to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEGRADE_MODE_RECD to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_DEV_CODE
prompt ==============================
prompt
create table ACC_ST.OP_PRM_DEV_CODE
(
  line_id      CHAR(2) not null,
  station_id   CHAR(2) not null,
  dev_type_id  CHAR(2) not null,
  device_id    CHAR(3) not null,
  csc_num      INTEGER,
  array_id     CHAR(3),
  concourse_id CHAR(3),
  ip_address   VARCHAR2(15),
  store_id     CHAR(5),
  dev_serial   VARCHAR2(20),
  record_flag  CHAR(1) not null,
  version_no   CHAR(10) not null,
  config_date  DATE,
  dev_name     VARCHAR2(30)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_DEV_CODE.dev_type_id
  is '…Ë±∏¿‡–Õ';
comment on column ACC_ST.OP_PRM_DEV_CODE.device_id
  is '…Ë±∏±‡∫≈';
comment on column ACC_ST.OP_PRM_DEV_CODE.csc_num
  is '…Ë±∏À˘∫¨µƒCSC∂¡–¥∆˜ ˝¡ø';
comment on column ACC_ST.OP_PRM_DEV_CODE.array_id
  is '’¢ª˙ªÚTVMÀ˘ Ùµƒ’Û¡–±‡∫≈';
comment on column ACC_ST.OP_PRM_DEV_CODE.concourse_id
  is '≥µ’æƒ⁄µƒ«¯”Ú±‡∫≈';
comment on column ACC_ST.OP_PRM_DEV_CODE.ip_address
  is '…Ë±∏IPµÿ÷∑';
comment on column ACC_ST.OP_PRM_DEV_CODE.store_id
  is '…ÃªßID';
comment on column ACC_ST.OP_PRM_DEV_CODE.dev_serial
  is '…Ë±∏–Ú¡–∫≈';
comment on column ACC_ST.OP_PRM_DEV_CODE.config_date
  is '≈‰÷√ ±º‰';
alter table ACC_ST.OP_PRM_DEV_CODE
  add constraint OP_PRM_DEV_CODE_PK primary key (LINE_ID, STATION_ID, DEV_TYPE_ID, DEVICE_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_DEV_CODE to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_DEV_CODE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEV_CODE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEV_CODE to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_DEV_CODE to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_DEV_CODE to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_DEV_CODE to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_DEV_CONTRL
prompt ================================
prompt
create table ACC_ST.OP_PRM_DEV_CONTRL
(
  version_no         CHAR(10) not null,
  logoff_idle_sc     VARCHAR2(4),
  interval_connectsc VARCHAR2(4),
  logoff_idle_bom    VARCHAR2(4),
  time_out_pass      VARCHAR2(4),
  operator_id        VARCHAR2(8),
  degrade_time       VARCHAR2(2),
  record_flag        CHAR(1) not null,
  upper_amount       VARCHAR2(8),
  upper_count        VARCHAR2(8),
  upper_sjt          VARCHAR2(8),
  under_amount       VARCHAR2(8),
  under_count        VARCHAR2(8),
  under_sjt          VARCHAR2(8)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_DEV_CONTRL
  is '…Ë±∏øÿ÷∆≤Œ ˝';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.logoff_idle_sc
  is 'SC≤Ÿ◊˜‘±Œﬁ≤Ÿ◊˜◊‘∂Ø◊¢œ˙ ±º‰';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.interval_connectsc
  is 'SC÷ÿ–¬¡¨Ω”LCCµƒ÷‹∆⁄';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.logoff_idle_bom
  is 'BOM‘À––»À‘±◊‘∂Ø◊¢œ˙ ±º‰';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.time_out_pass
  is 'Ω¯/≥ˆ’¢≥¨ ±';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.operator_id
  is 'Œﬁ';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.degrade_time
  is 'Ωµº∂ƒ£ Ωµƒ”∞œÏ”––ß∆⁄';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.upper_amount
  is '¥¢÷µø®«Æ∞¸≥‰÷µ…œœﬁ';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.upper_count
  is 'ª˝∑÷«Æ∞¸≥‰÷µ…œœﬁ';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.upper_sjt
  is 'µ•≥Ã∆±∑¢ €«Æ∞¸≥‰÷µ…œœﬁ';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.under_amount
  is '¥¢÷µø®«Æ∞¸≥‰÷µœ¬œﬁ';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.under_count
  is 'ª˝∑÷«Æ∞¸≥‰÷µœ¬œﬁ';
comment on column ACC_ST.OP_PRM_DEV_CONTRL.under_sjt
  is 'µ•≥Ã∆±∑¢ €«Æ∞¸≥‰÷µœ¬œﬁ';
alter table ACC_ST.OP_PRM_DEV_CONTRL
  add constraint PK_OP_PRM_DEV_CONTRL primary key (VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_DEV_CONTRL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEV_CONTRL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEV_CONTRL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_DEV_PROGRAM
prompt =================================
prompt
create table ACC_ST.OP_PRM_DEV_PROGRAM
(
  water_no      NUMBER(18) not null,
  parm_type_id  CHAR(4) not null,
  file_path     VARCHAR2(150) not null,
  operator_id   VARCHAR2(8) not null,
  version_no    VARCHAR2(10) not null,
  record_flag   CHAR(1) not null,
  app_line_name VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_DEV_PROGRAM
  is '≥µ’æ…Ë±∏≥Ã–Ú≤Œ ˝';
alter table ACC_ST.OP_PRM_DEV_PROGRAM
  add constraint PK_OP_PRM_DEV_PROGRAM primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_DEV_PROGRAM
  add unique (PARM_TYPE_ID, RECORD_FLAG, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_DEV_PROGRAM to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEV_PROGRAM to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEV_PROGRAM to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_DEV_TYPE
prompt ==============================
prompt
create table ACC_ST.OP_PRM_DEV_TYPE
(
  dev_type_id   CHAR(2) not null,
  dev_type_name VARCHAR2(40),
  version_no    CHAR(10) not null,
  record_flag   CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_DEV_TYPE
  is '(≤Œ ˝)…Ë±∏¿‡–Õ';
alter table ACC_ST.OP_PRM_DEV_TYPE
  add constraint PK_OP_PRM_DEV_TYPE primary key (DEV_TYPE_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_DEV_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_DEV_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_DEV_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_FARE_CONF
prompt ===============================
prompt
create table ACC_ST.OP_PRM_FARE_CONF
(
  water_no      NUMBER(18) not null,
  time_code     CHAR(1),
  card_sub_id   CHAR(2),
  card_main_id  CHAR(2),
  fare_table_id VARCHAR2(3),
  version_no    CHAR(10),
  record_flag   CHAR(1),
  start_times   VARCHAR2(3),
  end_times     VARCHAR2(3)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_FARE_CONF
  is ' ’∑—≈‰÷√±Ì';
comment on column ACC_ST.OP_PRM_FARE_CONF.time_code
  is '≥À≥µ ±º‰¥˙¬Î';
comment on column ACC_ST.OP_PRM_FARE_CONF.card_sub_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.OP_PRM_FARE_CONF.card_main_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.OP_PRM_FARE_CONF.fare_table_id
  is '∆±º€±ÌID';
alter table ACC_ST.OP_PRM_FARE_CONF
  add constraint PK_OP_PRM_FARE_CONF primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_FARE_CONF
  add constraint UK_OP_PRM_FARE_CONF unique (CARD_SUB_ID, CARD_MAIN_ID, TIME_CODE, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_FARE_CONF to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_FARE_CONF to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_FARE_CONF to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_FARE_NAME
prompt ===============================
prompt
create table ACC_ST.OP_PRM_FARE_NAME
(
  fare_id   VARCHAR2(3) not null,
  fare_name VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_FARE_NAME
  is '∑—¬ √˚≥∆';
alter table ACC_ST.OP_PRM_FARE_NAME
  add constraint PK_OP_PRM_FARE_NAME primary key (FARE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_FARE_NAME to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_FARE_NAME to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_FARE_NAME to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_FARE_TABLE
prompt ================================
prompt
create table ACC_ST.OP_PRM_FARE_TABLE
(
  water_no      NUMBER(18) not null,
  fare_table_id VARCHAR2(3) not null,
  fare          VARCHAR2(10) not null,
  fare_zone     VARCHAR2(3) not null,
  version_no    CHAR(10) not null,
  record_flag   CHAR(1) not null,
  fare_name     VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_FARE_TABLE
  is '∆±º€±Ì';
comment on column ACC_ST.OP_PRM_FARE_TABLE.fare_table_id
  is '∆±º€±ÌID';
comment on column ACC_ST.OP_PRM_FARE_TABLE.fare
  is ' ’∑—';
comment on column ACC_ST.OP_PRM_FARE_TABLE.fare_zone
  is ' ’∑—«¯∂Œ';
alter table ACC_ST.OP_PRM_FARE_TABLE
  add constraint PK_OP_PRM_FARE_TABLE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_FARE_TABLE
  add constraint UK_OP_PRM_FARE_TABLE unique (FARE_ZONE, VERSION_NO, FARE_TABLE_ID, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_FARE_TABLE to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_FARE_TABLE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_FARE_TABLE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_FARE_TABLE to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_FARE_TABLE to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_FARE_TABLE to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_FARE_TABLE to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_FARE_ZONE
prompt ===============================
prompt
create table ACC_ST.OP_PRM_FARE_ZONE
(
  water_no         NUMBER(18) not null,
  b_line_id        CHAR(2) not null,
  b_station_id     CHAR(2) not null,
  e_line_id        CHAR(2) not null,
  e_station_id     CHAR(2) not null,
  fare_zone        VARCHAR2(3) not null,
  max_travel_time  VARCHAR2(5),
  over_time_charge VARCHAR2(4),
  version_no       CHAR(10),
  record_flag      CHAR(1) not null,
  distince         NUMBER(11,7)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_FARE_ZONE
  is ' ’∑—«¯∂Œ';
comment on column ACC_ST.OP_PRM_FARE_ZONE.b_line_id
  is 'Ω¯’æœﬂ¬∑';
comment on column ACC_ST.OP_PRM_FARE_ZONE.b_station_id
  is 'Ω¯’æ≥µ’æ';
comment on column ACC_ST.OP_PRM_FARE_ZONE.e_line_id
  is '≥ˆ’æœﬂ¬∑';
comment on column ACC_ST.OP_PRM_FARE_ZONE.e_station_id
  is '≥ˆ’æ≥µ’æ';
comment on column ACC_ST.OP_PRM_FARE_ZONE.fare_zone
  is ' ’∑—«¯∂Œ';
comment on column ACC_ST.OP_PRM_FARE_ZONE.max_travel_time
  is '≥À≥µ ±º‰œﬁ÷∆£®µ•Œª£∫∑÷÷”£©';
comment on column ACC_ST.OP_PRM_FARE_ZONE.over_time_charge
  is '≥¨ ±∑£Ω';
comment on column ACC_ST.OP_PRM_FARE_ZONE.distince
  is '≥Àæ‡';
create index ACC_ST.FARE_ZONE_IDX on ACC_ST.OP_PRM_FARE_ZONE (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, RECORD_FLAG, FARE_ZONE)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_FARE_ZONE
  add constraint PK_OP_PRM_FARE_ZONE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_FARE_ZONE
  add constraint UK_OP_PRM_FARE_ZONE unique (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_FARE_ZONE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_FARE_ZONE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_FARE_ZONE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_GATE_VOICE_PROMP
prompt ======================================
prompt
create table ACC_ST.OP_PRM_GATE_VOICE_PROMP
(
  line_id      VARCHAR2(2) not null,
  station_id   VARCHAR2(2) not null,
  card_main_id VARCHAR2(2) not null,
  card_sub_id  VARCHAR2(2) not null,
  discount     VARCHAR2(1) not null,
  sound        VARCHAR2(1) not null,
  record_flag  CHAR(1) not null,
  version_no   CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_GATE_VOICE_PROMP.line_id
  is 'œﬂ¬∑';
comment on column ACC_ST.OP_PRM_GATE_VOICE_PROMP.station_id
  is '≥µ’æ';
comment on column ACC_ST.OP_PRM_GATE_VOICE_PROMP.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.OP_PRM_GATE_VOICE_PROMP.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.OP_PRM_GATE_VOICE_PROMP.discount
  is ' «∑Ò”≈ª›∆±£®0∆’Õ®∆±£©';
comment on column ACC_ST.OP_PRM_GATE_VOICE_PROMP.sound
  is ' «∑Ò∆Ù”√”Ô“ÙÃ· æ£®0∑Ò£¨1 «£©';
alter table ACC_ST.OP_PRM_GATE_VOICE_PROMP
  add constraint OP_PRM_GATE_VOICE_PROMP_PK primary key (LINE_ID, STATION_ID, CARD_MAIN_ID, CARD_SUB_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_GATE_VOICE_PROMP to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_GATE_VOICE_PROMP to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_GATE_VOICE_PROMP to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_HOLIDAY_TABLE
prompt ===================================
prompt
create table ACC_ST.OP_PRM_HOLIDAY_TABLE
(
  water_no     NUMBER(18) not null,
  holiday_type VARCHAR2(3),
  start_date   CHAR(8),
  end_date     CHAR(8),
  version_no   CHAR(10),
  record_flag  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_HOLIDAY_TABLE
  is '(≤Œ ˝)Ω⁄ºŸ»’∂®“Â±Ì';
comment on column ACC_ST.OP_PRM_HOLIDAY_TABLE.holiday_type
  is 'Ω⁄ºŸ»’¥˙¬Î';
comment on column ACC_ST.OP_PRM_HOLIDAY_TABLE.start_date
  is 'ø™ º»’∆⁄';
comment on column ACC_ST.OP_PRM_HOLIDAY_TABLE.end_date
  is 'Ω· ¯»’∆⁄';
alter table ACC_ST.OP_PRM_HOLIDAY_TABLE
  add constraint PK_OP_PRM_HOLIDAY_TABLE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_HOLIDAY_TABLE
  add constraint UK_OP_PRM_HOLIDAY_TABLE unique (HOLIDAY_TYPE, START_DATE, END_DATE, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_HOLIDAY_TABLE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_HOLIDAY_TABLE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_HOLIDAY_TABLE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_LINE
prompt ==========================
prompt
create table ACC_ST.OP_PRM_LINE
(
  line_id     CHAR(2) not null,
  version_no  CHAR(10) not null,
  line_name   VARCHAR2(50) not null,
  record_flag CHAR(1) not null,
  lcc_ip      VARCHAR2(15),
  lcc_line_id CHAR(2),
  sequence    CHAR(2) default '00' not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_LINE.line_id
  is 'œﬂ¬∑¥˙¬Î';
comment on column ACC_ST.OP_PRM_LINE.line_name
  is 'œﬂ¬∑√˚≥∆';
comment on column ACC_ST.OP_PRM_LINE.lcc_ip
  is 'œﬂ¬∑IP';
comment on column ACC_ST.OP_PRM_LINE.lcc_line_id
  is 'LCCœﬂ¬∑ID';
comment on column ACC_ST.OP_PRM_LINE.sequence
  is '–Ú∫≈';
alter table ACC_ST.OP_PRM_LINE
  add constraint OP_PRM_LINE_PK primary key (LINE_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_LINE to ACC_COMMU_APP;
grant select on ACC_ST.OP_PRM_LINE to ACC_COMMU_DEV;
grant select on ACC_ST.OP_PRM_LINE to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_LINE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_LINE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_LINE to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_LINE to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_LINE to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_LINE to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_LINE_SERVICE_RATE
prompt =======================================
prompt
create table ACC_ST.OP_PRM_LINE_SERVICE_RATE
(
  line_id      CHAR(2) not null,
  version_no   CHAR(10) not null,
  service_rate NUMBER(12,2),
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_LINE_SERVICE_RATE
  add constraint PK_OP_PRM_LINE_SERVICE_RATE primary key (LINE_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_LINE_SERVICE_RATE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_LINE_SERVICE_RATE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_LINE_SERVICE_RATE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_LOGIC_ICC_LIST
prompt ====================================
prompt
create table ACC_ST.OP_PRM_LOGIC_ICC_LIST
(
  logic_no    VARCHAR2(20) not null,
  icc_id      VARCHAR2(20) not null,
  record_flag CHAR(1) default 3 not null,
  water_no    NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 16K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_LOGIC_ICC_LIST
  is '¬ﬂº≠ø®∫≈øÃ”°∫≈∂‘’’±Ì';
alter table ACC_ST.OP_PRM_LOGIC_ICC_LIST
  add constraint PK_OP_PRM_LOGIC_ICC_LIST primary key (LOGIC_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_LOGIC_ICC_LIST
  add constraint UK_OP_PRM_LOGIC_ICC_LIST unique (ICC_ID)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_LOGIC_ICC_LIST to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_LOGIC_ICC_LIST to ACC_ST_DEV;

prompt
prompt Creating table OP_PRM_OFF_PEAK_HOURS
prompt ====================================
prompt
create table ACC_ST.OP_PRM_OFF_PEAK_HOURS
(
  water_no    NUMBER(18) not null,
  day_of_week CHAR(1),
  start_time  CHAR(4),
  end_time    CHAR(4),
  version_no  CHAR(10),
  record_flag CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_OFF_PEAK_HOURS
  is '(≤Œ ˝)∑«∑±√¶ ±º‰∂®“Â±Ì';
comment on column ACC_ST.OP_PRM_OFF_PEAK_HOURS.day_of_week
  is '–«∆⁄¥˙¬Î';
comment on column ACC_ST.OP_PRM_OFF_PEAK_HOURS.start_time
  is 'ø™ º ±º‰';
comment on column ACC_ST.OP_PRM_OFF_PEAK_HOURS.end_time
  is 'Ω· ¯ ±º‰';
alter table ACC_ST.OP_PRM_OFF_PEAK_HOURS
  add constraint PK_OP_PRM_OFF_PEAK_HOURS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_OFF_PEAK_HOURS to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_OFF_PEAK_HOURS to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_OFF_PEAK_HOURS to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_DISTRIBUTE_DTL
prompt =========================================
prompt
create table ACC_ST.OP_PRM_PARA_DISTRIBUTE_DTL
(
  water_no            NUMBER(18) not null,
  distribute_datetime DATE,
  operator_id         CHAR(8),
  distribute_result   CHAR(1),
  distribute_memo     VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_PARA_DISTRIBUTE_DTL
  is '≤Œ ˝œ¬∑¢«Èøˆ';
alter table ACC_ST.OP_PRM_PARA_DISTRIBUTE_DTL
  add constraint PK_OP_PRM_PARA_DISTRIBUTE_DTL primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_DISTRIBUTE_DTL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_DISTRIBUTE_DTL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_DISTRIBUTE_DTL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_GEN_DTL
prompt ==================================
prompt
create table ACC_ST.OP_PRM_PARA_GEN_DTL
(
  water_no     NUMBER(18) not null,
  parm_type_id CHAR(4) not null,
  version_type VARCHAR2(1),
  version_no   CHAR(10) not null,
  gen_result   CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_PARA_GEN_DTL
  add constraint PK_OP_PRM_PARA_GEN_DTL primary key (WATER_NO, PARM_TYPE_ID, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_GEN_DTL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_GEN_DTL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_GEN_DTL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_INFORM_DTL
prompt =====================================
prompt
create table ACC_ST.OP_PRM_PARA_INFORM_DTL
(
  water_no      NUMBER(18) not null,
  station_id    CHAR(2) not null,
  line_id       CHAR(2) not null,
  inform_result CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_PARA_INFORM_DTL
  is '(≤Œ ˝)≤Œ ˝œ¬∑¢Õ®÷™√˜œ∏';
alter table ACC_ST.OP_PRM_PARA_INFORM_DTL
  add constraint PK_OP_PRM_PARA_INFORM_DTL primary key (WATER_NO, STATION_ID, LINE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_INFORM_DTL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_INFORM_DTL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_INFORM_DTL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_STS_DL
prompt =================================
prompt
create table ACC_ST.OP_PRM_PARA_STS_DL
(
  status_datetime DATE,
  line_id         CHAR(2),
  station_id      CHAR(2),
  parm_type_id    CHAR(4),
  ver_num         CHAR(10),
  download_status CHAR(1),
  insert_time     DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_PARA_STS_DL
  is '≤Œ ˝œ¬‘ÿ◊¥Ã¨';
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_STS_DL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_STS_DL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_STS_DL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_VER
prompt ==============================
prompt
create table ACC_ST.OP_PRM_PARA_VER
(
  version_no       CHAR(10) not null,
  record_flag      CHAR(1) not null,
  begin_time       DATE,
  end_time         DATE,
  distribute_times INTEGER,
  parm_type_id     CHAR(4) not null,
  version_date     DATE,
  operator_id      CHAR(8),
  app_line_name    VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_PARA_VER
  is '≤Œ ˝∞Ê±æº«¬º±Ì';
alter table ACC_ST.OP_PRM_PARA_VER
  add constraint PK_OP_PRM_PARA_VER primary key (VERSION_NO, RECORD_FLAG, PARM_TYPE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_VER to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_VER to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_VER to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_VER_CM
prompt =================================
prompt
create table ACC_ST.OP_PRM_PARA_VER_CM
(
  parm_type_id CHAR(4) not null,
  version_no   CHAR(10) not null,
  version_type CHAR(1) not null,
  line_id      CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_PARA_VER_CM
  add primary key (LINE_ID, PARM_TYPE_ID, VERSION_TYPE)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_VER_CM to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_VER_CM to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_VER_CM to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PARA_VER_NOW
prompt ==================================
prompt
create table ACC_ST.OP_PRM_PARA_VER_NOW
(
  list_no      NUMBER not null,
  version_no   CHAR(10) not null,
  begin_time   CHAR(8) not null,
  end_time     CHAR(8) not null,
  record_flag  CHAR(1) not null,
  parm_type_id CHAR(4) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PARA_VER_NOW to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PARA_VER_NOW to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PARA_VER_NOW to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PASS_DETAIL
prompt =================================
prompt
create table ACC_ST.OP_PRM_PASS_DETAIL
(
  b_line_id    CHAR(2),
  b_station_id CHAR(2),
  e_line_id    CHAR(2),
  e_station_id CHAR(2),
  p_line_id    CHAR(2),
  proportion   NUMBER(4,2),
  version_no   CHAR(10) not null,
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_PASS_DETAIL
  is 'Õææ≠œﬂ¬∑±»¿˝≈‰÷√±Ì';
create index ACC_ST.IDX_ST_CFG_PASS_DETAIL on ACC_ST.OP_PRM_PASS_DETAIL (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PASS_DETAIL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PASS_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PASS_DETAIL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PAYMODE_TYPE
prompt ==================================
prompt
create table ACC_ST.OP_PRM_PAYMODE_TYPE
(
  pay_mode_id  CHAR(2) not null,
  paymode_name VARCHAR2(28),
  paymode_desc VARCHAR2(100),
  record_flag  CHAR(1) not null,
  version_no   CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_PAYMODE_TYPE
  add constraint PK_OP_PRM_PAYMODE_TYPE primary key (PAY_MODE_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PAYMODE_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PAYMODE_TYPE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PAYMODE_TYPE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PAYMODE_TYPE_VALID
prompt ========================================
prompt
create table ACC_ST.OP_PRM_PAYMODE_TYPE_VALID
(
  pay_mode_id  CHAR(2) not null,
  paymode_name VARCHAR2(28),
  paymode_desc VARCHAR2(100),
  record_flag  CHAR(1),
  version_no   CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_PAYMODE_TYPE_VALID
  add constraint PK_OP_PRM_PAYMODE_TYPE_VALID primary key (PAY_MODE_ID, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_PAYMODE_TYPE_VALID to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PAYMODE_TYPE_VALID to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PAYMODE_TYPE_VALID to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_PHY_LOGIC_LIST
prompt ====================================
prompt
create table ACC_ST.OP_PRM_PHY_LOGIC_LIST
(
  physic_no VARCHAR2(20) not null,
  logic_no  VARCHAR2(20),
  water_no  NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_PHY_LOGIC_LIST
  is 'ŒÔ¿Ìø®∫≈¬ﬂº≠ø®∫≈∂‘’’±Ì';
alter table ACC_ST.OP_PRM_PHY_LOGIC_LIST
  add constraint PK_OP_PRM_PHY_LOGIC_LIST primary key (PHYSIC_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_PHY_LOGIC_LIST
  add constraint UK_OP_PRM_PHY_LOGIC_LIST unique (LOGIC_NO)
  disable;
grant select on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_ST_RPT;
grant select, delete on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_PHY_LOGIC_LIST to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_REALFLOW_DETAIL
prompt =====================================
prompt
create table ACC_ST.OP_PRM_REALFLOW_DETAIL
(
  b_line_id      CHAR(2),
  b_station_id   CHAR(2),
  e_line_id      CHAR(2),
  e_station_id   CHAR(2),
  version_no     CHAR(10) not null,
  record_flag    CHAR(1) not null,
  direction_flag CHAR(1),
  is_border      CHAR(1) default 0
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_REALFLOW_DETAIL.is_border
  is '1Œ™œ‡¡⁄';
grant select, insert, update, delete on ACC_ST.OP_PRM_REALFLOW_DETAIL to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_REALFLOW_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_REALFLOW_DETAIL to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_SAM_LIST
prompt ==============================
prompt
create table ACC_ST.OP_PRM_SAM_LIST
(
  sam_logical_id VARCHAR2(20) not null,
  sam_type_id    CHAR(1),
  device_id      CHAR(3) not null,
  dev_type_id    CHAR(2) not null,
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  version_no     CHAR(10) not null,
  record_flag    CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_SAM_LIST
  is '(≤Œ ˝)SAMø®∂‘’’±Ì';
comment on column ACC_ST.OP_PRM_SAM_LIST.sam_logical_id
  is 'SAMø®¬ﬂº≠ø®∫≈';
comment on column ACC_ST.OP_PRM_SAM_LIST.sam_type_id
  is 'SAMø®¿‡–Õ¥˙¬Î';
comment on column ACC_ST.OP_PRM_SAM_LIST.device_id
  is '…Ë±∏¥˙¬Î';
comment on column ACC_ST.OP_PRM_SAM_LIST.dev_type_id
  is '…Ë±∏¿‡–Õ';
alter table ACC_ST.OP_PRM_SAM_LIST
  add constraint PK_OP_PRM_SAM_LIST primary key (DEVICE_ID, DEV_TYPE_ID, LINE_ID, STATION_ID, RECORD_FLAG, VERSION_NO, SAM_LOGICAL_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_SAM_LIST to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_SAM_LIST to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_SAM_LIST to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_SAM_LIST to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_SAM_LIST to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_SAM_LIST to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_SAM_LIST to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_SERVICE_RATE
prompt ==================================
prompt
create table ACC_ST.OP_PRM_SERVICE_RATE
(
  contc_id     CHAR(2) not null,
  version_no   CHAR(10) not null,
  service_rate NUMBER(12,2),
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_SERVICE_RATE
  is '(≤Œ ˝)∑˛ŒÒ∑—¬ ';
alter table ACC_ST.OP_PRM_SERVICE_RATE
  add constraint PK_OP_PRM_SERVICE_RATE primary key (CONTC_ID, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_SERVICE_RATE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_SERVICE_RATE to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_SERVICE_RATE to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_STATION
prompt =============================
prompt
create table ACC_ST.OP_PRM_STATION
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  chinese_name   VARCHAR2(20),
  english_name   VARCHAR2(50),
  sc_ip          VARCHAR2(15),
  contc_id       CHAR(2),
  record_flag    CHAR(1) not null,
  lcc_ip         CHAR(15),
  version_no     CHAR(10) not null,
  sequence       CHAR(2) default '00',
  belong_line_id CHAR(2) default '00'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_STATION
  is '≥µ’æ±Ì£®π˝∆⁄£©';
comment on column ACC_ST.OP_PRM_STATION.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.OP_PRM_STATION.station_id
  is '≥µ’æID';
comment on column ACC_ST.OP_PRM_STATION.chinese_name
  is '≥µ’æ÷–Œƒ√˚≥∆';
comment on column ACC_ST.OP_PRM_STATION.english_name
  is '≥µ’æ”¢Œƒ√˚≥∆';
comment on column ACC_ST.OP_PRM_STATION.sc_ip
  is '≥µ’æº∆À„ª˙µƒIPµÿ÷∑';
comment on column ACC_ST.OP_PRM_STATION.contc_id
  is '‘À”™…ÃID';
comment on column ACC_ST.OP_PRM_STATION.lcc_ip
  is 'SCÀ˘ ÙLCCµƒipµÿ÷∑';
comment on column ACC_ST.OP_PRM_STATION.sequence
  is '–Ú∫≈';
comment on column ACC_ST.OP_PRM_STATION.belong_line_id
  is 'À˘ Ùœﬂ¬∑';
alter table ACC_ST.OP_PRM_STATION
  add constraint PK_OP_PRM_STATION primary key (LINE_ID, STATION_ID, RECORD_FLAG, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_PRM_STATION to ACC_COMMU_APP;
grant select on ACC_ST.OP_PRM_STATION to ACC_COMMU_DEV;
grant select on ACC_ST.OP_PRM_STATION to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_PRM_STATION to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_STATION to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_STATION to ACC_ST_RPT;
grant select on ACC_ST.OP_PRM_STATION to ACC_TK_APP;
grant select on ACC_ST.OP_PRM_STATION to ACC_TK_DEV;
grant select on ACC_ST.OP_PRM_STATION to ACC_TK_RPT;

prompt
prompt Creating table OP_PRM_SVT_TYPE
prompt ==============================
prompt
create table ACC_ST.OP_PRM_SVT_TYPE
(
  card_main_id CHAR(2) not null,
  card_sub_id  CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_SVT_TYPE to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_SVT_TYPE to ACC_ST_DEV;

prompt
prompt Creating table OP_PRM_TRANSFER_STATION
prompt ======================================
prompt
create table ACC_ST.OP_PRM_TRANSFER_STATION
(
  line_id             CHAR(2) not null,
  station_id          CHAR(2) not null,
  transfer_line_id    CHAR(2) not null,
  transfer_station_id CHAR(2) not null,
  record_flag         CHAR(1) not null,
  version_no          CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_TRANSFER_STATION
  add constraint PK_OP_PRM_TRANSFER_STATION primary key (LINE_ID, STATION_ID, TRANSFER_LINE_ID, TRANSFER_STATION_ID, RECORD_FLAG, VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_TRANSFER_STATION to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_TRANSFER_STATION to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_TRANSFER_STATION to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_TVM_ALL_POSITION
prompt ======================================
prompt
create table ACC_ST.OP_PRM_TVM_ALL_POSITION
(
  line_id          VARCHAR2(20) not null,
  station_id       VARCHAR2(20) not null,
  x_position       NUMBER not null,
  y_position       NUMBER not null,
  width            NUMBER,
  height           NUMBER,
  operator_id      VARCHAR2(8),
  description      VARCHAR2(20),
  image_name       VARCHAR2(50),
  is_line          CHAR(1) not null,
  is_cross_station CHAR(1) not null,
  content          VARCHAR2(20) not null,
  resolution_id    CHAR(2) not null,
  is_use           CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_TVM_ALL_POSITION
  is 'TVM»´œﬂ¬∑µÿÕº◊¯±Í≤Œ ˝';
comment on column ACC_ST.OP_PRM_TVM_ALL_POSITION.is_line
  is ' «∑Òœﬂ¬∑Õº£®0»´Õº£¨1œﬂ¬∑Õº£©';
comment on column ACC_ST.OP_PRM_TVM_ALL_POSITION.is_cross_station
  is ' «∑Òªª≥À’æ£®0∑Ò£¨1 «£©';
comment on column ACC_ST.OP_PRM_TVM_ALL_POSITION.content
  is '∑÷±Ê¬ ƒ⁄»›';
comment on column ACC_ST.OP_PRM_TVM_ALL_POSITION.resolution_id
  is '∑÷±Ê¬ ±‡∫≈';
comment on column ACC_ST.OP_PRM_TVM_ALL_POSITION.is_use
  is ' «∑Òø…”√£®0∑Ò£¨1 «£©';
alter table ACC_ST.OP_PRM_TVM_ALL_POSITION
  add constraint PK_OP_PRM_TVM_ALL_POSITION primary key (RESOLUTION_ID, LINE_ID, STATION_ID, IS_LINE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_TVM_ALL_POSITION to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_TVM_ALL_POSITION to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_TVM_ALL_POSITION to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_TVM_DISPLAY
prompt =================================
prompt
create table ACC_ST.OP_PRM_TVM_DISPLAY
(
  version_no   CHAR(10) not null,
  chinese_text VARCHAR2(64),
  english_text VARCHAR2(64),
  record_flag  CHAR(1) not null,
  line_id      CHAR(2),
  station_id   CHAR(2),
  water_no     NUMBER(18) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
alter table ACC_ST.OP_PRM_TVM_DISPLAY
  add constraint PK_OP_PRM_TVM_DISPLAY primary key (VERSION_NO, RECORD_FLAG, WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.OP_PRM_TVM_DISPLAY to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_TVM_DISPLAY to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_TVM_DISPLAY to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_TVM_STOPSELL_CONFIG
prompt =========================================
prompt
create table ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG
(
  flow_id       NUMBER(18) not null,
  version_no    CHAR(10) not null,
  record_flag   CHAR(1) not null,
  timetable_id  VARCHAR2(2),
  begin_date    VARCHAR2(12),
  end_date      VARCHAR2(12),
  param_type_id CHAR(4)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG.timetable_id
  is ' ±º‰±ÌID';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG.begin_date
  is 'ø™ º ±º‰';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG.end_date
  is 'Ω· ¯ ±º‰';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG.param_type_id
  is '≤Œ ˝¿‡–ÕID';
alter table ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG
  add constraint PK_OP_PRM_TVM_STOPSELL_CONFIG primary key (FLOW_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG
  add constraint UK_OP_PRM_TVM_STOPSELL_CONFIG unique (VERSION_NO, RECORD_FLAG, BEGIN_DATE, END_DATE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_TVM_STOPSELL_CONFIG to ACC_ST_RPT;

prompt
prompt Creating table OP_PRM_TVM_STOPSELL_DETAIL_DEF
prompt =============================================
prompt
create table ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF
(
  version_no       CHAR(10) not null,
  record_flag      CHAR(1) not null,
  parm_type_id     CHAR(4) not null,
  timetable_id     CHAR(2) not null,
  start_station    CHAR(4) not null,
  dest_station     CHAR(4) not null,
  stopsell_time1   CHAR(4) not null,
  stopsell_time2   CHAR(4) not null,
  stopsell_endtime CHAR(4) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF
  is 'TVMÕ£ €œÍœ∏ ±º‰∂®“Â±Ì';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.parm_type_id
  is '≤Œ ˝¿‡–ÕID';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.timetable_id
  is ' ±º‰±ÌID';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.start_station
  is '≥ˆ∑¢’æ';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.dest_station
  is 'ƒøµƒ’æ';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.stopsell_time1
  is 'Õ£÷π∑¢ €µ•≥Ã∆±ø™ º ±º‰1£®Ã· æ ±º‰£©';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.stopsell_time2
  is 'Õ£÷π∑¢ €µ•≥Ã∆±ø™ º ±º‰2£®Õ£ € ±º‰£©';
comment on column ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF.stopsell_endtime
  is 'Õ£÷π∑¢ €µ•≥Ã∆±Ω· ¯ ±º‰';
alter table ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF
  add constraint PK_OP_PRM_TVM_STOPSELL_DETAIL_ primary key (VERSION_NO, RECORD_FLAG, PARM_TYPE_ID, TIMETABLE_ID, START_STATION, DEST_STATION)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF to ACC_ST_APP;
grant select on ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF to ACC_ST_DEV;
grant select on ACC_ST.OP_PRM_TVM_STOPSELL_DETAIL_DEF to ACC_ST_RPT;

prompt
prompt Creating table OP_REPORT_ATTRIBUTE
prompt ==================================
prompt
create table ACC_ST.OP_REPORT_ATTRIBUTE
(
  report_code        VARCHAR2(6) not null,
  report_name        VARCHAR2(50),
  report_module      VARCHAR2(6) not null,
  report_type        CHAR(1) not null,
  period_type        CHAR(1) not null,
  line_id            CHAR(2),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  data_table         VARCHAR2(500),
  report_lock        CHAR(1) not null,
  station_id         CHAR(2),
  out_type           VARCHAR2(10) not null,
  ds_id              VARCHAR2(50),
  generate_date      VARCHAR2(2),
  period_detail_type VARCHAR2(1),
  remark             VARCHAR2(200)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_REPORT_ATTRIBUTE.report_code
  is '±®±Ì¥˙¬Î';
comment on column ACC_ST.OP_REPORT_ATTRIBUTE.report_module
  is '±®±Ìƒ£∞Â∫≈';
comment on column ACC_ST.OP_REPORT_ATTRIBUTE.report_type
  is '1 ¥˙±Ì…˙≥…±®±Ì ∞¥‘À”™»’µ»”⁄«ÂÀ„»’ 2 ¥˙±Ì‘À”™»’¥”÷–º‰±Ì»°
';
comment on column ACC_ST.OP_REPORT_ATTRIBUTE.period_type
  is '1»’±®£¨2‘¬±®£¨3ƒÍ±®';
comment on column ACC_ST.OP_REPORT_ATTRIBUTE.report_lock
  is ' «∑ÒÀ¯∂®';
comment on column ACC_ST.OP_REPORT_ATTRIBUTE.out_type
  is ' ‰≥ˆ±®±ÌŒƒº˛¿‡–Õ';
alter table ACC_ST.OP_REPORT_ATTRIBUTE
  add constraint UK_OP_REPORT_ATTRIBUTE unique (OUT_TYPE, REPORT_CODE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_REPORT_ATTRIBUTE
  add constraint UK_OP_REPORT_ATTRIBUTE1 unique (REPORT_MODULE, OUT_TYPE, LINE_ID, CARD_MAIN_ID, CARD_SUB_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_REPORT_ATTRIBUTE to ACC_ST_APP;
grant select on ACC_ST.OP_REPORT_ATTRIBUTE to ACC_ST_DEV;
grant select on ACC_ST.OP_REPORT_ATTRIBUTE to ACC_ST_RPT;

prompt
prompt Creating table OP_REPORT_LINE_NO_STAT
prompt =====================================
prompt
create table ACC_ST.OP_REPORT_LINE_NO_STAT
(
  line_id   VARCHAR2(2) not null,
  line_name VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_REPORT_LINE_NO_STAT
  is 'œﬂ¬∑±®±Ì≤ªÕ≥º∆±Ì';
comment on column ACC_ST.OP_REPORT_LINE_NO_STAT.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.OP_REPORT_LINE_NO_STAT.line_name
  is 'œﬂ¬∑√˚≥∆';
alter table ACC_ST.OP_REPORT_LINE_NO_STAT
  add primary key (LINE_ID)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_REPORT_LINE_NO_STAT to ACC_ST_APP;
grant select on ACC_ST.OP_REPORT_LINE_NO_STAT to ACC_ST_DEV;
grant select on ACC_ST.OP_REPORT_LINE_NO_STAT to ACC_ST_RPT;

prompt
prompt Creating table OP_REPORT_MODULE_MAPPING
prompt =======================================
prompt
create table ACC_ST.OP_REPORT_MODULE_MAPPING
(
  module_id     VARCHAR2(6) not null,
  report_module VARCHAR2(6),
  description   VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.OP_REPORT_MODULE_MAPPING
  is '±®±Ìƒ£øÈ∂‘’’±Ì';
alter table ACC_ST.OP_REPORT_MODULE_MAPPING
  add constraint PK_OP_REPORT_MODULE_MAPPING primary key (MODULE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_REPORT_MODULE_MAPPING to ACC_ST_APP;
grant select on ACC_ST.OP_REPORT_MODULE_MAPPING to ACC_ST_DEV;
grant select on ACC_ST.OP_REPORT_MODULE_MAPPING to ACC_ST_RPT;

prompt
prompt Creating table OP_REPORT_PERIOD
prompt ===============================
prompt
create table ACC_ST.OP_REPORT_PERIOD
(
  period_detail_type VARCHAR2(1),
  begin_date         VARCHAR2(8),
  end_date           VARCHAR2(8)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_REPORT_PERIOD to ACC_ST_APP;
grant select on ACC_ST.OP_REPORT_PERIOD to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.OP_REPORT_PERIOD to ACC_ST_RPT;

prompt
prompt Creating table OP_REPORT_WATER_NO
prompt =================================
prompt
create table ACC_ST.OP_REPORT_WATER_NO
(
  report_water_no VARCHAR2(14) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_REPORT_WATER_NO to ACC_ST_APP;
grant select on ACC_ST.OP_REPORT_WATER_NO to ACC_ST_DEV;
grant select on ACC_ST.OP_REPORT_WATER_NO to ACC_ST_RPT;

prompt
prompt Creating table OP_SYS_GROUP
prompt ===========================
prompt
create table ACC_ST.OP_SYS_GROUP
(
  sys_group_id   CHAR(2) not null,
  sys_group_name VARCHAR2(50),
  sys_storage_id CHAR(4) default '0000' not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_SYS_GROUP
  add constraint SYS_GROUP_PK primary key (SYS_GROUP_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_SYS_GROUP to ACC_ST_APP;
grant select on ACC_ST.OP_SYS_GROUP to ACC_ST_DEV;
grant select on ACC_ST.OP_SYS_GROUP to ACC_ST_RPT;

prompt
prompt Creating table OP_SYS_GROUP_MODULE
prompt ==================================
prompt
create table ACC_ST.OP_SYS_GROUP_MODULE
(
  sys_group_id CHAR(2) not null,
  module_id    VARCHAR2(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create unique index ACC_ST.SYS_GROUP__PK on ACC_ST.OP_SYS_GROUP_MODULE (SYS_GROUP_ID, MODULE_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_SYS_GROUP_MODULE
  add constraint PK_OP_SYS_G_M primary key (MODULE_ID, SYS_GROUP_ID);
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_COMMU_APP;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_MONITOR_APP;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_ONLINE_APP;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_SYS_GROUP_MODULE to ACC_ST_APP;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_ST_DEV;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_ST_RPT;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_TK_APP;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_TK_DEV;
grant select on ACC_ST.OP_SYS_GROUP_MODULE to ACC_TK_RPT;

prompt
prompt Creating table OP_SYS_GROUP_OPERATOR
prompt ====================================
prompt
create table ACC_ST.OP_SYS_GROUP_OPERATOR
(
  sys_group_id    CHAR(2) not null,
  sys_operator_id VARCHAR2(8) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_SYS_GROUP_OPERATOR
  add constraint SYS_GROUP_OP_PK primary key (SYS_GROUP_ID, SYS_OPERATOR_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_COMMU_APP;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_MONITOR_APP;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_ONLINE_APP;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_ST_APP;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_ST_DEV;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_ST_RPT;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_TK_APP;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_TK_DEV;
grant select on ACC_ST.OP_SYS_GROUP_OPERATOR to ACC_TK_RPT;

prompt
prompt Creating table OP_SYS_MODULE
prompt ============================
prompt
create table ACC_ST.OP_SYS_MODULE
(
  module_id   VARCHAR2(10) not null,
  module_name VARCHAR2(50),
  menu_url    VARCHAR2(100),
  menu_icon   VARCHAR2(50),
  top_menu_id VARCHAR2(2),
  parent_id   VARCHAR2(10),
  locked      CHAR(1),
  sys_flag    VARCHAR2(3),
  btn_id      VARCHAR2(20),
  module_type CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.OP_SYS_MODULE.btn_id
  is '∞¥≈•µƒ»®œﬁ¥˙¬Î';
comment on column ACC_ST.OP_SYS_MODULE.module_type
  is 'ƒ£øÈµƒ¿‡–Õ£∫MŒ™≤Àµ•£¨BŒ™∞¥≈•';
alter table ACC_ST.OP_SYS_MODULE
  add constraint PK_OP_SYS_MODULE primary key (MODULE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.OP_SYS_MODULE to ACC_COMMU_APP;
grant select on ACC_ST.OP_SYS_MODULE to ACC_MONITOR_APP;
grant select on ACC_ST.OP_SYS_MODULE to ACC_ONLINE_APP;
grant select on ACC_ST.OP_SYS_MODULE to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_SYS_MODULE to ACC_ST_APP;
grant select on ACC_ST.OP_SYS_MODULE to ACC_ST_DEV;
grant select on ACC_ST.OP_SYS_MODULE to ACC_ST_RPT;
grant select on ACC_ST.OP_SYS_MODULE to ACC_TK_APP;
grant select on ACC_ST.OP_SYS_MODULE to ACC_TK_DEV;
grant select on ACC_ST.OP_SYS_MODULE to ACC_TK_RPT;

prompt
prompt Creating table OP_SYS_OPERATOR
prompt ==============================
prompt
create table ACC_ST.OP_SYS_OPERATOR
(
  sys_operator_id    VARCHAR2(8) not null,
  sys_password_hash  VARCHAR2(50),
  sys_operator_name  VARCHAR2(8),
  sys_employee_id    VARCHAR2(6),
  sys_expired_date   CHAR(14),
  sys_status         CHAR(1),
  login_num          INTEGER default 0 not null,
  failed_num         INTEGER default 0 not null,
  session_id         VARCHAR2(100),
  password_edit_date CHAR(8),
  edit_past_days     INTEGER default 0
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, update on ACC_ST.OP_SYS_OPERATOR to ACC_COMMU_APP;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_MONITOR_APP;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_ONLINE_APP;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.OP_SYS_OPERATOR to ACC_ST_APP;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_ST_DEV;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_ST_RPT;
grant select, update on ACC_ST.OP_SYS_OPERATOR to ACC_TK_APP;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_TK_DEV;
grant select on ACC_ST.OP_SYS_OPERATOR to ACC_TK_RPT;

prompt
prompt Creating table OP_SYS_VERSION
prompt =============================
prompt
create table ACC_ST.OP_SYS_VERSION
(
  version_no  VARCHAR2(10) not null,
  operator_id VARCHAR2(10),
  valid_date  CHAR(10),
  del_desc    VARCHAR2(255),
  update_desc VARCHAR2(255),
  add_desc    VARCHAR2(255),
  note        VARCHAR2(255)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.OP_SYS_VERSION
  add constraint ICCS_VERSION_PK_1 primary key (VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.OP_SYS_VERSION to ACC_ST_APP;
grant select on ACC_ST.OP_SYS_VERSION to ACC_ST_DEV;
grant select on ACC_ST.OP_SYS_VERSION to ACC_ST_RPT;

prompt
prompt Creating table SR_DISTANCE_CHANGE
prompt =================================
prompt
create table ACC_ST.SR_DISTANCE_CHANGE
(
  od_id              INTEGER,
  pchange_station_id VARCHAR2(2),
  pass_line_out      VARCHAR2(2),
  pass_line_in       VARCHAR2(2),
  pass_distance      NUMBER(13,4),
  nchange_station_id VARCHAR2(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_DISTANCE_CHANGE
  is 'ªª≥À’æµ„≥Àæ‡±Ì';
comment on column ACC_ST.SR_DISTANCE_CHANGE.od_id
  is 'OD¬∑æ∂ID';
comment on column ACC_ST.SR_DISTANCE_CHANGE.pchange_station_id
  is '…œ“ªªª≥À’æ(∞¸∫¨∆’æ)';
comment on column ACC_ST.SR_DISTANCE_CHANGE.pass_line_out
  is 'ªª≥ˆœﬂ¬∑';
comment on column ACC_ST.SR_DISTANCE_CHANGE.pass_line_in
  is 'ªª»Îœﬂ¬∑';
comment on column ACC_ST.SR_DISTANCE_CHANGE.pass_distance
  is 'æ≠π˝ªª≥ˆœﬂ¬∑≥Àæ‡';
comment on column ACC_ST.SR_DISTANCE_CHANGE.nchange_station_id
  is 'œ¬“ªªª≥À’æ(∞¸∫¨÷’’æ)';
grant select, insert, update, delete on ACC_ST.SR_DISTANCE_CHANGE to ACC_ST_APP;
grant select on ACC_ST.SR_DISTANCE_CHANGE to ACC_ST_DEV;
grant select on ACC_ST.SR_DISTANCE_CHANGE to ACC_ST_RPT;

prompt
prompt Creating table SR_DISTANCE_OD
prompt =============================
prompt
create table ACC_ST.SR_DISTANCE_OD
(
  id               INTEGER not null,
  o_line_id        VARCHAR2(2),
  o_station_id     VARCHAR2(2),
  e_line_id        VARCHAR2(2),
  e_station_id     VARCHAR2(2),
  pass_stations    VARCHAR2(1000),
  pass_time        INTEGER,
  change_times     INTEGER,
  stations_num     INTEGER,
  distance         NUMBER(13,4),
  version          VARCHAR2(20),
  record_flag      CHAR(1),
  create_time      DATE,
  create_operator  VARCHAR2(20),
  distance_percent NUMBER(8,6) default 0,
  distance_base    NUMBER(13,4) default 0
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_DISTANCE_OD
  is 'OD¬∑æ∂±Ì';
comment on column ACC_ST.SR_DISTANCE_OD.id
  is 'id';
comment on column ACC_ST.SR_DISTANCE_OD.o_line_id
  is '∆ º’æ';
comment on column ACC_ST.SR_DISTANCE_OD.o_station_id
  is '∆ ºœﬂ¬∑';
comment on column ACC_ST.SR_DISTANCE_OD.e_line_id
  is 'Ω· ¯’æ';
comment on column ACC_ST.SR_DISTANCE_OD.e_station_id
  is 'Ω· ¯œﬂ¬∑';
comment on column ACC_ST.SR_DISTANCE_OD.pass_stations
  is 'æ≠π˝’æµ„';
comment on column ACC_ST.SR_DISTANCE_OD.pass_time
  is '≥À≥µ◊‹ ±º‰';
comment on column ACC_ST.SR_DISTANCE_OD.change_times
  is 'ªª≥À◊‹¥Œ ˝';
comment on column ACC_ST.SR_DISTANCE_OD.stations_num
  is '◊‹’æ ˝';
comment on column ACC_ST.SR_DISTANCE_OD.distance
  is '◊‹¿Ô≥Ã ˝';
comment on column ACC_ST.SR_DISTANCE_OD.version
  is '∞Ê±æ';
comment on column ACC_ST.SR_DISTANCE_OD.record_flag
  is 'º«¬º±Í÷æ';
comment on column ACC_ST.SR_DISTANCE_OD.create_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.SR_DISTANCE_OD.create_operator
  is '¥¥Ω®»À';
comment on column ACC_ST.SR_DISTANCE_OD.distance_percent
  is '¡Ÿ ±œﬂ¬∑∑÷ÃØ±»¿˝';
comment on column ACC_ST.SR_DISTANCE_OD.distance_base
  is '¡Ÿ ±∑÷ÃØª˘ ˝';
alter table ACC_ST.SR_DISTANCE_OD
  add constraint PK_SR_OD_DISTANCE primary key (ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.SR_DISTANCE_OD to ACC_ST_APP;
grant select on ACC_ST.SR_DISTANCE_OD to ACC_ST_DEV;
grant select on ACC_ST.SR_DISTANCE_OD to ACC_ST_RPT;

prompt
prompt Creating table SR_LOG
prompt =====================
prompt
create table ACC_ST.SR_LOG
(
  serialno    NUMBER(18),
  operator_id VARCHAR2(8) not null,
  op_time     DATE not null,
  module_id   VARCHAR2(6) not null,
  oper_type   VARCHAR2(50) not null,
  description VARCHAR2(200),
  sys_type    VARCHAR2(2) default 0
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_LOG
  is '«Â∑÷πÊ‘Ú»’÷æ±Ì';
comment on column ACC_ST.SR_LOG.serialno
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.SR_LOG.operator_id
  is '≤Ÿ◊˜‘±';
comment on column ACC_ST.SR_LOG.op_time
  is '≤Ÿ◊˜ ±º‰';
comment on column ACC_ST.SR_LOG.module_id
  is 'ƒ£øÈ';
comment on column ACC_ST.SR_LOG.oper_type
  is '≤Ÿ◊˜¿‡–Õ';
comment on column ACC_ST.SR_LOG.description
  is '√Ë ˆ';
grant select, insert, update, delete on ACC_ST.SR_LOG to ACC_ST_APP;
grant select on ACC_ST.SR_LOG to ACC_ST_DEV;
grant select on ACC_ST.SR_LOG to ACC_ST_RPT;

prompt
prompt Creating table SR_PARAMS_STATION
prompt ================================
prompt
create table ACC_ST.SR_PARAMS_STATION
(
  p_station_id    VARCHAR2(2) not null,
  n_station_id    VARCHAR2(2) not null,
  line_id         VARCHAR2(2) not null,
  record_flag     CHAR(1),
  version         VARCHAR2(20) not null,
  mileage         NUMBER(13,4),
  create_time     DATE,
  create_operator VARCHAR2(20),
  n_t_station_id  VARCHAR2(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_PARAMS_STATION
  is 'œﬂ¬∑’æµ„ª˘±æ≤Œ ˝±Ì';
comment on column ACC_ST.SR_PARAMS_STATION.p_station_id
  is 'µ±«∞’æ';
comment on column ACC_ST.SR_PARAMS_STATION.n_station_id
  is 'œ¬“ª’æ';
comment on column ACC_ST.SR_PARAMS_STATION.line_id
  is 'œﬂ¬∑';
comment on column ACC_ST.SR_PARAMS_STATION.record_flag
  is '…Û∫À◊¥Ã¨ 0:”––ß◊¥Ã¨';
comment on column ACC_ST.SR_PARAMS_STATION.version
  is '∞Ê±æ';
comment on column ACC_ST.SR_PARAMS_STATION.mileage
  is '¿Ô≥Ã ˝£®km£©';
comment on column ACC_ST.SR_PARAMS_STATION.create_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.SR_PARAMS_STATION.create_operator
  is '¥¥Ω®»À';
comment on column ACC_ST.SR_PARAMS_STATION.n_t_station_id
  is 'œ¬“ªªª≥À’æ';
alter table ACC_ST.SR_PARAMS_STATION
  add constraint PROMARY_SR_PARAMS_STATION primary key (LINE_ID, P_STATION_ID, N_STATION_ID, VERSION)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.SR_PARAMS_STATION to ACC_ST_APP;
grant select on ACC_ST.SR_PARAMS_STATION to ACC_ST_DEV;
grant select on ACC_ST.SR_PARAMS_STATION to ACC_ST_RPT;

prompt
prompt Creating table SR_PARAMS_SYS
prompt ============================
prompt
create table ACC_ST.SR_PARAMS_SYS
(
  type_code        VARCHAR2(2) not null,
  type_description VARCHAR2(100),
  code             VARCHAR2(2) not null,
  value            VARCHAR2(100),
  description      VARCHAR2(100),
  record_flag      CHAR(1) not null,
  version          VARCHAR2(20) not null,
  create_time      DATE,
  create_operator  VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_PARAMS_SYS
  is 'œµÕ≥≤Œ ˝±Ì';
comment on column ACC_ST.SR_PARAMS_SYS.type_code
  is '¿‡–Õ¥˙¬Î';
comment on column ACC_ST.SR_PARAMS_SYS.type_description
  is '¿‡–Õ√Ë ˆ';
comment on column ACC_ST.SR_PARAMS_SYS.code
  is '≤Œ ˝¥˙¬Î';
comment on column ACC_ST.SR_PARAMS_SYS.value
  is '≤Œ ˝÷µ';
comment on column ACC_ST.SR_PARAMS_SYS.description
  is '≤Œ ˝√Ë ˆ';
comment on column ACC_ST.SR_PARAMS_SYS.record_flag
  is '…Û∫À◊¥Ã¨ 0:”––ß◊¥Ã¨';
comment on column ACC_ST.SR_PARAMS_SYS.version
  is '∞Ê±æ';
comment on column ACC_ST.SR_PARAMS_SYS.create_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.SR_PARAMS_SYS.create_operator
  is '¥¥Ω®»À';
alter table ACC_ST.SR_PARAMS_SYS
  add constraint PRIMARY_SR_PARAMS_SYS primary key (TYPE_CODE, CODE, VERSION, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.SR_PARAMS_SYS to ACC_ST_APP;
grant select on ACC_ST.SR_PARAMS_SYS to ACC_ST_DEV;
grant select on ACC_ST.SR_PARAMS_SYS to ACC_ST_RPT;

prompt
prompt Creating table SR_PARAMS_THRESHOLD
prompt ==================================
prompt
create table ACC_ST.SR_PARAMS_THRESHOLD
(
  distance_thres  NUMBER(8,4),
  station_thres   INTEGER,
  change_thres    INTEGER,
  time_thres      INTEGER,
  description     VARCHAR2(100),
  record_flag     CHAR(1) not null,
  version         VARCHAR2(20) not null,
  update_time     DATE,
  update_operator VARCHAR2(20),
  id              INTEGER not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_PARAMS_THRESHOLD
  is '∑ß÷µ≤Œ ˝±Ì';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.distance_thres
  is '¿Ô≥Ã≤Ó±»¿˝∑ß÷µ';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.station_thres
  is '’æµ„≤Ó∑ß÷µ';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.change_thres
  is 'ªª≥À¥Œ ˝∑ß÷µ';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.time_thres
  is '≥À≥µ ±º‰£®s£©∑ß÷µ';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.description
  is '√Ë ˆ';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.record_flag
  is '¿˙ ∑◊¥Ã¨';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.version
  is '∞Ê±æ';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.update_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.update_operator
  is '¥¥Ω®»À';
comment on column ACC_ST.SR_PARAMS_THRESHOLD.id
  is 'id';
alter table ACC_ST.SR_PARAMS_THRESHOLD
  add constraint SR_PARAMS_THRESHOLD_PKEY primary key (ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.SR_PARAMS_THRESHOLD to ACC_ST_APP;
grant select on ACC_ST.SR_PARAMS_THRESHOLD to ACC_ST_DEV;
grant select on ACC_ST.SR_PARAMS_THRESHOLD to ACC_ST_RPT;

prompt
prompt Creating table SR_PROPORTION
prompt ============================
prompt
create table ACC_ST.SR_PROPORTION
(
  version         VARCHAR2(20) not null,
  record_flag     CHAR(1) not null,
  o_station_id    VARCHAR2(2) not null,
  o_line_id       VARCHAR2(2) not null,
  d_station_id    VARCHAR2(2) not null,
  d_line_id       VARCHAR2(2) not null,
  dispart_line_id VARCHAR2(2) not null,
  in_percent      NUMBER(8,6),
  create_time     DATE,
  create_operator VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.SR_PROPORTION
  is 'OD«Â∑÷»®÷ÿ≤È—ØΩ·π˚';
comment on column ACC_ST.SR_PROPORTION.version
  is '∞Ê±æ';
comment on column ACC_ST.SR_PROPORTION.record_flag
  is '…Û∫À◊¥Ã¨ 0:”––ß◊¥Ã¨';
comment on column ACC_ST.SR_PROPORTION.o_station_id
  is 'ø™ º’æµ„';
comment on column ACC_ST.SR_PROPORTION.o_line_id
  is 'ø™ º¬∑œﬂ';
comment on column ACC_ST.SR_PROPORTION.d_station_id
  is 'Ω· ¯’æµ„';
comment on column ACC_ST.SR_PROPORTION.d_line_id
  is 'Ω· ¯’æµ„';
comment on column ACC_ST.SR_PROPORTION.dispart_line_id
  is '»®÷ÿ¬∑œﬂ';
comment on column ACC_ST.SR_PROPORTION.in_percent
  is '»®÷ÿ±»¿˝';
comment on column ACC_ST.SR_PROPORTION.create_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.SR_PROPORTION.create_operator
  is '¥¥Ω®»À';
alter table ACC_ST.SR_PROPORTION
  add constraint SR_RESULT_PROP_PRIMARY_KEY primary key (O_STATION_ID, D_STATION_ID, DISPART_LINE_ID, VERSION, RECORD_FLAG, O_LINE_ID, D_LINE_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.SR_PROPORTION to ACC_ST_APP;
grant select on ACC_ST.SR_PROPORTION to ACC_ST_DEV;
grant select on ACC_ST.SR_PROPORTION to ACC_ST_RPT;

prompt
prompt Creating table SR_SYS_VERSION
prompt =============================
prompt
create table ACC_ST.SR_SYS_VERSION
(
  version_no  VARCHAR2(10) not null,
  operator_id VARCHAR2(10),
  valid_date  CHAR(10),
  del_desc    VARCHAR2(255),
  update_desc VARCHAR2(255),
  add_desc    VARCHAR2(255),
  note        VARCHAR2(255)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.SR_SYS_VERSION
  add constraint SR_VERSION_PK_1 primary key (VERSION_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.SR_SYS_VERSION to ACC_ST_APP;
grant select on ACC_ST.SR_SYS_VERSION to ACC_ST_DEV;
grant select on ACC_ST.SR_SYS_VERSION to ACC_ST_RPT;

prompt
prompt Creating table ST_ACT_SAM
prompt =========================
prompt
create table ACC_ST.ST_ACT_SAM
(
  line_id             CHAR(2) not null,
  station_id          CHAR(2) not null,
  dev_type_id         CHAR(2) not null,
  device_id           CHAR(3) not null,
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  sam_logical_id      CHAR(20) not null,
  sam_trade_seq_start NUMBER(18) not null,
  sam_trade_seq_end   NUMBER(18) not null,
  total_deal_num      NUMBER(10),
  balance_water_no    CHAR(10) not null,
  tk_app_mode         CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_ACT_SAM
  add constraint ST_ACT_SAM_PK primary key (LINE_ID, STATION_ID, DEV_TYPE_ID, DEVICE_ID, TK_APP_MODE, SAM_TRADE_SEQ_START, SAM_TRADE_SEQ_END, SAM_LOGICAL_ID, BALANCE_WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SAM to ACC_ST_APP;
grant select on ACC_ST.ST_ACT_SAM to ACC_ST_DEV;
grant select on ACC_ST.ST_ACT_SAM to ACC_ST_RPT;

prompt
prompt Creating table ST_ACT_SAM_BAK20160406
prompt =====================================
prompt
create table ACC_ST.ST_ACT_SAM_BAK20160406
(
  line_id             CHAR(2) not null,
  station_id          CHAR(2) not null,
  dev_type_id         CHAR(2) not null,
  device_id           CHAR(3) not null,
  card_main_id        CHAR(2) not null,
  card_sub_id         CHAR(2) not null,
  sam_logical_id      CHAR(20) not null,
  sam_trade_seq_start NUMBER(18) not null,
  sam_trade_seq_end   NUMBER(18) not null,
  total_deal_num      NUMBER(10),
  balance_water_no    CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SAM_BAK20160406 to ACC_ST_APP;

prompt
prompt Creating table ST_ACT_SAM_BAK20160408
prompt =====================================
prompt
create table ACC_ST.ST_ACT_SAM_BAK20160408
(
  line_id             CHAR(2) not null,
  station_id          CHAR(2) not null,
  dev_type_id         CHAR(2) not null,
  device_id           CHAR(3) not null,
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  sam_logical_id      CHAR(20) not null,
  sam_trade_seq_start NUMBER(18) not null,
  sam_trade_seq_end   NUMBER(18) not null,
  total_deal_num      NUMBER(10),
  balance_water_no    CHAR(10),
  tk_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SAM_BAK20160408 to ACC_ST_APP;

prompt
prompt Creating table ST_ACT_SAM_DEL
prompt =============================
prompt
create table ACC_ST.ST_ACT_SAM_DEL
(
  line_id             CHAR(2) not null,
  station_id          CHAR(2) not null,
  dev_type_id         CHAR(2) not null,
  device_id           CHAR(3) not null,
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  sam_logical_id      CHAR(20) not null,
  sam_trade_seq_start NUMBER(18) not null,
  sam_trade_seq_end   NUMBER(18) not null,
  total_deal_num      NUMBER(10),
  balance_water_no    CHAR(10),
  del_balance_no      CHAR(10),
  tk_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SAM_DEL to ACC_ST_APP;
grant select, update on ACC_ST.ST_ACT_SAM_DEL to ACC_ST_DEV;
grant select on ACC_ST.ST_ACT_SAM_DEL to ACC_ST_RPT;

prompt
prompt Creating table ST_ACT_SVT
prompt =========================
prompt
create table ACC_ST.ST_ACT_SVT
(
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20) not null,
  card_physical_id    CHAR(20),
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  max_deal_time       DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_ACT_SVT
  add constraint ST_ACT_SVT_PK primary key (CARD_LOGICAL_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SVT to ACC_ST_APP;
grant select on ACC_ST.ST_ACT_SVT to ACC_ST_DEV;
grant select on ACC_ST.ST_ACT_SVT to ACC_ST_RPT;

prompt
prompt Creating table ST_ACT_SVT_AGAIN
prompt ===============================
prompt
create table ACC_ST.ST_ACT_SVT_AGAIN
(
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20),
  again_time       DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_ACT_SVT_AGAIN
  is '¥¢÷µ∆±÷ÿ±‡¬Î ±º‰º«¬º±Ì';
create index ACC_ST.IDX_ST_ACT_SVT_AGAIN on ACC_ST.ST_ACT_SVT_AGAIN (CARD_LOGICAL_ID, CARD_PHYSICAL_ID, AGAIN_TIME)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_ACT_SVT_AGAIN_LOGICAL on ACC_ST.ST_ACT_SVT_AGAIN (CARD_LOGICAL_ID)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SVT_AGAIN to ACC_ST_APP;
grant select on ACC_ST.ST_ACT_SVT_AGAIN to ACC_ST_DEV;
grant select on ACC_ST.ST_ACT_SVT_AGAIN to ACC_ST_RPT;

prompt
prompt Creating table ST_ACT_SVT_BAK20170227
prompt =====================================
prompt
create table ACC_ST.ST_ACT_SVT_BAK20170227
(
  card_main_id        CHAR(2) not null,
  card_sub_id         CHAR(2) not null,
  card_logical_id     CHAR(20) not null,
  card_physical_id    CHAR(20) not null,
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  max_deal_time       DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ACT_SVT_BAK20170227 to ACC_ST_APP;
grant select on ACC_ST.ST_ACT_SVT_BAK20170227 to ACC_ST_DEV;

prompt
prompt Creating table ST_ACT_SVT_OLD
prompt =============================
prompt
create table ACC_ST.ST_ACT_SVT_OLD
(
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20) not null,
  card_physical_id    CHAR(20),
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  max_deal_time       DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_ACT_SVT_OLD
  is 'æ…ø®’Àªßº«¬º±Ì';
grant select, insert, update, delete on ACC_ST.ST_ACT_SVT_OLD to ACC_ST_APP;
grant select on ACC_ST.ST_ACT_SVT_OLD to ACC_ST_DEV;
grant select on ACC_ST.ST_ACT_SVT_OLD to ACC_ST_RPT;

prompt
prompt Creating table ST_AUD_OCT_EXPORT
prompt ================================
prompt
create table ACC_ST.ST_AUD_OCT_EXPORT
(
  file_name        VARCHAR2(30),
  total_record_num NUMBER(18),
  total_record_fee NUMBER(18,2),
  file_name_audit  VARCHAR2(30),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_AUD_OCT_EXPORT to ACC_ST_APP;
grant select on ACC_ST.ST_AUD_OCT_EXPORT to ACC_ST_DEV;
grant select on ACC_ST.ST_AUD_OCT_EXPORT to ACC_ST_RPT;

prompt
prompt Creating table ST_BACT_INC000001
prompt ================================
prompt
create table ACC_ST.ST_BACT_INC000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  contc_id         CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2),
  balance_ser_fee  NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_BACT_INC000001
  is '‘À”™…ÃΩ·À„Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_BACT_INC000001 on ACC_ST.ST_BACT_INC000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_BACT_INC000001
  add constraint PK_ST_BACT_INC000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BACT_INC000001 to ACC_ST_APP;
grant select on ACC_ST.ST_BACT_INC000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_BACT_TRD000001
prompt ================================
prompt
create table ACC_ST.ST_BACT_TRD000001
(
  water_no         NUMBER(20) not null,
  contc_id         CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_BACT_TRD000001
  is 'Ωª“◊ ˝æ›Ω·À„Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_BACT_TRD000001_1 on ACC_ST.ST_BACT_TRD000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_BACT_TRD000001_2 on ACC_ST.ST_BACT_TRD000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_BACT_TRD000001
  add constraint PK_ST_BACT_TRD000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BACT_TRD000001 to ACC_ST_APP;
grant select on ACC_ST.ST_BACT_TRD000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_BALANCE_WATER
prompt ===============================
prompt
create table ACC_ST.ST_BALANCE_WATER
(
  balance_water_no  CHAR(10) not null,
  gen_time          DATE,
  operator_id       CHAR(6),
  is_rpt            CHAR(1),
  center_balance_no CHAR(10),
  begin_datetime    DATE,
  end_datetime      DATE,
  step              NUMBER
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_BALANCE_WATER
  is '«ÂÀ„¡˜ÀÆ∫≈º«¬º±Ì';
alter table ACC_ST.ST_BALANCE_WATER
  add constraint PK_ST_BALANCE_WATER primary key (BALANCE_WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BALANCE_WATER to ACC_ST_APP;
grant select on ACC_ST.ST_BALANCE_WATER to ACC_ST_DEV;
grant select on ACC_ST.ST_BALANCE_WATER to ACC_ST_RPT;

prompt
prompt Creating table ST_BALI_INC000001
prompt ================================
prompt
create table ACC_ST.ST_BALI_INC000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id_dispart  CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2),
  balance_ser_fee  NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_BALI_INC000001 on ACC_ST.ST_BALI_INC000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_BALI_INC000001
  add constraint PK_ST_BALI_INC000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BALI_INC000001 to ACC_ST_APP;
grant select on ACC_ST.ST_BALI_INC000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_BALI_TRD000001
prompt ================================
prompt
create table ACC_ST.ST_BALI_TRD000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id_dispart  CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_BALI_TRD000001
  is 'Ωª“◊ ˝æ›Ω·À„Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_BALI_TRD0000011 on ACC_ST.ST_BALI_TRD000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_BALI_TRD0000012 on ACC_ST.ST_BALI_TRD000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_BALI_TRD000001
  add constraint PK_ST_BALI_TRD000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BALI_TRD000001 to ACC_ST_APP;
grant select on ACC_ST.ST_BALI_TRD000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_BUF_ADMIN
prompt ===========================
prompt
create table ACC_ST.ST_BUF_ADMIN
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  admin_datetime   DATE,
  admin_way_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  return_fee       NUMBER(18,2),
  penalty_fee      NUMBER(18,2),
  admin_reason_id  CHAR(2),
  describe         CHAR(30),
  passenger_name   CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_ADMIN to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_AGM_CARD_DATA
prompt ===================================
prompt
create table ACC_ST.ST_BUF_AGM_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  box_id           VARCHAR2(16),
  water_no_op      NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_AGM_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_AGM_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_AGM_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_AGM_CUTOFF_DTL
prompt ====================================
prompt
create table ACC_ST.ST_BUF_AGM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_AGM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_AGM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_AGM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_AGM_CUTOFF_TOTAL
prompt ======================================
prompt
create table ACC_ST.ST_BUF_AGM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  box_pop_num      NUMBER(18),
  total_num        NUMBER(18),
  total_fee        NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_AUDIT
prompt ===========================
prompt
create table ACC_ST.ST_BUF_AUDIT
(
  file_type        CHAR(3),
  file_name        CHAR(20),
  file_size        INTEGER,
  line_id          CHAR(2),
  station_id       CHAR(2),
  open_time        CHAR(14),
  close_time       CHAR(14),
  serial_no        INTEGER,
  record_count     INTEGER,
  real_recd_count  INTEGER,
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_BUF_AUDIT
  is 'Œƒº˛…Ûº∆ª∫¥Ê±Ì';
create index ACC_ST.IDX_ST_BUF_AUDIT on ACC_ST.ST_BUF_AUDIT (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_BUF_AUDIT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_AUDIT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_AUDIT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT
prompt ===============================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT
(
  water_no            NUMBER(20) not null,
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  operator_id         CHAR(8),
  shift_id            CHAR(2),
  start_time          CHAR(14),
  end_time            CHAR(14),
  group_1_count       INTEGER,
  total_sale          CHAR(10),
  group_2_count       INTEGER,
  total_add           CHAR(10),
  group_3_count       INTEGER,
  total_cash_update   CHAR(10),
  total_update        CHAR(10),
  group_4_count       INTEGER,
  total_return_affair CHAR(10),
  total_affair        CHAR(10),
  group_5_count       INTEGER,
  group_6_count       INTEGER,
  total_return        CHAR(10),
  group_7_count       INTEGER,
  total_non_return    CHAR(10),
  group_8_count       INTEGER,
  group_9_count       INTEGER,
  total_chongzheng    CHAR(1),
  group_10_count      INTEGER,
  total_nocash        CHAR(10),
  total_cash          CHAR(10),
  balance_water_no    CHAR(10),
  file_name           CHAR(25),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_BUF_BOM_SHIFT
  is 'BOM∞‡¥Œ ˝æ›÷˜±Ìª∫¥Ê±Ì';
create index ACC_ST.IDX_ST_BUF_BOM_SHIFT_1 on ACC_ST.ST_BUF_BOM_SHIFT (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
create index ACC_ST.IDX_ST_BUF_BOM_SHIFT_2 on ACC_ST.ST_BUF_BOM_SHIFT (START_TIME)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
alter table ACC_ST.ST_BUF_BOM_SHIFT
  add constraint PK_ST_BUF_BOM_SHIFT primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_ADMIN
prompt =====================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_ADMIN
(
  water_no         NUMBER(18) not null,
  admin_way_id     CHAR(2),
  admin_reason_id  CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_ADMIN to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_CHARGE
prompt ======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_CHARGE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_CHARGE to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_CHARGE to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_CHARGE to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_CHG_UPD
prompt =======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_CHG_UPD
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_CHG_UPD to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_CHG_UPD to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_CHG_UPD to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_DELAY
prompt =====================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_DELAY
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_RETURN
prompt ======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_RETURN
(
  water_no           NUMBER(18) not null,
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  num                NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  return_type        CHAR(1),
  is_broken          CHAR(1),
  penalty_fee        NUMBER(18,2),
  penalty_reason     CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_RTN_APP
prompt =======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_RTN_APP
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_RTN_NON
prompt =======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_RTN_NON
(
  water_no           NUMBER(18) not null,
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  num                NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  return_type        CHAR(1),
  is_broken          CHAR(1),
  penalty_fee        NUMBER(18,2),
  penalty_reason     CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_RTN_NON to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_RTN_NON to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_RTN_NON to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_SALE
prompt ====================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_SALE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_TOTAL
prompt =====================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_TOTAL
(
  water_no                 NUMBER(18) not null,
  line_id                  CHAR(2),
  station_id               CHAR(2),
  dev_type_id              CHAR(2),
  device_id                CHAR(3),
  operator_id              CHAR(6),
  shift_id                 CHAR(2),
  start_time               DATE,
  end_time                 DATE,
  sale_total_num           NUMBER(18),
  sale_total_fee           NUMBER(18,2),
  charge_total_num         NUMBER(18),
  charge_total_fee         NUMBER(18,2),
  update_total_num         NUMBER(18),
  update_total_fee         NUMBER(18,2),
  update_total_fee_cash    NUMBER(18,2),
  admin_total_num          NUMBER(18),
  admin_total_fee_return   NUMBER(18,2),
  admin_total_fee_income   NUMBER(18,2),
  delay_total_num          NUMBER(18),
  return_total_num         NUMBER(18),
  return_total_fee         NUMBER(18,2),
  return_non_total_num     NUMBER(18),
  return_non_total_fee     NUMBER(18,2),
  return_non_app_total_num NUMBER(18),
  charge_update_total_num  NUMBER(18),
  charge_update_total_fee  NUMBER(18,2),
  unlock_total_num         NUMBER(18),
  total_fee_nocash         NUMBER(18,2),
  total_fee_cash           NUMBER(18,2),
  balance_water_no         CHAR(10),
  file_name                VARCHAR2(30),
  check_flag               CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_UNLOCK
prompt ======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_UNLOCK
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_UNLOCK to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_UNLOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_UNLOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_BOM_SHIFT_UPDATE
prompt ======================================
prompt
create table ACC_ST.ST_BUF_BOM_SHIFT_UPDATE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  update_reason    CHAR(2),
  pay_type         CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_BOM_SHIFT_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_BOM_SHIFT_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_DEAL
prompt ==========================
prompt
create table ACC_ST.ST_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_DEAL_BANK
prompt ===============================
prompt
create table ACC_ST.ST_BUF_DEAL_BANK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_DEAL_BANK to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_DEAL_BANK to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_DEAL_BANK to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_DEAL_OCT
prompt ==============================
prompt
create table ACC_ST.ST_BUF_DEAL_OCT
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_DEAL_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_DEAL_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_DEAL_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_DELAY
prompt ===========================
prompt
create table ACC_ST.ST_BUF_DELAY
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  card_status_id      CHAR(3),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  operate_datetime    DATE,
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_ENTRY
prompt ===========================
prompt
create table ACC_ST.ST_BUF_ENTRY
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_ENTRY to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_ENTRY to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_LCC
prompt =========================
prompt
create table ACC_ST.ST_BUF_LCC
(
  water_no                NUMBER(18),
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2),
  file_name               VARCHAR2(30),
  check_flag              CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_LCC to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_LCC to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_LOCK
prompt ==========================
prompt
create table ACC_ST.ST_BUF_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_LOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_LOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_NON_RTN_APP
prompt =================================
prompt
create table ACC_ST.ST_BUF_NON_RTN_APP
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_print_id    CHAR(16),
  apply_datetime   DATE,
  receipt_id       CHAR(4),
  operator_id      CHAR(6),
  apply_name       CHAR(8),
  tel_no           CHAR(12),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  is_broken        CHAR(2),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_NON_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_REG_DTL
prompt =============================
prompt
create table ACC_ST.ST_BUF_REG_DTL
(
  water_no         NUMBER(18) not null,
  data_code        NUMBER(18),
  data_value       NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_REG_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_REG_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_REG_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_REG_TOTAL
prompt ===============================
prompt
create table ACC_ST.ST_BUF_REG_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  commu_datetime   DATE,
  gen_datetime     DATE,
  total_num        NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_REG_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_REG_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_REG_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_REPORT_LOSS
prompt =================================
prompt
create table ACC_ST.ST_BUF_REPORT_LOSS
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  apply_name          CHAR(8),
  apply_sex           CHAR(1),
  identity_type       CHAR(1),
  identity_id         CHAR(18),
  expired_date        CHAR(8),
  tel_no              CHAR(16),
  fax                 CHAR(16),
  address             CHAR(30),
  operator_id         CHAR(6),
  apply_datetime      DATE,
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  apply_business_type CHAR(1),
  receipt_id          CHAR(4),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_BUF_REPORT_LOSS to ACC_ST_APP;

prompt
prompt Creating table ST_BUF_RETURN
prompt ============================
prompt
create table ACC_ST.ST_BUF_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_SALE
prompt ==========================
prompt
create table ACC_ST.ST_BUF_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_SALE_OCT
prompt ==============================
prompt
create table ACC_ST.ST_BUF_SALE_OCT
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_SALE_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_SALE_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_SALE_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_SALE_SJT
prompt ==============================
prompt
create table ACC_ST.ST_BUF_SALE_SJT
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_SALE_SJT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_SIGN_CARD
prompt ===============================
prompt
create table ACC_ST.ST_BUF_SIGN_CARD
(
  water_no         NUMBER(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  proposer_name    CHAR(8),
  proposer_sex     CHAR(1),
  ind_type         CHAR(1),
  national_id      CHAR(18),
  expired_date     CHAR(8),
  tel_no           CHAR(16),
  fax              CHAR(16),
  address          CHAR(200),
  operator_id      CHAR(8),
  app_date         DATE,
  shift_id         CHAR(2),
  balance_water_no CHAR(10),
  file_name        CHAR(25),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_BUF_SIGN_CARD
  is 'º«√˚ø®…Í«ÎΩª“◊ª∫¥Ê±Ì';
create index ACC_ST.IDX_ST_BUF_SIGN_CARD_1 on ACC_ST.ST_BUF_SIGN_CARD (LINE_ID, STATION_ID, DEV_TYPE_ID, DEVICE_ID, NATIONAL_ID, APP_DATE)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
create index ACC_ST.IDX_ST_BUF_SIGN_CARD_2 on ACC_ST.ST_BUF_SIGN_CARD (FILE_NAME, BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_BUF_SIGN_CARD to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_SIGN_CARD to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_SIGN_CARD to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_SIGN_CARD_APPLY
prompt =====================================
prompt
create table ACC_ST.ST_BUF_SIGN_CARD_APPLY
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_SIGN_CARD_APPLY to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_SIGN_CARD_APPLY to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_SIGN_CARD_APPLY to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_AUTO_BAL
prompt ==================================
prompt
create table ACC_ST.ST_BUF_TVM_AUTO_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_AUTO_BAL to ACC_ST_APP;

prompt
prompt Creating table ST_BUF_TVM_BAL
prompt =============================
prompt
create table ACC_ST.ST_BUF_TVM_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_BAL to ACC_ST_APP;

prompt
prompt Creating table ST_BUF_TVM_CARD_CLEAR
prompt ====================================
prompt
create table ACC_ST.ST_BUF_TVM_CARD_CLEAR
(
  water_no              NUMBER(18) not null,
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  operator_id           CHAR(6),
  clear_datetime        DATE,
  water_no_op           NUMBER(18),
  card_main_id_hopper_1 CHAR(2),
  card_sub_id_hopper_1  CHAR(2),
  card_main_id_hopper_2 CHAR(2),
  card_sub_id_hopper_2  CHAR(2),
  hopper_1_num          NUMBER(18),
  hopper_2_num          NUMBER(18),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_CARD_CLEAR to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_CARD_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_CARD_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_CARD_PUT
prompt ==================================
prompt
create table ACC_ST.ST_BUF_TVM_CARD_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  box_id           VARCHAR2(16),
  hopper_id        NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_CARD_PUT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_CARD_PUT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_CARD_PUT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_COIN_CLEAR
prompt ====================================
prompt
create table ACC_ST.ST_BUF_TVM_COIN_CLEAR
(
  water_no          NUMBER(18) not null,
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  coin_box_id       VARCHAR2(16),
  operator_id       CHAR(6),
  clear_datetime    DATE,
  water_no_op       NUMBER(18),
  hopper_1_unit_fee NUMBER(18,2),
  hopper_1_unit_num NUMBER(18),
  hopper_2_unit_fee NUMBER(18,2),
  hopper_2_unit_num NUMBER(18),
  coin_fee_1        NUMBER(18,2),
  coin_fee_2        NUMBER(18,2),
  coin_fee_3        NUMBER(18,2),
  coin_fee_4        NUMBER(18,2),
  coin_fee_5        NUMBER(18,2),
  coin_fee_6        NUMBER(18,2),
  coin_fee_7        NUMBER(18,2),
  coin_fee_8        NUMBER(18,2),
  coin_num_1        NUMBER(18),
  coin_num_2        NUMBER(18),
  coin_num_3        NUMBER(18),
  coin_num_4        NUMBER(18),
  coin_num_5        NUMBER(18),
  coin_num_6        NUMBER(18),
  coin_num_7        NUMBER(18),
  coin_num_8        NUMBER(18),
  coin_fee_total    NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_COIN_CLEAR to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_COIN_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_COIN_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_COIN_DATA
prompt ===================================
prompt
create table ACC_ST.ST_BUF_TVM_COIN_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  coin_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_fee_1       NUMBER(18,2),
  coin_fee_2       NUMBER(18,2),
  coin_fee_3       NUMBER(18,2),
  coin_fee_4       NUMBER(18,2),
  coin_fee_5       NUMBER(18,2),
  coin_fee_6       NUMBER(18,2),
  coin_fee_7       NUMBER(18,2),
  coin_fee_8       NUMBER(18,2),
  coin_num_1       NUMBER(18),
  coin_num_2       NUMBER(18),
  coin_num_3       NUMBER(18),
  coin_num_4       NUMBER(18),
  coin_num_5       NUMBER(18),
  coin_num_6       NUMBER(18),
  coin_num_7       NUMBER(18),
  coin_num_8       NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_COIN_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_COIN_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_COIN_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_COIN_PUT
prompt ==================================
prompt
create table ACC_ST.ST_BUF_TVM_COIN_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  hopper_id        NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_unit_fee    NUMBER(18,2),
  coin_num         NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_COIN_PUT to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_COIN_PUT to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_COIN_PUT to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_CUTOFF_DTL
prompt ====================================
prompt
create table ACC_ST.ST_BUF_TVM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_CUTOFF_TOTAL
prompt ======================================
prompt
create table ACC_ST.ST_BUF_TVM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  card_put_num     NUMBER(18),
  card_clear_num   NUMBER(18),
  coin_put_num     NUMBER(18),
  coin_put_fee     NUMBER(18,2),
  coin_clear_num   NUMBER(18),
  coin_clear_fee   NUMBER(18,2),
  coin_reclaim_num NUMBER(18),
  coin_reclaim_fee NUMBER(18,2),
  note_reclaim_num NUMBER(18),
  note_reclaim_fee NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_NOTE_BOX_DATA
prompt =======================================
prompt
create table ACC_ST.ST_BUF_TVM_NOTE_BOX_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_id      NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee_1       NUMBER(18,2),
  note_fee_2       NUMBER(18,2),
  note_fee_3       NUMBER(18,2),
  note_fee_4       NUMBER(18,2),
  note_fee_5       NUMBER(18,2),
  note_fee_6       NUMBER(18,2),
  note_fee_7       NUMBER(18,2),
  note_fee_8       NUMBER(18,2),
  note_fee_9       NUMBER(18,2),
  note_fee_10      NUMBER(18,2),
  note_fee_11      NUMBER(18,2),
  note_fee_12      NUMBER(18,2),
  note_fee_13      NUMBER(18,2),
  note_num_1       NUMBER(18),
  note_num_2       NUMBER(18),
  note_num_3       NUMBER(18),
  note_num_4       NUMBER(18),
  note_num_5       NUMBER(18),
  note_num_6       NUMBER(18),
  note_num_7       NUMBER(18),
  note_num_8       NUMBER(18),
  note_num_9       NUMBER(18),
  note_num_10      NUMBER(18),
  note_num_11      NUMBER(18),
  note_num_12      NUMBER(18),
  note_num_13      NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_NOTE_BOX_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_NOTE_BOX_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_NOTE_BOX_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_NOTE_CHG_POP
prompt ======================================
prompt
create table ACC_ST.ST_BUF_TVM_NOTE_CHG_POP
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_type      NUMBER(18),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  put_datetime       DATE,
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee           NUMBER(18,2),
  note_num_put       NUMBER(18),
  note_num_chg       NUMBER(18),
  note_num_bal       NUMBER(18),
  note_fee_total_put NUMBER(18,2),
  note_fee_total_chg NUMBER(18,2),
  note_fee_total_bal NUMBER(18,2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_NOTE_CHG_POP to ACC_ST_APP;

prompt
prompt Creating table ST_BUF_TVM_NOTE_CHG_PUT
prompt ======================================
prompt
create table ACC_ST.ST_BUF_TVM_NOTE_CHG_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_type    NUMBER(18),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee         NUMBER(18,2),
  note_num         NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_NOTE_CHG_PUT to ACC_ST_APP;

prompt
prompt Creating table ST_BUF_TVM_NOTE_DATA
prompt ===================================
prompt
create table ACC_ST.ST_BUF_TVM_NOTE_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee_1       NUMBER(18,2),
  note_fee_2       NUMBER(18,2),
  note_fee_3       NUMBER(18,2),
  note_fee_4       NUMBER(18,2),
  note_fee_5       NUMBER(18,2),
  note_fee_6       NUMBER(18,2),
  note_fee_7       NUMBER(18,2),
  note_fee_8       NUMBER(18,2),
  note_fee_9       NUMBER(18,2),
  note_fee_10      NUMBER(18,2),
  note_fee_11      NUMBER(18,2),
  note_fee_12      NUMBER(18,2),
  note_fee_13      NUMBER(18,2),
  note_num_1       NUMBER(18),
  note_num_2       NUMBER(18),
  note_num_3       NUMBER(18),
  note_num_4       NUMBER(18),
  note_num_5       NUMBER(18),
  note_num_6       NUMBER(18),
  note_num_7       NUMBER(18),
  note_num_8       NUMBER(18),
  note_num_9       NUMBER(18),
  note_num_10      NUMBER(18),
  note_num_11      NUMBER(18),
  note_num_12      NUMBER(18),
  note_num_13      NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_NOTE_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_NOTE_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_NOTE_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_TVM_NOTE_RECLAIM
prompt ======================================
prompt
create table ACC_ST.ST_BUF_TVM_NOTE_RECLAIM
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee_1         NUMBER(18,2),
  note_num_reclaim_1 NUMBER(18),
  note_fee_2         NUMBER(18,2),
  note_num_reclaim_2 NUMBER(18),
  note_fee_3         NUMBER(18,2),
  note_num_reclaim_3 NUMBER(18),
  note_fee_4         NUMBER(18,2),
  note_num_reclaim_4 NUMBER(18),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_NOTE_RECLAIM to ACC_ST_APP;

prompt
prompt Creating table ST_BUF_TVM_WASTE_CARD_DATA
prompt =========================================
prompt
create table ACC_ST.ST_BUF_TVM_WASTE_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  sjt_num          NUMBER(18),
  sjt_discount_num NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_BUF_UPDATE
prompt ============================
prompt
create table ACC_ST.ST_BUF_UPDATE
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  device_id            CHAR(3),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  card_physical_id     CHAR(20),
  card_consume_seq     NUMBER,
  card_status_id       CHAR(3),
  update_area          CHAR(1),
  update_reason_id     CHAR(2),
  update_datetime      DATE,
  pay_type             CHAR(2),
  penalty_fee          NUMBER(18,2),
  receipt_id           CHAR(4),
  operator_id          CHAR(6),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  shift_id             CHAR(2),
  union_year_month     CHAR(4),
  union_bus_num        NUMBER(18),
  union_metro_num      NUMBER(18),
  union_total_num      NUMBER(18),
  balance_fee          NUMBER(18,2),
  deal_no_discount_fee NUMBER(18,2),
  card_charge_seq      NUMBER(18),
  tac                  CHAR(10),
  pay_mode_id          CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_time           DATE,
  last_sam_logical_id  CHAR(20),
  last_datetime        DATE,
  trade_sort           CHAR(2),
  card_area_code       CHAR(4),
  card_area_type       CHAR(4),
  overdraft_limit_fee  NUMBER(18),
  card_physical_type   CHAR(1),
  card_expired_flag    CHAR(1),
  tct_valid_days       NUMBER(18),
  tct_activate_time    DATE,
  card_app_flag        CHAR(1),
  limit_mode           CHAR(3),
  limit_entry_station  CHAR(4),
  limit_exit_station   CHAR(4),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30),
  check_flag           CHAR(1),
  card_app_mode        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_BUF_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_BUF_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_BUF_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_CARD_CHECK_RESULT
prompt ===================================
prompt
create table ACC_ST.ST_CARD_CHECK_RESULT
(
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20) not null,
  card_physical_id   CHAR(20),
  total_charge_num   NUMBER(18),
  total_consume_num  NUMBER(18),
  total_charge_fee   NUMBER(18,2),
  total_consume_fee  NUMBER(18,2),
  card_charge_seq    NUMBER(18),
  card_consume_seq   NUMBER(18),
  system_balance_fee NUMBER(18,2),
  card_balance_fee   NUMBER(18,2),
  diff_card_sys_fee  NUMBER(18,2),
  diff_card_sys_num  NUMBER(18,2),
  balance_water_no   CHAR(10),
  card_money         NUMBER(12,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CARD_CHECK_RESULT to ACC_ST_APP;
grant select on ACC_ST.ST_CARD_CHECK_RESULT to ACC_ST_DEV;
grant select on ACC_ST.ST_CARD_CHECK_RESULT to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_BCP
prompt =========================
prompt
create table ACC_ST.ST_CFG_BCP
(
  db_server   VARCHAR2(50) not null,
  db_sid      VARCHAR2(50) not null,
  db_account  VARCHAR2(20) not null,
  db_password VARCHAR2(100) not null,
  enc_flag    VARCHAR2(1) default '0' not null,
  remark      VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CFG_BCP to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_BCP to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_BCP to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_BLACK_TYPE_ACC_EXT
prompt ========================================
prompt
create table ACC_ST.ST_CFG_BLACK_TYPE_ACC_EXT
(
  black_type_acc  CHAR(2) not null,
  card_status_ext CHAR(2) not null,
  ext_type        CHAR(2) not null,
  status_ext_name VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CFG_BLACK_TYPE_ACC_EXT to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_BLACK_TYPE_ACC_EXT to ACC_ST_DEV;

prompt
prompt Creating table ST_CFG_CLEAR_TABLE
prompt =================================
prompt
create table ACC_ST.ST_CFG_CLEAR_TABLE
(
  origin_table_name VARCHAR2(50) not null,
  keep_days         INTEGER,
  divide_recd_count INTEGER,
  clear_flag        INTEGER,
  create_sql        VARCHAR2(2500),
  is_squadday       INTEGER,
  table_columns     VARCHAR2(800),
  ab_name           VARCHAR2(30),
  db_type           VARCHAR2(3),
  date_type         VARCHAR2(20),
  primarytable      VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_CFG_CLEAR_TABLE
  is '±Ì ˝æ›«Â¿Ì≈‰÷√±Ì';
comment on column ACC_ST.ST_CFG_CLEAR_TABLE.is_squadday
  is '0:”–‘À”™»’°¢1£∫Œﬁ‘À”™»’';
alter table ACC_ST.ST_CFG_CLEAR_TABLE
  add constraint PK_ST_CFG_CLEAR_TABLE primary key (ORIGIN_TABLE_NAME)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CFG_CLEAR_TABLE to ACC_ST_APP;
grant select, update on ACC_ST.ST_CFG_CLEAR_TABLE to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_CLEAR_TABLE to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_DATA_CHECK
prompt ================================
prompt
create table ACC_ST.ST_CFG_DATA_CHECK
(
  data_type  CHAR(3) not null,
  recd_type  CHAR(2) not null,
  card_type  CHAR(2) not null,
  table_name VARCHAR2(50),
  fld_order  INTEGER not null,
  fld_name   VARCHAR2(50),
  check_code CHAR(2),
  valid_flag CHAR(1),
  version_no CHAR(10),
  fld_desc   VARCHAR2(50),
  queue_flag CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_CFG_DATA_CHECK
  is ' ˝æ›◊÷∂Œ–£—È≈‰÷√±Ì';
alter table ACC_ST.ST_CFG_DATA_CHECK
  add constraint PK_ST_CFG_DATA_CHECK primary key (DATA_TYPE, RECD_TYPE, CARD_TYPE, FLD_ORDER)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_CFG_DATA_CHECK to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_DATA_CHECK to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_DATA_CHECK to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_ERR_ACC_EXT
prompt =================================
prompt
create table ACC_ST.ST_CFG_ERR_ACC_EXT
(
  err_code_acc      CHAR(2) not null,
  err_code_ext      CHAR(2) not null,
  ext_type          CHAR(2) not null,
  err_code_ext_name VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CFG_ERR_ACC_EXT to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_ERR_ACC_EXT to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_ERR_ACC_EXT to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_ERR_CODE_MAPPING
prompt ======================================
prompt
create table ACC_ST.ST_CFG_ERR_CODE_MAPPING
(
  err_code_acc      CHAR(2) not null,
  err_code_lcc      CHAR(1) not null,
  err_code_lcc_name VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CFG_ERR_CODE_MAPPING to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_ERR_CODE_MAPPING to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_ERR_CODE_MAPPING to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_FILE_FLD
prompt ==============================
prompt
create table ACC_ST.ST_CFG_FILE_FLD
(
  data_type     CHAR(3) not null,
  recd_type     CHAR(2) not null,
  group_order   INTEGER not null,
  recd_length   INTEGER,
  fld_order     INTEGER not null,
  fld_length    INTEGER,
  bcd_flag      INTEGER,
  fld_type_flag INTEGER,
  card_flag     INTEGER,
  fld_desc      VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_CFG_FILE_FLD
  is 'Ωª“◊Œƒº˛◊÷∂Œ≈‰÷√±Ì';
alter table ACC_ST.ST_CFG_FILE_FLD
  add constraint PK_ST_CFG_FILE_FLD primary key (DATA_TYPE, RECD_TYPE, GROUP_ORDER, FLD_ORDER)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_CFG_FILE_FLD to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_FILE_FLD to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_FILE_FLD to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_LOG_LEVEL
prompt ===============================
prompt
create table ACC_ST.ST_CFG_LOG_LEVEL
(
  sys_code    CHAR(1) not null,
  sys_level   CHAR(1),
  set_time    DATE,
  operator_id CHAR(6),
  version_no  CHAR(10) not null,
  record_flag CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_CFG_LOG_LEVEL
  is '«ÂÀ„»’÷æº∂±≈‰÷√±Ì';
alter table ACC_ST.ST_CFG_LOG_LEVEL
  add constraint PK_ST_CFG_LOG_LEVEL primary key (SYS_CODE, VERSION_NO, RECORD_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_CFG_LOG_LEVEL to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_LOG_LEVEL to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_LOG_LEVEL to ACC_ST_RPT;

prompt
prompt Creating table ST_CFG_SYS_BASE
prompt ==============================
prompt
create table ACC_ST.ST_CFG_SYS_BASE
(
  version_no  CHAR(10) not null,
  record_flag VARCHAR2(1) not null,
  cfg_key     VARCHAR2(100) not null,
  cfg_value   VARCHAR2(100),
  remark      VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.ST_CFG_SYS_BASE to ACC_COMMU_APP;
grant select on ACC_ST.ST_CFG_SYS_BASE to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.ST_CFG_SYS_BASE to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_SYS_BASE to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_SYS_BASE to ACC_ST_RPT;
grant select on ACC_ST.ST_CFG_SYS_BASE to ACC_TK_DEV;
grant select on ACC_ST.ST_CFG_SYS_BASE to ACC_TK_RPT;

prompt
prompt Creating table ST_CFG_TRD_SEQ
prompt =============================
prompt
create table ACC_ST.ST_CFG_TRD_SEQ
(
  trd_type_id VARCHAR2(3) not null,
  seq_name    VARCHAR2(50) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CFG_TRD_SEQ to ACC_ST_APP;
grant select on ACC_ST.ST_CFG_TRD_SEQ to ACC_ST_DEV;
grant select on ACC_ST.ST_CFG_TRD_SEQ to ACC_ST_RPT;

prompt
prompt Creating table ST_CHG_INC000001
prompt ===============================
prompt
create table ACC_ST.ST_CHG_INC000001
(
  balance_water_no    CHAR(10) not null,
  b_line_id           CHAR(2),
  b_station_id        CHAR(2),
  e_line_id           CHAR(2),
  e_station_id        CHAR(2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  squad_day           CHAR(8),
  time_section_id     CHAR(2),
  deal_fee            NUMBER(18,2) not null,
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_in      CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in_dir  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CHG_INC000001 to ACC_ST_APP;
grant select on ACC_ST.ST_CHG_INC000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_CHG_INC000002
prompt ===============================
prompt
create table ACC_ST.ST_CHG_INC000002
(
  balance_water_no    CHAR(10) not null,
  b_line_id           CHAR(2),
  b_station_id        CHAR(2),
  e_line_id           CHAR(2),
  e_station_id        CHAR(2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  squad_day           CHAR(8),
  time_section_id     CHAR(2),
  deal_fee            NUMBER(18,2) not null,
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_in      CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in_dir  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CHG_INC000002 to ACC_ST_APP;
grant select on ACC_ST.ST_CHG_INC000002 to ACC_ST_DEV;

prompt
prompt Creating table ST_CM_LOG_REPORT_LOSS
prompt ====================================
prompt
create table ACC_ST.ST_CM_LOG_REPORT_LOSS
(
  water_no     NUMBER(18) not null,
  apply_bill   VARCHAR2(25),
  apply_action CHAR(1),
  return_flag  CHAR(2),
  return_time  DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_CM_LOG_REPORT_LOSS
  is 'º«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«Î¡˜≥Ã±Ì';
comment on column ACC_ST.ST_CM_LOG_REPORT_LOSS.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_CM_LOG_REPORT_LOSS.apply_bill
  is '∆æ÷§ID';
comment on column ACC_ST.ST_CM_LOG_REPORT_LOSS.apply_action
  is '¥¶¿Ì∑Ω Ω(1:≤È—Ø;2:∞Ï¿Ì≥…π¶Õ®÷™)';
comment on column ACC_ST.ST_CM_LOG_REPORT_LOSS.return_flag
  is '∑µªÿΩ·π˚(00:‘ –Ì…Í«Î;01:÷§º˛≤ª¥Ê‘⁄;02:÷§º˛“—π˝∆⁄;03:∫⁄√˚µ•ø®;04:÷ÿ∏¥…Í«Î;05:“—…Í«Î,Œ¥÷∆ø®;06:“—…Í«Î≤πø®;07:“—…Í«ÎÕÀøÓ;10:Œﬁπ“ ß,≤ªø…Ω‚π“)';
comment on column ACC_ST.ST_CM_LOG_REPORT_LOSS.return_time
  is '∑µªÿ ±º‰';
alter table ACC_ST.ST_CM_LOG_REPORT_LOSS
  add constraint PK_ST_CM_LOG_REPORT_LOSS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_CM_LOG_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.ST_CM_LOG_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.ST_CM_LOG_REPORT_LOSS to ACC_ST_RPT;

prompt
prompt Creating table ST_CM_RESULT_REPORT_LOSS
prompt =======================================
prompt
create table ACC_ST.ST_CM_RESULT_REPORT_LOSS
(
  water_no      NUMBER(18) not null,
  apply_bill    VARCHAR2(25),
  create_time   DATE,
  busniss_type  CHAR(1),
  identify_type CHAR(1),
  identity_id   VARCHAR2(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_CM_RESULT_REPORT_LOSS
  is 'º«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«ÎÕ®—∂œµÕ≥º«¬º±Ì';
comment on column ACC_ST.ST_CM_RESULT_REPORT_LOSS.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_CM_RESULT_REPORT_LOSS.apply_bill
  is '∆æ÷§ID';
comment on column ACC_ST.ST_CM_RESULT_REPORT_LOSS.create_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.ST_CM_RESULT_REPORT_LOSS.busniss_type
  is '“µŒÒ¿‡–Õ';
comment on column ACC_ST.ST_CM_RESULT_REPORT_LOSS.identify_type
  is '÷§º˛¿‡–Õ(1:…Ì∑›÷§;2:—ß…˙÷§;3:æ¸»À÷§;4:¿œ»Àø®;5:‘±π§ø®;9:∆‰À˚)';
comment on column ACC_ST.ST_CM_RESULT_REPORT_LOSS.identity_id
  is '÷§º˛∫≈¬Î';
alter table ACC_ST.ST_CM_RESULT_REPORT_LOSS
  add constraint PK_ST_CM_RESULT_REPORT_LOSS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_CM_RESULT_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.ST_CM_RESULT_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.ST_CM_RESULT_REPORT_LOSS to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_ERROR
prompt ===========================
prompt
create table ACC_ST.ST_COD_ERROR
(
  err_code VARCHAR2(2) not null,
  err_desc VARCHAR2(100),
  remark   VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_COD_ERROR
  add constraint PK_ST_COD_ERROR primary key (ERR_CODE)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_ERROR to ACC_ST_APP;
grant select on ACC_ST.ST_COD_ERROR to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_ERROR to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_LCC_LINE
prompt ==============================
prompt
create table ACC_ST.ST_COD_LCC_LINE
(
  lcc_line_id   CHAR(2),
  lcc_line_name VARCHAR2(50),
  lcc_ip        VARCHAR2(15)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_COD_LCC_LINE
  is 'LCC¥˙¬Î±Ì';
grant select, insert, update, delete on ACC_ST.ST_COD_LCC_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_COD_LCC_LINE to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_LCC_LINE to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_LOGICAL_CARD
prompt ==================================
prompt
create table ACC_ST.ST_COD_LOGICAL_CARD
(
  card_logical_id_start VARCHAR2(20) not null,
  card_logical_id_end   VARCHAR2(20) not null,
  card_main_id          CHAR(2) not null,
  card_name             VARCHAR2(100),
  remark                VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_COD_LOGICAL_CARD
  add constraint ST_COD_LOGICAL_CARD_PK primary key (CARD_LOGICAL_ID_START, CARD_LOGICAL_ID_END)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_LOGICAL_CARD to ACC_ST_APP;
grant select on ACC_ST.ST_COD_LOGICAL_CARD to ACC_ST_DEV;

prompt
prompt Creating table ST_COD_PAYMENT
prompt =============================
prompt
create table ACC_ST.ST_COD_PAYMENT
(
  payment_id   CHAR(2) not null,
  payment_name VARCHAR2(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_COD_PAYMENT
  is 'ÕÀøÓ∑Ω Ω¥˙¬Î∂®“Â±Ì';
alter table ACC_ST.ST_COD_PAYMENT
  add constraint PK_ST_COD_PAYMENT primary key (PAYMENT_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_PAYMENT to ACC_ST_APP;
grant select on ACC_ST.ST_COD_PAYMENT to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_PAYMENT to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_PENALTY_REASON
prompt ====================================
prompt
create table ACC_ST.ST_COD_PENALTY_REASON
(
  penalty_id   CHAR(2) not null,
  penalty_name VARCHAR2(200),
  delete_flag  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_COD_PENALTY_REASON
  is '∑£øÓ‘≠“Ú¥˙¬Î±Ì';
alter table ACC_ST.ST_COD_PENALTY_REASON
  add constraint PK_ST_COD_PENALTY_REASON primary key (PENALTY_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_PENALTY_REASON to ACC_ST_APP;
grant select on ACC_ST.ST_COD_PENALTY_REASON to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_PENALTY_REASON to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_RETURN_TYPE
prompt =================================
prompt
create table ACC_ST.ST_COD_RETURN_TYPE
(
  return_type CHAR(1) not null,
  return_name VARCHAR2(25)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_COD_RETURN_TYPE
  is 'ÕÀøÓ∑Ω Ω¥˙¬Î∂®“Â±Ì';
alter table ACC_ST.ST_COD_RETURN_TYPE
  add constraint PK_ST_COD_RETURN_TYPE primary key (RETURN_TYPE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_RETURN_TYPE to ACC_ST_APP;
grant select on ACC_ST.ST_COD_RETURN_TYPE to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_RETURN_TYPE to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_STEPS
prompt ===========================
prompt
create table ACC_ST.ST_COD_STEPS
(
  step      CHAR(2) not null,
  step_pre  CHAR(2) not null,
  step_name VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_STEPS to ACC_ST_APP;
grant select on ACC_ST.ST_COD_STEPS to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_STEPS to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_SYS_ERROR
prompt ===============================
prompt
create table ACC_ST.ST_COD_SYS_ERROR
(
  sys_name      VARCHAR2(100),
  module_name   VARCHAR2(100),
  function_name VARCHAR2(100),
  err_code      CHAR(6) not null,
  err_desc      VARCHAR2(100),
  err_level     CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_COD_SYS_ERROR
  is 'œµÕ≥¥ÌŒÛ¥˙¬Î±Ì';
alter table ACC_ST.ST_COD_SYS_ERROR
  add constraint PK_ST_COD_SYS_ERROR primary key (ERR_CODE)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_SYS_ERROR to ACC_ST_APP;
grant select on ACC_ST.ST_COD_SYS_ERROR to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_SYS_ERROR to ACC_ST_RPT;

prompt
prompt Creating table ST_COD_TIME_SECTION
prompt ==================================
prompt
create table ACC_ST.ST_COD_TIME_SECTION
(
  time_section_id   CHAR(2) not null,
  begin_datetime    DATE,
  end_datetime      DATE,
  time_section_name CHAR(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_COD_TIME_SECTION
  is '«¯∂Œ¥˙¬Î±Ì';
alter table ACC_ST.ST_COD_TIME_SECTION
  add constraint PK_ST_COD_TIME_SECTION primary key (TIME_SECTION_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_COD_TIME_SECTION to ACC_ST_APP;
grant select on ACC_ST.ST_COD_TIME_SECTION to ACC_ST_DEV;
grant select on ACC_ST.ST_COD_TIME_SECTION to ACC_ST_RPT;

prompt
prompt Creating table ST_CROSSDB_OPERATION0324
prompt =======================================
prompt
create table ACC_ST.ST_CROSSDB_OPERATION0324
(
  vs_sourcedb    VARCHAR2(20) not null,
  vs_targetdb    VARCHAR2(20) not null,
  vs_object_name VARCHAR2(50) not null,
  vs_object_type VARCHAR2(20),
  vs_privs       VARCHAR2(20) not null,
  vs_create_man  VARCHAR2(50),
  vd_date        DATE default sysdate not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_CROSSDB_OPERATION0324
  add constraint PK_ST_CROSSDB_OPERATION0324 primary key (VS_SOURCEDB, VS_TARGETDB, VS_OBJECT_NAME, VS_PRIVS)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_CROSSDB_OPERATION0324 to ACC_ST_APP;
grant select on ACC_ST.ST_CROSSDB_OPERATION0324 to ACC_ST_DEV;
grant select on ACC_ST.ST_CROSSDB_OPERATION0324 to ACC_ST_RPT;

prompt
prompt Creating table ST_DIF_ANL000001
prompt ===============================
prompt
create table ACC_ST.ST_DIF_ANL000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  out_deal_type    CHAR(2),
  acc_send_num     NUMBER(18),
  acc_send_fee     NUMBER(18,2),
  out_affirm_num   NUMBER,
  out_affirm_fee   NUMBER(18,2),
  error_id         CHAR(2),
  error_num        NUMBER,
  error_fee        NUMBER(18,2),
  sys_type         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_DIF_ANL000001
  is '«ÂÀ„Ω·π˚≤Ó“ÏÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_DIF_ANL000001 on ACC_ST.ST_DIF_ANL000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_DIF_ANL000001
  add constraint PK_ST_DIF_ANL000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_DIF_ANL000001 to ACC_ST_APP;
grant select on ACC_ST.ST_DIF_ANL000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_DST_CON000001
prompt ===============================
prompt
create table ACC_ST.ST_DST_CON000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  contc_id         CHAR(2),
  line_id          CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_DST_CON000001
  is '‘À”™…Ã∑÷’ Ω·π˚Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_DST_CON000001_1 on ACC_ST.ST_DST_CON000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_DST_CON000001 to ACC_ST_APP;
grant select on ACC_ST.ST_DST_CON000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_DST_LIN000001
prompt ===============================
prompt
create table ACC_ST.ST_DST_LIN000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id_dispart  CHAR(2),
  line_id          CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_DST_LIN000001
  is '‘À”™…Ã∑÷’ Ω·π˚Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_DST_LIN000001_12 on ACC_ST.ST_DST_LIN000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_DST_LIN000001 to ACC_ST_APP;
grant select on ACC_ST.ST_DST_LIN000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_EPT_BAL000001
prompt ===============================
prompt
create table ACC_ST.ST_EPT_BAL000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  tr_type_id       CHAR(2),
  error_id         CHAR(2),
  deal_num         NUMBER(18),
  sys_type         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_EPT_BAL000001
  is '“Ï≥£Ωª“◊Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_EPT_BAL000001 on ACC_ST.ST_EPT_BAL000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_EPT_BAL000001
  add constraint PK_ST_EPT_BAL000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EPT_BAL000001 to ACC_ST_APP;
grant select on ACC_ST.ST_EPT_BAL000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_ERR_ADMIN
prompt ===========================
prompt
create table ACC_ST.ST_ERR_ADMIN
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  admin_datetime   DATE,
  admin_way_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  return_fee       NUMBER(18,2),
  penalty_fee      NUMBER(18,2),
  admin_reason_id  CHAR(2),
  describe         CHAR(30),
  passenger_name   CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX9_BALANCE_WATER_NO on ACC_ST.ST_ERR_ADMIN (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_ADMIN to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_AGM_CARD_DATA
prompt ===================================
prompt
create table ACC_ST.ST_ERR_AGM_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  box_id           VARCHAR2(16),
  water_no_op      NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_AGM_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_AGM_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_AGM_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_AGM_CUTOFF_DTL
prompt ====================================
prompt
create table ACC_ST.ST_ERR_AGM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_AGM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_AGM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_AGM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_AGM_CUTOFF_TOTAL
prompt ======================================
prompt
create table ACC_ST.ST_ERR_AGM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  box_pop_num      NUMBER(18),
  total_num        NUMBER(18),
  total_fee        NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_AGM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_AGM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_AGM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_GET
prompt =============================
prompt
create table ACC_ST.ST_ERR_BOM_GET
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  do_type          CHAR(2),
  operator_id      CHAR(6),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  dev_type_id      CHAR(2),
  deal_fee         NUMBER(18,2),
  return_bala      NUMBER(18,2),
  deal_num         NUMBER(18),
  shift_id         CHAR(2),
  device_id        CHAR(4),
  penalty          NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_ERR_BOM_GET
  is '≥µ’æ ’“ÊÕ≥º∆¥ÌŒÛ±Ì';
alter table ACC_ST.ST_ERR_BOM_GET
  add constraint PK_ST_ERR_BOM_GET primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_GET to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_GET to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_GET to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT
prompt ===============================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT
(
  water_no                 NUMBER(20),
  line_id                  CHAR(2),
  station_id               CHAR(2),
  dev_type_id              CHAR(2),
  device_id                CHAR(3),
  operator_id              CHAR(6),
  shift_id                 CHAR(2),
  start_time               CHAR(14),
  end_time                 CHAR(14),
  sale_total_num           NUMBER(18),
  sale_total_fee           NUMBER(18,2),
  charge_total_num         NUMBER(18),
  charge_total_fee         NUMBER(18,2),
  update_total_num         NUMBER(18),
  update_total_fee         NUMBER(18,2),
  update_total_fee_cash    NUMBER(18),
  admin_total_num          NUMBER(18),
  admin_total_fee_return   NUMBER(18),
  admin_total_fee_income   NUMBER(18,2),
  delay_total_num          NUMBER(18),
  return_total_num         NUMBER(18),
  return_total_fee         NUMBER(18,2),
  return_non_total_num     NUMBER(18),
  return_non_total_fee     NUMBER(18,2),
  return_non_app_total_num NUMBER(18),
  charge_update_total_num  NUMBER(18),
  charge_update_total_fee  NUMBER(18,2),
  unlock_total_num         NUMBER(18),
  total_fee_nocash         NUMBER(18,2),
  total_fee_cash           NUMBER(18,2),
  balance_water_no         CHAR(10),
  file_name                CHAR(25),
  error_code               CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_ERR_BOM_SHIFT
  is 'BOM∞‡¥Œ ˝æ›÷˜±Ì¥ÌŒÛ±Ì';
create index ACC_ST.IDX_ST_ERR_BOM_SHIFT on ACC_ST.ST_ERR_BOM_SHIFT (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_ADMIN
prompt =====================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_ADMIN
(
  water_no         NUMBER(18) not null,
  admin_way_id     CHAR(2),
  admin_reason_id  CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_ADMIN to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_CHARGE
prompt ======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_CHARGE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_CHARGE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_CHARGE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_CHARGE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_CHG_UPD
prompt =======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_CHG_UPD
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_CHG_UPD to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_CHG_UPD to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_CHG_UPD to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_DELAY
prompt =====================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_DELAY
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_RETURN
prompt ======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_RETURN
(
  water_no           NUMBER(18) not null,
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  num                NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  return_type        CHAR(1),
  is_broken          CHAR(1),
  penalty_fee        NUMBER(18,2),
  penalty_reason     CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  err_code           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_RTN_APP
prompt =======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_RTN_APP
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_RTN_NON
prompt =======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_RTN_NON
(
  water_no           NUMBER(18) not null,
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  num                NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  return_type        CHAR(1),
  is_broken          CHAR(1),
  penalty_fee        NUMBER(18,2),
  penalty_reason     CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  err_code           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_RTN_NON to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_RTN_NON to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_RTN_NON to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_SALE
prompt ====================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_SALE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_TOTAL
prompt =====================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_TOTAL
(
  water_no                 NUMBER(18) not null,
  line_id                  CHAR(2),
  station_id               CHAR(2),
  dev_type_id              CHAR(2),
  device_id                CHAR(3),
  operator_id              CHAR(6),
  shift_id                 CHAR(2),
  start_time               DATE,
  end_time                 DATE,
  sale_total_num           NUMBER(18),
  sale_total_fee           NUMBER(18,2),
  charge_total_num         NUMBER(18),
  charge_total_fee         NUMBER(18,2),
  update_total_num         NUMBER(18),
  update_total_fee         NUMBER(18,2),
  update_total_fee_cash    NUMBER(18,2),
  admin_total_num          NUMBER(18),
  admin_total_fee_return   NUMBER(18,2),
  admin_total_fee_income   NUMBER(18,2),
  delay_total_num          NUMBER(18),
  return_total_num         NUMBER(18),
  return_total_fee         NUMBER(18,2),
  return_non_total_num     NUMBER(18),
  return_non_total_fee     NUMBER(18,2),
  return_non_app_total_num NUMBER(18),
  charge_update_total_num  NUMBER(18),
  charge_update_total_fee  NUMBER(18,2),
  unlock_total_num         NUMBER(18),
  total_fee_nocash         NUMBER(18,2),
  total_fee_cash           NUMBER(18,2),
  balance_water_no         CHAR(10),
  file_name                VARCHAR2(30),
  check_flag               CHAR(1),
  err_code                 CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_UNLOCK
prompt ======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_UNLOCK
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_UNLOCK to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_UNLOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_UNLOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_BOM_SHIFT_UPDATE
prompt ======================================
prompt
create table ACC_ST.ST_ERR_BOM_SHIFT_UPDATE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  update_reason    CHAR(2),
  pay_type         CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_BOM_SHIFT_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_BOM_SHIFT_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_DATA_FIELD
prompt ================================
prompt
create table ACC_ST.ST_ERR_DATA_FIELD
(
  file_name        VARCHAR2(30),
  err_code         CHAR(2),
  balance_water_no CHAR(10),
  hdl_flag         CHAR(1),
  gen_time         DATE,
  remark           VARCHAR2(250),
  error_data       VARCHAR2(512)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_DATA_FIELD to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_DATA_FIELD to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_DATA_FIELD to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_DATA_FILE
prompt ===============================
prompt
create table ACC_ST.ST_ERR_DATA_FILE
(
  file_name        VARCHAR2(30),
  err_code         CHAR(2),
  balance_water_no CHAR(10),
  hdl_flag         CHAR(1),
  gen_time         DATE,
  remark           VARCHAR2(250)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_DATA_FILE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_DATA_FILE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_DATA_FILE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_DATA_FILE_OCT
prompt ===================================
prompt
create table ACC_ST.ST_ERR_DATA_FILE_OCT
(
  file_name        VARCHAR2(30),
  err_code         CHAR(2),
  balance_water_no CHAR(10),
  hdl_flag         CHAR(1),
  gen_time         DATE,
  remark           VARCHAR2(150)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_DATA_FILE_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_DATA_FILE_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_DATA_FILE_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_DEAL
prompt ==========================
prompt
create table ACC_ST.ST_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX_BALANCE_WATER_NO on ACC_ST.ST_ERR_DEAL (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_DEAL_UNIQUE
prompt =================================
prompt
create table ACC_ST.ST_ERR_DEAL_UNIQUE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_DEAL_UNIQUE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_DEAL_UNIQUE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_DEAL_UNIQUE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_DELAY
prompt ===========================
prompt
create table ACC_ST.ST_ERR_DELAY
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  card_status_id      CHAR(3),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  operate_datetime    DATE,
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  err_code            CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX8_BALANCE_WATER_NO on ACC_ST.ST_ERR_DELAY (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_ENTRY
prompt ===========================
prompt
create table ACC_ST.ST_ERR_ENTRY
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX7_BALANCE_WATER_NO on ACC_ST.ST_ERR_ENTRY (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_ENTRY to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_ENTRY to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_ENTRY_UNIQUE
prompt ==================================
prompt
create table ACC_ST.ST_ERR_ENTRY_UNIQUE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_ENTRY_UNIQUE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_ENTRY_UNIQUE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_ENTRY_UNIQUE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_FILE_INFO
prompt ===============================
prompt
create table ACC_ST.ST_ERR_FILE_INFO
(
  balance_water_no CHAR(10),
  file_type        CHAR(1),
  file_name        CHAR(36)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_ERR_FILE_INFO
  is '¥ÌŒÛ«ÂÀ„Œƒº˛º«¬º±Ì';
create index ACC_ST.IDX_ST_ERR_FILE_INFO on ACC_ST.ST_ERR_FILE_INFO (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_FILE_INFO to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_FILE_INFO to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_FILE_INFO to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_IMPORT_FILE_NAME
prompt ======================================
prompt
create table ACC_ST.ST_ERR_IMPORT_FILE_NAME
(
  file_name        CHAR(25),
  gen_time         DATE,
  import_num       INTEGER,
  success_flag     CHAR(1),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_ERR_IMPORT_FILE_NAME
  is 'µº»ÎŒƒº˛√˚º«¬º¥ÌŒÛ±Ì';
grant select, insert, update, delete on ACC_ST.ST_ERR_IMPORT_FILE_NAME to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_IMPORT_FILE_NAME to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_IMPORT_FILE_NAME to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_LCC
prompt =========================
prompt
create table ACC_ST.ST_ERR_LCC
(
  water_no                NUMBER(18),
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2),
  file_name               VARCHAR2(30),
  check_flag              CHAR(1),
  err_code                CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_LCC to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_LCC to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_LOCK
prompt ==========================
prompt
create table ACC_ST.ST_ERR_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2),
  card_app_mode    CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX6_BALANCE_WATER_NO on ACC_ST.ST_ERR_LOCK (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_LOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_LOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_NON_RTN_APP
prompt =================================
prompt
create table ACC_ST.ST_ERR_NON_RTN_APP
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_print_id    CHAR(16),
  apply_datetime   DATE,
  receipt_id       CHAR(4),
  operator_id      CHAR(6),
  apply_name       CHAR(8),
  tel_no           CHAR(12),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  is_broken        CHAR(2),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX3_BALANCE_WATER_NO on ACC_ST.ST_ERR_NON_RTN_APP (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_NON_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_REG_DTL
prompt =============================
prompt
create table ACC_ST.ST_ERR_REG_DTL
(
  water_no         NUMBER(18) not null,
  data_code        NUMBER(18),
  data_value       NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_REG_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_REG_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_REG_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_REG_TOTAL
prompt ===============================
prompt
create table ACC_ST.ST_ERR_REG_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  commu_datetime   DATE,
  gen_datetime     DATE,
  total_num        NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_REG_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_REG_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_REG_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_REPORT_LOSS
prompt =================================
prompt
create table ACC_ST.ST_ERR_REPORT_LOSS
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  apply_name          CHAR(8),
  apply_sex           CHAR(1),
  identity_type       CHAR(1),
  identity_id         CHAR(18),
  expired_date        CHAR(8),
  tel_no              CHAR(16),
  fax                 CHAR(16),
  address             CHAR(30),
  operator_id         CHAR(6),
  apply_datetime      DATE,
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  apply_business_type CHAR(1),
  receipt_id          CHAR(4),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  err_code            CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_REPORT_LOSS to ACC_ST_APP;

prompt
prompt Creating table ST_ERR_RETURN
prompt ============================
prompt
create table ACC_ST.ST_ERR_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(8),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  err_code           CHAR(2),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX5_BALANCE_WATER_NO on ACC_ST.ST_ERR_RETURN (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_SALE
prompt ==========================
prompt
create table ACC_ST.ST_ERR_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX2_BALANCE_WATER_NO on ACC_ST.ST_ERR_SALE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_SALE_SJT
prompt ==============================
prompt
create table ACC_ST.ST_ERR_SALE_SJT
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  err_code            CHAR(2),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX1_BALANCE_WATER_NO on ACC_ST.ST_ERR_SALE_SJT (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_SALE_SJT to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_SAM_WATER
prompt ===============================
prompt
create table ACC_ST.ST_ERR_SAM_WATER
(
  water_no            NUMBER(18) not null,
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  tr_type_id          CHAR(2),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  err_code            CHAR(2),
  balance_water_no    CHAR(10),
  tk_app_mode         CHAR(1),
  sam_trade_seq_start NUMBER(18),
  sam_trade_seq_end   NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_ERR_SAM_WATER
  add primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_SAM_WATER to ACC_ST_APP;
grant select, update on ACC_ST.ST_ERR_SAM_WATER to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_SAM_WATER to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_SIGN_CARD_APPLY
prompt =====================================
prompt
create table ACC_ST.ST_ERR_SIGN_CARD_APPLY
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX10_BALANCE_WATER_NO on ACC_ST.ST_ERR_SIGN_CARD_APPLY (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_SIGN_CARD_APPLY to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_SIGN_CARD_APPLY to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_SIGN_CARD_APPLY to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_AUTO_BAL
prompt ==================================
prompt
create table ACC_ST.ST_ERR_TVM_AUTO_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1),
  err_code                     CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_AUTO_BAL to ACC_ST_APP;

prompt
prompt Creating table ST_ERR_TVM_BAL
prompt =============================
prompt
create table ACC_ST.ST_ERR_TVM_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1),
  err_code                     CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_BAL to ACC_ST_APP;

prompt
prompt Creating table ST_ERR_TVM_CARD_CLEAR
prompt ====================================
prompt
create table ACC_ST.ST_ERR_TVM_CARD_CLEAR
(
  water_no              NUMBER(18) not null,
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  operator_id           CHAR(6),
  clear_datetime        DATE,
  water_no_op           NUMBER(18),
  card_main_id_hopper_1 CHAR(2),
  card_sub_id_hopper_1  CHAR(2),
  card_main_id_hopper_2 CHAR(2),
  card_sub_id_hopper_2  CHAR(2),
  hopper_1_num          NUMBER(18),
  hopper_2_num          NUMBER(18),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_CARD_CLEAR to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_CARD_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_CARD_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_CARD_PUT
prompt ==================================
prompt
create table ACC_ST.ST_ERR_TVM_CARD_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  box_id           VARCHAR2(16),
  hopper_id        NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_CARD_PUT to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_CARD_PUT to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_CARD_PUT to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_COIN_CLEAR
prompt ====================================
prompt
create table ACC_ST.ST_ERR_TVM_COIN_CLEAR
(
  water_no          NUMBER(18) not null,
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  coin_box_id       VARCHAR2(16),
  operator_id       CHAR(6),
  clear_datetime    DATE,
  water_no_op       NUMBER(18),
  hopper_1_unit_fee NUMBER(18,2),
  hopper_1_unit_num NUMBER(18),
  hopper_2_unit_fee NUMBER(18,2),
  hopper_2_unit_num NUMBER(18),
  coin_fee_1        NUMBER(18,2),
  coin_fee_2        NUMBER(18,2),
  coin_fee_3        NUMBER(18,2),
  coin_fee_4        NUMBER(18,2),
  coin_fee_5        NUMBER(18,2),
  coin_fee_6        NUMBER(18,2),
  coin_fee_7        NUMBER(18,2),
  coin_fee_8        NUMBER(18,2),
  coin_num_1        NUMBER(18),
  coin_num_2        NUMBER(18),
  coin_num_3        NUMBER(18),
  coin_num_4        NUMBER(18),
  coin_num_5        NUMBER(18),
  coin_num_6        NUMBER(18),
  coin_num_7        NUMBER(18),
  coin_num_8        NUMBER(18),
  coin_fee_total    NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_COIN_CLEAR to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_COIN_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_COIN_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_COIN_DATA
prompt ===================================
prompt
create table ACC_ST.ST_ERR_TVM_COIN_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  coin_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_fee_1       NUMBER(18,2),
  coin_fee_2       NUMBER(18,2),
  coin_fee_3       NUMBER(18,2),
  coin_fee_4       NUMBER(18,2),
  coin_fee_5       NUMBER(18,2),
  coin_fee_6       NUMBER(18,2),
  coin_fee_7       NUMBER(18,2),
  coin_fee_8       NUMBER(18,2),
  coin_num_1       NUMBER(18),
  coin_num_2       NUMBER(18),
  coin_num_3       NUMBER(18),
  coin_num_4       NUMBER(18),
  coin_num_5       NUMBER(18),
  coin_num_6       NUMBER(18),
  coin_num_7       NUMBER(18),
  coin_num_8       NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_COIN_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_COIN_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_COIN_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_COIN_PUT
prompt ==================================
prompt
create table ACC_ST.ST_ERR_TVM_COIN_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  hopper_id        NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_unit_fee    NUMBER(18,2),
  coin_num         NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_COIN_PUT to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_COIN_PUT to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_COIN_PUT to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_CUTOFF_DTL
prompt ====================================
prompt
create table ACC_ST.ST_ERR_TVM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_CUTOFF_TOTAL
prompt ======================================
prompt
create table ACC_ST.ST_ERR_TVM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  card_put_num     NUMBER(18),
  card_clear_num   NUMBER(18),
  coin_put_num     NUMBER(18),
  coin_put_fee     NUMBER(18,2),
  coin_clear_num   NUMBER(18),
  coin_clear_fee   NUMBER(18,2),
  coin_reclaim_num NUMBER(18),
  coin_reclaim_fee NUMBER(18,2),
  note_reclaim_num NUMBER(18),
  note_reclaim_fee NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_NOTE_CHG_POP
prompt ======================================
prompt
create table ACC_ST.ST_ERR_TVM_NOTE_CHG_POP
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_type      NUMBER(18),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  put_datetime       DATE,
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee           NUMBER(18,2),
  note_num_put       NUMBER(18),
  note_num_chg       NUMBER(18),
  note_num_bal       NUMBER(18),
  note_fee_total_put NUMBER(18,2),
  note_fee_total_chg NUMBER(18,2),
  note_fee_total_bal NUMBER(18,2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  err_code           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_NOTE_CHG_POP to ACC_ST_APP;

prompt
prompt Creating table ST_ERR_TVM_NOTE_CHG_PUT
prompt ======================================
prompt
create table ACC_ST.ST_ERR_TVM_NOTE_CHG_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_type    NUMBER(18),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee         NUMBER(18,2),
  note_num         NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_NOTE_CHG_PUT to ACC_ST_APP;

prompt
prompt Creating table ST_ERR_TVM_NOTE_DATA
prompt ===================================
prompt
create table ACC_ST.ST_ERR_TVM_NOTE_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee_1       NUMBER(18,2),
  note_fee_2       NUMBER(18,2),
  note_fee_3       NUMBER(18,2),
  note_fee_4       NUMBER(18,2),
  note_fee_5       NUMBER(18,2),
  note_fee_6       NUMBER(18,2),
  note_fee_7       NUMBER(18,2),
  note_fee_8       NUMBER(18,2),
  note_fee_9       NUMBER(18,2),
  note_fee_10      NUMBER(18,2),
  note_fee_11      NUMBER(18,2),
  note_fee_12      NUMBER(18,2),
  note_fee_13      NUMBER(18,2),
  note_num_1       NUMBER(18),
  note_num_2       NUMBER(18),
  note_num_3       NUMBER(18),
  note_num_4       NUMBER(18),
  note_num_5       NUMBER(18),
  note_num_6       NUMBER(18),
  note_num_7       NUMBER(18),
  note_num_8       NUMBER(18),
  note_num_9       NUMBER(18),
  note_num_10      NUMBER(18),
  note_num_11      NUMBER(18),
  note_num_12      NUMBER(18),
  note_num_13      NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_NOTE_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_NOTE_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_NOTE_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_TVM_NOTE_RECLAIM
prompt ======================================
prompt
create table ACC_ST.ST_ERR_TVM_NOTE_RECLAIM
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee_1         NUMBER(18,2),
  note_num_reclaim_1 NUMBER(18),
  note_fee_2         NUMBER(18,2),
  note_num_reclaim_2 NUMBER(18),
  note_fee_3         NUMBER(18,2),
  note_num_reclaim_3 NUMBER(18),
  note_fee_4         NUMBER(18,2),
  note_num_reclaim_4 NUMBER(18),
  err_code           CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_NOTE_RECLAIM to ACC_ST_APP;

prompt
prompt Creating table ST_ERR_TVM_WASTE_CARD_DATA
prompt =========================================
prompt
create table ACC_ST.ST_ERR_TVM_WASTE_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  sjt_num          NUMBER(18),
  sjt_discount_num NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_TVM_WASTE_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_TVM_WASTE_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_TVM_WASTE_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_UPDATE
prompt ============================
prompt
create table ACC_ST.ST_ERR_UPDATE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_consume_seq      INTEGER,
  card_status_id        CHAR(3),
  update_area           CHAR(1),
  update_reason_id      CHAR(2),
  update_datetime       DATE,
  pay_type              CHAR(2),
  penalty_fee           NUMBER(18,2),
  receipt_id            CHAR(4),
  operator_id           CHAR(8),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  shift_id              CHAR(2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  balance_fee           NUMBER(18,2),
  deal_no_dicount_fee   NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_time            DATE,
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  card_app_flag         CHAR(1),
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.INDEX4_BALANCE_WATER_NO on ACC_ST.ST_ERR_UPDATE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_ERR_UPDATE_UNIQUE
prompt ===================================
prompt
create table ACC_ST.ST_ERR_UPDATE_UNIQUE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_consume_seq      INTEGER,
  card_status_id        CHAR(3),
  update_area           CHAR(1),
  update_reason_id      CHAR(2),
  update_datetime       DATE,
  pay_type              CHAR(2),
  penalty_fee           NUMBER(18,2),
  receipt_id            CHAR(4),
  operator_id           CHAR(8),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  shift_id              CHAR(2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  balance_fee           NUMBER(18,2),
  deal_no_dicount_fee   NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_time            DATE,
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  card_app_flag         CHAR(1),
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ERR_UPDATE_UNIQUE to ACC_ST_APP;
grant select on ACC_ST.ST_ERR_UPDATE_UNIQUE to ACC_ST_DEV;
grant select on ACC_ST.ST_ERR_UPDATE_UNIQUE to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_AUDIT_BALANCE
prompt =======================================
prompt
create table ACC_ST.ST_EXT_MTR_AUDIT_BALANCE
(
  water_no         NUMBER(18),
  sam_logical_id   CHAR(20),
  pay_mode_id      CHAR(2),
  total_deal_num   NUMBER(18),
  total_deal_fee   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_AUDIT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_AUDIT_FILE_STL
prompt ========================================
prompt
create table ACC_ST.ST_EXT_MTR_AUDIT_FILE_STL
(
  water_no          NUMBER(18),
  file_name_audited VARCHAR2(30),
  total_record_num  NUMBER(18),
  total_record_fee  NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_AUDIT_FILE_STL to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_FILE_STL to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_FILE_STL to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_AUDIT_FILE_TRX
prompt ========================================
prompt
create table ACC_ST.ST_EXT_MTR_AUDIT_FILE_TRX
(
  water_no          NUMBER(18),
  file_name_audited VARCHAR2(30),
  total_record_num  NUMBER(18),
  total_record_fee  NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_AUDIT_FILE_TRX to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_FILE_TRX to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_FILE_TRX to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_AUDIT_STATUS
prompt ======================================
prompt
create table ACC_ST.ST_EXT_MTR_AUDIT_STATUS
(
  water_no         NUMBER(18),
  file_name_acc    VARCHAR2(30),
  file_status      CHAR(2),
  total_record_num NUMBER(18),
  total_record_fee NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_AUDIT_STATUS to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_AUDIT_STATUS to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_BLACKLIST
prompt ===================================
prompt
create table ACC_ST.ST_EXT_MTR_BLACKLIST
(
  water_no              NUMBER(18),
  card_logical_id_start CHAR(20),
  card_logical_id_end   CHAR(20),
  sect_flag             CHAR(1),
  card_status           CHAR(2),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_BLACKLIST to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_BLACKLIST to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_BLACKLIST to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_BLACKLIST_TOTAL
prompt =========================================
prompt
create table ACC_ST.ST_EXT_MTR_BLACKLIST_TOTAL
(
  card_logical_id_start CHAR(20) not null,
  card_logical_id_end   CHAR(20) not null,
  sect_flag             CHAR(1) not null,
  card_status           CHAR(2),
  send_datetime         DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_EXT_MTR_BLACKLIST_TOTAL
  add constraint ST_EXT_MTR_BLACKLIST_TOTAL_PK primary key (CARD_LOGICAL_ID_START, CARD_LOGICAL_ID_END, SECT_FLAG)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_BLACKLIST_TOTAL to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_BLACKLIST_TOTAL to ACC_ST_DEV;

prompt
prompt Creating table ST_EXT_MTR_BLL_APPLY
prompt ===================================
prompt
create table ACC_ST.ST_EXT_MTR_BLL_APPLY
(
  water_no              NUMBER(18),
  card_logical_id_start CHAR(20),
  sect_flag             CHAR(1),
  card_logical_id_end   CHAR(20),
  card_status           CHAR(2),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_BLL_APPLY to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_BLL_APPLY to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_BLL_APPLY to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_BUF_DEAL
prompt ==================================
prompt
create table ACC_ST.ST_EXT_MTR_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_BUF_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_BUF_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_ERR_DEAL
prompt ==================================
prompt
create table ACC_ST.ST_EXT_MTR_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         VARCHAR2(20),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        VARCHAR2(20),
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    VARCHAR2(20),
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime VARCHAR2(20),
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  err_code              CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_ERR_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_ERR_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_ERR_DEAL_OLD
prompt ======================================
prompt
create table ACC_ST.ST_EXT_MTR_ERR_DEAL_OLD
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  err_code              CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_ERR_DEAL_OLD to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_ERR_DEAL_OLD to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_ERR_DEAL_OLD to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_ERR_TRADE
prompt ===================================
prompt
create table ACC_ST.ST_EXT_MTR_ERR_TRADE
(
  water_no         NUMBER(18),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  deal_datetime    VARCHAR2(20),
  err_code         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  deal_fee         NUMBER(18,2),
  pay_mode_id      CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_ERR_TRADE to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_ERR_TRADE to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_ERR_TRADE to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_MTR_QUE_DEAL
prompt ==================================
prompt
create table ACC_ST.ST_EXT_MTR_QUE_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_MTR_QUE_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_MTR_QUE_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_MTR_QUE_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_AUDIT_BALANCE
prompt =======================================
prompt
create table ACC_ST.ST_EXT_OCT_AUDIT_BALANCE
(
  water_no         NUMBER(18),
  sam_logical_id   CHAR(20),
  pay_mode_id      CHAR(2),
  total_deal_num   NUMBER(18),
  total_deal_fee   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  in_flag          CHAR(1) default '0'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_AUDIT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_AUDIT_FILE
prompt ====================================
prompt
create table ACC_ST.ST_EXT_OCT_AUDIT_FILE
(
  water_no          NUMBER(18),
  file_name_audited VARCHAR2(30),
  total_record_num  NUMBER(18),
  total_record_fee  NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_AUDIT_FILE to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_FILE to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_FILE to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_AUDIT_FILE_STL
prompt ========================================
prompt
create table ACC_ST.ST_EXT_OCT_AUDIT_FILE_STL
(
  water_no          NUMBER(18),
  file_name_audited VARCHAR2(30),
  total_record_num  NUMBER(18),
  total_record_fee  NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_AUDIT_FILE_STL to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_FILE_STL to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_FILE_STL to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_AUDIT_FILE_TRX
prompt ========================================
prompt
create table ACC_ST.ST_EXT_OCT_AUDIT_FILE_TRX
(
  water_no          NUMBER(18),
  file_name_audited VARCHAR2(30),
  total_record_num  NUMBER(18),
  total_record_fee  NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_AUDIT_FILE_TRX to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_FILE_TRX to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_FILE_TRX to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_AUDIT_STATUS
prompt ======================================
prompt
create table ACC_ST.ST_EXT_OCT_AUDIT_STATUS
(
  water_no         NUMBER(18),
  file_name_acc    VARCHAR2(30),
  file_status      CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_AUDIT_STATUS to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_AUDIT_STATUS to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_BLACKLIST
prompt ===================================
prompt
create table ACC_ST.ST_EXT_OCT_BLACKLIST
(
  water_no              NUMBER(18),
  card_logical_id_start CHAR(20),
  card_logical_id_end   CHAR(20),
  sect_flag             CHAR(1),
  card_status           CHAR(2),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_BLACKLIST to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_BLACKLIST to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_BLACKLIST to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_BLL_APPLY
prompt ===================================
prompt
create table ACC_ST.ST_EXT_OCT_BLL_APPLY
(
  water_no              NUMBER(18),
  card_logical_id_start CHAR(20),
  sect_flag             CHAR(1),
  card_logical_id_end   CHAR(20),
  card_status           CHAR(2),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_BLL_APPLY to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_BLL_APPLY to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_BLL_APPLY to ACC_ST_RPT;

prompt
prompt Creating table ST_EXT_OCT_ERR_TRADE
prompt ===================================
prompt
create table ACC_ST.ST_EXT_OCT_ERR_TRADE
(
  water_no         NUMBER(18),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  deal_datetime    DATE,
  err_code         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  in_flag          CHAR(1) default '0',
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_EXT_OCT_ERR_TRADE to ACC_ST_APP;
grant select on ACC_ST.ST_EXT_OCT_ERR_TRADE to ACC_ST_DEV;
grant select on ACC_ST.ST_EXT_OCT_ERR_TRADE to ACC_ST_RPT;

prompt
prompt Creating table ST_FLG_DIT000001
prompt ===============================
prompt
create table ACC_ST.ST_FLG_DIT000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  distance_num     NUMBER(18,2),
  total_distance   NUMBER(18,2),
  pass_line        CHAR(2),
  begin_line       CHAR(2),
  end_line         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_FLG_DIT000001 to ACC_ST_APP;
grant select on ACC_ST.ST_FLG_DIT000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_FLOW_NON_RTN
prompt ==============================
prompt
create table ACC_ST.ST_FLOW_NON_RTN
(
  water_no     NUMBER(18) not null,
  id           INTEGER,
  apply_bill   VARCHAR2(25),
  apply_action VARCHAR2(1),
  return_flag  VARCHAR2(1),
  return_time  DATE,
  processing   VARCHAR2(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_FLOW_NON_RTN
  add constraint PK_ST_FLOW_NON_RETURN primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_FLOW_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.ST_FLOW_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.ST_FLOW_NON_RTN to ACC_ST_RPT;

prompt
prompt Creating table ST_FLW_CHG000001
prompt ===============================
prompt
create table ACC_ST.ST_FLW_CHG000001
(
  num                 INTEGER not null,
  squad_day           CHAR(8) not null,
  balance_water_no    CHAR(10) not null,
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_in      CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in_dir  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_FLW_CHG000001 to ACC_ST_APP;
grant select on ACC_ST.ST_FLW_CHG000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_FLW_ST000001
prompt ==============================
prompt
create table ACC_ST.ST_FLW_ST000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  entry_num        CHAR(5),
  export_num       NUMBER(18),
  time_section_id  CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_FLW_ST000001 to ACC_ST_APP;
grant select on ACC_ST.ST_FLW_ST000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_HIS_GRANT_PRIVS_T0324
prompt =======================================
prompt
create table ACC_ST.ST_HIS_GRANT_PRIVS_T0324
(
  vs_table_name  VARCHAR2(30),
  vs_table_owner VARCHAR2(20),
  vs_grant_sql   VARCHAR2(500),
  vd_create_time DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_HIS_GRANT_PRIVS_T0324 to ACC_ST_APP;
grant select on ACC_ST.ST_HIS_GRANT_PRIVS_T0324 to ACC_ST_DEV;
grant select on ACC_ST.ST_HIS_GRANT_PRIVS_T0324 to ACC_ST_RPT;

prompt
prompt Creating table ST_ICM_CRD000001
prompt ===============================
prompt
create table ACC_ST.ST_ICM_CRD000001
(
  water_no         NUMBER(20) not null,
  contc_id         CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_ICM_CRD000001
  is '‘À”™…Ã ’»ÎÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_ICM_CRD000001_1 on ACC_ST.ST_ICM_CRD000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_ICM_CRD000001_2 on ACC_ST.ST_ICM_CRD000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_ICM_CRD000001
  add constraint PK_ST_ICM_CRD000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ICM_CRD000001 to ACC_ST_APP;
grant select on ACC_ST.ST_ICM_CRD000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_IDX_RPT_HISTORY
prompt =================================
prompt
create table ACC_ST.ST_IDX_RPT_HISTORY
(
  table_name        VARCHAR2(50) not null,
  origin_table_name VARCHAR2(50),
  begin_balance_no  CHAR(10),
  end_balance_no    CHAR(10),
  min_squad_day     VARCHAR2(8),
  max_squad_day     VARCHAR2(8),
  recd_count        INTEGER,
  begin_date        DATE,
  end_date          DATE,
  create_time       DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_IDX_RPT_HISTORY to ACC_ST_APP;
grant select on ACC_ST.ST_IDX_RPT_HISTORY to ACC_ST_DEV;
grant select on ACC_ST.ST_IDX_RPT_HISTORY to ACC_ST_RPT;

prompt
prompt Creating table ST_IDX_TRX_HISTORY
prompt =================================
prompt
create table ACC_ST.ST_IDX_TRX_HISTORY
(
  table_name  VARCHAR2(30) not null,
  data_type   VARCHAR2(3),
  recd_type   VARCHAR2(2),
  begin_date  DATE,
  end_date    DATE,
  recd_count  INTEGER,
  create_time DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_IDX_TRX_HISTORY
  is 'Ωª“◊ ˝æ›¿˙ ∑À˜“˝±Ì';
alter table ACC_ST.ST_IDX_TRX_HISTORY
  add constraint PK_ST_IDX_TRX_HISTORY primary key (TABLE_NAME)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_IDX_TRX_HISTORY to ACC_ST_APP;
grant select on ACC_ST.ST_IDX_TRX_HISTORY to ACC_ST_DEV;
grant select on ACC_ST.ST_IDX_TRX_HISTORY to ACC_ST_RPT;

prompt
prompt Creating table ST_IDX_TRX_HISTORY_BAK
prompt =====================================
prompt
create table ACC_ST.ST_IDX_TRX_HISTORY_BAK
(
  table_name       CHAR(30),
  data_type        CHAR(3),
  recd_type        CHAR(2),
  begin_date       DATE,
  end_date         DATE,
  recd_count       INTEGER,
  total_count      INTEGER,
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_IDX_TRX_HISTORY_BAK to ACC_ST_APP;
grant select on ACC_ST.ST_IDX_TRX_HISTORY_BAK to ACC_ST_DEV;
grant select on ACC_ST.ST_IDX_TRX_HISTORY_BAK to ACC_ST_RPT;

prompt
prompt Creating table ST_IDX_TRX_HISTORY_BALANCE
prompt =========================================
prompt
create table ACC_ST.ST_IDX_TRX_HISTORY_BALANCE
(
  table_name       VARCHAR2(30) not null,
  data_type        VARCHAR2(3),
  recd_type        VARCHAR2(2),
  balance_water_no CHAR(10) not null,
  create_time      DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_IDX_TRX_HISTORY_BALANCE
  is 'Ωª“◊ ˝æ›¿˙ ∑À˜“˝±Ì(«ÂÀ„¡˜ÀÆ∫≈)';
alter table ACC_ST.ST_IDX_TRX_HISTORY_BALANCE
  add constraint PK_ST_IDX_TRX_HISTORY_BALANCE primary key (TABLE_NAME, BALANCE_WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_IDX_TRX_HISTORY_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_IDX_TRX_HISTORY_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_IDX_TRX_HISTORY_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_ID_NON_RTN
prompt ============================
prompt
create table ACC_ST.ST_ID_NON_RTN
(
  id INTEGER not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_ID_NON_RTN
  add constraint PK_ST_ID_NON_RETURN primary key (ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_ID_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.ST_ID_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.ST_ID_NON_RTN to ACC_ST_RPT;

prompt
prompt Creating table ST_INC_BAL000001
prompt ===============================
prompt
create table ACC_ST.ST_INC_BAL000001
(
  water_no          NUMBER(20) not null,
  balance_water_no  CHAR(10),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  total_num         NUMBER(18),
  total_bal_fee     NUMBER(18,2),
  total_deposit_fee NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_INC_BAL000001
  is '≥µ∆±∑¢ €Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_INC_BAL000001_1 on ACC_ST.ST_INC_BAL000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_BAL000001
  add constraint PK_ST_INC_BAL000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_BAL000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_BAL000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_INC_CON000001
prompt ===============================
prompt
create table ACC_ST.ST_INC_CON000001
(
  water_no             NUMBER(18) not null,
  balance_water_no     CHAR(10),
  line_id              CHAR(2),
  station_id           CHAR(2),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  squad_day            CHAR(8),
  deal_num             NUMBER(18),
  deal_fee             NUMBER(18,2),
  deal_no_discount_fee NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_CON000001_1 on ACC_ST.ST_INC_CON000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_CON000001_2 on ACC_ST.ST_INC_CON000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_CON000001
  add primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_CON000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_CON000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_INC_FRE000001
prompt ===============================
prompt
create table ACC_ST.ST_INC_FRE000001
(
  water_no          NUMBER(20) not null,
  balance_water_no  CHAR(10),
  squad_day         CHAR(8),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  pay_type          CHAR(2),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  sale_fee          NUMBER(18,2),
  sale_num          NUMBER(18),
  total_deposit_fee NUMBER(18,2),
  total_sale_fee    NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_INC_FRE000001
  is 'TVM∑¢ €µ•≥Ã∆± ˝¡øÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_INC_FRE000001_1 on ACC_ST.ST_INC_FRE000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_FRE000001_2 on ACC_ST.ST_INC_FRE000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_FRE000001
  add constraint PK_ST_INC_FRE000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_FRE000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_FRE000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_INC_RTN000001
prompt ===============================
prompt
create table ACC_ST.ST_INC_RTN000001
(
  water_no           NUMBER(20) not null,
  balance_water_no   CHAR(10),
  line_id            CHAR(2),
  station_id         CHAR(2),
  return_type        CHAR(1),
  squad_day          CHAR(8),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  return_num         NUMBER(18),
  return_deposit_fee NUMBER(18,2),
  bad_num            NUMBER(18),
  return_balance_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_INC_RTN000001
  is '≥µ∆±ÕÀøÓÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_INC_RTN000001_1 on ACC_ST.ST_INC_RTN000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_RTN000001_2 on ACC_ST.ST_INC_RTN000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_RTN000001
  add constraint PK_ST_INC_RTN000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_RTN000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_RTN000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_INC_SLE000001
prompt ===============================
prompt
create table ACC_ST.ST_INC_SLE000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  pay_type         CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  sale_num         NUMBER(18),
  deposit_fee      NUMBER(18,2),
  charge_fee       NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_INC_SLE000001
  is '≥µ∆±∑¢ €Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_INC_SLE000001_1 on ACC_ST.ST_INC_SLE000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_SLE000001_2 on ACC_ST.ST_INC_SLE000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_SLE000001
  add constraint PK_ST_INC_SLE000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_SLE000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_SLE000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_INC_ST000001
prompt ==============================
prompt
create table ACC_ST.ST_INC_ST000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  do_type          CHAR(2),
  operator_id      CHAR(6),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  dev_type_id      CHAR(2),
  deal_fee         NUMBER(18,2),
  return_balance   NUMBER(18,2),
  deal_num         NUMBER(18),
  shift_id         CHAR(2),
  device_id        CHAR(4),
  penalty_fee      NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_INC_ST000001
  is '≥µ’æ ’“ÊÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_INC_ST000001_1 on ACC_ST.ST_INC_ST000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_ST000001_2 on ACC_ST.ST_INC_ST000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_ST000001
  add constraint PK_ST_INC_ST000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_ST000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_ST000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_INC_UD000001
prompt ==============================
prompt
create table ACC_ST.ST_INC_UD000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  pay_type         CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  update_num       NUMBER(18),
  update_fee       NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_INC_UD000001
  is '≥µ∆±∏¸–¬Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_INC_UD000001_1 on ACC_ST.ST_INC_UD000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_INC_UD000001_2 on ACC_ST.ST_INC_UD000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_INC_UD000001
  add constraint PK_ST_INC_UD000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_INC_UD000001 to ACC_ST_APP;
grant select on ACC_ST.ST_INC_UD000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_LIST_BALANCE_CAL
prompt ==================================
prompt
create table ACC_ST.ST_LIST_BALANCE_CAL
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) not null,
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20) not null,
  charge_num       NUMBER(18),
  consume_num      NUMBER(18),
  charge_fee       NUMBER(18,2),
  consume_fee      NUMBER(18,2),
  card_balance_fee NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_LIST_BALANCE_CAL
  add constraint ST_LIST_BALANCE_CAL_PK primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_BALANCE_CAL to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_BALANCE_CAL to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_BALANCE_CAL to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_BALANCE_CONTC
prompt ====================================
prompt
create table ACC_ST.ST_LIST_BALANCE_CONTC
(
  contc_id         CHAR(2),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2),
  version_no       CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_BALANCE_CONTC
  is '«Â∑÷‘À”™…Ã÷–º‰±Ì';
create index ACC_ST.IDX_BALANCE_END on ACC_ST.ST_LIST_BALANCE_CONTC (E_LINE_ID, E_STATION_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_LIST_BALANCE_CONTC on ACC_ST.ST_LIST_BALANCE_CONTC (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, VERSION_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_BALANCE_CONTC to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_BALANCE_CONTC to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_BALANCE_CONTC to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_BALANCE_LINE
prompt ===================================
prompt
create table ACC_ST.ST_LIST_BALANCE_LINE
(
  line_id_dispart  CHAR(2),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2),
  version_no       CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_BALANCE_LINE
  is '«Â∑÷‘À”™…Ã÷–º‰±Ì';
create index ACC_ST.IDX_BALANCE_END_LINE on ACC_ST.ST_LIST_BALANCE_LINE (E_LINE_ID, E_STATION_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_LIST_BALANCE_LINE on ACC_ST.ST_LIST_BALANCE_LINE (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, VERSION_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_BALANCE_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_BALANCE_LINE to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_BALANCE_LINE to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_BALANCE_TRX
prompt ==================================
prompt
create table ACC_ST.ST_LIST_BALANCE_TRX
(
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  version_no_9003  CHAR(10),
  version_no_9004  CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_BALANCE_TRX
  is '«Â∑÷Ωª“◊÷–º‰±Ì';
create index ACC_ST.IDX_ST_LIST_BALANCE_TRX on ACC_ST.ST_LIST_BALANCE_TRX (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID, VERSION_NO_9003)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_BALANCE_TRX to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_BALANCE_TRX to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_BALANCE_TRX to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_BALANCE_WAITING
prompt ======================================
prompt
create table ACC_ST.ST_LIST_BALANCE_WAITING
(
  balance_water_no CHAR(10) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_BALANCE_WAITING
  is '¥˝«ÂÀ„¡˜ÀÆ∫≈±Ì';
alter table ACC_ST.ST_LIST_BALANCE_WAITING
  add constraint PK_ST_LIST_BALANCE_WAITING primary key (BALANCE_WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_BALANCE_WAITING to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_BALANCE_WAITING to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_BALANCE_WAITING to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_NON_RTN
prompt ==============================
prompt
create table ACC_ST.ST_LIST_NON_RTN
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    VARCHAR2(20),
  card_physical_id   VARCHAR2(20),
  card_print_id      VARCHAR2(20),
  apply_datetime     DATE,
  receipt_id         CHAR(4),
  operator_id        CHAR(6),
  apply_name         CHAR(8),
  tel_no             VARCHAR2(16),
  identity_type      CHAR(1),
  identity_id        VARCHAR2(18),
  is_broken          CHAR(2),
  shift_id           CHAR(2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  hdl_flag           CHAR(1) not null,
  deposit_fee        NUMBER(18,2),
  card_balance_fee   NUMBER(18,2),
  system_balance_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  return_bala        NUMBER(18,2),
  remark             VARCHAR2(50),
  return_line_id     CHAR(2),
  return_station_id  CHAR(2),
  return_dev_type_id CHAR(2),
  return_device_id   CHAR(4),
  actual_return_bala NUMBER(12,2),
  audit_flag         CHAR(1),
  penalty_reason     CHAR(2),
  return_type        CHAR(1) default '1'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.ST_LIST_NON_RTN.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_LIST_NON_RTN.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_LIST_NON_RTN.dev_type_id
  is '…Ë±∏¿‡–ÕID';
comment on column ACC_ST.ST_LIST_NON_RTN.device_id
  is '…Ë±∏ID';
comment on column ACC_ST.ST_LIST_NON_RTN.card_main_id
  is '∆±ø®÷˜¿‡–ÕID';
comment on column ACC_ST.ST_LIST_NON_RTN.card_sub_id
  is '∆±ø®◊”¿‡–ÕID';
comment on column ACC_ST.ST_LIST_NON_RTN.card_logical_id
  is 'SAMø®¬ﬂº≠ø®∫≈';
comment on column ACC_ST.ST_LIST_NON_RTN.card_physical_id
  is 'SAMø®ŒÔ¿Ìø®∫≈';
comment on column ACC_ST.ST_LIST_NON_RTN.card_print_id
  is '¥Ú”°∫≈';
comment on column ACC_ST.ST_LIST_NON_RTN.apply_datetime
  is '»’∆⁄ ±º‰';
comment on column ACC_ST.ST_LIST_NON_RTN.receipt_id
  is '∆æ÷§ID';
comment on column ACC_ST.ST_LIST_NON_RTN.operator_id
  is '≤Ÿ◊˜‘±ID';
comment on column ACC_ST.ST_LIST_NON_RTN.apply_name
  is '≥ÀøÕ–’√˚';
comment on column ACC_ST.ST_LIST_NON_RTN.tel_no
  is '≥ÀøÕµÁª∞';
comment on column ACC_ST.ST_LIST_NON_RTN.identity_type
  is '÷§º˛¿‡–Õ';
comment on column ACC_ST.ST_LIST_NON_RTN.identity_id
  is '÷§º˛∫≈¬Î';
comment on column ACC_ST.ST_LIST_NON_RTN.is_broken
  is 'Àªµ±Í÷æ';
comment on column ACC_ST.ST_LIST_NON_RTN.shift_id
  is 'BOM∞‡¥Œ–Ú∫≈';
comment on column ACC_ST.ST_LIST_NON_RTN.card_app_flag
  is 'ø®”¶”√±Í ∂';
comment on column ACC_ST.ST_LIST_NON_RTN.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_LIST_NON_RTN.hdl_flag
  is '¥¶¿Ì±Í÷æ';
comment on column ACC_ST.ST_LIST_NON_RTN.deposit_fee
  is '≥…±æ—∫Ω';
comment on column ACC_ST.ST_LIST_NON_RTN.card_balance_fee
  is 'ø®”‡∂Ó';
comment on column ACC_ST.ST_LIST_NON_RTN.system_balance_fee
  is 'œµÕ≥”‡∂Ó';
comment on column ACC_ST.ST_LIST_NON_RTN.penalty_fee
  is '∑£øÓ';
comment on column ACC_ST.ST_LIST_NON_RTN.return_bala
  is '”¶ÕÀΩ∂Ó';
comment on column ACC_ST.ST_LIST_NON_RTN.remark
  is '±∏◊¢';
comment on column ACC_ST.ST_LIST_NON_RTN.return_line_id
  is 'ÕÀøÓœﬂ¬∑ID';
comment on column ACC_ST.ST_LIST_NON_RTN.return_station_id
  is 'ÕÀøÓ≥µ’æID';
comment on column ACC_ST.ST_LIST_NON_RTN.return_dev_type_id
  is 'ÕÀøÓ…Ë±∏¿‡–ÕID';
comment on column ACC_ST.ST_LIST_NON_RTN.return_device_id
  is 'ÕÀøÓ…Ë±∏ID';
comment on column ACC_ST.ST_LIST_NON_RTN.actual_return_bala
  is ' µº ÕÀøÓΩ∂Ó';
comment on column ACC_ST.ST_LIST_NON_RTN.audit_flag
  is '…Û∫À±Í÷æ';
comment on column ACC_ST.ST_LIST_NON_RTN.penalty_reason
  is '∑£øÓ‘≠“ÚID';
comment on column ACC_ST.ST_LIST_NON_RTN.return_type
  is '0£∫º¥ ±ÕÀøÓ£ª1£∫∑«º¥ ±ÕÀøÓ£ª2£∫µ•≥Ã∆±ÕÀøÓ£ª3£∫∑«’˝≥£ƒ£ Ωµ•≥Ã∆±ÕÀøÓ 4£∫π“ ß∑«º¥ ±ÕÀøÓ';
alter table ACC_ST.ST_LIST_NON_RTN
  add primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_NON_RTN to ACC_ST_RPT;
grant select on ACC_ST.ST_LIST_NON_RTN to ACC_TK_APP;
grant select on ACC_ST.ST_LIST_NON_RTN to ACC_TK_DEV;

prompt
prompt Creating table ST_LIST_REPORT_LOSS
prompt ==================================
prompt
create table ACC_ST.ST_LIST_REPORT_LOSS
(
  water_no         NUMBER(18) not null,
  apply_bill       VARCHAR2(25),
  create_time      DATE,
  busniss_type     CHAR(1),
  identify_type    CHAR(1),
  identity_id      VARCHAR2(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  apply_name       VARCHAR2(20),
  apply_sex        CHAR(1),
  expired_date     CHAR(8),
  tel_no           VARCHAR2(16),
  fax              VARCHAR2(16),
  address          VARCHAR2(200),
  operator_id      VARCHAR2(10),
  apply_datetime   DATE,
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  VARCHAR2(20),
  card_physical_id VARCHAR2(20),
  card_print_id    VARCHAR2(20),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_REPORT_LOSS
  is 'º«√˚ø®π“ ß◊¥Ã¨±Ì';
comment on column ACC_ST.ST_LIST_REPORT_LOSS.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_LIST_REPORT_LOSS.apply_bill
  is '∆æ÷§ID';
comment on column ACC_ST.ST_LIST_REPORT_LOSS.create_time
  is '¥¥Ω® ±º‰';
comment on column ACC_ST.ST_LIST_REPORT_LOSS.busniss_type
  is '“µŒÒ¿‡–Õ';
comment on column ACC_ST.ST_LIST_REPORT_LOSS.identify_type
  is '÷§º˛¿‡–Õ(1:…Ì∑›÷§;2:—ß…˙÷§;3:æ¸»À÷§;4:¿œ»Àø®;5:‘±π§ø®;9:∆‰À˚)';
comment on column ACC_ST.ST_LIST_REPORT_LOSS.identity_id
  is '÷§º˛∫≈¬Î';
alter table ACC_ST.ST_LIST_REPORT_LOSS
  add constraint PK_ST_LIST_REPORT_LOSSS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_REPORT_LOSS to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_REPORT_LOSS_PEND
prompt =======================================
prompt
create table ACC_ST.ST_LIST_REPORT_LOSS_PEND
(
  water_no         NUMBER(18) not null,
  apply_bill       VARCHAR2(25),
  create_time      DATE,
  busniss_type     CHAR(1),
  identify_type    CHAR(1),
  identity_id      VARCHAR2(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  apply_name       VARCHAR2(20),
  apply_sex        CHAR(1),
  expired_date     CHAR(8),
  tel_no           VARCHAR2(16),
  fax              VARCHAR2(16),
  address          VARCHAR2(200),
  operator_id      VARCHAR2(10),
  apply_datetime   DATE,
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  VARCHAR2(20),
  card_physical_id VARCHAR2(20),
  card_print_id    VARCHAR2(20),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_REPORT_LOSS_PEND
  is 'º«√˚ø®π“ ß/Ω‚π“…Í«Î¥˝¥¶¿Ì±Ì';
grant select, insert, update, delete on ACC_ST.ST_LIST_REPORT_LOSS_PEND to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_REPORT_LOSS_PEND to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_REPORT_LOSS_PEND to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_SAM_CURRENT
prompt ==================================
prompt
create table ACC_ST.ST_LIST_SAM_CURRENT
(
  sam_logical_id  CHAR(20) not null,
  sam_type_code   CHAR(1) not null,
  device_id       CHAR(3) not null,
  dev_type_id     CHAR(2) not null,
  line_id         CHAR(2) not null,
  station_id      CHAR(2) not null,
  delete_datetime DATE,
  insert_datetime DATE,
  operator_id     CHAR(6),
  version_no      CHAR(10),
  record_flag     CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_SAM_CURRENT
  is 'SAMø®–£—È≤Œ ˝±Ì';
alter table ACC_ST.ST_LIST_SAM_CURRENT
  add constraint PK_ST_LIST_SAM_CURRENT primary key (SAM_LOGICAL_ID, SAM_TYPE_CODE, DEVICE_ID, DEV_TYPE_ID, LINE_ID, STATION_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_SAM_CURRENT to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_SAM_CURRENT to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_SAM_CURRENT to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_SAM_WATER
prompt ================================
prompt
create table ACC_ST.ST_LIST_SAM_WATER
(
  water_no            NUMBER(18) not null,
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  sam_logical_id      CHAR(20),
  sam_trade_seq_start NUMBER(18),
  sam_trade_seq_end   NUMBER(18),
  balance_water_no    CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_LIST_SAM_WATER
  add constraint ST_LIST_SAM_WATER_PK primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_SAM_WATER to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_SAM_WATER to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_SAM_WATER to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_SIGN_CARD
prompt ================================
prompt
create table ACC_ST.ST_LIST_SIGN_CARD
(
  req_no            CHAR(10) not null,
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        VARCHAR2(20),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  hdl_time          DATE,
  hdl_flag          CHAR(1),
  order_no          CHAR(14),
  card_sub_id       CHAR(2),
  card_main_id      CHAR(2),
  app_business_type CHAR(1) default '1'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.ST_LIST_SIGN_CARD.card_sub_id
  is '∆±ø®÷˜¿‡–ÕID';
comment on column ACC_ST.ST_LIST_SIGN_CARD.card_main_id
  is '∆±ø®◊”¿‡–ÕID';
comment on column ACC_ST.ST_LIST_SIGN_CARD.app_business_type
  is '…Í«Î¿‡–Õ';
alter table ACC_ST.ST_LIST_SIGN_CARD
  add constraint IDX_PRIMARY primary key (REQ_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_LIST_SIGN_CARD
  add constraint UK_IDENTITY unique (IDENTITY_TYPE, IDENTITY_ID, CARD_APP_FLAG)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select on ACC_ST.ST_LIST_SIGN_CARD to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.ST_LIST_SIGN_CARD to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_SIGN_CARD to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_SIGN_CARD to ACC_ST_RPT;
grant select, update on ACC_ST.ST_LIST_SIGN_CARD to ACC_TK_APP;
grant select on ACC_ST.ST_LIST_SIGN_CARD to ACC_TK_DEV;
grant select on ACC_ST.ST_LIST_SIGN_CARD to ACC_TK_RPT;

prompt
prompt Creating table ST_LIST_SIGN_CARD_DEL
prompt ====================================
prompt
create table ACC_ST.ST_LIST_SIGN_CARD_DEL
(
  req_no            CHAR(10) not null,
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        VARCHAR2(20),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  hdl_time          DATE,
  hdl_flag          CHAR(1),
  order_no          CHAR(14),
  card_sub_id       CHAR(2),
  card_main_id      CHAR(2),
  app_business_type CHAR(1) default '1'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on column ACC_ST.ST_LIST_SIGN_CARD_DEL.app_business_type
  is '…Í«Î¿‡–Õ';
grant select on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_ONLINE_DEV;
grant select, insert, update, delete on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_ST_RPT;
grant select, update on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_TK_APP;
grant select on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_TK_DEV;
grant select on ACC_ST.ST_LIST_SIGN_CARD_DEL to ACC_TK_RPT;

prompt
prompt Creating table ST_LIST_SIGN_CARD_PEND
prompt =====================================
prompt
create table ACC_ST.ST_LIST_SIGN_CARD_PEND
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           VARCHAR2(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1) default '1'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LIST_SIGN_CARD_PEND
  is 'º«√˚ø®…Í«Î¥˝¥¶¿Ì±Ì';
grant select, insert, update, delete on ACC_ST.ST_LIST_SIGN_CARD_PEND to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_SIGN_CARD_PEND to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_SIGN_CARD_PEND to ACC_ST_RPT;

prompt
prompt Creating table ST_LIST_SIGN_CARD_REMAKE
prompt =======================================
prompt
create table ACC_ST.ST_LIST_SIGN_CARD_REMAKE
(
  water_no              NUMBER(18),
  identity_type         CHAR(1),
  identity_id           CHAR(18),
  apply_name            VARCHAR2(20),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  apply_datetime_remake DATE,
  apply_name_remake     CHAR(8),
  reason_id             CHAR(2),
  remark                VARCHAR2(150),
  req_no                CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LIST_SIGN_CARD_REMAKE to ACC_ST_APP;
grant select on ACC_ST.ST_LIST_SIGN_CARD_REMAKE to ACC_ST_DEV;
grant select on ACC_ST.ST_LIST_SIGN_CARD_REMAKE to ACC_TK_DEV;

prompt
prompt Creating table ST_LOG_BALANCE
prompt =============================
prompt
create table ACC_ST.ST_LOG_BALANCE
(
  water_no         NUMBER(18) not null,
  balance_water_no CHAR(10),
  oper_object      VARCHAR2(60),
  err_level        CHAR(1),
  remark           VARCHAR2(400),
  operator_id      VARCHAR2(20),
  gen_datetime     DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LOG_BALANCE
  is '«Â∑÷’À»’÷æ';
alter table ACC_ST.ST_LOG_BALANCE
  add constraint PK_ST_LOG_BALANCE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_BALANCE_DETAIL
prompt ====================================
prompt
create table ACC_ST.ST_LOG_BALANCE_DETAIL
(
  water_no         NUMBER(18) not null,
  balance_water_no CHAR(10),
  step_id          CHAR(2),
  step_name        VARCHAR2(100),
  start_datetime   DATE,
  end_datetime     DATE,
  use_time         NUMBER,
  result_ok        VARCHAR2(250),
  result_exception VARCHAR2(250),
  sys_level        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LOG_BALANCE_DETAIL
  is '«ÂÀ„√˜œ∏»’÷æ±Ì';
alter table ACC_ST.ST_LOG_BALANCE_DETAIL
  add constraint PK_ST_LOG_BALANCE_DETAIL primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_BALANCE_DETAIL to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_BALANCE_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_BALANCE_DETAIL to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_BALNCE_DETAIL
prompt ===================================
prompt
create table ACC_ST.ST_LOG_BALNCE_DETAIL
(
  balance_water_no CHAR(10),
  modu_name        CHAR(50),
  begin_datetime   DATE,
  end_datetime     DATE,
  step             NUMBER,
  remark           VARCHAR2(200)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_BALNCE_DETAIL to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_BALNCE_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_BALNCE_DETAIL to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_CLEAR_TABLE
prompt =================================
prompt
create table ACC_ST.ST_LOG_CLEAR_TABLE
(
  origin_table_name    VARCHAR2(50),
  dest_table_name      VARCHAR2(50),
  balance_water_no     VARCHAR2(10),
  begin_clear_datetime CHAR(19),
  end_clear_datetime   CHAR(19),
  spent_time           VARCHAR2(8),
  clear_recd_count     NUMBER,
  err_discribe         VARCHAR2(1000),
  sql_label            VARCHAR2(3000)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_LOG_CLEAR_TABLE
  is '±Ì ˝æ›«Â¿Ì≈‰÷√»’÷æ±Ì';
grant select, insert, update, delete on ACC_ST.ST_LOG_CLEAR_TABLE to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_CLEAR_TABLE to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_CLEAR_TABLE to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_FILE_PASSED
prompt =================================
prompt
create table ACC_ST.ST_LOG_FILE_PASSED
(
  file_name        VARCHAR2(30) not null,
  file_type        VARCHAR2(3),
  balance_water_no CHAR(10),
  gen_time         DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_UK_ST_LOG_FILE_PASSED on ACC_ST.ST_LOG_FILE_PASSED (FILE_NAME)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_FILE_PASSED to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_FILE_PASSED to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_FILE_PASSED to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_FILE_PASSED_OCT
prompt =====================================
prompt
create table ACC_ST.ST_LOG_FILE_PASSED_OCT
(
  file_name        VARCHAR2(30) not null,
  file_type        VARCHAR2(6),
  balance_water_no CHAR(10),
  gen_time         DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_FILE_PASSED_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_FILE_PASSED_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_FILE_PASSED_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_FTP_PUT_FILE
prompt ==================================
prompt
create table ACC_ST.ST_LOG_FTP_PUT_FILE
(
  file_name        VARCHAR2(30) not null,
  balance_water_no CHAR(10),
  put_balance_no   CHAR(10),
  gen_datetime     DATE,
  put_datetime     DATE,
  state            CHAR(1),
  data_type        CHAR(1),
  file_size        NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_FTP_PUT_FILE to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_FTP_PUT_FILE to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_FTP_PUT_FILE to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_FTP_PUT_FILE_OCT
prompt ======================================
prompt
create table ACC_ST.ST_LOG_FTP_PUT_FILE_OCT
(
  file_name        VARCHAR2(30) not null,
  balance_water_no CHAR(10),
  put_balance_no   CHAR(10),
  gen_datetime     DATE,
  put_datetime     DATE,
  state            CHAR(1),
  data_type        CHAR(1),
  file_size        NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_FTP_PUT_FILE_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_FTP_PUT_FILE_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_FTP_PUT_FILE_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_OCT_FILE
prompt ==============================
prompt
create table ACC_ST.ST_LOG_OCT_FILE
(
  put_file_flag        CHAR(1),
  gen_datetime         DATE not null,
  export_line_flag     CHAR(1),
  group_line_flag      CHAR(1),
  zip_file_name        VARCHAR2(30),
  file_type            CHAR(1),
  balance_water_no     CHAR(10),
  ret_balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_LOG_OCT_FILE
  add constraint PK_YCT_LOG_FILE primary key (GEN_DATETIME)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_OCT_FILE to ACC_ST_APP;
grant select on ACC_ST.ST_LOG_OCT_FILE to ACC_ST_DEV;
grant select on ACC_ST.ST_LOG_OCT_FILE to ACC_ST_RPT;

prompt
prompt Creating table ST_LOG_TEMP_FILE_CLEAR
prompt =====================================
prompt
create table ACC_ST.ST_LOG_TEMP_FILE_CLEAR
(
  balance_water_no     CHAR(10),
  clear_dir            VARCHAR2(200),
  clear_datetime_begin DATE,
  clear_datetime_end   DATE,
  clear_file_num       INTEGER,
  clear_result         VARCHAR2(1),
  remark               VARCHAR2(200)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_LOG_TEMP_FILE_CLEAR to ACC_ST_APP;

prompt
prompt Creating table ST_MB_BUF_DEAL
prompt =============================
prompt
create table ACC_ST.ST_MB_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_MB_BUF_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_BUF_LCC
prompt ============================
prompt
create table ACC_ST.ST_MB_BUF_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_num       NUMBER(18),
  charge_fee       NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_BUF_LCC to ACC_ST_APP;

prompt
prompt Creating table ST_MB_BUF_LOCK
prompt =============================
prompt
create table ACC_ST.ST_MB_BUF_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  mobile_no        CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_BUF_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_MB_BUF_LOCK to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_BUF_RETURN
prompt ===============================
prompt
create table ACC_ST.ST_MB_BUF_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_MB_BUF_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_MB_BUF_RETURN to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_BUF_SALE
prompt =============================
prompt
create table ACC_ST.ST_MB_BUF_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  mobile_no         CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_BUF_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_COD_LCC_LINE
prompt =================================
prompt
create table ACC_ST.ST_MB_COD_LCC_LINE
(
  lcc_line_id   CHAR(2),
  lcc_line_name VARCHAR2(50),
  lcc_ip        VARCHAR2(15)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_COD_LCC_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_COD_LCC_LINE to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_COD_LCC_LINE to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_ERR_DEAL
prompt =============================
prompt
create table ACC_ST.ST_MB_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_MB_ERR_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_ERR_LCC
prompt ============================
prompt
create table ACC_ST.ST_MB_ERR_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_num       NUMBER(18),
  charge_fee       NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_ERR_LCC to ACC_ST_APP;

prompt
prompt Creating table ST_MB_ERR_LOCK
prompt =============================
prompt
create table ACC_ST.ST_MB_ERR_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  err_code         CHAR(2),
  mobile_no        CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_ERR_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_MB_ERR_LOCK to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_ERR_RETURN
prompt ===============================
prompt
create table ACC_ST.ST_MB_ERR_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11),
  err_code           CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_ERR_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_MB_ERR_RETURN to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_ERR_SALE
prompt =============================
prompt
create table ACC_ST.ST_MB_ERR_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2),
  mobile_no         CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_ERR_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_ERR_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_EXT_QUE_DEAL_BUS
prompt =====================================
prompt
create table ACC_ST.ST_MB_EXT_QUE_DEAL_BUS
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_EXT_QUE_DEAL_BUS to ACC_ST_APP;
grant select on ACC_ST.ST_MB_EXT_QUE_DEAL_BUS to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_EXT_QUE_DEAL_LINE
prompt ======================================
prompt
create table ACC_ST.ST_MB_EXT_QUE_DEAL_LINE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_EXT_QUE_DEAL_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_EXT_QUE_DEAL_LINE to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_EXT_STS_DEAL_BUS
prompt =====================================
prompt
create table ACC_ST.ST_MB_EXT_STS_DEAL_BUS
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_MB_EXT_STS_DEAL_BUS
  is ' ÷ª˙÷ß∏∂œ˚∑—÷–º‰±Ì£®π´Ωª£©';
grant select, insert, update, delete on ACC_ST.ST_MB_EXT_STS_DEAL_BUS to ACC_ST_APP;
grant select on ACC_ST.ST_MB_EXT_STS_DEAL_BUS to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_EXT_STS_DEAL_BUS to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_EXT_STS_DEAL_LINE
prompt ======================================
prompt
create table ACC_ST.ST_MB_EXT_STS_DEAL_LINE
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_MB_EXT_STS_DEAL_LINE
  is ' ÷ª˙÷ß∏∂œ˚∑—÷–º‰±Ì£®πÏµ¿£©';
grant select, insert, update, delete on ACC_ST.ST_MB_EXT_STS_DEAL_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_EXT_STS_DEAL_LINE to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_EXT_STS_DEAL_LINE to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_QUE_DEAL
prompt =============================
prompt
create table ACC_ST.ST_MB_QUE_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_QUE_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_MB_QUE_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_QUE_LCC
prompt ============================
prompt
create table ACC_ST.ST_MB_QUE_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_num       NUMBER(18),
  charge_fee       NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_QUE_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_MB_QUE_LCC to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_QUE_LOCK
prompt =============================
prompt
create table ACC_ST.ST_MB_QUE_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  mobile_no        CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_QUE_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_MB_QUE_LOCK to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_QUE_RETURN
prompt ===============================
prompt
create table ACC_ST.ST_MB_QUE_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_MB_QUE_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_MB_QUE_RETURN to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_QUE_SALE
prompt =============================
prompt
create table ACC_ST.ST_MB_QUE_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  mobile_no         CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_QUE_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_QUE_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_STS_ACC
prompt ============================
prompt
create table ACC_ST.ST_MB_STS_ACC
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_ACC to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_COLLECT_STATUS
prompt =======================================
prompt
create table ACC_ST.ST_MB_STS_COLLECT_STATUS
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  file_name        CHAR(25),
  line_id          CHAR(2),
  station_id       CHAR(2),
  file_type        CHAR(3),
  record_num       INTEGER
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_MB_STS_COLLECT_STATUS
  is ' ÷ª˙÷ß∏∂≤…ºØ…Ûº∆Õ≥º∆±Ì';
alter table ACC_ST.ST_MB_STS_COLLECT_STATUS
  add constraint PK_ST_MB_STS_COLLECT_STATUS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_COLLECT_STATUS to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_COLLECT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_COLLECT_STATUS to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_DEAL
prompt =============================
prompt
create table ACC_ST.ST_MB_STS_DEAL
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  paid_channel_type CHAR(2),
  squad_day         CHAR(8),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  balance_water_no  CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_EXCEPT_BALANCE
prompt =======================================
prompt
create table ACC_ST.ST_MB_STS_EXCEPT_BALANCE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  tr_type_id       CHAR(2),
  error_id         CHAR(2),
  deal_num         NUMBER(18),
  sys_type         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_MB_STS_EXCEPT_BALANCE
  is ' ÷ª˙÷ß∏∂“Ï≥£Ωª“◊Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_MB_STS_EXCEPT_BALANCE on ACC_ST.ST_MB_STS_EXCEPT_BALANCE (BALANCE_WATER_NO)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_MB_STS_EXCEPT_BALANCE
  add constraint PK_ST_MB_STS_EXCEPT_BALANCE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_EXCEPT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_EXCEPT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_EXCEPT_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_LCC
prompt ============================
prompt
create table ACC_ST.ST_MB_STS_LCC
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_LCC to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_LCC to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_LCC_ACC
prompt ================================
prompt
create table ACC_ST.ST_MB_STS_LCC_ACC
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  diff_deal_num    NUMBER(18),
  diff_deal_fee    NUMBER(18,2),
  diff_sale_num    NUMBER(18),
  diff_sale_fee    NUMBER(18,2),
  diff_return_num  NUMBER(18),
  diff_return_fee  NUMBER(18,2),
  diff_lock_num    NUMBER(18),
  diff_unlock_num  NUMBER(18),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_LCC_ACC to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_LCC_ACC to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_LCC_ACC to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_LOCK
prompt =============================
prompt
create table ACC_ST.ST_MB_STS_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  lock_num         NUMBER(18),
  squad_day        CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  lock_flag        CHAR(1),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_LOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_LOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_RETURN
prompt ===============================
prompt
create table ACC_ST.ST_MB_STS_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  return_num         NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  return_type        CHAR(1),
  auxi_fee           NUMBER(18,2),
  paid_channel_type  CHAR(2),
  squad_day          CHAR(8),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  balance_water_no   CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_STS_SALE
prompt =============================
prompt
create table ACC_ST.ST_MB_STS_SALE
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deposit_type     CHAR(2),
  deposit_fee      NUMBER(18,2),
  sale_num         NUMBER(18),
  squad_day        CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_STS_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_STS_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_MB_STS_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_MB_TST_DEAL
prompt =============================
prompt
create table ACC_ST.ST_MB_TST_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_TST_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_MB_TST_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_TST_LOCK
prompt =============================
prompt
create table ACC_ST.ST_MB_TST_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  mobile_no        CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_TST_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_MB_TST_LOCK to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_TST_RETURN
prompt ===============================
prompt
create table ACC_ST.ST_MB_TST_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_MB_TST_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_MB_TST_RETURN to ACC_ST_DEV;

prompt
prompt Creating table ST_MB_TST_SALE
prompt =============================
prompt
create table ACC_ST.ST_MB_TST_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  mobile_no         CHAR(11)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_MB_TST_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_MB_TST_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_BUF_DEAL
prompt =============================
prompt
create table ACC_ST.ST_NP_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_NP_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_NP_BUF_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_BUF_LCC
prompt ============================
prompt
create table ACC_ST.ST_NP_BUF_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_BUF_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_NP_BUF_LCC to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_BUF_ORDER
prompt ==============================
prompt
create table ACC_ST.ST_NP_BUF_ORDER
(
  water_no          NUMBER(10),
  order_no          VARCHAR2(20),
  order_type        CHAR(2),
  status            CHAR(2),
  generate_datetime DATE,
  paid_datetime     DATE,
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  line_id_start     CHAR(2),
  station_id_start  CHAR(2),
  line_id_end       CHAR(2),
  station_id_end    CHAR(2),
  deal_unit_fee     NUMBER(18,2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  mobile_no         CHAR(11),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_BUF_ORDER to ACC_ST_APP;
grant select on ACC_ST.ST_NP_BUF_ORDER to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_BUF_ORDER_IMP
prompt ==================================
prompt
create table ACC_ST.ST_NP_BUF_ORDER_IMP
(
  water_no         NUMBER(18),
  order_no         VARCHAR2(20),
  order_type       CHAR(2),
  finish_datetime  DATE,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_BUF_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.ST_NP_BUF_ORDER_IMP to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_BUF_SALE
prompt =============================
prompt
create table ACC_ST.ST_NP_BUF_SALE
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_NP_BUF_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_ERR_DEAL
prompt =============================
prompt
create table ACC_ST.ST_NP_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20),
  err_code              CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_NP_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_NP_ERR_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_ERR_LCC
prompt ============================
prompt
create table ACC_ST.ST_NP_ERR_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_NP_ERR_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_NP_ERR_LCC to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_ERR_ORDER
prompt ==============================
prompt
create table ACC_ST.ST_NP_ERR_ORDER
(
  water_no          NUMBER(10),
  order_no          VARCHAR2(20),
  order_type        CHAR(2),
  status            CHAR(2),
  generate_datetime DATE,
  paid_datetime     DATE,
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  line_id_start     CHAR(2),
  station_id_start  CHAR(2),
  line_id_end       CHAR(2),
  station_id_end    CHAR(2),
  deal_unit_fee     NUMBER(18,2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  mobile_no         CHAR(11),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_ERR_ORDER to ACC_ST_APP;
grant select on ACC_ST.ST_NP_ERR_ORDER to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_ERR_ORDER_IMP
prompt ==================================
prompt
create table ACC_ST.ST_NP_ERR_ORDER_IMP
(
  water_no         NUMBER(18),
  order_no         VARCHAR2(20),
  order_type       CHAR(2),
  finish_datetime  DATE,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_ERR_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.ST_NP_ERR_ORDER_IMP to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_ERR_SALE
prompt =============================
prompt
create table ACC_ST.ST_NP_ERR_SALE
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20),
  err_code            CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_ERR_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_NP_ERR_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_QUE_DEAL
prompt =============================
prompt
create table ACC_ST.ST_NP_QUE_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_NP_QUE_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_NP_QUE_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_QUE_LCC
prompt ============================
prompt
create table ACC_ST.ST_NP_QUE_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_QUE_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_NP_QUE_LCC to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_QUE_ORDER
prompt ==============================
prompt
create table ACC_ST.ST_NP_QUE_ORDER
(
  water_no          NUMBER(10),
  order_no          VARCHAR2(20),
  order_type        CHAR(2),
  status            CHAR(2),
  generate_datetime DATE,
  paid_datetime     DATE,
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  line_id_start     CHAR(2),
  station_id_start  CHAR(2),
  line_id_end       CHAR(2),
  station_id_end    CHAR(2),
  deal_unit_fee     NUMBER(18,2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  mobile_no         CHAR(11),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_QUE_ORDER to ACC_ST_APP;
grant select on ACC_ST.ST_NP_QUE_ORDER to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_QUE_ORDER_IMP
prompt ==================================
prompt
create table ACC_ST.ST_NP_QUE_ORDER_IMP
(
  water_no         NUMBER(18),
  order_no         VARCHAR2(20),
  order_type       CHAR(2),
  finish_datetime  DATE,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_QUE_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.ST_NP_QUE_ORDER_IMP to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_QUE_SALE
prompt =============================
prompt
create table ACC_ST.ST_NP_QUE_SALE
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_QUE_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_NP_QUE_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_STS_ACC
prompt ============================
prompt
create table ACC_ST.ST_NP_STS_ACC
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_ACC
  is 'ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì';
comment on column ACC_ST.ST_NP_STS_ACC.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_ACC.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_ACC.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_ACC.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_ACC.deal_num
  is '≥‰÷µ ˝¡ø';
comment on column ACC_ST.ST_NP_STS_ACC.deal_fee
  is '≥‰÷µΩ∂Ó';
comment on column ACC_ST.ST_NP_STS_ACC.sale_num
  is '∑¢ € ˝¡ø';
comment on column ACC_ST.ST_NP_STS_ACC.sale_fee
  is '∑¢ €Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_ACC.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_ACC to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_COLLECT_STATUS
prompt =======================================
prompt
create table ACC_ST.ST_NP_STS_COLLECT_STATUS
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  file_name        CHAR(25),
  line_id          CHAR(2),
  station_id       CHAR(2),
  file_type        CHAR(3),
  record_num       INTEGER
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_COLLECT_STATUS
  is 'ª•¡™Õ¯÷ß∏∂≤…ºØ…Ûº∆Õ≥º∆±Ì';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.file_name
  is 'Œƒº˛√˚';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.file_type
  is 'Œƒº˛¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_COLLECT_STATUS.record_num
  is 'º«¬º ˝';
alter table ACC_ST.ST_NP_STS_COLLECT_STATUS
  add constraint PK_ST_NP_STS_COLLECT_STATUS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_STS_COLLECT_STATUS to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_COLLECT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_COLLECT_STATUS to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_DEAL
prompt =============================
prompt
create table ACC_ST.ST_NP_STS_DEAL
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deal_fee         NUMBER(18,2),
  deal_num         NUMBER(18),
  pay_mode_id      CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  order_no         VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_DEAL
  is 'ª•¡™Õ¯÷ß∏∂≥‰÷µÕ≥º∆±Ì';
comment on column ACC_ST.ST_NP_STS_DEAL.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_DEAL.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_DEAL.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_DEAL.dev_type_id
  is '…Ë±∏¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_DEAL.device_id
  is '…Ë±∏ID';
comment on column ACC_ST.ST_NP_STS_DEAL.card_main_id
  is '∆±ø®÷˜¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_DEAL.card_sub_id
  is '∆±ø®◊”¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_DEAL.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_DEAL.deal_fee
  is 'Ωª“◊Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_DEAL.deal_num
  is ' ˝¡ø';
comment on column ACC_ST.ST_NP_STS_DEAL.pay_mode_id
  is '÷ß∏∂¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_DEAL.card_app_flag
  is 'ø®”¶”√±Í ∂';
comment on column ACC_ST.ST_NP_STS_DEAL.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_DEAL.order_no
  is '∂©µ•∫≈';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_EXCEPT_BALANCE
prompt =======================================
prompt
create table ACC_ST.ST_NP_STS_EXCEPT_BALANCE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  tr_type_id       CHAR(2),
  error_id         CHAR(2),
  deal_num         NUMBER(18),
  sys_type         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_EXCEPT_BALANCE
  is 'ª•¡™Õ¯÷ß∏∂“Ï≥£Ωª“◊Õ≥º∆±Ì';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.tr_type_id
  is 'Ωª“◊¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.error_id
  is '¥ÌŒÛ¥˙¬Î';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.deal_num
  is '¥ÌŒÛ ˝¡ø';
comment on column ACC_ST.ST_NP_STS_EXCEPT_BALANCE.sys_type
  is 'œµÕ≥¿‡–Õ';
create index ACC_ST.IDX_ST_NP_STS_EXCEPT_BALANCE on ACC_ST.ST_NP_STS_EXCEPT_BALANCE (BALANCE_WATER_NO)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_NP_STS_EXCEPT_BALANCE
  add constraint PK_ST_NP_STS_EXCEPT_BALANCE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_STS_EXCEPT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_EXCEPT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_EXCEPT_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_LCC
prompt ============================
prompt
create table ACC_ST.ST_NP_STS_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_LCC
  is 'ª•¡™Õ¯÷ß∏∂LCC∂‘’ÀÕ≥º∆±Ì';
comment on column ACC_ST.ST_NP_STS_LCC.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_LCC.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_LCC.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_LCC.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_LCC.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_LCC.charge_fee
  is '≥‰÷µ◊‹Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_LCC.charge_num
  is '≥‰÷µ◊‹ ˝¡ø';
comment on column ACC_ST.ST_NP_STS_LCC.sale_fee
  is '∑¢ €◊‹Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_LCC.sale_num
  is '∑¢ €◊‹ ˝¡ø';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_LCC to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_LCC to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_LCC_ACC
prompt ================================
prompt
create table ACC_ST.ST_NP_STS_LCC_ACC
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  diff_deal_num    NUMBER(18),
  diff_deal_fee    NUMBER(18,2),
  diff_sale_num    NUMBER(18),
  diff_sale_fee    NUMBER(18,2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_LCC_ACC
  is 'ª•¡™Õ¯÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.diff_deal_num
  is '≥‰÷µ ˝¡ø≤Ó“Ï';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.diff_deal_fee
  is '≥‰÷µΩ∂Ó≤Ó“Ï';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.diff_sale_num
  is '∑¢ € ˝¡ø≤Ó“Ï';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.diff_sale_fee
  is '∑¢ €Ω∂Ó≤Ó“Ï';
comment on column ACC_ST.ST_NP_STS_LCC_ACC.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_LCC_ACC to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_LCC_ACC to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_LCC_ACC to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_ORDER
prompt ==============================
prompt
create table ACC_ST.ST_NP_STS_ORDER
(
  water_no          NUMBER(10),
  order_type        CHAR(2),
  status            CHAR(2),
  squad_day         CHAR(8),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  order_num         NUMBER(18),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  balance_water_no  CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_ORDER
  is 'ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”¡–±Ì';
comment on column ACC_ST.ST_NP_STS_ORDER.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_ORDER.order_type
  is '∂©µ•¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER.status
  is '∂©µ•◊¥Ã¨';
comment on column ACC_ST.ST_NP_STS_ORDER.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_ORDER.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER.order_num
  is '∂©µ• ˝¡ø';
comment on column ACC_ST.ST_NP_STS_ORDER.deal_num
  is '’≈ ˝';
comment on column ACC_ST.ST_NP_STS_ORDER.deal_fee
  is '◊‹Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_ORDER.order_type_buy
  is '∂©µ•π∫∆±¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER.paid_channel_type
  is '÷ß∏∂«˛µ¿¿‡–Õ 01:“¯–– 02:“¯¡™ 03:µ⁄»˝∑Ω÷ß∏∂ 99:∆‰À˚';
comment on column ACC_ST.ST_NP_STS_ORDER.paid_channel_code
  is '÷ß∏∂«˛µ¿¥˙¬Î';
comment on column ACC_ST.ST_NP_STS_ORDER.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_ORDER to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_ORDER to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_ORDER to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_ORDER_IMP
prompt ==================================
prompt
create table ACC_ST.ST_NP_STS_ORDER_IMP
(
  water_no         NUMBER(18),
  order_type       CHAR(2),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  order_num        NUMBER(18),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_ORDER_IMP
  is 'ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”¡–±Ì';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.order_type
  is '∂©µ•¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.line_id
  is 'œﬂ¬∑¥˙¬Î';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.station_id
  is '’æµ„¥˙¬Î';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.dev_type_id
  is '…Ë±∏¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.dev_code
  is '…Ë±∏¥˙¬Î';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.status
  is '∂©µ•◊¥Ã¨';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.order_num
  is '∂©µ• ˝¡ø';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.deal_num
  is '≥ˆ∆± ˝¡ø';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.deal_num_not
  is 'Œ¥≥ˆ∆± ˝¡ø';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.deal_fee
  is '≥ˆ∆±Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.refund_fee
  is 'ÕÀøÓΩ∂Ó';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.auxi_fee
  is 'ÕÀøÓ ÷–¯∑—';
comment on column ACC_ST.ST_NP_STS_ORDER_IMP.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_ORDER_IMP to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_ORDER_IMP to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_STS_SALE
prompt =============================
prompt
create table ACC_ST.ST_NP_STS_SALE
(
  water_no         NUMBER(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sale_fee         NUMBER(18,2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deposit_type     CHAR(2),
  deposit_fee      NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  balance_water_no CHAR(10),
  card_app_flag    CHAR(1),
  order_no         VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_NP_STS_SALE
  is 'ª•¡™Õ¯÷ß∏∂∑¢ €Õ≥º∆±Ì';
comment on column ACC_ST.ST_NP_STS_SALE.water_no
  is '¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_SALE.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.ST_NP_STS_SALE.station_id
  is '≥µ’æID';
comment on column ACC_ST.ST_NP_STS_SALE.dev_type_id
  is '…Ë±∏¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_SALE.device_id
  is '…Ë±∏ID';
comment on column ACC_ST.ST_NP_STS_SALE.sale_fee
  is '∑¢ €Ω∂Ó';
comment on column ACC_ST.ST_NP_STS_SALE.card_main_id
  is '∆±ø®÷˜¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_SALE.card_sub_id
  is '∆±ø®◊”¿‡–ÕID';
comment on column ACC_ST.ST_NP_STS_SALE.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.ST_NP_STS_SALE.deposit_type
  is '—∫Ω¿‡–Õ 00:—∫Ω
01:≥…±æ
02:≤ª π”√
';
comment on column ACC_ST.ST_NP_STS_SALE.deposit_fee
  is '—∫ΩΩ∂Ó';
comment on column ACC_ST.ST_NP_STS_SALE.auxi_fee
  is ' ÷–¯∑—';
comment on column ACC_ST.ST_NP_STS_SALE.sale_num
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_NP_STS_SALE.balance_water_no
  is '∑¢ € ˝¡ø';
comment on column ACC_ST.ST_NP_STS_SALE.card_app_flag
  is 'ø®”¶”√±Í ∂0:∆’Õ®ø® 1:≤‚ ‘ø®';
comment on column ACC_ST.ST_NP_STS_SALE.order_no
  is '∂©µ•∫≈';
grant select, insert, update, delete on ACC_ST.ST_NP_STS_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_NP_STS_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_NP_STS_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_NP_TST_DEAL
prompt =============================
prompt
create table ACC_ST.ST_NP_TST_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_NP_TST_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_NP_TST_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_NP_TST_SALE
prompt =============================
prompt
create table ACC_ST.ST_NP_TST_SALE
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_NP_TST_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_NP_TST_SALE to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CRD000001
prompt ==============================
prompt
create table ACC_ST.ST_OD_CRD000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CRD000001
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CRD000001_1 on ACC_ST.ST_OD_CRD000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CRD000001_2 on ACC_ST.ST_OD_CRD000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CRD000001
  add constraint PK_ST_OD_CRD000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CRD000001 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CRD000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CRD000002
prompt ==============================
prompt
create table ACC_ST.ST_OD_CRD000002
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CRD000002
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CRD000002_1 on ACC_ST.ST_OD_CRD000002 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CRD000002_2 on ACC_ST.ST_OD_CRD000002 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CRD000002
  add constraint PK_ST_OD_CRD000002 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CRD000002 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CRD000002 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CRD000003
prompt ==============================
prompt
create table ACC_ST.ST_OD_CRD000003
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CRD000003
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CRD000003_1 on ACC_ST.ST_OD_CRD000003 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CRD000003_2 on ACC_ST.ST_OD_CRD000003 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CRD000003
  add constraint PK_ST_OD_CRD000003 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CRD000003 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CRD000003 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CRD000004
prompt ==============================
prompt
create table ACC_ST.ST_OD_CRD000004
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CRD000004
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CRD000004_1 on ACC_ST.ST_OD_CRD000004 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CRD000004_2 on ACC_ST.ST_OD_CRD000004 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CRD000004
  add constraint PK_ST_OD_CRD000004 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CRD000004 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CRD000004 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CRD000005
prompt ==============================
prompt
create table ACC_ST.ST_OD_CRD000005
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CRD000005
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CRD000005_1 on ACC_ST.ST_OD_CRD000005 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CRD000005_2 on ACC_ST.ST_OD_CRD000005 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CRD000005
  add constraint PK_ST_OD_CRD000005 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CRD000005 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CRD000005 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CRD000006
prompt ==============================
prompt
create table ACC_ST.ST_OD_CRD000006
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CRD000006
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CRD000006_1 on ACC_ST.ST_OD_CRD000006 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CRD000006_2 on ACC_ST.ST_OD_CRD000006 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CRD000006
  add constraint PK_ST_OD_CRD000006 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CRD000006 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CRD000006 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_CZO000001
prompt ==============================
prompt
create table ACC_ST.ST_OD_CZO000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  fare_zone        CHAR(5),
  person_num       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_CZO000001
  is '∆±÷÷«¯∂Œ∑÷≤ºÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_CZO000001_1 on ACC_ST.ST_OD_CZO000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_CZO000001_2 on ACC_ST.ST_OD_CZO000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_CZO000001
  add constraint PK_ST_OD_CZO000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_CZO000001 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_CZO000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_OD_LIN000001
prompt ==============================
prompt
create table ACC_ST.ST_OD_LIN000001
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  b_line_id        CHAR(2),
  e_line_id        CHAR(2),
  person_num       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_OD_LIN000001
  is 'œﬂ¬∑ODÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_OD_LIN000001_1 on ACC_ST.ST_OD_LIN000001 (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_OD_LIN000001_2 on ACC_ST.ST_OD_LIN000001 (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_OD_LIN000001
  add constraint PK_ST_OD_LIN000001 primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_OD_LIN000001 to ACC_ST_APP;
grant select on ACC_ST.ST_OD_LIN000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_PRM_OD_DISTANCE
prompt =================================
prompt
create table ACC_ST.ST_PRM_OD_DISTANCE
(
  version_no   CHAR(10) default 0000000000 not null,
  b_line_id    CHAR(2) not null,
  b_station_id CHAR(2) not null,
  e_line_id    CHAR(2) not null,
  e_station_id CHAR(2) not null,
  pass_line    CHAR(2) not null,
  pass_length  NUMBER(11,7) not null,
  record_flag  CHAR(1) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.OD_DISTANCE_IDX on ACC_ST.ST_PRM_OD_DISTANCE (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_PRM_OD_DISTANCE to ACC_ST_APP;
grant select on ACC_ST.ST_PRM_OD_DISTANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_PRM_OD_DISTANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_ADMIN
prompt ===========================
prompt
create table ACC_ST.ST_QUE_ADMIN
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  admin_datetime   DATE,
  admin_way_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  return_fee       NUMBER(18,2),
  penalty_fee      NUMBER(18,2),
  admin_reason_id  CHAR(2),
  describe         CHAR(30),
  passenger_name   CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_ADMIN to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_AGM_CARD_DATA
prompt ===================================
prompt
create table ACC_ST.ST_QUE_AGM_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  box_id           VARCHAR2(16),
  water_no_op      NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_AGM_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_AGM_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_AGM_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_AGM_CUTOFF_DTL
prompt ====================================
prompt
create table ACC_ST.ST_QUE_AGM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_AGM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_AGM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_AGM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_AGM_CUTOFF_TOTAL
prompt ======================================
prompt
create table ACC_ST.ST_QUE_AGM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  box_pop_num      NUMBER(18),
  total_num        NUMBER(18),
  total_fee        NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_AGM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_AGM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_AGM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_AUDIT
prompt ===========================
prompt
create table ACC_ST.ST_QUE_AUDIT
(
  file_type        CHAR(3),
  file_name        CHAR(20),
  file_size        INTEGER,
  line_id          CHAR(2),
  station_id       CHAR(2),
  open_time        CHAR(14),
  close_time       CHAR(14),
  serial_no        INTEGER,
  record_count     INTEGER,
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_QUE_AUDIT
  is 'Œƒº˛…Ûº∆∂”¡–±Ì';
grant select, insert, update, delete on ACC_ST.ST_QUE_AUDIT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_AUDIT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_AUDIT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT
prompt ===============================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT
(
  water_no            NUMBER(20) not null,
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  start_time          CHAR(14),
  end_time            CHAR(14),
  group_1_count       INTEGER,
  total_sale          CHAR(10),
  group_2_count       INTEGER,
  total_add           CHAR(10),
  group_3_count       INTEGER,
  total_cash_update   CHAR(10),
  total_update        CHAR(10),
  group_4_count       INTEGER,
  total_return_affair CHAR(10),
  total_affair        CHAR(10),
  group_5_count       INTEGER,
  group_6_count       INTEGER,
  total_return        CHAR(10),
  group_7_count       INTEGER,
  total_non_return    CHAR(10),
  group_8_count       INTEGER,
  group_9_count       INTEGER,
  total_chongzheng    CHAR(1),
  group_10_count      INTEGER,
  total_nocash        CHAR(10),
  total_cash          CHAR(10),
  balance_water_no    CHAR(10),
  file_name           CHAR(25)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
comment on table ACC_ST.ST_QUE_BOM_SHIFT
  is 'BOM∞‡¥Œ ˝æ›÷˜±Ì∂”¡–±Ì';
create index ACC_ST.IDX_ST_QUE_BOM_SHIFT on ACC_ST.ST_QUE_BOM_SHIFT (START_TIME)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
alter table ACC_ST.ST_QUE_BOM_SHIFT
  add constraint PK_ST_QUE_BOM_SHIFT primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_ADMIN
prompt =====================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_ADMIN
(
  water_no         NUMBER(18) not null,
  admin_way_id     CHAR(2),
  admin_reason_id  CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_ADMIN to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_CHARGE
prompt ======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_CHARGE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_CHARGE to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_CHARGE to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_CHARGE to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_CHG_UPD
prompt =======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_CHG_UPD
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_CHG_UPD to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_CHG_UPD to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_CHG_UPD to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_DELAY
prompt =====================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_DELAY
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_RETURN
prompt ======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_RETURN
(
  water_no           NUMBER(18) not null,
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  num                NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  return_type        CHAR(1),
  is_broken          CHAR(1),
  penalty_fee        NUMBER(18,2),
  penalty_reason     CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_RTN_APP
prompt =======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_RTN_APP
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_RTN_NON
prompt =======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_RTN_NON
(
  water_no           NUMBER(18) not null,
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  num                NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  return_type        CHAR(1),
  is_broken          CHAR(1),
  penalty_fee        NUMBER(18,2),
  penalty_reason     CHAR(2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_RTN_NON to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_RTN_NON to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_RTN_NON to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_SALE
prompt ====================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_SALE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_TOTAL
prompt =====================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_TOTAL
(
  water_no                 NUMBER(18) not null,
  line_id                  CHAR(2),
  station_id               CHAR(2),
  dev_type_id              CHAR(2),
  device_id                CHAR(3),
  operator_id              CHAR(6),
  shift_id                 CHAR(2),
  start_time               DATE,
  end_time                 DATE,
  sale_total_num           NUMBER(18),
  sale_total_fee           NUMBER(18,2),
  charge_total_num         NUMBER(18),
  charge_total_fee         NUMBER(18,2),
  update_total_num         NUMBER(18),
  update_total_fee         NUMBER(18,2),
  update_total_fee_cash    NUMBER(18,2),
  admin_total_num          NUMBER(18),
  admin_total_fee_return   NUMBER(18,2),
  admin_total_fee_income   NUMBER(18,2),
  delay_total_num          NUMBER(18),
  return_total_num         NUMBER(18),
  return_total_fee         NUMBER(18,2),
  return_non_total_num     NUMBER(18),
  return_non_total_fee     NUMBER(18,2),
  return_non_app_total_num NUMBER(18),
  charge_update_total_num  NUMBER(18),
  charge_update_total_fee  NUMBER(18,2),
  unlock_total_num         NUMBER(18),
  total_fee_nocash         NUMBER(18,2),
  total_fee_cash           NUMBER(18,2),
  balance_water_no         CHAR(10),
  file_name                VARCHAR2(30),
  check_flag               CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_UNLOCK
prompt ======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_UNLOCK
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_UNLOCK to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_UNLOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_UNLOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_BOM_SHIFT_UPDATE
prompt ======================================
prompt
create table ACC_ST.ST_QUE_BOM_SHIFT_UPDATE
(
  water_no         NUMBER(18) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  update_reason    CHAR(2),
  pay_type         CHAR(2),
  num              NUMBER(18),
  fee              NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_BOM_SHIFT_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_BOM_SHIFT_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_DEAL
prompt ==========================
prompt
create table ACC_ST.ST_QUE_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_QUE_DEAL on ACC_ST.ST_QUE_DEAL (CARD_MAIN_ID, CARD_SUB_ID, SAM_LOGICAL_ID, SAM_TRADE_SEQ, DEAL_DATETIME, DEAL_FEE, DEAL_BALANCE_FEE)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_DEAL_BANK
prompt ===============================
prompt
create table ACC_ST.ST_QUE_DEAL_BANK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_DEAL_BANK to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_DEAL_BANK to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_DEAL_BANK to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_DEAL_OCT
prompt ==============================
prompt
create table ACC_ST.ST_QUE_DEAL_OCT
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_DEAL_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_DEAL_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_DEAL_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_DELAY
prompt ===========================
prompt
create table ACC_ST.ST_QUE_DELAY
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  card_status_id      CHAR(3),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  operate_datetime    DATE,
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_ENTRY
prompt ===========================
prompt
create table ACC_ST.ST_QUE_ENTRY
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_QUE_ENTRY on ACC_ST.ST_QUE_ENTRY (CARD_MAIN_ID, CARD_SUB_ID, SAM_LOGICAL_ID, SAM_TRADE_SEQ, ENTRY_DATETIME, CARD_LOGICAL_ID)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_ENTRY to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_ENTRY to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_LCC
prompt =========================
prompt
create table ACC_ST.ST_QUE_LCC
(
  water_no                NUMBER(18),
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2),
  file_name               VARCHAR2(30),
  check_flag              CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_LCC to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_LCC to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_LCC to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_LOCK
prompt ==========================
prompt
create table ACC_ST.ST_QUE_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_LOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_LOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_NON_RTN_APP
prompt =================================
prompt
create table ACC_ST.ST_QUE_NON_RTN_APP
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_print_id    CHAR(16),
  apply_datetime   DATE,
  receipt_id       CHAR(4),
  operator_id      CHAR(6),
  apply_name       CHAR(8),
  tel_no           CHAR(12),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  is_broken        CHAR(2),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_NON_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_REG_DTL
prompt =============================
prompt
create table ACC_ST.ST_QUE_REG_DTL
(
  water_no         NUMBER(18) not null,
  data_code        NUMBER(18),
  data_value       NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_REG_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_REG_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_REG_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_REG_TOTAL
prompt ===============================
prompt
create table ACC_ST.ST_QUE_REG_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  commu_datetime   DATE,
  gen_datetime     DATE,
  total_num        NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_REG_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_REG_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_REG_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_REPORT_LOSS
prompt =================================
prompt
create table ACC_ST.ST_QUE_REPORT_LOSS
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  apply_name          CHAR(8),
  apply_sex           CHAR(1),
  identity_type       CHAR(1),
  identity_id         CHAR(18),
  expired_date        CHAR(8),
  tel_no              CHAR(16),
  fax                 CHAR(16),
  address             CHAR(30),
  operator_id         CHAR(6),
  apply_datetime      DATE,
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  apply_business_type CHAR(1),
  receipt_id          CHAR(4),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_QUE_REPORT_LOSS to ACC_ST_APP;

prompt
prompt Creating table ST_QUE_RETURN
prompt ============================
prompt
create table ACC_ST.ST_QUE_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_SALE
prompt ==========================
prompt
create table ACC_ST.ST_QUE_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_SALE_OCT
prompt ==============================
prompt
create table ACC_ST.ST_QUE_SALE_OCT
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 16K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_SALE_OCT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_SALE_OCT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_SALE_OCT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_SALE_SJT
prompt ==============================
prompt
create table ACC_ST.ST_QUE_SALE_SJT
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_QUE_SALE_SJT on ACC_ST.ST_QUE_SALE_SJT (CARD_MAIN_ID, CARD_SUB_ID, SAM_LOGICAL_ID, SAM_TRADE_SEQ, SALE_DATETIME)
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_SALE_SJT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_SIGN_CARD_APPLY
prompt =====================================
prompt
create table ACC_ST.ST_QUE_SIGN_CARD_APPLY
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_SIGN_CARD_APPLY to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_SIGN_CARD_APPLY to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_SIGN_CARD_APPLY to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_AUTO_BAL
prompt ==================================
prompt
create table ACC_ST.ST_QUE_TVM_AUTO_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_AUTO_BAL to ACC_ST_APP;

prompt
prompt Creating table ST_QUE_TVM_BAL
prompt =============================
prompt
create table ACC_ST.ST_QUE_TVM_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_BAL to ACC_ST_APP;

prompt
prompt Creating table ST_QUE_TVM_CARD_CLEAR
prompt ====================================
prompt
create table ACC_ST.ST_QUE_TVM_CARD_CLEAR
(
  water_no              NUMBER(18) not null,
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  operator_id           CHAR(6),
  clear_datetime        DATE,
  water_no_op           NUMBER(18),
  card_main_id_hopper_1 CHAR(2),
  card_sub_id_hopper_1  CHAR(2),
  card_main_id_hopper_2 CHAR(2),
  card_sub_id_hopper_2  CHAR(2),
  hopper_1_num          NUMBER(18),
  hopper_2_num          NUMBER(18),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_CARD_CLEAR to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_CARD_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_CARD_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_CARD_PUT
prompt ==================================
prompt
create table ACC_ST.ST_QUE_TVM_CARD_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  box_id           VARCHAR2(16),
  hopper_id        NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_CARD_PUT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_CARD_PUT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_CARD_PUT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_COIN_CLEAR
prompt ====================================
prompt
create table ACC_ST.ST_QUE_TVM_COIN_CLEAR
(
  water_no          NUMBER(18) not null,
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  coin_box_id       VARCHAR2(16),
  operator_id       CHAR(6),
  clear_datetime    DATE,
  water_no_op       NUMBER(18),
  hopper_1_unit_fee NUMBER(18,2),
  hopper_1_unit_num NUMBER(18),
  hopper_2_unit_fee NUMBER(18,2),
  hopper_2_unit_num NUMBER(18),
  coin_fee_1        NUMBER(18,2),
  coin_fee_2        NUMBER(18,2),
  coin_fee_3        NUMBER(18,2),
  coin_fee_4        NUMBER(18,2),
  coin_fee_5        NUMBER(18,2),
  coin_fee_6        NUMBER(18,2),
  coin_fee_7        NUMBER(18,2),
  coin_fee_8        NUMBER(18,2),
  coin_num_1        NUMBER(18),
  coin_num_2        NUMBER(18),
  coin_num_3        NUMBER(18),
  coin_num_4        NUMBER(18),
  coin_num_5        NUMBER(18),
  coin_num_6        NUMBER(18),
  coin_num_7        NUMBER(18),
  coin_num_8        NUMBER(18),
  coin_fee_total    NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_COIN_CLEAR to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_COIN_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_COIN_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_COIN_DATA
prompt ===================================
prompt
create table ACC_ST.ST_QUE_TVM_COIN_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  coin_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_fee_1       NUMBER(18,2),
  coin_fee_2       NUMBER(18,2),
  coin_fee_3       NUMBER(18,2),
  coin_fee_4       NUMBER(18,2),
  coin_fee_5       NUMBER(18,2),
  coin_fee_6       NUMBER(18,2),
  coin_fee_7       NUMBER(18,2),
  coin_fee_8       NUMBER(18,2),
  coin_num_1       NUMBER(18),
  coin_num_2       NUMBER(18),
  coin_num_3       NUMBER(18),
  coin_num_4       NUMBER(18),
  coin_num_5       NUMBER(18),
  coin_num_6       NUMBER(18),
  coin_num_7       NUMBER(18),
  coin_num_8       NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_COIN_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_COIN_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_COIN_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_COIN_PUT
prompt ==================================
prompt
create table ACC_ST.ST_QUE_TVM_COIN_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  hopper_id        NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_unit_fee    NUMBER(18,2),
  coin_num         NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_COIN_PUT to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_COIN_PUT to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_COIN_PUT to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_CUTOFF_DTL
prompt ====================================
prompt
create table ACC_ST.ST_QUE_TVM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_CUTOFF_TOTAL
prompt ======================================
prompt
create table ACC_ST.ST_QUE_TVM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  card_put_num     NUMBER(18),
  card_clear_num   NUMBER(18),
  coin_put_num     NUMBER(18),
  coin_put_fee     NUMBER(18,2),
  coin_clear_num   NUMBER(18),
  coin_clear_fee   NUMBER(18,2),
  coin_reclaim_num NUMBER(18),
  coin_reclaim_fee NUMBER(18,2),
  note_reclaim_num NUMBER(18),
  note_reclaim_fee NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_NOTE_CHG_POP
prompt ======================================
prompt
create table ACC_ST.ST_QUE_TVM_NOTE_CHG_POP
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_type      NUMBER(18),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  put_datetime       DATE,
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee           NUMBER(18,2),
  note_num_put       NUMBER(18),
  note_num_chg       NUMBER(18),
  note_num_bal       NUMBER(18),
  note_fee_total_put NUMBER(18,2),
  note_fee_total_chg NUMBER(18,2),
  note_fee_total_bal NUMBER(18,2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_NOTE_CHG_POP to ACC_ST_APP;

prompt
prompt Creating table ST_QUE_TVM_NOTE_CHG_PUT
prompt ======================================
prompt
create table ACC_ST.ST_QUE_TVM_NOTE_CHG_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_type    NUMBER(18),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee         NUMBER(18,2),
  note_num         NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_NOTE_CHG_PUT to ACC_ST_APP;

prompt
prompt Creating table ST_QUE_TVM_NOTE_DATA
prompt ===================================
prompt
create table ACC_ST.ST_QUE_TVM_NOTE_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee_1       NUMBER(18,2),
  note_fee_2       NUMBER(18,2),
  note_fee_3       NUMBER(18,2),
  note_fee_4       NUMBER(18,2),
  note_fee_5       NUMBER(18,2),
  note_fee_6       NUMBER(18,2),
  note_fee_7       NUMBER(18,2),
  note_fee_8       NUMBER(18,2),
  note_fee_9       NUMBER(18,2),
  note_fee_10      NUMBER(18,2),
  note_fee_11      NUMBER(18,2),
  note_fee_12      NUMBER(18,2),
  note_fee_13      NUMBER(18,2),
  note_num_1       NUMBER(18),
  note_num_2       NUMBER(18),
  note_num_3       NUMBER(18),
  note_num_4       NUMBER(18),
  note_num_5       NUMBER(18),
  note_num_6       NUMBER(18),
  note_num_7       NUMBER(18),
  note_num_8       NUMBER(18),
  note_num_9       NUMBER(18),
  note_num_10      NUMBER(18),
  note_num_11      NUMBER(18),
  note_num_12      NUMBER(18),
  note_num_13      NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_NOTE_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_NOTE_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_NOTE_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_TVM_NOTE_RECLAIM
prompt ======================================
prompt
create table ACC_ST.ST_QUE_TVM_NOTE_RECLAIM
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee_1         NUMBER(18,2),
  note_num_reclaim_1 NUMBER(18),
  note_fee_2         NUMBER(18,2),
  note_num_reclaim_2 NUMBER(18),
  note_fee_3         NUMBER(18,2),
  note_num_reclaim_3 NUMBER(18),
  note_fee_4         NUMBER(18,2),
  note_num_reclaim_4 NUMBER(18),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_NOTE_RECLAIM to ACC_ST_APP;

prompt
prompt Creating table ST_QUE_TVM_WASTE_CARD_DATA
prompt =========================================
prompt
create table ACC_ST.ST_QUE_TVM_WASTE_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  sjt_num          NUMBER(18),
  sjt_discount_num NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_TVM_WASTE_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_TVM_WASTE_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_TVM_WASTE_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table ST_QUE_UPDATE
prompt ============================
prompt
create table ACC_ST.ST_QUE_UPDATE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_consume_seq      NUMBER,
  card_status_id        CHAR(3),
  update_area           CHAR(1),
  update_reason_id      CHAR(2),
  update_datetime       DATE,
  pay_type              CHAR(2),
  penalty_fee           NUMBER(18,2),
  receipt_id            CHAR(4),
  operator_id           CHAR(6),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  shift_id              CHAR(2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  balance_fee           NUMBER(18,2),
  deal_no_discount_fee  NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_time            DATE,
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  card_app_flag         CHAR(1),
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_QUE_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_QUE_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_QUE_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_RLF_SEC000001
prompt ===============================
prompt
create table ACC_ST.ST_RLF_SEC000001
(
  time_section        CHAR(2),
  change_line_out_dir CHAR(1),
  b_station_id        CHAR(2),
  e_station_id        CHAR(2),
  num                 FLOAT,
  line_id             CHAR(2),
  balance_water_no    CHAR(10),
  squad_day           CHAR(8)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_RLF_SEC000001
  is '∂œ√ÊøÕ¡˜Õ≥º∆±Ì';
grant select, insert, update, delete on ACC_ST.ST_RLF_SEC000001 to ACC_ST_APP;
grant select on ACC_ST.ST_RLF_SEC000001 to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_ACC
prompt =========================
prompt
create table ACC_ST.ST_STS_ACC
(
  water_no                NUMBER(18),
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.ST_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_ACC to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_BALANCE_CONTC_INC
prompt =======================================
prompt
create table ACC_ST.ST_STS_BALANCE_CONTC_INC
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  contc_id         CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2),
  balance_ser_fee  NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_BALANCE_CONTC_INC
  is '‘À”™…ÃΩ·À„Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_OWNER_BALANCE on ACC_ST.ST_STS_BALANCE_CONTC_INC (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_BALANCE_CONTC_INC
  add constraint PK_ST_STS_OWNER_BALANCE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_BALANCE_CONTC_INC to ACC_ST_APP;
grant select on ACC_ST.ST_STS_BALANCE_CONTC_INC to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_BALANCE_CONTC_INC to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_BALANCE_CONTC_TRD
prompt =======================================
prompt
create table ACC_ST.ST_STS_BALANCE_CONTC_TRD
(
  water_no         NUMBER(20) not null,
  contc_id         CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_BALANCE_CONTC_TRD
  is 'Ωª“◊ ˝æ›Ω·À„Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_WORKING_DEAL_1 on ACC_ST.ST_STS_BALANCE_CONTC_TRD (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_WORKING_DEAL_2 on ACC_ST.ST_STS_BALANCE_CONTC_TRD (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_BALANCE_CONTC_TRD
  add constraint PK_ST_STS_WORKING_DEAL primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_BALANCE_CONTC_TRD to ACC_ST_APP;
grant select on ACC_ST.ST_STS_BALANCE_CONTC_TRD to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_BALANCE_CONTC_TRD to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_BALANCE_LINE_INC
prompt ======================================
prompt
create table ACC_ST.ST_STS_BALANCE_LINE_INC
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id_dispart  CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2),
  balance_ser_fee  NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_BALANCE_LINE_INC on ACC_ST.ST_STS_BALANCE_LINE_INC (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_BALANCE_LINE_INC
  add constraint PK_ST_BALANCE_LINE_INC primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_BALANCE_LINE_INC to ACC_ST_APP;
grant select on ACC_ST.ST_STS_BALANCE_LINE_INC to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_BALANCE_LINE_INC to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_BALANCE_LINE_TRD
prompt ======================================
prompt
create table ACC_ST.ST_STS_BALANCE_LINE_TRD
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id_dispart  CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_BALANCE_LINE_TRD
  is 'Ωª“◊ ˝æ›Ω·À„Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_BALANCE_LINE_TRD1 on ACC_ST.ST_STS_BALANCE_LINE_TRD (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_BALANCE_LINE_TRD2 on ACC_ST.ST_STS_BALANCE_LINE_TRD (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_BALANCE_LINE_TRD
  add constraint PK_ST_STS_BALANCE_LINE_TRD primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_BALANCE_LINE_TRD to ACC_ST_APP;
grant select on ACC_ST.ST_STS_BALANCE_LINE_TRD to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_BALANCE_LINE_TRD to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_CHANGE
prompt ============================
prompt
create table ACC_ST.ST_STS_CHANGE
(
  balance_water_no    CHAR(10) not null,
  b_line_id           CHAR(2) not null,
  b_station_id        CHAR(2) not null,
  e_line_id           CHAR(2) not null,
  e_station_id        CHAR(2) not null,
  change_out_line     CHAR(2),
  change_out_station  CHAR(2),
  change_in_line      CHAR(2),
  change_in_station   CHAR(2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  squad_day           CHAR(8),
  time_section_id     CHAR(2),
  deal_fee            NUMBER(18,2) not null,
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_in      CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in_dir  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.STS_CHANGE_IDX on ACC_ST.ST_STS_CHANGE (B_LINE_ID, B_STATION_ID, E_LINE_ID, E_STATION_ID)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_CHANGE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_CHANGE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_CHANGE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_CHANGE_INCOME
prompt ===================================
prompt
create table ACC_ST.ST_STS_CHANGE_INCOME
(
  balance_water_no    CHAR(10) not null,
  b_line_id           CHAR(2),
  b_station_id        CHAR(2),
  e_line_id           CHAR(2),
  e_station_id        CHAR(2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  squad_day           CHAR(8),
  time_section_id     CHAR(2),
  deal_fee            NUMBER(18,2) not null,
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_in      CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in_dir  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_CHANGE_INCOME to ACC_ST_APP;
grant select on ACC_ST.ST_STS_CHANGE_INCOME to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_CHANGE_INCOME to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_COLLECT_STATUS
prompt ====================================
prompt
create table ACC_ST.ST_STS_COLLECT_STATUS
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  file_name        CHAR(25),
  line_id          CHAR(2),
  station_id       CHAR(2),
  file_type        CHAR(3),
  record_num       INTEGER
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_COLLECT_STATUS
  is '≤…ºØ…Ûº∆Õ≥º∆±Ì';
alter table ACC_ST.ST_STS_COLLECT_STATUS
  add constraint PK_ST_STS_COLLECT_STATUS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_COLLECT_STATUS to ACC_ST_APP;
grant select on ACC_ST.ST_STS_COLLECT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_COLLECT_STATUS to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_CUSTOM_DISTANCE
prompt =====================================
prompt
create table ACC_ST.ST_STS_CUSTOM_DISTANCE
(
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  b_line_id        CHAR(2),
  e_line_id        CHAR(2),
  p_line_id        CHAR(2),
  pass_length      FLOAT,
  distance_num     NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_CUSTOM_DISTANCE
  is 'œﬂ¬∑∆Ωæ˘‘Àæ‡Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_SND_CUSTOM_DIS_1 on ACC_ST.ST_STS_CUSTOM_DISTANCE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_SND_CUSTOM_DIS_2 on ACC_ST.ST_STS_CUSTOM_DISTANCE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_CUSTOM_DISTANCE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_CUSTOM_DISTANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_CUSTOM_DISTANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_DEAL_SVT
prompt ==============================
prompt
create table ACC_ST.ST_STS_DEAL_SVT
(
  balance_water_no CHAR(10),
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) not null,
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20) not null,
  charge_num       NUMBER(18),
  consume_num      NUMBER(18),
  charge_fee       NUMBER(18,2),
  consume_fee      NUMBER(18,2),
  card_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(10),
  card_consume_seq NUMBER(10),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_DEAL_SVT to ACC_ST_APP;
grant select on ACC_ST.ST_STS_DEAL_SVT to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_DEAL_SVT to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_DIFF_ANALYSIS
prompt ===================================
prompt
create table ACC_ST.ST_STS_DIFF_ANALYSIS
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  out_deal_type    CHAR(2),
  acc_send_num     NUMBER(18),
  acc_send_fee     NUMBER(18,2),
  out_affirm_num   NUMBER,
  out_affirm_fee   NUMBER(18,2),
  error_id         CHAR(2),
  error_num        NUMBER,
  error_fee        NUMBER(18,2),
  sys_type         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_DIFF_ANALYSIS
  is '«ÂÀ„Ω·π˚≤Ó“ÏÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_DIFF_ANALYSIS on ACC_ST.ST_STS_DIFF_ANALYSIS (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_DIFF_ANALYSIS
  add constraint PK_ST_STS_DIFF_ANALYSIS primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_DIFF_ANALYSIS to ACC_ST_APP;
grant select on ACC_ST.ST_STS_DIFF_ANALYSIS to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_DIFF_ANALYSIS to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_DISPART_CONTC
prompt ===================================
prompt
create table ACC_ST.ST_STS_DISPART_CONTC
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  contc_id         CHAR(2),
  line_id          CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_DISPART_CONTC
  is '‘À”™…Ã∑÷’ Ω·π˚Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_WORKING_DISPART_1 on ACC_ST.ST_STS_DISPART_CONTC (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_DISPART_CONTC to ACC_ST_APP;
grant select on ACC_ST.ST_STS_DISPART_CONTC to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_DISPART_CONTC to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_DISPART_LINE
prompt ==================================
prompt
create table ACC_ST.ST_STS_DISPART_LINE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id_dispart  CHAR(2),
  line_id          CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_DISPART_LINE
  is '‘À”™…Ã∑÷’ Ω·π˚Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_WORKING_DISPART_12 on ACC_ST.ST_STS_DISPART_LINE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_DISPART_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_DISPART_LINE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_DISPART_LINE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_EXCEPT_BALANCE
prompt ====================================
prompt
create table ACC_ST.ST_STS_EXCEPT_BALANCE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  tr_type_id       CHAR(2),
  error_id         CHAR(2),
  deal_num         NUMBER(18),
  sys_type         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_EXCEPT_BALANCE
  is '“Ï≥£Ωª“◊Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_EXCEPT_BALANCE on ACC_ST.ST_STS_EXCEPT_BALANCE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_EXCEPT_BALANCE
  add constraint PK_ST_STS_EXCEPT_BALANCE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_EXCEPT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_EXCEPT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_EXCEPT_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_FLW_AVERAGE_DISTANCE
prompt ==========================================
prompt
create table ACC_ST.ST_STS_FLW_AVERAGE_DISTANCE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  distance_num     NUMBER(18,2),
  total_distance   NUMBER(18,2),
  pass_line        CHAR(2),
  begin_line       CHAR(2),
  end_line         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_AVERAGE_DISTANCE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_AVERAGE_DISTANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_FLW_AVERAGE_DISTANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_FLW_AVERAGE_DIS_BAK
prompt =========================================
prompt
create table ACC_ST.ST_STS_FLW_AVERAGE_DIS_BAK
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  distance_num     NUMBER(18,2),
  total_distance   NUMBER(18,2),
  pass_line        CHAR(2),
  begin_line       CHAR(2),
  end_line         CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_FLW_AVERAGE_DIS_BAK
  is '∆Ωæ˘≥Àæ‡Õ≥º∆±®±ÌBAK';
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_AVERAGE_DIS_BAK to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_AVERAGE_DIS_BAK to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_FLW_CHANGE
prompt ================================
prompt
create table ACC_ST.ST_STS_FLW_CHANGE
(
  num                 INTEGER not null,
  squad_day           CHAR(8) not null,
  balance_water_no    CHAR(10) not null,
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  change_line         CHAR(2),
  change_station      CHAR(2),
  change_line_out     CHAR(2),
  change_line_in      CHAR(2),
  change_line_out_dir CHAR(1),
  change_line_in_dir  CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_CHANGE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_CHANGE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_FLW_CHANGE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_FLW_LINE_CARD
prompt ===================================
prompt
create table ACC_ST.ST_STS_FLW_LINE_CARD
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  entry_num        NUMBER(18),
  export_num       NUMBER(18),
  station_id       CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_FLW_LINE_CARD
  is 'œﬂ¬∑∆±÷÷øÕ¡˜Õ≥º∆±Ì';
alter table ACC_ST.ST_STS_FLW_LINE_CARD
  add constraint PK_ST_STS_LINE_CUSTOM primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_LINE_CARD to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_LINE_CARD to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_FLW_LINE_CARD to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_FLW_LINE_PASS
prompt ===================================
prompt
create table ACC_ST.ST_STS_FLW_LINE_PASS
(
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  b_line_id        CHAR(2),
  p_line_id        CHAR(2),
  num              NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  time_section_id  CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_FLW_LINE_PASS
  is 'Õææ≠œﬂ¬∑∆±÷÷Õ≥º∆±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_LINE_PASS to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_LINE_PASS to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_FLW_LINE_PASS to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_FLW_LINE_PASS_BAK
prompt =======================================
prompt
create table ACC_ST.ST_STS_FLW_LINE_PASS_BAK
(
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  b_line_id        CHAR(2),
  p_line_id        CHAR(2),
  num              NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  time_section_id  CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_FLW_LINE_PASS_BAK
  is 'Õææ≠œﬂ¬∑∆±÷÷Õ≥º∆±ÌBAK';
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_LINE_PASS_BAK to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_LINE_PASS_BAK to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_FLW_STATION
prompt =================================
prompt
create table ACC_ST.ST_STS_FLW_STATION
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  entry_num        CHAR(5),
  export_num       NUMBER(18),
  time_section_id  CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_FLW_STATION to ACC_ST_APP;
grant select on ACC_ST.ST_STS_FLW_STATION to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_FLW_STATION to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INCOME_CONTC_CARD
prompt =======================================
prompt
create table ACC_ST.ST_STS_INCOME_CONTC_CARD
(
  water_no         NUMBER(20) not null,
  contc_id         CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INCOME_CONTC_CARD
  is '‘À”™…Ã ’»ÎÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_WORKING_INCOME_1 on ACC_ST.ST_STS_INCOME_CONTC_CARD (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_WORKING_INCOME_2 on ACC_ST.ST_STS_INCOME_CONTC_CARD (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INCOME_CONTC_CARD
  add constraint PK_ST_STS_WORKING_INCOME primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INCOME_CONTC_CARD to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INCOME_CONTC_CARD to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INCOME_CONTC_CARD to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INCOME_CONTC_CARD_MODE
prompt ============================================
prompt
create table ACC_ST.ST_STS_INCOME_CONTC_CARD_MODE
(
  water_no         NUMBER(20) not null,
  contc_id         CHAR(2),
  belong_line_id   CHAR(2),
  belong_contc_id  CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(12,2),
  deal_fee         NUMBER(15,2),
  deposit_type     CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INCOME_CONTC_CARD_MODE
  is '‘À”™…Ã∆±ø®¿‡–ÕΩª“◊±Ì';
comment on column ACC_ST.ST_STS_INCOME_CONTC_CARD_MODE.deposit_type
  is ' «∑Ò‘ –ÌÕÀ—∫Ω0:Ω˚÷π,1:‘ –Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_INCOME_CONTC_CARD_MODE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INCOME_CONTC_CARD_MODE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INCOME_CONTC_CARD_MODE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_BALANCE
prompt =================================
prompt
create table ACC_ST.ST_STS_INC_BALANCE
(
  water_no          NUMBER(20) not null,
  balance_water_no  CHAR(10),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  total_num         NUMBER(18),
  total_bal_fee     NUMBER(18,2),
  total_deposit_fee NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_BALANCE
  is '≥µ∆±∑¢ €Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_INC_BALANCE_1 on ACC_ST.ST_STS_INC_BALANCE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_BALANCE
  add constraint PK_ST_STS_INC_BALANCE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_BALANCE_EXPIRED
prompt =========================================
prompt
create table ACC_ST.ST_STS_INC_BALANCE_EXPIRED
(
  water_no          NUMBER(20) not null,
  balance_water_no  CHAR(10),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  total_num         NUMBER(18),
  total_bal_fee     NUMBER(18,2),
  total_deposit_fee NUMBER(18,2),
  squad_day         CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_BALANCE_EXPIRED
  is 'π˝∆⁄∆±”‡∂ÓÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_TICKET_DELAY_1 on ACC_ST.ST_STS_INC_BALANCE_EXPIRED (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_BALANCE_EXPIRED
  add constraint PK_ST_STS_TICKET_DELAY primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_BALANCE_EXPIRED to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_BALANCE_EXPIRED to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_BALANCE_EXPIRED to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_CHARGE
prompt ================================
prompt
create table ACC_ST.ST_STS_INC_CHARGE
(
  water_no         NUMBER(18) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  charge_num       NUMBER(18),
  charge_fee       NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_INC_CHARGE_1 on ACC_ST.ST_STS_INC_CHARGE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_INC_CHARGE_2 on ACC_ST.ST_STS_INC_CHARGE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_CHARGE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_CHARGE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_CHARGE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_CONSUME
prompt =================================
prompt
create table ACC_ST.ST_STS_INC_CONSUME
(
  water_no             NUMBER(18) not null,
  balance_water_no     CHAR(10),
  line_id              CHAR(2),
  station_id           CHAR(2),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  squad_day            CHAR(8),
  deal_num             NUMBER(18),
  deal_fee             NUMBER(18,2),
  deal_no_discount_fee NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_INC_CONSUME_1 on ACC_ST.ST_STS_INC_CONSUME (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_INC_CONSUME_2 on ACC_ST.ST_STS_INC_CONSUME (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_CONSUME
  add primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_CONSUME to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_CONSUME to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_CONSUME to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_FARE
prompt ==============================
prompt
create table ACC_ST.ST_STS_INC_FARE
(
  water_no          NUMBER(20) not null,
  balance_water_no  CHAR(10),
  squad_day         CHAR(8),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  pay_type          CHAR(2),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  sale_fee          NUMBER(18,2),
  sale_num          NUMBER(18),
  total_deposit_fee NUMBER(18,2),
  total_sale_fee    NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_FARE
  is 'TVM∑¢ €µ•≥Ã∆± ˝¡øÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_INC_SALE_SJT_TVM_1 on ACC_ST.ST_STS_INC_FARE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_INC_SALE_SJT_TVM_2 on ACC_ST.ST_STS_INC_FARE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_FARE
  add constraint PK_ST_STS_INC_SALE_SJT_TVM primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_FARE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_FARE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_FARE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_RETURN
prompt ================================
prompt
create table ACC_ST.ST_STS_INC_RETURN
(
  water_no           NUMBER(20) not null,
  balance_water_no   CHAR(10),
  line_id            CHAR(2),
  station_id         CHAR(2),
  return_type        CHAR(1),
  squad_day          CHAR(8),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  return_num         NUMBER(18),
  return_deposit_fee NUMBER(18,2),
  bad_num            NUMBER(18),
  return_balance_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_RETURN
  is '≥µ∆±ÕÀøÓÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_TICKET_RETURN_1 on ACC_ST.ST_STS_INC_RETURN (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_TICKET_RETURN_2 on ACC_ST.ST_STS_INC_RETURN (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_RETURN
  add constraint PK_ST_STS_TICKET_RETURN primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_SALE
prompt ==============================
prompt
create table ACC_ST.ST_STS_INC_SALE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  pay_type         CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  sale_num         NUMBER(18),
  deposit_fee      NUMBER(18,2),
  charge_fee       NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_SALE
  is '≥µ∆±∑¢ €Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_TICKET_SALE_1 on ACC_ST.ST_STS_INC_SALE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_TICKET_SALE_2 on ACC_ST.ST_STS_INC_SALE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_SALE
  add constraint PK_ST_STS_TICKET_SALE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_STATION
prompt =================================
prompt
create table ACC_ST.ST_STS_INC_STATION
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  do_type          CHAR(2),
  operator_id      CHAR(6),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  dev_type_id      CHAR(2),
  deal_fee         NUMBER(18,2),
  return_balance   NUMBER(18,2),
  deal_num         NUMBER(18),
  shift_id         CHAR(2),
  device_id        CHAR(4),
  penalty_fee      NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_STATION
  is '≥µ’æ ’“ÊÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_BOM_GET_1 on ACC_ST.ST_STS_INC_STATION (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_BOM_GET_2 on ACC_ST.ST_STS_INC_STATION (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_STATION
  add constraint PK_ST_STS_BOM_GET primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_STATION to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_STATION to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_STATION to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_INC_UPDATE
prompt ================================
prompt
create table ACC_ST.ST_STS_INC_UPDATE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  pay_type         CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  update_num       NUMBER(18),
  update_fee       NUMBER(18,2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_INC_UPDATE
  is '≥µ∆±∏¸–¬Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_TICKET_UPDATE_1 on ACC_ST.ST_STS_INC_UPDATE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_TICKET_UPDATE_2 on ACC_ST.ST_STS_INC_UPDATE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_INC_UPDATE
  add constraint PK_ST_STS_TICKET_UPDATE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_INC_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_INC_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_INC_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_LCC_ACC
prompt =============================
prompt
create table ACC_ST.ST_STS_LCC_ACC
(
  water_no                     NUMBER(18),
  balance_water_no             CHAR(10),
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  diff_bom_sale_sjt_num        NUMBER(18),
  diff_bom_sale_sjt_fee        NUMBER(18,2),
  diff_tvm_sale_sjt_num        NUMBER(18),
  diff_tvm_sale_sjt_fee        NUMBER(18,2),
  diff_bom_sale_num            NUMBER(18),
  diff_bom_sale_deposit_fee    NUMBER(18,2),
  diff_bom_charge_fee          NUMBER(18,2),
  diff_tvm_charge_num          NUMBER(18),
  diff_tvm_charge_fee          NUMBER(18,2),
  diff_return_num              NUMBER(18),
  diff_return_fee              NUMBER(18,2),
  diff_non_return_num          NUMBER(18),
  diff_non_ret_deposit_fee     NUMBER(18,2),
  diff_non_ret_actual_ret_bala NUMBER(18,2),
  diff_negative_charge_num     NUMBER(18),
  diff_negative_charge_fee     NUMBER(18,2),
  diff_deal_num                NUMBER(18),
  diff_deal_fee                NUMBER(18,2),
  diff_update_cash_num         NUMBER(18),
  diff_update_cash_fee         NUMBER(18,2),
  diff_update_noncash_num      NUMBER(18),
  diff_update_noncash_fee      NUMBER(18,2),
  diff_admin_num               NUMBER(18),
  diff_admin_return_fee        NUMBER(18,2),
  diff_admin_penalty_fee       NUMBER(18,2),
  account_date                 CHAR(8)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_LCC_ACC to ACC_ST_APP;
grant select on ACC_ST.ST_STS_LCC_ACC to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_LCC_ACC to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_MTR_AUDIT_BALANCE
prompt =======================================
prompt
create table ACC_ST.ST_STS_MTR_AUDIT_BALANCE
(
  water_no         NUMBER(18),
  sam_logical_id   CHAR(20),
  pay_mode_id      CHAR(2),
  total_deal_num   NUMBER(18),
  total_deal_fee   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_MTR_AUDIT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_MTR_AUDIT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_MTR_AUDIT_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_OD_CARD
prompt =============================
prompt
create table ACC_ST.ST_STS_OD_CARD
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  person_num       NUMBER(18),
  time_section_id  CHAR(2) not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_OD_CARD
  is 'ODøÕ¡˜Õ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_CARD_OD_1 on ACC_ST.ST_STS_OD_CARD (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_CARD_OD_2 on ACC_ST.ST_STS_OD_CARD (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_OD_CARD
  add constraint PK_ST_STS_CARD_OD primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_OD_CARD to ACC_ST_APP;
grant select on ACC_ST.ST_STS_OD_CARD to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_OD_CARD to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_OD_CARD_ZONE
prompt ==================================
prompt
create table ACC_ST.ST_STS_OD_CARD_ZONE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  fare_zone        CHAR(5),
  person_num       NUMBER(18),
  line_id          CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_OD_CARD_ZONE
  is '∆±÷÷«¯∂Œ∑÷≤ºÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_CARD_ZONE_1 on ACC_ST.ST_STS_OD_CARD_ZONE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_CARD_ZONE_2 on ACC_ST.ST_STS_OD_CARD_ZONE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_OD_CARD_ZONE
  add constraint PK_ST_STS_CARD_ZONE primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_OD_CARD_ZONE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_OD_CARD_ZONE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_OD_CARD_ZONE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_OD_LINE
prompt =============================
prompt
create table ACC_ST.ST_STS_OD_LINE
(
  water_no         NUMBER(20) not null,
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  b_line_id        CHAR(2),
  e_line_id        CHAR(2),
  person_num       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_OD_LINE
  is 'œﬂ¬∑ODÕ≥º∆±Ì';
create index ACC_ST.IDX_ST_STS_LINE_OD_1 on ACC_ST.ST_STS_OD_LINE (BALANCE_WATER_NO)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
create index ACC_ST.IDX_ST_STS_LINE_OD_2 on ACC_ST.ST_STS_OD_LINE (SQUAD_DAY)
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_STS_OD_LINE
  add constraint PK_ST_STS_LINE_OD primary key (WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_OD_LINE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_OD_LINE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_OD_LINE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_REALFLOW_SECTION
prompt ======================================
prompt
create table ACC_ST.ST_STS_REALFLOW_SECTION
(
  time_section        CHAR(2),
  change_line_out_dir CHAR(1),
  b_station_id        CHAR(2),
  e_station_id        CHAR(2),
  num                 FLOAT,
  line_id             CHAR(2),
  balance_water_no    CHAR(10),
  squad_day           CHAR(8)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_REALFLOW_SECTION
  is '∂œ√ÊøÕ¡˜Õ≥º∆±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_REALFLOW_SECTION to ACC_ST_APP;
grant select on ACC_ST.ST_STS_REALFLOW_SECTION to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_REALFLOW_SECTION to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_REALFLOW_SECTION_BAK
prompt ==========================================
prompt
create table ACC_ST.ST_STS_REALFLOW_SECTION_BAK
(
  time_section        CHAR(2),
  change_line_out_dir CHAR(1),
  b_station_id        CHAR(2),
  e_station_id        CHAR(2),
  num                 FLOAT,
  line_id             CHAR(2),
  balance_water_no    CHAR(10),
  squad_day           CHAR(8)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_REALFLOW_SECTION_BAK
  is '∂œ√ÊøÕ¡˜Õ≥º∆±ÌBAK';
grant select, insert, update, delete on ACC_ST.ST_STS_REALFLOW_SECTION_BAK to ACC_ST_APP;
grant select on ACC_ST.ST_STS_REALFLOW_SECTION_BAK to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_REG_BOM
prompt =============================
prompt
create table ACC_ST.ST_STS_REG_BOM
(
  water_no         NUMBER(20),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  data_code        CHAR(3),
  deal_value       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_REG_BOM
  is 'ºƒ¥Ê∆˜bomÕ≥º∆±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_REG_BOM to ACC_ST_APP;
grant select on ACC_ST.ST_STS_REG_BOM to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_REG_BOM to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_REG_GATE
prompt ==============================
prompt
create table ACC_ST.ST_STS_REG_GATE
(
  water_no         NUMBER(20),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  data_code        CHAR(3),
  deal_value       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_REG_GATE
  is 'ºƒ¥Ê∆˜’¢ª˙Õ≥º∆±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_REG_GATE to ACC_ST_APP;
grant select on ACC_ST.ST_STS_REG_GATE to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_REG_GATE to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_REG_TVM
prompt =============================
prompt
create table ACC_ST.ST_STS_REG_TVM
(
  water_no         NUMBER(20),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  data_code        CHAR(3),
  deal_value       NUMBER(18)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_REG_TVM
  is 'ºƒ¥Ê∆˜TVMÕ≥º∆±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_REG_TVM to ACC_ST_APP;
grant select on ACC_ST.ST_STS_REG_TVM to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_REG_TVM to ACC_ST_RPT;

prompt
prompt Creating table ST_STS_SALE_HUNCH
prompt ================================
prompt
create table ACC_ST.ST_STS_SALE_HUNCH
(
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  deal_datetime    DATE,
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_SALE_HUNCH
  is '¥¢÷µø®¬ﬂº≠ø®∫≈∑¢ €‘§∏≥÷µº«¬º';
comment on column ACC_ST.ST_STS_SALE_HUNCH.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.ST_STS_SALE_HUNCH.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.ST_STS_SALE_HUNCH.card_logical_id
  is '¬ﬂº≠ø®∫≈';
comment on column ACC_ST.ST_STS_SALE_HUNCH.card_physical_id
  is 'ŒÔ¿Ìø®∫≈';
comment on column ACC_ST.ST_STS_SALE_HUNCH.deal_datetime
  is 'Ωª“◊ ±º‰';
comment on column ACC_ST.ST_STS_SALE_HUNCH.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.ST_STS_SALE_HUNCH to ACC_ST_APP;
grant select on ACC_ST.ST_STS_SALE_HUNCH to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_SALE_HUNCH_ERR
prompt ====================================
prompt
create table ACC_ST.ST_STS_SALE_HUNCH_ERR
(
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  hdl_time            DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_SALE_HUNCH_ERR
  is '“Ï≥£œ˚∑—º«¬º±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_SALE_HUNCH_ERR to ACC_ST_APP;
grant select on ACC_ST.ST_STS_SALE_HUNCH_ERR to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_SETTLE_SVT_DEAL
prompt =====================================
prompt
create table ACC_ST.ST_STS_SETTLE_SVT_DEAL
(
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  hdl_time            DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_SETTLE_SVT_DEAL
  is '”‡∂Ó∆Ω∫‚Õ≥º∆±∏∑›±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_SETTLE_SVT_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_STS_SETTLE_SVT_DEAL to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_SVT_DEAL_ERR
prompt ==================================
prompt
create table ACC_ST.ST_STS_SVT_DEAL_ERR
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  device_id            CHAR(3),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  deal_datetime        DATE,
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  card_physical_id     CHAR(20),
  deal_fee             NUMBER(18,2),
  deal_balance_fee     NUMBER(18,2),
  card_charge_seq      NUMBER(18),
  card_consume_seq     NUMBER(18),
  pay_mode_id          CHAR(2),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_datetime       DATE,
  deal_no_discount_fee NUMBER(18,2),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_STS_SVT_DEAL_ERR to ACC_ST_APP;
grant select on ACC_ST.ST_STS_SVT_DEAL_ERR to ACC_ST_DEV;

prompt
prompt Creating table ST_STS_SVT_DEAL_OLD
prompt ==================================
prompt
create table ACC_ST.ST_STS_SVT_DEAL_OLD
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  device_id            CHAR(3),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  deal_datetime        DATE,
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  card_physical_id     CHAR(20),
  deal_fee             NUMBER(18,2),
  deal_balance_fee     NUMBER(18,2),
  card_charge_seq      NUMBER(18),
  card_consume_seq     NUMBER(18),
  pay_mode_id          CHAR(2),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_datetime       DATE,
  deal_no_discount_fee NUMBER(18,2),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_STS_SVT_DEAL_OLD
  is 'æ…ø®Ωª“◊º«¬º±Ì';
grant select, insert, update, delete on ACC_ST.ST_STS_SVT_DEAL_OLD to ACC_ST_APP;
grant select on ACC_ST.ST_STS_SVT_DEAL_OLD to ACC_ST_DEV;
grant select on ACC_ST.ST_STS_SVT_DEAL_OLD to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_CFG_TEMP_FILE_CLEAR
prompt =========================================
prompt
create table ACC_ST.ST_SYS_CFG_TEMP_FILE_CLEAR
(
  id           INTEGER not null,
  clear_type   INTEGER not null,
  path_clear   VARCHAR2(200) not null,
  reserve_days INTEGER not null,
  remark       VARCHAR2(200)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_CFG_TEMP_FILE_CLEAR to ACC_ST_APP;

prompt
prompt Creating table ST_SYS_CFG_TIMER
prompt ===============================
prompt
create table ACC_ST.ST_SYS_CFG_TIMER
(
  timer_id     CHAR(2) not null,
  run_year     VARCHAR2(100) not null,
  run_month    VARCHAR2(100) not null,
  run_date     VARCHAR2(100) not null,
  run_hour     VARCHAR2(100) not null,
  run_minute   VARCHAR2(100) not null,
  control_flag VARCHAR2(1) not null,
  remark       VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_CFG_TIMER
  add constraint ST_SYS_CFG_TIMER_PK primary key (TIMER_ID)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_CFG_TIMER to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_CFG_TIMER to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_CFG_TIMER to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_CFG_TIMER_CLEAR
prompt =====================================
prompt
create table ACC_ST.ST_SYS_CFG_TIMER_CLEAR
(
  timer_id     VARCHAR2(20) not null,
  run_year     VARCHAR2(100) not null,
  run_month    VARCHAR2(100) not null,
  run_date     VARCHAR2(100) not null,
  run_hour     VARCHAR2(100) not null,
  run_minute   VARCHAR2(100) not null,
  control_flag VARCHAR2(1) not null,
  remark       VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_CFG_TIMER_CLEAR to ACC_ST_APP;

prompt
prompt Creating table ST_SYS_CHK_CARD_MAIN
prompt ===================================
prompt
create table ACC_ST.ST_SYS_CHK_CARD_MAIN
(
  card_main_id   CHAR(2) not null,
  card_main_name VARCHAR2(30),
  card_tac_type  VARCHAR2(1) not null,
  remark         VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_CHK_CARD_MAIN
  add constraint ST_SYS_CHK_CARD_MAIN_PK primary key (CARD_MAIN_ID)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_CHK_CARD_MAIN to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.ST_SYS_CHK_CARD_MAIN to ACC_ST_DEV;

prompt
prompt Creating table ST_SYS_CHK_CTR
prompt =============================
prompt
create table ACC_ST.ST_SYS_CHK_CTR
(
  chk_id         VARCHAR2(3) not null,
  valid_flag     VARCHAR2(1) not null,
  app_trade_type VARCHAR2(20) not null,
  remark         VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_CHK_CTR
  add constraint ST_SYS_CHK_CTR_PK primary key (CHK_ID, APP_TRADE_TYPE, VALID_FLAG)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_CHK_CTR to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_CHK_CTR to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_CHK_CTR to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_CHK_LIMIT
prompt ===============================
prompt
create table ACC_ST.ST_SYS_CHK_LIMIT
(
  chk_id    VARCHAR2(3) not null,
  chk_key   VARCHAR2(100) not null,
  chk_value VARCHAR2(100) not null,
  remark    VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_CHK_LIMIT
  add constraint ST_SYS_CHK_LIMIT_PK primary key (CHK_ID, CHK_KEY)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_CHK_LIMIT to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_CHK_LIMIT to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_CHK_LIMIT to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_FLOW_CURRENT
prompt ==================================
prompt
create table ACC_ST.ST_SYS_FLOW_CURRENT
(
  balance_water_no CHAR(10) not null,
  step             CHAR(2) not null,
  step_pre         CHAR(2),
  finish_flag      CHAR(1),
  error_code       CHAR(2),
  begin_time       DATE,
  end_time         DATE,
  operator_id      CHAR(6),
  remark           VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_CURRENT to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_FLOW_CURRENT to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_FLOW_CURRENT to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_FLOW_HIS
prompt ==============================
prompt
create table ACC_ST.ST_SYS_FLOW_HIS
(
  balance_water_no CHAR(10) not null,
  step             CHAR(2) not null,
  step_pre         CHAR(2),
  finish_flag      CHAR(1),
  error_code       CHAR(2),
  begin_time       DATE,
  end_time         DATE,
  operator_id      CHAR(6),
  remark           VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_HIS to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_FLOW_HIS to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_FLOW_HIS to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_FLOW_MANU
prompt ===============================
prompt
create table ACC_ST.ST_SYS_FLOW_MANU
(
  balance_water_no CHAR(10) not null,
  finish_flag      CHAR(1),
  remark           VARCHAR2(50)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_FLOW_MANU
  add constraint PK_ST_SYS_FLOW_MANU primary key (BALANCE_WATER_NO)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_MANU to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_FLOW_MANU to ACC_ST_DEV;

prompt
prompt Creating table ST_SYS_FLOW_OCT_IMPORT_CTR
prompt =========================================
prompt
create table ACC_ST.ST_SYS_FLOW_OCT_IMPORT_CTR
(
  balance_water_no CHAR(10) not null,
  file_type        CHAR(2) not null,
  set_datetime     DATE not null,
  set_type         CHAR(1) not null,
  remark           VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_FLOW_OCT_IMPORT_CTR
  add constraint ST_SYS_FLOW_OCT_IMPORT_CTR_PK primary key (BALANCE_WATER_NO, FILE_TYPE)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_OCT_IMPORT_CTR to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_FLOW_OCT_IMPORT_CTR to ACC_ST_DEV;

prompt
prompt Creating table ST_SYS_FLOW_REPORT
prompt =================================
prompt
create table ACC_ST.ST_SYS_FLOW_REPORT
(
  balance_water_no CHAR(10) not null,
  finish_flag      VARCHAR2(1) not null,
  start_datetime   DATE,
  end_datetime     DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_SYS_FLOW_REPORT
  add constraint ST_SYS_FLOW_REPORT_PK primary key (BALANCE_WATER_NO)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_REPORT to ACC_ST_APP;
grant select, update on ACC_ST.ST_SYS_FLOW_REPORT to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_FLOW_REPORT to ACC_ST_RPT;

prompt
prompt Creating table ST_SYS_FLOW_REPORT_CTR
prompt =====================================
prompt
create table ACC_ST.ST_SYS_FLOW_REPORT_CTR
(
  balance_water_no CHAR(10) not null,
  report_module    VARCHAR2(6) not null,
  report_code      VARCHAR2(6) not null,
  valid_flag       VARCHAR2(1) not null,
  remark           VARCHAR2(100)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
comment on table ACC_ST.ST_SYS_FLOW_REPORT_CTR
  is '±®±Ì…˙≥…øÿ÷∆±Ì';
comment on column ACC_ST.ST_SYS_FLOW_REPORT_CTR.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.ST_SYS_FLOW_REPORT_CTR.report_module
  is '±®±Ìƒ£∞Â¥˙¬Î';
comment on column ACC_ST.ST_SYS_FLOW_REPORT_CTR.report_code
  is '±®±Ì¥˙¬Î';
comment on column ACC_ST.ST_SYS_FLOW_REPORT_CTR.valid_flag
  is '…˙–ß±Í÷æ';
comment on column ACC_ST.ST_SYS_FLOW_REPORT_CTR.remark
  is '±∏◊¢';
alter table ACC_ST.ST_SYS_FLOW_REPORT_CTR
  add constraint PK_ST_SYS_FLOW_REPORT_CTR primary key (BALANCE_WATER_NO, REPORT_MODULE, REPORT_CODE)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_REPORT_CTR to ACC_COMMU;
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_REPORT_CTR to ACC_COMMU_APP;
grant select on ACC_ST.ST_SYS_FLOW_REPORT_CTR to ACC_COMMU_DEV;
grant select, insert, update, delete on ACC_ST.ST_SYS_FLOW_REPORT_CTR to ACC_ST_APP;
grant select, insert, update on ACC_ST.ST_SYS_FLOW_REPORT_CTR to ACC_ST_DEV;

prompt
prompt Creating table ST_SYS_VERSION
prompt =============================
prompt
create table ACC_ST.ST_SYS_VERSION
(
  version_no  VARCHAR2(10) not null,
  operator_id VARCHAR2(10),
  valid_date  CHAR(10),
  del_desc    VARCHAR2(1024),
  update_desc VARCHAR2(1024),
  add_desc    VARCHAR2(1024),
  note        VARCHAR2(255)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_SYS_VERSION to ACC_ST_APP;
grant select on ACC_ST.ST_SYS_VERSION to ACC_ST_DEV;
grant select on ACC_ST.ST_SYS_VERSION to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_DEAL
prompt ==========================
prompt
create table ACC_ST.ST_TST_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_DEAL to ACC_ST_APP;
grant select on ACC_ST.ST_TST_DEAL to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_DEAL to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_DELAY
prompt ===========================
prompt
create table ACC_ST.ST_TST_DELAY
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  card_status_id      CHAR(3),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  operate_datetime    DATE,
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_DELAY to ACC_ST_APP;
grant select on ACC_ST.ST_TST_DELAY to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_DELAY to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_ENTRY
prompt ===========================
prompt
create table ACC_ST.ST_TST_ENTRY
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_ENTRY to ACC_ST_APP;
grant select on ACC_ST.ST_TST_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_ENTRY to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_LOCK
prompt ==========================
prompt
create table ACC_ST.ST_TST_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_LOCK to ACC_ST_APP;
grant select on ACC_ST.ST_TST_LOCK to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_LOCK to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_NON_RTN_APP
prompt =================================
prompt
create table ACC_ST.ST_TST_NON_RTN_APP
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_print_id    CHAR(16),
  apply_datetime   DATE,
  receipt_id       CHAR(4),
  operator_id      CHAR(6),
  apply_name       CHAR(8),
  tel_no           CHAR(12),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  is_broken        CHAR(2),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.ST_TST_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_NON_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_REPORT_LOSS
prompt =================================
prompt
create table ACC_ST.ST_TST_REPORT_LOSS
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  apply_name          CHAR(8),
  apply_sex           CHAR(1),
  identity_type       CHAR(1),
  identity_id         CHAR(18),
  expired_date        CHAR(8),
  tel_no              CHAR(16),
  fax                 CHAR(16),
  address             VARCHAR2(200),
  operator_id         CHAR(6),
  apply_datetime      DATE,
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  apply_business_type CHAR(1),
  receipt_id          CHAR(4),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_TST_REPORT_LOSS to ACC_ST_APP;

prompt
prompt Creating table ST_TST_RETURN
prompt ============================
prompt
create table ACC_ST.ST_TST_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_RETURN to ACC_ST_APP;
grant select on ACC_ST.ST_TST_RETURN to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_RETURN to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_SALE
prompt ==========================
prompt
create table ACC_ST.ST_TST_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_SALE to ACC_ST_APP;
grant select on ACC_ST.ST_TST_SALE to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_SALE to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_SALE_SJT
prompt ==============================
prompt
create table ACC_ST.ST_TST_SALE_SJT
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000'
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.ST_TST_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_SALE_SJT to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_SIGN_CARD_APPLY
prompt =====================================
prompt
create table ACC_ST.ST_TST_SIGN_CARD_APPLY
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255;
grant select, insert, update, delete on ACC_ST.ST_TST_SIGN_CARD_APPLY to ACC_ST_APP;
grant select on ACC_ST.ST_TST_SIGN_CARD_APPLY to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_SIGN_CARD_APPLY to ACC_ST_RPT;

prompt
prompt Creating table ST_TST_UPDATE
prompt ============================
prompt
create table ACC_ST.ST_TST_UPDATE
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_consume_seq      NUMBER,
  card_status_id        CHAR(3),
  update_area           CHAR(1),
  update_reason_id      CHAR(2),
  update_datetime       DATE,
  pay_type              CHAR(2),
  penalty_fee           NUMBER(18,2),
  receipt_id            CHAR(4),
  operator_id           CHAR(6),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  shift_id              CHAR(2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  balance_fee           NUMBER(18,2),
  deal_no_discount_fee  NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_time            DATE,
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  card_app_flag         CHAR(1),
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  card_app_mode         CHAR(1)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_TST_UPDATE to ACC_ST_APP;
grant select on ACC_ST.ST_TST_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.ST_TST_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table ST_WATER_NO
prompt ==========================
prompt
create table ACC_ST.ST_WATER_NO
(
  water_no_key VARCHAR2(5) not null,
  water_no     INTEGER not null
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.ST_WATER_NO
  add constraint PK_ST_WATER_NO primary key (WATER_NO_KEY)
  using index 
  tablespace TBS_ST_IDX
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.ST_WATER_NO to ACC_ST_APP;
grant select on ACC_ST.ST_WATER_NO to ACC_ST_DEV;
grant select on ACC_ST.ST_WATER_NO to ACC_ST_RPT;

prompt
prompt Creating table T#IST_GEN_NON_RETURN_LIST_HIS
prompt ============================================
prompt
create global temporary table ACC_ST.T#IST_GEN_NON_RETURN_LIST_HIS
(
  card_physical_id  CHAR(20),
  card_logical_id   CHAR(20),
  device_id         CHAR(4),
  deal_datetime     DATE,
  pay_mode_id       VARCHAR2(3),
  deal_fee          NUMBER(8,2),
  receipt_id        CHAR(4),
  tac               CHAR(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  deal_balance      NUMBER(12,2),
  balance_water_no  CHAR(10),
  entry_datetime    DATE,
  deal_type         CHAR(1),
  red_flag          CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  gen_time          DATE,
  tct_valid_days    INTEGER,
  tct_activate_time DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#IST_GEN_NON_RETURN_LIST_HIS to ACC_ST_APP;
grant select on ACC_ST.T#IST_GEN_NON_RETURN_LIST_HIS to ACC_ST_DEV;
grant select on ACC_ST.T#IST_GEN_NON_RETURN_LIST_HIS to ACC_ST_RPT;

prompt
prompt Creating table T#IST_GEN_NON_RETURN_LIST_NAME
prompt =============================================
prompt
create global temporary table ACC_ST.T#IST_GEN_NON_RETURN_LIST_NAME
(
  table_name VARCHAR2(20),
  num        CHAR(8),
  recd_type  CHAR(4)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#IST_GEN_NON_RETURN_LIST_NAME to ACC_ST_APP;
grant select on ACC_ST.T#IST_GEN_NON_RETURN_LIST_NAME to ACC_ST_DEV;
grant select on ACC_ST.T#IST_GEN_NON_RETURN_LIST_NAME to ACC_ST_RPT;

prompt
prompt Creating table T#IST_GEN_NON_RETURN_LIST_RET
prompt ============================================
prompt
create global temporary table ACC_ST.T#IST_GEN_NON_RETURN_LIST_RET
(
  water_no          NUMBER(19),
  card_physical_id  CHAR(20),
  card_logical_id   CHAR(20),
  device_id         CHAR(4),
  deal_datetime     DATE,
  pay_mode_id       VARCHAR2(3),
  deal_fee          NUMBER(8,2),
  receipt_id        CHAR(4),
  tac               CHAR(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  deal_balance      NUMBER(12,2),
  balance_water_no  CHAR(10),
  entry_datetime    DATE,
  deal_type         CHAR(1),
  red_flag          CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  gen_time          DATE,
  tct_valid_days    INTEGER,
  tct_activate_time DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#IST_GEN_NON_RETURN_LIST_RET to ACC_ST_APP;
grant select on ACC_ST.T#IST_GEN_NON_RETURN_LIST_RET to ACC_ST_DEV;
grant select on ACC_ST.T#IST_GEN_NON_RETURN_LIST_RET to ACC_ST_RPT;

prompt
prompt Creating table T#IST_MOVE_UNIQUE_ERR
prompt ====================================
prompt
create global temporary table ACC_ST.T#IST_MOVE_UNIQUE_ERR
(
  table_name VARCHAR2(20),
  num        CHAR(8),
  recd_type  CHAR(4)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#IST_MOVE_UNIQUE_ERR to ACC_ST_APP;
grant select on ACC_ST.T#IST_MOVE_UNIQUE_ERR to ACC_ST_DEV;
grant select on ACC_ST.T#IST_MOVE_UNIQUE_ERR to ACC_ST_RPT;

prompt
prompt Creating table T#IST_MOVE_UNIQUE_ERR_HIS
prompt ========================================
prompt
create global temporary table ACC_ST.T#IST_MOVE_UNIQUE_ERR_HIS
(
  tk_phy_id         CHAR(20),
  tk_logic_no       CHAR(18),
  device_id         CHAR(4),
  deal_time         DATE,
  paymode_id        CHAR(2),
  tk_fee            NUMBER(8,2),
  receipt_id        CHAR(4),
  tac               CHAR(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  tk_balance        NUMBER(12,2),
  balance_water_no  CHAR(18),
  entry_time        DATE,
  deal_type         CHAR(1),
  red_flag          CHAR(1),
  card_main_code    CHAR(2),
  card_sub_code     CHAR(2),
  data_source       VARCHAR2(10),
  occur_tm          DATE,
  tct_valid_days    INTEGER,
  tct_activate_time DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#IST_MOVE_UNIQUE_ERR_HIS to ACC_ST_APP;
grant select on ACC_ST.T#IST_MOVE_UNIQUE_ERR_HIS to ACC_ST_DEV;
grant select on ACC_ST.T#IST_MOVE_UNIQUE_ERR_HIS to ACC_ST_RPT;

prompt
prompt Creating table T#IST_NON_RETURN_LIST_TAB
prompt ========================================
prompt
create global temporary table ACC_ST.T#IST_NON_RETURN_LIST_TAB
(
  table_name VARCHAR2(80)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#IST_NON_RETURN_LIST_TAB to ACC_ST_APP;
grant select on ACC_ST.T#IST_NON_RETURN_LIST_TAB to ACC_ST_DEV;
grant select on ACC_ST.T#IST_NON_RETURN_LIST_TAB to ACC_ST_RPT;

prompt
prompt Creating table T#LOCK_CARD
prompt ==========================
prompt
create global temporary table ACC_ST.T#LOCK_CARD
(
  card_logical_id CHAR(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#LOCK_CARD to ACC_ST_APP;
grant select on ACC_ST.T#LOCK_CARD to ACC_ST_DEV;
grant select on ACC_ST.T#LOCK_CARD to ACC_ST_RPT;

prompt
prompt Creating table T#NON_RETURN_TMP_FARE_TABLE_ID
prompt =============================================
prompt
create global temporary table ACC_ST.T#NON_RETURN_TMP_FARE_TABLE_ID
(
  fare_table_id CHAR(3)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#NON_RETURN_TMP_FARE_TABLE_ID to ACC_ST_APP;
grant select on ACC_ST.T#NON_RETURN_TMP_FARE_TABLE_ID to ACC_ST_DEV;
grant select on ACC_ST.T#NON_RETURN_TMP_FARE_TABLE_ID to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_001_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_03_001_RESULT
(
  contc_name      VARCHAR2(20),
  m_type          CHAR(1),
  sale_num        INTEGER,
  sale_fee        NUMBER(*,2),
  deposit_num     INTEGER,
  deposit_fee     NUMBER(*,2),
  charge_num      INTEGER,
  charge_fee      NUMBER(*,2),
  cut_num         INTEGER,
  cut_fee         NUMBER(*,2),
  consume_num     INTEGER,
  consume_fee     NUMBER(*,2),
  return_num      INTEGER,
  return_fee      NUMBER(*,2),
  update_num      INTEGER,
  update_fee      NUMBER(*,2),
  affair_num      INTEGER,
  affair_fee      NUMBER(*,2),
  total_num       INTEGER,
  total_fee       NUMBER(*,2),
  line_id_dispart CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_001_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_001_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_001_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_001_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_001_RPT
(
  squad_day       CHAR(8),
  line_id_dispart CHAR(2),
  tr_type_id      CHAR(2),
  pay_mode_id     CHAR(2),
  deal_num        NUMBER(*,2),
  deal_fee        NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_001_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_001_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_001_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_002_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_03_002_RESULT
(
  contc_name  VARCHAR2(20),
  m_type      CHAR(1),
  sale_num    INTEGER,
  sale_fee    NUMBER(*,2),
  deposit_num INTEGER,
  deposit_fee NUMBER(*,2),
  charge_num  INTEGER,
  charge_fee  NUMBER(*,2),
  cut_num     INTEGER,
  cut_fee     NUMBER(*,2),
  consume_num INTEGER,
  consume_fee NUMBER(*,2),
  return_num  INTEGER,
  return_fee  NUMBER(*,2),
  update_num  INTEGER,
  update_fee  NUMBER(*,2),
  affair_num  INTEGER,
  affair_fee  NUMBER(*,2),
  total_num   INTEGER,
  total_fee   NUMBER(*,2),
  contc_id    CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_002_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_002_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_002_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_002_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_002_RPT
(
  squad_day   CHAR(8),
  contc_store CHAR(2),
  tr_type_id  CHAR(2),
  pay_mode_id CHAR(2),
  deal_num    NUMBER(*,2),
  deal_fee    NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_002_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_002_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_002_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_003_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_03_003_RESULT
(
  contc_name  VARCHAR2(20),
  m_type      CHAR(1),
  dt_num      INTEGER,
  dt_fee      NUMBER(*,2),
  affair_num  INTEGER,
  affair_fee  NUMBER(*,2),
  con_num     INTEGER,
  con_fee     NUMBER(*,2),
  sale_num    INTEGER,
  sale_fee    NUMBER(*,2),
  balance_num INTEGER,
  balance_fee NUMBER(*,2),
  service_fee NUMBER(*,2),
  sum_fee     NUMBER(*,2),
  sequence    INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_003_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_003_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_003_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_003_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_003_RPT
(
  squad_day       CHAR(8),
  line_id_dispart CHAR(2),
  tr_type_id      CHAR(2),
  pay_mode_id     CHAR(2),
  deal_num        INTEGER,
  deal_fee        NUMBER(*,2),
  balance_ser_fee NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_003_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_003_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_003_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_004_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_03_004_RESULT
(
  contc_name  VARCHAR2(20),
  dt_num      INTEGER,
  dt_fee      NUMBER(*,2),
  affair_num  INTEGER,
  affair_fee  NUMBER(*,2),
  con_num     INTEGER,
  con_fee     NUMBER(*,2),
  sale_num    INTEGER,
  sale_fee    NUMBER(*,2),
  balance_num INTEGER,
  balance_fee NUMBER(*,2),
  service_fee NUMBER(*,2),
  sum_fee     NUMBER(*,2),
  sequence    INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_004_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_004_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_004_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_004_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_004_RPT
(
  squad_day       CHAR(8),
  contc_store     CHAR(2),
  tr_type_id      CHAR(2),
  pay_mode_id     CHAR(2),
  deal_num        INTEGER,
  deal_fee        NUMBER(*,2),
  balance_ser_fee NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_004_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_004_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_004_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_005_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_005_RPT
(
  line_id     CHAR(2),
  line_sourse CHAR(20),
  line_result VARCHAR2(20),
  deal_fee    NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_005_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_005_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_005_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_006_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_006_RPT
(
  line_id     VARCHAR2(20),
  line_name   VARCHAR2(20),
  other_contc VARCHAR2(20),
  deal_fee    NUMBER(12,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_006_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_006_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_006_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_009_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_03_009_RESULT
(
  sequence     INTEGER,
  contc_name   VARCHAR2(20),
  squad_day    CHAR(8),
  singl        NUMBER(*,2),
  svt          NUMBER(*,2),
  stu_svt      NUMBER(*,2),
  old_svt_free NUMBER(*,2),
  old_svt_pre  NUMBER(*,2),
  sin_times    NUMBER(*,2),
  memory_sin   NUMBER(*,2),
  memory_pre   NUMBER(*,2),
  cs_city      NUMBER(*,2),
  special      NUMBER(*,2),
  mobile       NUMBER(*,2),
  commuter     NUMBER(*,2),
  total        NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_009_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_03_009_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_009_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_03_009_RPT
(
  contc_id         CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_sub_code    CHAR(2),
  card_main_code   CHAR(2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_03_009_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_009_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_03_009_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_03_010_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_03_010_RESULT
(
  contc_name           VARCHAR2(20),
  m_type               CHAR(1),
  sale_num             INTEGER,
  sale_fee             NUMBER(*,2),
  deposit_num          INTEGER,
  deposit_fee          NUMBER(*,2),
  cost_num             INTEGER,
  cost_fee             NUMBER(*,2),
  charge_num           INTEGER,
  charge_fee           NUMBER(*,2),
  cut_num              INTEGER,
  cut_fee              NUMBER(*,2),
  consume_single_fee   NUMBER(*,2),
  consume_metro_fee    NUMBER(*,2),
  consume_bus_fee      NUMBER(*,2),
  consume_alien_fee    NUMBER(*,2),
  consume_student_fee  NUMBER(*,2),
  consume_old_fee      NUMBER(*,2),
  consume_commuter_fee NUMBER(*,2),
  return_num           INTEGER,
  return_fee           NUMBER(*,2),
  update_single_fee    NUMBER(*,2),
  update_metro_fee     NUMBER(*,2),
  update_bus_fee       NUMBER(*,2),
  update_alien_fee     NUMBER(*,2),
  update_student_fee   NUMBER(*,2),
  update_old_fee       NUMBER(*,2),
  update_commuter_fee  NUMBER(*,2),
  affair_num           INTEGER,
  affair_fee           NUMBER(*,2),
  total_num            INTEGER,
  total_fee            NUMBER(*,2),
  contc_id             CHAR(2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_03_010_RESULT
  is '‘À”™…ÃΩª“◊ ˝æ›Ω·À„»’±®/‘¬±®¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_03_010_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_03_010_RESULT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_03_010_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_04_001_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_04_001_RESULT
(
  day             VARCHAR2(20),
  city_num        INTEGER,
  city_fee        NUMBER(*,2),
  citizen_num     INTEGER,
  citizen_fee     NUMBER(*,2),
  mobile_num      INTEGER,
  mobile_fee      NUMBER(*,2),
  small_store_num INTEGER,
  small_store_fee NUMBER(*,2),
  unionpay_num    INTEGER,
  unionpay_fee    NUMBER(*,2),
  total_num       INTEGER,
  total_fee       NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_04_001_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_04_001_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_04_001_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_04_001_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_04_001_RPT
(
  balance_water_no CHAR(20),
  out_deal_type    CHAR(2),
  acc_send_num     INTEGER,
  acc_send_fee     NUMBER(*,2),
  out_affirm_num   INTEGER,
  out_affirm_fee   NUMBER(*,2),
  error_id         INTEGER,
  error_num        INTEGER,
  error_fee        NUMBER(*,2),
  sys_type         INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_04_001_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_04_001_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_04_001_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_04_004_QRY
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_04_004_QRY
(
  balance_water_no CHAR(20),
  out_deal_type    CHAR(2),
  acc_send_num     INTEGER,
  acc_send_fee     NUMBER(*,2),
  out_affirm_num   INTEGER,
  out_affirm_fee   NUMBER(*,2),
  error_id         INTEGER,
  error_num        INTEGER,
  error_fee        NUMBER(*,2),
  sys_type         INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_04_004_QRY to ACC_ST_APP;

prompt
prompt Creating table T#OP_04_004_QRY_RESULT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_04_004_QRY_RESULT
(
  day            VARCHAR2(10),
  acc_num        INTEGER,
  acc_fee        NUMBER(*,2),
  cs_city_num    INTEGER,
  cs_city_fee    NUMBER(*,2),
  diff_num       INTEGER,
  diff_fee       NUMBER(*,2),
  tac_num        INTEGER,
  tac_fee        NUMBER(*,2),
  repeat_num     INTEGER,
  repeat_fee     NUMBER(*,2),
  nocard_num     INTEGER,
  nocard_fee     NUMBER(*,2),
  nosam_num      INTEGER,
  nosam_fee      NUMBER(*,2),
  notime_num     INTEGER,
  notime_fee     NUMBER(*,2),
  filere_num     INTEGER,
  filere_fee     NUMBER(*,2),
  dealerr_num    INTEGER,
  dealerr_fee    NUMBER(*,2),
  balance_num    INTEGER,
  balance_fee    NUMBER(*,2),
  ot_num         INTEGER,
  ot_fee         NUMBER(*,2),
  returncard_num INTEGER,
  returncard_fee NUMBER(*,2),
  blacklist_num  INTEGER,
  blacklist_fee  NUMBER(*,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_04_004_QRY_RESULT to ACC_ST_APP;

prompt
prompt Creating table T#OP_04_004_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_04_004_RESULT
(
  day            VARCHAR2(10),
  acc_num        INTEGER,
  acc_fee        NUMBER(*,2),
  cs_city_num    INTEGER,
  cs_city_fee    NUMBER(*,2),
  diff_num       INTEGER,
  diff_fee       NUMBER(*,2),
  tac_num        INTEGER,
  tac_fee        NUMBER(*,2),
  repeat_num     INTEGER,
  repeat_fee     NUMBER(*,2),
  nocard_num     INTEGER,
  nocard_fee     NUMBER(*,2),
  nosam_num      INTEGER,
  nosam_fee      NUMBER(*,2),
  notime_num     INTEGER,
  notime_fee     NUMBER(*,2),
  filere_num     INTEGER,
  filere_fee     NUMBER(*,2),
  dealerr_num    INTEGER,
  dealerr_fee    NUMBER(*,2),
  balance_num    INTEGER,
  balance_fee    NUMBER(*,2),
  ot_num         INTEGER,
  ot_fee         NUMBER(*,2),
  returncard_num INTEGER,
  returncard_fee NUMBER(*,2),
  blacklist_num  INTEGER,
  blacklist_fee  NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_04_004_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_04_004_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_04_004_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_04_004_RPT
prompt ==============================
prompt
create global temporary table ACC_ST.T#OP_04_004_RPT
(
  balance_water_no CHAR(20),
  out_deal_type    CHAR(2),
  acc_send_num     INTEGER,
  acc_send_fee     NUMBER(*,2),
  out_affirm_num   INTEGER,
  out_affirm_fee   NUMBER(*,2),
  error_id         INTEGER,
  error_num        INTEGER,
  error_fee        NUMBER(*,2),
  sys_type         INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_04_004_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_04_004_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_04_004_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_ACC_LCC_RESULT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_ACC_LCC_RESULT
(
  type                    VARCHAR2(20) not null,
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_ACC_LCC_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_ACC_LCC_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_ACC_LCC_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_AVE_DIST_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_AVE_DIST_RESULT
(
  day          VARCHAR2(20),
  card_main_id CHAR(2),
  card_sub_id  CHAR(4),
  card_name    VARCHAR2(40),
  distance     NUMBER(14,4)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_AVE_DIST_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_AVE_DIST_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_AVE_DIST_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_AVE_DIST_RESULT1
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_AVE_DIST_RESULT1
(
  card_main_code CHAR(2),
  card_sub_code  CHAR(2),
  squad_day      CHAR(8) not null,
  distance_num   NUMBER(14,4) not null,
  total_distance NUMBER(14,4) not null,
  b_line_id      CHAR(2),
  e_line_id      CHAR(2),
  pass_line      CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_AVE_DIST_RESULT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_AVE_DIST_RESULT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_AVE_DIST_RESULT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_AVE_DIST_RPT
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_AVE_DIST_RPT
(
  card_sub_code  CHAR(4),
  card_main_code CHAR(2),
  card_sub_desc  VARCHAR2(40)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_AVE_DIST_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_AVE_DIST_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_AVE_DIST_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_BUS_DIFF_RPT1
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_BUS_DIFF_RPT1
(
  balance_water_no VARCHAR2(10),
  err_code         CHAR(2),
  err_num          INTEGER,
  err_fee          NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_BUS_DIFF_RPT1 to ACC_ST_APP;

prompt
prompt Creating table T#OP_BUS_DIFF_RPT1_QRY
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_BUS_DIFF_RPT1_QRY
(
  balance_water_no VARCHAR2(10),
  err_code         CHAR(2),
  err_num          INTEGER,
  err_fee          NUMBER(12,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_BUS_DIFF_RPT1_QRY to ACC_ST_APP;

prompt
prompt Creating table T#OP_BUS_DIFF_RPT2
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_BUS_DIFF_RPT2
(
  balance_water_no VARCHAR2(10),
  pay_mode_id      CHAR(2),
  total_deal_num   INTEGER,
  total_deal_fee   NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_BUS_DIFF_RPT2 to ACC_ST_APP;
grant select on ACC_ST.T#OP_BUS_DIFF_RPT2 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_BUS_DIFF_RPT2 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_BUS_DIFF_RPT2_QRY
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_BUS_DIFF_RPT2_QRY
(
  balance_water_no VARCHAR2(10),
  pay_mode_id      CHAR(2),
  total_deal_num   INTEGER,
  total_deal_fee   NUMBER(12,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_BUS_DIFF_RPT2_QRY to ACC_ST_APP;

prompt
prompt Creating table T#OP_BUS_DIFF_RPT3
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_BUS_DIFF_RPT3
(
  balance_water_no VARCHAR2(10),
  pay_mode_id      CHAR(2),
  total_deal_num   INTEGER,
  total_deal_fee   NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_BUS_DIFF_RPT3 to ACC_ST_APP;
grant select on ACC_ST.T#OP_BUS_DIFF_RPT3 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_BUS_DIFF_RPT3 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_BUS_DIFF_RPT3_QRY
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_BUS_DIFF_RPT3_QRY
(
  balance_water_no VARCHAR2(10),
  pay_mode_id      CHAR(2),
  total_deal_num   INTEGER,
  total_deal_fee   NUMBER(12,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_BUS_DIFF_RPT3_QRY to ACC_ST_APP;

prompt
prompt Creating table T#OP_CARD_STA_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_CARD_STA_RESULT
(
  linekey         CHAR(4),
  rowkey          CHAR(4),
  begin_line_name CHAR(20),
  end_line_name   CHAR(20),
  person_num      INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_CARD_STA_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_CARD_STA_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_CARD_STA_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_CARD_STA_RESULT1
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_CARD_STA_RESULT1
(
  begin_line_no VARCHAR2(4),
  end_line_no   VARCHAR2(4),
  person_num    INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_CARD_STA_RESULT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_CARD_STA_RESULT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_CARD_STA_RESULT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_CARD_STA_RPT
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_CARD_STA_RPT
(
  linekey         CHAR(4),
  rowkey          CHAR(4),
  end_line_name   CHAR(20),
  begin_line_name CHAR(20)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_CARD_STA_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_CARD_STA_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_CARD_STA_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_CHANGE_INCOME_RPT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_CHANGE_INCOME_RPT
(
  begin_line      CHAR(2) not null,
  begin_line_name VARCHAR2(20),
  end_line        CHAR(2) not null,
  end_line_name   VARCHAR2(20),
  deal_fee        NUMBER(12,2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_CHANGE_INCOME_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_CHANGE_INCOME_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_CHANGE_INCOME_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_CHANGE_STA_RESULT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_CHANGE_STA_RESULT
(
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  change_line        CHAR(2),
  change_station     CHAR(2),
  change_line_out    CHAR(2),
  change_line_in     CHAR(2),
  single_normal_num  INTEGER,
  svt_normal_num     INTEGER,
  svt_student_num    INTEGER,
  svt_old_num        INTEGER,
  svt_oldfree_num    INTEGER,
  normal_times_num   INTEGER,
  normal_memo_num    INTEGER,
  pre_memo_num       INTEGER,
  city_num           INTEGER,
  different_num      INTEGER,
  mobile_num         INTEGER,
  maglev_commute_num INTEGER,
  out_line_name      VARCHAR2(20),
  station_name       VARCHAR2(20),
  in_line_name       VARCHAR2(20),
  deal_num           INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_CHANGE_STA_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_CHANGE_STA_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_CHANGE_STA_RPT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_CHANGE_STA_RPT
(
  num             INTEGER,
  card_main_id    CHAR(2),
  card_sub_id     CHAR(2),
  change_line     CHAR(2),
  change_station  CHAR(2),
  change_line_out CHAR(2),
  change_line_in  CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_CHANGE_STA_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_CHANGE_STA_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_CHANGE_STA_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_DEV_AGM_RPT
prompt ===============================
prompt
create global temporary table ACC_ST.T#OP_DEV_AGM_RPT
(
  line_id      CHAR(2),
  station_id   CHAR(2),
  squad_day    CHAR(8),
  dev_type_id  CHAR(2),
  reg_code     CHAR(3),
  reg_desc     VARCHAR2(40),
  deal_value   NUMBER(18),
  station_name VARCHAR2(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_DEV_AGM_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_DEV_AGM_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_DEV_AGM_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_DEV_CUR_QUER_RESULT
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_DEV_CUR_QUER_RESULT
(
  line_id      CHAR(2),
  station_id   CHAR(4),
  dev_type_id  CHAR(4),
  device_id    CHAR(4),
  parm_type_id CHAR(4),
  record_flag  CHAR(1),
  version_no   CHAR(10),
  report_date  DATE,
  remark       VARCHAR2(50),
  is_effect    CHAR(1),
  version_new  CHAR(10)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_DEV_CUR_QUER_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_DEV_CUR_QUER_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_DEV_CUR_QUER_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_DIFF_LCC_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_DIFF_LCC_RESULT
(
  line_id                      CHAR(2),
  line_name                    VARCHAR2(20),
  station_id                   CHAR(2),
  station_name                 VARCHAR2(20),
  diff_bom_sale_sjt_num        NUMBER(18),
  diff_bom_sale_sjt_fee        NUMBER(18,2),
  diff_tvm_sale_sjt_num        NUMBER(18),
  diff_tvm_sale_sjt_fee        NUMBER(18,2),
  diff_bom_sale_num            NUMBER(18),
  diff_bom_sale_deposit_fee    NUMBER(18,2),
  diff_bom_charge_fee          NUMBER(18,2),
  diff_tvm_charge_num          NUMBER(18),
  diff_tvm_charge_fee          NUMBER(18,2),
  diff_return_num              NUMBER(18),
  diff_return_fee              NUMBER(18,2),
  diff_non_return_num          NUMBER(18),
  diff_non_ret_deposit_fee     NUMBER(18,2),
  diff_non_ret_actual_ret_bala NUMBER(18,2),
  diff_negative_charge_num     NUMBER(18),
  diff_negative_charge_fee     NUMBER(18,2),
  diff_deal_num                NUMBER(18),
  diff_deal_fee                NUMBER(18,2),
  diff_update_cash_num         NUMBER(18),
  diff_update_cash_fee         NUMBER(18,2),
  diff_update_noncash_num      NUMBER(18),
  diff_update_noncash_fee      NUMBER(18,2),
  diff_admin_num               NUMBER(18),
  diff_admin_return_fee        NUMBER(18,2),
  diff_admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_DIFF_LCC_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_DIFF_LCC_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_DIFF_LCC_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_DIFF_LCC_RPT
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_DIFF_LCC_RPT
(
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  diff_bom_sale_sjt_num        NUMBER(18),
  diff_bom_sale_sjt_fee        NUMBER(18,2),
  diff_tvm_sale_sjt_num        NUMBER(18),
  diff_tvm_sale_sjt_fee        NUMBER(18,2),
  diff_bom_sale_num            NUMBER(18),
  diff_bom_sale_deposit_fee    NUMBER(18,2),
  diff_bom_charge_fee          NUMBER(18,2),
  diff_tvm_charge_num          NUMBER(18),
  diff_tvm_charge_fee          NUMBER(18,2),
  diff_return_num              NUMBER(18),
  diff_return_fee              NUMBER(18,2),
  diff_non_return_num          NUMBER(18),
  diff_non_ret_deposit_fee     NUMBER(18,2),
  diff_non_ret_actual_ret_bala NUMBER(18,2),
  diff_negative_charge_num     NUMBER(18),
  diff_negative_charge_fee     NUMBER(18,2),
  diff_deal_num                NUMBER(18),
  diff_deal_fee                NUMBER(18,2),
  diff_update_cash_num         NUMBER(18),
  diff_update_cash_fee         NUMBER(18,2),
  diff_update_noncash_num      NUMBER(18),
  diff_update_noncash_fee      NUMBER(18,2),
  diff_admin_num               NUMBER(18),
  diff_admin_return_fee        NUMBER(18,2),
  diff_admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_DIFF_LCC_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_DIFF_LCC_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_DIFF_LCC_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_ERR_CARD_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_ERR_CARD_RESULT
(
  card_logical_id   VARCHAR2(20),
  card_physical_id  VARCHAR2(20),
  total_charge_fee  NUMBER(12,2),
  total_consume_fee NUMBER(12,2),
  card_balance_fee  NUMBER(12,2),
  diff_balance_fee  NUMBER(12,2),
  sys_deal_num      INTEGER,
  card_deal_num     INTEGER,
  diff_balance_num  INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_ERR_CARD_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_ERR_CARD_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_ERR_CARD_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_ERR_DEAL_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_ERR_DEAL_RESULT
(
  line_id      CHAR(2),
  line_name    VARCHAR2(20),
  station_id   CHAR(2),
  station_name CHAR(20),
  tr_type_id   CHAR(2),
  tr_type_name VARCHAR2(20),
  error_id     CHAR(2),
  error_name   VARCHAR2(100),
  error_num    INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_ERR_DEAL_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_ERR_DEAL_RESULT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_ERR_DEAL_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_ERR_DEV_RESULT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_ERR_DEV_RESULT
(
  line_name    VARCHAR2(20),
  chinese_name VARCHAR2(20),
  dev_type_id  CHAR(2),
  device_id    CHAR(3),
  num          INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_ERR_DEV_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_ERR_DEV_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_ERR_DEV_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_ERR_SAM_RESULT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_ERR_SAM_RESULT
(
  sam_no       VARCHAR2(20),
  line_name    VARCHAR2(20),
  station_name VARCHAR2(20),
  dev_type_id  VARCHAR2(2),
  device_id    VARCHAR2(4),
  sys_num      INTEGER,
  sam_num      INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_ERR_SAM_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_ERR_SAM_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_ERR_SAM_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_FARE_ZONE_RPT1
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_FARE_ZONE_RPT1
(
  linekey VARCHAR2(20),
  rowkey  VARCHAR2(20),
  value   INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_FARE_ZONE_RPT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_FARE_ZONE_RPT2
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_FARE_ZONE_RPT2
(
  card_main_code CHAR(2) not null,
  card_sub_code  CHAR(2) not null,
  fare_zone      CHAR(5) not null,
  person_num     INTEGER not null,
  paymode_id     CHAR(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_FARE_ZONE_RPT2 to ACC_ST_APP;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT2 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT2 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_FARE_ZONE_RPT3
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_FARE_ZONE_RPT3
(
  rowkey CHAR(10)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_FARE_ZONE_RPT3 to ACC_ST_APP;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT3 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT3 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_FARE_ZONE_RPT4
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_FARE_ZONE_RPT4
(
  card_main_code VARCHAR2(2),
  card_sub_code  VARCHAR2(2),
  card_sub_desc  VARCHAR2(50)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_FARE_ZONE_RPT4 to ACC_ST_APP;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT4 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_FARE_ZONE_RPT4 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_DISCOUNT_RESULT
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_INC_DISCOUNT_RESULT
(
  id        CHAR(2),
  name      VARCHAR2(20),
  num0      INTEGER,
  fee0      NUMBER(10,2),
  num1      INTEGER,
  fee1      NUMBER(10,2),
  num2      INTEGER,
  fee2      NUMBER(10,2),
  num3      INTEGER,
  fee3      NUMBER(10,2),
  num4      INTEGER,
  fee4      NUMBER(10,2),
  num5      INTEGER,
  fee5      NUMBER(10,2),
  num6      INTEGER,
  fee6      NUMBER(10,2),
  num7      INTEGER,
  fee7      NUMBER(10,2),
  num8      INTEGER,
  fee8      NUMBER(10,2),
  num9      INTEGER,
  fee9      NUMBER(10,2),
  num10     INTEGER,
  fee10     NUMBER(10,2),
  num11     INTEGER,
  fee11     NUMBER(10),
  total_num INTEGER,
  total_fee NUMBER(10,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISCOUNT_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISCOUNT_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_DISCOUNT_RPT
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_INC_DISCOUNT_RPT
(
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         INTEGER,
  deal_fee         NUMBER(10,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISCOUNT_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_DISCOUNT_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_DISCOUNT_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_DISPART_RESULT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_DISPART_RESULT
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  num0         INTEGER,
  fee0         NUMBER(*,2),
  num1         INTEGER,
  fee1         NUMBER(*,2),
  num2         INTEGER,
  fee2         NUMBER(*,2),
  total_num    INTEGER,
  total_fee    NUMBER(*,2),
  num3         NUMBER,
  fee3         NUMBER(18,2),
  num4         NUMBER,
  fee4         NUMBER(18,2),
  num5         NUMBER,
  fee5         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISPART_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_DISPART_RESULT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISPART_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_DISPART_RPT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_INC_DISPART_RPT
(
  balance_day  VARCHAR2(8),
  squad_day    VARCHAR2(8),
  line_id      VARCHAR2(2),
  station_id   VARCHAR2(2),
  tr_type_id   VARCHAR2(2),
  pay_mode_id  VARCHAR2(2),
  do_type      VARCHAR2(2),
  card_main_id VARCHAR2(2),
  card_sub_id  VARCHAR2(2),
  deal_num     INTEGER,
  deal_fee     NUMBER(*,2),
  penalty_fee  NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISPART_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_DISPART_RPT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_INC_DISPART_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_LINE_DISCOUNT_RESULT
prompt ============================================
prompt
create global temporary table ACC_ST.T#OP_INC_LINE_DISCOUNT_RESULT
(
  squad_day            VARCHAR2(20),
  line_id              CHAR(2),
  line_name            VARCHAR2(20),
  station_id           CHAR(2),
  station_name         VARCHAR2(30),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_name            VARCHAR2(30),
  deal_fee             NUMBER(*,2),
  deal_num             INTEGER,
  deal_no_discount_fee NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_LINE_DISCOUNT_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_LINE_DISCOUNT_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_LINE_DISCOUNT_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_LINE_DISCOUNT_RPT
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_INC_LINE_DISCOUNT_RPT
(
  squad_day            CHAR(8),
  line_id              CHAR(2),
  station_id           CHAR(2),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  deal_fee             NUMBER(*,2),
  deal_num             INTEGER,
  deal_no_discount_fee NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_LINE_DISCOUNT_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_LINE_DISCOUNT_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_LINE_DISCOUNT_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_LINE_SALE
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_INC_LINE_SALE
(
  line_id           CHAR(2),
  line_name         VARCHAR2(20),
  station_id        CHAR(2),
  station_name      VARCHAR2(20),
  dev_type          CHAR(2),
  dev_name          VARCHAR2(20),
  payment_id        CHAR(2),
  payment_name      VARCHAR2(18),
  sale_num1         INTEGER,
  charge_fee1       NUMBER(12,2),
  sale_num2         INTEGER,
  deposit_fee2      NUMBER(12,2),
  charge_fee2       NUMBER(12,2),
  sale_num3         INTEGER,
  deposit_fee3      NUMBER(12,2),
  charge_fee3       NUMBER(12,2),
  sale_num4         INTEGER,
  deposit_fee4      NUMBER(12,2),
  charge_fee4       NUMBER(12,2),
  sale_num5         INTEGER,
  deposit_fee5      NUMBER(12,2),
  charge_fee5       NUMBER(12,2),
  sale_num6         INTEGER,
  deposit_fee6      NUMBER(12,2),
  charge_fee6       NUMBER(12,2),
  sale_num7         INTEGER,
  deposit_fee7      NUMBER(12,2),
  charge_fee7       NUMBER(12,2),
  sale_num8         INTEGER,
  deposit_fee8      NUMBER(12,2),
  charge_fee8       NUMBER(12,2),
  sale_num9         INTEGER,
  deposit_fee9      NUMBER(12,2),
  charge_fee9       NUMBER(12,2),
  sale_num10        INTEGER,
  deposit_fee10     NUMBER(12,2),
  charge_fee10      NUMBER(12,2),
  sale_num11        INTEGER,
  deposit_fee11     NUMBER(12,2),
  charge_fee11      NUMBER(12,2),
  sale_num12        INTEGER,
  deposit_fee12     NUMBER(12,2),
  charge_fee12      NUMBER(12,2),
  total_sale_num    INTEGER,
  total_deposit_fee NUMBER(12,2),
  total_charge_fee  NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_LINE_SALE to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_INC_LINE_SALE to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_LINE_SALE_RPT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_INC_LINE_SALE_RPT
(
  line_id      CHAR(2),
  station_id   CHAR(2),
  dev_type_id  CHAR(2),
  pay_type     CHAR(2),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  sale_num     INTEGER,
  deposit_fee  NUMBER(*,2),
  charge_fee   NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_LINE_SALE_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_LINE_SALE_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_LINE_SALE_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_PRE_CARD_RPT
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_INC_PRE_CARD_RPT
(
  line_id      CHAR(2),
  line_name    VARCHAR2(16),
  pre_code     VARCHAR2(16),
  pre_item     VARCHAR2(16),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  card_name    VARCHAR2(20),
  pre_num      NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_PRE_CARD_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_PRE_CARD_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_PRE_CARD_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_PRE_CARD_RPT0
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_INC_PRE_CARD_RPT0
(
  line_id           CHAR(2),
  line_name         VARCHAR2(20),
  disc_pre          VARCHAR2(20),
  pre_num0          INTEGER,
  pre_bef_fee0      NUMBER(12,2),
  pre_aft_fee0      NUMBER(12,2),
  pre_fee0          NUMBER(12,2),
  pre_num1          INTEGER,
  pre_bef_fee1      NUMBER(12,2),
  pre_aft_fee1      NUMBER(12,2),
  pre_fee1          NUMBER(12,2),
  pre_num2          INTEGER,
  pre_bef_fee2      NUMBER(12,2),
  pre_aft_fee2      NUMBER(12,2),
  pre_fee2          NUMBER(12,2),
  pre_num3          INTEGER,
  pre_bef_fee3      NUMBER(12,2),
  pre_aft_fee3      NUMBER(12,2),
  pre_fee3          NUMBER(12,2),
  pre_num4          INTEGER,
  pre_bef_fee4      NUMBER(12,2),
  pre_aft_fee4      NUMBER(12,2),
  pre_fee4          NUMBER(12,2),
  total_pre_num     INTEGER,
  total_pre_bef_fee NUMBER(12,2),
  total_pre_aft_fee NUMBER(12,2),
  total_pre_fee     NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_PRE_CARD_RPT0 to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_PRE_CARD_RPT0 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_PRE_CARD_RPT0 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_PRE_CARD_RPT1
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_INC_PRE_CARD_RPT1
(
  line_id              CHAR(2),
  squad_day            CHAR(8),
  balance_water_no     CHAR(20),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  deal_num             NUMBER(12,2),
  deal_fee             NUMBER(12,2),
  deal_no_discount_fee NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_PRE_CARD_RPT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_PRE_CARD_RPT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_PRE_CARD_RPT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_RECHARGE
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_INC_RECHARGE
(
  station_id   CHAR(2),
  station_name VARCHAR2(20),
  dev_type     CHAR(2),
  dev_name     VARCHAR2(20),
  num0         INTEGER,
  fee0         NUMBER(10),
  num1         INTEGER,
  fee1         NUMBER(10),
  num2         INTEGER,
  fee2         NUMBER(10),
  num3         INTEGER,
  fee3         NUMBER(10),
  num4         INTEGER,
  fee4         NUMBER(10),
  num5         INTEGER,
  fee5         NUMBER(10),
  num6         INTEGER,
  fee6         NUMBER(10),
  num7         INTEGER,
  fee7         NUMBER(10),
  num8         INTEGER,
  fee8         NUMBER(10),
  num9         INTEGER,
  fee9         NUMBER(10),
  total_num    INTEGER,
  total_fee    NUMBER(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_RECHARGE to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_INC_RECHARGE to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_RECHARGE_RESULT
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_INC_RECHARGE_RESULT
(
  line_id       CHAR(2),
  station_id    CHAR(2),
  station_name  VARCHAR2(20),
  dev_type_id   CHAR(2),
  dev_type_name VARCHAR2(20),
  ic_main_name  VARCHAR2(20),
  card_main_id  CHAR(2),
  card_sub_id   CHAR(2),
  card_name     VARCHAR2(20),
  deal_name     VARCHAR2(20),
  num           INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_RECHARGE_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_RECHARGE_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_RECHARGE_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_RECHARGE_RPT
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_INC_RECHARGE_RPT
(
  line_id       CHAR(2),
  station_id    CHAR(2),
  station_name  VARCHAR2(20),
  dev_type_id   CHAR(2),
  dev_type_name VARCHAR2(20),
  ic_main_name  VARCHAR2(20),
  card_main_id  CHAR(2),
  card_sub_id   CHAR(2),
  card_name     VARCHAR2(20),
  deal_fee      NUMBER(12,2),
  num           NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_RECHARGE_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_RECHARGE_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_RECHARGE_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SALES_YEAR
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_INC_SALES_YEAR
(
  line_id        CHAR(2),
  line_name      VARCHAR2(20),
  sale_type      CHAR(2),
  sale_name      VARCHAR2(20),
  sale_num0      INTEGER,
  sale_fee0      NUMBER(12,2),
  sale_num1      INTEGER,
  sale_fee1      NUMBER(12,2),
  sale_num2      INTEGER,
  sale_fee2      NUMBER(12,2),
  sale_num3      INTEGER,
  sale_fee3      NUMBER(12,2),
  sale_num4      INTEGER,
  sale_fee4      NUMBER(12,2),
  sale_num5      INTEGER,
  sale_fee5      NUMBER(12,2),
  sale_num6      INTEGER,
  sale_fee6      NUMBER(12,2),
  sale_num7      INTEGER,
  sale_fee7      NUMBER(12,2),
  sale_num8      INTEGER,
  sale_fee8      NUMBER(12,2),
  sale_num9      INTEGER,
  sale_fee9      NUMBER(12,2),
  sale_num10     INTEGER,
  sale_fee10     NUMBER(12,2),
  sale_num11     INTEGER,
  sale_fee11     NUMBER(12,2),
  total_sale_num INTEGER,
  total_sale_fee NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SALES_YEAR to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SALES_YEAR to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SALES_YEAR_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_INC_SALES_YEAR_RESULT
(
  line_id      CHAR(2),
  line_name    VARCHAR2(20),
  tr_type_id   CHAR(2),
  tr_type_name VARCHAR2(20),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  card_name    VARCHAR2(20),
  deal_code    VARCHAR2(20),
  num          NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SALES_YEAR_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_SALES_YEAR_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_SALES_YEAR_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SALES_YEAR_RPT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_SALES_YEAR_RPT
(
  line_id        CHAR(2),
  tr_type_id     CHAR(2),
  card_main_id   CHAR(2),
  card_sub_id    CHAR(2),
  deal_num       INTEGER,
  deal_fee       NUMBER(*,2),
  return_balance NUMBER(*,2),
  penalty_fee    NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SALES_YEAR_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_SALES_YEAR_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_SALES_YEAR_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_BOM_OPER_RPT
prompt ========================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_BOM_OPER_RPT
(
  line_id          CHAR(2),
  line_name        VARCHAR2(16),
  station_id       CHAR(2),
  station_name     VARCHAR2(16),
  operator_id      VARCHAR2(36),
  device_id        CHAR(4),
  shift_id         CHAR(2),
  singl_num        INTEGER,
  singl_fee        NUMBER(12,2),
  svt_sin_num      INTEGER,
  svt_sin_fee      INTEGER,
  svt_stu_num      INTEGER,
  svt_stu_fee      INTEGER,
  svt_old_free_num INTEGER,
  svt_old_free_fee INTEGER,
  svt_old_none_num INTEGER,
  svt_old_none_fee INTEGER,
  sin_times_num    INTEGER,
  sin_times_fee    INTEGER,
  memory_num       INTEGER,
  memory_fee       INTEGER,
  pre_rem_num      INTEGER,
  pre_rem_fee      INTEGER,
  commuter_num     INTEGER,
  commuter_fee     NUMBER(12,2),
  svt_fee          NUMBER(12,2),
  city_num         INTEGER,
  city_fee         NUMBER(12,2),
  free_times       INTEGER,
  charge_svt       NUMBER(12,2),
  charge_yct       NUMBER(12,2),
  cut_svt          NUMBER(12,2),
  cut_yct          NUMBER(12,2),
  update_dt1       NUMBER(12,2),
  update_dt2       NUMBER(12,2),
  update_dt3       NUMBER(12,2),
  update_yct1      NUMBER(12,2),
  update_yct2      NUMBER(12,2),
  update_yct3      NUMBER(12,2),
  affair_num       INTEGER,
  affair_num2      INTEGER,
  affair_penalty   NUMBER(12,2),
  affair_return    NUMBER(12,2),
  deposit          NUMBER(12,2),
  bala             NUMBER(12,2),
  penalty          NUMBER(12,2),
  return_singl     NUMBER(12,2),
  total_fee        NUMBER(15,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_BOM_OPER_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_BOM_OPER_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_BOM_OPER_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_BOM_RESULT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_BOM_RESULT
(
  line_id          CHAR(2),
  line_name        VARCHAR2(16),
  station_id       CHAR(2),
  station_name     VARCHAR2(16),
  singl_num        NUMBER(12,2),
  singl_fee        NUMBER(12,2),
  svt_sin_num      NUMBER(12,2),
  svt_sin_fee      NUMBER(12,2),
  svt_stu_num      NUMBER(12,2),
  svt_stu_fee      NUMBER(12,2),
  svt_old_free_num NUMBER(12,2),
  svt_old_free_fee NUMBER(12,2),
  svt_old_none_num NUMBER(12,2),
  svt_old_none_fee NUMBER(12,2),
  sin_times_num    NUMBER(12,2),
  sin_times_fee    NUMBER(12,2),
  memory_num       NUMBER(12,2),
  memory_fee       NUMBER(12,2),
  pre_rem_num      NUMBER(12,2),
  pre_rem_fee      NUMBER(12,2),
  commuter_num     NUMBER(12,2),
  commuter_fee     NUMBER(12,2),
  svt_fee          NUMBER(12,2),
  city_num         NUMBER(12,2),
  city_fee         NUMBER(12,2),
  free_times       NUMBER(12,2),
  charge_svt       NUMBER(12,2),
  charge_yct       NUMBER(12,2),
  cut_svt          NUMBER(12,2),
  cut_yct          NUMBER(12,2),
  update_dt1       NUMBER(12,2),
  update_dt2       NUMBER(12,2),
  update_dt3       NUMBER(12,2),
  update_yct1      NUMBER(12,2),
  update_yct2      NUMBER(12,2),
  update_yct3      NUMBER(12,2),
  affair_num       NUMBER(12,2),
  affair_num2      NUMBER(12,2),
  affair_penalty   NUMBER(12,2),
  affair_return    NUMBER(12,2),
  deposit          NUMBER(12,2),
  bala             NUMBER(12,2),
  penalty          NUMBER(12,2),
  return_singl     NUMBER(12,2),
  total_fee        NUMBER(15,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_BOM_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_BOM_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_BOM_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_BOM_RPT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_BOM_RPT
(
  squad_day      CHAR(8) not null,
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  tr_type_id     CHAR(2) not null,
  pay_type       CHAR(2),
  operator_id    CHAR(6) not null,
  card_main_code CHAR(2) not null,
  card_sub_code  CHAR(2) not null,
  dev_type_id    CHAR(2) not null,
  deal_fee       NUMBER(12,2) not null,
  return_balance NUMBER(12,2) not null,
  deal_num       INTEGER not null,
  shift_id       CHAR(2),
  device_id      CHAR(4),
  penalty_fee    NUMBER(12,2),
  pay_mode_id    CHAR(2),
  do_type        CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_BOM_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_BOM_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_BOM_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_DISCOUNT_RESULT
prompt ===========================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_DISCOUNT_RESULT
(
  line_id      CHAR(2),
  line_name    VARCHAR2(20),
  station_id   CHAR(2),
  station_name VARCHAR2(30),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  card_name    VARCHAR2(30),
  disc_code    CHAR(1),
  disc_name    VARCHAR2(20),
  num          NUMBER(*,2),
  dicount      NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_DISCOUNT_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_DISCOUNT_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_DISCOUNT_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_DISCOUNT_RPT
prompt ========================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_DISCOUNT_RPT
(
  squad_day    CHAR(8),
  line_id      CHAR(2),
  station_id   CHAR(2),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  income       NUMBER(*,2),
  deal_num     INTEGER,
  dicount      NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_DISCOUNT_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_DISCOUNT_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_DISCOUNT_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_INCOME_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_INCOME_RESULT
(
  line_id        CHAR(2),
  line_name      VARCHAR2(20),
  station_id     CHAR(2),
  station_name   VARCHAR2(20),
  tvm_sale       NUMBER(12,2),
  bom_sale       NUMBER(12,2),
  sale_total     NUMBER(12,2),
  tvm_add        NUMBER(12,2),
  bom_add        NUMBER(12,2),
  add_total      NUMBER(12,2),
  fee_total      NUMBER(12,2),
  update_dc      NUMBER(12,2),
  update_dt      NUMBER(12,2),
  update_oct     NUMBER(12,2),
  update_dc2     NUMBER(12,2),
  update_dt2     NUMBER(12,2),
  update_oct2    NUMBER(12,2),
  update_total   NUMBER(12,2),
  cut_dt         NUMBER(12,2),
  cut_oct        NUMBER(12,2),
  affair_02      NUMBER(12,2),
  affair_03      NUMBER(12,2),
  affair_penalty NUMBER(12,2),
  affair_return  NUMBER(12,2),
  ret_desosit    NUMBER(12,2),
  ret_bala       NUMBER(12,2),
  penalty        NUMBER(12,2),
  ret_sjt        NUMBER(12,2),
  ret_total      NUMBER(12,2),
  total          NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_INCOME_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_INCOME_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_INCOME_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_STA_INCOME_RPT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_STA_INCOME_RPT
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  squad_day      CHAR(8) not null,
  tr_type_id     CHAR(2) not null,
  paymode_id     CHAR(2),
  do_type        CHAR(2),
  operator_id    CHAR(6) not null,
  card_main_code CHAR(2) not null,
  card_sub_code  CHAR(2) not null,
  dev_type_id    CHAR(2) not null,
  deal_fee       NUMBER(12,2) not null,
  return_bala    NUMBER(12,2) not null,
  deal_num       INTEGER not null,
  shift_id       CHAR(2),
  device_id      CHAR(4),
  penalty        NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_STA_INCOME_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_STA_INCOME_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_STA_INCOME_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SYS_RETURN
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_INC_SYS_RETURN
(
  id                       CHAR(2),
  name                     VARCHAR2(20),
  type_id                  CHAR(2),
  type_name                VARCHAR2(25),
  return_num               INTEGER,
  return_deposit_fee       NUMBER(10,2),
  return_num1              INTEGER,
  return_deposit_fee1      NUMBER(10,2),
  bad_num1                 INTEGER,
  return_balance_fee1      NUMBER(10,2),
  return_num2              INTEGER,
  return_deposit_fee2      NUMBER(10,2),
  bad_num2                 INTEGER,
  return_balance_fee2      NUMBER(10,2),
  return_num3              INTEGER,
  return_deposit_fee3      NUMBER(10,2),
  bad_num3                 INTEGER,
  return_balance_fee3      NUMBER(10,2),
  return_num4              INTEGER,
  return_deposit_fee4      NUMBER(10,2),
  bad_num4                 INTEGER,
  return_balance_fee4      NUMBER(10,2),
  return_num5              INTEGER,
  return_deposit_fee5      NUMBER(10,2),
  bad_num5                 INTEGER,
  return_balance_fee5      NUMBER(10,2),
  return_num6              INTEGER,
  return_deposit_fee6      NUMBER(10,2),
  bad_num6                 INTEGER,
  return_balance_fee6      NUMBER(10,2),
  return_num7              INTEGER,
  return_deposit_fee7      NUMBER(10,2),
  bad_num7                 INTEGER,
  return_balance_fee7      NUMBER(10,2),
  return_num8              INTEGER,
  return_deposit_fee8      NUMBER(10,2),
  bad_num8                 INTEGER,
  return_balance_fee8      NUMBER(10,2),
  total_return_num         INTEGER,
  total_return_deposit_fee NUMBER(10,2),
  total_bad_num            INTEGER,
  total_return_balance_fee NUMBER(10,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SYS_RETURN to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SYS_RETURN to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SYS_RETURN_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_INC_SYS_RETURN_RESULT
(
  line_id        CHAR(2),
  line_name      VARCHAR2(20),
  station_id     CHAR(2),
  station_name   VARCHAR2(20),
  return_type    CHAR(1),
  return_name    VARCHAR2(20),
  card_main_code CHAR(2),
  card_sub_code  CHAR(2),
  card_name      VARCHAR2(20),
  return_code    CHAR(2),
  return_para    VARCHAR2(20),
  return_value   NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SYS_RETURN_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_SYS_RETURN_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_SYS_RETURN_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SYS_RETURN_RPT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_SYS_RETURN_RPT
(
  line_id            CHAR(2),
  station_id         CHAR(2),
  return_type        CHAR(1),
  card_main_code     CHAR(2),
  card_sub_code      CHAR(2),
  return_num         INTEGER,
  return_deposit_fee NUMBER(*,2),
  bad_num            INTEGER,
  return_balance_fee NUMBER(*,2),
  penalty_fee        NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SYS_RETURN_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_SYS_RETURN_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_SYS_RETURN_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SYS_UPDATE_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_INC_SYS_UPDATE_RESULT
(
  line_id      CHAR(2),
  line_name    VARCHAR2(30),
  pay_type     CHAR(2),
  pay_name     VARCHAR2(20),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  card_name    VARCHAR2(30),
  update_code  CHAR(2),
  update_name  VARCHAR2(20),
  num          NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SYS_UPDATE_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_SYS_UPDATE_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_SYS_UPDATE_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_SYS_UPDATE_RPT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_SYS_UPDATE_RPT
(
  line_id      CHAR(2),
  pay_type     CHAR(2),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  update_code  CHAR(20),
  num          NUMBER(*,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_SYS_UPDATE_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_SYS_UPDATE_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_SYS_UPDATE_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_UPDATE_SYS_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_INC_UPDATE_SYS_RESULT
(
  line_id   CHAR(2),
  line_name VARCHAR2(20),
  pay_type  CHAR(2),
  pay_name  VARCHAR2(20),
  num0      INTEGER,
  fee0      NUMBER(10,2),
  num1      INTEGER,
  fee1      NUMBER(10,2),
  num2      INTEGER,
  fee2      NUMBER(10,2),
  num3      INTEGER,
  fee3      NUMBER(10,2),
  num4      INTEGER,
  fee4      NUMBER(10,2),
  num5      INTEGER,
  fee5      NUMBER(10,2),
  num6      INTEGER,
  fee6      NUMBER(10,2),
  num7      INTEGER,
  fee7      NUMBER(10,2),
  num8      INTEGER,
  fee8      NUMBER(10,2),
  num9      INTEGER,
  fee9      NUMBER(10,2),
  num10     INTEGER,
  fee10     NUMBER(10,2),
  num11     INTEGER,
  fee11     NUMBER(10,2),
  total_num INTEGER,
  total_fee NUMBER(10,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_UPDATE_SYS_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_INC_UPDATE_SYS_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_INC_UPDATE_SYS_RPT
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_INC_UPDATE_SYS_RPT
(
  line_id      CHAR(2),
  tr_type_id   CHAR(2),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  deal_num     INTEGER,
  deal_fee     NUMBER(10,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_INC_UPDATE_SYS_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_INC_UPDATE_SYS_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_INC_UPDATE_SYS_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_IST_SETTLE_CONTC_DEAL_D
prompt ===========================================
prompt
create global temporary table ACC_ST.T#OP_IST_SETTLE_CONTC_DEAL_D
(
  contc_id         CHAR(2),
  belong_line_id   CHAR(2),
  belong_contc_id  CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(12,2),
  deal_fee         NUMBER(15,2),
  deposit_type     CHAR(2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_IST_SETTLE_CONTC_DEAL_D
  is '‘À”™…ÃΩª“◊ ˝æ›Ω·À„»’±®/‘¬±®¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_IST_SETTLE_CONTC_DEAL_D to ACC_ST_APP;
grant select on ACC_ST.T#OP_IST_SETTLE_CONTC_DEAL_D to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_IST_SETTLE_CONTC_DEAL_D to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_INOUT_CARD
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_LINE_INOUT_CARD
(
  ic_main_code CHAR(2),
  ic_sub_code  CHAR(2),
  ic_sub_desc  VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_INOUT_CARD to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_INOUT_CARD to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_INOUT_CARD to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_INOUT_RESULT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_LINE_INOUT_RESULT
(
  line_code        CHAR(2),
  card_main_code   CHAR(2),
  card_sub_code    CHAR(2),
  card_sub_desc    CHAR(30),
  paymode_id       CHAR(2),
  entry_num0       INTEGER,
  export_num0      INTEGER,
  entry_num1       INTEGER,
  export_num1      INTEGER,
  entry_num2       INTEGER,
  export_num2      INTEGER,
  entry_num3       INTEGER,
  export_num3      INTEGER,
  entry_num4       INTEGER,
  export_num4      INTEGER,
  entry_num5       INTEGER,
  export_num5      INTEGER,
  entry_num6       INTEGER,
  export_num6      INTEGER,
  entry_num7       INTEGER,
  export_num7      INTEGER,
  entry_num8       INTEGER,
  export_num8      INTEGER,
  entry_num9       INTEGER,
  export_num9      INTEGER,
  entry_num10      INTEGER,
  export_num10     INTEGER,
  entry_num11      INTEGER,
  export_num11     INTEGER,
  entry_num12      INTEGER,
  export_num12     INTEGER,
  entry_num13      INTEGER,
  export_num13     INTEGER,
  entry_num14      INTEGER,
  export_num14     INTEGER,
  entry_num15      INTEGER,
  export_num15     INTEGER,
  entry_num16      INTEGER,
  export_num16     INTEGER,
  entry_num17      INTEGER,
  export_num17     INTEGER,
  entry_num18      INTEGER,
  export_num18     INTEGER,
  entry_num19      INTEGER,
  export_num19     INTEGER,
  entry_num20      INTEGER,
  export_num20     INTEGER,
  entry_num21      INTEGER,
  export_num21     INTEGER,
  entry_num22      INTEGER,
  export_num22     INTEGER,
  entry_num23      INTEGER,
  export_num23     INTEGER,
  total_entry_num  INTEGER,
  total_export_num INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_INOUT_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_INOUT_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_INOUT_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_INOUT_RESULT1
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_LINE_INOUT_RESULT1
(
  card_main_code CHAR(2),
  card_sub_code  CHAR(2),
  paymode_id     CHAR(2),
  entry_num      INTEGER,
  export_num     INTEGER,
  section_no     CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_INOUT_RESULT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_INOUT_RESULT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_INOUT_RESULT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_INOUT_RPT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_LINE_INOUT_RPT
(
  line_id        CHAR(2) not null,
  card_main_code CHAR(2) not null,
  card_sub_code  CHAR(2) not null,
  squad_day      CHAR(8) not null,
  entry_num      INTEGER not null,
  export_num     INTEGER not null,
  section_no     CHAR(4) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_INOUT_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_INOUT_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_INOUT_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_TK_RESULT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_LINE_TK_RESULT
(
  day            VARCHAR2(18),
  line_id        CHAR(2),
  station_id     CHAR(2),
  station_name   VARCHAR2(20),
  card_main_code CHAR(2),
  card_sub_code  CHAR(2),
  card_name      VARCHAR2(20),
  entry_num      INTEGER,
  export_num     INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_TK_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_TK_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_TK_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_TK_RPT1
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_LINE_TK_RPT1
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  chinese_name   CHAR(20) not null,
  belong_line_id CHAR(2) not null,
  sequence       CHAR(2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_TK_RPT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_TK_RPT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_TK_RPT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_LINE_TK_RPT2
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_LINE_TK_RPT2
(
  balance_water_no CHAR(10) not null,
  line_id          CHAR(2) not null,
  station_id       CHAR(2) not null,
  card_main_code   CHAR(2) not null,
  card_sub_code    CHAR(2) not null,
  squad_day        CHAR(8) not null,
  entry_num        INTEGER not null,
  export_num       INTEGER not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_LINE_TK_RPT2 to ACC_ST_APP;
grant select on ACC_ST.T#OP_LINE_TK_RPT2 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_LINE_TK_RPT2 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MB_DIS_RES_DEAL_ERR_RTP
prompt ===========================================
prompt
create global temporary table ACC_ST.T#OP_MB_DIS_RES_DEAL_ERR_RTP
(
  day      VARCHAR2(20),
  deal_fee NUMBER(18,2),
  err_num  NUMBER(18),
  err_code CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_DEAL_ERR_RTP to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_DEAL_ERR_RTP to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MB_DIS_RES_DEAL_RES
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_MB_DIS_RES_DEAL_RES
(
  day            VARCHAR2(20),
  mb_deal_num    NUMBER(18),
  mb_deal_fee    NUMBER(18,2),
  acc_deal_num   NUMBER(18),
  acc_deal_fee   NUMBER(18,2),
  diff_num       NUMBER(18),
  diff_fee       NUMBER(18,2),
  tac_num        NUMBER(18),
  tac_fee        NUMBER(18,2),
  repeat_num     NUMBER(18),
  repeat_fee     NUMBER(18,2),
  nocard_num     NUMBER(18),
  nocard_fee     NUMBER(12,2),
  black_list_num NUMBER(18),
  black_list_fee NUMBER(18,2),
  notime_num     NUMBER(18),
  notime_fee     NUMBER(12,2),
  dealerr_num    NUMBER(18),
  dealerr_fee    NUMBER(12,2),
  balance_num    NUMBER(18),
  balance_fee    NUMBER(12,2),
  returncard_num NUMBER(18),
  returncard_fee NUMBER(12,2),
  ot_num         NUMBER(18),
  ot_fee         NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_DEAL_RES to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_DEAL_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MB_DIS_RES_RETURN_ERR_RTP
prompt =============================================
prompt
create global temporary table ACC_ST.T#OP_MB_DIS_RES_RETURN_ERR_RTP
(
  day        VARCHAR2(20),
  return_fee NUMBER(18,2),
  err_num    NUMBER(18),
  err_code   CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_RETURN_ERR_RTP to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_RETURN_ERR_RTP to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MB_DIS_RES_RETURN_RES
prompt =========================================
prompt
create global temporary table ACC_ST.T#OP_MB_DIS_RES_RETURN_RES
(
  day            VARCHAR2(20),
  mb_return_num  NUMBER(18),
  mb_return_fee  NUMBER(18,2),
  acc_return_num NUMBER(18),
  acc_return_fee NUMBER(18,2),
  diff_num       NUMBER(18),
  diff_fee       NUMBER(18,2),
  tac_num        NUMBER(18),
  tac_fee        NUMBER(18,2),
  repeat_num     NUMBER(18),
  repeat_fee     NUMBER(18,2),
  nocard_num     NUMBER(18),
  nocard_fee     NUMBER(12,2),
  black_list_num NUMBER(18),
  black_list_fee NUMBER(18,2),
  notime_num     NUMBER(18),
  notime_fee     NUMBER(12,2),
  dealerr_num    NUMBER(18),
  dealerr_fee    NUMBER(12,2),
  balance_num    NUMBER(18),
  balance_fee    NUMBER(12,2),
  returncard_num NUMBER(18),
  returncard_fee NUMBER(12,2),
  ot_num         NUMBER(18),
  ot_fee         NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_RETURN_RES to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_MB_DIS_RES_RETURN_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MB_STA_ACC_LCC_DAY_RESULT
prompt =============================================
prompt
create global temporary table ACC_ST.T#OP_MB_STA_ACC_LCC_DAY_RESULT
(
  day            VARCHAR2(20),
  data_type      VARCHAR2(2),
  data_type_name VARCHAR2(30),
  sale_num       NUMBER(18),
  deposit_fee    NUMBER(18,2),
  deal_num       NUMBER(18),
  deal_fee       NUMBER(18,2),
  return_num     NUMBER(18),
  return_fee     NUMBER(18,2),
  lock_num       NUMBER(18),
  unlock_num     NUMBER(18)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_MB_STA_ACC_LCC_DAY_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_MB_STA_ACC_LCC_DAY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MB_STA_DEAL_DAY_RESULT
prompt ==========================================
prompt
create global temporary table ACC_ST.T#OP_MB_STA_DEAL_DAY_RESULT
(
  day         VARCHAR2(20),
  sale_num    NUMBER(18),
  deposit_fee NUMBER(18,2),
  deal_num    NUMBER(18),
  deal_fee    NUMBER(18,2),
  return_num  NUMBER(18),
  return_fee  NUMBER(18,2),
  lock_num    NUMBER(18),
  unlock_num  NUMBER(18),
  total_num   NUMBER(18),
  total_fee   NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_MB_STA_DEAL_DAY_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_MB_STA_DEAL_DAY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MOB_PAY_REC_RES
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_MOB_PAY_REC_RES
(
  day            INTEGER,
  acc_num        INTEGER,
  acc_fee        NUMBER(12,2),
  cs_city_num    INTEGER,
  cs_city_fee    NUMBER(12,2),
  diff_num       INTEGER,
  diff_fee       NUMBER(12,2),
  tac_num        INTEGER,
  tac_fee        NUMBER(12,2),
  repeat_num     INTEGER,
  repeat_fee     NUMBER(12,2),
  nocard_num     INTEGER,
  nocard_fee     NUMBER(12,2),
  nosam_num      INTEGER,
  nosam_fee      NUMBER(12,2),
  notime_num     INTEGER,
  notime_fee     NUMBER(12,2),
  filere_num     INTEGER,
  filere_fee     NUMBER(12,2),
  dealerr_num    INTEGER,
  dealerr_fee    NUMBER(12,2),
  balance_num    INTEGER,
  balance_fee    NUMBER(12,2),
  test_num       INTEGER,
  test_fee       NUMBER(12,2),
  returncard_num INTEGER,
  returncard_fee NUMBER(12,2),
  blacklist_num  INTEGER,
  blacklist_fee  NUMBER(12,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_MOB_PAY_REC_RES to ACC_ST_APP;
grant select on ACC_ST.T#OP_MOB_PAY_REC_RES to ACC_ST_DEV;
grant select on ACC_ST.T#OP_MOB_PAY_REC_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MOB_PAY_REC_RPT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_MOB_PAY_REC_RPT
(
  balance_water_no VARCHAR2(18) not null,
  out_deal_type    CHAR(2) not null,
  acc_send_num     INTEGER not null,
  acc_send_fee     NUMBER(12,2) not null,
  out_affirm_num   INTEGER not null,
  out_affirm_fee   NUMBER(12,2) not null,
  error_id         CHAR(2) not null,
  error_num        INTEGER not null,
  error_fee        NUMBER(12,2) not null,
  sys_type         CHAR(2) not null
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_MOB_PAY_REC_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_MOB_PAY_REC_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_MOB_PAY_REC_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_MOB_PAY_RESULT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_MOB_PAY_RESULT
(
  consume_num INTEGER,
  consume_fee NUMBER(12,2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_MOB_PAY_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_MOB_PAY_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_MOB_PAY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_DIS_RES_DEAL_ERR_RTP
prompt ===========================================
prompt
create global temporary table ACC_ST.T#OP_NP_DIS_RES_DEAL_ERR_RTP
(
  day      VARCHAR2(20),
  deal_fee NUMBER(18,2),
  err_num  NUMBER(18),
  err_code CHAR(2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_DIS_RES_DEAL_ERR_RTP
  is 'ª•¡™Õ¯÷ß∏∂≥‰÷µ«Â∑÷Ω·π˚≤Ó“Ï‘≠“Ú¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_DEAL_ERR_RTP to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_DIS_RES_DEAL_ERR_RTP to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_DEAL_ERR_RTP to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_DIS_RES_DEAL_RES
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_NP_DIS_RES_DEAL_RES
(
  day            VARCHAR2(20),
  np_deal_num    NUMBER(18),
  np_deal_fee    NUMBER(18,2),
  acc_deal_num   NUMBER(18),
  acc_deal_fee   NUMBER(18,2),
  diff_num       NUMBER(18),
  diff_fee       NUMBER(18,2),
  tac_num        NUMBER(18),
  tac_fee        NUMBER(18,2),
  repeat_num     NUMBER(18),
  repeat_fee     NUMBER(18,2),
  nocard_num     NUMBER(18),
  nocard_fee     NUMBER(12,2),
  black_list_num NUMBER(18),
  black_list_fee NUMBER(18,2),
  notime_num     NUMBER(18),
  notime_fee     NUMBER(12,2),
  dealerr_num    NUMBER(18),
  dealerr_fee    NUMBER(12,2),
  balance_num    NUMBER(18),
  balance_fee    NUMBER(12,2),
  ot_num         NUMBER(18),
  ot_fee         NUMBER(12,2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_DIS_RES_DEAL_RES
  is 'ª•¡™Õ¯÷ß∏∂≥‰÷µ«Â∑÷Ω·π˚ª„◊‹¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_DEAL_RES to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_DIS_RES_DEAL_RES to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_DEAL_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_DIS_RES_SALE_ERR_RTP
prompt ===========================================
prompt
create global temporary table ACC_ST.T#OP_NP_DIS_RES_SALE_ERR_RTP
(
  day      VARCHAR2(20),
  sale_fee NUMBER(18,2),
  err_num  NUMBER(18),
  err_code CHAR(2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_DIS_RES_SALE_ERR_RTP
  is 'ª•¡™Õ¯÷ß∏∂∑¢ €«Â∑÷Ω·π˚≤Ó“Ï‘≠“Ú¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_SALE_ERR_RTP to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_DIS_RES_SALE_ERR_RTP to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_SALE_ERR_RTP to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_DIS_RES_SALE_RES
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_NP_DIS_RES_SALE_RES
(
  day            VARCHAR2(20),
  np_sale_num    NUMBER(18),
  np_sale_fee    NUMBER(18,2),
  acc_sale_num   NUMBER(18),
  acc_sale_fee   NUMBER(18,2),
  diff_num       NUMBER(18),
  diff_fee       NUMBER(18,2),
  tac_num        NUMBER(18),
  tac_fee        NUMBER(18,2),
  repeat_num     NUMBER(18),
  repeat_fee     NUMBER(18,2),
  nocard_num     NUMBER(18),
  nocard_fee     NUMBER(12,2),
  black_list_num NUMBER(18),
  black_list_fee NUMBER(18,2),
  notime_num     NUMBER(18),
  notime_fee     NUMBER(12,2),
  dealerr_num    NUMBER(18),
  dealerr_fee    NUMBER(12,2),
  balance_num    NUMBER(18),
  balance_fee    NUMBER(12,2),
  ot_num         NUMBER(18),
  ot_fee         NUMBER(12,2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_DIS_RES_SALE_RES
  is 'ª•¡™Õ¯÷ß∏∂∑¢ €«Â∑÷Ω·π˚ª„◊‹¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_SALE_RES to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_DIS_RES_SALE_RES to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_DIS_RES_SALE_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_ORD_DEAL_DIS_RESULT
prompt ==========================================
prompt
create global temporary table ACC_ST.T#OP_NP_ORD_DEAL_DIS_RESULT
(
  day            VARCHAR2(20),
  order_deal_num NUMBER(18),
  order_deal_fee NUMBER(18,2),
  acc_deal_num   NUMBER(18),
  acc_deal_fee   NUMBER(18,2),
  diff_num       NUMBER(18),
  diff_fee       NUMBER(18,2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_ORD_DEAL_DIS_RESULT
  is 'ª•¡™Õ¯∂©µ•”ÎΩª“◊≤Ó“Ïª„◊‹‘¬±®-≥‰÷µ¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_ORD_DEAL_DIS_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_ORD_DEAL_DIS_RESULT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_ORD_DEAL_DIS_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_ORD_DEAL_DIS_SALE_RES
prompt ============================================
prompt
create global temporary table ACC_ST.T#OP_NP_ORD_DEAL_DIS_SALE_RES
(
  day           VARCHAR2(20),
  np_sale_num   NUMBER(18),
  np_sale_fee   NUMBER(18,2),
  acc_sale_num  NUMBER(18),
  acc_sale_fee  NUMBER(18,2),
  diff_sale_num NUMBER(18),
  diff_sale_fee NUMBER(18,2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_ORD_DEAL_DIS_SALE_RES
  is 'ª•¡™Õ¯∑¢ €∂©µ•”ÎΩª“◊≤Ó“ÏΩ·π˚ª„◊‹¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_ORD_DEAL_DIS_SALE_RES to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_ORD_DEAL_DIS_SALE_RES to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_ORD_DEAL_DIS_SALE_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_STA_ACC_LCC_DAY_RESULT
prompt =============================================
prompt
create global temporary table ACC_ST.T#OP_NP_STA_ACC_LCC_DAY_RESULT
(
  day            VARCHAR2(20),
  data_type      VARCHAR2(2),
  data_type_name VARCHAR2(30),
  sale_num       NUMBER(18),
  deposit_fee    NUMBER(18,2),
  deal_num       NUMBER(18),
  deal_fee       NUMBER(18,2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_STA_ACC_LCC_DAY_RESULT
  is 'ACC”Îª•¡™Õ¯÷ß∏∂∂‘’À±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_STA_ACC_LCC_DAY_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_STA_ACC_LCC_DAY_RESULT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_STA_ACC_LCC_DAY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_NP_STA_DEAL_DAY_RESULT
prompt ==========================================
prompt
create global temporary table ACC_ST.T#OP_NP_STA_DEAL_DAY_RESULT
(
  day       VARCHAR2(20),
  sale_num  NUMBER(18),
  sale_fee  NUMBER(18,2),
  deal_num  NUMBER(18),
  deal_fee  NUMBER(18,2),
  total_num NUMBER(18),
  total_fee NUMBER(18,2)
)
on commit delete rows;
comment on table ACC_ST.T#OP_NP_STA_DEAL_DAY_RESULT
  is 'ª•¡™Õ¯Ωª“◊ª„◊‹»’£®‘¬£©±®¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#OP_NP_STA_DEAL_DAY_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_NP_STA_DEAL_DAY_RESULT to ACC_ST_DEV;
grant select, insert, update, delete on ACC_ST.T#OP_NP_STA_DEAL_DAY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_LINE_RESULT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_OD_LINE_RESULT
(
  begin_line_no   CHAR(2),
  end_line_no     CHAR(2),
  person_num      INTEGER,
  begin_line_name VARCHAR2(20),
  end_line_name   VARCHAR2(20),
  begin_sequence  VARCHAR2(2),
  end_sequence    VARCHAR2(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_LINE_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_LINE_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_LINE_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_LINE_RESULT1
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_OD_LINE_RESULT1
(
  begin_line_no VARCHAR2(2),
  end_line_no   VARCHAR2(2),
  person_num    INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_LINE_RESULT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_LINE_RESULT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_LINE_RESULT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_LINE_RPT1
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_OD_LINE_RPT1
(
  linekey CHAR(2),
  rowkey  CHAR(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_LINE_RPT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_LINE_RPT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_LINE_RPT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_STA_LINE
prompt ===============================
prompt
create global temporary table ACC_ST.T#OP_OD_STA_LINE
(
  line_id   CHAR(2) not null,
  line_name CHAR(20) not null,
  sequence  CHAR(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_STA_LINE to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_STA_LINE to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_STA_LINE to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_STA_RESULT
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_OD_STA_RESULT
(
  begin_line_code    CHAR(2),
  begin_line_name    CHAR(20),
  begin_station_code CHAR(2),
  begin_station_name CHAR(20),
  end_line_code      CHAR(2),
  end_line_name      CHAR(20),
  end_station_code   CHAR(2),
  end_station_name   CHAR(20),
  num                INTEGER,
  time_section       CHAR(11)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_STA_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_STA_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_STA_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_STA_RESULT1
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_OD_STA_RESULT1
(
  begin_line_code    CHAR(2),
  begin_station_code CHAR(2),
  end_line_code      CHAR(2),
  end_station_code   CHAR(2),
  num                INTEGER,
  time_section_id    CHAR(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_STA_RESULT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_STA_RESULT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_STA_RESULT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_OD_STA_STATION
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_OD_STA_STATION
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  chinese_name   VARCHAR2(20),
  english_name   VARCHAR2(50),
  sc_ip          VARCHAR2(15),
  contc_id       CHAR(2),
  record_flag    CHAR(1) not null,
  lcc_ip         CHAR(15),
  version_no     CHAR(10) not null,
  sequence       CHAR(2),
  belong_line_id CHAR(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_OD_STA_STATION to ACC_ST_APP;
grant select on ACC_ST.T#OP_OD_STA_STATION to ACC_ST_DEV;
grant select on ACC_ST.T#OP_OD_STA_STATION to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_CHANGE_RESULT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_CHANGE_RESULT
(
  day             INTEGER,
  change_out      CHAR(2),
  change_in       CHAR(2),
  change_in_name  CHAR(50),
  change_out_name CHAR(50),
  num             INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_CHANGE_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_CHANGE_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_CHANGE_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_CHANGE_RPT
prompt ==================================
prompt
create global temporary table ACC_ST.T#OP_PFL_CHANGE_RPT
(
  change_in_line  CHAR(2),
  change_out_line CHAR(2),
  num             INTEGER not null,
  squad_day       CHAR(8) not null,
  card_main_code  CHAR(2),
  card_sub_code   CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_CHANGE_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_CHANGE_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_CHANGE_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT1
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT1
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  entry_num    INTEGER,
  export_num   INTEGER,
  total_num    INTEGER,
  max_num0     INTEGER,
  max_num1     INTEGER,
  max_hour     VARCHAR2(5),
  remarks      VARCHAR2(100),
  max_hour1    VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT2
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT2
(
  line_id         VARCHAR2(2),
  line_name       VARCHAR2(20),
  station_id      VARCHAR2(2),
  station_name    VARCHAR2(20),
  passenger_index VARCHAR2(20),
  cycle_day       INTEGER,
  cycle_week      INTEGER,
  cycle_mon       INTEGER,
  cycle_year      INTEGER,
  remarks         VARCHAR2(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT2 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT2 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT2 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT3
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT3
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  entry_num    INTEGER,
  export_num   INTEGER,
  total_num    INTEGER,
  remarks      VARCHAR2(100)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT3 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT3 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT3 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT4
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT4
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  max_num0     INTEGER,
  max_num1     INTEGER,
  max_hour     VARCHAR2(30),
  remarks      VARCHAR2(100)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT4 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT4 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT4 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT5
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT5
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  max_num0     INTEGER,
  max_hour     VARCHAR2(5),
  remarks      VARCHAR2(100)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT5 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT5 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT5 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT6
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT6
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  max_num1     INTEGER,
  max_hour     VARCHAR2(5),
  remarks      VARCHAR2(100)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT6 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT6 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT6 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT7
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT7
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  max_num0     INTEGER,
  max_hour     VARCHAR2(5),
  remarks      VARCHAR2(100)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT7 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT7 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT7 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_DAY_RPT8
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_DAY_RPT8
(
  line_id      VARCHAR2(2),
  line_name    VARCHAR2(20),
  station_id   VARCHAR2(2),
  station_name VARCHAR2(20),
  max_num1     INTEGER,
  max_hour     VARCHAR2(5),
  remarks      VARCHAR2(100)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_DAY_RPT8 to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT8 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_DAY_RPT8 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_PASS_RESULT
prompt ========================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_PASS_RESULT
(
  day        INTEGER,
  pass_id    CHAR(2),
  begin_id   CHAR(2),
  pass_name  CHAR(50),
  begin_name CHAR(50),
  num        INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_PASS_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_PASS_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_PASS_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PFL_LINE_PASS_RPT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_PFL_LINE_PASS_RPT
(
  begin_line       CHAR(2) not null,
  pass_line        CHAR(2) not null,
  num              INTEGER not null,
  squad_day        CHAR(8) not null,
  balance_water_no CHAR(10) not null,
  card_main_code   CHAR(2),
  card_sub_code    CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PFL_LINE_PASS_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_PFL_LINE_PASS_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PFL_LINE_PASS_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_PRM_BLACK_LIST_MTR_SEC
prompt ==========================================
prompt
create global temporary table ACC_ST.T#OP_PRM_BLACK_LIST_MTR_SEC
(
  gen_datetime     DATE,
  begin_logical_id VARCHAR2(20),
  end_logical_id   VARCHAR2(20),
  black_type       CHAR(2),
  remark           VARCHAR2(256),
  action_type      VARCHAR2(3),
  create_datetime  DATE,
  operator_id      VARCHAR2(20),
  is_set           CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_PRM_BLACK_LIST_MTR_SEC to ACC_ST_APP;
grant select on ACC_ST.T#OP_PRM_BLACK_LIST_MTR_SEC to ACC_ST_DEV;
grant select on ACC_ST.T#OP_PRM_BLACK_LIST_MTR_SEC to ACC_ST_RPT;

prompt
prompt Creating table T#OP_QUERY_DEAL_DATA_TBL_ES
prompt ==========================================
prompt
create global temporary table ACC_ST.T#OP_QUERY_DEAL_DATA_TBL_ES
(
  origin_table_name VARCHAR2(30),
  table_name        VARCHAR2(100)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_QUERY_DEAL_DATA_TBL_ES to ACC_ST_APP;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TBL_ES to ACC_ST_DEV;

prompt
prompt Creating table T#OP_QUERY_DEAL_DATA_TMP1
prompt ========================================
prompt
create global temporary table ACC_ST.T#OP_QUERY_DEAL_DATA_TMP1
(
  deal_type      VARCHAR2(20),
  logi_id        VARCHAR2(20),
  deal_time      DATE,
  line_id        VARCHAR2(50),
  station_id     VARCHAR2(20),
  deal_amount    NUMBER(12,2),
  balance        NUMBER(12,2),
  device_id      VARCHAR2(4),
  dev_type_id    VARCHAR2(40),
  card_main_code VARCHAR2(30),
  card_sub_code  VARCHAR2(30),
  operator_id    VARCHAR2(16),
  limit_month    VARCHAR2(10),
  bus_counter    INTEGER,
  metro_counter  INTEGER,
  union_counter  INTEGER,
  expired_tk     VARCHAR2(20)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP1 to ACC_ST_APP;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP1 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP1 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_QUERY_DEAL_DATA_TMP2
prompt ========================================
prompt
create global temporary table ACC_ST.T#OP_QUERY_DEAL_DATA_TMP2
(
  deal_type      VARCHAR2(20),
  logi_id        VARCHAR2(20),
  deal_time      DATE,
  line_id        VARCHAR2(6),
  station_id     VARCHAR2(20),
  deal_amount    NUMBER(12,2),
  balance        NUMBER(12,2),
  device_id      VARCHAR2(4),
  dev_type_id    VARCHAR2(10),
  card_main_code VARCHAR2(16),
  card_sub_code  VARCHAR2(16),
  operator_id    VARCHAR2(16),
  order_no       VARCHAR2(14),
  es_samno       VARCHAR2(16)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP2 to ACC_ST_APP;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP2 to ACC_ST_DEV;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP2 to ACC_ST_RPT;

prompt
prompt Creating table T#OP_QUERY_DEAL_DATA_TMP_NAME
prompt ============================================
prompt
create global temporary table ACC_ST.T#OP_QUERY_DEAL_DATA_TMP_NAME
(
  table_name VARCHAR2(100),
  num        CHAR(8),
  recd_type  CHAR(2)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP_NAME to ACC_ST_APP;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP_NAME to ACC_ST_DEV;
grant select on ACC_ST.T#OP_QUERY_DEAL_DATA_TMP_NAME to ACC_ST_RPT;

prompt
prompt Creating table T#OP_REALFLOW_SECTION
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_REALFLOW_SECTION
(
  time_section   CHAR(2),
  direction_flag CHAR(1),
  direction_seq  INTEGER,
  b_station_id   CHAR(2),
  e_station_id   CHAR(2),
  num            FLOAT,
  line_id        CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_REALFLOW_SECTION to ACC_ST_APP;
grant select on ACC_ST.T#OP_REALFLOW_SECTION to ACC_ST_DEV;
grant select on ACC_ST.T#OP_REALFLOW_SECTION to ACC_ST_RPT;

prompt
prompt Creating table T#OP_REALFLOW_SEC_RESULT
prompt =======================================
prompt
create global temporary table ACC_ST.T#OP_REALFLOW_SEC_RESULT
(
  line_id        CHAR(2),
  line_name      VARCHAR2(20),
  direction_flag CHAR(2),
  direction_name VARCHAR2(20),
  direction_seq  INTEGER,
  b_line_id      CHAR(2),
  b_station_id   CHAR(2),
  b_name         VARCHAR2(20),
  e_line_id      CHAR(2),
  e_station_id   CHAR(2),
  e_name         VARCHAR2(20),
  hour0          CHAR(8),
  num0           INTEGER,
  hour1          CHAR(8),
  num1           INTEGER,
  hour2          CHAR(8),
  num2           INTEGER,
  hour3          CHAR(8),
  num3           INTEGER,
  hour4          CHAR(8),
  num4           INTEGER,
  hour5          CHAR(8),
  num5           INTEGER,
  hour6          CHAR(8),
  num6           INTEGER,
  hour7          CHAR(8),
  num7           INTEGER,
  hour8          CHAR(8),
  num8           INTEGER,
  hour9          CHAR(8),
  num9           INTEGER,
  hour10         CHAR(8),
  num10          INTEGER,
  hour11         CHAR(8),
  num11          INTEGER,
  hour12         CHAR(8),
  num12          INTEGER,
  hour13         CHAR(8),
  num13          INTEGER,
  hour14         CHAR(8),
  num14          INTEGER,
  hour15         CHAR(8),
  num15          INTEGER,
  hour16         CHAR(8),
  num16          INTEGER,
  hour17         CHAR(8),
  num17          INTEGER,
  hour18         CHAR(8),
  num18          INTEGER,
  hour19         CHAR(8),
  num19          INTEGER,
  hour20         CHAR(8),
  num20          INTEGER,
  hour21         CHAR(8),
  num21          INTEGER,
  hour22         CHAR(8),
  num22          INTEGER,
  hour23         CHAR(8),
  num23          INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_REALFLOW_SEC_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_REALFLOW_SEC_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_REALFLOW_SEC_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_REPORT_ATTRIBUTE
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_REPORT_ATTRIBUTE
(
  report_code   VARCHAR2(6) not null,
  report_name   VARCHAR2(50),
  report_module VARCHAR2(6) not null,
  report_type   CHAR(1) not null,
  period_type   CHAR(1) not null,
  line_id       CHAR(2),
  card_main_id  CHAR(2),
  card_sub_id   CHAR(2),
  data_table    VARCHAR2(500),
  report_lock   CHAR(1) not null,
  station_id    CHAR(2),
  out_type      VARCHAR2(10) not null,
  ds_id         VARCHAR2(50)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_REPORT_ATTRIBUTE to ACC_ST_APP;
grant select on ACC_ST.T#OP_REPORT_ATTRIBUTE to ACC_ST_DEV;
grant select on ACC_ST.T#OP_REPORT_ATTRIBUTE to ACC_ST_RPT;

prompt
prompt Creating table T#OP_RES_CITY_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_RES_CITY_RESULT
(
  deposit_num  INTEGER,
  deposit_fee  NUMBER(12,2),
  recharge_num INTEGER,
  recharge_fee NUMBER(12,2),
  consume_num  INTEGER,
  consume_fee  NUMBER(12,2),
  day          VARCHAR2(15)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#OP_RES_CITY_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_RES_CITY_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_RES_CITY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_RES_CITY_RPT
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_RES_CITY_RPT
(
  balance_water_no CHAR(20),
  out_deal_type    CHAR(2),
  acc_send_num     INTEGER,
  acc_send_fee     NUMBER(12,2),
  out_affirm_num   INTEGER,
  out_affirm_fee   NUMBER(12,2),
  error_id         INTEGER,
  error_num        INTEGER,
  error_fee        NUMBER(12,2),
  sys_type         INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_RES_CITY_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_RES_CITY_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_RES_CITY_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_STATION_INOUT_CARD
prompt ======================================
prompt
create global temporary table ACC_ST.T#OP_STATION_INOUT_CARD
(
  ic_main_code CHAR(2),
  ic_sub_code  CHAR(2),
  ic_sub_desc  VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_STATION_INOUT_CARD to ACC_ST_APP;
grant select on ACC_ST.T#OP_STATION_INOUT_CARD to ACC_ST_DEV;
grant select on ACC_ST.T#OP_STATION_INOUT_CARD to ACC_ST_RPT;

prompt
prompt Creating table T#OP_STATION_INOUT_RESULT
prompt ========================================
prompt
create global temporary table ACC_ST.T#OP_STATION_INOUT_RESULT
(
  line_code        CHAR(2),
  station_code     CHAR(2),
  station_name     VARCHAR2(30),
  card_main_code   CHAR(2),
  card_sub_code    CHAR(2),
  card_sub_desc    CHAR(30),
  paymode_id       CHAR(2),
  entry_num0       INTEGER,
  export_num0      INTEGER,
  entry_num1       INTEGER,
  export_num1      INTEGER,
  entry_num2       INTEGER,
  export_num2      INTEGER,
  entry_num3       INTEGER,
  export_num3      INTEGER,
  entry_num4       INTEGER,
  export_num4      INTEGER,
  entry_num5       INTEGER,
  export_num5      INTEGER,
  entry_num6       INTEGER,
  export_num6      INTEGER,
  entry_num7       INTEGER,
  export_num7      INTEGER,
  entry_num8       INTEGER,
  export_num8      INTEGER,
  entry_num9       INTEGER,
  export_num9      INTEGER,
  entry_num10      INTEGER,
  export_num10     INTEGER,
  entry_num11      INTEGER,
  export_num11     INTEGER,
  entry_num12      INTEGER,
  export_num12     INTEGER,
  entry_num13      INTEGER,
  export_num13     INTEGER,
  entry_num14      INTEGER,
  export_num14     INTEGER,
  entry_num15      INTEGER,
  export_num15     INTEGER,
  entry_num16      INTEGER,
  export_num16     INTEGER,
  entry_num17      INTEGER,
  export_num17     INTEGER,
  entry_num18      INTEGER,
  export_num18     INTEGER,
  entry_num19      INTEGER,
  export_num19     INTEGER,
  entry_num20      INTEGER,
  export_num20     INTEGER,
  entry_num21      INTEGER,
  export_num21     INTEGER,
  entry_num22      INTEGER,
  export_num22     INTEGER,
  entry_num23      INTEGER,
  export_num23     INTEGER,
  total_entry_num  INTEGER,
  total_export_num INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_STATION_INOUT_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_STATION_INOUT_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_STATION_INOUT_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_STATION_INOUT_RPT
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_STATION_INOUT_RPT
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  card_main_code CHAR(2) not null,
  card_sub_code  CHAR(2) not null,
  squad_day      CHAR(8) not null,
  entry_num      INTEGER not null,
  export_num     INTEGER not null,
  section_no     CHAR(4) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_STATION_INOUT_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_STATION_INOUT_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_STATION_INOUT_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_STATION_INOUT_STA
prompt =====================================
prompt
create global temporary table ACC_ST.T#OP_STATION_INOUT_STA
(
  line_id      CHAR(2),
  station_id   CHAR(2),
  station_name VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_STATION_INOUT_STA to ACC_ST_APP;
grant select on ACC_ST.T#OP_STATION_INOUT_STA to ACC_ST_DEV;
grant select on ACC_ST.T#OP_STATION_INOUT_STA to ACC_ST_RPT;

prompt
prompt Creating table T#OP_SYS_SALE
prompt ============================
prompt
create global temporary table ACC_ST.T#OP_SYS_SALE
(
  line_id           CHAR(2),
  line_name         VARCHAR2(20),
  dev_type          CHAR(2),
  dev_name          VARCHAR2(20),
  payment_id        CHAR(2),
  payment_name      VARCHAR2(18),
  sale_num1         INTEGER,
  charge_fee1       NUMBER(12,2),
  sale_num2         INTEGER,
  deposit_fee2      NUMBER(12,2),
  charge_fee2       NUMBER(12,2),
  sale_num3         INTEGER,
  deposit_fee3      NUMBER(12,2),
  charge_fee3       NUMBER(12,2),
  sale_num4         INTEGER,
  deposit_fee4      NUMBER(12,2),
  charge_fee4       NUMBER(12,2),
  sale_num5         INTEGER,
  deposit_fee5      NUMBER(12,2),
  charge_fee5       NUMBER(12,2),
  sale_num6         INTEGER,
  deposit_fee6      NUMBER(12,2),
  charge_fee6       NUMBER(12,2),
  sale_num7         INTEGER,
  deposit_fee7      NUMBER(12,2),
  charge_fee7       NUMBER(12,2),
  sale_num8         INTEGER,
  deposit_fee8      NUMBER(12,2),
  charge_fee8       NUMBER(12,2),
  sale_num9         INTEGER,
  deposit_fee9      NUMBER(12,2),
  charge_fee9       NUMBER(12,2),
  sale_num10        INTEGER,
  deposit_fee10     NUMBER(12,2),
  charge_fee10      NUMBER(12,2),
  sale_num11        INTEGER,
  deposit_fee11     NUMBER(12,2),
  charge_fee11      NUMBER(12,2),
  sale_num12        INTEGER,
  deposit_fee12     NUMBER(12,2),
  charge_fee12      NUMBER(12,2),
  total_sale_num    INTEGER,
  total_deposit_fee NUMBER(12,2),
  total_charge_fee  NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_SYS_SALE to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_SYS_SALE to ACC_ST_RPT;

prompt
prompt Creating table T#OP_SYS_SALE_CARD
prompt =================================
prompt
create global temporary table ACC_ST.T#OP_SYS_SALE_CARD
(
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  card_name    CHAR(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_SYS_SALE_CARD to ACC_ST_APP;
grant select on ACC_ST.T#OP_SYS_SALE_CARD to ACC_ST_DEV;
grant select on ACC_ST.T#OP_SYS_SALE_CARD to ACC_ST_RPT;

prompt
prompt Creating table T#OP_SYS_SALE_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_SYS_SALE_RESULT
(
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  line_name        CHAR(20),
  dev_type_id      CHAR(2),
  dev_name         CHAR(20),
  payment_id       CHAR(2),
  payment_name     CHAR(20),
  card_main_code   CHAR(2),
  card_sub_code    CHAR(2),
  card_name        VARCHAR2(40),
  sale_code        CHAR(2),
  sale_name        CHAR(20),
  num              NUMBER(*,2),
  station_id       CHAR(2),
  station_name     CHAR(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_SYS_SALE_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_SYS_SALE_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_SYS_SALE_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_SYS_SALE_RPT
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_SYS_SALE_RPT
(
  line_id      CHAR(2),
  dev_type_id  CHAR(2),
  pay_type     CHAR(2),
  card_main_id CHAR(2),
  card_sub_id  CHAR(2),
  sale_num     INTEGER,
  deposit_fee  NUMBER(*,2),
  charge_fee   NUMBER(*,2),
  station_id   CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_SYS_SALE_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_SYS_SALE_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_SYS_SALE_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_TOTAL_ACC_LCC_STATION_NAM
prompt =============================================
prompt
create global temporary table ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_NAM
(
  station_id   CHAR(2),
  station_name VARCHAR2(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_NAM to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_NAM to ACC_ST_RPT;

prompt
prompt Creating table T#OP_TOTAL_ACC_LCC_STATION_RES
prompt =============================================
prompt
create global temporary table ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES
(
  station_id              CHAR(2),
  station_name            VARCHAR2(20),
  data_type               VARCHAR2(2),
  data_type_name          VARCHAR2(20),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES to ACC_ST_RPT;

prompt
prompt Creating table T#OP_TOTAL_RESULT_ACC
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_TOTAL_RESULT_ACC
(
  type                    VARCHAR2(20),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_TOTAL_RESULT_ACC to ACC_ST_APP;
grant select on ACC_ST.T#OP_TOTAL_RESULT_ACC to ACC_ST_DEV;
grant select on ACC_ST.T#OP_TOTAL_RESULT_ACC to ACC_ST_RPT;

prompt
prompt Creating table T#OP_TOTAL_RESULT_LCC
prompt ====================================
prompt
create global temporary table ACC_ST.T#OP_TOTAL_RESULT_LCC
(
  type                    VARCHAR2(20),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_TOTAL_RESULT_LCC to ACC_ST_APP;
grant select on ACC_ST.T#OP_TOTAL_RESULT_LCC to ACC_ST_DEV;
grant select on ACC_ST.T#OP_TOTAL_RESULT_LCC to ACC_ST_RPT;

prompt
prompt Creating table T#OP_TVM_SALE_RESULT
prompt ===================================
prompt
create global temporary table ACC_ST.T#OP_TVM_SALE_RESULT
(
  line_id      CHAR(2),
  station_id   CHAR(2),
  station_name CHAR(20),
  sale_fee     VARCHAR2(2),
  sale_num     NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_TVM_SALE_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#OP_TVM_SALE_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_TVM_SALE_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#OP_TVM_SALE_RPT
prompt ================================
prompt
create global temporary table ACC_ST.T#OP_TVM_SALE_RPT
(
  line_id    CHAR(2),
  station_id CHAR(2),
  sale_fee   NUMBER(12,2),
  sale_num   NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#OP_TVM_SALE_RPT to ACC_ST_APP;
grant select on ACC_ST.T#OP_TVM_SALE_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#OP_TVM_SALE_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#SR_MIN_AVG_DISTANCE
prompt ====================================
prompt
create global temporary table ACC_ST.T#SR_MIN_AVG_DISTANCE
(
  o_line_id    VARCHAR2(2),
  o_station_id VARCHAR2(2),
  e_line_id    VARCHAR2(2),
  e_station_id VARCHAR2(2),
  min_distance NUMBER(13,4),
  avg_distance NUMBER(13,4)
)
on commit delete rows;
comment on table ACC_ST.T#SR_MIN_AVG_DISTANCE
  is '«Â∑÷πÊ‘Ú»®÷ÿº∆À„¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#SR_MIN_AVG_DISTANCE to ACC_ST_APP;
grant select on ACC_ST.T#SR_MIN_AVG_DISTANCE to ACC_ST_DEV;
grant select on ACC_ST.T#SR_MIN_AVG_DISTANCE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_ACT_SVT_AGAIN
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_ACT_SVT_AGAIN
(
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20),
  again_time       DATE
)
on commit delete rows;
comment on table ACC_ST.T#ST_ACT_SVT_AGAIN
  is '¥¢÷µ∆±÷ÿ±‡¬Î ±º‰º«¬º¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#ST_ACT_SVT_AGAIN to ACC_ST_APP;
grant select on ACC_ST.T#ST_ACT_SVT_AGAIN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_ACT_SVT_AGAIN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_ADMIN
prompt =============================
prompt
create global temporary table ACC_ST.T#ST_BUF_ADMIN
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  admin_datetime   DATE,
  admin_way_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  return_fee       NUMBER(18,2),
  penalty_fee      NUMBER(18,2),
  admin_reason_id  CHAR(2),
  describe         CHAR(30),
  passenger_name   CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_ADMIN to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_ADMIN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_ADMIN_CHK
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_BUF_ADMIN_CHK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  admin_datetime   DATE,
  admin_way_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  return_fee       NUMBER(18,2),
  penalty_fee      NUMBER(18,2),
  admin_reason_id  CHAR(2),
  describe         CHAR(30),
  passenger_name   CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  table_name       VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_ADMIN_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_ADMIN_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_ADMIN_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_AGM_CARD_DATA
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_AGM_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  box_id           NUMBER(18),
  water_no_op      NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_AGM_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_AGM_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_AGM_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_AGM_CUTOFF_DTL
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_AGM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_AGM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_AGM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_AGM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_AGM_CUTOFF_TOTAL
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_AGM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  box_pop_num      NUMBER(18),
  total_num        NUMBER(18),
  total_fee        NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_BOM_SHIFT_TOTAL
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_BOM_SHIFT_TOTAL
(
  water_no                 NUMBER(18) not null,
  line_id                  CHAR(2),
  station_id               CHAR(2),
  dev_type_id              CHAR(2),
  device_id                CHAR(3),
  operator_id              CHAR(6),
  shift_id                 CHAR(2),
  start_time               DATE,
  end_time                 DATE,
  sale_total_num           NUMBER(18),
  sale_total_fee           NUMBER(18,2),
  charge_total_num         NUMBER(18),
  charge_total_fee         NUMBER(18,2),
  update_total_num         NUMBER(18),
  update_total_fee         NUMBER(18,2),
  update_total_fee_cash    NUMBER(18,2),
  admin_total_num          NUMBER(18),
  admin_total_fee_return   NUMBER(18,2),
  admin_total_fee_income   NUMBER(18,2),
  delay_total_num          NUMBER(18),
  return_total_num         NUMBER(18),
  return_total_fee         NUMBER(18,2),
  return_non_total_num     NUMBER(18),
  return_non_total_fee     NUMBER(18,2),
  return_non_app_total_num NUMBER(18),
  charge_update_total_num  NUMBER(18),
  charge_update_total_fee  NUMBER(18,2),
  unlock_total_num         NUMBER(18),
  total_fee_nocash         NUMBER(18,2),
  total_fee_cash           NUMBER(18,2),
  balance_water_no         CHAR(10),
  file_name                VARCHAR2(30),
  check_flag               CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_DEAL
prompt ============================
prompt
create global temporary table ACC_ST.T#ST_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  tac_deal_type         CHAR(2),
  tac_dev_id            CHAR(12),
  card_app_mode         CHAR(1),
  work_mode             CHAR(1),
  city_code             CHAR(4),
  business_code         CHAR(4)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_DEAL_CHK
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_BUF_DEAL_CHK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  city_code             CHAR(4),
  business_code         CHAR(4),
  tac_deal_type         CHAR(2),
  tac_dev_id            CHAR(12),
  card_app_mode         CHAR(1),
  table_name            VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_DEAL_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_DEAL_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_DEAL_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_DELAY
prompt =============================
prompt
create global temporary table ACC_ST.T#ST_BUF_DELAY
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  card_status_id      CHAR(3),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  operate_datetime    DATE,
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_DELAY to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_DELAY to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_DELAY to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_DELAY_CHK
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_BUF_DELAY_CHK
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  card_status_id      CHAR(3),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  operate_datetime    DATE,
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  table_name          VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_DELAY_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_DELAY_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_DELAY_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_ENTRY
prompt =============================
prompt
create global temporary table ACC_ST.T#ST_BUF_ENTRY
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_ENTRY to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_ENTRY to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_ENTRY_CHK
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_BUF_ENTRY_CHK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  entry_datetime        DATE,
  card_status_id        CHAR(3),
  balance_fee           NUMBER(18,2),
  union_year_month      CHAR(4),
  union_total_num       NUMBER(18),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  tac                   CHAR(10),
  pay_mode_id           CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_datetime         DATE,
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_limit_fee   NUMBER(18,2),
  card_physical_type    CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER(18),
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  balance_water_no      CHAR(10),
  card_app_flag         CHAR(1),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  table_name            VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_ENTRY_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_ENTRY_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_ENTRY_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_LCC
prompt ===========================
prompt
create global temporary table ACC_ST.T#ST_BUF_LCC
(
  water_no                NUMBER(18),
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2),
  file_name               VARCHAR2(30),
  check_flag              CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_LCC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_LCC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_LOCK
prompt ============================
prompt
create global temporary table ACC_ST.T#ST_BUF_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(1),
  card_app_mode    CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_LOCK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_LOCK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_LOCK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_LOCK_CHK
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_BUF_LOCK_CHK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(1),
  card_app_mode    CHAR(1),
  table_name       VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_LOCK_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_LOCK_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_LOCK_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_NON_RTN_APP
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_BUF_NON_RTN_APP
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_print_id    CHAR(16),
  apply_datetime   DATE,
  receipt_id       CHAR(4),
  operator_id      CHAR(6),
  apply_name       CHAR(8),
  tel_no           CHAR(12),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  is_broken        CHAR(2),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_NON_RTN_APP to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_NON_RTN_APP_CHK
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_NON_RTN_APP_CHK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_print_id    CHAR(16),
  apply_datetime   DATE,
  receipt_id       CHAR(4),
  operator_id      CHAR(6),
  apply_name       CHAR(8),
  tel_no           CHAR(12),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  is_broken        CHAR(2),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  table_name       VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_NON_RTN_APP_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_NON_RTN_APP_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_NON_RTN_APP_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_REG_TOTAL
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_BUF_REG_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  commu_datetime   DATE,
  gen_datetime     DATE,
  total_num        NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_REG_TOTAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_REG_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_REG_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_REPORT_LOSS
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_BUF_REPORT_LOSS
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  apply_name          CHAR(8),
  apply_sex           CHAR(1),
  identity_type       CHAR(1),
  identity_id         CHAR(18),
  expired_date        CHAR(8),
  tel_no              CHAR(16),
  fax                 CHAR(16),
  address             VARCHAR2(200),
  operator_id         CHAR(6),
  apply_datetime      DATE,
  shift_id            CHAR(2),
  card_app_flag       CHAR(1),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  apply_business_type CHAR(1),
  receipt_id          CHAR(4),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_REPORT_LOSS to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_RETURN
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_BUF_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2),
  tac_dev_id         CHAR(12)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_RETURN to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_RETURN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_RETURN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_RETURN_CHK
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_BUF_RETURN_CHK
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2),
  tac_dev_id         CHAR(12),
  table_name         VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_RETURN_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_RETURN_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_RETURN_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_SALE
prompt ============================
prompt
create global temporary table ACC_ST.T#ST_BUF_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_SALE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_SALE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_SALE_AGAIN
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SALE_AGAIN
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SALE_AGAIN to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_SALE_AGAIN_NON
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SALE_AGAIN_NON
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SALE_AGAIN_NON to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_SALE_CHK
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SALE_CHK
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  table_name        VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SALE_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_SALE_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_SALE_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_SALE_SJT
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SALE_SJT
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2),
  tac_dev_id          CHAR(12)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_SALE_SJT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_SALE_SJT_CHK
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SALE_SJT_CHK
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2),
  tac_dev_id          CHAR(12),
  table_name          VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SALE_SJT_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_SALE_SJT_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_SALE_SJT_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_SIGN_CARD_APPLY
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SIGN_CARD_APPLY
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           CHAR(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SIGN_CARD_APPLY to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_SIGN_CARD_APPLY to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_SIGN_CARD_APPLY to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_SIGN_CARD_APPLY_CHK
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_SIGN_CARD_APPLY_CHK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  apply_name       CHAR(8),
  apply_sex        CHAR(1),
  identity_type    CHAR(1),
  identity_id      CHAR(18),
  expired_date     DATE,
  tel_no           CHAR(16),
  fax              CHAR(16),
  address          CHAR(200),
  operator_id      CHAR(6),
  apply_datetime   DATE,
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  table_name       VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_SIGN_CARD_APPLY_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_SIGN_CARD_APPLY_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_SIGN_CARD_APPLY_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_AUTO_BAL
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_AUTO_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_AUTO_BAL to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_TVM_BAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_BAL
(
  water_no                     NUMBER(18) not null,
  line_id                      CHAR(2),
  station_id                   CHAR(2),
  dev_type_id                  CHAR(2),
  device_id                    CHAR(3),
  auto_bal_datetime_begin      DATE,
  auto_bal_datetime_end        DATE,
  sjt_sale_fee_total_1         NUMBER(18,2),
  sjt_sale_fee_total_2         NUMBER(18,2),
  charge_fee_total             NUMBER(18,2),
  note_recv_fee_total          NUMBER(18,2),
  coin_recv_fee_total          NUMBER(18,2),
  note_recv_fee_rep_total      NUMBER(18,2),
  coin_recv_fee_rep_total      NUMBER(18,2),
  coin_bal_fee_total           NUMBER(18,2),
  note_bal_fee_total           NUMBER(18,2),
  note_chg_fee_put_total_1     NUMBER(18,2),
  note_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_put_total_1     NUMBER(18,2),
  coin_chg_fee_put_total_2     NUMBER(18,2),
  coin_chg_fee_total_1         NUMBER(18,2),
  coin_chg_fee_pop_total_2     NUMBER(18,2),
  note_chg_fee_total_1         NUMBER(18,2),
  note_chg_fee_total_2         NUMBER(18,2),
  coin_chg_fee_bal_total_1     NUMBER(18,2),
  coin_chg_fee_bal_total_2     NUMBER(18,2),
  note_chg_fee_bal_total_1     NUMBER(18,2),
  note_chg_fee_bal_total_2     NUMBER(18,2),
  coin_chg_fee_clear_total_1   NUMBER(18,2),
  coin_chg_fee_clear_total_2   NUMBER(18,2),
  coin_chg_fee_bal_sum_total_1 NUMBER(18,2),
  coin_chg_fee_bal_sum_total_2 NUMBER(18,2),
  note_recaim_chg_num          NUMBER(18),
  note_recaim_bal_num          NUMBER(18),
  sjt_num_put_total_1          NUMBER(18),
  sjt_num_put_total_2          NUMBER(18),
  sjt_num_sale_total_1         NUMBER(18),
  sjt_num_sale_total_2         NUMBER(18),
  sjt_num_clear_total_1        NUMBER(18),
  sjt_num_clear_total_2        NUMBER(18),
  sjt_num_bal_total_1          NUMBER(18),
  sjt_num_bal_total_2          NUMBER(18),
  sjt_num_waste_total          NUMBER(18),
  tvm_bal_fee_total            NUMBER(18,2),
  balance_water_no             CHAR(10),
  file_name                    VARCHAR2(30),
  check_flag                   CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_BAL to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_TVM_CARD_CLEAR
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_CARD_CLEAR
(
  water_no              NUMBER(18) not null,
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  operator_id           CHAR(6),
  clear_datetime        DATE,
  water_no_op           NUMBER(18),
  card_main_id_hopper_1 CHAR(2),
  card_sub_id_hopper_1  CHAR(2),
  card_main_id_hopper_2 CHAR(2),
  card_sub_id_hopper_2  CHAR(2),
  hopper_1_num          NUMBER(18),
  hopper_2_num          NUMBER(18),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_CARD_CLEAR to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_CARD_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_CARD_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_CARD_PUT
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_CARD_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  box_id           NUMBER(18),
  hopper_id        NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  num              NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_CARD_PUT to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_CARD_PUT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_CARD_PUT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_COIN_CLEAR
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_COIN_CLEAR
(
  water_no          NUMBER(18) not null,
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  coin_box_id       NUMBER(18),
  operator_id       CHAR(6),
  clear_datetime    DATE,
  water_no_op       NUMBER(18),
  hopper_1_unit_fee NUMBER(18,2),
  hopper_1_unit_num NUMBER(18),
  hopper_2_unit_fee NUMBER(18,2),
  hopper_2_unit_num NUMBER(18),
  coin_fee_1        NUMBER(18,2),
  coin_fee_2        NUMBER(18,2),
  coin_fee_3        NUMBER(18,2),
  coin_fee_4        NUMBER(18,2),
  coin_fee_5        NUMBER(18,2),
  coin_fee_6        NUMBER(18,2),
  coin_fee_7        NUMBER(18,2),
  coin_fee_8        NUMBER(18,2),
  coin_num_1        NUMBER(18),
  coin_num_2        NUMBER(18),
  coin_num_3        NUMBER(18),
  coin_num_4        NUMBER(18),
  coin_num_5        NUMBER(18),
  coin_num_6        NUMBER(18),
  coin_num_7        NUMBER(18),
  coin_num_8        NUMBER(18),
  coin_fee_total    NUMBER(18,2),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_COIN_CLEAR to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_COIN_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_COIN_CLEAR to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_COIN_DATA
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_COIN_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  coin_box_id      NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_fee_1       NUMBER(18,2),
  coin_fee_2       NUMBER(18,2),
  coin_fee_3       NUMBER(18,2),
  coin_fee_4       NUMBER(18,2),
  coin_fee_5       NUMBER(18,2),
  coin_fee_6       NUMBER(18,2),
  coin_fee_7       NUMBER(18,2),
  coin_fee_8       NUMBER(18,2),
  coin_num_1       NUMBER(18),
  coin_num_2       NUMBER(18),
  coin_num_3       NUMBER(18),
  coin_num_4       NUMBER(18),
  coin_num_5       NUMBER(18),
  coin_num_6       NUMBER(18),
  coin_num_7       NUMBER(18),
  coin_num_8       NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_COIN_DATA to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_COIN_DATA to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_COIN_DATA to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_COIN_PUT
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_COIN_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  hopper_id        NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  coin_unit_fee    NUMBER(18,2),
  coin_num         NUMBER(18),
  coin_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_COIN_PUT to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_COIN_PUT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_COIN_PUT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_CUTOFF_DTL
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_CUTOFF_DTL
(
  water_no         NUMBER(18) not null,
  trade_type_id    CHAR(2),
  pay_mode_id      CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_CUTOFF_DTL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_CUTOFF_DTL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_CUTOFF_DTL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_CUTOFF_TOTAL
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_CUTOFF_TOTAL
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  op_date          DATE,
  cur_datetime     DATE,
  card_put_num     NUMBER(18),
  card_clear_num   NUMBER(18),
  coin_put_num     NUMBER(18),
  coin_put_fee     NUMBER(18,2),
  coin_clear_num   NUMBER(18),
  coin_clear_fee   NUMBER(18,2),
  coin_reclaim_num NUMBER(18),
  coin_reclaim_fee NUMBER(18,2),
  note_reclaim_num NUMBER(18),
  note_reclaim_fee NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_NOTE_CHG_POP
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_NOTE_CHG_POP
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_type      NUMBER(18),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  put_datetime       DATE,
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee           NUMBER(18,2),
  note_num_put       NUMBER(18),
  note_num_chg       NUMBER(18),
  note_num_bal       NUMBER(18),
  note_fee_total_put NUMBER(18,2),
  note_fee_total_chg NUMBER(18,2),
  note_fee_total_bal NUMBER(18,2),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_NOTE_CHG_POP to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_TVM_NOTE_CHG_PUT
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_NOTE_CHG_PUT
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_type    NUMBER(18),
  note_box_id      VARCHAR2(16),
  operator_id      CHAR(6),
  put_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee         NUMBER(18,2),
  note_num         NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_NOTE_CHG_PUT to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_TVM_NOTE_DATA
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_NOTE_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  note_box_id      NUMBER(18),
  operator_id      CHAR(6),
  put_datetime     DATE,
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  note_fee_1       NUMBER(18,2),
  note_fee_2       NUMBER(18,2),
  note_fee_3       NUMBER(18,2),
  note_fee_4       NUMBER(18,2),
  note_fee_5       NUMBER(18,2),
  note_fee_6       NUMBER(18,2),
  note_fee_7       NUMBER(18,2),
  note_fee_8       NUMBER(18,2),
  note_fee_9       NUMBER(18,2),
  note_fee_10      NUMBER(18,2),
  note_fee_11      NUMBER(18,2),
  note_fee_12      NUMBER(18,2),
  note_fee_13      NUMBER(18,2),
  note_num_1       NUMBER(18),
  note_num_2       NUMBER(18),
  note_num_3       NUMBER(18),
  note_num_4       NUMBER(18),
  note_num_5       NUMBER(18),
  note_num_6       NUMBER(18),
  note_num_7       NUMBER(18),
  note_num_8       NUMBER(18),
  note_num_9       NUMBER(18),
  note_num_10      NUMBER(18),
  note_num_11      NUMBER(18),
  note_num_12      NUMBER(18),
  note_num_13      NUMBER(18),
  note_fee_total   NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_NOTE_DATA to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_NOTE_DATA to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_NOTE_DATA to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_TVM_NOTE_RECLAIM
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_NOTE_RECLAIM
(
  water_no           NUMBER(18) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  note_box_id        VARCHAR2(16),
  operator_id        CHAR(6),
  pop_datetime       DATE,
  water_no_op        NUMBER(18),
  note_fee_1         NUMBER(18,2),
  note_num_reclaim_1 NUMBER(18),
  note_fee_2         NUMBER(18,2),
  note_num_reclaim_2 NUMBER(18),
  note_fee_3         NUMBER(18,2),
  note_num_reclaim_3 NUMBER(18),
  note_fee_4         NUMBER(18,2),
  note_num_reclaim_4 NUMBER(18),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_NOTE_RECLAIM to ACC_ST_APP;

prompt
prompt Creating table T#ST_BUF_TVM_WASTE_CARD_DATA
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_BUF_TVM_WASTE_CARD_DATA
(
  water_no         NUMBER(18) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  operator_id      CHAR(6),
  pop_datetime     DATE,
  water_no_op      NUMBER(18),
  sjt_num          NUMBER(18),
  sjt_discount_num NUMBER(18),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_UPDATE
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_BUF_UPDATE
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  device_id            CHAR(3),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  card_physical_id     CHAR(20),
  card_consume_seq     INTEGER,
  card_status_id       CHAR(3),
  update_area          CHAR(1),
  update_reason_id     CHAR(2),
  update_datetime      DATE,
  pay_type             CHAR(2),
  penalty_fee          NUMBER(18,2),
  receipt_id           CHAR(4),
  operator_id          CHAR(8),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  shift_id             CHAR(2),
  union_year_month     CHAR(4),
  union_bus_num        NUMBER(18),
  union_metro_num      NUMBER(18),
  union_total_num      NUMBER(18),
  balance_fee          NUMBER(18,2),
  deal_no_dicount_fee  NUMBER(18,2),
  card_charge_seq      NUMBER(18),
  tac                  CHAR(10),
  pay_mode_id          CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_time           DATE,
  last_sam_logical_id  CHAR(20),
  last_datetime        DATE,
  trade_sort           CHAR(2),
  card_area_code       CHAR(4),
  card_area_type       CHAR(4),
  overdraft_limit_fee  NUMBER(18),
  card_physical_type   CHAR(1),
  card_expired_flag    CHAR(1),
  tct_valid_days       NUMBER(18),
  tct_activate_time    DATE,
  card_app_flag        CHAR(1),
  limit_mode           CHAR(3),
  limit_entry_station  CHAR(4),
  limit_exit_station   CHAR(4),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30),
  check_flag           CHAR(1),
  err_code             CHAR(2),
  card_app_mode        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_UPDATE to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_BUF_UPDATE_CHK
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_BUF_UPDATE_CHK
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  device_id            CHAR(3),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  card_physical_id     CHAR(20),
  card_consume_seq     INTEGER,
  card_status_id       CHAR(3),
  update_area          CHAR(1),
  update_reason_id     CHAR(2),
  update_datetime      DATE,
  pay_type             CHAR(2),
  penalty_fee          NUMBER(18,2),
  receipt_id           CHAR(4),
  operator_id          CHAR(8),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  shift_id             CHAR(2),
  union_year_month     CHAR(4),
  union_bus_num        NUMBER(18),
  union_metro_num      NUMBER(18),
  union_total_num      NUMBER(18),
  balance_fee          NUMBER(18,2),
  deal_no_dicount_fee  NUMBER(18,2),
  card_charge_seq      NUMBER(18),
  tac                  CHAR(10),
  pay_mode_id          CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_time           DATE,
  last_sam_logical_id  CHAR(20),
  last_datetime        DATE,
  trade_sort           CHAR(2),
  card_area_code       CHAR(4),
  card_area_type       CHAR(4),
  overdraft_limit_fee  NUMBER(18),
  card_physical_type   CHAR(1),
  card_expired_flag    CHAR(1),
  tct_valid_days       NUMBER(18),
  tct_activate_time    DATE,
  card_app_flag        CHAR(1),
  limit_mode           CHAR(3),
  limit_entry_station  CHAR(4),
  limit_exit_station   CHAR(4),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30),
  check_flag           CHAR(1),
  err_code             CHAR(2),
  card_app_mode        CHAR(1),
  table_name           VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_BUF_UPDATE_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_BUF_UPDATE_CHK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_BUF_UPDATE_CHK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_CFG_RECORD_SEQ
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_CFG_RECORD_SEQ
(
  seq INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#ST_CFG_RECORD_SEQ to ACC_ST_APP;
grant select on ACC_ST.T#ST_CFG_RECORD_SEQ to ACC_ST_DEV;
grant select on ACC_ST.T#ST_CFG_RECORD_SEQ to ACC_ST_RPT;

prompt
prompt Creating table T#ST_ERR_DEAL
prompt ============================
prompt
create global temporary table ACC_ST.T#ST_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_ERR_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_ERR_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_ERR_SALE_SJT
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_ERR_SALE_SJT
(
  water_no            NUMBER(18),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  err_code            CHAR(2),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000'
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_ERR_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.T#ST_ERR_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_ERR_SALE_SJT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_ERR_SIGN_CARD_APPLY
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_ERR_SIGN_CARD_APPLY
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  apply_name        CHAR(8),
  apply_sex         CHAR(1),
  identity_type     CHAR(1),
  identity_id       CHAR(18),
  expired_date      DATE,
  tel_no            CHAR(16),
  fax               CHAR(16),
  address           VARCHAR2(200),
  operator_id       CHAR(6),
  apply_datetime    DATE,
  shift_id          CHAR(2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  app_business_type CHAR(1) default '1'
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_ERR_SIGN_CARD_APPLY to ACC_ST_APP;

prompt
prompt Creating table T#ST_EXT_MTR_BUF_DEAL
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_EXT_MTR_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  err_code              CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_EXT_MTR_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_EXT_MTR_BUF_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_EXT_MTR_BUF_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_EXT_MTR_BUF_DEAL_CHK
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_EXT_MTR_BUF_DEAL_CHK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        INTEGER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  work_mode             CHAR(1),
  city_code             CHAR(4),
  business_code         CHAR(4),
  tac_deal_type         CHAR(2),
  tac_dev_id            CHAR(12),
  card_app_mode         CHAR(1),
  table_name            VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_EXT_MTR_BUF_DEAL_CHK to ACC_ST_APP;

prompt
prompt Creating table T#ST_FLAG_NON_RTN
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_FLAG_NON_RTN
(
  return_flag VARCHAR2(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_FLAG_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.T#ST_FLAG_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_FLAG_NON_RTN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_FLUX_REALFLOW
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_IST_FLUX_REALFLOW
(
  time_section        CHAR(2),
  change_line_out_dir CHAR(1),
  b_station_id        CHAR(2),
  e_station_id        CHAR(2),
  num                 FLOAT,
  line_id             CHAR(2),
  balance_water_no    CHAR(10),
  squad_day           CHAR(8)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_FLUX_REALFLOW to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_FLUX_REALFLOW to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_FLUX_REALFLOW to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_FLUX_REALFLOW1
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_IST_FLUX_REALFLOW1
(
  time_section        CHAR(2),
  change_line_out_dir CHAR(1),
  b_station_id        CHAR(2),
  e_station_id        CHAR(2),
  num                 FLOAT,
  line_id             CHAR(2),
  balance_water_no    CHAR(10),
  squad_day           CHAR(8)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_FLUX_REALFLOW1 to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_FLUX_REALFLOW1 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_FLUX_REALFLOW1 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_AUDIT_COLLECT
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_AUDIT_COLLECT
(
  balance_water_no CHAR(10) not null,
  file_name        CHAR(20) not null,
  line_id          CHAR(2) not null,
  station_id       CHAR(2) not null,
  file_type        CHAR(3),
  record_num       INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_AUDIT_COLLECT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_AUDIT_COLLECT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_AUDIT_COLLECT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_AUDIT_ERR
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_AUDIT_ERR
(
  balance_water_no CHAR(10) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  tr_type_id       CHAR(2),
  error_id         CHAR(2),
  sys_type         CHAR(2),
  deal_num         INTEGER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_AUDIT_ERR to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_AUDIT_ERR to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_AUDIT_ERR to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_END_CONTC
prompt =============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_END_CONTC
(
  contc_id         CHAR(2),
  belong_line_id   CHAR(2),
  belong_contc_id  CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_END_CONTC to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_END_CONTC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_END_CONTC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_END_LINE
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_END_LINE
(
  line_id_dispart  CHAR(2),
  belong_line_id   CHAR(2),
  belong_contc_id  CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_END_LINE to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_END_LINE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_END_LINE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_INCOME
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_INCOME
(
  contc_id         CHAR(2),
  belong_line_id   CHAR(2),
  belong_contc_id  CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(12,2),
  deal_fee         NUMBER(15,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_INCOME to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_INCOME to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_INCOME to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_INC_MODE
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_INC_MODE
(
  contc_id         CHAR(2),
  belong_line_id   CHAR(2),
  belong_contc_id  CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(12,2),
  deal_fee         NUMBER(15,2),
  deposit_type     CHAR(2)
)
on commit delete rows;
comment on table ACC_ST.T#ST_IST_SETTLE_DATA_INC_MODE
  is '‘À”™…Ã∆±ø®¿‡–ÕΩª“◊¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_IST_SETTLE_DATA_INC_MODE.deposit_type
  is '0£∫—∫Ω£¨1£∫≥…±æ£¨2£∫≤ª π”√£®—∫Ωø…ÕÀ£¨≥…±æ≤ªø…ÕÀ£©';
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_INC_MODE to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_INC_MODE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_INC_MODE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_MAX_NUM
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_MAX_NUM
(
  b_line_id      CHAR(2),
  b_station_id   CHAR(2),
  e_line_id      CHAR(2),
  e_station_id   CHAR(2),
  version_no     CHAR(10),
  contc_line_num INTEGER,
  max_contc_line CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_MAX_NUM to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_MAX_NUM to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_MAX_NUM to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_MID_NOW
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_MID_NOW
(
  version_no    CHAR(10),
  b_line_id     CHAR(2),
  b_station_id  CHAR(2),
  contc_line_id CHAR(2),
  e_line_id     CHAR(2),
  e_station_id  CHAR(2),
  in_percent    NUMBER(8,6)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_MID_NOW to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_MID_NOW to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_MID_NOW to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_MID_NUM
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_MID_NUM
(
  begin_line_id    CHAR(2),
  begin_station_id CHAR(2),
  end_line_id      CHAR(2),
  end_station_id   CHAR(2),
  version_no       CHAR(10),
  contc_line_num   NUMBER,
  max_contc_line   CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_MID_NUM to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_MID_NUM to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_MID_NUM to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_SECTION
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_SECTION
(
  contc_id         CHAR(2),
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  time_section_id  CHAR(2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_SECTION to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_SECTION to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_SECTION to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_DATA_STATION
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_DATA_STATION
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  belong_line_id CHAR(2) not null,
  contc_id       CHAR(2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_DATA_STATION to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_STATION to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_DATA_STATION to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_ASSIGN
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_ASSIGN
(
  version_no   CHAR(10) not null,
  b_line_id    CHAR(2) not null,
  b_station_id CHAR(2) not null,
  line_id      CHAR(2) not null,
  e_line_id    CHAR(2) not null,
  e_station_id CHAR(2) not null,
  in_percent   NUMBER(8,6)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_ASSIGN to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_ASSIGN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_ASSIGN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_DEAL
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_DEAL
(
  balance_water_no CHAR(10) not null,
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  person_num       NUMBER,
  time_section_id  CHAR(2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_ENTRY
prompt =========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_ENTRY
(
  balance_water_no CHAR(10) not null,
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  time_section_id  CHAR(2),
  person_num       NUMBER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_ENTRY to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_ENTRY to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_IN
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_IN
(
  balance_water_no CHAR(10) not null,
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  time_section_id  CHAR(2),
  person_num       NUMBER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_IN to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_IN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_IN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_L_CONTC
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_L_CONTC
(
  line_id  CHAR(2) not null,
  contc_id CHAR(2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_L_CONTC to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_L_CONTC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_L_CONTC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_OUT
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_OUT
(
  balance_water_no CHAR(10) not null,
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  time_section_id  CHAR(2),
  person_num       NUMBER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_OUT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_OUT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_OUT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_PERSON
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON
(
  balance_water_no CHAR(10) not null,
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  person_num       NUMBER,
  time_section_id  CHAR(2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_PERSON1
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON1
(
  balance_water_no CHAR(10) not null,
  b_line_id        CHAR(2),
  b_station_id     CHAR(2),
  e_line_id        CHAR(2),
  e_station_id     CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  person_num       NUMBER,
  time_section_id  CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON1 to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON1 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_PERSON1 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_QDEAL
prompt =========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_QDEAL
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  deal_datetime        DATE,
  deal_fee             NUMBER(18,2),
  pay_mode_id          CHAR(2),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_datetime       DATE,
  balance_water_no     CHAR(10),
  card_app_flag        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_QDEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_QDEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_QDEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_QENTRY
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_QENTRY
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  entry_datetime   DATE,
  balance_fee      NUMBER(18,2),
  pay_mode_id      CHAR(2),
  balance_water_no CHAR(10),
  card_app_flag    CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_QENTRY to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_QENTRY to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_QENTRY to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_RESULT
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_RESULT
(
  balance_water_no CHAR(10) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  time_section_id  CHAR(2),
  entry_num        NUMBER,
  export_num       NUMBER
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_SND_GET
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_SND_GET
(
  balance_water_no CHAR(10) not null,
  b_line_id        CHAR(2) not null,
  b_station_id     CHAR(2) not null,
  e_line_id        CHAR(2) not null,
  e_station_id     CHAR(2) not null,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  time_section_id  CHAR(2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_SND_GET to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_SND_GET to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_SND_GET to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_FLUX_STATION
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_FLUX_STATION
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  belong_line_id CHAR(2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_FLUX_STATION to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_STATION to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_FLUX_STATION to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_HIS_MORE_COL
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COL
(
  cnr NUMBER(18)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COL to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_HIS_MORE_COUNT
prompt =============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COUNT
(
  cnt NUMBER(18)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COUNT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COUNT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_COUNT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_HIS_MORE_MAX
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MAX
(
  max_time DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MAX to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MAX to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MAX to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_HIS_MORE_MIN
prompt ===========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MIN
(
  min_time DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MIN to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MIN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_HIS_MORE_MIN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_AD_PAY
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_AD_PAY
(
  balance_water_no CHAR(18) not null,
  squad_day        CHAR(8) not null,
  line_id          CHAR(2) not null,
  station_id       CHAR(2) not null,
  dev_type_id      CHAR(2) not null,
  device_id        CHAR(4) not null,
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) not null,
  operator_id      CHAR(6) not null,
  shift_id         CHAR(18) not null,
  admin_way_id     CHAR(2) not null,
  admin_reason_id  CHAR(2) not null,
  num              NUMBER(18) not null,
  total_fee        NUMBER(18,2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_AD_PAY to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_AD_PAY to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_AD_PAY to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_BALANCE
prompt =============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_BALANCE
(
  balance_month     CHAR(10),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  total_num         NUMBER(18),
  total_bal_fee     NUMBER(18,2),
  total_deposit_fee NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_BALANCE to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_BALANCE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_BOM_GET
prompt =============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_BOM_GET
(
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  do_type          CHAR(2),
  operator_id      CHAR(6),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  dev_type_id      CHAR(2),
  deal_fee         NUMBER(18,2),
  return_bala      NUMBER(18,2),
  deal_num         NUMBER(18),
  shift_id         CHAR(2),
  device_id        CHAR(4),
  penalty_fee      NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_BOM_GET to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_BOM_GET to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_BOM_GET to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_DEAL
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_DEAL
(
  balance_water_no     CHAR(10),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  squad_day            CHAR(8),
  pay_mode_id          CHAR(2),
  deal_num             NUMBER(18),
  deal_fee             NUMBER(18,2),
  deal_no_discount_fee NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_FARE_C
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_FARE_C
(
  time_code      CHAR(1) not null,
  card_sub_code  CHAR(2) not null,
  card_main_code CHAR(2) not null,
  fare_table_id  CHAR(3) not null,
  version_no     CHAR(10) not null,
  record_flag    CHAR(1) not null,
  start_times    CHAR(3),
  end_times      CHAR(3)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_FARE_C to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_FARE_C to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_FARE_C to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_RETURN
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_RETURN
(
  balance_water_no   CHAR(10) not null,
  line_id            CHAR(2),
  station_id         CHAR(2),
  return_type        CHAR(1),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  squad_day          CHAR(8),
  return_num         NUMBER,
  return_deposit_fee NUMBER(18,2),
  bad_num            NUMBER,
  return_balance_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_RETURN to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_RETURN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_RETURN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_RPT
prompt =========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_RPT
(
  balance_water_no CHAR(10) not null,
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  dev_type_id      CHAR(2),
  pay_type         CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER,
  deposit_fee      NUMBER(18,2),
  deal_fee         NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_RPT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_INCOME_UPDATE
prompt ============================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_INCOME_UPDATE
(
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  pay_type         CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  update_num       NUMBER(*,18),
  penalty_fee      NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_INCOME_UPDATE to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_INCOME_UPDATE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_LCC_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_LCC_RESULT
(
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_LCC_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_LCC_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_LCC_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_LCC_TMP
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_LCC_TMP
(
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_LCC_TMP to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_LCC_TMP to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_LCC_TMP to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_OUT_ERROR
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_OUT_ERROR
(
  balance_water_no CHAR(10) not null,
  out_deal_type    CHAR(2) not null,
  out_affirm_num   INTEGER,
  out_affirm_fee   NUMBER(12,2),
  error_id         CHAR(2),
  error_num        INTEGER not null,
  error_fee        NUMBER(12,2) not null,
  sys_type         CHAR(2),
  data_file_name   CHAR(25),
  line_id          CHAR(2),
  card_type        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_OUT_ERROR to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_OUT_ERROR to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_OUT_ERROR to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_OUT_RPT
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_OUT_RPT
(
  balance_water_no CHAR(10) not null,
  out_deal_type    CHAR(2) not null,
  acc_send_num     INTEGER not null,
  acc_send_fee     NUMBER(12,2) not null,
  out_affirm_num   INTEGER,
  out_affirm_fee   NUMBER(12,2),
  error_id         CHAR(2),
  error_num        INTEGER not null,
  error_fee        NUMBER(12,2) not null,
  sys_type         CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_OUT_RPT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_OUT_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_OUT_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_OUT_STATION
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_OUT_STATION
(
  line_id        CHAR(2) not null,
  station_id     CHAR(2) not null,
  belong_line_id CHAR(2) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_OUT_STATION to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_OUT_STATION to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_OUT_STATION to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_REG
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_REG
(
  balance_water_no CHAR(10) not null,
  line_id          CHAR(2) not null,
  station_id       CHAR(2) not null,
  squad_day        CHAR(8),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  data_code        CHAR(3) not null,
  deal_value       NUMBER(10) not null
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_REG to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_REG to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_REG to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_SAM_EXIST
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SAM_EXIST
(
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  err_code            CHAR(2),
  balance_water_no    CHAR(10),
  tk_app_mode         CHAR(1),
  sam_trade_seq_start NUMBER(18),
  sam_trade_seq_end   NUMBER(18),
  act_sam_start       NUMBER(18),
  act_sam_end         NUMBER(18),
  flag                NUMBER(1),
  act_sam_start_new   NUMBER(18),
  act_sam_end_new     NUMBER(18),
  list_sam_start      NUMBER(18),
  list_sam_end        NUMBER(18)
)
on commit delete rows;
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.sam_trade_seq_start
  is '÷ÿ∫≈ø™ º–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.sam_trade_seq_end
  is '÷ÿ∫≈Ω· ¯–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.act_sam_start
  is 'sam’Àªß±Ìø™ º–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.act_sam_end
  is 'sam’Àªß±ÌΩ· ¯–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.act_sam_start_new
  is '∫œ≤¢∫Ûø™ º–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.act_sam_end_new
  is '∫œ≤¢∫ÛΩ· ¯–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.list_sam_start
  is 'list±Ìø™ º–Ú∫≈';
comment on column ACC_ST.T#ST_IST_SETTLE_SAM_EXIST.list_sam_end
  is 'list±ÌΩ· ¯–Ú∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SAM_EXIST to ACC_ST_APP;

prompt
prompt Creating table T#ST_IST_SETTLE_SAM_LIST
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SAM_LIST
(
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq_start NUMBER(18),
  sam_trade_seq_end   NUMBER(18),
  total_deal_num      NUMBER(10),
  tk_app_mode         CHAR(1),
  flag                CHAR(1),
  id                  NUMBER(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SAM_LIST to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SAM_LIST to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_SAM_LIST to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_SAM_LIST1
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SAM_LIST1
(
  id                  NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq_start NUMBER(18),
  sam_trade_seq_end   NUMBER(18),
  total_deal_num      NUMBER(10),
  tk_app_mode         CHAR(1),
  flag                CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SAM_LIST1 to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SAM_LIST1 to ACC_ST_DEV;

prompt
prompt Creating table T#ST_IST_SETTLE_SAM_TMP
prompt ======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SAM_TMP
(
  water_no       NUMBER(18),
  line_id        CHAR(2),
  station_id     CHAR(2),
  dev_type_id    CHAR(2),
  device_id      CHAR(3),
  tr_type_id     CHAR(2),
  sam_logical_id CHAR(20),
  sam_trade_seq  NUMBER(18),
  tk_app_mode    CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SAM_TMP to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SAM_TMP to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_SAM_TMP to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_SAM_TMP1
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SAM_TMP1
(
  line_id             CHAR(2) not null,
  station_id          CHAR(2) not null,
  dev_type_id         CHAR(2) not null,
  device_id           CHAR(3) not null,
  sam_logical_id      CHAR(20) not null,
  sam_trade_seq_start NUMBER(18) not null,
  sam_trade_seq_end   NUMBER(18) not null,
  total_deal_num      NUMBER(10),
  balance_water_no    CHAR(10),
  tk_app_mode         CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SAM_TMP1 to ACC_ST_APP;

prompt
prompt Creating table T#ST_IST_SETTLE_STORE
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_STORE
(
  contc_store      CHAR(4),
  line_id          CHAR(2),
  squad_day        CHAR(8),
  balance_water_no CHAR(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  tr_type_id       CHAR(2),
  pay_mode_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  other_fee        NUMBER(18,2),
  three_fee        NUMBER(18,2),
  balance_ser_fee  NUMBER(18,2),
  fare             NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_STORE to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_STORE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_STORE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_SVT_CARD
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SVT_CARD
(
  balance_water_no CHAR(10),
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) not null,
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20) not null,
  charge_num       NUMBER(18),
  consume_num      NUMBER(18),
  charge_fee       NUMBER(18,2),
  consume_fee      NUMBER(18,2),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SVT_CARD to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_CARD to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_CARD to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_SVT_DEAL
prompt =======================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SVT_DEAL
(
  water_no             NUMBER(18),
  line_id              CHAR(2),
  station_id           CHAR(2),
  dev_type_id          CHAR(2),
  device_id            CHAR(3),
  sam_logical_id       CHAR(20),
  sam_trade_seq        NUMBER(18),
  deal_datetime        DATE,
  card_main_id         CHAR(2),
  card_sub_id          CHAR(2),
  card_logical_id      CHAR(20),
  card_physical_id     CHAR(20),
  deal_fee             NUMBER(18,2),
  deal_balance_fee     NUMBER(18,2),
  card_charge_seq      NUMBER(18),
  card_consume_seq     NUMBER(18),
  pay_mode_id          CHAR(2),
  entry_line_id        CHAR(2),
  entry_station_id     CHAR(2),
  entry_sam_logical_id CHAR(20),
  entry_datetime       DATE,
  deal_no_discount_fee NUMBER(18,2),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30)
)
on commit delete rows;
comment on table ACC_ST.T#ST_IST_SETTLE_SVT_DEAL
  is '”‡∂Ó∆Ω∫‚œ˚∑—Õ≥º∆¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SVT_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_DEAL to ACC_ST_DEV;

prompt
prompt Creating table T#ST_IST_SETTLE_SVT_LOGIC
prompt ========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SVT_LOGIC
(
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  hdl_time            DATE
)
on commit delete rows;
comment on table ACC_ST.T#ST_IST_SETTLE_SVT_LOGIC
  is '”‡∂Ó∆Ω∫‚∑¢ €‘§∏≥÷µÕ≥º∆¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SVT_LOGIC to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_LOGIC to ACC_ST_DEV;

prompt
prompt Creating table T#ST_IST_SETTLE_SVT_LOGICNO
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SVT_LOGICNO
(
  card_logical_id CHAR(20) not null
)
on commit delete rows;
comment on table ACC_ST.T#ST_IST_SETTLE_SVT_LOGICNO
  is '÷ÿ∏¥∑¢ €‘§∏≥÷µ¬ﬂº≠ø®∫≈¡Ÿ ±±Ì';
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SVT_LOGICNO to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_LOGICNO to ACC_ST_DEV;

prompt
prompt Creating table T#ST_IST_SETTLE_SVT_RESULT
prompt =========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SVT_RESULT
(
  balance_water_no CHAR(10),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20),
  charge_num       NUMBER(18),
  consume_num      NUMBER(18),
  charge_fee       NUMBER(18,2),
  consume_fee      NUMBER(18,2),
  card_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(10),
  card_consume_seq NUMBER(10),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SVT_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_IST_SETTLE_SVT_RESULT1
prompt ==========================================
prompt
create global temporary table ACC_ST.T#ST_IST_SETTLE_SVT_RESULT1
(
  balance_water_no CHAR(10),
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) not null,
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20) not null,
  charge_num       NUMBER(18),
  consume_num      NUMBER(18),
  charge_fee       NUMBER(18,2),
  consume_fee      NUMBER(18,2),
  card_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(10),
  card_consume_seq NUMBER(10),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_IST_SETTLE_SVT_RESULT1 to ACC_ST_APP;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_RESULT1 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_IST_SETTLE_SVT_RESULT1 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_LIST_REPORT_LOSS
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_LIST_REPORT_LOSS
(
  water_no         NUMBER(18) not null,
  apply_bill       VARCHAR2(25),
  create_time      DATE,
  busniss_type     CHAR(1),
  identify_type    CHAR(1),
  identity_id      VARCHAR2(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  apply_name       VARCHAR2(20),
  apply_sex        CHAR(1),
  expired_date     CHAR(8),
  tel_no           VARCHAR2(16),
  fax              VARCHAR2(16),
  address          VARCHAR2(200),
  operator_id      VARCHAR2(10),
  apply_datetime   DATE,
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  VARCHAR2(20),
  card_physical_id VARCHAR2(20),
  card_print_id    VARCHAR2(20),
  balance_water_no CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_LIST_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.T#ST_LIST_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.T#ST_LIST_REPORT_LOSS to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_BUF_DEAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_DEAL to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_DEAL_CHK
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_DEAL_CHK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11),
  table_name            VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_DEAL_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_DEAL_CHK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_LCC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_num       NUMBER(18),
  charge_fee       NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_LCC to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_LOCK
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  mobile_no        CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_LOCK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_LOCK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_LOCK_CHK
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_LOCK_CHK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  mobile_no        CHAR(11),
  table_name       VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_LOCK_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_LOCK_CHK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_RETURN
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_RETURN to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_RETURN to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_RETURN_CHK
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_RETURN_CHK
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11),
  table_name         VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_RETURN_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_RETURN_CHK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_SALE
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  mobile_no         CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_SALE to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_BUF_SALE_CHK
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_MB_BUF_SALE_CHK
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  mobile_no         CHAR(11),
  table_name        VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_BUF_SALE_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_BUF_SALE_CHK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_ERR_DEAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  err_code              CHAR(2),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  paid_channel_type     CHAR(2),
  paid_channel_code     CHAR(4),
  mobile_no             CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_ERR_DEAL to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_ERR_LCC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_MB_ERR_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_num       NUMBER(18),
  charge_fee       NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_ERR_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_ERR_LCC to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_ERR_LOCK
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_ERR_LOCK
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  lock_flag        CHAR(1),
  lock_datetime    DATE,
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  card_app_mode    CHAR(1),
  err_code         CHAR(2),
  mobile_no        CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_ERR_LOCK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_ERR_LOCK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_ERR_RETURN
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_MB_ERR_RETURN
(
  water_no           NUMBER(18),
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  sam_logical_id     CHAR(20),
  sam_trade_seq      NUMBER(18),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  card_logical_id    CHAR(20),
  card_physical_id   CHAR(20),
  card_status_id     CHAR(3),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  penalty_reason_id  CHAR(2),
  card_consume_seq   NUMBER(18),
  return_type        CHAR(1),
  return_datetime    DATE,
  receipt_id         CHAR(4),
  apply_datetime     DATE,
  tac                CHAR(10),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  auxi_fee           NUMBER(18,2),
  card_app_flag      CHAR(1),
  balance_water_no   CHAR(10),
  file_name          VARCHAR2(30),
  check_flag         CHAR(1),
  tac_deal_type      CHAR(2) default '00',
  tac_dev_id         CHAR(12) default '000000000000',
  paid_channel_type  CHAR(2),
  paid_channel_code  CHAR(4),
  mobile_no          CHAR(11),
  err_code           CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_ERR_RETURN to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_ERR_RETURN to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_ERR_SALE
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_ERR_SALE
(
  water_no          NUMBER(18),
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  card_logical_id   CHAR(20),
  card_physical_id  CHAR(20),
  card_status_id    CHAR(3),
  water_no_business CHAR(12),
  sam_logical_id    CHAR(20),
  sam_trade_seq     NUMBER(18),
  deposit_type      CHAR(2),
  deposit_fee       NUMBER(18,2),
  sale_datetime     DATE,
  receipt_id        CHAR(4),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  auxi_fee          NUMBER(18,2),
  card_app_flag     CHAR(1),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2),
  mobile_no         CHAR(11)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_ERR_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_ERR_SALE to ACC_ST_DEV;

prompt
prompt Creating table T#ST_MB_STS_ACC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_ACC
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18),
  balance_water_no CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_ACC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_STS_ACC_RESULT
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_ACC_RESULT
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18),
  balance_water_no CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_ACC_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_ACC_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_ACC_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_STS_DEAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_DEAL
(
  line_id           CHAR(2),
  station_id        CHAR(2),
  dev_type_id       CHAR(2),
  device_id         CHAR(3),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  paid_channel_type CHAR(2),
  squad_day         CHAR(8),
  operator_id       CHAR(6),
  shift_id          CHAR(2),
  balance_water_no  CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_STS_LCC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_LCC
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  return_num       NUMBER(18),
  return_fee       NUMBER(18,2),
  lock_num         NUMBER(18),
  unlock_num       NUMBER(18),
  balance_water_no CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_LCC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_LCC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_STS_LOCK
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_LOCK
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  lock_num         NUMBER(18),
  squad_day        CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  lock_flag        CHAR(1),
  balance_water_no CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_LOCK to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_LOCK to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_LOCK to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_STS_RETURN
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_RETURN
(
  line_id            CHAR(2),
  station_id         CHAR(2),
  dev_type_id        CHAR(2),
  device_id          CHAR(3),
  card_main_id       CHAR(2),
  card_sub_id        CHAR(2),
  return_num         NUMBER(18),
  return_balance_fee NUMBER(18,2),
  return_deposit_fee NUMBER(18,2),
  penalty_fee        NUMBER(18,2),
  return_type        CHAR(1),
  auxi_fee           NUMBER(18,2),
  paid_channel_type  CHAR(2),
  squad_day          CHAR(8),
  operator_id        CHAR(6),
  shift_id           CHAR(2),
  balance_water_no   CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_RETURN to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_RETURN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_RETURN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_MB_STS_SALE
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_MB_STS_SALE
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deposit_type     CHAR(2),
  deposit_fee      NUMBER(18,2),
  sale_num         NUMBER(18),
  squad_day        CHAR(8),
  operator_id      CHAR(6),
  shift_id         CHAR(2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_MB_STS_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_MB_STS_SALE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_MB_STS_SALE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_BUF_DEAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_DEAL to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_BUF_DEAL_CHK
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_DEAL_CHK
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20),
  table_name            VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_DEAL_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_DEAL_CHK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_BUF_LCC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_LCC to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_BUF_ORDER
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_ORDER
(
  water_no          NUMBER(10),
  order_no          VARCHAR2(20),
  order_type        CHAR(2),
  status            CHAR(2),
  generate_datetime DATE,
  paid_datetime     DATE,
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  line_id_start     CHAR(2),
  station_id_start  CHAR(2),
  line_id_end       CHAR(2),
  station_id_end    CHAR(2),
  deal_unit_fee     NUMBER(18,2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  mobile_no         CHAR(11),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_ORDER to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_ORDER to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_BUF_ORDER_IMP
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_ORDER_IMP
(
  water_no         NUMBER(18),
  order_no         VARCHAR2(20),
  order_type       CHAR(2),
  finish_datetime  DATE,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_ORDER_IMP to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_BUF_SALE
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_SALE
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_SALE to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_BUF_SALE_CHK
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_NP_BUF_SALE_CHK
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20),
  table_name          VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_BUF_SALE_CHK to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_BUF_SALE_CHK to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_ERR_DEAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_NP_ERR_DEAL
(
  water_no              NUMBER(18),
  line_id               CHAR(2),
  station_id            CHAR(2),
  dev_type_id           CHAR(2),
  device_id             CHAR(3),
  sam_logical_id        CHAR(20),
  sam_trade_seq         NUMBER(18),
  deal_datetime         DATE,
  card_main_id          CHAR(2),
  card_sub_id           CHAR(2),
  card_logical_id       CHAR(20),
  card_physical_id      CHAR(20),
  card_status_id        CHAR(3),
  deal_fee              NUMBER(18,2),
  deal_balance_fee      NUMBER(18,2),
  card_charge_seq       NUMBER(18),
  card_consume_seq      NUMBER(18),
  pay_mode_id           CHAR(2),
  receipt_id            CHAR(4),
  tac                   CHAR(10),
  entry_line_id         CHAR(2),
  entry_station_id      CHAR(2),
  entry_sam_logical_id  CHAR(20),
  entry_datetime        DATE,
  operator_id           CHAR(6),
  shift_id              CHAR(2),
  last_sam_logical_id   CHAR(20),
  last_deal_datetime    DATE,
  deal_no_discount_fee  NUMBER(18,2),
  union_year_month      CHAR(4),
  union_bus_num         NUMBER(18),
  union_metro_num       NUMBER(18),
  union_total_num       NUMBER(18),
  trade_sort            CHAR(2),
  card_area_code        CHAR(4),
  card_area_type        CHAR(4),
  overdraft_fee         NUMBER(18,2),
  card_cpu_flag         CHAR(1),
  card_expired_flag     CHAR(1),
  tct_valid_days        NUMBER,
  tct_activate_datetime DATE,
  limit_mode            CHAR(3),
  limit_entry_station   CHAR(4),
  limit_exit_station    CHAR(4),
  card_app_flag         CHAR(1),
  balance_water_no      CHAR(10),
  file_name             VARCHAR2(30),
  check_flag            CHAR(1),
  city_code             CHAR(4) default '0000',
  business_code         CHAR(4) default '0000',
  tac_deal_type         CHAR(2) default '00',
  tac_dev_id            CHAR(12) default '000000000000',
  work_mode             CHAR(1),
  card_app_mode         CHAR(1),
  order_no              VARCHAR2(20),
  err_code              CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_ERR_DEAL to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_ERR_LCC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_NP_ERR_LCC
(
  water_no         NUMBER(18),
  balance_water_no CHAR(10),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_ERR_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_ERR_LCC to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_ERR_ORDER
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_NP_ERR_ORDER
(
  water_no          NUMBER(10),
  order_no          VARCHAR2(20),
  order_type        CHAR(2),
  status            CHAR(2),
  generate_datetime DATE,
  paid_datetime     DATE,
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  line_id_start     CHAR(2),
  station_id_start  CHAR(2),
  line_id_end       CHAR(2),
  station_id_end    CHAR(2),
  deal_unit_fee     NUMBER(18,2),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  mobile_no         CHAR(11),
  balance_water_no  CHAR(10),
  file_name         VARCHAR2(30),
  check_flag        CHAR(1),
  err_code          CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_ERR_ORDER to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_ERR_ORDER to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_ERR_SALE
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_NP_ERR_SALE
(
  water_no            NUMBER(10),
  line_id             CHAR(2),
  station_id          CHAR(2),
  dev_type_id         CHAR(2),
  device_id           CHAR(3),
  sam_logical_id      CHAR(20),
  sam_trade_seq       NUMBER(18),
  sale_datetime       DATE,
  pay_type            CHAR(2),
  card_logical_id_pay CHAR(20),
  card_trade_seq      NUMBER(18),
  card_logical_id     CHAR(20),
  card_physical_id    CHAR(20),
  sale_fee            NUMBER(18,2),
  card_main_id        CHAR(2),
  card_sub_id         CHAR(2),
  zone_id             CHAR(2),
  tac                 CHAR(10),
  deposit_type        CHAR(2),
  deposit_fee         NUMBER(18,2),
  operator_id         CHAR(6),
  shift_id            CHAR(2),
  balance_water_no    CHAR(10),
  file_name           VARCHAR2(30),
  check_flag          CHAR(1),
  card_status_id      NUMBER(18),
  auxi_fee            NUMBER(18,2),
  card_count_used     NUMBER(18),
  card_app_flag       CHAR(1),
  tac_deal_type       CHAR(2) default '00',
  tac_dev_id          CHAR(12) default '000000000000',
  order_no            VARCHAR2(20),
  err_code            CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_ERR_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_ERR_SALE to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_QUE_ORDER_IMP
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_NP_QUE_ORDER_IMP
(
  water_no         NUMBER(18),
  order_no         VARCHAR2(20),
  order_type       CHAR(2),
  finish_datetime  DATE,
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10),
  file_name        VARCHAR2(30),
  check_flag       CHAR(1),
  err_code         CHAR(2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_NP_QUE_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_QUE_ORDER_IMP to ACC_ST_DEV;

prompt
prompt Creating table T#ST_NP_STS_ACC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_ACC
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  squad_day        CHAR(8),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_ACC
  is 'ª•¡™Õ¯÷ß∏∂ACC∂‘’À¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_ACC.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.T#ST_NP_STS_ACC.station_id
  is '≥µ’æID';
comment on column ACC_ST.T#ST_NP_STS_ACC.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.T#ST_NP_STS_ACC.deal_num
  is '≥‰÷µ ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ACC.deal_fee
  is '≥‰÷µΩ∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ACC.sale_num
  is '∑¢ € ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ACC.sale_fee
  is '∑¢ €Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ACC.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_ACC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_STS_ACC_RESULT
prompt =====================================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_ACC_RESULT
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  sale_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_ACC_RESULT
  is 'ª•¡™Õ¯÷ß∏∂ACC∂‘’À¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.station_id
  is '≥µ’æID';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.deal_num
  is '≥‰÷µ ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.deal_fee
  is '≥‰÷µΩ∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.sale_num
  is '∑¢ € ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.sale_fee
  is '∑¢ €Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ACC_RESULT.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_ACC_RESULT to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_ACC_RESULT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_ACC_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_STS_DEAL
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_DEAL
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deal_fee         NUMBER(18,2),
  deal_num         NUMBER(18),
  pay_mode_id      CHAR(2),
  card_app_flag    CHAR(1),
  balance_water_no CHAR(10),
  order_no         VARCHAR2(20)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_DEAL
  is 'ª•¡™Õ¯÷ß∏∂≥‰÷µÕ≥º∆¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_DEAL.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.station_id
  is '≥µ’æID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.dev_type_id
  is '…Ë±∏¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.device_id
  is '…Ë±∏ID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.card_main_id
  is '∆±ø®÷˜¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.card_sub_id
  is '∆±ø®◊”¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.T#ST_NP_STS_DEAL.deal_fee
  is 'Ωª“◊Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_DEAL.deal_num
  is ' ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_DEAL.pay_mode_id
  is '÷ß∏∂¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_DEAL.card_app_flag
  is 'ø®”¶”√±Í ∂';
comment on column ACC_ST.T#ST_NP_STS_DEAL.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.T#ST_NP_STS_DEAL.order_no
  is '∂©µ•∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_DEAL to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_DEAL to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_STS_LCC
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_LCC
(
  balance_water_no CHAR(10),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  charge_fee       NUMBER(18,2),
  charge_num       NUMBER(18),
  sale_fee         NUMBER(18,2),
  sale_num         NUMBER(18)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_LCC
  is 'ª•¡™Õ¯÷ß∏∂LCC∂‘’ÀÕ≥º∆¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_LCC.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.T#ST_NP_STS_LCC.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.T#ST_NP_STS_LCC.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.T#ST_NP_STS_LCC.station_id
  is '≥µ’æID';
comment on column ACC_ST.T#ST_NP_STS_LCC.charge_fee
  is '≥‰÷µ◊‹Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_LCC.charge_num
  is '≥‰÷µ◊‹ ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_LCC.sale_fee
  is '∑¢ €◊‹Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_LCC.sale_num
  is '∑¢ €◊‹ ˝¡ø';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_LCC to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_LCC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_LCC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_STS_ORDER
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_ORDER
(
  order_type        CHAR(2),
  status            CHAR(2),
  squad_day         CHAR(8),
  card_main_id      CHAR(2),
  card_sub_id       CHAR(2),
  order_num         NUMBER(18),
  deal_num          NUMBER(18),
  deal_fee          NUMBER(18,2),
  order_type_buy    CHAR(1),
  paid_channel_type CHAR(2),
  paid_channel_code CHAR(4),
  balance_water_no  CHAR(10)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_ORDER
  is 'ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”¡–¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_ORDER.order_type
  is '∂©µ•¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER.status
  is '∂©µ•◊¥Ã¨';
comment on column ACC_ST.T#ST_NP_STS_ORDER.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.T#ST_NP_STS_ORDER.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER.order_num
  is '∂©µ• ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ORDER.deal_num
  is '’≈ ˝';
comment on column ACC_ST.T#ST_NP_STS_ORDER.deal_fee
  is '◊‹Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ORDER.order_type_buy
  is '∂©µ•π∫∆±¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER.paid_channel_type
  is '÷ß∏∂«˛µ¿¿‡–Õ 01:“¯–– 02:“¯¡™ 03:µ⁄»˝∑Ω÷ß∏∂ 99:∆‰À˚';
comment on column ACC_ST.T#ST_NP_STS_ORDER.paid_channel_code
  is '÷ß∏∂«˛µ¿¥˙¬Î';
comment on column ACC_ST.T#ST_NP_STS_ORDER.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_ORDER to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_ORDER to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_ORDER to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_STS_ORDER_IMP
prompt ====================================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_ORDER_IMP
(
  order_type       CHAR(2),
  squad_day        CHAR(8),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  dev_code         CHAR(3),
  status           CHAR(2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  order_num        NUMBER(18),
  deal_num         NUMBER(18),
  deal_num_not     NUMBER(18),
  deal_fee         NUMBER(18,2),
  refund_fee       NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  balance_water_no CHAR(10)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_ORDER_IMP
  is 'ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”¡–¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.order_type
  is '∂©µ•¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.line_id
  is 'œﬂ¬∑¥˙¬Î';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.station_id
  is '’æµ„¥˙¬Î';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.dev_type_id
  is '…Ë±∏¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.dev_code
  is '…Ë±∏¥˙¬Î';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.status
  is '∂©µ•◊¥Ã¨';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.card_main_id
  is '∆±ø®÷˜¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.card_sub_id
  is '∆±ø®◊”¿‡–Õ';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.order_num
  is '∂©µ• ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.deal_num
  is '≥ˆ∆± ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.deal_num_not
  is 'Œ¥≥ˆ∆± ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.deal_fee
  is '≥ˆ∆±Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.refund_fee
  is 'ÕÀøÓΩ∂Ó';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.auxi_fee
  is 'ÕÀøÓ ÷–¯∑—';
comment on column ACC_ST.T#ST_NP_STS_ORDER_IMP.balance_water_no
  is '«ÂÀ„¡˜ÀÆ∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_ORDER_IMP to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_ORDER_IMP to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_ORDER_IMP to ACC_ST_RPT;

prompt
prompt Creating table T#ST_NP_STS_SALE
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_NP_STS_SALE
(
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sale_fee         NUMBER(18,2),
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  squad_day        CHAR(8),
  deposit_type     CHAR(2),
  deposit_fee      NUMBER(18,2),
  auxi_fee         NUMBER(18,2),
  sale_num         NUMBER(18),
  balance_water_no CHAR(10),
  card_app_flag    CHAR(1),
  order_no         VARCHAR2(20)
)
on commit delete rows;
comment on table ACC_ST.T#ST_NP_STS_SALE
  is 'ª•¡™Õ¯÷ß∏∂∑¢ €Õ≥º∆¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_NP_STS_SALE.line_id
  is 'œﬂ¬∑ID';
comment on column ACC_ST.T#ST_NP_STS_SALE.station_id
  is '≥µ’æID';
comment on column ACC_ST.T#ST_NP_STS_SALE.dev_type_id
  is '…Ë±∏¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_SALE.device_id
  is '…Ë±∏ID';
comment on column ACC_ST.T#ST_NP_STS_SALE.sale_fee
  is '∑¢ €Ω∂Ó';
comment on column ACC_ST.T#ST_NP_STS_SALE.card_main_id
  is '∆±ø®÷˜¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_SALE.card_sub_id
  is '∆±ø®◊”¿‡–ÕID';
comment on column ACC_ST.T#ST_NP_STS_SALE.squad_day
  is '‘À”™»’∆⁄';
comment on column ACC_ST.T#ST_NP_STS_SALE.deposit_type
  is '—∫Ω¿‡–Õ 00:—∫Ω
01:≥…±æ
02:≤ª π”√
';
comment on column ACC_ST.T#ST_NP_STS_SALE.deposit_fee
  is '—∫ΩΩ∂Ó';
comment on column ACC_ST.T#ST_NP_STS_SALE.auxi_fee
  is ' ÷–¯∑—';
comment on column ACC_ST.T#ST_NP_STS_SALE.sale_num
  is '«ÂÀ„¡˜ÀÆ∫≈';
comment on column ACC_ST.T#ST_NP_STS_SALE.balance_water_no
  is '∑¢ € ˝¡ø';
comment on column ACC_ST.T#ST_NP_STS_SALE.card_app_flag
  is 'ø®”¶”√±Í ∂0:∆’Õ®ø® 1:≤‚ ‘ø®';
comment on column ACC_ST.T#ST_NP_STS_SALE.order_no
  is '∂©µ•∫≈';
grant select, insert, update, delete on ACC_ST.T#ST_NP_STS_SALE to ACC_ST_APP;
grant select on ACC_ST.T#ST_NP_STS_SALE to ACC_ST_DEV;
grant select on ACC_ST.T#ST_NP_STS_SALE to ACC_ST_RPT;

prompt
prompt Creating table T#ST_QUE_LCC
prompt ===========================
prompt
create global temporary table ACC_ST.T#ST_QUE_LCC
(
  water_no                NUMBER(18),
  balance_water_no        CHAR(10),
  line_id                 CHAR(2),
  station_id              CHAR(2),
  bom_sale_sjt_num        NUMBER(18),
  bom_sale_sjt_fee        NUMBER(18,2),
  tvm_sale_sjt_num        NUMBER(18),
  tvm_sale_sjt_fee        NUMBER(18,2),
  bom_sale_num            NUMBER(18),
  bom_sale_deposit_fee    NUMBER(18,2),
  bom_charge_fee          NUMBER(18,2),
  tvm_charge_num          NUMBER(18),
  tvm_charge_fee          NUMBER(18,2),
  return_num              NUMBER(18),
  return_fee              NUMBER(18,2),
  non_return_num          NUMBER(18),
  non_ret_deposit_fee     NUMBER(18,2),
  non_ret_actual_ret_bala NUMBER(18,2),
  negative_charge_num     NUMBER(18),
  negative_charge_fee     NUMBER(18,2),
  deal_num                NUMBER(18),
  deal_fee                NUMBER(18,2),
  update_cash_num         NUMBER(18),
  update_cash_fee         NUMBER(18,2),
  update_noncash_num      NUMBER(18),
  update_noncash_fee      NUMBER(18,2),
  admin_num               NUMBER(18),
  admin_return_fee        NUMBER(18,2),
  admin_penalty_fee       NUMBER(18,2),
  file_name               VARCHAR2(30),
  check_flag              CHAR(1),
  account_date            CHAR(8)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_QUE_LCC to ACC_ST_APP;

prompt
prompt Creating table T#ST_RBK_DEAL_SVT
prompt ================================
prompt
create global temporary table ACC_ST.T#ST_RBK_DEAL_SVT
(
  balance_water_no CHAR(10),
  card_main_id     CHAR(2) not null,
  card_sub_id      CHAR(2) not null,
  card_logical_id  CHAR(20) not null,
  card_physical_id CHAR(20) not null,
  charge_num       NUMBER(18),
  consume_num      NUMBER(18),
  charge_fee       NUMBER(18,2),
  consume_fee      NUMBER(18,2),
  card_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(10),
  card_consume_seq NUMBER(10),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_RBK_DEAL_SVT to ACC_ST_APP;
grant select on ACC_ST.T#ST_RBK_DEAL_SVT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_RBK_DEAL_SVT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_RBK_MAX_SVT
prompt ===============================
prompt
create global temporary table ACC_ST.T#ST_RBK_MAX_SVT
(
  card_logical_id  CHAR(20) not null,
  card_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(18),
  card_consume_seq NUMBER(18),
  balance_water_no CHAR(10),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_RBK_MAX_SVT to ACC_ST_APP;

prompt
prompt Creating table T#ST_RESULTS_NON_RTN
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_RESULTS_NON_RTN
(
  card_logical_id    VARCHAR2(20),
  deposit_fee        NUMBER(7,2),
  card_balance_fee   NUMBER(12,2),
  actual_return_bala NUMBER(12,2),
  penalty            NUMBER(7,2),
  penalty_reason     VARCHAR2(12),
  audt               VARCHAR2(1),
  hdl_flag           VARCHAR2(1),
  apply_datetime     DATE
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#ST_RESULTS_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.T#ST_RESULTS_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_RESULTS_NON_RTN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_STS_INC_COUNT
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_STS_INC_COUNT
(
  cnt INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#ST_STS_INC_COUNT to ACC_ST_APP;
grant select on ACC_ST.T#ST_STS_INC_COUNT to ACC_ST_DEV;
grant select on ACC_ST.T#ST_STS_INC_COUNT to ACC_ST_RPT;

prompt
prompt Creating table T#ST_STS_INC_DAY_MAX
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_STS_INC_DAY_MAX
(
  max_squaddate CHAR(8)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#ST_STS_INC_DAY_MAX to ACC_ST_APP;
grant select on ACC_ST.T#ST_STS_INC_DAY_MAX to ACC_ST_DEV;
grant select on ACC_ST.T#ST_STS_INC_DAY_MAX to ACC_ST_RPT;

prompt
prompt Creating table T#ST_STS_INC_DAY_MIN
prompt ===================================
prompt
create global temporary table ACC_ST.T#ST_STS_INC_DAY_MIN
(
  min_squaddate CHAR(8)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#ST_STS_INC_DAY_MIN to ACC_ST_APP;
grant select on ACC_ST.T#ST_STS_INC_DAY_MIN to ACC_ST_DEV;
grant select on ACC_ST.T#ST_STS_INC_DAY_MIN to ACC_ST_RPT;

prompt
prompt Creating table T#ST_STS_INC_NO_MAX
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_STS_INC_NO_MAX
(
  max_water_no CHAR(10)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#ST_STS_INC_NO_MAX to ACC_ST_APP;
grant select on ACC_ST.T#ST_STS_INC_NO_MAX to ACC_ST_DEV;
grant select on ACC_ST.T#ST_STS_INC_NO_MAX to ACC_ST_RPT;

prompt
prompt Creating table T#ST_STS_SALE_HUNCH
prompt ==================================
prompt
create global temporary table ACC_ST.T#ST_STS_SALE_HUNCH
(
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  num              NUMBER
)
on commit delete rows;
comment on table ACC_ST.T#ST_STS_SALE_HUNCH
  is '¥¢÷µø®¬ﬂº≠ø®∫≈∑¢ €‘§∏≥÷µº«¬º¡Ÿ ±±Ì';
comment on column ACC_ST.T#ST_STS_SALE_HUNCH.card_logical_id
  is '¬ﬂº≠ø®∫≈';
comment on column ACC_ST.T#ST_STS_SALE_HUNCH.card_physical_id
  is 'ŒÔ¿Ìø®∫≈';
comment on column ACC_ST.T#ST_STS_SALE_HUNCH.num
  is 'º∆ ˝º«¬º';
grant select, insert, update, delete on ACC_ST.T#ST_STS_SALE_HUNCH to ACC_ST_APP;
grant select on ACC_ST.T#ST_STS_SALE_HUNCH to ACC_ST_DEV;
grant select on ACC_ST.T#ST_STS_SALE_HUNCH to ACC_ST_RPT;

prompt
prompt Creating table T#ST_SVT_LOGIC
prompt =============================
prompt
create global temporary table ACC_ST.T#ST_SVT_LOGIC
(
  card_main_id        CHAR(2) not null,
  card_sub_id         CHAR(2) not null,
  card_logical_id     CHAR(20) not null,
  card_physical_id    CHAR(20) not null,
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  hdl_time            DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_SVT_LOGIC to ACC_ST_APP;
grant select on ACC_ST.T#ST_SVT_LOGIC to ACC_ST_DEV;
grant select on ACC_ST.T#ST_SVT_LOGIC to ACC_ST_RPT;

prompt
prompt Creating table T#ST_SVT_LOGIC2
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_SVT_LOGIC2
(
  card_logical_id CHAR(20) not null,
  hdl_time        DATE,
  card_money      NUMBER(12,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_SVT_LOGIC2 to ACC_ST_APP;
grant select on ACC_ST.T#ST_SVT_LOGIC2 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_SVT_LOGIC2 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_SVT_LOGIC3
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_SVT_LOGIC3
(
  card_logical_id CHAR(20),
  max_datetime    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_SVT_LOGIC3 to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#ST_SVT_LOGIC3 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_SVT_LOGIC3 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_SVT_LOGIC4
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_SVT_LOGIC4
(
  card_logical_id  CHAR(20),
  deal_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(18),
  card_consume_seq NUMBER(18),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_SVT_LOGIC4 to ACC_ST_APP;
grant select on ACC_ST.T#ST_SVT_LOGIC4 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_SVT_LOGIC4 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_SVT_LOGIC5
prompt ==============================
prompt
create global temporary table ACC_ST.T#ST_SVT_LOGIC5
(
  card_logical_id  CHAR(20),
  deal_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(18),
  card_consume_seq NUMBER(18),
  card_status_id   CHAR(3),
  max_deal_time    DATE
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_SVT_LOGIC5 to ACC_ST_APP;
grant select on ACC_ST.T#ST_SVT_LOGIC5 to ACC_ST_DEV;
grant select on ACC_ST.T#ST_SVT_LOGIC5 to ACC_ST_RPT;

prompt
prompt Creating table T#ST_UP_ST_EXP_AUS
prompt =================================
prompt
create global temporary table ACC_ST.T#ST_UP_ST_EXP_AUS
(
  file_status          VARCHAR2(2),
  total_record_num_aus NUMBER(18),
  total_record_fee_aus NUMBER(18,2),
  total_record_num_auf NUMBER(18),
  total_record_fee_auf NUMBER(18,2),
  balance_water_no     CHAR(10),
  file_name            VARCHAR2(30)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#ST_UP_ST_EXP_AUS to ACC_ST_APP;
grant select on ACC_ST.T#ST_UP_ST_EXP_AUS to ACC_ST_DEV;
grant select on ACC_ST.T#ST_UP_ST_EXP_AUS to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_CHECK_SAM_RPT
prompt ====================================
prompt
create global temporary table ACC_ST.T#UP_OP_CHECK_SAM_RPT
(
  sam_no       VARCHAR2(16),
  line_name    VARCHAR2(10),
  station_name VARCHAR2(15),
  dev_type_id  VARCHAR2(2),
  device_id    VARCHAR2(4),
  sys_num      INTEGER,
  sam_num      INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_CHECK_SAM_RPT to ACC_ST_APP;
grant select on ACC_ST.T#UP_OP_CHECK_SAM_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#UP_OP_CHECK_SAM_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_CHECK_TRAN_RPT
prompt =====================================
prompt
create global temporary table ACC_ST.T#UP_OP_CHECK_TRAN_RPT
(
  linename  VARCHAR2(10),
  lineid    VARCHAR2(10),
  sys_type  VARCHAR2(10),
  errorname VARCHAR2(40),
  error_num INTEGER
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_CHECK_TRAN_RPT to ACC_ST_APP;
grant select on ACC_ST.T#UP_OP_CHECK_TRAN_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#UP_OP_CHECK_TRAN_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_MB_CONSUME_DAY_RESULT
prompt ============================================
prompt
create global temporary table ACC_ST.T#UP_OP_MB_CONSUME_DAY_RESULT
(
  day         VARCHAR2(20),
  line_01_num NUMBER(18),
  line_01_fee NUMBER(18,2),
  line_02_num NUMBER(18),
  line_02_fee NUMBER(18,2),
  line_60_num NUMBER(18),
  line_60_fee NUMBER(18,2),
  bus_num     NUMBER(18),
  bus_fee     NUMBER(18,2),
  total_num   NUMBER(18),
  total_fee   NUMBER(18,2)
)
on commit delete rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_MB_CONSUME_DAY_RESULT to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.T#UP_OP_MB_CONSUME_DAY_RESULT to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_RP_ERROR_DAY_RPT
prompt =======================================
prompt
create global temporary table ACC_ST.T#UP_OP_RP_ERROR_DAY_RPT
(
  linename     VARCHAR2(10),
  station_name VARCHAR2(15),
  dev_type_id  VARCHAR2(2),
  device_id    VARCHAR2(4),
  error_num    INTEGER,
  linecode     VARCHAR2(10)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_RP_ERROR_DAY_RPT to ACC_ST_APP;
grant select on ACC_ST.T#UP_OP_RP_ERROR_DAY_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#UP_OP_RP_ERROR_DAY_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_RP_ERROR_DAY_STATUS
prompt ==========================================
prompt
create global temporary table ACC_ST.T#UP_OP_RP_ERROR_DAY_STATUS
(
  status_datetime DATE not null,
  line_id         CHAR(2) not null,
  station_id      CHAR(2) not null,
  dev_type_id     CHAR(2) not null,
  device_id       CHAR(4) not null,
  status_id       CHAR(3) not null,
  status_value    CHAR(1)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_RP_ERROR_DAY_STATUS to ACC_ST_APP;
grant select on ACC_ST.T#UP_OP_RP_ERROR_DAY_STATUS to ACC_ST_DEV;
grant select on ACC_ST.T#UP_OP_RP_ERROR_DAY_STATUS to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_RP_ERROR_MON_RPT
prompt =======================================
prompt
create global temporary table ACC_ST.T#UP_OP_RP_ERROR_MON_RPT
(
  linename     VARCHAR2(10),
  station_name VARCHAR2(15),
  dev_type_id  VARCHAR2(2),
  device_id    VARCHAR2(4),
  error_num    INTEGER,
  linecode     VARCHAR2(10)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_RP_ERROR_MON_RPT to ACC_ST_APP;
grant select on ACC_ST.T#UP_OP_RP_ERROR_MON_RPT to ACC_ST_DEV;
grant select on ACC_ST.T#UP_OP_RP_ERROR_MON_RPT to ACC_ST_RPT;

prompt
prompt Creating table T#UP_OP_RP_ERROR_MON_STATUS
prompt ==========================================
prompt
create global temporary table ACC_ST.T#UP_OP_RP_ERROR_MON_STATUS
(
  status_datetime DATE not null,
  line_id         CHAR(2) not null,
  station_id      CHAR(2) not null,
  dev_type_id     CHAR(2) not null,
  device_id       CHAR(4) not null,
  status_id       CHAR(3) not null,
  status_value    CHAR(1)
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#UP_OP_RP_ERROR_MON_STATUS to ACC_ST_APP;
grant select on ACC_ST.T#UP_OP_RP_ERROR_MON_STATUS to ACC_ST_DEV;
grant select on ACC_ST.T#UP_OP_RP_ERROR_MON_STATUS to ACC_ST_RPT;

prompt
prompt Creating table T#_FLAGS_RETURN
prompt ==============================
prompt
create global temporary table ACC_ST.T#_FLAGS_RETURN
(
  tk_logic_no        VARCHAR2(16),
  amount             NUMBER(7,2),
  bala               NUMBER(12,2),
  actual_return_bala NUMBER(12,2),
  penalty            NUMBER(7,2),
  penalty_reason     VARCHAR2(12),
  audt               VARCHAR2(1),
  hdl_flag           VARCHAR2(1),
  tk_time            DATE
)
on commit preserve rows;
grant select, insert, update, delete on ACC_ST.T#_FLAGS_RETURN to ACC_ST_APP;
grant select on ACC_ST.T#_FLAGS_RETURN to ACC_ST_DEV;
grant select on ACC_ST.T#_FLAGS_RETURN to ACC_ST_RPT;

prompt
prompt Creating table TMP_COUNT_ST_DEAL1
prompt =================================
prompt
create table ACC_ST.TMP_COUNT_ST_DEAL1
(
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  pay_mode_id      CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_COUNT_ST_DEAL1 to ACC_ST_APP;
grant select on ACC_ST.TMP_COUNT_ST_DEAL1 to ACC_ST_DEV;

prompt
prompt Creating table TMP_COUNT_ST_DEAL2
prompt =================================
prompt
create table ACC_ST.TMP_COUNT_ST_DEAL2
(
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  pay_mode_id      CHAR(2)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_COUNT_ST_DEAL2 to ACC_ST_APP;
grant select on ACC_ST.TMP_COUNT_ST_DEAL2 to ACC_ST_DEV;

prompt
prompt Creating table TMP_COUNT_ST_DEAL3
prompt =================================
prompt
create table ACC_ST.TMP_COUNT_ST_DEAL3
(
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  deal_num         NUMBER(18),
  deal_fee         NUMBER(18,2),
  pay_mode_id      CHAR(2),
  card_balance_fee NUMBER(18,2),
  max_deal_time    DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_COUNT_ST_DEAL3 to ACC_ST_APP;
grant select on ACC_ST.TMP_COUNT_ST_DEAL3 to ACC_ST_DEV;

prompt
prompt Creating table TMP_PROCEDURE_FLOW
prompt =================================
prompt
create table ACC_ST.TMP_PROCEDURE_FLOW
(
  procedure_name   VARCHAR2(50),
  step             VARCHAR2(50),
  begin_time       DATE,
  end_time         DATE,
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_PROCEDURE_FLOW to ACC_ST_APP;
grant select, insert, update, delete on ACC_ST.TMP_PROCEDURE_FLOW to ACC_ST_DEV;

prompt
prompt Creating table TMP_ST_ACT_SVT
prompt =============================
prompt
create table ACC_ST.TMP_ST_ACT_SVT
(
  card_main_id        CHAR(2) not null,
  card_sub_id         CHAR(2) not null,
  card_logical_id     CHAR(20) not null,
  card_physical_id    CHAR(20) not null,
  total_charge_num    NUMBER(18),
  total_consume_num   NUMBER(18),
  total_charge_fee    NUMBER(18,2),
  total_consume_fee   NUMBER(18,2),
  system_balance_fee  NUMBER(18,2),
  card_balance_fee    NUMBER(18,2),
  old_expire_datetime DATE,
  new_expire_datetime DATE,
  card_charge_seq     NUMBER(18),
  card_consume_seq    NUMBER(18),
  balance_water_no    CHAR(10),
  card_status_id      CHAR(3),
  deposit_fee         NUMBER(18,2),
  card_money          NUMBER(12,2),
  max_deal_time       DATE
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 8K
    minextents 1
    maxextents unlimited
  );
alter table ACC_ST.TMP_ST_ACT_SVT
  add constraint TMP_ST_ACT_SVT_PK primary key (CARD_LOGICAL_ID, CARD_MAIN_ID)
  using index 
  tablespace TBS_ST_DATA
  pctfree 10
  initrans 2
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_ST_ACT_SVT to ACC_ST_APP;
grant select on ACC_ST.TMP_ST_ACT_SVT to ACC_ST_DEV;

prompt
prompt Creating table TMP_ST_DEAL
prompt ==========================
prompt
create table ACC_ST.TMP_ST_DEAL
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  deal_datetime    DATE,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  deal_fee         NUMBER(18,2),
  deal_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(18),
  card_consume_seq NUMBER(18),
  pay_mode_id      CHAR(2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_ST_DEAL to ACC_ST_APP;
grant select on ACC_ST.TMP_ST_DEAL to ACC_ST_DEV;

prompt
prompt Creating table TMP_ST_DEAL1
prompt ===========================
prompt
create table ACC_ST.TMP_ST_DEAL1
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  deal_datetime    DATE,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  deal_fee         NUMBER(18,2),
  deal_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(18),
  card_consume_seq NUMBER(18),
  pay_mode_id      CHAR(2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_ST_DEAL1 to ACC_ST_APP;
grant select on ACC_ST.TMP_ST_DEAL1 to ACC_ST_DEV;

prompt
prompt Creating table TMP_ST_DEAL2
prompt ===========================
prompt
create table ACC_ST.TMP_ST_DEAL2
(
  water_no         NUMBER(18),
  line_id          CHAR(2),
  station_id       CHAR(2),
  dev_type_id      CHAR(2),
  device_id        CHAR(3),
  sam_logical_id   CHAR(20),
  sam_trade_seq    NUMBER(18),
  deal_datetime    DATE,
  card_main_id     CHAR(2),
  card_sub_id      CHAR(2),
  card_logical_id  CHAR(20),
  card_physical_id CHAR(20),
  card_status_id   CHAR(3),
  deal_fee         NUMBER(18,2),
  deal_balance_fee NUMBER(18,2),
  card_charge_seq  NUMBER(18),
  card_consume_seq NUMBER(18),
  pay_mode_id      CHAR(2),
  balance_water_no CHAR(10)
)
tablespace TBS_ST_DATA
  pctfree 10
  initrans 1
  maxtrans 255
  storage
  (
    initial 64K
    next 1M
    minextents 1
    maxextents unlimited
  );
grant select, insert, update, delete on ACC_ST.TMP_ST_DEAL2 to ACC_ST_APP;
grant select on ACC_ST.TMP_ST_DEAL2 to ACC_ST_DEV;

prompt
prompt Creating sequence SEQ_CM_LOG_FTP
prompt ================================
prompt
create sequence ACC_ST.SEQ_CM_LOG_FTP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_CM_LOG_FTP to ACC_ST_APP;
grant select on ACC_ST.SEQ_CM_LOG_FTP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_CM_LOG_FTP to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_CM_QUE_MESSAGE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_CM_QUE_MESSAGE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_CM_QUE_MESSAGE to ACC_ST_APP;
grant select on ACC_ST.SEQ_CM_QUE_MESSAGE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_CM_QUE_MESSAGE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_CM_CONNECT_LOG
prompt =======================================
prompt
create sequence ACC_ST.SEQ_OP_CM_CONNECT_LOG
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_CM_CONNECT_LOG to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_CM_CONNECT_LOG to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_CM_CONNECT_LOG to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_CM_DEV_PARA_VER_HIS
prompt ============================================
prompt
create sequence ACC_ST.SEQ_OP_CM_DEV_PARA_VER_HIS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_CM_DEV_PARA_VER_HIS to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_CM_DEV_PARA_VER_HIS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_CM_DEV_PARA_VER_HIS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_CM_DEV_PARA_VER_QRY
prompt ============================================
prompt
create sequence ACC_ST.SEQ_OP_CM_DEV_PARA_VER_QRY
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_CM_DEV_PARA_VER_QRY to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_CM_DEV_PARA_VER_QRY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_CM_DEV_PARA_VER_QRY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_CM_LOG_PARA_FLE_CHK
prompt ============================================
prompt
create sequence ACC_ST.SEQ_OP_CM_LOG_PARA_FLE_CHK
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_CM_LOG_PARA_FLE_CHK to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_CM_LOG_PARA_FLE_CHK to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_CM_LOG_PARA_FLE_CHK to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_DM_TASK_LOG
prompt ====================================
prompt
create sequence ACC_ST.SEQ_OP_DM_TASK_LOG
minvalue 1
maxvalue 9999999999999999999999999999
start with 62131
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_DM_TASK_LOG to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_DM_TASK_LOG to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_DM_TASK_LOG to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_IMPORT
prompt ===================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_IMPORT
minvalue 1
maxvalue 9999999999999999999999999999
start with 16471
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_LOG_IMPORT to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_IMPORT to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_IMPORT to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_PRM_OPERATE
prompt ========================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_PRM_OPERATE
minvalue 1
maxvalue 9999999999999999999999999999
start with 17536
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_LOG_PRM_OPERATE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_PRM_OPERATE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_PRM_OPERATE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_REPORT_DETAIL
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_REPORT_DETAIL
minvalue 1
maxvalue 9999999999999999999999999999
start with 345271
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_LOG_REPORT_DETAIL to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_REPORT_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_REPORT_DETAIL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_REPORT_TOTAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_REPORT_TOTAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 11191
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_LOG_REPORT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_REPORT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_REPORT_TOTAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_SAM_LIST_OPERATION
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_SAM_LIST_OPERATION
minvalue 1
maxvalue 9999999999999999999999999999
start with 4551
increment by 1
cache 10;
grant select on ACC_ST.SEQ_OP_LOG_SAM_LIST_OPERATION to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_SAM_LIST_OPERATION to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_SAM_LIST_OPERATION to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_USER_ACCESS
prompt ========================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_USER_ACCESS
minvalue 1
maxvalue 9999999999999999999999999999
start with 50477
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_COMMU_APP;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_MONITOR_APP;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_ONLINE_APP;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_ONLINE_DEV;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_ST_RPT;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_TK_APP;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_TK_DEV;
grant select on ACC_ST.SEQ_OP_LOG_USER_ACCESS to ACC_TK_RPT;


prompt
prompt Creating sequence SEQ_OP_LOG_USER_OPERATE
prompt =========================================
prompt
create sequence ACC_ST.SEQ_OP_LOG_USER_OPERATE
minvalue 1
maxvalue 9999999999999999999999999999
start with 37303
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_LOG_USER_OPERATE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_LOG_USER_OPERATE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_LOG_USER_OPERATE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_MB_INFO
prompt ================================
prompt
create sequence ACC_ST.SEQ_OP_MB_INFO
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select, alter on ACC_ST.SEQ_OP_MB_INFO to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_OP_MB_INFO_DETAIL
prompt =======================================
prompt
create sequence ACC_ST.SEQ_OP_MB_INFO_DETAIL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select, alter on ACC_ST.SEQ_OP_MB_INFO_DETAIL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_OP_PRM_ADMIN_MANAGER_TYPE
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_ADMIN_MANAGER_TYPE
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_ADMIN_MANAGER_TYPE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_ADMIN_MANAGER_TYPE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_ADMIN_MANAGER_TYPE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_CARD_BLACK_LIST
prompt ============================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_CARD_BLACK_LIST
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_CARD_BLACK_LIST to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_CARD_BLACK_LIST to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_CARD_BLACK_LIST to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_CARD_PARA
prompt ======================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_CARD_PARA
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_CARD_PARA to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_CARD_PARA to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_CARD_PARA to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_CARD_TCT_ATTR
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_CARD_TCT_ATTR
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_CARD_TCT_ATTR to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_CARD_TCT_ATTR to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_CARD_TCT_ATTR to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_CHANGE_DETAIL
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_CHANGE_DETAIL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1246
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_CHANGE_DETAIL to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_CHANGE_DETAIL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_CHANGE_DETAIL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_DEGRADE_MODE_RECD
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_DEGRADE_MODE_RECD
minvalue 1
maxvalue 2147483647
start with 383
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_DEGRADE_MODE_RECD to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_DEGRADE_MODE_RECD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_DEGRADE_MODE_RECD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_DEV_CODE
prompt =====================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_DEV_CODE
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_DEV_CODE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_DEV_CODE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_DEV_CODE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_DEV_CONTRL
prompt =======================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_DEV_CONTRL
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_DEV_CONTRL to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_DEV_CONTRL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_DEV_CONTRL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_DEV_PROGRAM
prompt ========================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_DEV_PROGRAM
minvalue 1
maxvalue 9999999999999999999999999999
start with 486
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_DEV_PROGRAM to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_DEV_PROGRAM to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_DEV_PROGRAM to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_FARE_CONF
prompt ======================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_FARE_CONF
minvalue 1
maxvalue 9999999999999999999999999999
start with 6817
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_FARE_CONF to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_FARE_CONF to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_FARE_CONF to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_FARE_TABLE
prompt =======================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_FARE_TABLE
minvalue 1
maxvalue 9999999999999999999999999999
start with 4557
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_FARE_TABLE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_FARE_TABLE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_FARE_TABLE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_FARE_ZONE
prompt ======================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_FARE_ZONE
minvalue 1
maxvalue 9999999999999999999999999999
start with 58809
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_FARE_ZONE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_FARE_ZONE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_FARE_ZONE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_GATE_VOICE_PROMP
prompt =============================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_GATE_VOICE_PROMP
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_GATE_VOICE_PROMP to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_GATE_VOICE_PROMP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_GATE_VOICE_PROMP to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_HOLIDAY_TABLE
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_HOLIDAY_TABLE
minvalue 1
maxvalue 9999999999999999999999999999
start with 873
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_HOLIDAY_TABLE to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_HOLIDAY_TABLE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_HOLIDAY_TABLE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_OFF_PEAK_HOURS
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_OFF_PEAK_HOURS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1247
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_OFF_PEAK_HOURS to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_OFF_PEAK_HOURS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_OFF_PEAK_HOURS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_PARA_VER_NOW
prompt =========================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_PARA_VER_NOW
minvalue 1
maxvalue 9999999999999999999999999999
start with 14643
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_PARA_VER_NOW to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_PARA_VER_NOW to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_PARA_VER_NOW to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_SAM_LIST
prompt =====================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_SAM_LIST
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_SAM_LIST to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_SAM_LIST to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_SAM_LIST to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_STATION
prompt ====================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_STATION
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_STATION to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_STATION to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_STATION to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_TRANSFER_STATION
prompt =============================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_TRANSFER_STATION
minvalue 1
maxvalue 2147483647
start with 1
increment by 1
cache 10
cycle;
grant select on ACC_ST.SEQ_OP_PRM_TRANSFER_STATION to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_TRANSFER_STATION to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_TRANSFER_STATION to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_OP_PRM_TVM_STOPSELL_CONFIG
prompt ================================================
prompt
create sequence ACC_ST.SEQ_OP_PRM_TVM_STOPSELL_CONFIG
minvalue 1
maxvalue 9999999999999999999999999999
start with 287
increment by 1
cache 20;
grant select on ACC_ST.SEQ_OP_PRM_TVM_STOPSELL_CONFIG to ACC_ST_APP;
grant select on ACC_ST.SEQ_OP_PRM_TVM_STOPSELL_CONFIG to ACC_ST_DEV;
grant select on ACC_ST.SEQ_OP_PRM_TVM_STOPSELL_CONFIG to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_SR_DISTANCE_OD
prompt ====================================
prompt
create sequence ACC_ST.SEQ_SR_DISTANCE_OD
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_SR_DISTANCE_OD to ACC_ST_APP;
grant select on ACC_ST.SEQ_SR_DISTANCE_OD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_SR_DISTANCE_OD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_SR_LOG
prompt ============================
prompt
create sequence ACC_ST.SEQ_SR_LOG
minvalue 1
maxvalue 9999999999999999999999999999
start with 101
increment by 1
cache 10;
grant select on ACC_ST.SEQ_SR_LOG to ACC_ST_APP;
grant select on ACC_ST.SEQ_SR_LOG to ACC_ST_DEV;
grant select on ACC_ST.SEQ_SR_LOG to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_SR_PARAMS_THRESHOLD
prompt =========================================
prompt
create sequence ACC_ST.SEQ_SR_PARAMS_THRESHOLD
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;
grant select on ACC_ST.SEQ_SR_PARAMS_THRESHOLD to ACC_ST_APP;
grant select on ACC_ST.SEQ_SR_PARAMS_THRESHOLD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_SR_PARAMS_THRESHOLD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_STS_DIFF_ANALYSIS
prompt =======================================
prompt
create sequence ACC_ST.SEQ_STS_DIFF_ANALYSIS
minvalue 1
maxvalue 9999999999999999999999999999
start with 15661
increment by 1
cache 10;
grant select on ACC_ST.SEQ_STS_DIFF_ANALYSIS to ACC_ST_APP;
grant select on ACC_ST.SEQ_STS_DIFF_ANALYSIS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_STS_DIFF_ANALYSIS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BALANCE_ROLLBACK_STEP
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_BALANCE_ROLLBACK_STEP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BALANCE_ROLLBACK_STEP to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BALANCE_ROLLBACK_STEP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BALANCE_ROLLBACK_STEP to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_ADMIN
prompt ==================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_ADMIN
minvalue 1
maxvalue 9999999999999999999999999999
start with 299071
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_ADMIN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_ADMIN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_AGM_CARD_DATA
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_AGM_CARD_DATA
minvalue 1
maxvalue 9999999999999999999999999999
start with 874581
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_AGM_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_AGM_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_AGM_CARD_DATA to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_AGM_CUTOFF_TOTAL
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_AGM_CUTOFF_TOTAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 770121
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_AGM_CUTOFF_TOTAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_BOM_SHIFT_TOTAL
prompt ============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_BOM_SHIFT_TOTAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 166881
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_BOM_SHIFT_TOTAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_DEAL
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 548224661
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_DEAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_DEAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_DEAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_DELAY
prompt ==================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_DELAY
minvalue 1
maxvalue 9999999999999999999999999999
start with 8161
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_DELAY to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_DELAY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_DELAY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_ENTRY
prompt ==================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_ENTRY
minvalue 1
maxvalue 9999999999999999999999999999
start with 543200471
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_ENTRY to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_ENTRY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_LCC
prompt ================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 49821
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_LCC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_LCC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_LCC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_LOCK
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_LOCK
minvalue 1
maxvalue 9999999999999999999999999999
start with 8341
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_LOCK to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_LOCK to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_LOCK to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_NON_RTN_APP
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_NON_RTN_APP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1391
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_NON_RTN_APP to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_REG_TOTAL
prompt ======================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_REG_TOTAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 128030041
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_REG_TOTAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_REG_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_REG_TOTAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_REPORT_LOSS
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_REPORT_LOSS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_BUF_REPORT_LOSS to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_BUF_RETURN
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_RETURN
minvalue 1
maxvalue 9999999999999999999999999999
start with 380861
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_RETURN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_RETURN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_RETURN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_SALE
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1795811
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_SALE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_SALE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_SALE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_SALE_SJT
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_SALE_SJT
minvalue 1
maxvalue 9999999999999999999999999999
start with 242148981
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_SALE_SJT to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_SIGN_CARD_APPLY
prompt ============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_SIGN_CARD_APPLY
minvalue 1
maxvalue 9999999999999999999999999999
start with 176171
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_SIGN_CARD_APPLY to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_SIGN_CARD_APPLY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_SIGN_CARD_APPLY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_AUTO_BAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_AUTO_BAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 301761
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_BUF_TVM_AUTO_BAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_BAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_BAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 159641
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_BUF_TVM_BAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_CARD_CLEAR
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_CARD_CLEAR
minvalue 1
maxvalue 9999999999999999999999999999
start with 146641
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CARD_CLEAR to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CARD_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CARD_CLEAR to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_CARD_PUT
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_CARD_PUT
minvalue 1
maxvalue 9999999999999999999999999999
start with 551161
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CARD_PUT to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CARD_PUT to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CARD_PUT to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_COIN_CLEAR
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_COIN_CLEAR
minvalue 1
maxvalue 9999999999999999999999999999
start with 509061
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_CLEAR to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_CLEAR to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_CLEAR to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_COIN_DATA
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_COIN_DATA
minvalue 1
maxvalue 9999999999999999999999999999
start with 499581
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_DATA to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_DATA to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_DATA to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_COIN_PUT
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_COIN_PUT
minvalue 1
maxvalue 9999999999999999999999999999
start with 435301
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_PUT to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_PUT to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_COIN_PUT to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_CUTOFF_TOTAL
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_CUTOFF_TOTAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 421211
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_CUTOFF_TOTAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_NOTE_CHG_POP
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_NOTE_CHG_POP
minvalue 1
maxvalue 9999999999999999999999999999
start with 197301
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_BUF_TVM_NOTE_CHG_POP to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_NOTE_CHG_PUT
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_NOTE_CHG_PUT
minvalue 1
maxvalue 9999999999999999999999999999
start with 212081
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_BUF_TVM_NOTE_CHG_PUT to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_NOTE_DATA
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_NOTE_DATA
minvalue 1
maxvalue 9999999999999999999999999999
start with 776631
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_NOTE_DATA to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_NOTE_DATA to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_NOTE_DATA to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_NOTE_RECLAIM
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_NOTE_RECLAIM
minvalue 1
maxvalue 9999999999999999999999999999
start with 34761
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_BUF_TVM_NOTE_RECLAIM to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_BUF_TVM_WASTE_CARD_DATA
prompt ================================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_TVM_WASTE_CARD_DATA
minvalue 1
maxvalue 9999999999999999999999999999
start with 21421
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_TVM_WASTE_CARD_DATA to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_BUF_UPDATE
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_BUF_UPDATE
minvalue 1
maxvalue 9999999999999999999999999999
start with 7040851
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_BUF_UPDATE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_BUF_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_BUF_UPDATE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_CM_LOG_REPORT_LOSS
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_ST_CM_LOG_REPORT_LOSS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_CM_LOG_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_CM_LOG_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_CM_LOG_REPORT_LOSS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_CM_RESULT_REPORT_LOSS
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_CM_RESULT_REPORT_LOSS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_CM_RESULT_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_CM_RESULT_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_CM_RESULT_REPORT_LOSS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_ADMIN
prompt ==================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_ADMIN
minvalue 1
maxvalue 9999999999999999999999999999
start with 71
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_ADMIN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_ADMIN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_ADMIN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_DEAL
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 7001
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_DEAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_DEAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_DEAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_DELAY
prompt ==================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_DELAY
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_DELAY to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_DELAY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_DELAY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_ENTRY
prompt ==================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_ENTRY
minvalue 1
maxvalue 9999999999999999999999999999
start with 981
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_ENTRY to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_ENTRY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_ENTRY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_LOCK
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_LOCK
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_LOCK to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_LOCK to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_LOCK to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_NON_RTN_APP
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_NON_RTN_APP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_NON_RTN_APP to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_NON_RTN_APP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_NON_RTN_APP to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_REPORT_LOSS
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_REPORT_LOSS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_ERR_REPORT_LOSS to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_ERR_RETURN
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_RETURN
minvalue 1
maxvalue 9999999999999999999999999999
start with 71
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_RETURN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_RETURN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_RETURN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_SALE
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 2011
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_SALE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_SALE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_SALE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_SALE_SJT
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_SALE_SJT
minvalue 1
maxvalue 9999999999999999999999999999
start with 1481
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_SALE_SJT to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_SALE_SJT to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_SALE_SJT to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_SAM_WATER
prompt ======================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_SAM_WATER
minvalue 1
maxvalue 9999999999999999999999999999
start with 10649171
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_SAM_WATER to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_SAM_WATER to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_SAM_WATER to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_SIGN_CARD
prompt ======================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_SIGN_CARD
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_SIGN_CARD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_SIGN_CARD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_SIGN_CARD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_ERR_UPDATE
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_ERR_UPDATE
minvalue 1
maxvalue 9999999999999999999999999999
start with 611
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_ERR_UPDATE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_ERR_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_ERR_UPDATE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_AUDIT_BALANCE
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_AUDIT_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 7035541
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_AUDIT_BALANCE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_AUDIT_FILE_STL
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_AUDIT_FILE_STL
minvalue 1
maxvalue 9999999999999999999999999999
start with 11541
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_AUDIT_FILE_STL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_AUDIT_FILE_TRX
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_AUDIT_FILE_TRX
minvalue 1
maxvalue 9999999999999999999999999999
start with 20841
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_AUDIT_FILE_TRX to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_AUDIT_STATUS
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_AUDIT_STATUS
minvalue 1
maxvalue 9999999999999999999999999999
start with 13781
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_AUDIT_STATUS to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_BLACKLIST
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_BLACKLIST
minvalue 1
maxvalue 9999999999999999999999999999
start with 4168461
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_EXT_MTR_BLACKLIST to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_BLL_APPLY
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_BLL_APPLY
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_BLL_APPLY to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_BUF_DEAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_BUF_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 231641381
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_BUF_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_ERR_DEAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_ERR_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1116301
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_ERR_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_ERR_TRADE
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_ERR_TRADE
minvalue 1
maxvalue 9999999999999999999999999999
start with 4097341
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_ERR_TRADE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_HIS_DEAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_HIS_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 226745221
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_HIS_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_MTR_QUE_DEAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_MTR_QUE_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_MTR_QUE_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_AUDIT_BALANCE
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_AUDIT_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1141761
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_BALANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_AUDIT_FILE
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_AUDIT_FILE_STL
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE_STL
minvalue 1
maxvalue 9999999999999999999999999999
start with 18921
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE_STL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_AUDIT_FILE_TRX
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE_TRX
minvalue 1
maxvalue 9999999999999999999999999999
start with 10661
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_FILE_TRX to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_AUDIT_STATUS
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_AUDIT_STATUS
minvalue 1
maxvalue 9999999999999999999999999999
start with 12661
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_STATUS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_EXT_OCT_AUDIT_STATUS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_BLACKLIST
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_BLACKLIST
minvalue 1
maxvalue 9999999999999999999999999999
start with 25882381
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_EXT_OCT_BLACKLIST to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_EXT_OCT_BLACKLIST to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_EXT_OCT_BLACKLIST to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_EXT_OCT_ERR_TRADE
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_EXT_OCT_ERR_TRADE
minvalue 1
maxvalue 9999999999999999999999999999
start with 667701
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_EXT_OCT_ERR_TRADE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_EXT_OCT_ERR_TRADE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_EXT_OCT_ERR_TRADE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_FLOW_NON_RTN
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_FLOW_NON_RTN
minvalue 1
maxvalue 9999999999999999999999999999
start with 2101
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_FLOW_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_FLOW_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_FLOW_NON_RTN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_HIS_DEAL
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_HIS_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_HIS_DEAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_HIS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_HIS_DEAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_HIS_DENY
prompt =================================
prompt
create sequence ACC_ST.SEQ_ST_HIS_DENY
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_HIS_DENY to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_HIS_DENY to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_HIS_DENY to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_HIS_NON_RTN
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_HIS_NON_RTN
minvalue 1
maxvalue 9999999999999999999999999999
start with 175861
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_HIS_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_HIS_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_HIS_NON_RTN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_HIS_UPDATE
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_HIS_UPDATE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_HIS_UPDATE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_HIS_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_HIS_UPDATE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_LIST_BALANCE_CAL
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_LIST_BALANCE_CAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 261
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_LIST_BALANCE_CAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_LIST_BALANCE_CAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_LIST_BALANCE_CAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_LIST_NON_RTN
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_LIST_NON_RTN
minvalue 1
maxvalue 9999999999999999999999999999
start with 1191
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_LIST_NON_RTN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_LIST_NON_RTN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_LIST_NON_RTN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_LIST_REPORT_LOSS
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_LIST_REPORT_LOSS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_LIST_REPORT_LOSS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_LIST_REPORT_LOSS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_LIST_REPORT_LOSS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_LIST_SAM_WATER
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_LIST_SAM_WATER
minvalue 1
maxvalue 9999999999999999999999999999
start with 1800441
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_LIST_SAM_WATER to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_LIST_SAM_WATER to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_LIST_SAM_WATER to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_LIST_SIGN_CARD
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_LIST_SIGN_CARD
minvalue 1
maxvalue 9999999999999999999999999999
start with 175901
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_LIST_SIGN_CARD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_LIST_SIGN_CARD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_LIST_SIGN_CARD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_LIST_SIGN_CARD_REMAKE
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_LIST_SIGN_CARD_REMAKE
minvalue 1
maxvalue 9999999999999999999999999999
start with 9421
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_LIST_SIGN_CARD_REMAKE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_LOG_BALANCE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_LOG_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 5411
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_LOG_BALANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_LOG_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_LOG_BALANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_BUF_DEAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_BUF_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 389121
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_BUF_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_BUF_LCC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_MB_BUF_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 12981
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_BUF_LCC to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_BUF_LOCK
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_BUF_LOCK
minvalue 1
maxvalue 9999999999999999999999999999
start with 161
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_BUF_LOCK to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_BUF_RETURN
prompt ======================================
prompt
create sequence ACC_ST.SEQ_ST_MB_BUF_RETURN
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_BUF_RETURN to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_BUF_SALE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_BUF_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 9601
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_BUF_SALE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_ERR_DEAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_ERR_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 3341
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_ERR_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_ERR_LCC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_MB_ERR_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_ERR_LCC to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_ERR_LOCK
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_ERR_LOCK
minvalue 1
maxvalue 9999999999999999999999999999
start with 61
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_ERR_LOCK to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_ERR_RETURN
prompt ======================================
prompt
create sequence ACC_ST.SEQ_ST_MB_ERR_RETURN
minvalue 1
maxvalue 9999999999999999999999999999
start with 21
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_ERR_RETURN to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_ERR_SALE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_ERR_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 121
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_MB_ERR_SALE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_MB_EXT_STS_DEAL_BUS
prompt ============================================
prompt
create sequence ACC_ST.SEQ_ST_MB_EXT_STS_DEAL_BUS
minvalue 1
maxvalue 9999999999999999999999999999
start with 39541
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_EXT_STS_DEAL_BUS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_EXT_STS_DEAL_BUS to ACC_ST_DEV;


prompt
prompt Creating sequence SEQ_ST_MB_EXT_STS_DEAL_LINE
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_MB_EXT_STS_DEAL_LINE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_EXT_STS_DEAL_LINE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_EXT_STS_DEAL_LINE to ACC_ST_DEV;


prompt
prompt Creating sequence SEQ_ST_MB_STS_ACC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 3161
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_ACC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_COLLECT_STATUS
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_COLLECT_STATUS
minvalue 1
maxvalue 9999999999999999999999999999
start with 55441
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_COLLECT_STATUS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_COLLECT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_COLLECT_STATUS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_DEAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 4441
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_DEAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_DEAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_EXCEPT_BALANCE
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_EXCEPT_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 481
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_EXCEPT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_EXCEPT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_EXCEPT_BALANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_LCC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 3021
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_LCC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_LCC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_LCC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_LCC_ACC
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_LCC_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 3515
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_LCC_ACC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_LCC_ACC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_LCC_ACC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_LOCK
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_LOCK
minvalue 1
maxvalue 9999999999999999999999999999
start with 81
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_LOCK to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_LOCK to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_LOCK to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_RETURN
prompt ======================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_RETURN
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_RETURN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_RETURN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_RETURN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_MB_STS_SALE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_MB_STS_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 3851
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_MB_STS_SALE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_MB_STS_SALE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_MB_STS_SALE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_BUF_DEAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_BUF_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_BUF_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_BUF_LCC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_NP_BUF_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 9201
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_BUF_LCC to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_BUF_ORDER
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_BUF_ORDER
minvalue 1
maxvalue 9999999999999999999999999999
start with 203721
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_BUF_ORDER to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_BUF_ORDER_IMP
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_NP_BUF_ORDER_IMP
minvalue 1
maxvalue 9999999999999999999999999999
start with 889981
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_BUF_ORDER_IMP to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_BUF_SALE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_BUF_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1046781
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_BUF_SALE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_ERR_DEAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_ERR_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_ERR_DEAL to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_ERR_LCC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_NP_ERR_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_ERR_LCC to ACC_ST_DEV;


prompt
prompt Creating sequence SEQ_ST_NP_ERR_ORDER
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_ERR_ORDER
minvalue 1
maxvalue 9999999999999999999999999999
start with 1781
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_ERR_ORDER to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_ERR_ORDER_IMP
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_NP_ERR_ORDER_IMP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1781
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_ERR_ORDER_IMP to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_ERR_SALE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_ERR_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 121
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_NP_ERR_SALE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_NP_STS_ACC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 4571
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_ACC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_COLLECT_STATUS
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_COLLECT_STATUS
minvalue 1
maxvalue 9999999999999999999999999999
start with 169191
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_COLLECT_STATUS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_COLLECT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_COLLECT_STATUS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_DEAL
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_DEAL
minvalue 1
maxvalue 9999999999999999999999999999
start with 2211
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_DEAL to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_DEAL to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_DEAL to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_EXCEPT_BALANCE
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_EXCEPT_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 191
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_EXCEPT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_EXCEPT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_EXCEPT_BALANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_LCC
prompt ===================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_LCC
minvalue 1
maxvalue 9999999999999999999999999999
start with 4591
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_LCC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_LCC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_LCC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_LCC_ACC
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_LCC_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 4551
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_LCC_ACC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_LCC_ACC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_LCC_ACC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_ORDER
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_ORDER
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_ORDER to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_ORDER to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_ORDER to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_ORDERIMP
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_ORDERIMP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_ORDERIMP to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_ORDERIMP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_ORDERIMP to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_NP_STS_SALE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_NP_STS_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 8851
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_NP_STS_SALE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_NP_STS_SALE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_NP_STS_SALE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_QUE_MESSAGE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_QUE_MESSAGE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_QUE_MESSAGE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_QUE_MESSAGE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_QUE_MESSAGE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_QUE_REPORT_LOSS
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_QUE_REPORT_LOSS
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_QUE_REPORT_LOSS to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_STS_ACC
prompt ================================
prompt
create sequence ACC_ST.SEQ_ST_STS_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 47991
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_ACC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_ACC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_ACC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_BALANCE_CONTC_INC
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_BALANCE_CONTC_INC
minvalue 1
maxvalue 9999999999999999999999999999
start with 26111
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_CONTC_INC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_CONTC_INC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_CONTC_INC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_BALANCE_CONTC_TRD
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_BALANCE_CONTC_TRD
minvalue 1
maxvalue 9999999999999999999999999999
start with 72751
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_CONTC_TRD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_CONTC_TRD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_CONTC_TRD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_BALANCE_LINE_INC
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_BALANCE_LINE_INC
minvalue 1
maxvalue 9999999999999999999999999999
start with 44351
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_LINE_INC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_LINE_INC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_LINE_INC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_BALANCE_LINE_TRD
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_BALANCE_LINE_TRD
minvalue 1
maxvalue 9999999999999999999999999999
start with 72491
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_LINE_TRD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_LINE_TRD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_BALANCE_LINE_TRD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_BOM_GET
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_STS_BOM_GET
minvalue 1
maxvalue 9999999999999999999999999999
start with 3933171
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_BOM_GET to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_BOM_GET to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_BOM_GET to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_COLLECT_STATUS
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_COLLECT_STATUS
minvalue 1
maxvalue 9999999999999999999999999999
start with 12840931
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_COLLECT_STATUS to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_COLLECT_STATUS to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_COLLECT_STATUS to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_DISPART_CONTC
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_DISPART_CONTC
minvalue 1
maxvalue 9999999999999999999999999999
start with 14231
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_DISPART_CONTC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_DISPART_CONTC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_DISPART_CONTC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_EXCEPT_BALANCE
prompt ===========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_EXCEPT_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 14621
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_EXCEPT_BALANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_EXCEPT_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_EXCEPT_BALANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_FLW_AVE_DISTANCE
prompt =============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_FLW_AVE_DISTANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 55091
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_FLW_AVE_DISTANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_FLW_AVE_DISTANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_FLW_AVE_DISTANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_FLW_LINE_CARD
prompt ==========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_FLW_LINE_CARD
minvalue 1
maxvalue 9999999999999999999999999999
start with 411931
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_FLW_LINE_CARD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_FLW_LINE_CARD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_FLW_LINE_CARD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_FLW_STATION
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_FLW_STATION
minvalue 1
maxvalue 9999999999999999999999999999
start with 6380361
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_FLW_STATION to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_FLW_STATION to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_FLW_STATION to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INCOME_CONTC_CARD
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INCOME_CONTC_CARD
minvalue 1
maxvalue 9999999999999999999999999999
start with 29981
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INCOME_CONTC_CARD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INCOME_CONTC_CARD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INCOME_CONTC_CARD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INCOM_CONTC_SECTION
prompt ================================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INCOM_CONTC_SECTION
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INCOM_CONTC_SECTION to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INCOM_CONTC_SECTION to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INCOM_CONTC_SECTION to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_BALANCE
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 913501
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_BALANCE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_BALANCE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_BALANCE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_BALANCE_EXPIRED
prompt ================================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_BALANCE_EXPIRED
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_BALANCE_EXPIRED to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_BALANCE_EXPIRED to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_BALANCE_EXPIRED to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_CHARGE
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_CHARGE
minvalue 1
maxvalue 9999999999999999999999999999
start with 147471
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_CHARGE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_CHARGE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_CHARGE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_CONSUME
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_CONSUME
minvalue 1
maxvalue 9999999999999999999999999999
start with 414071
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_CONSUME to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_CONSUME to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_CONSUME to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_CONTC_CARD_MODE
prompt ================================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_CONTC_CARD_MODE
minvalue 1
maxvalue 9999999999999999999999999999
start with 88831
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_CONTC_CARD_MODE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_CONTC_CARD_MODE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_CONTC_CARD_MODE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_FARE
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_FARE
minvalue 1
maxvalue 9999999999999999999999999999
start with 201211
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_FARE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_FARE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_FARE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_RETURN
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_RETURN
minvalue 1
maxvalue 9999999999999999999999999999
start with 74471
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_RETURN to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_RETURN to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_RETURN to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_SALE
prompt =====================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_SALE
minvalue 1
maxvalue 9999999999999999999999999999
start with 142371
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_SALE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_SALE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_SALE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_INC_UPDATE
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_STS_INC_UPDATE
minvalue 1
maxvalue 9999999999999999999999999999
start with 375851
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_INC_UPDATE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_INC_UPDATE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_INC_UPDATE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_LCC_ACC
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_STS_LCC_ACC
minvalue 1
maxvalue 9999999999999999999999999999
start with 48191
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_LCC_ACC to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_LCC_ACC to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_LCC_ACC to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_MTR_AUDIT_BALANCE
prompt ==============================================
prompt
create sequence ACC_ST.SEQ_ST_STS_MTR_AUDIT_BALANCE
minvalue 1
maxvalue 9999999999999999999999999999
start with 7039721
increment by 1
cache 20;
grant select on ACC_ST.SEQ_ST_STS_MTR_AUDIT_BALANCE to ACC_ST_APP;


prompt
prompt Creating sequence SEQ_ST_STS_OD_CARD
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_STS_OD_CARD
minvalue 1
maxvalue 9999999999999999999999999999
start with 72151201
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_OD_CARD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_OD_CARD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_OD_CARD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_OD_CARD_ZONE
prompt =========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_OD_CARD_ZONE
minvalue 1
maxvalue 9999999999999999999999999999
start with 113551
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_OD_CARD_ZONE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_OD_CARD_ZONE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_OD_CARD_ZONE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_OD_LINE
prompt ====================================
prompt
create sequence ACC_ST.SEQ_ST_STS_OD_LINE
minvalue 1
maxvalue 9999999999999999999999999999
start with 9311
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_OD_LINE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_OD_LINE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_OD_LINE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_STATION_OD
prompt =======================================
prompt
create sequence ACC_ST.SEQ_ST_STS_STATION_OD
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_STATION_OD to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_STATION_OD to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_STATION_OD to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_ST_STS_TICKET_FARE
prompt ========================================
prompt
create sequence ACC_ST.SEQ_ST_STS_TICKET_FARE
minvalue 1
maxvalue 9999999999999999999999999999
start with 1
increment by 1
cache 10;
grant select on ACC_ST.SEQ_ST_STS_TICKET_FARE to ACC_ST_APP;
grant select on ACC_ST.SEQ_ST_STS_TICKET_FARE to ACC_ST_DEV;
grant select on ACC_ST.SEQ_ST_STS_TICKET_FARE to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_T#IST_GEN_NON_RETLIST_RET
prompt ===============================================
prompt
create sequence ACC_ST.SEQ_T#IST_GEN_NON_RETLIST_RET
minvalue 1
maxvalue 9999999999999999999999999999
start with 23551
increment by 1
cache 10;
grant select on ACC_ST.SEQ_T#IST_GEN_NON_RETLIST_RET to ACC_ST_APP;
grant select on ACC_ST.SEQ_T#IST_GEN_NON_RETLIST_RET to ACC_ST_DEV;
grant select on ACC_ST.SEQ_T#IST_GEN_NON_RETLIST_RET to ACC_ST_RPT;


prompt
prompt Creating sequence SEQ_T#ST_IST_SETTLE_SAM_TMP
prompt =============================================
prompt
create sequence ACC_ST.SEQ_T#ST_IST_SETTLE_SAM_TMP
minvalue 1
maxvalue 9999999999999999999999999999
start with 1146735211
increment by 1
cache 10;
grant select on ACC_ST.SEQ_T#ST_IST_SETTLE_SAM_TMP to ACC_ST_APP;
grant select on ACC_ST.SEQ_T#ST_IST_SETTLE_SAM_TMP to ACC_ST_DEV;
grant select on ACC_ST.SEQ_T#ST_IST_SETTLE_SAM_TMP to ACC_ST_RPT;


prompt
prompt Creating synonym ST_HIS_ACT_SAM
prompt ===============================
prompt
create or replace synonym ACC_ST.ST_HIS_ACT_SAM
  for ACC_ST_HIS.ST_HIS_ACT_SAM;

prompt
prompt Creating synonym ST_HIS_ACT_SVT
prompt ===============================
prompt
create or replace synonym ACC_ST.ST_HIS_ACT_SVT
  for ACC_ST_HIS.ST_HIS_ACT_SVT;

prompt
prompt Creating synonym ST_HIS_ADMIN
prompt =============================
prompt
create or replace synonym ACC_ST.ST_HIS_ADMIN
  for ACC_ST_HIS.ST_HIS_ADMIN;

prompt
prompt Creating synonym ST_HIS_AGM_CARD_DATA
prompt =====================================
prompt
create or replace synonym ACC_ST.ST_HIS_AGM_CARD_DATA
  for ACC_ST_HIS.ST_HIS_AGM_CARD_DATA;

prompt
prompt Creating synonym ST_HIS_AGM_CUTOFF_DTL
prompt ======================================
prompt
create or replace synonym ACC_ST.ST_HIS_AGM_CUTOFF_DTL
  for ACC_ST_HIS.ST_HIS_AGM_CUTOFF_DTL;

prompt
prompt Creating synonym ST_HIS_AGM_CUTOFF_TOTAL
prompt ========================================
prompt
create or replace synonym ACC_ST.ST_HIS_AGM_CUTOFF_TOTAL
  for ACC_ST_HIS.ST_HIS_AGM_CUTOFF_TOTAL;

prompt
prompt Creating synonym ST_HIS_AUDIT
prompt =============================
prompt
create or replace synonym ACC_ST.ST_HIS_AUDIT
  for ACC_ST_HIS.ST_HIS_AUDIT;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_ADMIN
prompt =======================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_ADMIN
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_ADMIN;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_CHARGE
prompt ========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_CHARGE
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_CHARGE;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_CHG_UPD
prompt =========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_CHG_UPD
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_CHG_UPD;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_DELAY
prompt =======================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_DELAY
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_DELAY;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_RETURN
prompt ========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_RETURN
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_RETURN;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_RTN_APP
prompt =========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_RTN_APP
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_RTN_APP;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_RTN_NON
prompt =========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_RTN_NON
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_RTN_NON;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_SALE
prompt ======================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_SALE
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_SALE;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_TOTAL
prompt =======================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_TOTAL
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_TOTAL;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_UNLOCK
prompt ========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_UNLOCK
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_UNLOCK;

prompt
prompt Creating synonym ST_HIS_BOM_SHIFT_UPDATE
prompt ========================================
prompt
create or replace synonym ACC_ST.ST_HIS_BOM_SHIFT_UPDATE
  for ACC_ST_HIS.ST_HIS_BOM_SHIFT_UPDATE;

prompt
prompt Creating synonym ST_HIS_DEAL
prompt ============================
prompt
create or replace synonym ACC_ST.ST_HIS_DEAL
  for ACC_ST_HIS.ST_HIS_DEAL;

prompt
prompt Creating synonym ST_HIS_DEAL_BANK
prompt =================================
prompt
create or replace synonym ACC_ST.ST_HIS_DEAL_BANK
  for ACC_ST_HIS.ST_HIS_DEAL_BANK;

prompt
prompt Creating synonym ST_HIS_DEAL_OCT
prompt ================================
prompt
create or replace synonym ACC_ST.ST_HIS_DEAL_OCT
  for ACC_ST_HIS.ST_HIS_DEAL_OCT;

prompt
prompt Creating synonym ST_HIS_DELAY
prompt =============================
prompt
create or replace synonym ACC_ST.ST_HIS_DELAY
  for ACC_ST_HIS.ST_HIS_DELAY;

prompt
prompt Creating synonym ST_HIS_ENTRY
prompt =============================
prompt
create or replace synonym ACC_ST.ST_HIS_ENTRY
  for ACC_ST_HIS.ST_HIS_ENTRY;

prompt
prompt Creating synonym ST_HIS_LCC
prompt ===========================
prompt
create or replace synonym ACC_ST.ST_HIS_LCC
  for ACC_ST_HIS.ST_HIS_LCC;

prompt
prompt Creating synonym ST_HIS_LOCK
prompt ============================
prompt
create or replace synonym ACC_ST.ST_HIS_LOCK
  for ACC_ST_HIS.ST_HIS_LOCK;

prompt
prompt Creating synonym ST_HIS_NON_RTN
prompt ===============================
prompt
create or replace synonym ACC_ST.ST_HIS_NON_RTN
  for ACC_ST_HIS.ST_HIS_NON_RTN;

prompt
prompt Creating synonym ST_HIS_NON_RTN_APP
prompt ===================================
prompt
create or replace synonym ACC_ST.ST_HIS_NON_RTN_APP
  for ACC_ST_HIS.ST_HIS_NON_RTN_APP;

prompt
prompt Creating synonym ST_HIS_REG_DTL
prompt ===============================
prompt
create or replace synonym ACC_ST.ST_HIS_REG_DTL
  for ACC_ST_HIS.ST_HIS_REG_DTL;

prompt
prompt Creating synonym ST_HIS_REG_TOTAL
prompt =================================
prompt
create or replace synonym ACC_ST.ST_HIS_REG_TOTAL
  for ACC_ST_HIS.ST_HIS_REG_TOTAL;

prompt
prompt Creating synonym ST_HIS_RETURN
prompt ==============================
prompt
create or replace synonym ACC_ST.ST_HIS_RETURN
  for ACC_ST_HIS.ST_HIS_RETURN;

prompt
prompt Creating synonym ST_HIS_SALE
prompt ============================
prompt
create or replace synonym ACC_ST.ST_HIS_SALE
  for ACC_ST_HIS.ST_HIS_SALE;

prompt
prompt Creating synonym ST_HIS_SALE_OCT
prompt ================================
prompt
create or replace synonym ACC_ST.ST_HIS_SALE_OCT
  for ACC_ST_HIS.ST_HIS_SALE_OCT;

prompt
prompt Creating synonym ST_HIS_SALE_SJT
prompt ================================
prompt
create or replace synonym ACC_ST.ST_HIS_SALE_SJT
  for ACC_ST_HIS.ST_HIS_SALE_SJT;

prompt
prompt Creating synonym ST_HIS_TVM_CARD_CLEAR
prompt ======================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_CARD_CLEAR
  for ACC_ST_HIS.ST_HIS_TVM_CARD_CLEAR;

prompt
prompt Creating synonym ST_HIS_TVM_CARD_PUT
prompt ====================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_CARD_PUT
  for ACC_ST_HIS.ST_HIS_TVM_CARD_PUT;

prompt
prompt Creating synonym ST_HIS_TVM_COIN_CLEAR
prompt ======================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_COIN_CLEAR
  for ACC_ST_HIS.ST_HIS_TVM_COIN_CLEAR;

prompt
prompt Creating synonym ST_HIS_TVM_COIN_DATA
prompt =====================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_COIN_DATA
  for ACC_ST_HIS.ST_HIS_TVM_COIN_DATA;

prompt
prompt Creating synonym ST_HIS_TVM_COIN_PUT
prompt ====================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_COIN_PUT
  for ACC_ST_HIS.ST_HIS_TVM_COIN_PUT;

prompt
prompt Creating synonym ST_HIS_TVM_CUTOFF_DTL
prompt ======================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_CUTOFF_DTL
  for ACC_ST_HIS.ST_HIS_TVM_CUTOFF_DTL;

prompt
prompt Creating synonym ST_HIS_TVM_CUTOFF_TOTAL
prompt ========================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_CUTOFF_TOTAL
  for ACC_ST_HIS.ST_HIS_TVM_CUTOFF_TOTAL;

prompt
prompt Creating synonym ST_HIS_TVM_NOTE_DATA
prompt =====================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_NOTE_DATA
  for ACC_ST_HIS.ST_HIS_TVM_NOTE_DATA;

prompt
prompt Creating synonym ST_HIS_TVM_WASTE_CARD_DATA
prompt ===========================================
prompt
create or replace synonym ACC_ST.ST_HIS_TVM_WASTE_CARD_DATA
  for ACC_ST_HIS.ST_HIS_TVM_WASTE_CARD_DATA;

prompt
prompt Creating synonym ST_HIS_UPDATE
prompt ==============================
prompt
create or replace synonym ACC_ST.ST_HIS_UPDATE
  for ACC_ST_HIS.ST_HIS_UPDATE;

prompt
prompt Creating type STR_SPLIT
prompt =======================
prompt
CREATE OR REPLACE TYPE ACC_ST."STR_SPLIT"                                          IS TABLE OF VARCHAR2 (4000)
/
grant execute on ACC_ST.STR_SPLIT to ACC_ST_APP;


prompt
prompt Creating function UP_DM_ST_SPLITSTR
prompt ===================================
prompt
CREATE OR REPLACE FUNCTION ACC_ST.up_dm_st_splitstr(p_string IN VARCHAR2, p_delimiter IN VARCHAR2)
    RETURN str_split
    PIPELINED
AS
    v_length   NUMBER := LENGTH(p_string);
    v_start    NUMBER := 1;
    v_index    NUMBER;
BEGIN
    WHILE(v_start <= v_length)
    LOOP
        v_index := INSTR(p_string, p_delimiter, v_start);

        IF v_index = 0
        THEN
            PIPE ROW(SUBSTR(p_string, v_start));
            v_start := v_length + 1;
        ELSE
            PIPE ROW(SUBSTR(p_string, v_start, v_index - v_start));
            v_start := v_index + 1;
        END IF;
    END LOOP;

    RETURN;
END up_dm_st_splitstr;
/
grant execute on ACC_ST.UP_DM_ST_SPLITSTR to ACC_ST_APP;


prompt
prompt Creating function UP_DM_ST_TABLENO
prompt ==================================
prompt
create or replace function acc_st.up_dm_st_tableno(in_num number) -- ‰»Îµƒµ±«∞–Ú∫≈
  --∫Ø  ˝ √˚£∫ up_dms_st_tableno
  --π¶ƒ‹√Ë ˆ£∫∏˘æ›¥´»Îµƒ–Ú¡–∫≈÷µ£¨º∆À„“ªœ¬∏ˆ–Ú¡–∫≈÷µ£¨¿˝»Á¥´»Î1£¨∑µªÿ002£¨¥´»Î22∑µªÿ023£¨¥´»Î123∑µªÿ124
  -- ‰   »Î: ’˚ ˝–Ú¡–∫≈÷µ
  -- ‰   ≥ˆ£∫4Œªµƒ–Ú¡–∫≈÷µ
  --∑µªÿ÷µ    £∫
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131021

 return varchar2 is
  v_temp_num number;
begin
  v_temp_num := in_num + 1;

  if in_num < 0 then
    return '000001';
  elsif in_num < 9 then
    return '00000' || v_temp_num;
  elsif in_num < 99 then
    return '0000' || v_temp_num;
  elsif in_num < 999 then
    return '000' || v_temp_num;
  elsif in_num < 9999 then
    return '00' || v_temp_num;
  elsif in_num < 99999 then
    return '0' || v_temp_num;
  elsif in_num < 999999 then
    return '' || v_temp_num;
  else
    return '000001';
  end if;

end up_dm_st_tableno;
/
grant execute on ACC_ST.UP_DM_ST_TABLENO to ACC_ST_APP;


prompt
prompt Creating procedure ST_HIS_GRANT_PRIV_P0324
prompt ==========================================
prompt
create or replace procedure acc_st.st_his_grant_priv_P0324 is
  vs_priv_sql    varchar2(500);
  vs_synonym_sql varchar2(500);
  vs_priv_sql2   varchar2(500); --∏¯acc_st_dev ⁄≤È—Ø»®œﬁ±‰¡ø
  vs_table_name  varchar2(30);
  vn_tab_num     number(10);
  vn_priv_num    number(2);
  vn_syn_num     number(2);
  vs_sqlcode     varchar2(12);
  vs_owner       varchar2(30);
  cursor st_dba_objects_cur is
    select owner,object_name from dba_objects where owner in ('ACC_ST','ACC_ST_HIS') and object_type='TABLE' and created>=sysdate-1/48;
begin
  --st_idx_trx_history grant priv
  begin
    --≤È—Ø «∑Ò”––Ë“™ ⁄»®µƒ±Ì
    select count(*)
      into vn_tab_num
      from dba_objects where owner in ('ACC_ST','ACC_ST_HIS') and object_type='TABLE' and created>=sysdate-1/24;
  
    --st_idx_trx_history grant priv
  
    if vn_tab_num > 0 then
      for cur_idx in st_dba_objects_cur loop
        vs_table_name := cur_idx.object_name;
        vs_owner := cur_idx.owner;
        select count(*)
          into vn_priv_num
          from (select table_name
                  from dba_tab_privs
                 where grantee = 'ACC_ST_APP'
                   and table_name = upper(trim(vs_table_name))
                   and owner = vs_owner
                   and privilege = 'SELECT'
                union all
                select table_name
                  from dba_tab_privs
                 where grantee = 'ACC_ST_APP'
                   and table_name = upper(trim(vs_table_name))
                   and owner = vs_owner
                   and privilege = 'INSERT'
                union all
                select table_name
                  from dba_tab_privs
                 where grantee = 'ACC_ST_APP'
                   and table_name = upper(trim(vs_table_name))
                   and owner = vs_owner
                   and privilege = 'UPDATE'
                union all
                select table_name
                  from dba_tab_privs
                 where grantee = 'ACC_ST_APP'
                   and table_name = upper(trim(vs_table_name))
                  and owner = vs_owner
                   and privilege = 'DELETE');
      
        if vn_priv_num < 4 then
          vs_priv_sql := 'GRANT SELECT,INSERT,UPDATE,DELETE ON ' ||vs_owner||'.'
                         ||vs_table_name || ' to ' || 'ACC_ST_APP';
          vs_priv_sql2 := 'GRANT SELECT ON ' ||vs_owner||'.'||vs_table_name || ' to ' || 'ACC_ST_DEV';  --‘ˆº”∏¯ACC_ST_DEV≤È—Ø»®œﬁ
          execute immediate vs_priv_sql;
          insert into acc_st.st_his_grant_privs_T0324
          values
            (vs_table_name,vs_owner, vs_priv_sql, sysdate);
          commit;
          execute immediate vs_priv_sql2;
         end if;
          select count(*)
            into vn_syn_num
            from dba_synonyms
           where owner = 'ACC_ST_APP'
             and synonym_name = upper(trim(vs_table_name));
          if vn_syn_num = 1 then
            dbms_output.put_line('∂‘œÛ√˚≥∆“—¥Ê‘⁄£¨«Î∫À≤È!');
          else
            vs_synonym_sql := 'create synonym acc_st_app.' || vs_table_name ||
                              ' for '||vs_owner||'.'|| vs_table_name;
            execute immediate vs_synonym_sql;
            insert into acc_st.st_his_grant_privs_T0324
          values
            (vs_table_name,vs_owner, vs_synonym_sql, sysdate);
          commit;
          end if;
        
          --dbms_output.put_line(vn_priv_num);
          --dbms_output.put_line(vn_syn_num);
          vn_priv_num := 0;
          vn_syn_num  := 0;
          
        
        --dbms_output.put_line(st_idx__trx_cur%rowcount);
      
      end loop;
    end if;
    --dbms_output.put_line(vn_tab_num);
    --dbms_output.put_line(vs_priv_sql);
    --dbms_output.put_line(vn_syn_num);
  
   -- vn_tab_num := 0
  
  end;

  --st_idx_rpt_history grant priv
  
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      vs_sqlcode := sqlcode;
      insert into st_his_grant_privs_T0324
      values
        ('-', '-', vs_sqlcode, sysdate);
      commit;
      return;
    end;
end st_his_grant_priv_P0324;
/

prompt
prompt Creating procedure TMP_ST_IST_SETTLE_LCC
prompt ========================================
prompt
create or replace procedure acc_st.tmp_st_ist_settle_lcc(
 out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  tmp_st_ist_settle_lcc
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫lcc∂‘’À
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫--¡Ÿ ±∏¸–¬lcc∂‘’ÀΩ·π˚
-------------------------------------------------------------------------------
as

   v_msg varchar(100);

begin

  --ver1.11 ‘ˆº”¡Ÿ ±±Ì£¨º«¬º∂‘’À»’∆⁄ ∏¸–¬»’∆⁄2015-4-8
  insert into t#st_que_lcc( water_no ,balance_water_no ,line_id ,station_id ,bom_sale_sjt_num,bom_sale_sjt_fee ,tvm_sale_sjt_num ,tvm_sale_sjt_fee ,
         bom_sale_num ,bom_sale_deposit_fee ,bom_charge_fee ,tvm_charge_num ,tvm_charge_fee ,return_num ,
         return_fee ,non_return_num ,non_ret_deposit_fee , non_ret_actual_ret_bala ,
         negative_charge_num ,negative_charge_fee , deal_num , deal_fee , update_cash_num , update_cash_fee , update_noncash_num ,
         update_noncash_fee , admin_num , admin_return_fee , admin_penalty_fee , file_name , check_flag,account_date)
  select  water_no ,balance_water_no ,line_id ,station_id ,bom_sale_sjt_num,bom_sale_sjt_fee ,tvm_sale_sjt_num ,tvm_sale_sjt_fee ,
          bom_sale_num ,bom_sale_deposit_fee ,bom_charge_fee ,tvm_charge_num ,tvm_charge_fee ,return_num ,
          return_fee ,non_return_num ,non_ret_deposit_fee , non_ret_actual_ret_bala ,
          negative_charge_num ,negative_charge_fee , deal_num , deal_fee , update_cash_num , update_cash_fee , update_noncash_num ,
          update_noncash_fee , admin_num , admin_return_fee , admin_penalty_fee , file_name , check_flag,substr(file_name,7,8)
  from st_his_lcc where balance_water_no = in_balance_water_no;


 ---------------------------lcc_acc∂‘’ÀΩ·π˚±Ì£®st_sts_lcc_acc£©
  delete st_sts_lcc_acc where  balance_water_no = in_balance_water_no;

  v_msg := 'œÚst_sts_lcc_acc±Ì≤Â»Î∂‘’À»’Œ™«ÂÀ„»’µƒ ˝æ›';
  insert into st_sts_lcc_acc£®  water_no , balance_water_no ,line_id, station_id ,diff_bom_sale_sjt_num , diff_bom_sale_sjt_fee ,
  diff_tvm_sale_sjt_num , diff_tvm_sale_sjt_fee, diff_bom_sale_num , diff_bom_sale_deposit_fee ,
  diff_bom_charge_fee , diff_tvm_charge_num , diff_tvm_charge_fee , diff_return_num ,diff_return_fee,
  diff_non_return_num ,diff_non_ret_deposit_fee ,diff_non_ret_actual_ret_bala ,diff_negative_charge_num ,
  diff_negative_charge_fee, diff_deal_num ,diff_deal_fee , diff_update_cash_num ,diff_update_cash_fee ,
  diff_update_noncash_num , diff_update_noncash_fee ,diff_admin_num , diff_admin_return_fee,diff_admin_penalty_fee,account_date
   )
 select  seq_st_sts_lcc_acc.nextval,a.balance_water_no ,a.line_id, a.station_id ,
  a.bom_sale_sjt_num-b.bom_sale_sjt_num ,a.bom_sale_sjt_fee-b.bom_sale_sjt_fee,
  a.tvm_sale_sjt_num-b.tvm_sale_sjt_num,a.tvm_sale_sjt_fee-b.tvm_sale_sjt_fee,
  a.bom_sale_num-b.bom_sale_num, a.bom_sale_deposit_fee-b.bom_sale_deposit_fee,
  a.bom_charge_fee-b.bom_charge_fee,a.tvm_charge_num-b.tvm_charge_num,
  a.tvm_charge_fee-b.tvm_charge_fee, a.return_num-b.return_num,
  a.return_fee-b.return_fee, a.non_return_num-b.non_return_num,
  a.non_ret_deposit_fee-b.non_ret_deposit_fee, a.non_ret_actual_ret_bala-b.non_ret_actual_ret_bala,
  a.negative_charge_num-b.negative_charge_num, a.negative_charge_fee-b.negative_charge_fee,
  a.deal_num -b.deal_num , a.deal_fee -b.deal_fee , a.update_cash_num-b.update_cash_num,
  a.update_cash_fee-b.update_cash_fee, a.update_noncash_num-b.update_noncash_num,
  a.update_noncash_fee-b.update_noncash_fee,a.admin_num-b.admin_num,
  a.admin_return_fee-b.admin_return_fee, a.admin_penalty_fee-b.admin_penalty_fee,a.account_date
 from t#st_que_lcc a,st_sts_acc b
 where a.account_date=substr(b.balance_water_no,1,8) and a.line_id=b.line_id and a.station_id=b.station_id;


   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.TMP_ST_IST_SETTLE_LCC to ACC_ST_DEV;


prompt
prompt Creating procedure UP_CM_REPORT_LOSS
prompt ====================================
prompt
create or replace procedure acc_st.up_cm_report_loss(i_busnissType in varchar2, --“µŒÒ¿‡–Õ
                                              i_idCardType  in varchar2, --÷§º˛¿‡–Õ
                                              i_idNumber    in varchar2, --÷§º˛∫≈
                                              i_applybill   in varchar2, --∆æ÷§ID
                                              i_applyaction in varchar2, --≤Ÿ◊˜¿‡–Õ
                                              o_result     out varchar2 --∂®“Âout≤Œ ˝∑µªÿΩ·π˚¥˙¬Î
                                              )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚: up_cm_report_loss
  --π¶ƒ‹£∫π“ ß°¢Ω‚π“°¢π“ ßø®≤πø®
  --◊˜’ﬂ£∫lindaquan
  --¥¥Ω®»’∆⁄£∫20150527
  --∞Ê±æ:1.00

  --–ﬁ∏ƒ£∫‘ –Ìµ±ÃÏ…Í«Îπ“ ß∫ÛΩ‚π“∫Õ≤πø®  version:1.35 by lindaquan in 20160602
  --–ﬁ∏ƒ£∫‘ˆº”≈–∂œ÷ÿ∏¥…Í«ÎΩ‚π“°¢≤πø®  version:1.37 by lindaquan in 20160803
  --–ﬁ∏ƒ£∫…Í«Îπ“ ßÕÀøÓ∫Û≤ªƒ‹π“ ß≤πø®  version:1.38 by lindaquan in 20160907
  -------------------------------------------------------------------------------
 as
  resultPermit    char(2) :='00'; --00:‘ –Ì…Í«Î
  resultNoID      char(2) :='01'; --01:÷§º˛≤ª¥Ê‘⁄
  resultExpID     char(2) :='02'; --02:÷§º˛“—π˝∆⁄
  resultBlackCard char(2) :='03'; --03:∫⁄√˚µ•ø®
  resultRepApply  char(2) :='04'; --04:÷ÿ∏¥…Í«Î
  resultNoMake    char(2) :='05'; --05:’˝≥£…Í«Î,Œ¥÷∆ø®
  resultRefund    char(2) :='06'; --06:“—…Í«ÎÕÀøÓ
  resultReMake    char(2) :='07'; --07:“—…Í«Î≤πø®
  resultNoLoss    char(2) :='10'; --10:Œﬁπ“ ß,≤ªø…Ω‚π“/≤πø®…Í«Î

  bReportLoss       char(1) :='1';  --“µŒÒ¿‡–Õ£∫π“ ß
  bReportLossOf     char(1) :='2';  --“µŒÒ¿‡–Õ£∫Ω‚π“
  bReportLossFill   char(1) :='3';  --“µŒÒ¿‡–Õ£∫π“ ß≤πø®…Í«Î

  --applyQuery      char(1) :='1';  --¥¶¿Ì∑Ω Ω£∫≤È—Ø
  applyResult     char(1) :='2';  --¥¶¿Ì∑Ω Ω£∫∞Ï¿Ì≥…π¶Õ®÷™

  countTemp       integer :=0;--¡Ÿ ±Õ≥º∆
  isMake          varchar2(2) :='-1';-- «∑Ò“—æ≠÷∆ø®
  isExpiredID       char(1);--÷§º˛ «∑Ò ß–ß 1”––ß£¨0 ß–ß
  waitDay           integer :=0;--∑«º¥ ±ÕÀøÓµ»¥˝»’
  tmpBusnissType    char(1) :='1';--…Í«Î¿‡–Õ£¨1£∫’˝≥£…Í«Î2£∫≤πø®…Í«Î
  tmpsql            varchar2(1024);--¡Ÿ ±SQL”Ôæ‰

begin

  ---------∞Ï¿Ì≥…π¶Õ®÷™ø™ º------------------
  begin
    if i_applyaction=applyResult then
      insert into acc_st.st_cm_result_report_loss
        (water_no, apply_bill, create_time, busniss_type, identify_type, identity_id)
      values
        (acc_st.seq_st_cm_result_report_loss.nextval, i_applybill, sysdate, i_busnissType, i_idCardType, i_idNumber);

      --≤Â»Î≤È—Øº«¬º
      insert into acc_st.st_cm_log_report_loss
        (water_no, apply_bill, apply_action, return_flag, return_time)
      values
        (acc_st.seq_st_cm_log_report_loss.nextval, i_applybill, i_applyaction, resultPermit, sysdate);
      commit;
      return;
    end if;
  end;
  ---------∞Ï¿Ì≥…π¶Õ®÷™Ω· ¯------------------


  ---------≤È—Øø™ º------------------
  --Ω·π˚£∫00:‘ –Ì…Í«Î;01:÷§º˛≤ª¥Ê‘⁄;02:÷§º˛“—π˝∆⁄;03:∫⁄√˚µ•ø®;04:÷ÿ∏¥…Í«Î;
        --05:’˝≥£…Í«Î,Œ¥÷∆ø®;06:“—…Í«ÎÕÀøÓ/≤πø®£®≥¨π˝∑«º¥ ±ÕÀøÓµ»¥˝»’£©;10:Œﬁπ“ ß,≤ªø…Ω‚π“/≤πø®…Í«Î
  --0.≤È—ØÕ®—∂º«¬º±Ì «∑Ò¥Ê‘⁄≥…π¶µƒπ“ ßªÚΩ‚π“º«¬º£®st_cm_result_report_loss£©
  --1.≤È—Ø«ÂÀ„º«¬º±Ì «∑Ò¥Ê‘⁄π“ ßªÚΩ‚π“º«¬º£®04:÷ÿ∏¥…Í«Î;10:Œﬁπ“ ß,≤ªø…Ω‚π“,≤ªø…≤πø®…Í«Î£©
  --2.≤È—Øº«√˚ø®…Í«Î±Ìst_list_sign_card£®01:÷§º˛≤ª¥Ê‘⁄;02:÷§º˛“—π˝∆⁄;st_list_sign_card±Ì÷–hdl_flag = '2'£©
  --3.≤È—Ø÷§º˛∂‘’’º«√˚ø® «∑ÒES…˙≤˙£®st_list_sign_card±Ì÷–hdl_flag <> '2';05:“—…Í«Î,Œ¥÷∆ø®£©
  --4.π“ ß ±£¨≤È—Ø «∑Ò∫⁄√˚µ•(03:∫⁄√˚µ•ø®)

  --≥ı ºΩ·π˚00:‘ –Ì…Í«Î
  o_result := resultPermit;

  --≤È—Ø÷§º˛∫≈
  select count(1) into countTemp from acc_st.st_list_sign_card
           where identity_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber));
  if countTemp>0 then
  select hdl_flag,(case when expired_date>=sysdate then 1 else 0 end),app_business_type
         into isMake,isExpiredID,tmpBusnissType from (
         select hdl_flag,expired_date,apply_datetime,app_business_type,rownum from acc_st.st_list_sign_card
           where identity_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber))
           order by apply_datetime desc)
  where rownum = 1;
  end if;

  --01:÷§º˛≤ª¥Ê‘⁄
  if isMake='-1' then
     o_result := resultNoID;
  end if;

  --02:÷§º˛“—π˝∆⁄
  if isExpiredID=0 then
     o_result := resultExpID;
  end if;

  --04:÷ÿ∏¥…Í«Î
  --≥ı ºΩ·π˚00:‘ –Ì…Í«Î ±≤≈÷¥––
  if o_result = resultPermit then
    countTemp :=0;
    --µ±ÃÏ
    select count(1) into countTemp from acc_st.ST_CM_RESULT_REPORT_LOSS
    where busniss_type = i_busnissType and identify_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber))
    and substr(apply_bill,1,8)=to_char(sysdate,'yyyymmdd');
    --∂‡ÃÏ
    if countTemp=0 then
        select count(1) into countTemp from acc_st.st_list_report_loss
        where busniss_type = i_busnissType and identify_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber));
    end if;
    --Ω‚π“º«¬º¥˝¥¶¿Ì±Ì
    if countTemp=0 and i_busnissType<>bReportLossFill then
        select count(1) into countTemp from acc_st.st_list_report_loss_pend
        where identify_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber));
    end if;
    --≤πø®…Í«Î¥˝¥¶¿Ì±Ì
    if countTemp=0 and i_busnissType<>bReportLossOf  then
        select count(1) into countTemp from acc_st.st_list_sign_card_pend
        where identity_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber));
    end if;
    if countTemp>0 then
       o_result := resultRepApply;
    end if;
  end if;

  --≥ı ºΩ·π˚00:‘ –Ì…Í«Î ±≤≈÷¥––
  if o_result = resultPermit and i_busnissType = bReportLoss then
      --05:’˝≥£…Í«Î,Œ¥÷∆ø®
      if isMake<>'2' and isMake<>'-1' and tmpBusnissType='1' then
         o_result := resultNoMake;
      else

        --03:∫⁄√˚µ•ø®
        --≤È—Øµ±«∞ES≥ı ºªØº«¬º±Ì¬ﬂº≠ø®∫≈ «∑Ò∂‘”¶∫⁄√˚µ•º«¬º
        select count(1) into countTemp from acc_st.op_prm_black_list_mtr where card_logical_id in(
             select b.logical_id from acc_st.st_list_sign_card a,acc_tk.ic_es_initi_info b
             where a.req_no=b.req_no and a.order_no=b.order_no and a.identity_type=i_idCardType and upper(trim(a.identity_id))= upper(i_idNumber)
        );
        --≤È—Ø∑÷±ÌES≥ı ºªØº«¬º±Ì¬ﬂº≠ø®∫≈ «∑Ò∂‘”¶∫⁄√˚µ•º«¬º
        if countTemp=0 then
          begin
            --∂®“Â∑÷±Ìic_es_initi_info”Œ±Í
            DECLARE CURSOR hisTableCus IS select his_table from acc_tk.ic_idx_history where origin_table_name='ic_es_initi_info';
      c_row hisTableCus%rowtype;
            --—≠ª∑”Œ±Í
            begin
              open hisTableCus;
                   loop
                     fetch hisTableCus into c_row;
                     --”Œ±Í»°≤ªµΩ ˝æ›‘ÚÕÀ≥ˆ
                     exit when hisTableCus%NOTFOUND;
                     tmpsql := 'select count(1) from acc_st.op_prm_black_list_mtr where card_logical_id in('||
                             ' select b.logical_id from acc_st.st_list_sign_card a,acc_tk.'||c_row.his_table||' b'||
                             ' where a.req_no=b.req_no and a.order_no=b.order_no and a.identity_type='''||i_idCardType||''' and upper(trim(a.identity_id))= upper('''||i_idNumber||'''))';
                     EXECUTE IMMEDIATE tmpsql into countTemp;
                     exit when countTemp>0;
                   end loop;
              close hisTableCus;
            end;
          end;
        end if;
        if countTemp>0 then
           o_result := resultBlackCard;
        end if;

    end if;
  end if;

  --≤πø®°¢Ω‚π“
  if o_result = resultPermit and i_busnissType<>bReportLoss then
    --10:Œﬁπ“ ß,≤ªø…Ω‚π“,≤ªø…≤πø®…Í«Î
    countTemp :=0;
    --µ±ÃÏ
    select count(1) into countTemp from acc_st.ST_CM_RESULT_REPORT_LOSS
    where busniss_type = bReportLoss and identify_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber))
    and substr(apply_bill,1,8)=to_char(sysdate,'yyyymmdd');
    --∂‡ÃÏ
    select count(1) into countTemp from acc_st.st_list_report_loss
    where busniss_type = bReportLoss and identify_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber));
    if countTemp=0 then
       o_result := resultNoLoss;
    else

      --∑«º¥ ±ÕÀøÓµ»¥˝»’
      select cfg_value into waitDay from acc_st.st_cfg_sys_base where cfg_key='sys.non_return_day' and record_flag='0';
      --06:“—…Í«ÎÕÀøÓ/≤πø®(”–π“ ßº«¬ºº¥ø…Ω‚π“∫Õ≤πø®£¨≥¨≥ˆµ»¥˝»’≤ª‘ –ÌΩ‚π“∫Õ≤πø®)
      countTemp :=0;
      select count(1) into countTemp from acc_st.st_list_report_loss
      where busniss_type = bReportLoss and identify_type = i_idCardType and upper(trim(identity_id)) = upper(trim(i_idNumber))
      and trunc(APPLY_DATETIME)+waitDay < trunc(sysdate);
      if countTemp>0 then
         o_result := resultRefund;
      end if;

    end if;
  end if;


  --≤Â»Î≤È—Øº«¬º
  insert into acc_st.st_cm_log_report_loss
    (water_no, apply_bill, apply_action, return_flag, return_time)
  values
    (acc_st.seq_st_cm_log_report_loss.nextval, i_applybill, i_applyaction, o_result, sysdate);
  commit;

  ---------≤È—ØΩ· ¯------------------
end up_cm_report_loss;
/
grant execute on ACC_ST.UP_CM_REPORT_LOSS to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_MV_LOG
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_mv_log(origin_table_name    in varchar2,
                                            dest_table_name      in varchar2,
                                            balance_water_no     in varchar2,
                                            begin_clear_datetime in date,
                                            end_clear_datetime   in date,
                                            spent_time           in NUMBER,
                                            clear_recd_count     in NUMBER,
                                            err_discribe         in varchar2,
                                            v_sql                in varchar2) as

  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_st_ist_settle_log_add
  --π¶ƒ‹√Ë ˆ£∫º«¬º«®“∆ ˝æ› ±µƒ»’÷æ
  -- ‰»Î≤Œ ˝: origin_table_name  ‘≠±Ì√˚
  -- ‰»Î≤Œ ˝: dest_table_name   ∑÷±Ì±Ì√˚
  -- ‰»Î≤Œ ˝: balance_water_no  ‘≠±Ì√˚
  -- ‰»Î≤Œ ˝: begin_clear_datetime  ≤Ÿ◊˜ø™ º ±º‰
  -- ‰»Î≤Œ ˝: end_clear_datetimein  ≤Ÿ◊˜Ω· ¯ ±º‰
  -- ‰»Î≤Œ ˝: spent_time  ≤Ÿ◊˜À˘ª® ±º‰
  -- ‰»Î≤Œ ˝: clear_recd_count  «Â¿Ìº«¬º ˝
  -- ‰»Î≤Œ ˝: err_discribe  ¥ÌŒÛ√Ë ˆ
  --¥¥Ω®’ﬂ£∫’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131028
  -------------------------------------------------------------------------------
begin
  insert into acc_st.st_log_clear_table
    (origin_table_name,
     dest_table_name,
     balance_water_no,
     begin_clear_datetime,
     end_clear_datetime,
     spent_time,
     clear_recd_count,
     err_discribe,
     sql_label)
  values
    (origin_table_name,
     dest_table_name,
     balance_water_no,
     to_char(begin_clear_datetime, 'yyyy-mm-dd hh24:mi:ss'),
     to_char(end_clear_datetime, 'yyyy-mm-dd hh24:mi:ss'),
     spent_time,
     clear_recd_count,
     err_discribe,
     v_sql);
  commit;
end up_dm_st_mv_log;
/
grant execute on ACC_ST.UP_DM_ST_MV_LOG to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_HIS_CREATE1
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_his_create1(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                        out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                        ) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_HIS_MORE
  --π¶ƒ‹√Ë ˆ£∫Ω®¡¢÷–—Î«ÂÀ„£∫µ•≥Ã∆±∑¢ €°¢«Æ∞¸Ωª“◊°¢Ω¯’æ°¢∏¸–¬ ˝æ›¿˙ ∑±Ìµƒ¿˙ ∑∑÷±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫201301021
  --–ﬁ∏ƒ»’∆⁄£∫20160707
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº” √ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨“‘£ª∑÷∏Ó∫Û√ø∏ˆ”Ôæ‰µ•∂¿÷¥––°£
  --–ﬁ∏ƒ»’∆⁄£∫20170123 add by mqf
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”π´Ωªœ˚∑—¿˙ ∑±Ì
    -------------------------------------------------------------------------------

 AS

  v_msg           VARCHAR(50);
  v_min_time      date; --buf±Ì÷–µƒ◊Ó–°Ωª“◊ ±º‰
  v_max_time      date; --buf±Ì÷–µƒ◊Ó¥ÛΩª“◊ ±º‰
  v_new_date      varchar2(20);
  v_max_table     varchar2(50); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count         number(18);
  v_count2        number(18);
  v_flag          number(1); --¥¥Ω®001µƒ±Í÷æ£¨0£∫¥¥Ω®
  v_deal_type     char(2); --Ωª“◊¿‡–Õ  50, 53, 54,56
  v_time          varchar2(20);
  v_balance_time  varchar2(20);
  v_temp_sql      varchar2(8000); --¡Ÿ ±sql”Ôæ‰
  v_table_sql     varchar2(5000); --Ω®±Ì¡Ÿ ±sql”Ôæ‰
  v_temp_num      varchar2(6); --∑÷±Ì–Ú¡–∫≈
  v_limit_count   number(18); --∏˜Ωª“◊¿‡–Õ∑÷±Ìœﬁ÷∆ ˝¡ø
  --v_begin_index   number(3); --∑÷±Ì±Ì√˚÷––Ú¡–∫≈µƒ∆ ºœ¬±Í,¿˝»Ást_his_deal_001,‘Úv_begin_index=11
  v_new_tablename varchar2(50);
  v_in_que        varchar2(50);
  v_time_type     varchar2(30);
  v_ab_name       varchar2(50);
BEGIN
  --◊ÚÃÏ«ÂÀ„µƒ»’∆⁄(”√”⁄Ω®¡¢µ⁄“ª∏ˆ0001±Ì)
  select to_char(sysdate - 1, 'yyyymmdd') into v_balance_time from dual;

  declare
    cursor scc_table is
      select t.origin_table_name tmp_origin_table,
             t.create_sql        tmp_create_sql,
             t.is_squadday       tmp_is_squadday,
             t.ab_name           tmp_ab_name,
             t.divide_recd_count tmp_divide_recd_count,
             t.date_type         tmp_date_type
        from acc_st.st_cfg_clear_table t
       where t.db_type = 'trx';
  begin
    for i_cur in scc_table loop
      --Ω®001±Ì
      --‘≠ º±Ì√ª”– ˝æ›
      begin
        v_flag      := 2;
        v_table_sql := 'select count(*)  from ' || i_cur.tmp_origin_table; --tmp_origin_table“—∞¸∫¨”√ªß«∞◊∫acc_st_his
        execute immediate v_table_sql
          into v_count;
        if 0 = v_count then
          continue;
        end if;
      end;

      v_time_type   := i_cur.tmp_date_type; -- ±º‰¿‡–Õ
      v_in_que      := i_cur.tmp_origin_table; --‘¥±Ì
      v_table_sql   := i_cur.tmp_create_sql; --Ω®±Ì”Ôæ‰
      v_limit_count := i_cur.tmp_divide_recd_count;
      v_ab_name     := i_cur.tmp_ab_name;
      if v_in_que = 'acc_st_his.st_his_deal' then
        --«Æ∞¸Ωª“◊st_his_deal
        v_deal_type   := '54';
        --v_begin_index := 9;
      elsif v_in_que = 'acc_st_his.st_his_entry' then
        --Ω¯’æΩª“◊ st_his_entry
        v_deal_type   := '53';
        --v_begin_index := 10;
      elsif v_in_que = 'acc_st_his.st_his_sale_sjt' then
        --µ•≥Ã∆±∑¢ € st_buf_sale_sjt
        v_deal_type   := '50';
        --v_begin_index := 13;
      elsif v_in_que = 'acc_st_his.st_his_update' then
        --∏¸–¬Ωª“◊st_buf update
        v_deal_type   := '56';
        --v_begin_index := 11;
	  elsif v_in_que = 'acc_st_his.st_ext_mtr_his_deal' then  --20170123 add by mqf ‘ˆº”π´Ωªœ˚∑—¿˙ ∑±Ì
        v_deal_type   := '94';

      end if;

      v_new_tablename := v_ab_name || '000001'; --Œ¥∞¸∫¨”√ªß«∞◊∫acc_stªÚacc_st_his

      begin
        begin
          select count(*)
            into v_count
            from acc_st.st_idx_trx_history
           where table_name like v_ab_name || '_%';
        end;
        begin
          v_temp_sql := 'select count(*) from dba_objects where object_name = upper (''' ||
                        v_new_tablename ||
                        ''')  and owner=''ACC_ST_HIS'' and object_type =''TABLE'' ';
          execute immediate v_temp_sql
            into v_count2;
        end;
      end;
      if v_count = 0 then
        --st_idx_trx_history√ª”–Ωª“◊∑÷±Ìµƒº«¬º
        if v_count2 > 0 then
          --∑÷±ÌµƒŒÔ¿Ì±Ì¥Ê‘⁄
          v_temp_sql := 'drop table acc_st_his.' || v_new_tablename; --20150427 modify by mqf ‘ˆº”±Ì«∞◊∫ ACC_ST_HIS
          execute immediate v_temp_sql; --…æ≥˝001∑÷±Ì±Ì
        end if;
        v_flag := 0;
      else
        ----st_idx_trx_history”–Ωª“◊∑÷±Ìµƒº«¬º
        if v_count2 = 0 then
          --∑÷±ÌµƒŒÔ¿Ì±Ì≤ª¥Ê‘⁄
          v_flag := 0;
        end if;
      end if;

      begin
        if v_flag = 0 then

          begin

            select REGEXP_REPLACE(v_table_sql, '%s', v_new_tablename)
              into v_temp_sql
              from dual;

            --execute immediate v_temp_sql; --¥¥Ω®001∑÷±Ì±Ì
      --20160707 add by mqf  √ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
      --¥¥Ω®001∑÷±Ì±Ì
            declare
              cursor sql_cur is
                select * from table(acc_st.up_dm_st_splitstr(v_temp_sql, ';'));
            begin
              for t_cur in sql_cur loop
                v_table_sql := t_cur.column_value;
                if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                  execute immediate v_table_sql; --¥¥Ω®0001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                end if;
              end loop;
            end;

            acc_st.up_dm_st_mv_log(v_in_que,
                            v_new_tablename,
                            '0000000000',
                            sysdate,
                            sysdate,
                            0,
                            0,
                            '≥…π¶¥¥Ω®' || v_new_tablename || '±Ì',
                            'create table ' || v_new_tablename || '...');

          end;

          begin
            begin
              --µ⁄“ª¥Œ‘À––£¨»°÷Æ«∞µƒÀ˘”–µƒ«ÂÀ„ ˝æ›¥Ê∑≈µΩµ⁄“ª’≈±Ì
              v_temp_sql := 'select min(' || v_time_type || '),max(' ||
                            v_time_type || ') from ' || v_in_que ||
                            ' where substr(balance_water_no,0,8)<= ''' ||
                            v_balance_time || '''';
              execute immediate v_temp_sql
                into v_min_time, v_max_time;
            end;
            begin
              -- ˝æ›ø…ƒ‹”–—”≥Ÿ
              v_time     := '2013-05-01'; --to_char(v_min_time, 'yyyy-mm-dd');
              v_min_time := to_date(v_time || ' 00:00:00',
                                    'yyyy-mm-dd hh24:mi:ss');
            end;

            -- ≥ı ºªØÀ˜“˝±Ì÷–µƒ0001±Ì
            begin
              insert into acc_st.st_idx_trx_history
                (table_name,
                 data_type,
                 recd_type,
                 begin_date,
                 end_date,
                 recd_count,
                 create_time)
              values
                (v_new_tablename,
                 'trx',
                 v_deal_type,
                 v_min_time,
                 '',
                 0,
                 sysdate);
            end;
          end;

        end if;
      end;

      --Ω®00X±Ì
      begin
        --»°◊Ó¥Ûµƒ¿˙ ∑±Ì
        select max(table_name)
          into v_max_table
          from acc_st.st_idx_trx_history
         where data_type = 'trx'
           and recd_type = v_deal_type;
      end;

      if v_max_table is null then
        continue;
      end if;

      begin
        --select substr(v_max_table, v_begin_index, 6),
    --20150424 modify by mqf ∏ƒŒ™»°∑÷±Ìµƒ”“6Œª
    select substr(trim(v_max_table), -6),
               recd_count,
               to_char(end_date + 1, 'yyyy-mm-dd')
          into v_temp_num, v_count, v_new_date
          from acc_st.st_idx_trx_history
         where table_name = v_max_table;

        begin
          --œ¬“ª∑÷±Ìµƒ–Ú¡–∫≈
          v_temp_num := acc_st.up_dm_st_tableno(to_number(v_temp_num)); --20150427 modify by mqf ‘ˆº”◊™ªªto_number()
        end;
      end;

      begin
        if (v_count >= v_limit_count) then
          v_new_tablename := v_ab_name || v_temp_num;

          select REGEXP_REPLACE(v_table_sql, '%s', v_new_tablename)
            into v_temp_sql
            from dual;

          --execute immediate v_temp_sql; --¥¥Ω®00000X∑÷±Ì



      --20160707 add by mqf √ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
      --¥¥Ω®00000X∑÷±Ì
            declare
              cursor sql_cur is
                select * from table(up_dm_st_splitstr(v_temp_sql, ';'));
            begin
              for t_cur in sql_cur loop
                v_table_sql := t_cur.column_value;
                if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                  execute immediate v_table_sql; --¥¥Ω®000X∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                end if;
              end loop;
            end;

          v_min_time := to_date(v_new_date || ' 00:00:00',
                                'yyyy-mm-dd hh24:mi:ss');

          v_max_time := to_date(v_new_date || ' 23:59:59',
                                'yyyy-mm-dd hh24:mi:ss');
          acc_st.up_dm_st_mv_log(v_in_que,
                          v_new_tablename,
                          '0000000000',
                          sysdate,
                          sysdate,
                          0,
                          0,
                          '≥…π¶¥¥Ω®' || v_new_tablename || '±Ì',
                          'create table ' || v_new_tablename || '...');

          insert into acc_st.st_idx_trx_history
            (table_name,
             data_type,
             recd_type,
             begin_date,
             end_date,
             recd_count,
             create_time)
          values
            (v_new_tablename,
             'trx',
             v_deal_type,
             v_min_time,
             v_max_time,
             0,
             sysdate);

        end if;

      end;

    end loop;
  end;
  commit;
  out_msg       := v_new_tablename;
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_his_create1;
/
grant execute on ACC_ST.UP_DM_ST_HIS_CREATE1 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_HIS_MV1
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_his_mv1(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                    out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                    ) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_his_mv1
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫µ•≥Ã∆±∑¢ €°¢«Æ∞¸Ωª“◊°¢Ω¯’æ°¢∏¸–¬ ˝æ›µπ¿˙ ∑±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131020
  --–ﬁ∏ƒ»’∆⁄£∫ 20150424 by mqf
  --–ﬁ∏ƒƒ⁄»›£∫ ∞¥»’∆⁄±È¿˙£¨º«¬º ˝¥Û”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝‘ÚÕ£÷π«®“∆ ˝æ›£¨–¬Ω®∑÷±Ì‘Ÿ«®“∆ ˝æ›°£
             --Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±ÌµƒŒ Ã‚
   --–ﬁ∏ƒ»’∆⁄£∫20160704 modify by mqf
   --–ﬁ∏ƒƒ⁄»›£∫1. ˝æ›«®“∆µΩ∑÷±ÌÕ¨ ±≤Â»Î«ÂÀ„¡˜ÀÆ∫≈º«¬ºµΩ«ÂÀ„¡˜ÀÆ∫≈À˜“˝±ÌST_IDX_TRX_HISTORY_BALANCE,
   --         2.πÿ±’”Œ±Í
   --–ﬁ∏ƒ»’∆⁄£∫20170123 add by mqf
   --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”π´Ωªœ˚∑—¿˙ ∑±Ì«®“∆µΩ∑÷±Ì,π´Ωªœ˚∑—¿˙ ∑±ÌÕ≥º∆µƒ«ÂÀ„¡˜ÀÆ∫≈“≤≤Â»Î«ÂÀ„¡˜ÀÆ∫≈À˜“˝±ÌST_IDX_TRX_HISTORY_BALANCE
   --–ﬁ∏ƒ»’∆⁄£∫20170321 modify by mqf
   --–ﬁ∏ƒƒ⁄»›£∫”≈ªØ£¨≤ª π”√ƒ⁄∫Ø ˝to_char£¨∏ƒŒ™÷µto_date◊™ªª
  -------------------------------------------------------------------------------
 AS

  v_msg            VARCHAR2(50);
  v_sql            varchar2(5000);
  v_sql2           varchar2(5000);
  v_new_end        date; --–¬µƒΩ· ¯ ±º‰
  v_min_time       date; --buf±Ì÷–µƒ◊Ó–°Ωª“◊ ±º‰
  v_max_time       date; --buf±Ì÷–µƒ◊Ó¥ÛΩª“◊ ±º‰
  v_min_table      VARCHAR2(30); --◊Ó–°Ωª“◊ ±º‰∂‘”¶µƒ◊Ó–°µƒ¿˙ ∑±Ì√˚
  v_max_table      VARCHAR2(30); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count          number(18);
  v_deal_type      char(2); --Ωª“◊¿‡–Õ  50, 53, 54,56
  v_time_type      VARCHAR2(20);
  v_column         VARCHAR2(2000);
  v_tmp1           VARCHAR2(256);
  v_cost_seconds   number;
  begin_time       date; --«®“∆ø™ º ±º‰
  keep_days        int; --¿˙ ∑±Ì ˝æ›±£¥ÊÃÏ ˝
  end_clear_time   VARCHAR2(20);
  begin_clear_time VARCHAR2(20);
  v_in_que         VARCHAR2(50);
  v_table_sql      varchar2(5000); --sql”Ôæ‰
  v_begin_date     date;
  v_where_sql      varchar2(500);

  --20140424 add by mqf
  v_recd_count integer; --À˜“˝±Ì“—∏¸–¬º«¬º ˝
  divide_recd_count integer; --≈‰÷√±Ì◊Ó¥Ûº«¬º ˝
  v_rowcount  integer; --∏¸–¬º«¬º ˝
  v_time_type_value varchar2(20); --»’∆⁄
  TYPE MYCURSOR IS REF CURSOR;  --∂®“Â”Œ±Í¿‡–Õ
  cur_date_type MYCURSOR;       --∂®“Â”Œ±Í
  v_datetime_begin     varchar2(20); --±È¿˙µƒø™ º ±º‰
  v_datetime_end     varchar2(20); --±È¿˙µƒΩ· ¯ ±º‰
  v_datetime_where_sql  varchar2(2048);

  --20160704
  v_idx_balance_count  integer; --≤Â»Î«ÂÀ„¡˜ÀÆ∫≈À˜“˝±ÌST_IDX_TRX_HISTORY_BALANCEº«¬º ˝
BEGIN
  declare
    cursor scc_table is
      select t.origin_table_name tmp_origin_table,
             t.create_sql        tmp_create_sql,
             t.is_squadday       tmp_is_squadday,
             t.ab_name           tmp_ab_name,
             t.table_columns     tmp_table_columns,
             t.date_type         tmp_date_type,
             t.keep_days         tmp_keep_days,
       t.divide_recd_count tmp_divide_recd_count
        from acc_st.st_cfg_clear_table t
       where t.db_type = 'trx';
  begin
    for i_cur in scc_table loop

      v_time_type := i_cur.tmp_date_type; -- ±º‰¿‡–Õ
      v_in_que    := i_cur.tmp_origin_table; --‘¥±Ì “—∞¸∫¨”√ªß«∞◊∫acc_st_his
      v_table_sql := i_cur.tmp_create_sql; --Ω®±Ì”Ôæ‰
      v_column    := i_cur.tmp_table_columns;
      keep_days   := i_cur.tmp_keep_days;
    --20150424 add by mqf
    divide_recd_count := trim(i_cur.tmp_divide_recd_count);
    --20150424 modify by mqf ∆¡±ŒŒ¥ π”√±‰¡ø
    /*
      --»°Ωª“◊ ˝æ›÷–◊Ó–°µƒΩª“◊ ±º‰
      v_tmp1 := ' select min(' || v_time_type || ') from ' || v_in_que;
      execute immediate v_tmp1
        into v_min_time;

      --»°Ωª“◊ ˝æ›÷–◊Ó¥ÛµƒΩª“◊ ±º‰
      v_tmp1 := 'select max(' || v_time_type || ') from ' || v_in_que;
      execute immediate v_tmp1
        into v_max_time;
    */

	  v_deal_type := ''; --20170123 add by mqf ƒ¨»œŒ™ø’

      if v_in_que = 'acc_st_his.st_his_deal' then
        --«Æ∞¸Ωª“◊st_his_deal
        v_deal_type := '54';
      elsif v_in_que = 'acc_st_his.st_his_entry' then
        --Ω¯’æΩª“◊ st_his_entry
        v_deal_type := '53';
      elsif v_in_que = 'acc_st_his.st_his_sale_sjt' then
        --µ•≥Ã∆±∑¢ € st_buf_sale_sjt
        v_deal_type := '50';
      elsif v_in_que = 'acc_st_his.st_his_update' then
        --∏¸–¬Ωª“◊st_buf update
        v_deal_type := '56';
	  elsif v_in_que = 'acc_st_his.st_ext_mtr_his_deal' then --20170123 add by mqf ‘ˆº”π´Ωªœ˚∑—¿˙ ∑±Ì
        v_deal_type := '94';
      end if;
      begin
        select min(table_name)
          into v_min_table
          from acc_st.st_idx_trx_history
         where data_type = 'trx'
           and recd_type = v_deal_type;
      exception
        when OTHERS THEN
          begin
            out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                             dbms_utility.format_error_backtrace() || ']––';
            out_retresult := sqlcode;
            continue;
          end;
      end;
      if v_min_table is null then
        continue;
      end if;

      select max(table_name)
        into v_max_table
        from acc_st.st_idx_trx_history
       where data_type = 'trx'
         and recd_type = v_deal_type;

      --∂®“Â»°≥ˆÀ˘”––Ë“™µº»Î ˝æ›µƒHis±Ìµƒ”Œ±Í
      --(◊Ó¥Ûµƒ¿˙ ∑±Ì–Ë“™Ãÿ ‚¥¶¿Ì,∏¸∏ƒst_idx_trx_history±Ì÷–∂‘”¶µƒΩ· ¯ ±º‰)
      declare
        cursor cu_table is
          select table_name,
                 to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss') begin_date,
                 to_char(end_date, 'yyyy-mm-dd hh24:mi:ss') end_date
            from acc_st.st_idx_trx_history
           where data_type = 'trx'
             and recd_type = v_deal_type
             and table_name >= v_min_table
             and table_name < v_max_table;
      begin
        for my_cur in cu_table loop

          v_tmp1 := 'lock table acc_st_his.' || my_cur.table_name ||
                    ' in  exclusive mode nowait';
          execute immediate v_tmp1;

          begin_time  := sysdate;
          v_where_sql := ' where ' || v_time_type || ' <= to_date(' || '''' ||
                         my_cur.end_date ||
                         ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
                         v_time_type || ' >= to_date(' || '''' ||
                         my_cur.begin_date ||
                         ''',''yyyy-mm-dd hh24:mi:ss'')';
          v_sql       := 'select count(*) from ' || v_in_que || v_where_sql;
          execute immediate v_sql
            into v_count;

          --–Ë«®“∆µƒ ˝æ›µ»”⁄0ÕÀ≥ˆ±æ¥Œ—≠ª∑
          if 0 = v_count then
            continue;
          end if;

          --∞— ˝æ›∞¥Ωª“◊ ±º‰≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
          v_sql := 'insert into acc_st_his.' || my_cur.table_name || '(' ||
                   v_column || ') select ' || v_column || ' from ' ||
                   v_in_que || v_where_sql;

          execute immediate v_sql;

          --…æ≥˝‘¥±Ì ˝æ›
      /*
          v_sql := 'delete from ' || v_in_que || v_where_sql;
          execute immediate v_sql;
      */

          v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
          out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩ' ||
                            my_cur.table_name || '£¨π≤' || v_count || 'Ãı';
          acc_st.up_dm_st_mv_log(v_in_que,
                          my_cur.table_name,
                          '0000000000',
                          begin_time,
                          sysdate,
                          v_cost_seconds,
                          v_count,
                          out_msg,
                          v_sql);--20150520 modify by mqf v_sql2∏ƒŒ™v_sql

          update acc_st.st_idx_trx_history
             set recd_count = recd_count + v_count
           where table_name = my_cur.table_name;

          --20160704 add by mqf ≤Â»Î«ÂÀ„¡˜ÀÆ∫≈À˜“˝±ÌST_IDX_TRX_HISTORY_BALANCE
		  begin_time  := sysdate;
		  v_sql := 'insert into acc_st.ST_IDX_TRX_HISTORY_BALANCE (table_name,data_type,recd_type,balance_water_no,create_time) '
					|| ' select ''' || my_cur.table_name || ''', ''trx'', ''' || v_deal_type || ''', balance_water_no, sysdate from ' || v_in_que || v_where_sql
					|| ' and not exists(select 1 from acc_st.ST_IDX_TRX_HISTORY_BALANCE '
					|| '    where table_name='''|| my_cur.table_name || ''' and balance_water_no = ' || v_in_que || '.balance_water_no )'
					|| ' group by balance_water_no';
		  execute immediate v_sql;
		  v_idx_balance_count := sql%rowcount;

		  if v_idx_balance_count >0 then
			  v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
			  out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩacc_st.ST_IDX_TRX_HISTORY_BALANCE£¨π≤' || v_idx_balance_count || 'Ãı';
			  acc_st.up_dm_st_mv_log(v_in_que,
							  'acc_st.ST_IDX_TRX_HISTORY_BALANCE',
							  '0000000000',
							  begin_time,
							  sysdate,
							  v_cost_seconds,
							  v_idx_balance_count,
							  out_msg,
							  v_sql);
		  end if;
          --end 20160704


      begin_time  := sysdate;  --20150520 add by mqf
      --…æ≥˝‘¥±Ì ˝æ›
          v_sql := 'delete from ' || v_in_que || v_where_sql;
          execute immediate v_sql;

      --20150520 add by mqf
      out_msg := '¥”' || v_in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';
      v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);

      acc_st.up_dm_st_mv_log(v_in_que,
              '0',
              '0000000000',
              begin_time,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql);

        end loop;
        commit;
      end;

      --∂‘◊Ó¥Ûµƒ¿˙ ∑±Ìµº»Î ˝æ›
    --20150424  «∑Ò”¶∑≈‘⁄œ¬√Ê£¨insert«∞√Ê£¨”–ø…ƒ‹º«¬ºŒ™0
      v_tmp1 := 'lock table acc_st_his.' || v_max_table ||
                ' in exclusive mode';
      execute immediate v_tmp1;

      end_clear_time := to_char(sysdate - keep_days,
                                'yyyy-mm-dd hh24:mi:ss');
      v_new_end      := to_date(substr(end_clear_time, 1, 10) ||
                                ' 23:59:59',
                                'yyyy-mm-dd hh24:mi:ss');
      end_clear_time := to_char(v_new_end, 'yyyy-mm-dd hh24:mi:ss');
      --20150424 modify by mqf ‘ˆº”≤È—Ørecd_count
      select begin_date,recd_count
        into v_begin_date,v_recd_count
        from acc_st.st_idx_trx_history
       where table_name = v_max_table; --«®“∆µƒ◊‹º«¬º ˝
      begin_clear_time := to_char(v_begin_date, 'yyyy-mm-dd hh24:mi:ss');
	  /*
      v_where_sql      := ' where to_char(' || v_time_type ||
                          ',''yyyy-mm-dd hh24:mi:ss'')  >= ''' ||
                          begin_clear_time || '''  and  to_char(' ||
                          v_time_type ||
                          ',''yyyy-mm-dd hh24:mi:ss'')  <=''' ||
                          end_clear_time || '''';
						  */
	  --20170321 modify by mqf ”≈ªØ£¨≤ª π”√ƒ⁄∫Ø ˝to_char£¨∏ƒŒ™÷µto_date◊™ªª
	  v_where_sql      := ' where ' || v_time_type || ' >= to_date(' || '''' ||
                         begin_clear_time ||
                         ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
                         v_time_type || ' <= to_date(' || '''' ||
                         end_clear_time ||
                         ''',''yyyy-mm-dd hh24:mi:ss'')';

      --À˜“˝±Ì“—«®“∆º«¬º¥Û”⁄ªÚµ»”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ã¯µΩ“ª¥Œ—≠ª∑ 20150520 modify by mqf
      if v_recd_count>=divide_recd_count then
      continue;
    end if;

      v_sql2 := 'select count(*) from ' || v_in_que || v_where_sql;
      execute immediate v_sql2
        into v_count;
      --«®“∆µƒ◊‹º«¬º ˝µ»”⁄0ÕÀ≥ˆ±æ¥Œ—≠ª∑
      if 0 = v_count then
        continue;
      end if;

    --20150424 add by mqf ∞¥»’∆⁄±È¿˙£¨Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±Ì÷–°£
    --'yyyyMMdd'
    --20150424 add by mqf …Ë÷√begin_time
    begin_time := sysdate;
    v_sql := ' select distinct to_char(' || v_time_type || ', ''yyyy-mm-dd'') from ' || v_in_que || v_where_sql
        || ' order by to_char(' || v_time_type || ', ''yyyy-mm-dd'')';
    --∏¸–¬º«¬º ˝≥ı ºŒ™0
    v_rowcount := 0;

    open cur_date_type for v_sql;
    loop
      fetch cur_date_type into v_time_type_value;
      exit when cur_date_type%notfound;

      --≥¨π˝∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ω· ¯—≠ª∑
      if (v_recd_count+v_rowcount>=divide_recd_count) then
        exit;
      end if;
      v_datetime_begin := v_time_type_value || ' 00:00:00';
      v_datetime_end := v_time_type_value || ' 23:59:59';
	  /*
      v_datetime_where_sql     := ' where to_char(' || v_time_type ||
                          ',''yyyy-mm-dd hh24:mi:ss'')  >= ''' ||
                          v_datetime_begin || '''  and  to_char(' ||
                          v_time_type ||
                          ',''yyyy-mm-dd hh24:mi:ss'')  <=''' ||
                          v_datetime_end || '''';
						  */

	  --20170321 modify by mqf ”≈ªØ£¨≤ª π”√ƒ⁄∫Ø ˝to_char£¨∏ƒŒ™÷µto_date◊™ªª
	  v_datetime_where_sql     := ' where ' || v_time_type || ' >= to_date(' || '''' ||
                         v_datetime_begin ||
                         ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
                         v_time_type || ' <= to_date(' || '''' ||
                         v_datetime_end ||
                         ''',''yyyy-mm-dd hh24:mi:ss'')';

      v_sql := ' insert into acc_st_his.' || v_max_table || '(' || v_column || ')' ||
           ' select ' || v_column || ' from ' || v_in_que ||
           v_datetime_where_sql;


      execute immediate v_sql;
      --¿€º”∏¸–¬º«¬º ˝
      v_rowcount := v_rowcount + sql%rowcount;
    end loop;
    close cur_date_type; --20160901 add by mqf πÿ±’”Œ±Í

    --20150424 add by mqf v_whereSql”√”⁄…æ≥˝º«¬º
	/*
    v_where_sql      := ' where to_char(' || v_time_type ||
                          ',''yyyy-mm-dd hh24:mi:ss'')  >= ''' ||
                          begin_clear_time || '''  and  to_char(' ||
                          v_time_type ||
                          ',''yyyy-mm-dd hh24:mi:ss'')  <=''' ||
                          v_datetime_end || '''';
						  */

    --20170321 modify by mqf ”≈ªØ£¨≤ª π”√ƒ⁄∫Ø ˝to_char£¨∏ƒŒ™÷µto_date◊™ªª
    v_where_sql      := ' where ' || v_time_type || ' >= to_date(' || '''' ||
						 begin_clear_time ||
						 ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
						 v_time_type || ' <= to_date(' || '''' ||
						 v_datetime_end ||
						 ''',''yyyy-mm-dd hh24:mi:ss'')';
    v_new_end := to_date(v_datetime_end, 'yyyy-mm-dd hh24:mi:ss');
    v_count := v_rowcount;


    --20150424 by mqf ∆¡±Œ
      --begin_time := sysdate;

      v_cost_seconds := round(to_number(sysdate - begin_time) * 24 * 60 * 60);
      out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩ' || v_max_table || '£¨π≤' ||
                        v_count || 'Ãı';

      acc_st.up_dm_st_mv_log(v_in_que,
                      v_max_table,
                      '0000000000',
                      begin_time,
                      sysdate,
                      v_cost_seconds,
                      v_count,
                      out_msg,
                      v_sql); --20150424 out_msg ∏ƒŒ™ v_sql


    if v_count >0 then --20150512 add by mqf º«¬º¥Û”⁄0≤≈∏¸–¬À˜“˝±Ì°¢…æ≥˝‘¥±Ì ˝æ›
        --∏¸–¬st_idx_trx_history±Ì–≈œ¢
      update acc_st.st_idx_trx_history
       set recd_count = recd_count + v_count, end_date = v_new_end
       where table_name = v_max_table;

      --20160704 add by mqf ◊Ó¥Ûµƒ¿˙ ∑±Ì  ≤Â»Î«ÂÀ„¡˜ÀÆ∫≈À˜“˝±ÌST_IDX_TRX_HISTORY_BALANCE
	  begin_time  := sysdate;
	  v_sql := 'insert into acc_st.ST_IDX_TRX_HISTORY_BALANCE (table_name,data_type,recd_type,balance_water_no,create_time) '
				|| ' select ''' || v_max_table || ''', ''trx'', ''' || v_deal_type || ''', balance_water_no, sysdate from ' || v_in_que || v_where_sql
				|| ' and not exists(select 1 from acc_st.ST_IDX_TRX_HISTORY_BALANCE '
				|| '    where table_name='''|| v_max_table || ''' and balance_water_no = ' || v_in_que || '.balance_water_no )'
				|| ' group by balance_water_no';

	  execute immediate v_sql;
	  v_idx_balance_count := sql%rowcount;

	  if v_idx_balance_count >0 then
		  v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
		  out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩacc_st.ST_IDX_TRX_HISTORY_BALANCE£¨π≤' || v_idx_balance_count || 'Ãı';
		  acc_st.up_dm_st_mv_log(v_in_que,
						  'acc_st.ST_IDX_TRX_HISTORY_BALANCE',
						  '0000000000',
						  begin_time,
						  sysdate,
						  v_cost_seconds,
						  v_idx_balance_count,
						  out_msg,
						  v_sql);
	  end if;
      --end 20160704


      ---------…æ≥˝¿˙ ∑ ˝æ›ø™ º--------------------------------------------
      begin_time := sysdate;

      --…æ≥˝≤Ÿ◊˜
      v_sql := 'delete from  ' || v_in_que || v_where_sql;
      execute immediate v_sql;

      --º«¬º»’÷æ
      out_msg := '¥”' || v_in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';

      v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);

      acc_st.up_dm_st_mv_log(v_in_que,
              '0',
              '0000000000',
              begin_time,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql); --20150424 out_msg ∏ƒŒ™ v_sql
      ---------…æ≥˝¿˙ ∑ ˝æ›Ω· ¯--------------------------------------------
    end if;

    end loop;
  end;
  commit;
  out_msg       := ' ˝æ›«®“∆≥…π¶';
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_his_mv1;
/
grant execute on ACC_ST.UP_DM_ST_HIS_MV1 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_RPT_CREATE1
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_rpt_create1(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                 out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                 )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_rpt_create1
  --π¶ƒ‹√Ë ˆ£∫Ω®¡¢÷–—Î«ÂÀ„∏˜÷–º‰±Ìµƒ¿˙ ∑∑÷±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫201301023
  --–ﬁ∏ƒ£∫
  -------------------------------------------------------------------------------
 AS

  v_msg      varchar(50);
  v_count    number(18); --¡Ÿ ±Õ≥º∆±‰¡ø
  v_flag     number(1); --¥¥Ω®0001µƒ±Í÷æ£¨0£∫¥¥Ω®
  v_time     varchar2(20);
  v_count2   number(18); --¡Ÿ ±Õ≥º∆±‰¡ø
  v_min_time varchar2(10); --◊Ó–°‘À”™ ±º‰
  -- v_max_time     varchar2(10); --◊Ó¥Û‘À”™ ±º‰
  v_temp_sql     varchar2(4000); --¡Ÿ ±sql”Ôæ‰
  v_temp_num     varchar2(6); --∑÷±Ì–Ú¡–∫≈ --20150428 modify by mqf ∏ƒŒ™6Œª
  v_table_sql    varchar2(4000); --Ω®±Ì¡Ÿ ±sql”Ôæ‰
  new_table_name varchar2(40); --∑÷±Ì±Ì√˚
  --v_min_balance_no varchar2(10); --◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
  --v_max_balance_no varchar2(10); -- ◊Ó–°«ÂÀ„¡˜ÀÆ
BEGIN
  begin
    out_msg       := 'Ω®±Ì≥…π¶';
    out_retResult := sqlcode;
    declare
      cursor scc_table is
        select t.origin_table_name tmp_origin_table, --∞¸∫¨”√ªß«∞◊∫acc_st
               t.create_sql        tmp_create_sql,
               t.is_squadday       tmp_is_squadday,
               t.ab_name           tmp_ab_name
          from acc_st.st_cfg_clear_table t
         where t.db_type = 'rpt'
           and t.is_squadday = 1; --”–‘À”™»’±Í÷æ
    begin
      for i_cur in scc_table loop
        begin
          v_flag := 2;
          --“ÚŒ™”––©‘≠±Ì√˚Ã´≥§£¨À˘“‘…˙≥…µƒ∑÷±Ì≤…”√◊‘∂®“Âµƒ±Ì√˚£¨øÿ÷∆¡À≥§∂»
          --new_table_name := i_cur.tmp_ab_name || '_0001';
      new_table_name := i_cur.tmp_ab_name || '000001'; --20150426 modify by mqf Õ≥º∆ π”√6Œª ˝◊÷
          begin
            v_table_sql := 'select count(*)  from ' ||
                           i_cur.tmp_origin_table;
            execute immediate v_table_sql
              into v_count;
            if 0 = v_count then
              continue;
            end if;
          end;

          begin
            select count(*)
              into v_count
              from acc_st.st_idx_rpt_history
             where table_name like i_cur.tmp_ab_name || '_%';
          end;
          begin

            v_temp_sql := 'select count(*) from dba_objects where object_name = upper (''' ||
                          new_table_name ||
                          ''') and owner=''ACC_ST'' and object_type =''TABLE''';
            execute immediate v_temp_sql
              into v_count2;
          end;
        exception
          when OTHERS THEN
            begin
              out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                               dbms_utility.format_error_backtrace() ||
                               ']––,' || new_table_name || ',' ||
                               v_table_sql;
              out_retResult := sqlcode;
              acc_st.up_dm_st_mv_log(i_cur.tmp_origin_table,
                              new_table_name,
                              '',
                              sysdate,
                              sysdate,
                              0,
                              0,
                              '¥¥Ω®' || new_table_name || ' ß∞‹',
                              out_msg);
              continue;
            end;
        end;

        begin
          if v_count = 0 then
            --st_idx_rpt_history√ª”–∂‘”¶∑÷±Ìµƒº«¬º
            if v_count2 > 0 then
              --∑÷±ÌµƒŒÔ¿Ì±Ì¥Ê‘⁄
              v_temp_sql := 'drop table acc_st.' || new_table_name;
              execute immediate v_temp_sql; --…æ≥˝0001∑÷±Ì±Ì

            end if;
            v_flag := 0;

          else
            ----st_idx_rpt_history”–∂‘”¶∑÷±Ìµƒº«¬º
            if v_count2 = 0 then
              --∑÷±ÌµƒŒÔ¿Ì±Ì≤ª¥Ê‘⁄
              v_flag := 0;
            end if;
          end if;

        end;
        if v_flag = 0 then
          --œ»Ω®±Ì£¨‘Ÿ≥ı ºªØ
          begin
            --Ω®0001±Ì
            begin
              --ªÒ»°Ω®±Ì”Ôæ‰
              --ÃÊªª±Ì√˚
              select regexp_replace(i_cur.tmp_create_sql,
                                    '%s',
                                    new_table_name)
                into v_temp_sql
                from dual;

              --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
              declare
                cursor sql_cur is
                  select * from table(acc_st.up_dm_st_splitstr(v_temp_sql, ';'));
              begin
                for t_cur in sql_cur loop
                  v_table_sql := t_cur.column_value;
                  if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                    execute immediate v_table_sql; --¥¥Ω®0001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                  end if;
                end loop;
              end;
            end;

      --20150512 add by mqf ‘ˆº”»’÷æ
      acc_st.up_dm_st_mv_log(i_cur.tmp_origin_table,
                new_table_name,
                '',
                sysdate,
                sysdate,
                0,
                0,
                '≥…π¶¥¥Ω®' || new_table_name || '±Ì',
                'create table ' || new_table_name || '...');

            select to_char(sysdate - 1, 'yyyymmdd') into v_time from dual;
            /**
            --º∆À„◊Ó–°°¢◊Ó¥Û¡˜ÀÆ∫≈°¢◊Ó–°‘À”™»’£¨◊Ó¥Û‘À”™»’
            v_temp_sql := 'select min(t.squad_day)  from ' ||
                          i_cur.tmp_origin_table ||
                          ' t where t.balance_water_no <=''' || v_time || '''';
            execute immediate v_temp_sql
              into v_min_time;**/

            v_min_time := '20130501'; -- ˝æ›◊‹”–—”≥Ÿ£¨…Ë∂®“ª∏ˆ≥ı º ±º‰

            select count(*)
              into v_count
              from acc_st.st_idx_rpt_history
             where table_name = new_table_name;
            if v_count = 0 then
              insert into acc_st.st_idx_rpt_history
                (table_name,
                 origin_table_name,
                 min_squad_day,
                 max_squad_day,
                 recd_count,
                 create_time)
              values
                (new_table_name,
                 i_cur.tmp_origin_table,
                 v_min_time,
                 '',
                 0,
                 sysdate);
            end if;

          exception
            when OTHERS THEN
              begin
                out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                                 dbms_utility.format_error_backtrace() ||
                                 ']––,' || new_table_name;
                out_retResult := sqlcode;
                acc_st.up_dm_st_mv_log(i_cur.tmp_origin_table,
                                new_table_name,
                                '',
                                sysdate,
                                sysdate,
                                0,
                                0,
                                '¥¥Ω®' || new_table_name || ' ß∞‹',
                                out_msg);
                continue;
              end;
        /* 20150512 modify by mqf ∆¡±Œ
              up_dm_st_mv_log(i_cur.tmp_origin_table,
                              new_table_name,
                              '',
                              sysdate,
                              sysdate,
                              0,
                              0,
                              '¥¥Ω®' || new_table_name || '≥…π¶',
                              out_msg);
                */

          end;
        end if;
      end loop;

    end;

  end;

  --“‘œ¬Œ™¥¥Ω®∑«0001±Ì
  begin
    declare
      cursor cu_table is
        select regexp_substr(a.table_name, '.{1,6}$') tmp_i_list_no, --'20150426 modify by mqf Õ≥º∆ π”√6Œª ˝◊÷ '.{1,4}$' ∏ƒŒ™ '.{1,6}$'
               a.recd_count tmp_recd_count,
               --to_char(to_date(substr(a.end_balance_no, 0, 8), 'yyyymmdd') + 1, 'yyyymmdd') || '01' tmp_max_balance_no,
               to_char(to_date(a.max_squad_day, 'yyyymmdd') + 1, 'yyyymmdd') tmp_max_squad_day,
               a.origin_table_name tmp_origin_table,
               b.divide_recd_count tmp_divide_recd,
               b.create_sql tmp_create_sql,
               b.is_squadday tmp_is_squadDay,
               b.ab_name tmp_ab_name
          from acc_st.st_idx_rpt_history a, acc_st.st_cfg_clear_table b
         where a.origin_table_name = b.origin_table_name
           and b.db_type = 'rpt'
           and b.is_squadday = 1
           and a.table_name in
               (select max(table_name)
                  from st_idx_rpt_history
                 group by origin_table_name);

    begin
      for my_cur in cu_table loop
        begin
          begin
            if my_cur.tmp_recd_count >= my_cur.tmp_divide_recd then
              --¥ÔµΩ≈‰÷√±Ì÷–µƒ◊Ó¥Ûº«¬º ˝£¨–Ë“™Ω®±Ì
              --œ¬“ª∑÷±Ìµƒ–Ú¡–∫≈
              v_temp_num     := up_dm_st_tableno(my_cur.tmp_i_list_no);
              new_table_name := my_cur.tmp_ab_name || v_temp_num; --20150428 modify by mqf »•µÙ '_'
              begin
                v_temp_sql := 'select count(*) from user_objects where object_name = upper (''' ||
                              new_table_name || ''')';
                execute immediate v_temp_sql
                  into v_count2;
                if v_count2 > 0 then
                  --…æ≥˝∏√±Ì
                  v_temp_sql := 'drop table  acc_st.' || new_table_name;
                  execute immediate v_temp_sql;
                end if;
              end;

              --ªÒ»°Ω®±Ì”Ôæ‰
              --ÃÊªª±Ì√˚
              select REGEXP_REPLACE(my_cur.tmp_create_sql,
                                    '%s',
                                    new_table_name)
                into v_table_sql
                from dual;

              --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
              declare
                cursor sql_cur is
                  select * from table(acc_st.up_dm_st_splitstr(v_table_sql, ';'));
              begin
                for t_cur in sql_cur loop
                  v_temp_sql := t_cur.column_value;
                  if trim(v_temp_sql) is not null and v_temp_sql <> ' ' then
                    execute immediate v_temp_sql; --¥¥Ω®0001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                  end if;
                end loop;

              exception
                when OTHERS THEN
                  begin
                    out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                                     dbms_utility.format_error_backtrace() ||
                                     ']––,' || new_table_name;
                    out_retResult := sqlcode;
                    acc_st.up_dm_st_mv_log(my_cur.tmp_origin_table,
                                    new_table_name,
                                    '',
                                    sysdate,
                                    sysdate,
                                    0,
                                    0,
                                    '¥¥Ω®' || new_table_name || ' ß∞‹',
                                    '¥¥Ω®' || new_table_name || ' ß∞‹');
                    continue;
                  end;
          /*
                  up_dm_st_mv_log(my_cur.tmp_origin_table,
                                  new_table_name,
                                  '',
                                  sysdate,
                                  sysdate,
                                  0,
                                  0,
                                  '¥¥Ω®' || new_table_name || '≥…π¶',
                                  '¥¥Ω®' || new_table_name || '≥…π¶');
                  */
              end;
        --20150512 modify by mqf Œª÷√µ˜’˚‘⁄’‚¿Ô
        acc_st.up_dm_st_mv_log(my_cur.tmp_origin_table,
                                  new_table_name,
                                  '',
                                  sysdate,
                                  sysdate,
                                  0,
                                  0,
                                  '¥¥Ω®' || new_table_name || '≥…π¶',
                                  '¥¥Ω®' || new_table_name || '≥…π¶');

              begin

                v_min_time := my_cur.tmp_max_squad_day;
                --v_max_time := my_cur.tmp_max_squad_day;

                insert into acc_st.st_idx_rpt_history
                  (table_name,
                   origin_table_name,
                   min_squad_day,
                   max_squad_day,
                   recd_count,
                   create_time)
                values
                  (new_table_name,
                   my_cur.tmp_origin_table,
                   v_min_time,
                   '',
                   0,
                   sysdate);

              end;

            end if;
          end;

        end;
      end loop;
    end;

  end;
  commit;
  out_msg       := 'Ω®±Ì≥…π¶';
  out_retresult := 0;
exception
  when OTHERS THEN
    begin
      rollback;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––,' ||
                       new_table_name;
      out_retResult := sqlcode;
      return;
    end;

END up_dm_st_rpt_create1;
/
grant execute on ACC_ST.UP_DM_ST_RPT_CREATE1 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_RPT_CREATE2
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_rpt_create2(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                        out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                        ) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_rpt_create2
  --π¶ƒ‹√Ë ˆ£∫Ω®¡¢÷–º‰±Ìµƒ¿˙ ∑∑÷±Ì£®”–÷˜°¢¥”±Ì£¨»’∆⁄¥Ê‘⁄÷˜±Ì÷–£¨ ˝æ›‘⁄¥”±Ì÷–£©
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131021
  --–ﬁ∏ƒ»’∆⁄£∫20130303
  --–ﬁ∏ƒ£∫Ω´∑÷±Ì√˚÷–µƒ–Ú∫≈¿©’πµΩ6Œª
  --–ﬁ∏ƒ»’∆⁄£∫20140517 modify by mqf
  -------------------------------------------------------------------------------
 AS

  v_msg           VARCHAR(50);
  v_min_time      date; --buf±Ì÷–µƒ◊Ó–°Ωª“◊ ±º‰
  v_max_time      date; --buf±Ì÷–µƒ◊Ó¥ÛΩª“◊ ±º‰
  v_new_date      varchar2(20);
  v_max_table     varchar2(50); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count         number(18);
  v_count2        number(18);
  v_flag          number(1); --¥¥Ω®000001µƒ±Í÷æ£¨0£∫¥¥Ω®
  v_time          varchar2(20);
  v_balance_time  varchar2(20);
  v_temp_sql      varchar2(8000); --¡Ÿ ±sql”Ôæ‰
  v_table_sql     varchar2(5000); --Ω®±Ì¡Ÿ ±sql”Ôæ‰
  v_temp_num      varchar2(6); --∑÷±Ì–Ú¡–∫≈
  v_limit_count   number(18); --∏˜Ωª“◊¿‡–Õ∑÷±Ìœﬁ÷∆ ˝¡ø
  v_new_tablename varchar2(50);
  v_in_que        varchar2(50);
  v_time_type     varchar2(30);
  v_primarytable  VARCHAR2(50); --‘¥±Ì√˚∂‘”¶µƒ÷˜±Ì√˚
BEGIN
  --◊ÚÃÏ«ÂÀ„µƒ»’∆⁄(”√”⁄Ω®¡¢µ⁄“ª∏ˆ000001±Ì)
  select to_char(sysdate - 1, 'yyyymmdd') into v_balance_time from dual;
  declare
    cursor scc_table is
      select t.origin_table_name tmp_origin_table, --∞¸∫¨”√ªß«∞◊∫acc_st_his
             t.create_sql        tmp_create_sql,
             t.is_squadday       tmp_is_squadday,
             t.ab_name           tmp_ab_name,
             t.divide_recd_count tmp_divide_recd_count,
             t.date_type         tmp_date_type,
             t.primarytable      tmp_primarytable --÷˜±Ì±Ì√˚
        from acc_st.st_cfg_clear_table t
       where t.db_type = 'rpt'
         and t.is_squadday = 0
         and t.primarytable is not null; --”–÷˜±Ì
  begin
    for i_cur in scc_table loop
      --Ω®001±Ì
      --‘≠ º±Ì√ª”– ˝æ›£¨∑µªÿ
      begin
        v_flag      := 2;
        v_table_sql := 'select count(*)  from ' || i_cur.tmp_origin_table;
        execute immediate v_table_sql
          into v_count;
        if 0 = v_count then
          continue;
        end if;
      end;

      v_time_type     := i_cur.tmp_date_type; -- ±º‰¿‡–Õ
      v_in_que        := i_cur.tmp_ab_name; --‘¥±ÌÀı–¥
      v_table_sql     := i_cur.tmp_create_sql; --Ω®±Ì”Ôæ‰
      v_limit_count   := i_cur.tmp_divide_recd_count;
      v_primarytable  := i_cur.tmp_primarytable;
      v_new_tablename := v_in_que || '000001';

      begin
        begin
          select count(*)
            into v_count
            from acc_st.st_idx_rpt_history
           where table_name like '%' || v_in_que || '_%';
        end;
        begin
          v_temp_sql := 'select count(*) from dba_objects where object_name = upper (''' ||
                        v_new_tablename ||
                        ''') and owner=''ACC_ST_HIS'' and object_type =''TABLE''';
          execute immediate v_temp_sql
            into v_count2;
        end;
      end;
      if v_count = 0 then
        --st_idx_rpt_history√ª”–Ωª“◊∑÷±Ìµƒº«¬º
        if v_count2 > 0 then
          --∑÷±ÌµƒŒÔ¿Ì±Ì¥Ê‘⁄
          v_temp_sql := 'drop table acc_st_his.' || v_new_tablename;
          execute immediate v_temp_sql; --…æ≥˝000001∑÷±Ì±Ì
        end if;
        v_flag := 0;
      else
        ----st_idx_rpt_history”–Ωª“◊∑÷±Ìµƒº«¬º
        if v_count2 = 0 then
          --∑÷±ÌµƒŒÔ¿Ì±Ì≤ª¥Ê‘⁄
          v_flag := 0;
        end if;
      end if;

      begin
        if v_flag = 0 then

          begin

            select REGEXP_REPLACE(v_table_sql, '%s', v_new_tablename)
              into v_temp_sql
              from dual;

            --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
            declare
              cursor sql_cur is
                select * from table(acc_st.up_dm_st_splitstr(v_temp_sql, ';'));
            begin
              for t_cur in sql_cur loop
                v_table_sql := t_cur.column_value;
                if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                  execute immediate v_table_sql; --¥¥Ω®000001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                end if;
              end loop;
            end;

            acc_st.up_dm_st_mv_log(v_in_que,
                            v_new_tablename,
                            '0000000000',
                            sysdate,
                            sysdate,
                            0,
                            0,
                            '≥…π¶¥¥Ω®' || v_new_tablename || '±Ì',
                            'create table ' || v_new_tablename || '...');

          end;

          begin
            /**
            begin
              --µ⁄“ª¥Œ‘À––£¨»°÷Æ«∞µƒÀ˘”–µƒ«ÂÀ„ ˝æ›¥Ê∑≈µΩµ⁄“ª’≈±Ì
              v_temp_sql := 'select min(' || v_time_type || '),max(' ||
                            v_time_type || ') from ' || v_primarytable ||
                            ' where substr(balance_water_no,0,8)<= ''' ||
                            v_balance_time || '''';
              execute immediate v_temp_sql
                into v_min_time, v_max_time;
            end;**/
            begin
              -- ˝æ›ø…ƒ‹”–—”≥Ÿ
              v_time     := '2013-05-01'; --to_char(v_min_time, 'yyyy-mm-dd');
              v_min_time := to_date(v_time || ' 00:00:00',
                                    'yyyy-mm-dd hh24:mi:ss');
            end;
            /**
            begin
              v_time     := to_char(v_max_time, 'yyyy-mm-dd');
              v_max_time := to_date(v_time || ' 23:59:59',
                                    'yyyy-mm-dd hh24:mi:ss');
            end;**/
            -- ≥ı ºªØÀ˜“˝±Ì÷–µƒ0001±Ì
            begin
              insert into acc_st.st_idx_rpt_history
                (table_name,
                 origin_table_name,
                 begin_date,
                 end_date,
                 recd_count,
                 create_time)
              values
                ('acc_st_his.' || v_new_tablename,
                 i_cur.tmp_origin_table,
                 v_min_time,
                 '',
                 0,
                 sysdate);

            end;
          end;

        end if;
      end;

      --Ω®00000X±Ì
      begin
        --»°◊Ó¥Ûµƒ¿˙ ∑±Ì
        select max(table_name)
          into v_max_table
          from st_idx_rpt_history
         where origin_table_name = i_cur.tmp_origin_table;
      end;

      if v_max_table is null then
        continue;
      end if;

      begin
        v_temp_sql := 'select count(*)  from acc_st.st_idx_rpt_history  where table_name =''' ||
                      v_max_table || '''';
        execute immediate v_temp_sql
          into v_temp_num;
        v_temp_sql := 'select regexp_substr(table_name, ''.{1,6}$''), recd_count, to_char(end_date + 1, ''yyyy-mm-dd'')  from acc_st.st_idx_rpt_history     where table_name =''' ||
                      v_max_table || '''';
        execute immediate v_temp_sql
          into v_temp_num, v_count, v_new_date;
        /**
        select regexp_substr(table_name, '.{1, 4}$ '),
               recd_count,
               to_char(end_date + 1, ' yyyy - mm - dd ')
          into v_temp_num, v_count, v_new_date **/

        begin
          --œ¬“ª∑÷±Ìµƒ–Ú¡–∫≈
          v_temp_num := acc_st.up_dm_st_tableno(v_temp_num);
        end;
      end;

      begin
        if (v_count >= v_limit_count) then
          v_new_tablename := v_in_que || v_temp_num;

          select regexp_replace(v_table_sql, '%s', v_new_tablename)
            into v_temp_sql
            from dual;
          execute immediate v_temp_sql; --¥¥Ω®00000X∑÷±Ì

          v_min_time := to_date(v_new_date || ' 00:00:00',
                                'yyyy-mm-dd hh24:mi:ss');

          v_max_time := to_date(v_new_date || ' 23:59:59',
                                'yyyy-mm-dd hh24:mi:ss');
          acc_st.up_dm_st_mv_log(v_in_que,
                          v_new_tablename,
                          '0000000000',
                          sysdate,
                          sysdate,
                          0,
                          0,
                          ' ≥…π¶¥¥Ω® ' || v_new_tablename || '±Ì',
                          'create table  ' || v_new_tablename || '...');

          insert into acc_st.st_idx_rpt_history
            (table_name,
             origin_table_name,
             begin_date,
             end_date,
             recd_count,
             create_time)
          values
            ('acc_st_his.' || v_new_tablename,
             i_cur.tmp_origin_table,
             v_min_time,
             '',
             0,
             sysdate);

        end if;

      end;

    end loop;
  end;

  out_msg       := 'Ω®±Ì≥…π¶';
  out_retresult := 0;
  commit;
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[ ' ||
                       dbms_utility.format_error_backtrace() || ']–– ';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_rpt_create2;
/
grant execute on ACC_ST.UP_DM_ST_RPT_CREATE2 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_RPT_CREATE3
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_rpt_create3(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                        out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                        )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_rpt_create3
  --π¶ƒ‹√Ë ˆ£∫Ω®¡¢÷–º‰±Ìµƒ¿˙ ∑∑÷±Ì£®∞¥’’«ÂÀ„¡˜ÀÆ∫≈∑÷±Ì£©
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131021
  --–ﬁ∏ƒ£∫Ω´∑÷±Ì√˚÷–µƒ–Ú∫≈¿©’πµΩ6Œª
  --–ﬁ∏ƒ»’∆⁄£∫20140517

  -------------------------------------------------------------------------------
 AS

  v_msg              VARCHAR(50);
  v_min_bal_water_no varchar2(10); --◊Ó–°«ÂÀ„¡˜ÀÆ∫≈
  --v_max_bal_water_no varchar2(10); --◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
  v_new_bal_water_no varchar2(10);
  v_max_table        varchar2(30); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count            number(18);
  v_count2           number(18);
  v_flag             number(1); --¥¥Ω®001µƒ±Í÷æ£¨0£∫¥¥Ω®
  v_balance_time     varchar2(20);
  v_temp_sql         varchar2(8000); --¡Ÿ ±sql”Ôæ‰
  v_table_sql        varchar2(5000); --Ω®±Ì¡Ÿ ±sql”Ôæ‰
  v_temp_num         varchar2(6); --∑÷±Ì–Ú¡–∫≈
  v_limit_count      number(18); --∏˜Ωª“◊¿‡–Õ∑÷±Ìœﬁ÷∆ ˝¡ø
  v_new_tablename    varchar2(30);
  v_in_que           varchar2(30);
  v_time_type        varchar2(30);
  v_owner            varchar2(11);
BEGIN
  --◊ÚÃÏ«ÂÀ„µƒ»’∆⁄(”√”⁄Ω®¡¢µ⁄“ª∏ˆ0001±Ì)
  select to_char(sysdate - 1, 'yyyymmdd') into v_balance_time from dual;
  declare
    cursor scc_table is
      select t.origin_table_name tmp_origin_table, --∞¸∫¨”√ªß«∞◊∫acc_stªÚacc_st_his
             t.create_sql        tmp_create_sql,
             t.is_squadday       tmp_is_squadday,
             t.ab_name           tmp_ab_name,
             t.divide_recd_count tmp_divide_recd_count,
             t.date_type         tmp_date_type,
             t.primarytable      tmp_primarytable --÷˜±Ì±Ì√˚
        from acc_st.st_cfg_clear_table t
       where t.db_type = 'rpt'
         and t.is_squadday = 0
         and t.primarytable is null;
  begin
    for i_cur in scc_table loop
      --Ω®0001±Ì
      --‘≠ º±Ì√ª”– ˝æ›£¨∑µªÿ
      begin
        v_flag      := 2;
        v_table_sql := 'select count(*)  from ' || i_cur.tmp_origin_table;
        execute immediate v_table_sql
          into v_count;
        if 0 = v_count then
          continue;
        end if;
      end;

      v_time_type     := i_cur.tmp_date_type; -- ±º‰¿‡–Õ
      v_in_que        := i_cur.tmp_ab_name; --‘¥±ÌÀı–¥
      v_table_sql     := i_cur.tmp_create_sql; --Ω®±Ì”Ôæ‰
      v_limit_count   := i_cur.tmp_divide_recd_count;
      v_new_tablename := v_in_que || '000001';
      v_owner         := substr(i_cur.tmp_origin_table,
                                1,
                                INSTR(i_cur.tmp_origin_table, '.', 1, 1) - 1);
      begin
        begin
          select count(*)
            into v_count
            from acc_st.st_idx_rpt_history
           where table_name like '%' || v_in_que || '_%';
        end;
        begin
          v_temp_sql := 'select count(*) from dba_objects where object_name = upper (''' ||
                        v_new_tablename || ''')  and owner= upper (''' ||
                        v_owner || ''') and object_type =''TABLE''';
          execute immediate v_temp_sql
            into v_count2;
        end;
      end;
      if v_count = 0 then
        --st_idx_rpt_history√ª”–Ωª“◊∑÷±Ìµƒº«¬º
        if v_count2 > 0 then
          if substr(v_in_que, 1, 11) = 'acc_st_his' then
            v_new_tablename := 'acc_st_his.';
          end if;
          --∑÷±ÌµƒŒÔ¿Ì±Ì¥Ê‘⁄
          v_temp_sql := 'drop table ' || v_owner || '.' || v_new_tablename; --20150428 modify by mqf ‘ˆº”v_owner
          execute immediate v_temp_sql; --…æ≥˝001∑÷±Ì±Ì
        end if;
        v_flag := 0;
      else
        ----st_idx_rpt_history”–Ωª“◊∑÷±Ìµƒº«¬º
        if v_count2 = 0 then
          --∑÷±ÌµƒŒÔ¿Ì±Ì≤ª¥Ê‘⁄
          v_flag := 0;
        end if;
      end if;
      begin
        if v_flag = 0 then
          --Ω®0001±Ì
          begin
            --ªÒ»°Ω®±Ì”Ôæ‰
            --ÃÊªª±Ì√˚
            select regexp_replace(v_table_sql, '%s', v_new_tablename)
              into v_temp_sql
              from dual;

            --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
            declare
              cursor sql_cur is
                select * from table(acc_st.up_dm_st_splitstr(v_temp_sql, ';'));
            begin
              for t_cur in sql_cur loop
                v_table_sql := t_cur.column_value;
                if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                  execute immediate v_table_sql; --¥¥Ω®0001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                end if;
              end loop;
            end;

      --20150512 add by mqf ‘ˆº”»’÷æ
      acc_st.up_dm_st_mv_log(v_in_que,
                          v_new_tablename,
                          '0000000000',
                          sysdate,
                          sysdate,
                          0,
                          0,
                          '≥…π¶¥¥Ω®' || v_new_tablename || '±Ì',
                          'create table ' || v_new_tablename || '...');

          end;
          /*
          v_table_sql := 'select min(balance_water_no)  from ' ||
                         i_cur.tmp_origin_table;
          execute immediate v_table_sql
            into v_min_bal_water_no;
      */
        v_min_bal_water_no := '2013050101'; --20150428 modify by mqf -- ˝æ›ø…ƒ‹”–—”≥Ÿ£¨≥ı º◊Ó–°«ÂÀ„¡˜ÀÆ∫≈∏ƒŒ™2013050101

          begin
            insert into acc_st.st_idx_rpt_history
              (table_name,
               origin_table_name,
               begin_balance_no,
               end_balance_no,
               recd_count,
               create_time)
            values
              (v_new_tablename,
               i_cur.tmp_origin_table,
               v_min_bal_water_no,
               '',
               0,
               sysdate);

          end;

        end if;
      end;

      --Ω®000X±Ì
      begin
        --»°◊Ó¥Ûµƒ¿˙ ∑±Ì
        select max(table_name)
          into v_max_table
          from acc_st.st_idx_rpt_history
         where origin_table_name = i_cur.tmp_origin_table;
      end;

      if v_max_table is null then
        continue;
      end if;

      begin
        select regexp_substr(v_max_table, '.{1,6}$'),
               recd_count,
               to_char(to_date(substr(end_balance_no, 1, 8), 'yyyymmdd') + 1,
                       'yyyymmdd')
          into v_temp_num, v_count, v_new_bal_water_no
          from acc_st.st_idx_rpt_history
         where table_name = v_max_table;

        begin
          --œ¬“ª∑÷±Ìµƒ–Ú¡–∫≈
          v_temp_num := acc_st.up_dm_st_tableno(v_temp_num);
        end;
      end;

      begin
        if (v_count >= v_limit_count) then
          v_new_tablename := v_in_que || v_temp_num;
          begin
            select regexp_replace(v_table_sql, '%s', v_new_tablename)
              into v_temp_sql
              from dual;

            --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
            declare
              cursor sql_cur is
                select * from table(up_dm_st_splitstr(v_temp_sql, ';'));
            begin
              for t_cur in sql_cur loop
                v_table_sql := t_cur.column_value;
                if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                  execute immediate v_table_sql; --¥¥Ω®000X∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                end if;
              end loop;
            end;
          end;

          v_min_bal_water_no := v_new_bal_water_no || '01';

          --v_max_bal_water_no := v_new_bal_water_no;
          acc_st.up_dm_st_mv_log(v_in_que,
                          v_new_tablename,
                          '0000000000',
                          sysdate,
                          sysdate,
                          0,
                          0,
                          '≥…π¶¥¥Ω®' || v_new_tablename || '±Ì',
                          'create table ' || v_new_tablename || '...');

          insert into acc_st.st_idx_rpt_history
            (table_name,
             origin_table_name,
             begin_balance_no,
             end_balance_no,
             recd_count,
             create_time)
          values
            (v_new_tablename,
             i_cur.tmp_origin_table,
             v_min_bal_water_no,
             '',
             0,
             sysdate);

        end if;

      end;

    end loop;
  end;
  commit;
  out_msg       := v_new_tablename;
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_rpt_create3;
/
grant execute on ACC_ST.UP_DM_ST_RPT_CREATE3 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_RPT_MV1
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_rpt_mv1(out_retresult OUT INTEGER, --∑µªÿΩ·π˚
                                             out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                             )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_rpt_mv1
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--÷–º‰±Ì ˝æ›∏˘æ›‘À”™»’squad_dayµº»Î¿˙ ∑±Ì£¨∂ØÃ¨≤Â»Î
  -- ‰»Î≤Œ ˝: @origin_table_name  ÷–º‰±Ì√˚
  -- ‰≥ˆ≤Œ ˝  £∫return_num ƒ£øÈ∑µªÿ÷µ
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131029
  --¥¥Ω®√Ë ˆ£∫µ±ƒø«∞À˘ π”√µƒ±Ì÷–º«¬º±£¥Ê ±º‰≥¨π˝‘§œ»…Ë∂®µƒ±£¥ÊÃÏ ˝ ±£¨
  --          ‘ÚΩ´±æ±Ì÷–≥¨≥ˆ±£¥Ê ±º‰∑∂Œßµƒº«¬º÷µ≤Â»Î¿˙ ∑∑÷±Ì÷–Ω¯––±£¥Ê∫Û‘ŸΩ¯––…æ≥˝≤Ÿ◊˜£¨
  --          À˘”–≤Ÿ◊˜æ˘–Ë”–œ‡”¶»’÷æ±£¥Ê”⁄«Â¿Ì»’÷æ±Ìclear_table_log÷–
  --–ﬁ∏ƒ»’∆⁄£∫ 20150424 by mqf
  --–ﬁ∏ƒƒ⁄»›£∫ ∞¥‘À”™»’∆⁄±È¿˙£¨º«¬º ˝¥Û”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝‘ÚÕ£÷π«®“∆ ˝æ›£¨–¬Ω®∑÷±Ì‘Ÿ«®“∆ ˝æ›°£
             --Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±ÌµƒŒ Ã‚
  --–ﬁ∏ƒ»’∆⁄£∫20160912 modify by mqf
  --–ﬁ∏ƒƒ⁄»›£∫1.πÿ±’”Œ±Í

  -------------------------------------------------------------------------------
 AS
  v_sql               varchar2(2048);
  v_max_table         varchar2(50); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_min_table         varchar2(50); --◊Ó–°µƒ¿˙ ∑±Ì
  v_count             int; --
  v_begin_time        date; --«Â¿Ìø™ º ±º‰
  v_mindate           varchar2(8); --◊Ó–°‘À”™»’
  v_maxdate           varchar2(8); --◊Ó¥Û‘À”™»’
  v_origin_table_name varchar2(50); --÷–º‰±Ì±Ì√˚
  v_keep_days         int; --÷–º‰±Ì±£¥ÊÃÏ ˝
  v_table_columns     varchar2(1000); --÷–º‰±Ì∏˜◊÷∂Œ
  v_cost_seconds      int; --Õ≥º∆ ±º‰
  v_msg               varchar2(255); --◊¢ Õ
  v_balance_water_no  varchar2(10); --◊¢ Õ
  --v_max_blane_water_no varchar2(10);

  --20140424 add by mqf
  v_tmp1              varchar2(256);
  v_recd_count        integer; --À˜“˝±Ì“—∏¸–¬º«¬º ˝
  divide_recd_count   integer; --≈‰÷√±Ì◊Ó¥Ûº«¬º ˝
  v_rowcount          integer; --∏¸–¬º«¬º ˝
  v_squad_day_value   varchar2(8); --»’∆⁄
  TYPE MYCURSOR IS REF CURSOR;  --∂®“Â”Œ±Í¿‡–Õ
  cur_date_type MYCURSOR;       --∂®“Â”Œ±Í
BEGIN

  -------------------------«®“∆ ˝æ›ø™ º---------------------------
  select max(balance_water_no)
    into v_balance_water_no
    from acc_st.st_list_balance_waiting;
  begin
    declare
      cursor scc_table is
        select t.origin_table_name tmp_origin_table,
               t.keep_days         tmp_keep_days,
               t.clear_flag        tmp_clear_flag,
               t.is_squadDay       tmp_is_squadDay,
               t.table_columns     tmp_table_columns£¨
         t.divide_recd_count tmp_divide_recd_count
          from acc_st.st_cfg_clear_table t
         where --t.clear_flag = 1 and
         t.is_squadday = 1
         and t.db_type = 'rpt'; --
    begin

      for i_cur in scc_table loop
        begin
          v_origin_table_name := trim(i_cur.tmp_origin_table);  --∞¸∫¨”√ªß«∞◊∫acc_st
          v_table_columns     := trim(i_cur.tmp_table_columns);
          v_begin_time        := sysdate;
          v_keep_days         := i_cur.tmp_keep_days;
      --20150424 add by mqf
        divide_recd_count := trim(i_cur.tmp_divide_recd_count);

          -- select min_squadDate into minDate from t#st_sts_inc_day_min;
          --delete from t#st_sts_inc_day_min;
          v_sql := ' select max(table_name) ,min(table_name)  from acc_st.st_idx_rpt_history where origin_table_name =''' ||
                   v_origin_table_name || '''';
          execute immediate v_sql
            into v_max_table, v_min_table;
          if v_max_table is null or v_min_table is null then
            continue;
          end if;
          --—≠ª∑œÚ∑÷±Ì÷–≤Â»Î ˝æ›
          begin
            declare
              cursor index_table is
                select table_name    temp_table_name,
                       min_squad_day temp_min_squad_day,
                       max_squad_day temp_max_squad_day
                  from acc_st.st_idx_rpt_history t
                 where origin_table_name = v_origin_table_name
                   and table_name >= v_min_table
                   and table_name < v_max_table;

            begin
              for t_cur in index_table loop

                -- ∏˘æ›‘À”™»’≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
                v_sql := ' select count(*) from ' || v_origin_table_name ||
                         ' where squad_day >=''' ||
                         t_cur.temp_min_squad_day ||
                         ''' and squad_day <=''' ||
                         t_cur.temp_max_squad_day || '''';
                execute immediate v_sql
                  into v_count;
                if v_count = 0 then
                  out_msg := '√ª”– ˝æ›–Ë“™«®“∆';
                  continue;
                end if;
        v_begin_time := sysdate; --20150512 add by mqf
                begin
                  v_sql := ' insert into acc_st.' || t_cur.temp_table_name ||
                           ' select ' || v_table_columns || ' from ' ||
                           v_origin_table_name || ' where squad_day >=''' ||
                           t_cur.temp_min_squad_day ||
                           ''' and squad_day <=''' ||
                           t_cur.temp_max_squad_day || '''';
                  execute immediate v_sql;
                EXCEPTION
                  when others then
                    begin
                      rollback;
                      out_retresult  := SQLCODE;
                      out_msg        := v_origin_table_name ||
                                        '≤Â»Î¿˙ ∑±Ì¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' || SQLERRM ||
                                        ',∑¢…˙‘⁄µ⁄[' ||
                                        dbms_utility.format_error_backtrace() || ']––';
                      v_cost_seconds := round(to_number(sysdate -
                                                        v_begin_time) * 24 * 60 * 60);
                      acc_st.up_dm_st_mv_log(v_origin_table_name,
                                      '0',
                                      v_balance_water_no,
                                      v_begin_time,
                                      sysdate,
                                      v_cost_seconds,
                                      0,
                                      out_msg,
                                      v_sql);
                      continue;
                    end;

                end;
        --20150512 add by mqf ‘ˆº”≤Â»Î ˝æ›»’÷æ
        v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_time) * 24 * 60 * 60);
          out_msg        := '¥”' || v_origin_table_name || '±Ì≤Â»Î ˝æ›µΩ' ||
                  t_cur.temp_table_name || '£¨π≤' || v_count || 'Ãı';
          acc_st.up_dm_st_mv_log(v_origin_table_name,
                  t_cur.temp_table_name,
                  v_balance_water_no,
                  v_begin_time,
                  sysdate,
                  v_cost_seconds,
                  v_count,
                  out_msg,
                  v_sql);

                update acc_st.st_idx_rpt_history
                   set recd_count = recd_count + v_count
                 where table_name = t_cur.temp_table_name;
                v_sql := 'delete from ' || v_origin_table_name ||
                         ' where squad_day >=''' ||
                         t_cur.temp_min_squad_day ||
                         ''' and squad_day <=''' ||
                         t_cur.temp_max_squad_day || '''';
                execute immediate v_sql;

        v_begin_time := sysdate; --20150520 add by mqf
        out_msg := '¥”' || v_origin_table_name || '…æ≥˝' || v_count || 'Ãı ˝æ›'; --20150520 modify by mqf
        v_cost_seconds := round(to_number(sysdate - v_begin_time) * 24 * 60 * 60);
        acc_st.up_dm_st_mv_log(v_origin_table_name,
                '0',
                v_balance_water_no,
                v_begin_time,
                sysdate,
                v_cost_seconds,
                v_count,
                out_msg,
                v_sql);

              end loop;
              commit;
            end;
          end;

          begin
            --◊Ó¥ÛΩª“◊»’∆⁄
            v_maxdate := to_char(sysdate - v_keep_days, 'yyyymmdd');
            begin

              --◊Ó–°Ωª“◊»’∆⁄
        --20150424 modify by mqf ‘ˆº”≤È—Ørecd_count
              v_sql := ' select min_squad_day,recd_count   from acc_st.st_idx_rpt_history where table_name =''' ||
                       v_max_table || '''';

              execute immediate v_sql
                into v_mindate, v_recd_count;

            exception
              when OTHERS THEN
                begin
                  v_msg := '≤È—Ø◊Ó–°Ωª“◊»’∆⁄±®¥Ì£∫' || v_sql;
                  acc_st.up_dm_st_mv_log(v_origin_table_name,
                                  v_max_table,
                                  v_balance_water_no,
                                  sysdate,
                                  sysdate,
                                  0,
                                  v_count,
                                  v_msg,
                                  v_sql);
                  continue;
                end;
            end;
      --À˜“˝±Ì“—«®“∆º«¬º¥Û”⁄ªÚµ»”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ã¯µΩ“ª¥Œ—≠ª∑ 20150520 modify by mqf
      if v_recd_count>=divide_recd_count then
          continue;
      end if;

            v_sql := ' select count(*) from ' || v_origin_table_name ||
                     ' where squad_day >=''' || v_mindate ||
                     ''' and squad_day <=''' || v_maxdate || '''';
            execute immediate v_sql
              into v_count;

          end;

          if v_count <= 0 then
            continue;
          end if;
          /**
          --ªÒ»°◊Ó¥ÛΩª“◊»’∆⁄µƒ«ÂÀ„¡˜ÀÆ∫≈
          v_sql := 'select max(balance_water_no) from ' ||
                   v_origin_table_name || ' where squad_day <=''' ||
                   v_maxdate || '''';
          execute immediate v_sql
            into v_max_blane_water_no;**/

          --20150426 add by mqf
      v_tmp1 := 'lock table acc_st.' || v_max_table || ' in exclusive mode';
          execute immediate v_tmp1;

      v_begin_time := sysdate; --20150512 add by mqf
      --20150426 add by mqf ∞¥‘À”™»’∆⁄±È¿˙£¨Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±Ì÷–°£
      v_sql := ' select distinct squad_day from ' || v_origin_table_name || ' where squad_day >=''' ||
                   v_mindate || ''' and squad_day <=''' || v_maxdate || ''' order by squad_day ';
        --∏¸–¬º«¬º ˝≥ı ºŒ™0
        v_rowcount := 0;

      open cur_date_type for v_sql;
        loop
        fetch cur_date_type into v_squad_day_value;
          exit when cur_date_type%notfound;

        --≥¨π˝∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ω· ¯—≠ª∑
        if (v_recd_count+v_rowcount>=divide_recd_count) then
          exit;
        end if;

        v_maxdate := v_squad_day_value;
        v_sql := ' insert into acc_st.' || v_max_table || '(' || v_table_columns ||
             ') select ' || v_table_columns || ' from ' ||
             --v_origin_table_name || ' where squad_day >=''' ||
             --v_mindate || ''' and squad_day <=''' || v_maxdate || '''';
             v_origin_table_name || ' where squad_day =''' ||
             v_maxdate || '''';
        execute immediate v_sql;
        --¿€º”∏¸–¬º«¬º ˝
        v_rowcount := v_rowcount + sql%rowcount;
      end loop;
    close cur_date_type; --20160912 add by mqf πÿ±’”Œ±Í

      --20150424 add by mqf ∏¸–¬v_count
        v_count := v_rowcount;

      --20150512 add by mqf ‘ˆº”≤Â»Î ˝æ›»’÷æ
      v_cost_seconds := round(to_number(sysdate - v_begin_time) * 24 * 60 * 60);
      out_msg        := '¥”' || v_origin_table_name || '±Ì≤Â»Î ˝æ›µΩ' || v_max_table || '£¨π≤' ||
              v_count || 'Ãı';

      acc_st.up_dm_st_mv_log(v_origin_table_name,
              v_max_table,
              v_balance_water_no,
              v_begin_time,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql);
      --‘ˆº”≤Â»Î ˝æ›»’÷æ

          --‘Ÿ∏¸–¬◊Ó¥Û¿˙ ∑±Ìµƒ◊Ó¥Û‘À”™»’∆⁄Œ™◊ÚÃÏ
      if v_count >0 then --20150512 add by mqf º«¬º¥Û”⁄0≤≈∏¸–¬À˜“˝±Ì°¢…æ≥˝‘¥±Ì ˝æ›
        update acc_st.st_idx_rpt_history t
         set max_squad_day = v_maxdate,
           -- t.end_balance_no = v_max_blane_water_no,
           t.recd_count = t.recd_count + v_count
         where table_name = v_max_table;


        -------------------------…æ≥˝ ˝æ›ø™ º---------------------------
        begin
        v_begin_time := sysdate; --20150512 add by mqf
        --…æ≥˝≈‰÷√±Ì÷–¥À÷–º‰±Ì±£¥ÊÃÏ ˝«∞µƒ ˝æ›
        begin
          v_sql := 'delete from ' || v_origin_table_name ||
               ' where squad_day >=''' || v_mindate ||
               ''' and squad_day <=''' || v_maxdate || '''';
          execute immediate v_sql;
        end;
        --º«¬º»’÷æ
        --out_msg        := '…æ≥˝' || v_origin_table_name || '±Ì÷–«Â¿ÌÃÏ ˝«∞µƒ ˝æ›≥…π¶';
        out_msg := '¥”' || v_origin_table_name || '…æ≥˝' || v_count || 'Ãı ˝æ›'; --20150512 modify by mqf
        v_cost_seconds := round(to_number(sysdate - v_begin_time) * 24 * 60 * 60);
        acc_st.up_dm_st_mv_log(v_origin_table_name,
                '0', --20150520 modify by mqf v_max_table∏ƒŒ™'0'
                v_balance_water_no,
                v_begin_time,
                sysdate,
                v_cost_seconds,
                v_count,
                out_msg,
                v_sql);

        end;
        -------------------------…æ≥˝ ˝æ›Ω· ¯---------------------------
      end if;

        end;

      end loop;
    end;
    -------------------------«®“∆ ˝æ›Ω· ¯---------------------------

  end;
  out_retresult := SQLCODE;
  out_msg       := ' ˝æ›«®“∆≥…π¶';
  commit;
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retResult := sqlcode;
      return;
    end;

END up_dm_st_rpt_mv1;
/
grant execute on ACC_ST.UP_DM_ST_RPT_MV1 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_RPT_MV2
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_rpt_mv2(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                             out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                             )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_rpt_mv2
  --π¶ƒ‹√Ë ˆ£∫÷–º‰±Ì«®“∆£¨»’∆⁄‘⁄÷˜±Ì£¨∞¥÷˜±Ìµƒ»’∆⁄∑÷±Ì£¨ ˝æ›‘⁄¥”±Ì«®“∆
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131020
  --–ﬁ∏ƒ»’∆⁄£∫ 20150424 by mqf
  --–ﬁ∏ƒƒ⁄»›£∫ ∞¥»’∆⁄±È¿˙£¨º«¬º ˝¥Û”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝‘ÚÕ£÷π«®“∆ ˝æ›£¨–¬Ω®∑÷±Ì‘Ÿ«®“∆ ˝æ›°£
             --Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±ÌµƒŒ Ã‚
  --–ﬁ∏ƒ»’∆⁄£∫20160912 modify by mqf
  --–ﬁ∏ƒƒ⁄»›£∫1.πÿ±’”Œ±Í
  -------------------------------------------------------------------------------
 AS

  v_msg VARCHAR2(50);
  v_sql varchar2(5000);
  --v_sql2           varchar2(5000);
  v_start_time     VARCHAR2(19); --◊Ó–°Ωª“◊ ±º‰
  v_end_time       VARCHAR2(19); --◊Ó¥ÛΩª“◊ ±º‰
  v_min_table      VARCHAR2(50); --◊Ó–°Ωª“◊ ±º‰∂‘”¶µƒ◊Ó–°µƒ¿˙ ∑±Ì√˚
  v_max_table      VARCHAR2(50); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count          number(18);
  v_time_type      VARCHAR2(20);
  v_column         VARCHAR2(2000);
  v_tmp1           VARCHAR2(256);
  v_cost_seconds   number;
  v_begin_time     VARCHAR2(20); --«®“∆ø™ º ±º‰
  v_begin_date     date; --«®“∆ø™ º ±º‰
  v_keep_days      int; --¿˙ ∑±Ì ˝æ›±£¥ÊÃÏ ˝
  v_end_clear_time VARCHAR2(20);
  v_in_que         VARCHAR2(50); --‘¥±Ì√˚
  v_primarytable   VARCHAR2(50); --‘¥±Ì√˚∂‘”¶µƒ÷˜±Ì√˚
  v_in_sql         VARCHAR2(300);

  --20140424 add by mqf
  v_recd_count integer; --À˜“˝±Ì“—∏¸–¬º«¬º ˝
  divide_recd_count integer; --≈‰÷√±Ì◊Ó¥Ûº«¬º ˝
  v_rowcount  integer; --∏¸–¬º«¬º ˝
  v_time_type_value varchar2(20); --»’∆⁄
  TYPE MYCURSOR IS REF CURSOR;  --∂®“Â”Œ±Í¿‡–Õ
  cur_date_type MYCURSOR;       --∂®“Â”Œ±Í
  v_datetime_begin     varchar2(20); --±È¿˙µƒø™ º ±º‰
  v_datetime_end     varchar2(20); --±È¿˙µƒΩ· ¯ ±º‰
  v_datetime_where_sql  varchar2(300);
BEGIN
  declare
    cursor scc_table is
      select --t.origin_table_name tmp_origin_table,  --20150519 modify by mqf Œ¥ π”√
             --t.create_sql        tmp_create_sql,
             t.is_squadday       tmp_is_squadday,
             t.origin_table_name tmp_origin_table_name, --∞¸∫¨”√ªß«∞◊∫acc_st_his
             t.table_columns     tmp_table_columns,
             t.date_type         tmp_date_type,
             t.keep_days         tmp_keep_days,
             t.primarytable      tmp_primarytable, --÷˜±Ì±Ì√˚
       t.divide_recd_count tmp_divide_recd_count

        from acc_st.st_cfg_clear_table t
       where t.db_type = 'rpt'
         and t.is_squadday = 0
         and t.primarytable is not null; --”–÷˜±Ì
  begin
    for i_cur in scc_table loop

      v_time_type    := i_cur.tmp_date_type; -- ±º‰¿‡–Õ
      v_in_que       := i_cur.tmp_origin_table_name;
      v_primarytable := i_cur.tmp_primarytable;
      v_column       := i_cur.tmp_table_columns;
      v_keep_days    := i_cur.tmp_keep_days;
    --20150426 add by mqf
    divide_recd_count := trim(i_cur.tmp_divide_recd_count);
      /**
      --»°Ωª“◊ ˝æ›÷–◊Ó–°µƒΩª“◊ ±º‰
      v_tmp1 := ' select min(' || v_time_type || ') from ' || v_in_que;
      execute immediate v_tmp1
        into v_min_time;

      --»°Ωª“◊ ˝æ›÷–◊Ó¥ÛµƒΩª“◊ ±º‰
      v_tmp1 := 'select max(' || v_time_type || ') from ' || v_in_que;
      execute immediate v_tmp1
        into v_max_time;**/

      begin
        select min(table_name)
          into v_min_table
          from acc_st.st_idx_rpt_history t
         where t.origin_table_name = v_in_que;
      exception
        when OTHERS THEN
          begin
            out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                             dbms_utility.format_error_backtrace() || ']––';
            out_retresult := sqlcode;
            continue;
          end;
      end;
      if v_min_table is null then
        continue;
      end if;

      select max(table_name)
        into v_max_table
        from acc_st.st_idx_rpt_history t
       where t.origin_table_name = v_in_que;
      --∂®“Â»°≥ˆÀ˘”––Ë“™µº»Î ˝æ›µƒHis±Ìµƒ”Œ±Í
      --(◊Ó¥Ûµƒ¿˙ ∑±Ì–Ë“™Ãÿ ‚¥¶¿Ì,∏¸∏ƒst_idx_rpt_history±Ì÷–∂‘”¶µƒΩ· ¯ ±º‰)
      declare
        cursor cu_table is
          select table_name,
                 to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss') begin_date,
                 to_char(end_date, 'yyyy-mm-dd hh24:mi:ss') end_date
            from acc_st.st_idx_rpt_history t
           where t.table_name >= v_min_table
             and t.table_name < v_max_table;
      begin
        for my_cur in cu_table loop

          v_tmp1 := 'lock table ' || my_cur.table_name ||
                    ' in  exclusive mode nowait';
          execute immediate v_tmp1;
          v_start_time := my_cur.begin_date;
          v_end_time   := my_cur.end_date;

          --¥”±Ìµƒwater_no∫Õbalance_water_no“ª÷¬
          v_in_sql := ' a where (a.water_no,a.balance_water_no) in (select b.water_no, b.balance_water_no from ' ||
                      v_primarytable || ' b  where b.' || v_time_type ||
                      ' <= to_date(''' || v_end_time ||
                      ''', ''yyyy-mm-dd hh24 :mi :ss'') and b.' ||
                      v_time_type || ' >= to_date(''' || v_start_time ||
                      ''',''yyyy-mm-dd hh24:mi:ss''))';

          v_sql := 'select count(*) from ' || v_in_que || v_in_sql;
          execute immediate v_sql
            into v_count;

          --–Ë«®“∆µƒ ˝æ›µ»”⁄0ÕÀ≥ˆ±æ¥Œ—≠ª∑
          if 0 = v_count then
            continue;
          end if;
          v_begin_date := sysdate;
          --∞— ˝æ›∞¥Ωª“◊ ±º‰≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
          v_sql := 'insert into ' || my_cur.table_name || ' select ' ||
                   v_column || ' from ' || v_in_que || v_in_sql;
          execute immediate v_sql;

          v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_date) * 24 * 60 * 60);
          out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩ' ||
                            my_cur.table_name || '£¨π≤' || v_count || 'Ãı';
          acc_st.up_dm_st_mv_log(v_in_que,
                          my_cur.table_name,
                          '0000000000',
                          v_begin_date,
                          sysdate,
                          v_cost_seconds,
                          v_count,
                          out_msg,
                          v_sql); --20150427 modify by mqf out_msg ∏ƒŒ™ v_sql

      v_begin_date := sysdate; --20150520 add by mqf
          --…æ≥˝‘¥±Ì ˝æ›
          v_sql := 'delete from ' || v_in_que || v_in_sql;
          execute immediate v_sql;

      --20150520 add by mqf
      out_msg := '¥”' || v_in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';
      v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_date) * 24 * 60 * 60);

      acc_st.up_dm_st_mv_log(v_in_que,
              '0',
              '0000000000',
              v_begin_date,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql);

          --∏¸∏ƒÀ˜“˝±Ì–≈œ¢
          update acc_st.st_idx_rpt_history
             set recd_count = recd_count + v_count
           where table_name = my_cur.table_name;
        end loop;
        commit;
      end;

      --∂‘◊Ó¥Ûµƒ¿˙ ∑±Ìµº»Î ˝æ›
      v_tmp1 := 'lock table ' || v_max_table || ' in exclusive mode';
      execute immediate v_tmp1;

      v_end_clear_time := to_char(sysdate - v_keep_days,
                                  'yyyy-mm-dd hh24:mi:ss');

      v_end_time := substr(v_end_clear_time, 1, 10) || ' 23:59:59';

    --20150426 modify by mqf ‘ˆº”≤È—Ørecd_count
      select to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss'),recd_count
        into v_begin_time,v_recd_count
        from acc_st.st_idx_rpt_history
       where table_name = v_max_table; --«®“∆µƒ◊‹º«¬º ˝

    --À˜“˝±Ì“—«®“∆º«¬º¥Û”⁄ªÚµ»”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ã¯µΩ“ª¥Œ—≠ª∑ 20150520 modify by mqf
      if v_recd_count>=divide_recd_count then
      continue;
    end if;

      v_in_sql := ' a where (a.water_no,a.balance_water_no) in (select b.water_no, b.balance_water_no from ' ||
                  v_primarytable || ' b  where b.' || v_time_type ||
                  ' <= to_date(''' || v_end_time ||
                  ''', ''yyyy-mm-dd hh24:mi:ss'') and b.' ||
                  v_time_type || ' >= to_date(''' || v_begin_time ||
                  ''',''yyyy-mm-dd hh24:mi:ss''))';

      v_sql := 'select count(*) from ' || v_in_que || v_in_sql;
      execute immediate v_sql
        into v_count;
      --«®“∆µƒ◊‹º«¬º ˝µ»”⁄0ÕÀ≥ˆ±æ¥Œ—≠ª∑
      if 0 = v_count then
        continue;
      end if;

    --20150426 add by mqf ∞¥»’∆⁄±È¿˙£¨Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±Ì÷–°£
      v_begin_date := sysdate;
    v_sql := ' select distinct to_char(b.' || v_time_type || ', ''yyyy-mm-dd'') from ' || v_primarytable ||
         ' b where b.' || v_time_type ||
               ' <= to_date(''' || v_end_time ||
               ''', ''yyyy-mm-dd hh24:mi:ss'') and b.' ||
               v_time_type || ' >= to_date(''' || v_begin_time ||
               ''',''yyyy-mm-dd hh24:mi:ss'')' ||
         ' and exists (select 1 from ' || v_in_que ||
         ' a where a.water_no = b.water_no and a.balance_water_no = b.balance_water_no) order by to_char(b.' ||
         v_time_type || ', ''yyyy-mm-dd'')';
    --∏¸–¬º«¬º ˝≥ı ºŒ™0
    v_rowcount := 0;
    open cur_date_type for v_sql;
    loop
      fetch cur_date_type into v_time_type_value;
      exit when cur_date_type%notfound;

      --≥¨π˝∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ω· ¯—≠ª∑
      if (v_recd_count+v_rowcount>=divide_recd_count) then
        exit;
      end if;
      v_datetime_begin := v_time_type_value || ' 00:00:00';
      v_datetime_end := v_time_type_value || ' 23:59:59';
      v_datetime_where_sql := ' a where (a.water_no,a.balance_water_no) in (select b.water_no, b.balance_water_no from ' ||
                  v_primarytable || ' b  where b.' || v_time_type ||
                  ' <= to_date(''' || v_datetime_end ||
                  ''', ''yyyy-mm-dd hh24:mi:ss'') and b.' ||
                  v_time_type || ' >= to_date(''' || v_datetime_begin ||
                  ''',''yyyy-mm-dd hh24:mi:ss''))';
      v_sql        := ' insert into ' || v_max_table || '(' || v_column || ')' ||
              ' select ' || v_column || ' from ' || v_in_que ||
              v_datetime_where_sql;
      execute immediate v_sql;
      --¿€º”∏¸–¬º«¬º ˝
      v_rowcount := v_rowcount + sql%rowcount;
    end loop;
  close cur_date_type; --20160912 add by mqf πÿ±’”Œ±Í

    --20150426 add by mqf v_in_sql”√”⁄…æ≥˝º«¬º
    v_in_sql := ' a where (a.water_no,a.balance_water_no) in (select b.water_no, b.balance_water_no from ' ||
                  v_primarytable || ' b  where b.' || v_time_type ||
                  ' <= to_date(''' || v_datetime_end ||
                  ''', ''yyyy-mm-dd hh24:mi:ss'') and b.' ||
                  v_time_type || ' >= to_date(''' || v_begin_time ||
                  ''',''yyyy-mm-dd hh24:mi:ss''))';
    v_end_time := v_datetime_end;
    v_count := v_rowcount;

      v_cost_seconds := round(to_number(sysdate - v_begin_date) * 24 * 60 * 60);
      out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩ' || v_max_table || '£¨π≤' ||
                        v_count || 'Ãı';

      acc_st.up_dm_st_mv_log(v_in_que,
                      v_max_table,
                      '0000000000',
                      v_begin_date,
                      sysdate,
                      v_cost_seconds,
                      v_count,
                      out_msg,
                      v_sql); --20150426  modify by mqf  out_msg ∏ƒŒ™ v_sql

      --∏¸–¬st_idx_rpt_history±Ì–≈œ¢
    if v_count >0 then --20150512 add by mqf º«¬º¥Û”⁄0≤≈∏¸–¬À˜“˝±Ì°¢…æ≥˝‘¥±Ì ˝æ›
      update acc_st.st_idx_rpt_history
       set recd_count = recd_count + v_count,
         end_date   = to_date(v_end_time, 'yyyy-mm-dd hh24:mi:ss')
       where table_name = v_max_table;


      ---------…æ≥˝¿˙ ∑ ˝æ›ø™ º--------------------------------------------
      v_begin_date := sysdate;

      --…æ≥˝≤Ÿ◊˜
      v_sql := 'delete from  ' || v_in_que || v_in_sql;
      execute immediate v_sql;

      --º«¬º»’÷æ
      out_msg := '¥”' || v_in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';

      v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_date) * 24 * 60 * 60);

      acc_st.up_dm_st_mv_log(v_in_que,
              '0',
              '0000000000',
              v_begin_date,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql); --20150426  modify by mqf out_msg ∏ƒŒ™ v_sql
      ---------…æ≥˝¿˙ ∑ ˝æ›Ω· ¯--------------------------------------------
    end if;

    end loop;
  end;
  commit;
  out_msg       := ' ˝æ›«®“∆≥…π¶';
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_rpt_mv2;
/
grant execute on ACC_ST.UP_DM_ST_RPT_MV2 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_RPT_MV3
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_rpt_mv3(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                    out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                    )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_rpt_mv3
  --π¶ƒ‹√Ë ˆ£∫÷–º‰±Ì«®“∆£¨∞¥’’«ÂÀ„¡˜ÀÆ∫≈«®“∆
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131020
  --–ﬁ∏ƒ»’∆⁄£∫ 20150427 by mqf
  --–ﬁ∏ƒƒ⁄»›£∫ ∞¥«ÂÀ„¡˜ÀÆ∫≈±È¿˙£¨º«¬º ˝¥Û”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝‘ÚÕ£÷π«®“∆ ˝æ›£¨–¬Ω®∑÷±Ì‘Ÿ«®“∆ ˝æ›°£
             --Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±ÌµƒŒ Ã‚
  --–ﬁ∏ƒ»’∆⁄£∫20160912 modify by mqf
  --–ﬁ∏ƒƒ⁄»›£∫1.πÿ±’”Œ±Í
  -------------------------------------------------------------------------------
 AS
  v_msg varchar2(50);
  v_sql varchar2(5000);
  --v_sql2             varchar2(5000);
  v_min_bal_water_no varchar2(10); --◊Ó–°«ÂÀ„¡˜ÀÆ∫≈
  v_max_bal_water_no varchar2(10); --◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
  v_max_table        varchar2(30); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_min_table        varchar2(30); --◊Ó–°µƒ¿˙ ∑±Ì
  v_count            number(18);
  v_time_type        varchar2(20);
  v_column           varchar2(2000);
  v_tmp1             varchar2(256);
  v_cost_seconds     number;
  v_begin_time       date; --«®“∆ø™ º ±º‰
  v_keep_days        int; --¿˙ ∑±Ì ˝æ›±£¥ÊÃÏ ˝
  v_in_que           varchar2(50); --‘¥±Ì√˚
  v_in_sql           varchar2(300);
  v_table            varchar2(40);
  v_owner            varchar2(11);

  --20140427 add by mqf
  v_recd_count integer; --À˜“˝±Ì“—∏¸–¬º«¬º ˝
  divide_recd_count integer; --≈‰÷√±Ì◊Ó¥Ûº«¬º ˝
  v_rowcount  integer; --∏¸–¬º«¬º ˝
  v_bal_water_no_value varchar2(10); --«ÂÀ„¡˜ÀÆ∫≈
  TYPE MYCURSOR IS REF CURSOR;  --∂®“Â”Œ±Í¿‡–Õ
  cur_date_type MYCURSOR;       --∂®“Â”Œ±Í
  v_in_where_sql  varchar2(300);
BEGIN
  declare
    cursor scc_table is
      select
      --t.create_sql        tmp_create_sql,
       t.is_squadday       tmp_is_squadday,
       t.origin_table_name tmp_origin_table,
       t.table_columns     tmp_table_columns,
       t.date_type         tmp_date_type,
       t.keep_days         tmp_keep_days,
     t.divide_recd_count tmp_divide_recd_count

        from acc_st.st_cfg_clear_table t
       where t.db_type = 'rpt'
         and t.is_squadday = 0
         and t.primarytable is null; --”–÷˜±Ì
  begin
    for i_cur in scc_table loop

      v_time_type := i_cur.tmp_date_type; -- ±º‰¿‡–Õ
      v_in_que    := i_cur.tmp_origin_table;

      v_column    := i_cur.tmp_table_columns;
      v_keep_days := i_cur.tmp_keep_days;
      v_owner     := substr(v_in_que, 1, INSTR(v_in_que, '.', 1, 1));
    --20150427 add by mqf
    divide_recd_count := trim(i_cur.tmp_divide_recd_count);
      begin
        select min(table_name)
          into v_min_table
          from acc_st.st_idx_rpt_history t
         where t.origin_table_name = v_in_que;
      exception
        when OTHERS THEN
          begin
            out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                             dbms_utility.format_error_backtrace() || ']––';
            out_retresult := sqlcode;
            continue;
          end;
      end;
      if v_min_table is null then
        continue;
      end if;

      select max(table_name)
        into v_max_table
        from acc_st.st_idx_rpt_history t
       where t.origin_table_name = v_in_que;
      --∂®“Â»°≥ˆÀ˘”––Ë“™µº»Î ˝æ›µƒHis±Ìµƒ”Œ±Í
      --(◊Ó¥Ûµƒ¿˙ ∑±Ì–Ë“™Ãÿ ‚¥¶¿Ì,∏¸∏ƒst_idx_rpt_history±Ì÷–∂‘”¶µƒΩ· ¯ ±º‰)
      declare
        cursor cu_table is
          select table_name,
                 begin_balance_no begin_no,
                 end_balance_no   end_no
            from acc_st.st_idx_rpt_history t
           where t.table_name >= v_min_table
             and t.table_name < v_max_table;
      begin
        for my_cur in cu_table loop

          v_tmp1 := 'lock table ' || v_owner || my_cur.table_name ||
                    ' in  exclusive mode nowait';
          execute immediate v_tmp1;
          v_min_bal_water_no := my_cur.begin_no;
          v_max_bal_water_no := my_cur.end_no;

          --≤È—ØÃıº˛
          v_in_sql := ' a where a.balance_water_no <= ''' ||
                      v_max_bal_water_no || ''' and a.balance_water_no>=''' ||
                      v_min_bal_water_no || '''';

          v_sql := 'select count(*) from ' || v_in_que || v_in_sql;
          execute immediate v_sql
            into v_count;

          --–Ë«®“∆µƒ ˝æ›µ»”⁄0ÕÀ≥ˆ±æ¥Œ—≠ª∑
          if 0 = v_count then
            continue;
          end if;
          v_begin_time := sysdate;
          --∞— ˝æ›∞¥Ωª“◊ ±º‰≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
          v_sql := 'insert into ' || v_owner || my_cur.table_name || '(' ||
                   v_column || ') select ' || v_column || ' from ' ||
                   v_in_que || v_in_sql;
          execute immediate v_sql;

          v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_time) * 24 * 60 * 60);
          out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩ' ||
                            my_cur.table_name || '£¨π≤' || v_count || 'Ãı';
          acc_st.up_dm_st_mv_log(v_in_que,
                          my_cur.table_name,
                          '0000000000',
                          v_begin_time,
                          sysdate,
                          v_cost_seconds,
                          v_count,
                          out_msg,
                          v_sql); --20150427 modify by mqf out_msg ∏ƒŒ™ v_sql

      v_begin_time := sysdate;  --20150520 add by mqf
          --…æ≥˝‘¥±Ì ˝æ›
          v_sql := 'delete from ' || v_in_que || v_in_sql;
          execute immediate v_sql;

      --20150520 add by mqf
      out_msg := '¥”' || v_in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';
      v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_time) * 24 * 60 * 60);

      acc_st.up_dm_st_mv_log(v_in_que,
              '0',
              '0000000000',
              v_begin_time,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql);

          --∏¸∏ƒÀ˜“˝±Ì–≈œ¢
          update acc_st.st_idx_rpt_history
             set recd_count = recd_count + v_count
           where table_name = my_cur.table_name;
        end loop;
        --commit;
      end;

      --∂‘◊Ó¥Ûµƒ¿˙ ∑±Ìµº»Î ˝æ›
      v_tmp1 := 'lock table ' || v_owner || v_max_table ||
                ' in exclusive mode';
      execute immediate v_tmp1;

      v_max_bal_water_no := to_char(sysdate - v_keep_days, 'yyyymmdd') || '01';

    --20150426 modify by mqf ‘ˆº”≤È—Ørecd_count
      select begin_balance_no,recd_count
        into v_min_bal_water_no,v_recd_count
        from acc_st.st_idx_rpt_history
       where table_name = v_max_table; --«®“∆µƒ◊‹º«¬º ˝

    --À˜“˝±Ì“—«®“∆º«¬º¥Û”⁄ªÚµ»”⁄∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ã¯µΩ“ª¥Œ—≠ª∑ 20150520 modify by mqf
      if v_recd_count>=divide_recd_count then
      continue;
    end if;

      --≤È—ØÃıº˛
      v_in_sql := ' a where a.balance_water_no <= ''' || v_max_bal_water_no ||
                  ''' and a.balance_water_no>=''' || v_min_bal_water_no || '''';

      v_sql := 'select count(*) from ' || v_in_que || v_in_sql;
      execute immediate v_sql
        into v_count;
      --«®“∆µƒ◊‹º«¬º ˝µ»”⁄0ÕÀ≥ˆ±æ¥Œ—≠ª∑
      if 0 = v_count then
        continue;
      end if;

    --20150427 add by mqf ∞¥balance_water_no±È¿˙£¨Ω‚æˆ…œœﬂ‘À–– ±£¨∂—ª˝¥Û¡øµƒº«¬º≤Â»ÎµΩµ⁄“ª∏ˆ∑÷±Ì÷–°£
    v_begin_time := sysdate; --20150427 add by mqf ∏ƒ∑≈‘⁄≤Â»Î ˝æ›«∞
    v_sql := ' select distinct balance_water_no from ' || v_in_que || v_in_sql ||
         ' order by balance_water_no';
    --∏¸–¬º«¬º ˝≥ı ºŒ™0
    v_rowcount := 0;
    open cur_date_type for v_sql;
    loop
      fetch cur_date_type into v_bal_water_no_value;
      exit when cur_date_type%notfound;

      --≥¨π˝∑÷±Ì◊Ó¥Ûº«¬º ˝£¨Ω´Ω· ¯—≠ª∑
      if (v_recd_count+v_rowcount>=divide_recd_count) then
        exit;
      end if;

      v_max_bal_water_no := v_bal_water_no_value;
      v_in_where_sql := ' a where a.balance_water_no = ''' || v_bal_water_no_value || '''';
      v_sql := ' insert into ' || v_owner || v_max_table || '(' || v_column || ')' ||
           ' select ' || v_column || ' from ' || v_in_que || v_in_where_sql;
      execute immediate v_sql;

      --¿€º”∏¸–¬º«¬º ˝
      v_rowcount := v_rowcount + sql%rowcount;
    end loop;
  close cur_date_type; --20160912 add by mqf πÿ±’”Œ±Í

    --20150427 add by mqf v_in_sql”√”⁄…æ≥˝º«¬º
    v_in_sql := ' a where a.balance_water_no <= ''' || v_max_bal_water_no ||
                  ''' and a.balance_water_no>=''' || v_min_bal_water_no || '''';
    v_count := v_rowcount;

      --v_begin_time := sysdate;

      v_cost_seconds := round(to_number(sysdate - v_begin_time) * 24 * 60 * 60);
      out_msg        := '¥”' || v_in_que || '±Ì≤Â»Î ˝æ›µΩ' || v_max_table || '£¨π≤' ||
                        v_count || 'Ãı';

      acc_st.up_dm_st_mv_log(v_in_que,
                      v_max_table,
                      '0000000000',
                      v_begin_time,
                      sysdate,
                      v_cost_seconds,
                      v_count,
                      out_msg,
                      v_sql); --20150427 modify by mqf out_msg ∏ƒŒ™ v_sql

      --∏¸–¬st_idx_rpt_history±Ì–≈œ¢
    if v_count >0 then --20150512 add by mqf º«¬º¥Û”⁄0≤≈∏¸–¬À˜“˝±Ì°¢…æ≥˝‘¥±Ì ˝æ›
      update acc_st.st_idx_rpt_history
       set recd_count     = recd_count + v_count,
         end_balance_no = v_max_bal_water_no
       where table_name = v_max_table;


      ---------…æ≥˝¿˙ ∑ ˝æ›ø™ º--------------------------------------------
      v_begin_time := sysdate;

      --…æ≥˝≤Ÿ◊˜
      v_sql := 'delete from  ' || v_in_que || v_in_sql;
      execute immediate v_sql;

      --º«¬º»’÷æ
      out_msg := '¥”' || v_in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';

      v_cost_seconds := ROUND(TO_NUMBER(sysdate - v_begin_time) * 24 * 60 * 60);

      acc_st.up_dm_st_mv_log(v_in_que,
              '0',
              '0000000000',
              v_begin_time,
              sysdate,
              v_cost_seconds,
              v_count,
              out_msg,
              v_sql); --20150427 modify by mqf out_msg ∏ƒŒ™ v_sql
      ---------…æ≥˝¿˙ ∑ ˝æ›Ω· ¯--------------------------------------------
    end if;

    end loop;
  end;

  out_msg       := ' ˝æ›«®“∆≥…π¶';
  out_retresult := 0;
  commit;
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_rpt_mv3;
/
grant execute on ACC_ST.UP_DM_ST_RPT_MV3 to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_TK_SYN_LOG
prompt ======================================
prompt
create or replace procedure acc_st.up_dm_st_tk_syn_log(src_db     in varchar2,
                                                src_table  in varchar2,
                                                dest_db    in varchar2,
                                                dest_table in varchar2,
                                                status     in number,
                                                nums       in number,
                                                remark     in varchar2) as

  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_tk_syn_log
  --π¶ƒ‹√Ë ˆ£∫º«¬º ˝æ›Õ¨≤Ω ±µƒ»’÷æ
  -- ‰»Î≤Œ ˝: src_db  ‘≠±Ì√˚
  -- ‰»Î≤Œ ˝: src_table   ∑÷±Ì±Ì√˚
  -- ‰»Î≤Œ ˝: dest_db  ‘≠±Ì√˚
  -- ‰»Î≤Œ ˝: dest_table  ≤Ÿ◊˜ø™ º ±º‰
  -- ‰»Î≤Œ ˝: status  ≤Ÿ◊˜Ω· ¯ ±º‰
  -- ‰»Î≤Œ ˝: nums  ≤Ÿ◊˜À˘ª® ±º‰
  -- ‰»Î≤Œ ˝: remark  «Â¿Ìº«¬º ˝
  --¥¥Ω®’ﬂ£∫’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131109
  -------------------------------------------------------------------------------
begin
  insert into op_dm_syn_log
    (src_db,
     src_table,
     dest_db,
     dest_table,
     syn_time,
     status,
     nums,
     remark)
  values
    (src_db, src_table, dest_db, dest_table, sysdate, status, nums, remark);
  commit;
end up_dm_st_tk_syn_log;
/
grant execute on ACC_ST.UP_DM_ST_TK_SYN_LOG to ACC_ST_APP;


prompt
prompt Creating procedure UP_DM_ST_TK_SYN
prompt ==================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_dm_st_tk_syn(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                            out_msg       OUT VARCHAR2) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_dm_st_tk_syn
  --π¶ƒ‹√Ë ˆ£∫‘À”™π‹¿ÌœµÕ≥∫Õ∆±ø‚œµÕ≥÷Æº‰ ˝æ›Õ¨≤Ω
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫201301109
  --–ﬁ∏ƒ£∫20150525 modify by mqf ‘ˆº”÷µ°¢◊÷∂Œ sysdate INSERT_DATE
  -------------------------------------------------------------------------------
 AS

  v_msg          VARCHAR(50);
  v_sql          varchar2(1000);
  --v_date         date; --
  v_keep_days    int;
  v_count        int;
  v_column_names varchar2(500);

  v_date_str     VARCHAR2(20);
BEGIN
  out_msg       := ' ˝æ›Õ¨≤Ω≥…π¶';
  out_retresult := sqlcode;
  declare
    cursor scc_table is
      select t.src_table      tmp_src_table,
             t.src_db         tmp_src_db,
             t.dest_table     tmp_dest_table,
             t.dest_db        tmp_dest_db,
             t.dest_table_bak tmp_dest_table_bak,
             t.keep_days      tmp_keep_days,
             t.column_names   tmp_column_names
        from acc_st.op_dm_syn_config t;
  begin
    for i_cur in scc_table loop
      v_keep_days    := i_cur.tmp_keep_days;
      --v_date         := sysdate - v_keep_days;
    v_date_str := to_char(sysdate - v_keep_days,'yyyy-mm-dd hh24:mi:ss');
      v_column_names := i_cur.tmp_column_names;
      --
      v_sql := 'select count(*) from ' || i_cur.tmp_dest_db || '.' ||
               --i_cur.tmp_dest_table_bak || ' where insert_date<''' ||
               --v_date || ''' ';
         i_cur.tmp_dest_table_bak || ' where insert_date < to_date(''' || --20150525 modify by mqf
         v_date_str ||''', ''yyyy-mm-dd hh24:mi:ss'')';
      execute immediate v_sql
        into v_count;
      --…æ≥˝”––ß∆⁄«∞µƒ±∏∑› ˝æ›°£
      begin
        v_sql := 'delete from ' || i_cur.tmp_dest_db || '.' ||
                 --i_cur.tmp_dest_table_bak || ' where insert_date<''' ||
                 --v_date || '''';
         i_cur.tmp_dest_table_bak || ' where insert_date< to_date(''' || --20150525 modify by mqf
         v_date_str ||''', ''yyyy-mm-dd hh24:mi:ss'')';
        execute immediate v_sql;
      EXCEPTION
        when others then
          begin
            rollback;
            out_retresult := SQLCODE;
            out_msg       := '…æ≥˝”––ß∆⁄«∞µƒ±∏∑› ˝æ›' || i_cur.tmp_dest_table_bak ||
                             '≥ˆ¥Ì£∫¥ÌŒÛ¥˙¬Î£∫' || SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                             dbms_utility.format_error_backtrace() || ']––';

            acc_st.up_dm_st_tk_syn_log(i_cur.tmp_dest_db,
                                i_cur.tmp_dest_table_bak,
                                '',
                                '',
                                1,
                                0,
                                out_msg);
            continue;
          end;
      end;
      out_msg := '≥…π¶…æ≥˝' || v_count || 'Ãı ˝æ›¥”' || i_cur.tmp_dest_db || '.' ||
                 i_cur.tmp_dest_table_bak;
      acc_st.up_dm_st_tk_syn_log(i_cur.tmp_dest_db,
                          i_cur.tmp_dest_table_bak,
                          '',
                          '',
                          0,
                          v_count,
                          out_msg);
      --±∏∑› ˝æ›
      begin
        begin
          v_sql := 'insert into   ' || i_cur.tmp_dest_db || '.' ||
                   i_cur.tmp_dest_table_bak || '(' ||
                   i_cur.tmp_column_names || ',INSERT_DATE) select ' ||
                   i_cur.tmp_column_names || ' ,sysdate INSERT_DATE from ' || i_cur.tmp_dest_db || '.' || --20150525 modify by mqf ‘ˆº”÷µ°¢◊÷∂Œ sysdate INSERT_DATE
                   i_cur.tmp_dest_table;
          execute immediate v_sql;
        EXCEPTION
          when others then
            begin
              rollback;
              out_retresult := SQLCODE;
              out_msg       := '±∏∑› ˝æ›µΩ' || i_cur.tmp_dest_db || '.' ||
                               i_cur.tmp_dest_table_bak || '±Ì ˝æ›±®¥Ì£∫¥ÌŒÛ¥˙¬Î£∫' ||
                               SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                               dbms_utility.format_error_backtrace() || ']––';

              acc_st.up_dm_st_tk_syn_log(i_cur.tmp_dest_db,
                                  i_cur.tmp_dest_table_bak,
                                  '',
                                  '',
                                  1,
                                  0,
                                  out_msg);
              continue;
            end;
        end;

        v_sql := ' select count(*) from ' || i_cur.tmp_dest_db || '.' ||
                 i_cur.tmp_dest_table;
        execute immediate v_sql
          into v_count;
        out_msg := '≥…π¶±∏∑›' || v_count || 'Ãı ˝æ›µΩ' || i_cur.tmp_dest_db || '.' ||
                   i_cur.tmp_dest_table_bak;
        acc_st.up_dm_st_tk_syn_log(i_cur.tmp_dest_db,
                            i_cur.tmp_dest_table,
                            i_cur.tmp_dest_db,
                            i_cur.tmp_dest_table_bak,
                            0,
                            v_count,
                            out_msg);
      end;
      --…æ≥˝ƒøµƒ±Ì ˝æ›
      begin
        v_sql := 'delete from ' || i_cur.tmp_dest_db || '.' ||
                 i_cur.tmp_dest_table;
        execute immediate v_sql;
      end;

      begin
        begin
          --Õ¨≤Ω ˝æ›
          v_sql := 'insert into   ' || i_cur.tmp_dest_db || '.' ||
                   i_cur.tmp_dest_table || ' select ' || v_column_names ||
                   ' from ' || i_cur.tmp_src_db || '.' ||
                   i_cur.tmp_src_table || ' where record_flag=0';
          execute immediate v_sql;
        EXCEPTION
          when others then
            begin
              rollback;
              out_retresult := SQLCODE;
              out_msg       := 'Õ¨≤Ω ˝æ›µΩ' || i_cur.tmp_dest_db || '.' ||
                               i_cur.tmp_dest_table || '±Ì ˝æ›±®¥Ì£∫¥ÌŒÛ¥˙¬Î£∫' ||
                               SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                               dbms_utility.format_error_backtrace() || ']––';

              acc_st.up_dm_st_tk_syn_log(i_cur.tmp_src_db,
                                  i_cur.tmp_src_table,
                                  i_cur.tmp_dest_db,
                                  i_cur.tmp_dest_table,
                                  1,
                                  0,
                                  out_msg);
              continue;
            end;
        end;
        --Õ¨≤Ω ˝æ›
        v_sql := 'select count(*) from ' || i_cur.tmp_src_db || '.' ||
                 i_cur.tmp_src_table || ' where record_flag=0';
        execute immediate v_sql
          into v_count;
        out_msg := '≥…π¶Õ¨≤Ω' || v_count || 'Ãı ˝æ›µΩ' || i_cur.tmp_dest_db || '.' ||
                   i_cur.tmp_dest_table;
        acc_st.up_dm_st_tk_syn_log(i_cur.tmp_src_db,
                            i_cur.tmp_src_table,
                            i_cur.tmp_dest_db,
                            i_cur.tmp_dest_table,
                            0,
                            v_count,
                            out_msg);
      end;
    end loop;
  end;
  commit;
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;

END up_dm_st_tk_syn;
/
grant execute on ACC_ST.UP_DM_ST_TK_SYN to ACC_ST_APP;


prompt
prompt Creating procedure UP_IC_ES_GEN_PRODUCE_BILL
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST."UP_IC_ES_GEN_PRODUCE_BILL"
( orderNo IN CHAR                   --∂©µ•∫≈
, finiPronum IN INTEGER             --”––ß∆±
, surplusNum IN INTEGER             --Ω·”‡∆±
, trashyNum IN INTEGER              --∑œ∆±
, esSamno IN VARCHAR2               --SAMø®∫≈
, hdlFlag IN VARCHAR2               --¥¶¿Ì±Í÷æ
, achieveTime IN DATE               --…˙≤˙ ±º‰
, orderMemo IN VARCHAR2             --±∏◊¢
, esWorkTypeId IN VARCHAR2          --π§◊˜¿‡–Õ
, retCode  OUT INTEGER              --∑µªÿΩ·π˚
, retMsg OUT VARCHAR2               -- ‰≥ˆ–≈œ¢
)
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚:  UP_IC_ES_GEN_PRODUCE_BILL
  --π¶ƒ‹: Õ®—∂≥Ã–Ú◊‘∂Ø…˙≥……˙≤˙µ•
  -------------------------------------------------------------------------------
AS

  recNum INTEGER;
  strSql VARCHAR2( 1000);


  planBillNo  CHAR(12 );              --…˙≤˙º∆ªÆµ•
  outBillNo   CHAR(12 );               --≥ˆø‚µ•∫≈
  billNo      CHAR(12 );                  --µ•∫≈

  esOperator VARCHAR2( 10); --ES≤Ÿ◊˜‘±
  totalPlanProduce INTEGER; --º∆ªÆµ•◊‹…˙≤˙ ˝¡ø
  totalDraw INTEGER;  --¡Ï∆±◊‹ ˝¡ø
  totalSurplus INTEGER; --Ω·”‡◊‹ ˝¡ø
  totalTrash INTEGER;  --∑—∆±◊‹ ˝¡ø

  orderNoInt INTEGER;                   --∂©µ•∫≈
  curInt INTEGER; --”Œ±Í—≠ª∑–Ú ˝
  cardType INTEGER ;  --ø®∆¨¿‡–Õ
BEGIN

  --«Â¿Ì¡Ÿ ±±Ì
  DELETE ACC_TK.T#IC_PDU_PLAN_ORDER_MAPPING;
   DELETE ACC_TK.T#IC_PDU_ORDER_FORM;
   DELETE ACC_TK.T#IC_PDU_PRODUCE_BILL_DETAIL;
   DELETE acc_tk.T#IC_PDU_RESULT_DETAIL;

   commit;

  --»°≥ˆø‚º∆ªÆµ•∫≈°¢≥ˆø‚µ•∫≈
  SELECT plan_bill_no, out_bill_no into planbillno, outbillno
      FROM ACC_TK.ic_pdu_plan_order_mapping
      WHERE order_no = orderno;

  ---≈–∂œ «∑Ò–Ë…˙≥……˙≤˙µ•£¨»Á¥Ê‘⁄…˙≤˙µ•£¨‘Ú∑µªÿ
  select count(*) into recNum FROM dual
    where EXISTS (SELECT 1 from acc_tk.IC_PDU_PRODUCE_BILL where out_bill_no=outBillNo);
  if recNum<> 0 then
    begin
       retCode := 4;
       retMsg := '…˙≤˙µ•“—¥Ê‘⁄' ;
       return;
    end;
  end if;

  --∏¸–¬∂©µ•µƒ”––ß∆±°¢∑œ∆±°¢Ω·”‡∆±°¢SAMø®∫≈°¢¥¶¿Ì±Í÷æ°¢…˙≤˙ ±º‰°¢±∏◊¢
  BEGIN
    UPDATE ACC_TK.IC_PDU_ORDER_FORM
      SET fini_pronum= finiPronum, surplus_num= surplusnum, trashy_num= trashynum,
        es_samno= essamno, hdl_flag= hdlflag, achieve_time= achievetime, order_memo= ordermemo
      where order_no=orderNo;
  EXCEPTION
    WHEN OTHERS THEN
    BEGIN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
        DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
        retCode := 1;
        retMsg := '∏¸–¬…˙≤˙∂©µ•±Ì ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
        return;
    END;
  END;

  --µ±∂©µ•Œ¥ÕÍ’˚ÕÍ≥… ±£®hdlflag='2'£∫±ª÷–Õæ÷–÷πΩ· ¯∂©µ•£©
  /*
  BEGIN
    IF hdlflag='2' THEN
      BEGIN
        -- ∏¸–¬Œ¥ø™ ºµƒÀ˘”–∂©µ•Œ™2 Œ¥ÕÍ’˚ÕÍ≥…◊¥Ã¨
        UPDATE ACC_TK.IC_PDU_ORDER_FORM
          SET fini_pronum= 0, surplus_num= pro_num, trashy_num= 0,
            es_samno= '', hdl_flag= hdlflag, achieve_time= achievetime, order_memo= ordermemo
          where order_no IN (SELECT order_no FROM ACC_TK.IC_PDU_PLAN_ORDER_MAPPING WHERE out_bill_no = outbillno )
                AND hdl_flag = 0;
        -- ∏¸–¬≥˝’˝‘⁄…˙≤˙Õ‚µƒÀ˘”–∂©µ•Œ™1 ÕÍ≥…◊¥Ã¨
        UPDATE ACC_TK.IC_PDU_PLAN_ORDER_MAPPING SET finish_flag= '1', detail_total= 0
          WHERE out_bill_no = outbillno AND order_no NOT IN (
                SELECT order_no FROM ACC_TK.IC_PDU_ORDER_FORM WHERE hdl_flag=1
          ) AND finish_flag<> '1';
      END;
    END IF;
  EXCEPTION
    WHEN OTHERS THEN
      BEGIN
        ROLLBACK;
        retCode := 1;
        retMsg := '∏¸–¬…˙≤˙∂©µ•±Ì ß∞‹2,'||SQLCODE||':'||SQLERRM;
        return;
      END;
  END;
  */

  --∏¸–¬∂©µ•ÕÍ≥…±Í÷æ
  BEGIN
    IF hdlflag='2' OR hdlflag= '3' THEN
    BEGIN
      UPDATE ACC_TK.IC_PDU_PLAN_ORDER_MAPPING
        SET finish_flag= '1' , detail_total= finipronum
        WHERE order_no= orderno;
    END;
    END IF ;
  EXCEPTION
    WHEN OTHERS THEN
      BEGIN
        ROLLBACK;
        retCode := 2;
        retMsg := '∏¸–¬∂©µ•±ÌªÚ∂‘’’±Ì ß∞‹' ;
        return;
      END;
  END;

  --≈–∂œ…˙≤˙º∆ªÆ «∑Òªπ”–Œ¥ÕÍ≥…∂©µ•
  select count(*) into recNum from dual
    where EXISTS (select 1 from acc_tk.IC_PDU_PLAN_ORDER_MAPPING where plan_bill_no=planBillNo and finish_flag <>'1');
  if recNum!= 0 then
    begin
      --hwj modify 20140308
      --retCode := 3;
      retCode := 0;
      retMsg := 'ªπ”–Œ¥ÕÍ≥…∂©µ•' ;
      return;
    end;
  end if;

  --…˙≤˙µ•∫≈
  billNo := ACC_TK.uf_ic_es_get_bill_flow(retMsg);

   begin
    --»°≥ˆES≤Ÿ◊˜‘±
     select operator into esOperator from ACC_TK.IC_OUT_DATE_PLAN where bill_no=planBillNo;

     ---Õ≥º∆ ˝¡ø
     select sum (draw_num),sum(trashy_num), sum(fini_pronum), sum(surplus_num)
          into totalDraw, totalTrash, totalPlanProduce, totalSurplus
        from ACC_TK.IC_PDU_ORDER_FORM
        where order_no in (select order_no from ACC_TK.IC_PDU_PLAN_ORDER_MAPPING where plan_bill_no=planBillNo);
   exception
     WHEN others THEN
     begin
       ROLLBACK;
       DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE ||':'||planBillNo);
       DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
       retMsg := '»°≥ˆES≤Ÿ◊˜‘±ªÚÕ≥º∆ ˝¡ø ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
       retCode := 5;
       return;
     end;
   end;

   --”…”⁄¡Ï∆± ˝¡ø√ª”–∑÷≤µΩ …˙≤˙µ•£¨À˘“‘–Ë¥”‘≠≥ˆø‚µ•≤È—Ø¡Ï∆± ˝¡ø
   SELECT out_num INTO totalDraw FROM ic_out_bill_detail WHERE bill_no = outbillno;

  ----…˙≤˙…˙≤˙µ•◊‹±Ì
   begin
     insert into ACC_TK.IC_PDU_PRODUCE_BILL(bill_no,out_bill_no,es_worktype_id,bill_date,
                                record_flag,remarks,es_operator,draw_total,system_balance,
                                es_useless_num,real_balance,man_useless_num,lost_num)
               values(billNo,outBillNo,esWorkTypeId,sysdate ,'3', 'œµÕ≥◊‘∂Ø…˙≥…' ,esOperator,
                      totalDraw,totalSurplus,totalTrash, 0,0 ,0);
   exception
     when OTHERS THEN
     begin
       ROLLBACK;
       DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE ||':'||planBillNo);
       DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
       retMsg := '…˙≥……˙≤˙µ• ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
       retCode := 6;
       return;
     end;
   end;

   --…˙≥……˙≤˙√˜œ∏
   --ª∫¥Ê…˙≤˙µ•∂©µ•”≥…‰±Ì
   begin
     insert into ACC_TK.T#IC_PDU_PLAN_ORDER_MAPPING(plan_bill_no,order_no,finish_flag,out_bill_no,out_water_no)
                  select plan_bill_no,order_no,finish_flag,out_bill_no,out_water_no
                  from  ACC_TK.IC_PDU_PLAN_ORDER_MAPPING where plan_bill_no=planBillNo;
   exception
    WHEN others THEN
    begin
       ROLLBACK;
       retMsg := 'ª∫¥Ê…˙≤˙µ•∂©µ•”≥…‰±Ì ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
       retCode := 7;
       return;
    end;
   end;

   --ª∫¥Ê∂©µ•±Ì
   begin
     insert into ACC_TK.T#IC_PDU_ORDER_FORM(order_no,card_main_code,card_sub_code,card_per_ava,card_mon,
                        draw_num,fini_pronum,surplus_num,trashy_num,
                        es_samno,line_code,station_code,
                        card_ava_days,exit_line_code,exit_station_code,model)
               select order_no,card_main_code,card_sub_code,card_per_ava,CARD_MON,
                      draw_num,fini_pronum,surplus_num,trashy_num,
                      es_samno,line_code,station_code,
                      card_ava_days,exit_line_code,exit_station_code, model
              from ACC_TK.IC_PDU_ORDER_FORM
              where order_no in (select order_no from ACC_TK.T#IC_PDU_PLAN_ORDER_MAPPING);
   exception
    when OTHERS then
    begin
       ROLLBACK;
       retMsg := 'ª∫¥Ê∂©µ•±Ì ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
       retCode := 8;
       return;
    end;
   end;

   begin
     --ª∫¥Ê…˙≤˙√˜œ∏
     insert into ACC_TK.T#IC_PDU_PRODUCE_BILL_DETAIL(bill_no,afc_main_type,afc_sub_type,
                          card_money,vaild_date,afc_line_id,afc_station_id,es_samno,
                          draw_quantity,order_no,out_bill_no,out_water_no,
                          card_ava_days,afc_exit_line_id,afc_exit_station_id,modal)
                select billNo ,A.card_main_code,A.card_sub_code,
                       A.card_mon,A.card_per_ava,A.line_code,A.station_code,A.es_samno,
                       A.fini_pronum,B.order_no,B.out_bill_no,B.out_water_no,
                       A.card_ava_days,A.exit_line_code,A.exit_station_code,A.model
               from  ACC_TK.T#IC_PDU_ORDER_FORM A,ACC_TK.T#IC_PDU_PLAN_ORDER_MAPPING B
               where A.order_no =B.order_no;
   exception
    when OTHERS then
    begin
      ROLLBACK;
      DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
        DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
      retMsg := 'ª∫¥Ê…˙≤˙√˜œ∏ ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
      retCode := 9;
      return;
    end;
   end;

   BEGIN
     --∏¸–¬ª˙∆˜∫≈ modify hwj 20140306
     --update ACC_TK.T#IC_PDU_PRODUCE_BILL_DETAIL A
     --     set machine_no = (SELECT B.device_id from ACC_ST.OP_PRM_SAM_LIST B
     --              where A.es_samno = B.sam_logical_id and B.dev_type_id='09' and B.record_flag='0');
     update ACC_TK.T#IC_PDU_PRODUCE_BILL_DETAIL A
           set machine_no = (select B.ES_SERIAL_NO from ACC_TK.IC_PDU_ORDER_FORM B
                     where B.Order_No=orderNo);
   EXCEPTION
    WHEN OTHERS THEN
    BEGIN
      ROLLBACK;
      retMsg := '∏¸–¬ª˙∆˜∫≈ ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
      retCode := 10;
      return;
    END;
   END;

   -----------------------------------------------∫œ≤¢∂©µ•∫≈ø™ º-----------------------------------------------------------
   DECLARE
     cursor cur_pbd is
        select bill_no,afc_main_type,afc_sub_type,card_money,vaild_date,afc_line_id,
               afc_station_id,machine_no,draw_quantity,order_no,out_bill_no,out_water_no,
               card_ava_days,afc_exit_line_id,afc_exit_station_id,modal
        from  ACC_TK.T#IC_PDU_PRODUCE_BILL_DETAIL
        order by order_no,bill_no,afc_main_type,afc_sub_type,card_money,vaild_date,afc_line_id,
                 afc_station_id,machine_no,out_bill_no,out_water_no,card_ava_days,
                 afc_exit_line_id,afc_exit_station_id,modal;
    BEGIN
      curInt := 0;
      for pbd in cur_pbd
      LOOP
          IF curInt>0 AND to_number(pbd.order_no)=orderNoInt+ 1 THEN
              BEGIN
                update acc_tk.T#IC_PDU_RESULT_DETAIL
                  set draw_quantity=draw_quantity+pbd.draw_quantity,end_box_id=pbd.order_no,order_no=pbd.order_no
                  where order_no=orderNoInt;
              end;
          ELSE
            begin
              insert into acc_tk.T#IC_PDU_RESULT_DETAIL(bill_no,afc_main_type,afc_sub_type,
                                       card_money,vaild_date,afc_line_id,afc_station_id,machine_no,
                                       draw_quantity,start_box_id,end_box_id,out_bill_no,out_water_no,
                                       card_ava_days,afc_exit_line_id,afc_exit_station_id,modal,order_no)
                   values(pbd.bill_no,pbd.afc_main_type,pbd.afc_sub_type,pbd.card_money,pbd.vaild_date,
                          pbd.afc_line_id,pbd.afc_station_id,pbd.machine_no,pbd.draw_quantity,
                          pbd.order_no,pbd.order_no,pbd.out_bill_no,pbd.out_water_no,pbd.card_ava_days,
                          pbd.afc_exit_line_id,pbd.afc_exit_station_id,pbd.modal,pbd.order_no);
            end;
          end if ;
          --SELECT draw_quantity INTO draw_quantity_tmp FROM T#IC_PDU_RESULT_DETAIL WHERE order_no=pbd.order_no;
          curInt := curInt+ 1;
          orderNoInt := pbd.order_no;
          /*
        orderNoInt := "TO_NUMBER"(pbd.order_no)-1;
        select count(*) into recNum from dual
          where EXISTS(select 1 from acc_tk.T#IC_PDU_RESULT_DETAIL where order_no=orderNoInt);
        if recNum=0 then
          begin
            insert into acc_tk.T#IC_PDU_RESULT_DETAIL(bill_no,afc_main_type,afc_sub_type,
                                     card_money,vaild_date,afc_line_id,afc_station_id,machine_no,
                                     draw_quantity,start_box_id,end_box_id,out_bill_no,out_water_no,
                                     card_ava_days,afc_exit_line_id,afc_exit_station_id,modal,order_no)
                 values(pbd.bill_no,pbd.afc_main_type,pbd.afc_sub_type,pbd.card_money,pbd.vaild_date,
                        pbd.afc_line_id,pbd.afc_station_id,pbd.machine_no,pbd.draw_quantity,
                        pbd.order_no,pbd.order_no,pbd.out_bill_no,pbd.out_water_no,pbd.card_ava_days,
                        pbd.afc_exit_line_id,pbd.afc_exit_station_id,pbd.modal,pbd.order_no);
          end;
        else
          begin
            update acc_tk.T#IC_PDU_RESULT_DETAIL
              set draw_quantity=draw_quantity+pbd.draw_quantity,end_box_id=pbd.order_no,order_no=orderNoInt
              where order_no=orderNoInt;
          end;
        end if;
        */
        --—≠ª∑◊ˆ“˛∫¨ºÏ≤È %notfound
      end loop ;
    end;
    ---------------------------------------------∫œ≤¢∂©µ•∫≈Ω· ¯-------------------------------------------------

   BEGIN
     --◊™ªªAFC∆±ø®¿‡–Õ≥…ic∆±ø‚∆±ø®¿‡–Õ
     /*
     update acc_tk.T#IC_PDU_RESULT_DETAIL A set(ic_main_type,ic_sub_type)=
          (select B.ic_main_type,B.ic_sub_type from acc_tk.IC_COD_CARD_TYPE_CONTRAST B
            where A.afc_main_type = B.CARD_MAIN_TYPE and A.afc_sub_type=B.CARD_SUB_TYPE);
            */
     update acc_tk.T#IC_PDU_RESULT_DETAIL A set(ic_main_type,ic_sub_type)=
          ( SELECT DISTINCT ic_main_type,ic_sub_type FROM ic_out_bill_detail WHERE bill_no=outBillNo);
   EXCEPTION
    WHEN OTHERS THEN
    BEGIN
      ROLLBACK;
      DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
      DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
      retMsg := '◊™ªªAFC∆±ø®¿‡–Õ≥…ic∆±ø‚∆±ø®¿‡–Õ ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
      retCode := 11;
      return;
    END;
   END;

   BEGIN
     --◊™ªªAFC≥µ’æ¥˙¬Î≥…ic∆±ø‚≥µ’æ¥˙¬Î --∏ƒŒ™œ»∏¸–¬œﬂœﬂ¬∑‘Ÿ∏¸–¬≥µ’æ
     update acc_tk.T#IC_PDU_RESULT_DETAIL A set A.line_id=
        ( SELECT DISTINCT B.line_id from acc_tk.IC_COD_STATION_CONTRAST B
        where A.afc_line_id =B.line_code);
     update acc_tk.T#IC_PDU_RESULT_DETAIL A set A.station_id=
        ( SELECT DISTINCT B.station_id from acc_tk.IC_COD_STATION_CONTRAST B
        where A.afc_line_id =B.line_code and A.afc_station_id=B.station_code);
   EXCEPTION
     WHEN OTHERS THEN
     BEGIN
      ROLLBACK;
      DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
      DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
      retMsg := '◊™ªªAFC≥µ’æ¥˙¬Î≥…ic∆±ø‚≥µ’æ¥˙¬Î ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
      retCode := 12;
      return;
    END;
   END;

   begin
    update acc_tk.T#IC_PDU_RESULT_DETAIL A set exit_line_id=
      ( SELECT DISTINCT B.line_id from acc_tk.IC_COD_STATION_CONTRAST B
           where A.afc_exit_line_id =B.line_code);

    update acc_tk.T#IC_PDU_RESULT_DETAIL A set exit_station_id=
      ( SELECT DISTINCT B.station_id from acc_tk.IC_COD_STATION_CONTRAST B
           where A.afc_exit_line_id =B.line_code and A.afc_exit_station_id=B.station_code);
   EXCEPTION
     WHEN OTHERS THEN
     BEGIN
      ROLLBACK;
      DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
      DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
      retMsg := '◊™ªªAFC≥µ’æ¥˙¬Î≥…ic∆±ø‚≥µ’æ¥˙¬Î ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
      retCode := 13;
      return;
    END;
   END;

   begin
     --≤Â»Î…˙≤˙√˜œ∏±Ì(”––ß∆±)
     insert into ACC_TK.IC_PDU_PRODUCE_BILL_DETAIL(water_no,bill_no,ic_main_type,ic_sub_type,card_money,
            vaild_date,line_id,station_id,machine_no,draw_quantity,start_box_id,
            end_box_id,card_ava_days,exit_line_id,exit_station_id,model)
        select seq_ic_pdu_produce_bill_detail.nextval,bill_no,ic_main_type,ic_sub_type,card_money,vaild_date,line_id,
               station_id,machine_no,draw_quantity,start_box_id,end_box_id,
               card_ava_days,exit_line_id,exit_station_id,modal
        from acc_tk.T#IC_PDU_RESULT_DETAIL;
   exception
     when others then
     begin
       ROLLBACK;
       DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
       DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
       retMsg := '≤Â»Î…˙≤˙√˜œ∏±Ì ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
       retCode := 14;
       return;
     end;
   end;

   --µº»Îª∫¥Ê ˝æ›µΩ’˝ Ω√˜œ∏±Ì---------------------------------------------------------
   if(esWorkTypeId = '00') then --≥ı ºªØ∂©µ•
   begin
       begin
         insert into ACC_TK.IC_ES_INITI_INFO(logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                 print_id, manu_time, card_money, peri_avadate, kdc_version,
                                 hdl_time, order_no, status_flag, card_type,
                                 card_ava_days,exit_line_code,exit_station_code,model)
                      select     logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                 print_id, manu_time, card_money, peri_avadate, kdc_version,
                                 hdl_time, order_no, status_flag, card_type,
                                 card_ava_days,exit_line_code,exit_station_code,model
                      from ACC_TK.IC_ES_INITI_INFO_BUF;

          ----∏¸–¬≥…π¶º«√˚ø®º«¬º–≈œ¢
          UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '2',t.hdl_time = SYSDATE
          WHERE hdl_flag = '1' AND EXISTS (
               SELECT 1 FROM ACC_TK.IC_ES_INITI_INFO_BUF a,acc_tk.ic_pdu_order_form b
               WHERE a.order_no = b.order_no(+) AND b.card_type='1' AND a.req_no = t.req_no AND a.order_no = t.order_no
          );
          ---ªπ‘≠ ß∞‹º«¬ºµƒº«√˚ø®
          UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '0',t.hdl_time = '' , t.order_no=''
          WHERE hdl_flag = '1' AND EXISTS (
               SELECT 1 FROM ACC_TK.IC_ES_INITI_INFO_BUF a WHERE  a.order_no = t.order_no
          );

         --≤Â»ÎŒÔ¿Ìø®∫≈”Î¬ﬂº≠ø®∫≈∂‘’’±∏∑›±Ì
         insert into ACC_ST.op_his_phy_logic_list(physic_no,logic_no)
                      SELECT phy_id,logical_id from ACC_TK.IC_ES_INITI_INFO_BUF;

         --…æ≥˝ŒÔ¿Ìø®∫≈”Î¬ﬂº≠ø®∫≈∂‘’’±Ì“—æ≠÷∆ø® ˝æ›,Õ¨ ±∆±ø®¿‡–Õ≤ªŒ™µ•≥Ã∆±(20140604–ﬁ∏ƒ by lindaquan)
         DELETE FROM ACC_ST.op_prm_phy_logic_list WHERE trim(physic_no) in(
         SELECT trim (phy_id) from ACC_TK.IC_ES_INITI_INFO_BUF where trim(card_main_type) <> '01' );

         --…æ≥˝Buf¡Ÿ ± ˝¡ø(∆±ŒÒ»Îø‚ª·…æ≥˝£¨¥À¥¶≤ªƒ‹…æ≥˝)
         DELETE FROM ACC_TK.IC_ES_INITI_INFO_BUF;

     exception
      when others then
      begin
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
        DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
        retMsg := '≤Â»Î≥ı ºªØ∂©µ•±Ì ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
        retCode := 15;
        return;
      end;
     end;
   end;
   end if;

   if(esWorkTypeId = '01') then        --‘§∏≥÷µ∂©µ•
   begin
     begin
       insert into ACC_TK.IC_ES_HUNCH_INFO(logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                 print_id, manu_time, card_money, peri_avadate, kdc_version,
                                 hdl_time, order_no, status_flag, card_type,
                                 line_code, station_code, card_start_ava,
                                 card_ava_days,exit_line_code,exit_station_code,model
                                 )
                     select     logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                print_id, manu_time, card_money, peri_avadate, kdc_version,
                                hdl_time, order_no, status_flag, card_type,
                                line_code, station_code, card_start_ava ,
                                card_ava_days,exit_line_code,exit_station_code,model
                     from     ACC_TK.IC_ES_HUNCH_INFO_BUF;

       ----∏¸–¬≥…π¶º«√˚ø®º«¬º–≈œ¢
        UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '2',t.hdl_time = SYSDATE
        WHERE hdl_flag = '1' AND EXISTS (
             SELECT 1 FROM ACC_TK.IC_ES_HUNCH_INFO_BUF a,acc_tk.ic_pdu_order_form b
             WHERE a.order_no = b.order_no(+) AND b.card_type='1' AND a.req_no = t.req_no AND a.order_no = t.order_no
        );
        ---ªπ‘≠ ß∞‹º«¬ºµƒº«√˚ø®
        UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '0',t.hdl_time = '' , t.order_no=''
        WHERE hdl_flag = '1' AND EXISTS (
             SELECT 1 FROM ACC_TK.IC_ES_HUNCH_INFO_BUF a WHERE  a.order_no = t.order_no
        );

       --…æ≥˝Buf¡Ÿ ± ˝¡ø(∆±ŒÒ»Îø‚ª·…æ≥˝£¨¥À¥¶≤ªƒ‹…æ≥˝)
       DELETE FROM ACC_TK.IC_ES_HUNCH_INFO_BUF;

     exception
       when others then
       begin
         ROLLBACK;
         DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
        DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
         retMsg := '≤Â»Î‘§∏≥÷µ∂©µ• ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
         retCode := 16;
         return;
       end;
     end;
   end;
   end if;

   if(esWorkTypeId = '02') then        --÷ÿ±‡¬Î∂©µ•
   begin
     begin
         insert into ACC_TK.IC_ES_AGAIN_INFO(logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                   print_id, manu_time, card_money, peri_avadate, kdc_version,
                                   hdl_time, order_no, status_flag, card_type,
                                   card_ava_days,exit_line_code,exit_station_code,model
                                   )
                        select     logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                   print_id, manu_time, card_money, peri_avadate, kdc_version,
                                   hdl_time, order_no, status_flag, card_type,
                                   card_ava_days,exit_line_code,exit_station_code,model
                        from     ACC_TK.IC_ES_AGAIN_INFO_BUF;


       ----∏¸–¬≥…π¶º«√˚ø®º«¬º–≈œ¢
        UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '2',t.hdl_time = SYSDATE
        WHERE hdl_flag = '1' AND EXISTS (
             SELECT 1 FROM ACC_TK.IC_ES_AGAIN_INFO_BUF a,acc_tk.ic_pdu_order_form b
             WHERE a.order_no = b.order_no(+) AND b.card_type='1' AND a.req_no = t.req_no AND a.order_no = t.order_no
        );
        ---ªπ‘≠ ß∞‹º«¬ºµƒº«√˚ø®
        UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '0',t.hdl_time = '' , t.order_no=''
        WHERE hdl_flag = '1' AND EXISTS (
             SELECT 1 FROM ACC_TK.IC_ES_AGAIN_INFO_BUF a WHERE  a.order_no = t.order_no
        );

       --…æ≥˝Buf¡Ÿ ± ˝¡ø(∆±ŒÒ»Îø‚ª·…æ≥˝£¨¥À¥¶≤ªƒ‹…æ≥˝)
       DELETE FROM ACC_TK.IC_ES_AGAIN_INFO_BUF;

     exception
      when others then
      begin
         ROLLBACK;
         DBMS_OUTPUT.PUT_LINE( 'sqlcode : ' || SQLCODE );
         DBMS_OUTPUT.PUT_LINE( 'sqlerrm : ' || SQLERRM );
         retMsg := '≤Â»Î÷ÿ±‡¬Î∂©µ• ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
         retCode := 17;
         return;
      end;
     end;
   end;
   end if;
   if(esWorkTypeId = '03') then        --◊¢œ˙∂©µ•
   begin
     begin
       insert into ACC_TK.IC_ES_LOGOUT_INFO(logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                  print_id, manu_time, card_money, peri_avadate, kdc_version,
                                  hdl_time, order_no, status_flag, card_type,
                                  card_ava_days,exit_line_code,exit_station_code,model
                                  )
                       select     logical_id, card_main_type, card_sub_type, req_no, phy_id,
                                  print_id, manu_time, card_money, peri_avadate, kdc_version,
                                  hdl_time, order_no, status_flag, card_type,
                                  card_ava_days,exit_line_code,exit_station_code,model
                       from     ACC_TK.IC_ES_LOGOUT_INFO_BUF;


       ----∏¸–¬≥…π¶º«√˚ø®º«¬º–≈œ¢
        UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '2',t.hdl_time = SYSDATE
        WHERE hdl_flag = '1' AND EXISTS (
             SELECT 1 FROM ACC_TK.IC_ES_LOGOUT_INFO_BUF a,acc_tk.ic_pdu_order_form b
             WHERE a.order_no = b.order_no(+) AND b.card_type='1' AND a.req_no = t.req_no AND a.order_no = t.order_no
        );
        ---ªπ‘≠ ß∞‹º«¬ºµƒº«√˚ø®
        UPDATE acc_st.st_list_sign_card t SET t.hdl_flag = '0',t.hdl_time = '' , t.order_no=''
        WHERE hdl_flag = '1' AND EXISTS (
             SELECT 1 FROM ACC_TK.IC_ES_LOGOUT_INFO_BUF a WHERE  a.order_no = t.order_no
        );

       --…æ≥˝Buf¡Ÿ ± ˝¡ø(∆±ŒÒ»Îø‚ª·…æ≥˝£¨¥À¥¶≤ªƒ‹…æ≥˝)
       DELETE FROM ACC_TK.IC_ES_LOGOUT_INFO_BUF;

     exception
       when others then
       begin
         ROLLBACK;
         retMsg := '≤Â»Î◊¢œ˙∂©µ• ß∞‹,' ||SQLCODE|| ':'||SQLERRM ;
         retCode := 17;
         return;
       end;
     end;
   end;
   end if;
   ------------------------µº»Îª∫¥Ê ˝æ›µΩ’˝ Ω√˜œ∏±ÌΩ· ¯-------------------------
   --«Â¿Ì¡Ÿ ±±Ì
   DELETE ACC_TK.T#IC_PDU_PLAN_ORDER_MAPPING;
   DELETE ACC_TK.T#IC_PDU_ORDER_FORM;
   DELETE ACC_TK.T#IC_PDU_PRODUCE_BILL_DETAIL;
   DELETE acc_tk.T#IC_PDU_RESULT_DETAIL;

   commit; --Ã·Ωª

   retMsg := '≥…π¶';
   retCode := 0;

END UP_IC_ES_GEN_PRODUCE_BILL;
/

prompt
prompt Creating procedure UP_NON_RETURN_ACTION
prompt =======================================
prompt
create or replace procedure acc_st.up_non_return_action(i_id          in int, --ª·ª∞id
                                                 i_applybill   in varchar2, --…Í«Î∑«º¥ÕÀµƒµƒ∆æ÷§
                                                 i_applyaction in varchar2, --≤Ÿ◊˜¿‡–Õ
                                                 i_processbom  in varchar2, --µ±«∞bom
                                                 o_resultset   out sys_refcursor --∂®“Âout≤Œ ˝∑µªÿΩ·π˚ºØ
                                                 )
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚: up_non_return_action
  --π¶ƒ‹£∫¥¶¿Ì∑«º¥ ±ÕÀøÓ≤È—Ø°¢ÕÀøÓ°¢ÕÀøÓΩ·π˚
  --≤Œ ˝£∫
  --–ﬁ∏ƒ’ﬂ£∫hejj
  --–ﬁ∏ƒ»’∆⁄£∫20140912
  --–ﬁ∏ƒÀµ√˜£∫∆±ø®¬ﬂº≠ø®∫≈»°∫Û16Œª
  --∞Ê±æ:1.01
  --–ﬁ∏ƒ’ﬂ£∫hejj
  --–ﬁ∏ƒ»’∆⁄£∫20141124
  --–ﬁ∏ƒÀµ√˜£∫‘ˆº”…Û∫À±Í÷æNULL÷µ≈–∂œ
  --∞Ê±æ:1.06
  --–ﬁ∏ƒ’ﬂ£∫lindaquan
  --–ﬁ∏ƒ»’∆⁄£∫20160107
  --–ﬁ∏ƒÀµ√˜£∫∑«º¥ ±ÕÀøÓµ»¥˝»’–ﬁ∏ƒŒ™≤È—Ø≈‰÷√±Ì
  --∞Ê±æ:1.09

  -------------------------------------------------------------------------------
 as
  tkTime       varchar(8); --∆æ÷§ ±º‰
  shiftId      varchar(2); --…Í«Î¥¶¿Ì∞‡¥Œ
  lineId       varchar(2); --…Í«Î¥¶¿Ì≥µ’æ
  stationId    varchar(2); --…Í«Î¥¶¿Ì≥µ’æ
  deviceId     varchar(4); --…Í«Î¥¶¿Ì…Ë±∏id
  receiptId    varchar(4); --∆æ÷§–Ú∫≈
  devicetypeId varchar(2); --…Ë±∏¿‡–Õ
  isNeedBaseinfo int; -- «∑Ò–Ë“™ª˘±æ–≈œ¢
  --cardLogicalId  varchar(16);
  audt_flag varchar(1);
  applytime date;
  actionQuery  varchar(1); --≤È—Ø
  actionApply  varchar(1); --…Í«ÎÕÀøÓ
  actionFinish varchar(1); --ÕÀøÓÕÍ≥…
  hdlFlagPermit  varchar(1); --–Ìø…
  hdlFlagUnandle varchar(1); --Œ¥¥¶¿Ì
  hdlFlagHandle  varchar(1); --≥µ∆±“—”–ÕÀøÓΩ·π˚
  hdlFlagFinish  varchar(1); --ÕÀøÓÕÍ≥…
  hdlFlagError   varchar(1); --∑«∑®…Í«Î
  procesingDoing   varchar(1); --¥Ê‘⁄≤¢∑¢
  procesingNodoing varchar(1); --√ª”–≤¢∑¢
  v_temp_counts  int;
  v_temp_counts1 int;
  v_temp_counts2 int;
  non_return_day int := 7; --∑«º¥ ±ÕÀøÓµ»¥˝»’
begin
  ---------------------------------ª˘±æ–≈œ¢¥¶¿Ì-------------------------------------------------------------
  begin
    execute immediate ('truncate table t#st_results_non_rtn');
    commit;
    begin
      --ªÒ»°∆æ÷§–≈œ¢
      --20120616-01-0101-001-0002
      select substr(i_applybill, 1, 8),
             substr(i_applybill, 10, 2),
             substr(i_applybill, 13, 2),
             substr(i_applybill, 15, 2),
             substr(i_applybill, 18, 3),
             substr(i_applybill, 22, 4),
             '03'
        into tkTime, --‘À”™»’
             shiftId, --BOM∞‡¥Œ–Ú∫≈
             lineId, --œﬂ¬∑±‡∫≈
             stationId, --≥µ’æ±‡∫≈
             deviceId, --…Ë±∏ID
             receiptId, --…Í«Î∑«º¥ÕÀµƒ∆æ÷§ID
             devicetypeId --…Ë±∏¿‡–Õ
        from dual;
    end;

    --≤È—Ø≈‰÷√±Ì∑«º¥ ±ÕÀøÓµ»¥˝»’
    select cfg_value into non_return_day from ST_CFG_SYS_BASE where cfg_key='sys.non_return_day';

    begin
      --¥¶¿Ì±Í÷æ
      hdlFlagFinish  := '1'; --“—∞Ï¿ÌÕÀøÓ
      hdlFlagUnandle := '2'; --≥µ∆±Œ¥¥¶¿Ì
      hdlFlagHandle  := '3'; --≥µ∆±“—”–ÕÀøÓΩ·π˚
      hdlFlagError   := '5'; --∆æ÷§∫≈ªÚø®∫≈ ‰»Î¥ÌŒÛ£¨÷ÿ–¬ ‰»Î
      hdlFlagPermit  := '7'; --ÕÀøÓ…Í«Îµ√µΩ–Ìø…
      --∑«º¥ ±ÕÀøÓ≤Ÿ◊˜1£∫≤È—Ø 2£∫…Í«ÎÕÀøÓ 3£∫ÕÀøÓÕÍ≥…
      actionQuery  := '1'; --≤È—Ø
      actionApply  := '2'; --ÕÀøÓ
      actionFinish := '3'; --ÕÀøÓ≥…π¶Õ®÷™
      --≤¢∑¢÷µ
      procesingDoing   := '1';
      procesingNodoing := '0';
      --≈–∂œ «∑Ò–Ë“™ª˘±æ–≈œ¢
      isNeedBaseinfo := 0;
    end;
    --∑«º¥ ±ÕÀ≤È—Ø°¢º∞…Í«Î
    if (actionQuery = i_applyaction or actionApply = i_applyaction) then
      isNeedBaseinfo := 1;
    end if;
  end;
  ---------------------------------ª˘±æ–≈œ¢¥¶¿ÌΩ· ¯-------------------------------------------------------------
  begin
    if (isNeedBaseinfo = 1) then
      begin
        insert into t#st_results_non_rtn
          (card_logical_id,
           deposit_fee,
           card_balance_fee,
           actual_return_bala,
           penalty,
           penalty_reason,
           audt,
           hdl_flag,
           apply_datetime)
          select --card_logical_id, modify by hejj 20140912
                 case
                    when length(card_logical_id)>16 then substr(card_logical_id,length(card_logical_id)-16+1,16)
                    else card_logical_id
                 end case,
                 deposit_fee * 100 deposit_fee, --—∫Ω
                 card_balance_fee * 100 card_balance_fee, --ø®∆¨”‡∂Ó
                 actual_return_bala * 100 actual_return_bala, -- µº ∑µ”‡∂Ó
                 penalty_fee * 100 penalty, --∑£Ω
                 penalty_reason, --≥Õ∑£‘≠“Ú
                 AUDIT_FLAG, --…Û∫À‘≠“Ú£∫1-…Û∫ÀÕ®π˝
                 hdl_flag, --¥¶¿ÌΩ·π˚(«Â∑÷œµÕ≥÷ª–¥2÷÷±Í ∂):2-Œ¥¥¶¿Ì£ª3-≥µ∆±“—”–ÕÀøÓΩ·π˚
                 apply_datetime --…Í«Î ±º‰
            from st_list_non_rtn
           where line_id = lineId
             and station_id = stationId
             and dev_type_id = devicetypeId
             and device_id = deviceId
             and receipt_id = receiptId
             and to_char(apply_datetime, 'yyyymmdd') = tkTime
             and shift_id = shiftId;
      end;
      --
      select count(card_logical_id)
        into v_temp_counts
        from t#st_results_non_rtn;
      if (v_temp_counts = 1) then
        select audt, apply_datetime
          into audt_flag, applytime
          from t#st_results_non_rtn;
        --»Áπ˚Œ¥…Û∫ÀªÚ…Í«Î ±º‰–°”⁄7ÃÏ£¨¥¶¿Ì±Í÷æŒ™Œ¥¥¶¿Ì
        --modify by hejj 20141124 ‘ˆº”…Û∫À±Í÷æNULL÷µ≈–∂œ
        if (audt_flag is null or audt_flag <> '1' or round(to_number(sysdate - applytime)) < non_return_day) then
          update t#st_results_non_rtn
             set hdl_flag           = hdlFlagUnandle,
                 deposit_fee        = 0,
                 card_balance_fee   = 0,
                 actual_return_bala = 0,
                 penalty            = 0,
                 penalty_reason     = '0';
        end if;
        ----»Áπ˚’˝≥£µƒ∑«º¥ ±ÕÀøÓ±Ì÷–≤ª¥Ê‘⁄£¨¥”¥ÌŒÛ±Ì÷–≤È’“¬ﬂº≠ø®∫≈,‘ˆº”∑«∑®…Í«Î–≈œ¢
      else
        /**
        select card_print_id
          into cardLogicalId
          from st_err_non_rtn_app
         where line_id = lineId
           and station_id = stationId
           and dev_type_id = devicetypeId
           and device_id = deviceId
           and receipt_id = receiptId
           and to_char(apply_datetime, 'yyyymmdd') = tkTime
           and shift_id = shiftId
           and err_code in ('01', '03', '04', '06', '07', '08', '41');**/
        insert into t#st_results_non_rtn
          (card_logical_id,
           deposit_fee,
           card_balance_fee,
           actual_return_bala,
           penalty,
           penalty_reason,
           audt,
           hdl_flag)
        values
          ('', 0, 0, 0, 0, '', '', hdlFlagError);
      end if;
    end if;
  end;
  ---------------------------------ªÒ»°∆æ÷§µƒ∏˜¥¶¿Ì–≈œ¢Ω· ¯--------------------------------
  --------------------------------≤È—Ø-----------------------------------------------------
  begin
    if (i_applyaction = actionQuery) then
      --º«¬º∑µªÿ◊¥Ã¨
      insert into st_flow_non_rtn
        (water_no, id, apply_bill, apply_action, return_flag, return_time)
        select seq_st_flow_non_rtn.nextval,
               i_id,
               i_applybill,
               actionQuery,
               hdl_flag,
               sysdate
          from t#st_results_non_rtn; ----∑µªÿ¥¶¿Ì–≈œ¢
      open o_resultset for
        select card_logical_id,
               deposit_fee,
               card_balance_fee,
               actual_return_bala,
               penalty,
               penalty_reason,
               hdl_flag
          from t#st_results_non_rtn;
    end if;
  end;
  --------------------------------≤È—ØΩ· ¯-----------------------------------------------------
  -----------------------------------…Í«ÎÕÀøÓ----------------------------------------------------
  begin
    if (i_applyaction = actionApply) then
      --≈–∂œ «∑Ò¥Ê‘⁄≤¢∑¢µƒ…Í«Î: Õ¨“ª∆æ÷§¥¶¿ÌÕÀøÓ…Í«Îªπ√ª”–Ω· ¯µƒ£¨≤ª¥Ê‘⁄Õ¨“ª∆æ÷§“— ’µΩÕÀøÓÕ®÷™£¨“—∏¸–¬±Í÷æº∞Ω‚≥˝≤¢∑¢◊¥Ã¨µƒ
      --Õ¨“ª¡¨Ω”“—≤È—Øπ˝£¨≤È—Ø∑µªÿ±Í÷æŒ™3«“√ª”–≤¢∑¢,∑µªÿ±Í÷æ7‘ –ÌÕÀøÓ
      begin
        select count(*)
          into v_temp_counts
          from st_flow_non_rtn
         where apply_bill = i_applybill
           and apply_action = actionApply
           and processing = procesingDoing;
        select count(*)
          into v_temp_counts1
          from st_flow_non_rtn
         where apply_bill = i_applybill
           and return_flag = hdlFlagFinish;
        select count(*)
          into v_temp_counts2
          from st_flow_non_rtn
         where id = i_id
           and apply_bill = i_applybill
           and apply_action = actionQuery
           and return_flag = hdlFlagHandle;
        if (v_temp_counts = 0 and v_temp_counts1 = 0 and v_temp_counts2 > 0) then
          begin
            update t#st_results_non_rtn set hdl_flag = hdlFlagPermit;
          end;
        end if;
        --º«¬º∑µªÿ◊¥Ã¨º∞±Í ∂”–¡¨Ω”’˝‘⁄¥¶¿Ì(‘ˆº”µ±«∞¡¨Ω”µƒ≤¢∑¢À¯)
        insert into st_flow_non_rtn
          (water_no,
           id,
           apply_bill,
           apply_action,
           return_flag,
           return_time,
           processing)
          select seq_st_flow_non_rtn.nextval,
                 i_id,
                 i_applybill,
                 actionApply,
                 hdl_flag,
                 sysdate,
                 procesingDoing
            from t#st_results_non_rtn;
        --∑µªÿ¥¶¿Ì–≈œ¢
        open o_resultset for
          select card_logical_id,
                 deposit_fee,
                 card_balance_fee,
                 actual_return_bala,
                 penalty,
                 penalty_reason,
                 hdl_flag
            from t#st_results_non_rtn;
      end;
    end if;
  end;
  -----------------------------------------------…Í«ÎÕÀøÓΩ· ¯----------------------------------------------------
  ----------------------------------------------ÕÀøÓÕÍ≥…Õ®÷™¥¶¿Ì--------------------------------------------------
  begin
    if (i_applyaction = actionFinish) then
      begin
        insert into t#st_flag_non_rtn
          (return_flag)
          select return_flag
            from st_flow_non_rtn
           where id = i_id
             and apply_bill = i_applybill;
        select count(*)
          into v_temp_counts1
          from t#st_flag_non_rtn
         where return_flag = hdlFlagHandle;
        select count(*)
          into v_temp_counts2
          from t#st_flag_non_rtn
         where return_flag = hdlFlagPermit;
      end;
      if (v_temp_counts1 > 0 and v_temp_counts2 > 0) then
        --≈–∂œ «∑Ò◊ﬂÕÍ≤È—Ø°¢…Í«ÎÕÀøÓ¡˜≥Ã£¨◊ﬂÕÍ¡À£¨≤≈∏¸–¬∆æ÷§◊¥Ã¨
        begin
          --º«¬º∑µªÿ◊¥Ã¨:ÕÍ≥…◊¥Ã¨Œ™1“—ÕÀøÓ
          insert into st_flow_non_rtn
            (water_no,
             id,
             apply_bill,
             apply_action,
             return_flag,
             return_time)
          values
            (seq_st_flow_non_rtn.nextval,
             i_id,
             i_applybill,
             actionFinish,
             hdlFlagFinish,
             sysdate);
          --∏¸–¬∆æ÷§¥¶¿Ì±Í÷æŒ™“—ÕÍ≥…ÕÀøÓ
          update st_list_non_rtn
             set hdl_flag           = hdlFlagFinish,
                 return_line_id     = substr(i_processbom, 1, 2),
                 return_station_id  = substr(i_processbom, 3, 2),
                 return_dev_type_id = substr(i_processbom, 5, 2),
                 return_device_id   = substr(i_processbom, 7, 3)
           where line_id = lineId
             and station_id = stationId
             and dev_type_id = devicetypeId
             and device_id = deviceId
             and receipt_id = receiptId
             and to_char(apply_datetime, 'yyyymmdd') = tkTime
             and shift_id = shiftId;
        end;
      else
        begin
          --º«¬º∑µªÿ◊¥Ã¨ ◊¥Ã¨Œ™ø’÷µ£¨√ª”–∏¸–¬∆æ÷§◊¥Ã¨
          insert into st_flow_non_rtn
            (water_no,
             id,
             apply_bill,
             apply_action,
             return_flag,
             return_time)
          values
            (seq_st_flow_non_rtn.nextval,
             i_id,
             i_applybill,
             actionFinish,
             '',
             sysdate);
        end;
      end if;
      begin
        --Ω‚≥˝µ±«∞¡¨Ω”µƒ≤¢∑¢À¯
        update st_flow_non_rtn
           set processing = procesingNodoing
         where id = i_id
           and apply_bill = i_applybill
           and apply_action = actionApply;
        --∑µªÿΩ·π˚£®ŒﬁΩ·π˚∑µªÿ£©
        open o_resultset for
          select card_logical_id,
                 deposit_fee,
                 card_balance_fee,
                 actual_return_bala,
                 penalty,
                 penalty_reason,
                 hdl_flag
            from t#st_results_non_rtn;
      end;
    end if;
  end;
  ----------------------------------------------ÕÀøÓÕÍ≥…Õ®÷™¥¶¿ÌΩ· ¯--------------------------------------------------
  --execute immediate ('truncate table t#st_results_non_rtn');
  --execute immediate ('truncate table t#st_results_non_r commit;
  commit;
  -----------------------------------------------------------------------------------------------------
end up_non_return_action;
/
grant execute on ACC_ST.UP_NON_RETURN_ACTION to ACC_ST_APP;


prompt
prompt Creating procedure UP_NON_RETURN_QUERY_PENALTY
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_NON_RETURN_QUERY_PENALTY(in_logic_id  in varchar,
                                               out_penalty  out varchar)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_NON_RETURN_QUERY_PENALTY
  --π¶ƒ‹√Ë ˆ£∫≤È—Ø≥µ≥À∑—
  --¥¥Ω®’ﬂ£∫  ouyangwenling
  --¥¥Ω®»’∆⁄£∫201301010
  --Ã· æ£∫
  --¡Ÿ ±±Ì£∫t#non_return_tmp_fare_table_id    --¥Ê∑≈∆±º€±ÌID
  -------------------------------------------------------------------------------
 is
   v_name                       varchar(20);            --±Ì√˚
    v_n                           int           ;                  --–Ú∫≈
    v_i                           int          ;              --º«¬º ˝
    v_j                           int          ;              --º«¬º ˝
    v_sql                      varchar(1000)   ;       --º«¬º ˝
    v_deal_type                 char(1)      ;                      --º«¬º¿‡–Õ
    v_deal_time                 date  ;                    --º«¬º ±º‰
    v_iCount                      int   ;                                 --º«¬º ˝≈–∂œ

    v_line_id                   char(2);
    v_station_id             char(2);
    v_req_line_id             char(2);
    v_req_station_id         char(2);
    v_card_main_code            char(2);
    v_card_sub_code            char(2);

    v_reqtime                    date;
    v_penalty                     decimal(12,2)     ;         --∑£Ω

    v_farezone                    varchar(2);
    v_holiday_type            char(1);
    v_weekend                    char(1);
    v_timecode                    char(1);
    v_dayofweek                char(1);
    v_faretableid            varchar(3);
    v_fare                    decimal(8,2);

begin
  select deal_type,deal_datetime, line_id,station_id, card_main_id,card_sub_id
   into v_deal_type, v_deal_time, v_line_id, v_station_id, v_card_main_code, v_card_sub_code
     from op_non_return_tk_hist
    where  card_logical_id=in_logic_id and deal_datetime = (select max(deal_datetime)
    from op_non_return_tk_hist  where  card_logical_id=in_logic_id ) ;

    --»Áπ˚Œ™Ω¯’æº«¬º£¨«“Ωª“◊»’Œ™…Í«Î»’£¨"≥µ≥Ã∑—"Œ™Ω¯’æ≥µ’æ÷¡…Í«Î∞Ï¿Ì’æ’€ø€∫Ûµƒ∆±º€
 if(v_deal_type='2') then
 begin
         select count(*),line_id,station_id into v_iCount,v_req_line_id, v_req_station_id
         from st_list_non_rtn where card_logical_id=in_logic_id
         and hdl_flag='2'
         and to_char(v_deal_time,'yyyy-MM-dd') = to_char(apply_datetime,'yyyy-MM-dd')
         group by line_id,station_id ;


         if(v_iCount=1) then --‘⁄…Í«Î»’∆⁄ƒ⁄
         begin
             --≤È’“ ’∑—«¯∂Œ
             select  fare_zone into v_farezone
                from op_prm_fare_zone
                 where record_flag='0'
                 and b_line_id=v_line_id and b_station_id=v_station_id
                 and e_line_id=v_req_line_id and e_station_id=v_req_station_id ;

             if (v_farezone is null) then
                  v_farezone := '01' ;
                  end if;

             --≤È’“ ±º‰¥˙¬Î
             select holiday_type into v_holiday_type from op_prm_holiday_table
                 where to_char(v_deal_time,'yyyyMMdd') between start_date and end_date
                 and record_flag='0' ;

             --»Áπ˚≤ª «Ω⁄ºŸ»’£¨≈–∂œ «∑Ò÷‹ƒ©
             if(v_holiday_type is null) then
             begin
               
                 v_weekend := to_char(v_deal_time,'d') ;

                 if (v_weekend<>'1' and v_weekend<>'7') then
                 begin
                     select day_of_week into v_dayofweek
                         from op_prm_off_peak_hours
                         where record_flag='0'
                         and to_char(v_deal_time,'HH24:mi') between start_time and end_time ;

                     if (v_dayofweek is null) then
                         v_timecode := '0' ;        --π§◊˜»’
                     else
                         v_timecode := '1' ;         --∑«∑±√¶ ±º‰
                         end if;
                 end ;
                 else
                 begin
                     if(v_weekend='1') then
                         v_timecode := '3' ;        --÷‹»’
                     elsif(v_weekend='7') then
                         v_timecode := '2' ;        --÷‹¡˘
                         end if;
                  end;
                 end if;
             end;
             else
             begin
                 if(v_holiday_type = '1') then
                     v_timecode := '4'  ;        --π´π≤ºŸ∆⁄
                 elsif(v_holiday_type = '2') then
                     v_timecode := '5'  ;        --—ß–£ºŸ∆⁄
                     end if;
             end ;
             end if;

             --∏˘æ› ±º‰¥˙¬Î+∆±÷÷¿‡–Õ≤È’“∆±º€±ÌID
             select fare_table_id into v_faretableid
             from op_prm_fare_conf
             where record_flag='0'
             and card_main_id = v_card_main_code and card_sub_id=v_card_sub_code
             and time_code = v_timecode ;

             --∏˘æ› ’∑—«¯∂Œ+∆±º€±ÌID≤È’“∆±º€
             select to_number(fare)/100 into v_fare
             from op_prm_fare_table
             where record_flag='0'
             and fare_table_id=v_faretableid
             and fare_zone=v_farezone ;
       end ;
       else  --‘⁄…Í«Î»’∆⁄Õ‚
       begin
            select line_id,station_id into v_req_line_id, v_req_station_id
                from st_list_non_rtn where card_logical_id=in_logic_id
                 and hdl_flag='2'
                and apply_datetime=(select max(apply_datetime) from st_list_non_rtn 
                where card_logical_id=in_logic_id and hdl_flag='2' );

             --≤È’“ ’∑—«¯∂Œ
             select fare_zone into v_farezone
             from op_prm_fare_zone
                 where record_flag='0'
                 and b_line_id=v_line_id and b_station_id=v_station_id
                 and e_line_id=v_req_line_id and e_station_id=v_req_station_id ;

           --»°∆±º€±ÌID
      insert into t#non_return_tmp_fare_table_id
               select min(fare_table_id)
                   from op_prm_fare_conf
                   where record_flag='0'
                   and card_main_id = v_card_main_code and card_sub_id=v_card_sub_code ;

           --»°◊ÓµÕ∆±º€
           select to_number(fare)/100 into v_fare
                   from op_prm_fare_table
                   where fare_table_id in 
                   (select fare_table_id from t#non_return_tmp_fare_table_id)
                   and record_flag='0' ;
       end ;
       end if;

 end  ;
 end if;

 if(v_deal_type='6') then --»Áπ˚Œ™≥‰÷µº«¬º£¨"≥µ≥Ã∑—"∏√± ≥‰÷µΩ∂Ó
 begin
         select  deal_fee into v_fare
             from  op_non_return_tk_hist  
             where  card_logical_id=in_logic_id  
             and deal_datetime = 
             (select max(deal_datetime) 
             from op_non_return_tk_hist where  card_logical_id=in_logic_id ) ;
 end ;
 end if;

  -------------∑µªÿΩª“◊º«¬º
  if (v_fare is null) then
   -- select 0.00 as fare ;
   v_fare :='0.00' ;
  --else
   --select v_fare as fare ;
   end if;
   
   out_penalty:=v_fare ;
   return ;
   
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE(SQLCODE || '---' || SQLERRM);
    out_penalty:='0.00';
    return ;
end;
/
grant execute on ACC_ST.UP_NON_RETURN_QUERY_PENALTY to ACC_ST_APP;


prompt
prompt Creating procedure UP_OP_ACC_LCC_STATION_TOTAL
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_ACC_LCC_STATION_TOTAL(in_line_id   varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day  varchar,
                                             out_cursor     OUT SYS_REFCURSOR)
-------------------------------------------------------------------
  --π˝≥Ã√˚:UP_OP_ACC_LCC_STATION_TOTAL
  --±®±Ì√˚£∫LCC∂‘’ÀΩ·π˚»’±®-∞¥≥µ’æ
  --π¶ƒ‹√Ë ˆ£∫ACC”ÎLCC∂‘’ÀΩ·π˚(∞¥’æµ„)
  --±®±Ìƒ£∞Â£∫rpt_09_002.rpt
  --‘≠ º±Ì£∫Op_Prm_Station, ST_STS_ACC , st_his_lcc, st_sts_lcc_acc
  --¡Ÿ ±±Ì£∫T#OP_TOTAL_ACC_LCC_STATION_RES T#OP_TOTAL_ACC_LCC_STATION_NAM
  --¥¥Ω®’ﬂ£∫zzq
  --¥¥Ω®»’∆⁄£∫20160425
  ------------------------------------------------------------------
  -------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ:zzq
  --∏¸∏ƒ ±º‰£∫20160516
  --∏¸∏ƒƒ⁄»›£∫ÃÌº”ƒ©––◊‹º∆Ãıº˛π˝¬À
  ------------------------------------------------------------------
    -------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ:zzq
  --∏¸∏ƒ ±º‰£∫20160523
  --∏¸∏ƒƒ⁄»›£∫œﬂ¬∑√˚◊÷œ‘ æ
  ------------------------------------------------------------------
  -------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ:zzq
  --∏¸∏ƒ ±º‰£∫20160524
  --∏¸∏ƒƒ⁄»›£∫ACC_ST_HIS.st_his_lcc∏ƒ≥…acc_st.st_his_lcc,…æ≥˝∂‡”‡µƒÃıº˛
  ------------------------------------------------------------------

  --∏¸∏ƒ’ﬂ:mqf
  --∏¸∏ƒ ±º‰£∫20161110
  --∏¸∏ƒƒ⁄»›£∫lcc ˝æ›ACC_ST.st_his_lcc¥Ê‘⁄÷Õ¡Ù∂‘’  ˝æ›
  --LCC-ACC ≤È—ØACC_ST.st_sts_lcc_acc±Ì£¨Ãıº˛∏ƒŒ™account_date£¨lcc¥Ê‘⁄÷Õ¡Ù∂‘’  ˝æ›
  ------------------------------------------------------------------

 IS
  v_balance_day  VARCHAR(8);
  v_line_name  VARCHAR2(100) := '';
  v_count      INTEGER;
  v_i          INTEGER;
  v_j          INTEGER;
BEGIN
  V_BALANCE_DAY := substr(in_balance_day, 1, 8);
  SELECT line_name INTO V_LINE_NAME FROM  op_prm_line WHERE line_id = in_line_id AND record_flag = '0' ;

  v_i :=1;
  --ªÒ»°≥µ’æ÷–Œƒ√˚
  INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_NAM
   SELECT
            STATION_ID,
            CHINESE_NAME
       FROM ACC_ST.OP_PRM_STATION
     WHERE LINE_ID = IN_LINE_ID
       AND RECORD_FLAG = '0';
  SELECT COUNT(station_id) INTO v_count FROM ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_NAM;
  --ππΩ®≥µ’æºØ∫œ
  WHILE v_i <=v_count  LOOP
        v_j := 1;
        WHILE v_j <=3 LOOP
   INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES
    SELECT
            STATION_ID,
            STATION_NAME,
            to_char(v_j),
            NULL,
            0,
            0,
            0,
            0,
            0,
           0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
           0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0
      FROM ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_NAM;
      v_j := v_j + 1;
    end loop;
    v_i := v_i + 1;
  end loop;

--lcc ˝æ›
      INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES(
      STATION_ID,
      STATION_NAME,
      DATA_TYPE,
      data_type_name,
      BOM_SALE_SJT_NUM,
      BOM_SALE_SJT_FEE,
      TVM_SALE_SJT_NUM,
      TVM_SALE_SJT_FEE,
      BOM_SALE_NUM,
      BOM_SALE_DEPOSIT_FEE,
      BOM_CHARGE_FEE,
      TVM_CHARGE_NUM,
      TVM_CHARGE_FEE,
      RETURN_NUM,
      RETURN_FEE,
      NON_RETURN_NUM,
      NON_RET_DEPOSIT_FEE,
      NON_RET_ACTUAL_RET_BALA,
      NEGATIVE_CHARGE_NUM,
      NEGATIVE_CHARGE_FEE,
      DEAL_NUM,
      DEAL_FEE,
      UPDATE_CASH_NUM,
      UPDATE_CASH_FEE,
      UPDATE_NONCASH_NUM,
      UPDATE_NONCASH_FEE,
      ADMIN_NUM,
      ADMIN_RETURN_FEE,
      ADMIN_PENALTY_FEE)
      SELECT
               STATION_ID,
               NULL,
                '1',
                NULL,
                SUM(nvl(bom_sale_sjt_num,0)),
                SUM(nvl(bom_sale_sjt_fee,0)),
                SUM(nvl(tvm_sale_sjt_num,0)),
                SUM(nvl(tvm_sale_sjt_fee,0)),
                SUM(nvl(bom_sale_num,0)),
                SUM(nvl(bom_sale_deposit_fee,0)),
                SUM(nvl(bom_charge_fee,0)),
                SUM(nvl(tvm_charge_num,0)),
                SUM(nvl(tvm_charge_fee,0)),
                SUM(nvl(return_num,0)),
                SUM(nvl(return_fee,0)),
                SUM(nvl(non_return_num,0)),
                SUM(nvl(non_ret_deposit_fee,0)),
                SUM(nvl(non_ret_actual_ret_bala,0)),
                SUM(nvl(negative_charge_num,0)),
                SUM(nvl(negative_charge_fee,0)),
                SUM(nvl(deal_num,0)),
                SUM(nvl(deal_fee,0)),
                SUM(nvl(update_cash_num,0)),
                SUM(nvl(update_cash_fee,0)),
                SUM(nvl(update_noncash_num,0)),
                SUM(nvl(update_noncash_fee,0)),
                SUM(nvl(admin_num,0)),
                SUM(nvl(admin_return_fee,0)),
                SUM(nvl(admin_penalty_fee,0))
                FROM ACC_ST.st_his_lcc
                --WHERE  line_id = IN_LINE_ID and substr(BALANCE_WATER_NO,0,8) = V_BALANCE_DAY
				WHERE  line_id = IN_LINE_ID and substr(file_name,7,8) = V_BALANCE_DAY --20161110 mqf ¥Ê‘⁄÷Õ¡Ù∂‘’  ˝æ›
                GROUP BY STATION_ID;

--acc ˝æ›
 INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES(
      STATION_ID,
      STATION_NAME,
      DATA_TYPE,
      data_type_name,
      BOM_SALE_SJT_NUM,
      BOM_SALE_SJT_FEE,
      TVM_SALE_SJT_NUM,
      TVM_SALE_SJT_FEE,
      BOM_SALE_NUM,
      BOM_SALE_DEPOSIT_FEE,
      BOM_CHARGE_FEE,
      TVM_CHARGE_NUM,
      TVM_CHARGE_FEE,
      RETURN_NUM,
      RETURN_FEE,
      NON_RETURN_NUM,
      NON_RET_DEPOSIT_FEE,
      NON_RET_ACTUAL_RET_BALA,
      NEGATIVE_CHARGE_NUM,
      NEGATIVE_CHARGE_FEE,
      DEAL_NUM,
      DEAL_FEE,
      UPDATE_CASH_NUM,
      UPDATE_CASH_FEE,
      UPDATE_NONCASH_NUM,
      UPDATE_NONCASH_FEE,
      ADMIN_NUM,
      ADMIN_RETURN_FEE,
      ADMIN_PENALTY_FEE)
      SELECT
               STATION_ID,
               NULL,
                '2',
                NULL,
                SUM(nvl(bom_sale_sjt_num,0)),
                SUM(nvl(bom_sale_sjt_fee,0)),
                SUM(nvl(tvm_sale_sjt_num,0)),
                SUM(nvl(tvm_sale_sjt_fee,0)),
                SUM(nvl(bom_sale_num,0)),
                SUM(nvl(bom_sale_deposit_fee,0)),
                SUM(nvl(bom_charge_fee,0)),
                SUM(nvl(tvm_charge_num,0)),
                SUM(nvl(tvm_charge_fee,0)),
                SUM(nvl(return_num,0)),
                SUM(nvl(return_fee,0)),
                SUM(nvl(non_return_num,0)),
                SUM(nvl(non_ret_deposit_fee,0)),
                SUM(nvl(non_ret_actual_ret_bala,0)),
                SUM(nvl(negative_charge_num,0)),
                SUM(nvl(negative_charge_fee,0)),
                SUM(nvl(deal_num,0)),
                SUM(nvl(deal_fee,0)),
                SUM(nvl(update_cash_num,0)),
                SUM(nvl(update_cash_fee,0)),
                SUM(nvl(update_noncash_num,0)),
                SUM(nvl(update_noncash_fee,0)),
                SUM(nvl(admin_num,0)),
                SUM(nvl(admin_return_fee,0)),
                SUM(nvl(admin_penalty_fee,0))
                FROM ACC_ST.ST_STS_ACC
                WHERE  line_id = IN_LINE_ID and substr(BALANCE_WATER_NO,0,8) = V_BALANCE_DAY
                GROUP BY STATION_ID;
 --LCC-ACC

 INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES(
      STATION_ID,
      STATION_NAME,
      DATA_TYPE,
      DATA_TYPE_NAME,
      BOM_SALE_SJT_NUM,
      BOM_SALE_SJT_FEE,
      TVM_SALE_SJT_NUM,
      TVM_SALE_SJT_FEE,
      BOM_SALE_NUM,
      BOM_SALE_DEPOSIT_FEE,
      BOM_CHARGE_FEE,
      TVM_CHARGE_NUM,
      TVM_CHARGE_FEE,
      RETURN_NUM,
      RETURN_FEE,
      NON_RETURN_NUM,
      NON_RET_DEPOSIT_FEE,
      NON_RET_ACTUAL_RET_BALA,
      NEGATIVE_CHARGE_NUM,
      NEGATIVE_CHARGE_FEE,
      DEAL_NUM,
      DEAL_FEE,
      UPDATE_CASH_NUM,
      UPDATE_CASH_FEE,
      UPDATE_NONCASH_NUM,
      UPDATE_NONCASH_FEE,
      ADMIN_NUM,
      ADMIN_RETURN_FEE,
      ADMIN_PENALTY_FEE)
      SELECT
               STATION_ID,
               NULL,
                '3',
                NULL,
                SUM(nvl(diff_bom_sale_sjt_num,0)),
                SUM(nvl(diff_bom_sale_sjt_fee,0)),
                SUM(nvl(diff_tvm_sale_sjt_num,0)),
                SUM(nvl(diff_tvm_sale_sjt_fee,0)),
                SUM(nvl(diff_bom_sale_num,0)),
                SUM(nvl(diff_bom_sale_deposit_fee,0)),
                SUM(nvl(diff_bom_charge_fee,0)),
                SUM(nvl(diff_tvm_charge_num,0)),
                SUM(nvl(diff_tvm_charge_fee,0)),
                SUM(nvl(diff_return_num,0)),
                SUM(nvl(diff_return_fee,0)),
                SUM(nvl(diff_non_return_num,0)),
                SUM(nvl(diff_non_ret_deposit_fee,0)),
                SUM(nvl(diff_non_ret_actual_ret_bala,0)),
                SUM(nvl(diff_negative_charge_num,0)),
                SUM(nvl(diff_negative_charge_fee,0)),
                SUM(nvl(diff_deal_num,0)),
                SUM(nvl(diff_deal_fee,0)),
                SUM(nvl(diff_update_cash_num,0)),
                SUM(nvl(diff_update_cash_fee,0)),
                SUM(nvl(diff_update_noncash_num,0)),
                SUM(nvl(diff_update_noncash_fee,0)),
                SUM(nvl(diff_admin_num,0)),
                SUM(nvl(diff_admin_return_fee,0)),
                SUM(nvl(diff_admin_penalty_fee,0))
                FROM ACC_ST.st_sts_lcc_acc
                --WHERE  line_id = IN_LINE_ID AND substr(BALANCE_WATER_NO,0,8) = V_BALANCE_DAY
				WHERE  line_id = IN_LINE_ID AND account_date = V_BALANCE_DAY--20161110 mqf ∏ƒŒ™account_date£¨¥Ê‘⁄÷Õ¡Ù∂‘’  ˝æ›
                GROUP BY STATION_ID;

 --ƒ©––◊‹º∆
 --lcc
  INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES(
      STATION_ID,
      STATION_NAME,
      DATA_TYPE,
      DATA_TYPE_NAME,
      BOM_SALE_SJT_NUM,
      BOM_SALE_SJT_FEE,
      TVM_SALE_SJT_NUM,
      TVM_SALE_SJT_FEE,
      BOM_SALE_NUM,
      BOM_SALE_DEPOSIT_FEE,
      BOM_CHARGE_FEE,
      TVM_CHARGE_NUM,
      TVM_CHARGE_FEE,
      RETURN_NUM,
      RETURN_FEE,
      NON_RETURN_NUM,
      NON_RET_DEPOSIT_FEE,
      NON_RET_ACTUAL_RET_BALA,
      NEGATIVE_CHARGE_NUM,
      NEGATIVE_CHARGE_FEE,
      DEAL_NUM,
      DEAL_FEE,
      UPDATE_CASH_NUM,
      UPDATE_CASH_FEE,
      UPDATE_NONCASH_NUM,
      UPDATE_NONCASH_FEE,
      ADMIN_NUM,
      ADMIN_RETURN_FEE,
      ADMIN_PENALTY_FEE)
      SELECT
               '99',
               '◊‹º∆',
                '1',
                NULL,
                SUM(nvl(bom_sale_sjt_num,0)),
                SUM(nvl(bom_sale_sjt_fee,0)),
                SUM(nvl(tvm_sale_sjt_num,0)),
                SUM(nvl(tvm_sale_sjt_fee,0)),
                SUM(nvl(bom_sale_num,0)),
                SUM(nvl(bom_sale_deposit_fee,0)),
                SUM(nvl(bom_charge_fee,0)),
                SUM(nvl(tvm_charge_num,0)),
                SUM(nvl(tvm_charge_fee,0)),
                SUM(nvl(return_num,0)),
                SUM(nvl(return_fee,0)),
                SUM(nvl(non_return_num,0)),
                SUM(nvl(non_ret_deposit_fee,0)),
                SUM(nvl(non_ret_actual_ret_bala,0)),
                SUM(nvl(negative_charge_num,0)),
                SUM(nvl(negative_charge_fee,0)),
                SUM(nvl(deal_num,0)),
                SUM(nvl(deal_fee,0)),
                SUM(nvl(update_cash_num,0)),
                SUM(nvl(update_cash_fee,0)),
                SUM(nvl(update_noncash_num,0)),
                SUM(nvl(update_noncash_fee,0)),
                SUM(nvl(admin_num,0)),
                SUM(nvl(admin_return_fee,0)),
                SUM(nvl(admin_penalty_fee,0))
                FROM ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES a
                --add by zzq
                WHERE a.data_type = '1'
                GROUP BY STATION_ID;
 --acc
  INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES(
      STATION_ID,
      STATION_NAME,
      DATA_TYPE,
      DATA_TYPE_NAME,
      BOM_SALE_SJT_NUM,
      BOM_SALE_SJT_FEE,
      TVM_SALE_SJT_NUM,
      TVM_SALE_SJT_FEE,
      BOM_SALE_NUM,
      BOM_SALE_DEPOSIT_FEE,
      BOM_CHARGE_FEE,
      TVM_CHARGE_NUM,
      TVM_CHARGE_FEE,
      RETURN_NUM,
      RETURN_FEE,
      NON_RETURN_NUM,
      NON_RET_DEPOSIT_FEE,
      NON_RET_ACTUAL_RET_BALA,
      NEGATIVE_CHARGE_NUM,
      NEGATIVE_CHARGE_FEE,
      DEAL_NUM,
      DEAL_FEE,
      UPDATE_CASH_NUM,
      UPDATE_CASH_FEE,
      UPDATE_NONCASH_NUM,
      UPDATE_NONCASH_FEE,
      ADMIN_NUM,
      ADMIN_RETURN_FEE,
      ADMIN_PENALTY_FEE)
      SELECT
               '99',
               '◊‹º∆',
                '2',
                NULL,
                 SUM(nvl(bom_sale_sjt_num,0)),
                SUM(nvl(bom_sale_sjt_fee,0)),
                SUM(nvl(tvm_sale_sjt_num,0)),
                SUM(nvl(tvm_sale_sjt_fee,0)),
                SUM(nvl(bom_sale_num,0)),
                SUM(nvl(bom_sale_deposit_fee,0)),
                SUM(nvl(bom_charge_fee,0)),
                SUM(nvl(tvm_charge_num,0)),
                SUM(nvl(tvm_charge_fee,0)),
                SUM(nvl(return_num,0)),
                SUM(nvl(return_fee,0)),
                SUM(nvl(non_return_num,0)),
                SUM(nvl(non_ret_deposit_fee,0)),
                SUM(nvl(non_ret_actual_ret_bala,0)),
                SUM(nvl(negative_charge_num,0)),
                SUM(nvl(negative_charge_fee,0)),
                SUM(nvl(deal_num,0)),
                SUM(nvl(deal_fee,0)),
                SUM(nvl(update_cash_num,0)),
                SUM(nvl(update_cash_fee,0)),
                SUM(nvl(update_noncash_num,0)),
                SUM(nvl(update_noncash_fee,0)),
                SUM(nvl(admin_num,0)),
                SUM(nvl(admin_return_fee,0)),
                SUM(nvl(admin_penalty_fee,0))
                FROM ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES a
                --add by zzq
               WHERE a.data_type = '2'
                GROUP BY STATION_ID;
 --lcc-acc
 INSERT INTO ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES(
      STATION_ID,
      STATION_NAME,
      DATA_TYPE,
      DATA_TYPE_NAME,
      BOM_SALE_SJT_NUM,
      BOM_SALE_SJT_FEE,
      TVM_SALE_SJT_NUM,
      TVM_SALE_SJT_FEE,
      BOM_SALE_NUM,
      BOM_SALE_DEPOSIT_FEE,
      BOM_CHARGE_FEE,
      TVM_CHARGE_NUM,
      TVM_CHARGE_FEE,
      RETURN_NUM,
      RETURN_FEE,
      NON_RETURN_NUM,
      NON_RET_DEPOSIT_FEE,
      NON_RET_ACTUAL_RET_BALA,
      NEGATIVE_CHARGE_NUM,
      NEGATIVE_CHARGE_FEE,
      DEAL_NUM,
      DEAL_FEE,
      UPDATE_CASH_NUM,
      UPDATE_CASH_FEE,
      UPDATE_NONCASH_NUM,
      UPDATE_NONCASH_FEE,
      ADMIN_NUM,
      ADMIN_RETURN_FEE,
      ADMIN_PENALTY_FEE)
      SELECT
               '99',
               '◊‹º∆',
                '3',
                NULL,
                 SUM(nvl(bom_sale_sjt_num,0)),
                SUM(nvl(bom_sale_sjt_fee,0)),
                SUM(nvl(tvm_sale_sjt_num,0)),
                SUM(nvl(tvm_sale_sjt_fee,0)),
                SUM(nvl(bom_sale_num,0)),
                SUM(nvl(bom_sale_deposit_fee,0)),
                SUM(nvl(bom_charge_fee,0)),
                SUM(nvl(tvm_charge_num,0)),
                SUM(nvl(tvm_charge_fee,0)),
                SUM(nvl(return_num,0)),
                SUM(nvl(return_fee,0)),
                SUM(nvl(non_return_num,0)),
                SUM(nvl(non_ret_deposit_fee,0)),
                SUM(nvl(non_ret_actual_ret_bala,0)),
                SUM(nvl(negative_charge_num,0)),
                SUM(nvl(negative_charge_fee,0)),
                SUM(nvl(deal_num,0)),
                SUM(nvl(deal_fee,0)),
                SUM(nvl(update_cash_num,0)),
                SUM(nvl(update_cash_fee,0)),
                SUM(nvl(update_noncash_num,0)),
                SUM(nvl(update_noncash_fee,0)),
                SUM(nvl(admin_num,0)),
                SUM(nvl(admin_return_fee,0)),
                SUM(nvl(admin_penalty_fee,0))
                FROM ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES a
                --add by zzq
               WHERE a.data_type = '3'
                GROUP BY STATION_ID;
 --∏¸–¬data_type_name
  update acc_st.T#OP_TOTAL_ACC_LCC_STATION_RES
     set data_type_name= (case when data_type='1'then 'LCC'
                            when data_type='2'then 'ACC'
                            when data_type='3'then 'LCC-ACC'
                          end);
 --∏¸–¬station_nam
 UPDATE acc_st.t#op_total_acc_lcc_station_res a
       SET station_name = (SELECT station_name FROM T#OP_TOTAL_ACC_LCC_STATION_NAM b WHERE a.station_id=b.station_id)
        WHERE EXISTS(SELECT station_name FROM T#OP_TOTAL_ACC_LCC_STATION_NAM b WHERE a.station_id=b.station_id);

  ---∑µªÿΩ·π˚ºØ
  OPEN OUT_CURSOR FOR
    SELECT V_BALANCE_DAY BALANCEDAY,
           V_LINE_NAME  LINENAME,
           STATION_ID ,
           STATION_NAME ,
           data_type,
           data_type_name,
           sum(bom_sale_sjt_num) AS bom_sale_sjt_num,
           sum(bom_sale_sjt_fee) AS bom_sale_sjt_fee,
           sum(tvm_sale_sjt_num) AS tvm_sale_sjt_num,
           sum(tvm_sale_sjt_fee) AS tvm_sale_sjt_fee,
           sum(bom_sale_num)     AS bom_sale_num,
           sum(bom_sale_deposit_fee)  AS bom_sale_deposit_fee,
           sum(bom_charge_fee) AS bom_charge_fee,
           sum(tvm_charge_num) AS tvm_charge_num,
           sum(tvm_charge_fee) as tvm_charge_fee,
           sum(return_num) AS return_num,
           sum(return_fee) AS return_fee,
           sum(non_return_num) AS non_return_num,
           sum(non_ret_deposit_fee) AS non_ret_deposit_fee,
           sum(non_ret_actual_ret_bala) AS non_ret_actual_ret_bala,
           sum(negative_charge_num) AS negative_charge_num,
           sum(negative_charge_fee) AS negative_charge_fee,
           sum(deal_num) AS deal_num,
           sum(deal_fee) AS deal_fee,
           sum(update_cash_num) AS update_cash_num,
           sum(update_cash_fee) AS update_cash_fee,
           sum(update_noncash_num) AS update_noncash_num,
           sum(update_noncash_fee) AS update_noncash_fee,
           sum(admin_num) AS admin_num,
           sum(admin_return_fee) AS admin_return_fee,
           sum(admin_penalty_fee) AS admin_penalty_fee
      FROM ACC_ST.T#OP_TOTAL_ACC_LCC_STATION_RES
      GROUP BY STATION_ID,STATION_NAME,data_type,data_type_name
      ORDER BY STATION_ID,STATION_NAME,data_type,data_type_name;
END UP_OP_ACC_LCC_STATION_TOTAL;
/
grant execute on ACC_ST.UP_OP_ACC_LCC_STATION_TOTAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_ACC_LCC_TOTAL
prompt ======================================
prompt
create or replace procedure acc_st.UP_OP_ACC_LCC_TOTAL(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-------------------------------------------------------------------
--π˝≥Ã√˚:UP_OP_ACC_LCC_TOTAL
--±®±Ì√˚£∫LCC∂‘’ÀΩ·π˚»’±®--œﬂÕ¯◊‹º∆
--π¶ƒ‹√Ë ˆ£∫ACC”ÎLCC∂‘’ÀΩ·π˚(À˘”–’æµ„)
--±®±Ìƒ£∞Â£∫rpt_09_001
--÷–º‰±Ì£∫st_his_lcc,st_sts_acc
------------------------------------------------------------------
--–ﬁ∏ƒ ±º‰£∫20140804
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫∏¸∏ƒ ˝æ›‘¥£∫st_sts_lcc_acc
------------------------------------------------------------------
--–ﬁ∏ƒ ±º‰£∫20150410
--–ﬁ∏ƒ»À£∫wangkejia
--÷–º‰±Ì±ÌΩ·ππ–ﬁ∏ƒ£∫st_sts_lcc_acc‘ˆº”∂‘’À»’∆⁄◊÷∂Œaccout_date£¨∂‘’ÀΩ·π˚“‘accout_dateŒ™“¿æ›
--–ﬁ∏ƒƒ⁄»›£∫∂‘’À»’∆⁄∞¥“‘accout_dateŒ™“¿æ›°£
------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160317  by lindaquan

AS
V_balanceday varchar(8);
V_squadday varchar(8);
v_no_balance varchar(8);
v_line_name varchar2(100) := '';
BEGIN
 v_balanceday:=substr(in_balance_day,1,8);
 v_squadday:=substr(in_squad_day,1,8);
 v_no_balance:=substr(v_balanceday,1,6)||'01';
 
 select b.line_name into v_line_name from op_prm_line b where b.line_id=in_line_id and b.record_flag='0';

 if substr(v_balanceday,7,2)='01' then
--20150410
INSERT INTO T#OP_TOTAL_RESULT_ACC
    SELECT  a.account_date,
        diff_bom_sale_sjt_num,
        diff_bom_sale_sjt_fee,
        diff_tvm_sale_sjt_num,
        diff_tvm_sale_sjt_fee,
        diff_bom_sale_num,
        diff_bom_sale_deposit_fee,
        diff_bom_charge_fee,
        diff_tvm_charge_num,
        diff_tvm_charge_fee,
        diff_return_num,
        diff_return_fee,
        diff_non_return_num,
        diff_non_ret_deposit_fee,
        diff_non_ret_actual_ret_bala,
        diff_negative_charge_num,
        diff_negative_charge_fee,
        diff_deal_num,
        diff_deal_fee,
        diff_update_cash_num,
        diff_update_cash_fee,
        diff_update_noncash_num,
        diff_update_noncash_fee,
        diff_admin_num,
        diff_admin_return_fee,
        diff_admin_penalty_fee
 from st_sts_lcc_acc a
 WHERE a.account_date=to_char(last_day(add_months(to_date(v_balanceday,'yyyymmdd'),-1)),'yyyymmdd')
 and line_id=in_line_id;
end if;

while to_number(v_no_balance)<=to_number(V_balanceday)
loop
 --20150410
 INSERT INTO T#OP_TOTAL_RESULT_ACC
 SELECT a.account_date,
        diff_bom_sale_sjt_num,
        diff_bom_sale_sjt_fee,
        diff_tvm_sale_sjt_num,
        diff_tvm_sale_sjt_fee,
        diff_bom_sale_num,
        diff_bom_sale_deposit_fee,
        diff_bom_charge_fee,
        diff_tvm_charge_num,
        diff_tvm_charge_fee,
        diff_return_num,
        diff_return_fee,
        diff_non_return_num,
        diff_non_ret_deposit_fee,
        diff_non_ret_actual_ret_bala,
        diff_negative_charge_num,
        diff_negative_charge_fee,
        diff_deal_num,
        diff_deal_fee,
        diff_update_cash_num,
        diff_update_cash_fee,
        diff_update_noncash_num,
        diff_update_noncash_fee,
        diff_admin_num,
        diff_admin_return_fee,
        diff_admin_penalty_fee
 from st_sts_lcc_acc a
 WHERE a.account_date=v_no_balance and line_id=in_line_id;
 v_no_balance:=to_char(to_number(v_no_balance)+1);
end loop;


----ƒ©––◊‹º∆
INSERT INTO T#OP_TOTAL_RESULT_ACC
select
    '◊‹º∆',
    sum(BOM_SALE_SJT_NUM) BOM_SALE_SJT_NUM,
    sum(BOM_SALE_SJT_FEE) BOM_SALE_SJT_FEE,
    sum(TVM_SALE_SJT_NUM) TVM_SALE_SJT_NUM,
    sum(TVM_SALE_SJT_FEE) TVM_SALE_SJT_FEE,
    sum(BOM_SALE_NUM) BOM_SALE_NUM,
    sum(BOM_SALE_DEPOSIT_FEE) BOM_SALE_DEPOSIT_FEE,
    sum(BOM_CHARGE_FEE) BOM_CHARGE_FEE,
    sum(TVM_CHARGE_NUM) TVM_CHARGE_NUM,
    sum(TVM_CHARGE_FEE) TVM_CHARGE_FEE,
    sum(RETURN_NUM) RETURN_NUM,
    sum(RETURN_FEE) RETURN_FEE,
    sum(NON_RETURN_NUM) NON_RETURN_NUM,
    sum(NON_RET_DEPOSIT_FEE) NON_RET_DEPOSIT_FEE,
    sum(NON_RET_ACTUAL_RET_BALA) NON_RET_ACTUAL_RET_BALA,
    sum(NEGATIVE_CHARGE_NUM) NEGATIVE_CHARGE_NUM,
    sum(NEGATIVE_CHARGE_FEE) NEGATIVE_CHARGE_FEE,
    sum(DEAL_NUM) DEAL_NUM,
    sum(DEAL_FEE) DEAL_FEE,
    sum(UPDATE_CASH_NUM) UPDATE_CASH_NUM,
    sum(UPDATE_CASH_FEE) UPDATE_CASH_FEE,
    sum(UPDATE_NONCASH_NUM) UPDATE_NONCASH_NUM,
    sum(UPDATE_NONCASH_FEE) UPDATE_NONCASH_FEE,
    sum(ADMIN_NUM) ADMIN_NUM,
    sum(ADMIN_RETURN_FEE) ADMIN_RETURN_FEE,
    sum(ADMIN_PENALTY_FEE) ADMIN_PENALTY_FEE
from T#OP_TOTAL_RESULT_ACC;
----∑µªÿΩ·π˚ºØ
 OPEN out_cursor for
 select 
    v_line_name line_name,
    V_balanceday day,
    type,
    sum(BOM_SALE_SJT_NUM) BOM_SALE_SJT_NUM,
    sum(BOM_SALE_SJT_FEE) BOM_SALE_SJT_FEE,
    sum(TVM_SALE_SJT_NUM) TVM_SALE_SJT_NUM,
    sum(TVM_SALE_SJT_FEE) TVM_SALE_SJT_FEE,
    sum(BOM_SALE_NUM) BOM_SALE_NUM,
    sum(BOM_SALE_DEPOSIT_FEE) BOM_SALE_DEPOSIT_FEE,
    sum(BOM_CHARGE_FEE) BOM_CHARGE_FEE,
    sum(TVM_CHARGE_NUM) TVM_CHARGE_NUM,
    sum(TVM_CHARGE_FEE) TVM_CHARGE_FEE,
    sum(RETURN_NUM) RETURN_NUM,
    sum(RETURN_FEE) RETURN_FEE,
    sum(NON_RETURN_NUM) NON_RETURN_NUM,
    sum(NON_RET_DEPOSIT_FEE) NON_RET_DEPOSIT_FEE,
    sum(NON_RET_ACTUAL_RET_BALA) NON_RET_ACTUAL_RET_BALA,
    sum(NEGATIVE_CHARGE_NUM) NEGATIVE_CHARGE_NUM,
    sum(NEGATIVE_CHARGE_FEE) NEGATIVE_CHARGE_FEE,
    sum(DEAL_NUM) DEAL_NUM,
    sum(DEAL_FEE) DEAL_FEE,
    sum(UPDATE_CASH_NUM) UPDATE_CASH_NUM,
    sum(UPDATE_CASH_FEE) UPDATE_CASH_FEE,
    sum(UPDATE_NONCASH_NUM) UPDATE_NONCASH_NUM,
    sum(UPDATE_NONCASH_FEE) UPDATE_NONCASH_FEE,
    sum(ADMIN_NUM) ADMIN_NUM,
    sum(ADMIN_RETURN_FEE) ADMIN_RETURN_FEE,
    sum(ADMIN_PENALTY_FEE) ADMIN_PENALTY_FEE
from T#OP_TOTAL_RESULT_ACC
group by type
order by type;

end;
/
grant execute on ACC_ST.UP_OP_ACC_LCC_TOTAL to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_ACC_LCC_TOTAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_DEV_AGM_DAY
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_DEV_AGM_DAY(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_DEV_AGM_DAY
--ƒ£øÈ£∫ºƒ¥Ê∆˜Õ≥º∆±®±Ì
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑AGMºƒ¥Ê∆˜ ˝æ›»’±®±Ì
-- ‰»Î≤Œ ˝:
--ƒ£øÈÕ®”√¡Ÿ ±±Ì£∫t#OP_DEV_AGM_rpt
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130806
--–ﬁ∏ƒ»’∆⁄£∫
--ƒ£∞Â±‡∫≈£∫rpt_08_003
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140707
--–ﬁ∏ƒƒ⁄»›£∫
  --1>–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ
  --2>–¬Ω®ºƒ¥Ê∆˜ ˝æ›±Ìop_cod_dev_reg£¨≤¢‘ˆº”∂‘”¶ºƒ¥Ê∆˜±‡¬Î ˝æ›
  --3>–ﬁ∏ƒ∑µªÿµƒΩ·π˚ºØ
  ----------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140730
--–ﬁ∏ƒƒ⁄»›£∫
  --1>µ±»’Õ≥º∆÷µ=µ±«∞«ÂÀ„»’µƒ÷µ-…œ“ª∏ˆ«ÂÀ„»’µƒ÷µ
    ----------------------------------------------------------------------------
      --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140828
--–ﬁ∏ƒƒ⁄»›£∫
  --1>∏ƒªÿ20140707∞Ê±æ
    ----------------------------------------------------------------------------
     --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒ»’∆⁄:20160629
--–ﬁ∏ƒƒ⁄»›£∫
  --1> ˝æ›≤ª¥Ê‘⁄ ±∫Ú£¨∑µªÿ“ª’≈ø’±Ì
    ----------------------------------------------------------------------------    ----------------------------------------------------------------------------
     --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒ»’∆⁄:20160826
--–ﬁ∏ƒƒ⁄»›£∫
  --1>deal_valueŒ™ø’ ±∑µªÿnull
    ----------------------------------------------------------------------------
AS
   v_line_id  char(2);
   v_linename VARCHAR2(20);
   v_squadday varchar2(8);
   v_balanceday varchar2(8);
   v_balanceday_last varchar2(8);
   v_squadday_last varchar2(8);
   v_sqlcount number(8);
BEGIN
   v_line_id:=in_line_id;
   v_squadday:=substr(in_squad_day,1,8);
   v_balanceday:=substr(in_balance_day,1,8);
   v_sqlcount :=0;
   IF v_line_id is not NULL and v_line_id!=' ' THEN
      SELECT LINE_NAME
      INTO V_LINENAME
      FROM op_prm_line
      WHERE LINE_ID = v_line_id and record_flag='0';
   END IF;
   ----ªÒ»°÷–º‰±Ì ˝æ›¿Ô…œ“ª«ÂÀ„¡˜ÀÆ÷µ----------------------------
--20140730∏¸∏ƒ£∫
/*
    select max(substr(balance_water_no,1,8)) into v_balanceday_last from st_sts_reg_gate
            where substr(balance_water_no,1,8)<v_balanceday;
   select max(substr(squad_day,1,8)) into v_squadday_last from st_sts_reg_gate
            where substr(balance_water_no,1,8)=v_balanceday_last;*/
   /*--ππΩ®Ω·π˚ºØΩ·ππ
    INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      '',
      '04',--¥˙¬Î±ÌAGM «'04'
      b.reg_code,
      b.reg_code,
      0
   FROM op_prm_station a,op_cod_dev_reg b
   where b.dev_type_id='04'
   and a.line_id=v_line_id and a.record_flag='0'
   group by a.line_id,a.station_id,b.reg_code;
   */
   ----µ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒ ˝÷µ----------------
 INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      '04',--¥˙¬Î±ÌAGM «'04'
      a.data_code,
      a.data_code,
      sum(a.deal_value)
   FROM st_sts_reg_gate a
   where a.dev_type_id in ('04','05','06')--÷–º‰±Ì»˝∏ˆ±‡¬Î∂‘”¶∂º «AGMºƒ¥Ê∆˜
   and a.line_id=v_line_id
   and substr(a.squad_day,1,8)=v_squadday
   and substr(a.balance_water_no,1,8)=v_balanceday
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;
   /*----ºı»•…œ“ªÃÏ«ÂÀ„¡˜ÀÆ∫≈µƒ ˝÷µ---------------
   --20140730∏¸∏ƒ£∫
 INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      '04',--¥˙¬Î±ÌAGM «'04'
      a.data_code,
      a.data_code,
      sum(a.deal_value)*(-1)
   FROM st_sts_reg_gate a
   where a.dev_type_id in ('04','05','06')--÷–º‰±Ì»˝∏ˆ±‡¬Î∂‘”¶∂º «AGMºƒ¥Ê∆˜
   and a.line_id=v_line_id
   and substr(a.squad_day,1,8)=v_squadday_last
   and substr(a.balance_water_no,1,8)=v_balanceday_last
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;*/
 ---------------------------------------------------------------------------------------
      ----∫œº∆
INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      '99',
      '∫œº∆',
      a.squad_day,
      a.dev_type_id,
      '',
      '',
      sum(a.deal_value)
   FROM t#OP_DEV_AGM_rpt A
   group by a.line_id,a.squad_day,a.dev_type_id;
   ----∏¸–¬’æµ„√˚
   update t#OP_DEV_AGM_rpt a set a.station_name=(
          select b.sequence||b.chinese_name from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id)
   where exists (select 1 from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id);
   ----∏¸–¬ºƒ¥Ê∆˜√˚
   update t#OP_DEV_AGM_rpt a set a.reg_desc=(
          select b.reg_desc from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='04')
   where exists (select 1 from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='04');

----∑µªÿΩ·π˚ºØ
SELECT COUNT(*) INTO v_sqlcount FROM t#OP_DEV_AGM_rpt;
IF v_sqlcount>0 THEN
OPEN out_cursor FOR
   SELECT  v_squadday||v_balanceday day,v_linename linename,
           station_name stationname,reg_code,reg_desc,sum(deal_value) deal_value
      FROM t#OP_DEV_AGM_rpt
   group by station_name,reg_code,reg_desc
   order by station_name,reg_code,reg_desc;
ELSE
  OPEN out_cursor FOR
  SELECT  v_squadday||v_balanceday day,
          v_linename linename,
          ' ' stationname,
          ' ' reg_code,
          ' ' reg_desc,
        --' 'deal_value  modify by ldz
          null deal_value
     FROM dual;


         END IF;
         END;
/
grant execute on ACC_ST.UP_OP_DEV_AGM_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_DEV_AGM_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_DEV_AGM_MON
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_DEV_AGM_MON(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_DEV_AGM_MON
--ƒ£øÈ£∫ºƒ¥Ê∆˜Õ≥º∆±®±Ì
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑AGMºƒ¥Ê∆˜ ˝æ›‘¬±®±Ì
-- ‰»Î≤Œ ˝:
--ƒ£øÈÕ®”√¡Ÿ ±±Ì£∫t#OP_DEV_AGM_rpt
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130806
--–ﬁ∏ƒ»’∆⁄£∫
--ƒ£∞Â±‡∫≈£∫rpt_08_004
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140707
--–ﬁ∏ƒƒ⁄»›£∫
  --1>–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ
  --2>–¬Ω®ºƒ¥Ê∆˜ ˝æ›±Ìop_cod_dev_reg£¨≤¢‘ˆº”∂‘”¶ºƒ¥Ê∆˜±‡¬Î ˝æ›
  --3>–ﬁ∏ƒ∑µªÿµƒΩ·π˚ºØ
  ----------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140730
--–ﬁ∏ƒƒ⁄»›£∫
  --1>µ±‘¬Õ≥º∆÷µ=µ±«∞«ÂÀ„‘¬µƒ÷µ-…œ“ª∏ˆ«ÂÀ„‘¬µƒ÷µ
----------------------------------------------------------------------------
      --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140828
--–ﬁ∏ƒƒ⁄»›£∫
  --1>∏ƒªÿ20140707∞Ê±æ
    ----------------------------------------------------------------------------
     --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒ»’∆⁄:20160629
--–ﬁ∏ƒƒ⁄»›£∫
  --1> ˝æ›≤ª¥Ê‘⁄ ±∫Ú£¨∑µªÿ“ª’≈ø’±Ì
    ----------------------------------------------------------------------------
         --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒ»’∆⁄:20160826
--–ﬁ∏ƒƒ⁄»›£∫
  --1>deal_valueŒ™ø’ ±∑µªÿnull
    ----------------------------------------------------------------------------
AS
   v_line_id  char(2);
   v_linename VARCHAR2(20);
   v_squadday varchar2(6);
   v_balanceday varchar2(6);
   v_balanceday_last varchar2(8);
   v_squadday_last varchar2(8);
   v_sqlcount number(8);
      -----st_sts_reg_tvm÷–º‰±Ì ˝æ› ±√ø»’¿€º”µƒ
BEGIN
   v_line_id:=substr(in_line_id,1,2);
   v_squadday:=substr(in_squad_day,1,6);
   v_balanceday:=substr(in_balance_day,1,6);
   v_sqlcount :=0;
/*
   --v_squadday:=to_char(last_day(to_date(substr(in_squad_day,1,6),'yyyymm')),'yyyymmdd');
   --v_balanceday:=to_char(last_day(to_date(substr(in_balance_day,1,6),'yyyymm')),'yyyymmdd');
--µ±‘¬◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
select max(substr(balance_water_no,1,8)) into v_balanceday from st_sts_reg_tvm a
   where substr(balance_water_no,1,6)=v_balanceday;
--µ±‘¬◊Ó¥Û‘À”™»’
select max(substr(squad_day,1,8)) into v_squadday from st_sts_reg_tvm a
   where substr(balance_water_no,1,8)=v_balanceday;
--…œ‘¬◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
select max(substr(balance_water_no,1,8)) into v_balanceday_last from st_sts_reg_tvm a
   where substr(balance_water_no,1,6)=to_char(add_months(to_date(substr(v_balanceday,1,6),'yyyymm'),-1),'yyyymm');
--…œ‘¬◊Ó¥Û‘À”™»’
select max(substr(squad_day,1,8)) into v_squadday_last from st_sts_reg_tvm a
   where balance_water_no=v_balanceday_last;
*/

   IF v_line_id is not NULL and v_line_id!=' ' THEN
      SELECT LINE_NAME
      INTO V_LINENAME
      FROM op_prm_line
      WHERE LINE_ID = v_line_id and record_flag='0';
   END IF;
      /*--ππΩ®Ω·π˚ºØΩ·ππ
    INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      '',
      '04',--¥˙¬Î±ÌAGM «'04'
      b.reg_code,
      b.reg_code,
      0
   FROM op_prm_station a,op_cod_dev_reg b
   where b.dev_type_id='04'
   and a.line_id=v_line_id and a.record_flag='0'
   group by a.line_id,a.station_id,b.reg_code;*/

 INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      '04',--¥˙¬Î±ÌAGM «'04'
      a.data_code,
      a.data_code,
      sum(a.deal_value)
   FROM st_sts_reg_gate a
   where a.dev_type_id in ('04','05','06')--÷–º‰±Ì»˝∏ˆ±‡¬Î∂‘”¶∂º «AGMºƒ¥Ê∆˜
   and a.line_id=v_line_id
   and substr(a.squad_day,1,6)=v_squadday
   and substr(a.balance_water_no,1,6)=v_balanceday
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;
   /*
   INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      '04',--¥˙¬Î±ÌAGM «'04'
      a.data_code,
      a.data_code,
      sum(a.deal_value)*(-1)
   FROM st_sts_reg_gate a
   where a.dev_type_id in ('04','05','06')--÷–º‰±Ì»˝∏ˆ±‡¬Î∂‘”¶∂º «AGMºƒ¥Ê∆˜
   and a.line_id=v_line_id
   and substr(a.squad_day,1,6)=v_squadday_last
   and substr(a.balance_water_no,1,6)=v_balanceday_last
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;*/
      ----∫œº∆
INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      '99',
      '∫œº∆',
      a.squad_day,
      a.dev_type_id,
      '',
      '',
      sum(a.deal_value)
   FROM t#OP_DEV_AGM_rpt A
   group by a.line_id,a.squad_day,a.dev_type_id;
   ----∏¸–¬’æµ„√˚
   update t#OP_DEV_AGM_rpt a set a.station_name=(
          select b.sequence||b.chinese_name from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id)
   where exists (select 1 from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id);
   ----∏¸–¬ºƒ¥Ê∆˜√˚
   update t#OP_DEV_AGM_rpt a set a.reg_desc=(
          select b.reg_desc from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='04')
   where exists (select 1 from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='04');

----∑µªÿΩ·π˚ºØ
SELECT COUNT(*) INTO v_sqlcount FROM t#OP_DEV_AGM_rpt;
IF v_sqlcount >0 THEN
OPEN out_cursor FOR
   SELECT  v_squadday||v_balanceday day,v_linename linename,
           station_name stationname,reg_code,reg_desc,sum(deal_value) deal_value
      FROM t#OP_DEV_AGM_rpt
   group by station_name,reg_code,reg_desc
   order by station_name,reg_code,reg_desc;
   ELSE----  2016.06.29 add by liudezeng  ∑µªÿø’ ˝æ›
     OPEN out_cursor FOR
     SELECT v_squadday||v_balanceday day,
            v_linename linename,
            ' ' stationname,
            ' ' reg_code,
            ' ' reg_desc,
            --' ' deal_value modify by ldz
            null deal_value
            FROM DUAL;
            END IF;

END;
/
grant execute on ACC_ST.UP_OP_DEV_AGM_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_DEV_AGM_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_DEV_CUR_QUER
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.Up_OP_DEV_CUR_QUER(in_record_flag  in varchar,
                                               in_parm_type_id in varchar,
                                               in_isEffect     in varchar,
                                               in_line_id      in varchar,
                                               in_station_id   in varchar,
                                               in_dev_type_id  in varchar,
                                               in_device_id    in varchar,
                                               in_start_time   in varchar, --ø™ º ±º‰
                                               in_end_time     in varchar, -- Ω· ¯ ±º‰
                                               out_cur_arg     out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  Up_OP_DEV_CUR_QUER
  --π¶ƒ‹√Ë ˆ£∫≤Œ ˝∞Ê±æ≤È—Ø-…Ë±∏≤Œ ˝◊¥Ã¨≤È—Ø
  --¥¥Ω®’ﬂ£∫  ouyangwenling
  --¥¥Ω®»’∆⁄£∫20130720
  --¡Ÿ ±±Ì£∫t#op_dev_cur_quer_result
  --Ã· æ£∫op_prm_para_ver_cm Õ®—∂≥Ã–Ú–¥»Î
  -- “ª «ø¥∑µªÿµƒ ˝æ›µƒ∞Ê±æ∫≈ «∑Ò∏˙µ±«∞∞Ê±æ∫≈“ª—˘
  -- ∂˛ «∑µªÿµƒº«¬º ˝ «≤ª «”––©…Ë±∏Œ Ã‚Œ¥∑µªÿ ˝æ›
  -- »Áπ˚∞Ê±æ∫≈∫Õ≤Œ ˝ ˝æ›±Ìµƒ∞Ê±æ∫≈“ª÷¬ ‘ÚŒ™“—…˙–ß ≤ª»ªŒ™Œ¥…˙–ß
  -- ¿‡–ÕLCC-98 SC-01
  -------------------------------------------------------------------------------
 is
  v_sqlno          varchar(1000); --
  v_sqlok          varchar(1000); --
  v_c_parm_type_id char(4);
  
  v_whereParams    varchar(500);
  v_whereTimes     varchar(500);
  
  v_lccParams      varchar(100); --…Ë±∏¿‡–ÕŒ™LCC ±£¨≤È—ØÃıº˛
  v_scParams       varchar(100); --…Ë±∏¿‡–ÕŒ™SC ±£¨≤È—ØÃıº˛
  v_recordParams   varchar(100); --…Ë÷√record_flagµƒ≤È—ØÃıº˛
  
  v_version_new    varchar(10);
  v_record_flag   char(1);
  v_lcc_line_id    varchar(2);
  v_lcc_station_id varchar(2);
begin

  --table t#op_dev_cur_quer_result

  v_whereParams := '';
  v_whereTimes  := '';
  v_lccParams   := '';
  v_scParams    := '';
  v_recordParams :='';
  v_record_flag := '0';
  --œ»…æ≥˝¡Ÿ ±±Ì ˝æ›
  delete from   t#op_dev_cur_quer_result ;
  
  if ( in_line_id is not null and in_line_id != ' ' and in_dev_type_id = '00' ) then
    begin
      --»Áπ˚…Ë±∏ «LCC¿‡–Õ  ∂‘”¶œﬂ¬∑ ≥µ’æ
      select lcc_line_id
        into v_lcc_line_id
        from op_prm_line
       where record_flag = '0'
         and line_id = in_line_id;
    
      v_lcc_station_id := '';
    end;
  else
    begin
      v_lcc_line_id    := in_line_id;
      v_lcc_station_id := in_station_id;
    end;
  end if;

  -- …Ë÷√≤È—ØÃıº˛
  if (v_lcc_line_id is not null ) then
    begin
      v_whereParams := v_whereParams || ' and line_id = ''' || v_lcc_line_id || '''';
      v_lccParams   := v_lccParams || ' and lcc_line_id = ''' || v_lcc_line_id || '''';
      v_scParams    := v_scParams || ' and line_id = ''' || v_lcc_line_id || '''';
    end;
  end if;

  if (v_lcc_station_id is not null ) then
    begin
      v_whereParams := v_whereParams || ' and station_id = ''' || v_lcc_station_id || '''';
      v_scParams    := v_scParams || ' and station_id = ''' || v_lcc_station_id || '''';
    end;
  end if;

  if (in_dev_type_id is not null ) then
    v_whereParams := v_whereParams || ' and dev_type_id = ''' || in_dev_type_id || '''';
  end if;

  if (in_device_id is not null ) then
    v_whereParams := v_whereParams || ' and device_id = ''' || in_device_id || '''';
  end if;

  if (in_start_time is not null ) then
    v_whereTimes := v_whereTimes 
    || ' and report_date >= to_date('''||in_start_time||''',''yyyy_mm_dd hh24:mi:ss'') ';
  end if;

  if (in_end_time is not null ) then
    v_whereTimes := v_whereTimes 
    || ' and report_date <= to_date('''||in_end_time||''',''yyyy_mm_dd hh24:mi:ss'') ';
  end if;
  
  if (in_record_flag is not null )then
    v_recordParams:=v_recordParams||' and record_flag = ''' ||  in_record_flag || ''' ';
    v_record_flag :=in_record_flag;
  end if;

  --select @whereParams        

  begin
    --≈–∂œ «∑Ò—°‘Ò¡À≤Œ ˝¿‡–ÕID
    --if (@parm_type_id is not null and @parm_type_id <> '')
    --declare cu_parm_type  cursor for select parm_type_id  from parm_code_type where parm_type_id = @parm_type_id
  
    declare
      cursor cu_parm_type is
        select parm_type_id
        from op_cod_parm_type
        where parm_type_id like '0%'
        and parm_type_id like '%'||in_parm_type_id||'%'
        and parm_type_id not in ('0401', '0402', '0403', '0404', '0405', '0600');
    
    begin
      --∞¥≤Œ ˝parm_type_id—≠ª∑≤Èø¥≤Œ ˝…˙–ß«Èøˆ
      for my_cur in cu_parm_type loop
           v_c_parm_type_id := my_cur.parm_type_id;
        begin
        
         
            
            begin
              --select ø’÷µ ± @version_new ªπ «…œ“ª∏ˆ÷µ
              v_version_new := null;
              
              begin
                select version_no
                  into v_version_new
                  from op_prm_para_ver
                 where parm_type_id = v_c_parm_type_id
                   and record_flag = v_record_flag;
              EXCEPTION
                WHEN OTHERS THEN
                  dbms_output.put_line('Œ¥’“µΩ'||v_c_parm_type_id||'≤Œ ˝record_flagŒ™'||v_record_flag||'µƒ∞Ê±æversion_no£°');
                  --dbms_output.put_line('SQL CODE:'||sqlcode||chr(10)||sqlerrm||chr(10)||dbms_utility.format_error_backtrace());
              end;
              
            
              --√ª”–∞Ê±æ≤Œ ˝µƒæÕ≤ª–Ë“™≤È—Ø
              if v_version_new is not null then
                begin
                
                  --LCC µƒ«Èøˆœ¬,dev_code ŒﬁLCCº«¬º∂‘£¨»° lcc_line_code ÷–œﬂ¬∑
                  --and record_flag = '"+@record_flag +"'
                
                  if in_dev_type_id = '98' then
                    begin
                      v_sqlno := 'insert into t#op_dev_cur_quer_result '
                              ||'select lcc_line_id,'''',''98'','''','
                              || v_c_parm_type_id ||''' as parm_type_id,'''|| in_record_flag ||''' as record_flag,'
                              ||' '''' as version_no,null as report_date,''not exist'' as remark, ''0'',''' || v_version_new || ''' '
                              || 'from st_cod_lcc_line a  '
                              || 'where 1=1 ' || v_lccParams 
                              || ' and not exists '
                              ||'(select * from acc_commu.cm_dev_para_ver_cur b '
                              ||'where parm_type_id = ''' ||  v_c_parm_type_id || ''' ' 
                              ||'and b.line_id = a.lcc_line_id '
                              ||'and b.dev_type_id = ''' ||  in_dev_type_id || ''' ) '
                              
                              ||'union all '
                              
                              ||'select line_id,station_id,dev_type_id,device_id,parm_type_id,record_flag,version_no,'
                              ||'report_date,remark, ''0'',''' || v_version_new || ''' '
                              ||'from acc_commu.cm_dev_para_ver_cur '
                              ||'where 1=1 '
                              ||'and parm_type_id = ''' ||  v_c_parm_type_id || ''' ' 
                              || v_whereParams || v_whereTimes || v_recordParams
                              || ' and version_no !=  ''' || v_version_new || '''';
                    end;
                    --SC µƒ«Èøˆœ¬,dev_code ŒﬁSCº«¬º∂‘£¨»° station_code ÷–œﬂ¬∑≥µ’æ
                  elsif in_dev_type_id = '01' then
                    begin
                      v_sqlno := 'insert into t#op_dev_cur_quer_result '
                                 
                                 ||'select line_id,station_id,''01'','''',''' 
                                 || v_c_parm_type_id ||''' as parm_type_id,''' 
                                 || in_record_flag || ''' as record_flag,'''' as version_no,null as report_date,''not exist'' as remark, ''0'',''' 
                                 || v_version_new || ''' '
                                 ||' from op_prm_station a '
                                 ||' where 1=1 ' 
                                 || v_scParams 
                                 || ' and not exists (select * from acc_commu.cm_dev_para_ver_cur b '
                                 ||' where parm_type_id = ''' ||  v_c_parm_type_id || ''' '
                                 ||' and b.line_id = a.line_id '
                                 ||' and b.station_id = a.station_id '
                                 ||' and b.dev_type_id = ''' || in_dev_type_id || ''' ) '
                                 
                                 ||' union all '
                                 
                                 ||' select line_id,station_id,dev_type_id,device_id,parm_type_id,record_flag,version_no,report_date,remark, ''0'',' 
                                 ||'''v_version_new'' ' 
                                 ||' from acc_commu.cm_dev_para_ver_cur '
                                 ||' where 1=1 '
                                 ||' and parm_type_id = ''' ||   v_c_parm_type_id || ''' ' 
                                 || v_whereParams ||  v_whereTimes || v_recordParams
                                 || ' and version_no !=  ''' || v_version_new || ''' ';
                                                  end;
                  else
                    begin
                    
                      v_sqlno := 'insert into t#op_dev_cur_quer_result ' 
                      
                                 ||'select line_id,station_id,dev_type_id,device_id, '
                                 ||' '''||  v_c_parm_type_id || ''' as parm_type_id,''' 
                                 || in_record_flag ||''' as record_flag,'''' as version_no,'
                                 ||'null as report_date,''not exist'' as remark, ''0'',''' || v_version_new ||''' '
                                 ||' from op_prm_dev_code a  '
                                 ||'where a.record_flag=0 ' 
                                 || v_whereParams 
                                 
                                 ||'  and not exists '
                                 ||'(select * from acc_commu.cm_dev_para_ver_cur b '
                                 ||' where parm_type_id = ''' || v_c_parm_type_id 
                                 || ''' and b.line_id = a.line_id '
                                 ||' and b.station_id = a.station_id '
                                 ||' and b.dev_type_id = a.dev_type_id '
                                 ||' and b.device_id = a.device_id) '
                                 
                                 ||' union all '
                                 
                                 ||' select line_id,station_id,dev_type_id,device_id,parm_type_id,record_flag,version_no,report_date,remark, ''0'',''' 
                                 || v_version_new 
                                 || ''' from acc_commu.cm_dev_para_ver_cur '
                                 ||'where 1=1 ' 
                                 || ' and parm_type_id = ''' || v_c_parm_type_id || ''' ' 
                                 || v_whereParams || v_whereTimes || v_recordParams
                                 || ' and version_no !=  ''' || v_version_new || '''';
                                                  end;
                  end if;
                
                  v_sqlok := 'insert into t#op_dev_cur_quer_result '
                           || ' select line_id,station_id,dev_type_id,device_id,parm_type_id,'
                           || 'record_flag,version_no,report_date,remark, ''1'',''' || v_version_new 
                           || ''' from acc_commu.cm_dev_para_ver_cur '
                           ||' where 1=1 ' 
                           || ' and parm_type_id = ''' || v_c_parm_type_id || ''' ' 
                           || v_whereParams || v_whereTimes || v_recordParams
                           || ' and version_no =  ''' || v_version_new || ''''
                           ;
                
                  if in_isEffect = '0' then
                    begin
                      execute immediate v_sqlno;
                    end;
                  elsif in_isEffect = '1' then
                    begin
                      execute immediate v_sqlok;
                    end;
                  else
                    begin
                      execute immediate v_sqlno;
                      execute immediate v_sqlok;
                    end;
                  end if;
                
                end;
              end if;
            
            end;
          
        
        end;
      end loop;
    end;
  end;

  open out_cur_arg for
    select line_id,
           station_id,
           dev_type_id,
           device_id,
           parm_type_id,
           record_flag,
           version_no,
           report_date,
           remark,
           is_effect,
           version_new
      from t#op_dev_cur_quer_result;
      commit;
EXCEPTION
  WHEN OTHERS THEN
    dbms_output.put_line('SQL CODE:'||sqlcode||chr(10)||sqlerrm||chr(10)||dbms_utility.format_error_backtrace());
end;
/
grant execute on ACC_ST.UP_OP_DEV_CUR_QUER to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_DEV_CUR_QUER to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_DEV_TVM_DAY
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_DEV_TVM_DAY(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_DEV_TVM_DAY
--ƒ£øÈ£∫ºƒ¥Ê∆˜Õ≥º∆±®±Ì
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑TVMºƒ¥Ê∆˜ ˝æ›»’±®±Ì
-- ‰»Î≤Œ ˝:
--ƒ£øÈÕ®”√¡Ÿ ±±Ì£∫t#OP_DEV_AGM_rpt
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130806
--–ﬁ∏ƒ»’∆⁄£∫
--ƒ£∞Â±‡∫≈£∫rpt_08_001
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140707
--–ﬁ∏ƒƒ⁄»›£∫
  --1>–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ
  --2>–¬Ω®ºƒ¥Ê∆˜ ˝æ›±Ìop_cod_dev_reg£¨≤¢‘ˆº”∂‘”¶ºƒ¥Ê∆˜±‡¬Î ˝æ›
  --3>–ﬁ∏ƒ∑µªÿµƒΩ·π˚ºØ
  ----------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140730
--–ﬁ∏ƒƒ⁄»›£∫
  --1>µ±»’Õ≥º∆÷µ=µ±«∞«ÂÀ„»’µƒ÷µ-…œ“ª∏ˆ«ÂÀ„»’µƒ÷µ
    ----------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140828
--–ﬁ∏ƒƒ⁄»›£∫
  --1>∏ƒªÿ20140707»’µƒ∞Ê±æ£¨÷±Ω”¥”÷–º‰±ÌÕ≥º∆ºƒ¥Ê∆˜ ˝æ›
    ----------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫÷‹—Ô
--–ﬁ∏ƒ»’∆⁄:20160629
--–ﬁ∏ƒƒ⁄»›£∫
  --1>‘⁄∑µªÿΩ·π˚π˝≥Ã÷–£¨µ±¡Ÿ ±±Ì√ª”– ˝æ› ±∑µªÿ“ªÃı≥˝»’∆⁄Õ‚∆‰À¸∂ºŒ™ø’µƒ ˝æ›
----------------------------------------------------------------------------
AS
   v_line_id  char(2);
   v_linename VARCHAR2(20);
   v_squadday varchar2(8);
   v_balanceday varchar2(8);
   v_balanceday_last varchar2(8);
   v_squadday_last varchar2(8);
   v_count number(8);-- 2016.06.29 add by zhouyang
   --v_day int;
BEGIN
   v_line_id:=in_line_id;
   v_squadday:=substr(in_squad_day,1,8);
   v_balanceday:=substr(in_balance_day,1,8);
   --v_day:=1;
   IF v_line_id is not NULL and v_line_id!=' ' THEN
      SELECT LINE_NAME
      INTO V_LINENAME
      FROM op_prm_line
      WHERE LINE_ID = v_line_id and record_flag='0';
   END IF;
----ªÒ»°÷–º‰±Ì ˝æ›¿Ô…œ“ª«ÂÀ„¡˜ÀÆ÷µ----------------------------
--20140730∏¸∏ƒ£∫
/*
    select max(substr(balance_water_no,1,8)) into v_balanceday_last from st_sts_reg_tvm
            where substr(balance_water_no,1,8)<v_balanceday;
   select max(substr(squad_day,1,8)) into v_squadday_last from st_sts_reg_tvm
            where substr(balance_water_no,1,8)=v_balanceday_last;
            */
/*
declare
  cursor v_cursor
   is
     select max(substr(balance_water_no,1,8)) from st_sts_reg_tvm
            where substr(balance_water_no,1,8)<v_balanceday;
begin
   open v_cursor;

       fetch v_cursor into  v_balanceday_last;

   close v_cursor;
end;*/
------------------------------------------------------
------------------------------------------
--ππΩ®Ω·π˚ºØΩ·ππ
    /*INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      '',
      '02',--¥˙¬Î±ÌTVM «'02'
      b.reg_code,
      b.reg_code,
      0
   FROM op_prm_station a,op_cod_dev_reg b
   where b.dev_type_id='02'
   and a.line_id=v_line_id and a.record_flag='0'
   group by a.line_id,a.station_id,b.reg_code;*/
-----------------------------------------------------------
--st_sts_reg_tvmÕ≥º∆÷µ¿€º”£¨”¶∏√ºı»•…œ“ªÃı«ÂÀ„¡˜ÀÆ∫≈µƒÕ≥º∆÷µ
----st_sts_reg_tvmµ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒÕ≥º∆÷µ---------------------
 INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      a.dev_type_id,
      a.data_code,
      a.data_code,
      sum(a.deal_value)
   FROM st_sts_reg_tvm a
   where a.dev_type_id='02'--TVM¥˙¬Î£∫02
   and a.line_id=v_line_id
   and substr(a.squad_day,1,8)=v_squadday
   and substr(a.balance_water_no,1,8)=v_balanceday
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;
  /* ----ºı»•st_sts_reg_tvm…œ“ª«ÂÀ„¡˜ÀÆ∫≈µƒÕ≥º∆÷µ---------------------
   --20140730∏¸∏ƒ£∫
 INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      a.dev_type_id,
      a.data_code,
      a.data_code,
      sum(a.deal_value)*(-1)
   FROM st_sts_reg_tvm a
   where a.dev_type_id='02'--TVM¥˙¬Î£∫02
   and a.line_id=v_line_id
   and substr(a.squad_day,1,8)=v_squadday_last
   and substr(a.balance_water_no,1,8)=v_balanceday_last
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;
   */
   ---------------------------------------------------------------------
      ----∫œº∆
INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      '99',
      '∫œº∆',
      a.squad_day,
      a.dev_type_id,
      '',
      '',
      sum(a.deal_value)
   FROM t#OP_DEV_AGM_rpt A
   group by a.line_id,a.squad_day,a.dev_type_id;
   ----∏¸–¬’æµ„√˚
   update t#OP_DEV_AGM_rpt a set a.station_name=(
          select b.sequence||b.chinese_name from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id)
   where exists (select 1 from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id);
   ----∏¸–¬ºƒ¥Ê∆˜√˚
   update t#OP_DEV_AGM_rpt a set a.reg_desc=(
          select b.reg_desc from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='02')
   where exists (select 1 from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='02');
----∑µªÿΩ·π˚ºØ
SELECT count(*) INTO v_count FROM t#OP_DEV_AGM_rpt;
IF v_count > 0 then
      OPEN out_cursor FOR
         SELECT  v_squadday||v_balanceday day,v_linename linename,
                 station_name stationname,reg_code,reg_desc,sum(deal_value) deal_value
            FROM t#OP_DEV_AGM_rpt
         group by station_name,reg_code,reg_desc
         order by station_name,reg_code,reg_desc;
else----»Áπ˚t#OP_DEV_AGM_rpt√ª”– ˝æ› ±£¨∑¥ªÿ“ªÃıø’ ˝æ›  2016.06.29 add by zhouyang
     OPEN out_cursor FOR
     SELECT  v_squadday||v_balanceday day,v_linename linename,
             ' ' stationname,' ' reg_code,' ' reg_desc,null deal_value
     FROM dual;
end if;
END;
/
grant execute on ACC_ST.UP_OP_DEV_TVM_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_DEV_TVM_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_DEV_TVM_MON
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_DEV_TVM_MON(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_DEV_TVM_MON
--ƒ£øÈ£∫ºƒ¥Ê∆˜Õ≥º∆±®±Ì
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑TVMºƒ¥Ê∆˜ ˝æ›‘¬±®±Ì
-- ‰»Î≤Œ ˝:
--ƒ£øÈÕ®”√¡Ÿ ±±Ì£∫t#OP_DEV_AGM_rpt
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130806
--–ﬁ∏ƒ»’∆⁄£∫
--ƒ£∞Â±‡∫≈£∫rpt_08_002
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140707
--–ﬁ∏ƒƒ⁄»›£∫
  --1>–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ
  --2>–¬Ω®ºƒ¥Ê∆˜ ˝æ›±Ìop_cod_dev_reg£¨≤¢‘ˆº”∂‘”¶ºƒ¥Ê∆˜±‡¬Î ˝æ›
  --3>–ﬁ∏ƒ∑µªÿµƒΩ·π˚ºØ
----------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140730
--–ﬁ∏ƒƒ⁄»›£∫
  --1>µ±‘¬Õ≥º∆÷µ=µ±«∞«ÂÀ„‘¬µƒ÷µ-…œ“ª∏ˆ«ÂÀ„‘¬µƒ÷µ
----------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄:20140828
--–ﬁ∏ƒƒ⁄»›£∫
  --1>∏ƒªÿ20140707∞Ê±æ£¨÷±Ω”¥”÷–º‰±ÌÕ≥º∆ ˝æ›
----------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫÷‹—Ô
--–ﬁ∏ƒ»’∆⁄:20160629
--–ﬁ∏ƒƒ⁄»›£∫
  --1>‘⁄∑µªÿΩ·π˚π˝≥Ã÷–£¨µ±¡Ÿ ±±Ì√ª”– ˝æ› ±∑µªÿ“ªÃı≥˝»’∆⁄Õ‚∆‰À¸∂ºŒ™ø’µƒ ˝æ›
----------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫÷‹—Ô
--–ﬁ∏ƒ»’∆⁄:20160824
--–ﬁ∏ƒƒ⁄»›£∫
  --1>Ω´…Ë÷√V_LINENAME≤ø∑÷µƒƒ⁄»›ø™∑≈≥ˆ¿¥
----------------------------------------------------------------------------
AS
   v_line_id  char(2);
   v_linename VARCHAR2(20);
   v_squadday varchar2(6);
   v_balanceday varchar2(6);
   v_balanceday_last varchar2(8);
   v_squadday_last varchar2(8);
   v_count number(8);-- 2016.06.29 add by zhouyang
   -----st_sts_reg_tvm÷–º‰±Ì ˝æ› ±√ø»’¿€º”µƒ
BEGIN
   v_line_id:=substr(in_line_id,1,2);
   v_squadday:=substr(in_squad_day,1,6);
   v_balanceday:=substr(in_balance_day,1,6);
/*
   --v_squadday:=to_char(last_day(to_date(substr(in_squad_day,1,6),'yyyymm')),'yyyymmdd');
   --v_balanceday:=to_char(last_day(to_date(substr(in_balance_day,1,6),'yyyymm')),'yyyymmdd');
--µ±‘¬◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
select max(substr(balance_water_no,1,8)) into v_balanceday from st_sts_reg_tvm a
   where substr(balance_water_no,1,6)=v_balanceday;
--µ±‘¬◊Ó¥Û‘À”™»’
select max(substr(squad_day,1,8)) into v_squadday from st_sts_reg_tvm a
   where substr(balance_water_no,1,8)=v_balanceday;
--…œ‘¬◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
select max(substr(balance_water_no,1,8)) into v_balanceday_last from st_sts_reg_tvm a
   where substr(balance_water_no,1,6)=to_char(add_months(to_date(substr(v_balanceday,1,6),'yyyymm'),-1),'yyyymm');
--…œ‘¬◊Ó¥Û‘À”™»’
select max(substr(squad_day,1,8)) into v_squadday_last from st_sts_reg_tvm a
   where balance_water_no=v_balanceday_last;
*/
   IF v_line_id is not NULL and v_line_id!=' ' THEN --20160824 zhouyang
      SELECT LINE_NAME
      INTO V_LINENAME
      FROM op_prm_line
      WHERE LINE_ID = v_line_id and record_flag='0';
   END IF;

-----------------------------------------------------------
--st_sts_reg_tvmÕ≥º∆÷µ¿€º”£¨”¶∏√ºı»•…œ“ªÃı«ÂÀ„¡˜ÀÆ∫≈µƒÕ≥º∆÷µ
----st_sts_reg_tvmµ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒÕ≥º∆÷µ---------------------
INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      a.dev_type_id,
      a.data_code,
      a.data_code,
      sum(a.deal_value)
   FROM st_sts_reg_tvm a
   where a.dev_type_id='02'
   and a.line_id=v_line_id
   and substr(a.squad_day,1,6)=v_squadday
   and substr(a.balance_water_no,1,6)=v_balanceday
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;
/*----ºı»•st_sts_reg_tvm…œ“ª«ÂÀ„¡˜ÀÆ∫≈µƒÕ≥º∆÷µ---------------------
 --20140730∏¸∏ƒ£∫
 INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      a.station_id,
      '',
      a.squad_day,
      a.dev_type_id,
      a.data_code,
      a.data_code,
      sum(a.deal_value)*(-1)
   FROM st_sts_reg_tvm a
   where a.dev_type_id='02'--TVM¥˙¬Î£∫02
   and a.line_id=v_line_id
   and substr(a.squad_day,1,8)=v_squadday_last
   and substr(a.balance_water_no,1,8)=v_balanceday_last
   group by a.line_id,a.station_id,a.squad_day,a.dev_type_id,a.data_code;*/
---------------------------------------------------------------------
   ----∫œº∆
INSERT INTO  t#OP_DEV_AGM_rpt(line_id,Station_Id,Station_Name,Squad_Day,Dev_Type_Id,Reg_Code,Reg_Desc,Deal_Value)
   SELECT
      a.line_id,
      '99',
      '∫œº∆',
      a.squad_day,
      a.dev_type_id,
      '',
      '',
      sum(a.deal_value)
   FROM t#OP_DEV_AGM_rpt A
   group by a.line_id,a.squad_day,a.dev_type_id;

   ----∏¸–¬’æµ„√˚
   update t#OP_DEV_AGM_rpt a set a.station_name=(
          select b.sequence||b.chinese_name from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id)
   where exists (select 1 from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id and b.station_id=a.station_id);
   ----∏¸–¬ºƒ¥Ê∆˜√˚
   update t#OP_DEV_AGM_rpt a set a.reg_desc=(
          select b.reg_desc from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='02')
   where exists (select 1 from op_cod_dev_reg b
          where a.dev_type_id=b.dev_type_id and a.reg_code=b.reg_code and b.dev_type_id='02');
----∑µªÿΩ·π˚ºØ
SELECT count(*) INTO v_count FROM t#OP_DEV_AGM_rpt;
IF v_count >0 then
      OPEN out_cursor FOR
         SELECT  v_squadday||v_balanceday day,v_linename linename,
                 station_name stationname,reg_code,reg_desc,sum(deal_value) deal_value
            FROM t#OP_DEV_AGM_rpt
         group by station_name,reg_code,reg_desc
         order by station_name,reg_code,reg_desc;
ELSE----»Áπ˚t#OP_DEV_AGM_rpt√ª”– ˝æ› ±£¨≤Â»Î“ªÃıø’ ˝æ›  2016.06.29 add by zhouyang
      OPEN out_cursor FOR
         SELECT  v_squadday||v_balanceday day,v_linename linename,
                 ' ' stationname,' ' reg_code,' ' reg_desc,null deal_value
            FROM dual;
END IF;
END;
/
grant execute on ACC_ST.UP_OP_DEV_TVM_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_DEV_TVM_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_DIFF_ACC_LCC
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_DIFF_ACC_LCC(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-------------------------------------------------------------------
--π˝≥Ã√˚:UP_OP_DIFF_ACC_LCC
--±®±Ì√˚£∫LCC∂‘’ÀΩ·π˚»’±®
--π¶ƒ‹√Ë ˆ£∫ACC”ÎLCC∂‘’ÀΩ·π˚(À˘”–’æµ„)
--±®±Ìƒ£∞Â£∫rpt_09_001
--÷–º‰±Ì£∫st_sts_lcc_acc
AS
V_balanceday char(8);
V_squadday char(8);
BEGIN
 v_balanceday:=substr(in_balance_day,1,8);
 v_squadday:=substr(in_squad_day,1,8);
 ----≤È—Ø÷–º‰±Ì ˝æ›
 insert into t#op_diff_lcc_rpt
 select
    LINE_ID,
    STATION_ID,
    DIFF_BOM_SALE_SJT_NUM,
    DIFF_BOM_SALE_SJT_FEE,
    DIFF_TVM_SALE_SJT_NUM,
    DIFF_TVM_SALE_SJT_FEE,
    DIFF_BOM_SALE_NUM,
    DIFF_BOM_SALE_DEPOSIT_FEE,
    DIFF_BOM_CHARGE_FEE,
    DIFF_TVM_CHARGE_NUM,
    DIFF_TVM_CHARGE_FEE,
    DIFF_RETURN_NUM,
    DIFF_RETURN_FEE,
    DIFF_NON_RETURN_NUM,
    DIFF_NON_RET_DEPOSIT_FEE,
    DIFF_NON_RET_ACTUAL_RET_BALA,
    DIFF_NEGATIVE_CHARGE_NUM,
    DIFF_NEGATIVE_CHARGE_FEE,
    DIFF_DEAL_NUM,
    DIFF_DEAL_FEE,
    DIFF_UPDATE_CASH_NUM,
    DIFF_UPDATE_CASH_FEE,
    DIFF_UPDATE_NONCASH_NUM,
    DIFF_UPDATE_NONCASH_FEE,
    DIFF_ADMIN_NUM,
    DIFF_ADMIN_RETURN_FEE,
    DIFF_ADMIN_PENALTY_FEE
from st_sts_lcc_acc
where balance_water_no<=V_balanceday||'99' and balance_water_no>=V_balanceday||'01';
----œÚΩ·π˚ºØ≤Â»Î ˝æ›
insert into t#op_diff_lcc_result
 select
    LINE_ID,
    '',
    STATION_ID,
    '',
    sum(DIFF_BOM_SALE_SJT_NUM) DIFF_BOM_SALE_SJT_NUM,
    sum(DIFF_BOM_SALE_SJT_FEE) DIFF_BOM_SALE_SJT_FEE,
    sum(DIFF_TVM_SALE_SJT_NUM) DIFF_TVM_SALE_SJT_NUM,
    sum(DIFF_TVM_SALE_SJT_FEE) DIFF_TVM_SALE_SJT_FEE,
    sum(DIFF_BOM_SALE_NUM) DIFF_BOM_SALE_NUM,
    sum(DIFF_BOM_SALE_DEPOSIT_FEE) DIFF_BOM_SALE_DEPOSIT_FEE,
    sum(DIFF_BOM_CHARGE_FEE) DIFF_BOM_CHARGE_FEE,
    sum(DIFF_TVM_CHARGE_NUM) DIFF_TVM_CHARGE_NUM,
    sum(DIFF_TVM_CHARGE_FEE) DIFF_TVM_CHARGE_FEE,
    sum(DIFF_RETURN_NUM) DIFF_RETURN_NUM,
    sum(DIFF_RETURN_FEE) DIFF_RETURN_FEE,
    sum(DIFF_NON_RETURN_NUM) DIFF_NON_RETURN_NUM,
    sum(DIFF_NON_RET_DEPOSIT_FEE) DIFF_NON_RET_DEPOSIT_FEE,
    sum(DIFF_NON_RET_ACTUAL_RET_BALA) DIFF_NON_RET_ACTUAL_RET_BALA,
    sum(DIFF_NEGATIVE_CHARGE_NUM) DIFF_NEGATIVE_CHARGE_NUM,
    sum(DIFF_NEGATIVE_CHARGE_FEE) DIFF_NEGATIVE_CHARGE_FEE,
    sum(DIFF_DEAL_NUM) DIFF_DEAL_NUM,
    sum(DIFF_DEAL_FEE) DIFF_DEAL_FEE,
    sum(DIFF_UPDATE_CASH_NUM) DIFF_UPDATE_CASH_NUM,
    sum(DIFF_UPDATE_CASH_FEE) DIFF_UPDATE_CASH_FEE,
    sum(DIFF_UPDATE_NONCASH_NUM) DIFF_UPDATE_NONCASH_NUM,
    sum(DIFF_UPDATE_NONCASH_FEE) DIFF_UPDATE_NONCASH_FEE,
    sum(DIFF_ADMIN_NUM) DIFF_ADMIN_NUM,
    sum(DIFF_ADMIN_RETURN_FEE) DIFF_ADMIN_RETURN_FEE,
    sum(DIFF_ADMIN_PENALTY_FEE) DIFF_ADMIN_PENALTY_FEE
from t#op_diff_lcc_rpt
group by line_id,station_id;
----∞¥œﬂ¬∑∫œº∆
insert into t#op_diff_lcc_result
 select
    LINE_ID,
    '',
    '99',
    '∞¥œﬂ¬∑∫œº∆',
    sum(DIFF_BOM_SALE_SJT_NUM) DIFF_BOM_SALE_SJT_NUM,
    sum(DIFF_BOM_SALE_SJT_FEE) DIFF_BOM_SALE_SJT_FEE,
    sum(DIFF_TVM_SALE_SJT_NUM) DIFF_TVM_SALE_SJT_NUM,
    sum(DIFF_TVM_SALE_SJT_FEE) DIFF_TVM_SALE_SJT_FEE,
    sum(DIFF_BOM_SALE_NUM) DIFF_BOM_SALE_NUM,
    sum(DIFF_BOM_SALE_DEPOSIT_FEE) DIFF_BOM_SALE_DEPOSIT_FEE,
    sum(DIFF_BOM_CHARGE_FEE) DIFF_BOM_CHARGE_FEE,
    sum(DIFF_TVM_CHARGE_NUM) DIFF_TVM_CHARGE_NUM,
    sum(DIFF_TVM_CHARGE_FEE) DIFF_TVM_CHARGE_FEE,
    sum(DIFF_RETURN_NUM) DIFF_RETURN_NUM,
    sum(DIFF_RETURN_FEE) DIFF_RETURN_FEE,
    sum(DIFF_NON_RETURN_NUM) DIFF_NON_RETURN_NUM,
    sum(DIFF_NON_RET_DEPOSIT_FEE) DIFF_NON_RET_DEPOSIT_FEE,
    sum(DIFF_NON_RET_ACTUAL_RET_BALA) DIFF_NON_RET_ACTUAL_RET_BALA,
    sum(DIFF_NEGATIVE_CHARGE_NUM) DIFF_NEGATIVE_CHARGE_NUM,
    sum(DIFF_NEGATIVE_CHARGE_FEE) DIFF_NEGATIVE_CHARGE_FEE,
    sum(DIFF_DEAL_NUM) DIFF_DEAL_NUM,
    sum(DIFF_DEAL_FEE) DIFF_DEAL_FEE,
    sum(DIFF_UPDATE_CASH_NUM) DIFF_UPDATE_CASH_NUM,
    sum(DIFF_UPDATE_CASH_FEE) DIFF_UPDATE_CASH_FEE,
    sum(DIFF_UPDATE_NONCASH_NUM) DIFF_UPDATE_NONCASH_NUM,
    sum(DIFF_UPDATE_NONCASH_FEE) DIFF_UPDATE_NONCASH_FEE,
    sum(DIFF_ADMIN_NUM) DIFF_ADMIN_NUM,
    sum(DIFF_ADMIN_RETURN_FEE) DIFF_ADMIN_RETURN_FEE,
    sum(DIFF_ADMIN_PENALTY_FEE) DIFF_ADMIN_PENALTY_FEE
from t#op_diff_lcc_rpt
group by line_id;
----◊‹º∆
insert into t#op_diff_lcc_result
 select
    '99',
    '◊‹º∆',
    '',
    '',
    sum(DIFF_BOM_SALE_SJT_NUM) DIFF_BOM_SALE_SJT_NUM,
    sum(DIFF_BOM_SALE_SJT_FEE) DIFF_BOM_SALE_SJT_FEE,
    sum(DIFF_TVM_SALE_SJT_NUM) DIFF_TVM_SALE_SJT_NUM,
    sum(DIFF_TVM_SALE_SJT_FEE) DIFF_TVM_SALE_SJT_FEE,
    sum(DIFF_BOM_SALE_NUM) DIFF_BOM_SALE_NUM,
    sum(DIFF_BOM_SALE_DEPOSIT_FEE) DIFF_BOM_SALE_DEPOSIT_FEE,
    sum(DIFF_BOM_CHARGE_FEE) DIFF_BOM_CHARGE_FEE,
    sum(DIFF_TVM_CHARGE_NUM) DIFF_TVM_CHARGE_NUM,
    sum(DIFF_TVM_CHARGE_FEE) DIFF_TVM_CHARGE_FEE,
    sum(DIFF_RETURN_NUM) DIFF_RETURN_NUM,
    sum(DIFF_RETURN_FEE) DIFF_RETURN_FEE,
    sum(DIFF_NON_RETURN_NUM) DIFF_NON_RETURN_NUM,
    sum(DIFF_NON_RET_DEPOSIT_FEE) DIFF_NON_RET_DEPOSIT_FEE,
    sum(DIFF_NON_RET_ACTUAL_RET_BALA) DIFF_NON_RET_ACTUAL_RET_BALA,
    sum(DIFF_NEGATIVE_CHARGE_NUM) DIFF_NEGATIVE_CHARGE_NUM,
    sum(DIFF_NEGATIVE_CHARGE_FEE) DIFF_NEGATIVE_CHARGE_FEE,
    sum(DIFF_DEAL_NUM) DIFF_DEAL_NUM,
    sum(DIFF_DEAL_FEE) DIFF_DEAL_FEE,
    sum(DIFF_UPDATE_CASH_NUM) DIFF_UPDATE_CASH_NUM,
    sum(DIFF_UPDATE_CASH_FEE) DIFF_UPDATE_CASH_FEE,
    sum(DIFF_UPDATE_NONCASH_NUM) DIFF_UPDATE_NONCASH_NUM,
    sum(DIFF_UPDATE_NONCASH_FEE) DIFF_UPDATE_NONCASH_FEE,
    sum(DIFF_ADMIN_NUM) DIFF_ADMIN_NUM,
    sum(DIFF_ADMIN_RETURN_FEE) DIFF_ADMIN_RETURN_FEE,
    sum(DIFF_ADMIN_PENALTY_FEE) DIFF_ADMIN_PENALTY_FEE
from t#op_diff_lcc_rpt
group by line_id;
--∏¸–¬’æµ„œﬂ¬∑÷–Œƒ√˚
update t#op_diff_lcc_result a set a.line_name=(select b.sequence||b.line_name from op_prm_line b
where a.line_id=b.line_id and b.record_flag='0')
where a.line_id!='99';
update t#op_diff_lcc_result a set a.station_name=(select b.sequence||b.chinese_name from op_prm_station b
where a.line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0')
where a.station_id!='99';
 ----∑µªÿΩ·π˚ºØ
 OPEN out_cursor for
 select V_balanceday day,
    line_name,
    station_name,
    sum(DIFF_BOM_SALE_SJT_NUM) DIFF_BOM_SALE_SJT_NUM,
    sum(DIFF_BOM_SALE_SJT_FEE) DIFF_BOM_SALE_SJT_FEE,
    sum(DIFF_TVM_SALE_SJT_NUM) DIFF_TVM_SALE_SJT_NUM,
    sum(DIFF_TVM_SALE_SJT_FEE) DIFF_TVM_SALE_SJT_FEE,
    sum(DIFF_BOM_SALE_NUM) DIFF_BOM_SALE_NUM,
    sum(DIFF_BOM_SALE_DEPOSIT_FEE) DIFF_BOM_SALE_DEPOSIT_FEE,
    sum(DIFF_BOM_CHARGE_FEE) DIFF_BOM_CHARGE_FEE,
    sum(DIFF_TVM_CHARGE_NUM) DIFF_TVM_CHARGE_NUM,
    sum(DIFF_TVM_CHARGE_FEE) DIFF_TVM_CHARGE_FEE,
    sum(DIFF_RETURN_NUM) DIFF_RETURN_NUM,
    sum(DIFF_RETURN_FEE) DIFF_RETURN_FEE,
    sum(DIFF_NON_RETURN_NUM) DIFF_NON_RETURN_NUM,
    sum(DIFF_NON_RET_DEPOSIT_FEE) DIFF_NON_RET_DEPOSIT_FEE,
    sum(DIFF_NON_RET_ACTUAL_RET_BALA) DIFF_NON_RET_ACTUAL_RET_BALA,
    sum(DIFF_NEGATIVE_CHARGE_NUM) DIFF_NEGATIVE_CHARGE_NUM,
    sum(DIFF_NEGATIVE_CHARGE_FEE) DIFF_NEGATIVE_CHARGE_FEE,
    sum(DIFF_DEAL_NUM) DIFF_DEAL_NUM,
    sum(DIFF_DEAL_FEE) DIFF_DEAL_FEE,
    sum(DIFF_UPDATE_CASH_NUM) DIFF_UPDATE_CASH_NUM,
    sum(DIFF_UPDATE_CASH_FEE) DIFF_UPDATE_CASH_FEE,
    sum(DIFF_UPDATE_NONCASH_NUM) DIFF_UPDATE_NONCASH_NUM,
    sum(DIFF_UPDATE_NONCASH_FEE) DIFF_UPDATE_NONCASH_FEE,
    sum(DIFF_ADMIN_NUM) DIFF_ADMIN_NUM,
    sum(DIFF_ADMIN_RETURN_FEE) DIFF_ADMIN_RETURN_FEE,
    sum(DIFF_ADMIN_PENALTY_FEE) DIFF_ADMIN_PENALTY_FEE
from t#op_diff_lcc_result
group by  line_name,station_name
order by  line_name,station_name;
end UP_OP_DIFF_ACC_LCC;
/
grant execute on ACC_ST.UP_OP_DIFF_ACC_LCC to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_DIFF_ACC_LCC to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_ERR_CARD
prompt =================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_ERR_CARD
---------------------------------------------------------------------------------
--π¶ƒ‹£∫¥¢÷µø®ø®–£—È“Ï≥£»’±®±Ì
--¥¥Ω®£∫Õıø…º—
-- ±º‰£∫20130710
(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--–ﬁ∏ƒ»’∆⁄£ª20140826
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£ªº«¬º ˝≥¨≥ˆœﬁ÷∆£¨±®±Ì…˙≥…≤ª¡À£¨÷ª»°”‡∂Ó≤Ó∂Ó>50µƒº«¬º
--------------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£ª20170522
--–ﬁ∏ƒ»À£∫zhouyang
--–ﬁ∏ƒƒ⁄»›£ª»Ù∑µªÿΩ·π˚÷–◊÷∂Œµƒ÷µŒ™null£¨‘Ú∏≥÷µ"0";
--          Ω´ø®œ˚∑—º∆ ˝∏ƒŒ™CARD_CONSUME_SEQ£®‘≠œ»Œ™CARD_CHARGE_SEQ£©
--------------------------------------------------------------------------------------
aS
v_squadDay varchar(8);
v_balanceday varchar(8);
    BEGIN
v_squadDay:=substr(in_squad_day,1,8);
v_balanceday:=substr(in_balance_day,1,8);
 /* insert into  t#op_err_card_result(
  card_logical_id,--¬ﬂº≠ø®∫≈
  card_physical_id,--ŒÔ¿Ìø®∫≈
  total_charge_fee,--≥‰÷µ◊‹Ω∂Ó
  total_consume_fee,--œ˚∑—◊‹Ω∂Ó
  card_balance_fee,--∆±ø®”‡∂Ó
  diff_balance_fee,--”‡∂Ó≤Ó∂Ó
  sys_deal_num,--œµÕ≥¿€º∆Ωª“◊ ˝
  card_deal_num,--∆±ø®◊‹Ωª“◊ ˝
  diff_balance_num--Ωª“◊¥Œ ˝≤Ó∂Ó
  )
    select
        card_logical_id,--¬ﬂº≠ø®∫≈
        card_physical_id,--ŒÔ¿Ìø®∫≈
        total_charge_fee,--≥‰÷µ◊‹Ω∂Ó
        total_consume_fee,--œ˚∑—◊‹Ω∂Ó
        card_balance_fee,--∆±ø®”‡∂Ó
        diff_card_sys_fee,--”‡∂Ó≤Ó∂Ó
        card_charge_seq+card_consume_seq,--œµÕ≥≥‰÷µ¥Œ ˝+œµÕ≥œ˚∑—¥Œ ˝
        total_charge_num+total_consume_num,--∆±ø®≥‰÷µ¥Œ ˝+∆±ø®œ˚∑—¥Œ ˝
        diff_card_sys_num    --Ωª“◊¥Œ ˝≤Ó∂Ó
        card_money
    from st_card_check_result
    where substr(balance_water_no,1,8)=v_balanceday
    and abs(diff_card_sys_fee)>=50;*/
        OPEN out_cursor FOR
select v_squadDay||v_balanceDay day,
  card_logical_id,
  card_physical_id,
  sum(nvl(card_money,0)) as card_money,--‘§∏≥÷µΩ∂Ó£∫
  sum(nvl(TOTAL_CHARGE_FEE,0)) as TOTAL_CHARGE_FEE,--≥‰÷µ◊‹Ω∂Ó£∫
  sum(nvl(TOTAL_CONSUME_FEE,0)) as TOTAL_CONSUME_FEE,--œ˚∑—◊‹Ω∂Ó£∫
  sum(nvl(SYSTEM_BALANCE_FEE,0)) as SYSTEM_BALANCE_FEE,--œµÕ≥”‡∂Ó£∫
  sum(nvl(CARD_BALANCE_FEE,0)) as CARD_BALANCE_FEE,--∆±ø®”‡∂Ó£∫
  sum(nvl(DIFF_CARD_SYS_FEE,0)) as DIFF_CARD_SYS_FEE,--”‡∂Ó≤Ó∂Ó£∫
  sum(nvl(TOTAL_CHARGE_NUM,0)) as TOTAL_CHARGE_NUM,--≥‰÷µ¥Œ ˝:
  sum(nvl(CARD_CHARGE_SEQ,0)) as CARD_CHARGE_SEQ,--ø®≥‰÷µº∆ ˝:
  sum(nvl(TOTAL_consume_NUM,0)) as TOTAL_consume_NUM,--œ˚∑—¥Œ ˝:
  sum(nvl(CARD_CONSUME_SEQ,0)) as CARD_CONSUME_SEQ --ø®œ˚∑—º∆ ˝:
  from st_card_check_result
  where substr(balance_water_no,1,8)=v_balanceday
        and abs(diff_card_sys_fee)>=50
  group by card_logical_id,card_physical_id
  order by card_logical_id,card_physical_id;
end;
/
grant execute on ACC_ST.UP_OP_ERR_CARD to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_ERR_CARD to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_ERR_DEAL_DAY
prompt =====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_ERR_DEAL_DAY
---------------------------------------------------------------------------------
--“Ï≥£Ωª“◊Õ≥º∆»’±®±Ì
--π¶ƒ‹£∫“Ï≥£Ωª“◊Õ≥º∆»’±®±Ì£®∞¸¿®“Ï≥£‘≠“Ú°¢±  ˝°¢Ωª“◊Ω∂Ó°¢µÿµ„°¢…Ë±∏µ»£©
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫2013-07-30
--∂‘”¶ƒ£∞Â£∫rpt_06_003
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140619
--–ﬁ∏ƒ»À£∫Õıø…º—
--–ﬁ∏ƒƒ⁄»›£∫1>÷ÿΩ®¡Ÿ ±±Ìt#op_err_deal_result(line_id,station_id,linename,tr_type_id,tr_type_name,sys_type,error_id,errorname,error_num)£ª
          --2>‘≠ º ˝æ›∫Õ¥ÌŒÛ∂‘’’±Ì∑÷ø™≤È—Ø
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140619
--–ﬁ∏ƒ»À£∫lili
--–ﬁ∏ƒƒ⁄»›£∫÷ÿΩ®¥ÌŒÛ∂‘’’±Ì£®st_cod_sys_error∏ƒŒ™st_cod_error£©°£
   -------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140619(17µ„10∑÷)
--–ﬁ∏ƒ»À£∫Õıø…º—
--–ﬁ∏ƒƒ⁄»›£∫1>÷ÿΩ®¡Ÿ ±±Ìt#op_err_deal_result(line_id,line_name,station_id,station_name,tr_type_id,tr_type_name,error_id,error_name,error_num)£ª
          --2>÷–º‰±Ìst_sts_except_balance‘ˆº”µÿÃ˙ø®‘⁄π´Ωªµƒ“Ï≥£Ωª“◊ ˝æ›£®line_id=°Æ00°Ø£©£®by lili£©
          --3>÷ÿ–¬µ˜’˚ƒ£∞Ârpt_06_003°£
--------------------------------------------------------------------------------
   (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_lineCode CHAR(2);
   v_squadDay VARCHAR(8);
   v_balanceday VARCHAR(8);
BEGIN
   v_squadDay := substr(in_squad_day,1,8);
   v_balanceday := SUBSTR(in_balance_day, 1, 8);
--------------------------------------------------------------------------------------------------
--20140619∏¸∏ƒ«∞ƒ⁄»›£∫
  /*insert into  t#op_err_deal_result
        select         a.line_id,
                       a.line_id||a.station_id||c.line_name||d.chinese_name,
                       a.tr_type_id,
                       a.error_id||b.err_desc,
                       sum(nvl(a.deal_num,0)  )
   from st_sts_except_balance a,st_cod_sys_error b,op_prm_line c,op_prm_station d
   where a.line_id=c.line_id and c.record_flag='0'
     and a.line_id=d.line_id and a.station_id=d.station_id and d.record_flag='0'
     and substr(a.balance_water_no,1,8)=v_balanceday
     and a.sys_type='01'
     and a.error_id=b.err_code
    group by  a.line_id,
              a.station_id,
              c.line_name,
              d.chinese_name,
              a.tr_type_id,
              a.error_id,
              b.err_desc;*/
 --------------------------------------------------------------------------------------------------
--20140619∏¸∏ƒƒ⁄»›£∫
  ----œÚΩ·π˚ºØµº»Î ˝æ›
   insert into  t#op_err_deal_result(line_id,line_name,station_id,station_name,tr_type_id,tr_type_name,error_id,error_name,error_num)
            select a.line_id,'',a.station_id,'',a.tr_type_id,'',a.error_id,a.error_id,a.deal_num
                   from st_sts_except_balance a
            where substr(a.balance_water_no,1,8)=v_balanceday;
  --∏¸–¬≤…ºØµ„√˚
   update t#op_err_deal_result c set c.line_name=(
           select a.line_name from op_prm_line a
           where a.record_flag='0' and a.line_id=c.line_id)
        where exists (select 1 from op_prm_line a
           where a.record_flag='0' and a.line_id=c.line_id);
   update t#op_err_deal_result c set c.station_name=(
           select '-'||a.chinese_name from op_prm_station a
           where a.record_flag='0' and a.line_id=c.line_id and a.station_id=c.station_id)
        where exists (select 1 from op_prm_station a
           where a.record_flag='0' and a.line_id=c.line_id and a.station_id=c.station_id);
   ----∏¸–¬≤…ºØµ„--π´Ωª
   update t#op_err_deal_result c set c.line_name='π´Ωª' where line_id='00';
   update t#op_err_deal_result c set c.station_id='00' where line_id='00';
   update t#op_err_deal_result c set c.station_name='' where line_id='00';


    --∏¸–¬“Ï≥£‘≠“Ú
    --£®¥ÌŒÛ∂‘’’±Ìst_cod_sys_error∏ƒŒ™st_cod_error£©
    update t#op_err_deal_result c set c.error_name=(
            select b.err_desc from st_cod_error b where c.error_id=b.err_code)
        where exists (select 1 from st_cod_error b where c.error_id=b.err_code);
--------------------------------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ

OPEN out_cursor for
   select v_balanceday||v_squadDay balance_day,line_id||station_id||line_name||station_name as location,error_name,
                       sum(nvl(error_num,0)) error_num
   FROM t#op_err_deal_result
   group by line_id,station_id,line_name,station_name,error_name
   ORDER BY line_id,station_id,line_name,station_name,error_name;
END;
/
grant execute on ACC_ST.UP_OP_ERR_DEAL_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_ERR_DEAL_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_ERR_DEV_DAY
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_ERR_DEV_DAY
   ---------------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_op_rp_error_day
   --π¶ƒ‹√Ë ˆ£∫œµÕ≥…Ë±∏π ’œ‘¬±®
   --–ﬁ∏ƒ’ﬂ£∫  Õıø…º—
   --–ﬁ∏ƒ»’∆⁄£∫2013-07-30
   --∂‘”¶ƒ£∞Â£∫rpt_07_001
   -------------------------------------------------------------------------------
(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
As
   v_squadday VARCHAR(8);
   v_balanceday VARCHAR(8);
BEGIN
   v_squadday := substr(in_squad_day,1,8);
   v_balanceday := SUBSTR(in_balance_day, 1, 8);

   INSERT
   INTO t#op_err_dev_result
   SELECT a.line_id,
      a.station_id,
      a.dev_type_id,
      a.device_id,
      COUNT(a.status_datetime)
   FROM acc_commu.CM_DEV_ERROR_STATUS a
   WHERE TO_CHAR(status_datetime, 'yyyymmdd') = v_squadday
   group by a.line_id,a.station_id,a.dev_type_id,a.device_id;
 ----∏¸–¬’æµ„÷–Œƒ√˚
 update t#op_err_dev_result a set a.line_name=(
   select b.line_name from op_prm_line b
     where a.line_name=b.line_id and b.record_flag='0')
 where EXISTS (select 1 from op_prm_line b
      where a.line_name=b.line_id and b.record_flag='0');

  update t#op_err_dev_result a set a.chinese_name=(
   select b.chinese_name from op_prm_station b
     where a.line_name=b.line_id and a.chinese_name=b.station_id and b.record_flag='0')
 where EXISTS (select 1 from op_prm_station b
     where a.line_name=b.line_id and a.chinese_name=b.station_id and b.record_flag='0');
   /*INSERT
   INTO t#op_err_dev_result
   SELECT c.sequence||c.line_name,
      b.sequence||b.chinese_name,
      a.dev_type_id,
      a.device_id,
      COUNT(a.status_datetime)
   FROM acc_commu.CM_DEV_ERROR_STATUS a, op_prm_station b, op_prm_line c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = c.line_id)
   AND (b.belong_line_id = c.line_id
   AND c.record_flag = '0')
   AND TO_CHAR(status_datetime, 'yyyymmdd') = v_squadday
   GROUP BY c.sequence,c.line_name, b.sequence, b.chinese_name, a.dev_type_id, a.device_id;
 */
 /*---∫œº∆
   INSERT
   INTO t#op_err_dev_result
   SELECT '99∫œº∆',
      NULL,
      NULL,
      NULL,
      COUNT(status_datetime)
   FROM OP_CM_DEV_ERROR_STATUS a, ic_cod_line_code b
   WHERE TO_CHAR(status_datetime, 'yyyymmdd') = v_squadday
   AND (a.line_id = b.line_id
   AND b.record_flag = '0');*/
   OPEN out_cursor FOR
   SELECT A.line_name,
      A.chinese_name as station_name,
      A.dev_type_id,
      A.device_id,
      A.num,
      v_balanceday day
   FROM t#op_err_dev_result A
   ORDER BY A.line_name,a.chinese_name,a.dev_type_id,a.device_id;
END;
/
grant execute on ACC_ST.UP_OP_ERR_DEV_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_ERR_DEV_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_ERR_DEV_MON
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_ERR_DEV_MON
   ---------------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_op_rp_error_mon
   --π¶ƒ‹√Ë ˆ£∫œµÕ≥…Ë±∏π ’œ‘¬±®
   --–ﬁ∏ƒ’ﬂ£∫  Õıø…º—
   --–ﬁ∏ƒ»’∆⁄£∫2013-07-30
   --∂‘”¶ƒ£∞Â£∫rpt_07_002
   -------------------------------------------------------------------------------
(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
As
   v_squadday VARCHAR(6);
   v_balanceday VARCHAR(6);
BEGIN
   v_squadday := substr(in_squad_day,1,6);
   v_balanceday := SUBSTR(in_balance_day, 1, 6);

   INSERT
   INTO t#op_err_dev_result
   SELECT a.line_id,
      a.station_id,
      a.dev_type_id,
      a.device_id,
      COUNT(a.status_datetime)
   FROM acc_commu.CM_DEV_ERROR_STATUS a
   WHERE TO_CHAR(status_datetime, 'yyyymm') = v_squadday
   group by a.line_id,a.station_id,a.dev_type_id,a.device_id;
 ----∏¸–¬’æµ„÷–Œƒ√˚
 update t#op_err_dev_result a set a.line_name=(
   select b.line_name from op_prm_line b
     where a.line_name=b.line_id and b.record_flag='0')
 where EXISTS (select 1 from op_prm_line b
      where a.line_name=b.line_id and b.record_flag='0');

  update t#op_err_dev_result a set a.chinese_name=(
   select b.chinese_name from op_prm_station b
     where a.line_name=b.line_id and a.chinese_name=b.station_id and b.record_flag='0')
 where EXISTS (select 1 from op_prm_station b
     where a.line_name=b.line_id and a.chinese_name=b.station_id and b.record_flag='0');
   /*INSERT
   INTO t#op_err_dev_result
   SELECT c.sequence||c.line_name,
      b.sequence||b.chinese_name,
      a.dev_type_id,
      a.device_id,
      COUNT(a.status_datetime)
   FROM OP_CM_DEV_ERROR_STATUS a, op_prm_station b, op_prm_line c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = c.line_id)
   AND (b.belong_line_id = c.line_id
   AND c.record_flag = '0')
   AND TO_CHAR(status_datetime, 'yyyymm') = v_squadday
   GROUP BY c.line_name,c.sequence, b.chinese_name,b.sequence, a.dev_type_id, a.device_id, a.line_id;
 */
 /*---∫œº∆
   INSERT
   INTO t#op_err_dev_result
   SELECT '99∫œº∆',
      NULL,
      NULL,
      NULL,
      COUNT(status_datetime)
   FROM OP_CM_DEV_ERROR_STATUS a, ic_cod_line_code b
   WHERE TO_CHAR(status_datetime, 'yyyymm') = v_squadday
   AND (a.line_id = b.line_id
   AND b.record_flag = '0');*/
   OPEN out_cursor FOR
   SELECT A.line_name,
      A.chinese_name as station_name,
      A.dev_type_id,
      A.device_id,
      A.num,
      v_balanceday day
   FROM t#op_err_dev_result A
   ORDER BY A.line_name,a.chinese_name,a.dev_type_id,a.device_id;
END;
/
grant execute on ACC_ST.UP_OP_ERR_DEV_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_ERR_DEV_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_ERR_SAM
prompt ================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_ERR_SAM
---------------------------------------------------------------------------------
--π¶ƒ‹£∫SAM ø®–£—È“Ï≥£»’±®±Ì
--¥¥Ω®£∫Õıø…º—
-- ±º‰£∫20130710
(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
v_squadDay varchar(8);
v_balanceday varchar(8);
    BEGIN
v_squadDay:=substr(in_squad_day,1,8);
v_balanceday:=substr(in_balance_day,1,8);
  insert into  t#op_err_sam_result
        select
              a.SAM_LOGICAL_ID,
              c.sequence||c.line_name,
              c.sequence||b.sequence||b.chinese_name,
              a.dev_type_id,
              a.device_id,
              sum(a.total_deal_num),
              max(a.sam_trade_seq_end)
    from st_act_sam a,op_prm_station b,op_prm_line c
    where a.line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0'
          and a.line_id=c.line_id and c.record_flag='0'
      group by
        a.sam_logical_id,
        c.line_name,
        c.sequence,
        b.sequence,
        b.chinese_name,
        a.dev_type_id,
        a.device_id;
        OPEN out_cursor FOR
select sam_no, line_name, station_name, dev_type_id, device_id,sys_num,sam_num,v_squadDay||v_balanceDay day from t#op_err_sam_result
       order by sam_no, line_name, station_name, dev_type_id, device_id;
end;
/
grant execute on ACC_ST.UP_OP_ERR_SAM to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_ERR_SAM to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_MOB_PAY_D
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_MOB_PAY_D (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_MOB_PAY_D
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--“∆∂Ø∏∂∑—«Â∑÷Ω·π˚»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ≈∑—ÙŒ¬‹ﬂ
  --¥¥Ω®»’∆⁄£∫20130908
  --±®±Ì±‡∫≈£∫04-006
  --¡Ÿ ±±Ì£∫t#op_res_city_rpt,t#op_res_city_result
  --–ﬁ∏ƒ¥Ê¥¢π˝≥Ã√˚£∫UP_OP_EST_DIS_MOB_PAY_D
  --∂‘”¶ƒ£∞Â£∫rpt_04_006
-------------------------------------------------------------------------------
 as
    v_balance_day varchar(8);
---------------------------------------------------------------------------------
begin
    v_balance_day:=substr(in_balance_day,1,8);
----≤È—Ø‘≠ º ˝æ›
  insert into t#op_res_city_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where sys_type='02' and out_deal_type='17' and substr(balance_water_no,1, 8) = v_balance_day;
----out_deal_type=v_deal_type≥‰÷µ'13'≥Â’˝'12'ø€øÓ£¨sys_type='01'µÿÃ˙∆±,sys_type='02'≥« –Õ®∆±
---------------------------------------------------------------------------------
  --œ˚∑—
  insert into t#op_mob_pay_result
  select sum(out_affirm_num),sum(out_affirm_fee) from t#op_res_city_rpt
  where out_deal_type='17' and sys_type='02';
--∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           sum(consume_num) consume_num,
           sum(consume_fee) consume_fee
      from t#op_mob_pay_result;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_MOB_PAY_DIS
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_MOB_PAY_DIS (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_MOB_PAY_DIS
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥« –Õ®ø®«Â∑÷Ω·π˚≤Ó“ÏÕ≥º∆‘¬±®±Ì°™ø€÷µ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20130806
  --±®±Ì±‡∫≈£∫rpt_04_009
  --◊¢ Õ:
  --¡Ÿ ±±Ì£∫t#op_mob_pay_rec_rpt,T#OP_mob_pay_rec_res,
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
 is
  v_balance_month varchar(8);
  v_max_day    integer;
  v_ii         integer;
  v_deal_type  char(2); --'14'  ≥‰÷µ °¢'12' ø€÷µ
BEGIN
  v_balance_month := substr(in_balance_day, 1, 6);
  v_deal_type  := '12';
----------------------------------------------------------------------------------
--ππΩ®Ω·π˚ºØΩ·ππ
  select max(to_number(substr(balance_water_no, 7, 2)))
    into v_max_day
    from st_sts_diff_analysis
   where sys_type = '01'
     and substr(balance_water_no, 7, 2) = v_balance_month;
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into T#OP_mob_pay_rec_res
    values
      (v_ii,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
	   0,
       0,
       0,
       0,
       0);
    v_ii := v_ii + 1;
  end loop;
----------------------------------------------------------------------------------
--≤È—Ø ˝æ›
  insert into t#op_mob_pay_rec_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
           from st_sts_diff_analysis
     where substr(balance_water_no,1,6) = v_balance_month
       and out_deal_type=v_deal_type;
       --sys_type='01'µÿÃ˙,sys_type='02'≥« –Õ®
----------------------------------------------------------------------------------
    ----µÿÃ˙ACCÀÕ≥ˆ
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        sum(acc_send_num ),sum(acc_send_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        group by substr(balance_water_no,1,6);
	----“ªø®Õ®»∑»œ
    insert into  T#OP_mob_pay_rec_res
   select substr(balance_water_no,1,6),
        0,0,sum(out_affirm_num ),sum(out_affirm_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        group by substr(balance_water_no,1,6);
	----≤Ó“Ï
    insert into  T#OP_mob_pay_rec_res
       select substr(balance_water_no,1,6),
        0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        group by substr(balance_water_no,1,6);
	----TAC¥Ì
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='12'
		--20160222 modify by mqf 
		and error_id='01'
        group by substr(balance_water_no,1,6);
	----÷ÿ∏¥
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
 0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0
        from T#OP_mob_pay_rec_rpt
 where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='13'
		--20160222 modify by mqf 
		and error_id='02'
        group by substr(balance_water_no,1,6);
	----∑«∑®ø®∫≈
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
      from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='14'
		--20160222 modify by mqf 
		and error_id='15'
        group by substr(balance_water_no,1,6);
	----∑«∑®SAM	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='15'
		--20160222 modify by mqf 
		and error_id='14'
        group by substr(balance_water_no,1,6);
	-----∑«∑® ±º‰
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,
        0,0,0,0
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='16'
		--20160222 modify by mqf 
		and error_id='13'
        group by substr(balance_water_no,1,6);
    ----Œƒº˛ƒ⁄÷ÿ∏¥	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='17'
		--20160222 modify by mqf 
		and error_id='000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
        group by substr(balance_water_no,1,6);
   ----Ωª“◊¿‡–Õ¥ÌŒÛ	
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='18'
		--20160222 modify by mqf 
		and error_id='10'
        group by substr(balance_water_no,1,6);
   ----∆±ø®”‡∂Ó∑«∑®	
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='19'
		--20160222 modify by mqf 
		and error_id='11'
        group by substr(balance_water_no,1,6);
 ----Œ¥÷™	
 insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        and error_id='99'
        group by substr(balance_water_no,1,6);
   ----“—ÕÀøÓø®¥ÌŒÛ --20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    sum(error_num ),sum(error_fee),0,0
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
		and error_id='16'
        group by substr(balance_water_no,1,6);
   ----∫⁄√˚µ•¥ÌŒÛ --20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    0,0,sum(error_num ),sum(error_fee)
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
		and error_id='17'
        group by substr(balance_water_no,1,6);
    -----------chongzheng ≥Â’˝
	  ----µÿÃ˙ACCÀÕ≥ˆ
      insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
       sum(acc_send_num ),sum(acc_send_fee)*(-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        group by substr(balance_water_no,1,6);
	----“ªø®Õ®»∑»œ
    insert into  T#OP_mob_pay_rec_res
       select substr(balance_water_no,1,6),
        0,0,sum(out_affirm_num ),sum(out_affirm_fee)*(-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0  ,0,0,0,0,0,0,
		0,0,0,0
      from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        group by substr(balance_water_no,1,6);
	----≤Ó“Ï
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,sum(error_num  ),sum(error_fee)*(-1),0,0,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where  sys_type='01'  and out_deal_type='13'
        group by substr(balance_water_no,1,6);
	----TAC¥Ì
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
   0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
        0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where  sys_type='01'  and out_deal_type='13'
        --and error_id='12'
		--20160222 modify by mqf 
		and error_id='01'
        group by substr(balance_water_no,1,6);
	----÷ÿ∏¥
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
       from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        --and error_id='13'
		--20160222 modify by mqf 
		and error_id='02'
        group by substr(balance_water_no,1,6);
	----∑«∑®ø®∫≈
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        --and error_id='14'
	    --20160222 modify by mqf 
	    and error_id='15'
        group by substr(balance_water_no,1,6);
	----∑«∑®SAM
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        --and error_id='15'
		--20160222 modify by mqf 
	    and error_id='14'
 group by substr(balance_water_no,1,6);
    -----∑«∑® ±º‰
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1) ,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        --and error_id='16'
		--20160222 modify by mqf 
	    and error_id='13'
        group by substr(balance_water_no,1,6);
   ----Œƒº˛ƒ⁄÷ÿ∏¥
   insert into  T#OP_mob_pay_rec_res
     select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0 ,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
       --and error_id='17'
       --20160222 modify by mqf 
	    and error_id='000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
        group by substr(balance_water_no,1,6);
   ----Ωª“◊¿‡–Õ¥ÌŒÛ
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        --and error_id='18'
		--20160222 modify by mqf 
	    and error_id='10'
        group by substr(balance_water_no,1,6);
   ----∆±ø®”‡∂Ó∑«∑®
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
    where   sys_type='01'  and out_deal_type='13'
        --and error_id='19'
		--20160222 modify by mqf 
	    and error_id='11'
        group by substr(balance_water_no,1,6);
 ----Œ¥÷™
 insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        and error_id='99'
        group by substr(balance_water_no,1,6);
   ----“—ÕÀøÓø®¥ÌŒÛ --20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    sum(error_num ),sum(error_fee)*(-1),0,0
        from T#OP_mob_pay_rec_rpt
    where   sys_type='01'  and out_deal_type='13'
	    and error_id='16'
        group by substr(balance_water_no,1,6);
   ----∫⁄√˚µ•¥ÌŒÛ --20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,1,6),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    0,0,sum(error_num ),sum(error_fee)*(-1)
        from T#OP_mob_pay_rec_rpt
    where   sys_type='01'  and out_deal_type='13'
	    and error_id='17'
        group by substr(balance_water_no,1,6);
		
  open out_cur_arg for
    select v_balance_month bala_day,
           day,
           sum(acc_num) acc_num,
           sum(acc_fee) acc_fee,
           sum(cs_city_num) cs_city_num,
           sum(cs_city_fee) cs_city_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(test_num) test_num,
           sum(test_fee) test_fee,
		   sum(returncard_num) returncard_num, --20160222 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
      from T#OP_mob_pay_rec_res
     group by day
     order by day;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_DIS to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_DIS to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_MOB_PAY_M
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_MOB_PAY_M (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_MOB_PAY_M
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--“∆∂Ø∏∂∑—«Â∑÷Ω·π˚‘¬±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ wangkejia
  --¥¥Ω®»’∆⁄£∫201309015
  --±®±Ì±‡∫≈£∫02-006
  --¡Ÿ ±±Ì£∫t#op_res_city_rpt,t#op_mob_pay_result
  --∂‘”¶ƒ£∞Â£∫rpt_04_006
  -------------------------------------------------------------------------------
as
    v_balance_day varchar(6);
---------------------------------------------------------------------------------
begin
    v_balance_day:=substr(in_balance_day,1,6);
----≤È—Ø‘≠ º ˝æ›
  insert into t#op_res_city_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where sys_type='02' and out_deal_type='12' and substr(balance_water_no,1,6) = v_balance_day;
----com_file_name—πÀıŒƒº˛√˚≥∆,card_type='0'≥« –Õ®∆±£¨out_deal_type=v_deal_type≥‰÷µ'13'≥Â’˝'12'ø€øÓ£¨sys_type='01'µÿÃ˙∆±,sys_type='02'≥« –Õ®∆±
---------------------------------------------------------------------------------
  --œ˚∑—
  open out_cur_arg for
    select v_balance_day balance_day,
           sum(consume_num) consume_num,
           sum(consume_fee) consume_fee
      from t#op_mob_pay_result;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_MOB_PAY_REC
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_MOB_PAY_REC (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_MOB_PAY_REC
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥« –Õ®ø®«Â∑÷Ω·π˚≤Ó“ÏÕ≥º∆‘¬±®±Ì°™≥‰÷µ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20130806
  --±®±Ì±‡∫≈£∫rpt_04_008
  --◊¢ Õ:
  --¡Ÿ ±±Ì£∫t#op_mob_pay_rec_rpt,T#OP_mob_pay_rec_res,
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_max_day    integer;
  v_ii         integer;
  v_deal_type  char(2); --'14'  ≥‰÷µ °¢'12' ø€÷µ
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
  v_deal_type  := '14';
---------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from st_sts_diff_analysis
   where sys_type = '01'
     and substr(balance_water_no,1,6) = v_balance_day;
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into T#OP_mob_pay_rec_res
    values
      (v_ii,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
	   0,
       0,
       0,
       0,
       0);
    v_ii := v_ii + 1;
  end loop;
---------------------------------------------------------------------------
----≤È—Ø ˝æ›
----out_deal_type='14'≥‰÷µ'13'≥Â’˝'12'ø€øÓ£¨sys_type='01'µÿÃ˙∆±,sys_type='02'≥« –Õ®∆±
---------------------------------------------------------------------------
  insert into t#op_mob_pay_rec_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where substr(balance_water_no,1,6) = v_balance_day
       and sys_type='01'
       and out_deal_type=v_deal_type;
 -----------------------------------------------------------------------------------
    ----µÿÃ˙ACCÀÕ≥ˆ
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        sum(acc_send_num ),sum(acc_send_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        group by substr(balance_water_no,7,2);
	----“ªø®Õ®»∑»œ
    insert into  T#OP_mob_pay_rec_res
   select substr(balance_water_no,7,2),
        0,0,sum(out_affirm_num ),sum(out_affirm_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        group by substr(balance_water_no,7,2);
	----≤Ó“Ï	
    insert into  T#OP_mob_pay_rec_res
       select substr(balance_water_no,7,2),
        0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        group by substr(balance_water_no,7,2);
	----TAC¥Ì	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='12'
		--20160222 modify by mqf 
		and error_id='01'
        group by substr(balance_water_no,7,2);
	----÷ÿ∏¥	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
 0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0
        from T#OP_mob_pay_rec_rpt
 where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='13'
		--20160222 modify by mqf 
		and error_id='02'
        group by substr(balance_water_no,7,2);
	----∑«∑®ø®∫≈	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
      from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='14'
		--20160222 modify by mqf 
		and error_id='15'
        group by substr(balance_water_no,7,2);
	----∑«∑®SAM	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='15'
		--20160222 modify by mqf 
		and error_id='14'
        group by substr(balance_water_no,7,2);
	-----∑«∑® ±º‰	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
  0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,0,0,
        0,0,0,0
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='16'
		--20160222 modify by mqf 
		and error_id='13'
        group by substr(balance_water_no,7,2);
	----Œƒº˛ƒ⁄÷ÿ∏¥	
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='17'
		--20160222 modify by mqf 
		and error_id='000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
        group by substr(balance_water_no,7,2);
   ----Ωª“◊¿‡–Õ¥ÌŒÛ		
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='18'
		--20160222 modify by mqf 
		and error_id='10'
        group by substr(balance_water_no,7,2);
   ----∆±ø®”‡∂Ó∑«∑®		
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),0,0,
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
        --and error_id='19'
		--20160222 modify by mqf 
		and error_id='11'
        group by substr(balance_water_no,7,2);
 ----Œ¥÷™		
 insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee),
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type=v_deal_type
        and error_id='99'
        group by substr(balance_water_no,7,2);
   ----“—ÕÀøÓø®¥ÌŒÛ	--20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    sum(error_num ),sum(error_fee),0,0
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
		and error_id='16'
        group by substr(balance_water_no,7,2);	
   ----∫⁄√˚µ•¥ÌŒÛ --20160222 add by mqf	
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    0,0,sum(error_num ),sum(error_fee)
        from T#OP_mob_pay_rec_rpt
   where   sys_type='01'  and out_deal_type=v_deal_type
		and error_id='17'
        group by substr(balance_water_no,7,2);
    -----------≥Â’˝
	  ----µÿÃ˙ACCÀÕ≥ˆ
      insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
       sum(acc_send_num ),sum(acc_send_fee)*(-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        group by substr(balance_water_no,7,2);
	----“ªø®Õ®»∑»œ
    insert into  T#OP_mob_pay_rec_res
       select substr(balance_water_no,7,2),
        0,0,sum(out_affirm_num ),sum(out_affirm_fee)*(-1),0,0,0,0,0,0,0,0,0,0,0,0,0,0  ,0,0,0,0,0,0,
		0,0,0,0
      from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        group by substr(balance_water_no,7,2);
	----≤Ó“Ï
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,sum(error_num  ),sum(error_fee)*(-1),0,0,0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where  sys_type='01'  and out_deal_type='13'
        group by substr(balance_water_no,7,2);
	----TAC¥Ì
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
   0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
        0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where  sys_type='01'  and out_deal_type='13'
        --and error_id='12'
		--20160222 modify by mqf 
		and error_id='01'
        group by substr(balance_water_no,7,2);
	----÷ÿ∏¥
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
       from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        --and error_id='13'
		--20160222 modify by mqf 
		and error_id='02'
        group by substr(balance_water_no,7,2);
	----∑«∑®ø®∫≈
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
      --and error_id='14'
	  --20160222 modify by mqf 
	  and error_id='15'
        group by substr(balance_water_no,7,2);
	----∑«∑®SAM
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
        where   sys_type='01'  and out_deal_type='13'
        --and error_id='15'
		--20160222 modify by mqf 
	    and error_id='14'
 group by substr(balance_water_no,7,2);
    -----∑«∑® ±º‰
    insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1) ,0,0 ,0,0,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        --and error_id='16'
		--20160222 modify by mqf 
	    and error_id='13'
        group by substr(balance_water_no,7,2);
   ----Œƒº˛ƒ⁄÷ÿ∏¥
   insert into  T#OP_mob_pay_rec_res
     select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0 ,0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        --and error_id='17'
		--20160222 modify by mqf 
	    and error_id='000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
        group by substr(balance_water_no,7,2);
   ----Ωª“◊¿‡–Õ¥ÌŒÛ
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,0,0,
		0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        --and error_id='18'
		--20160222 modify by mqf 
	    and error_id='10'
        group by substr(balance_water_no,7,2);
   ----∆±ø®”‡∂Ó∑«∑®
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),0,0,
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
    where   sys_type='01'  and out_deal_type='13'
        --and error_id='19'
		--20160222 modify by mqf 
	    and error_id='11'
        group by substr(balance_water_no,7,2);
 ----Œ¥÷™
 insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(error_num ),sum(error_fee)*(-1),
	    0,0,0,0
        from T#OP_mob_pay_rec_rpt
       where   sys_type='01'  and out_deal_type='13'
        and error_id='99'
        group by substr(balance_water_no,7,2);
   ----“—ÕÀøÓø®¥ÌŒÛ --20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    sum(error_num ),sum(error_fee)*(-1),0,0
        from T#OP_mob_pay_rec_rpt
    where   sys_type='01'  and out_deal_type='13'
	    and error_id='16'
        group by substr(balance_water_no,7,2);
   ----∫⁄√˚µ•¥ÌŒÛ --20160222 add by mqf
   insert into  T#OP_mob_pay_rec_res
        select substr(balance_water_no,7,2),
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
	    0,0,sum(error_num ),sum(error_fee)*(-1)
        from T#OP_mob_pay_rec_rpt
    where   sys_type='01'  and out_deal_type='13'
	    and error_id='17'
        group by substr(balance_water_no,7,2);
-----------------------------------------------------------------------------------
/*--‘¬◊‹º∆
insert into  T#OP_mob_pay_rec_res
        select '◊‹º∆',
           sum(acc_num),
           sum(acc_fee),
           sum(cs_city_num),
           sum(cs_city_fee),
           sum(diff_num),
           sum(diff_fee),
           sum(tac_num),
           sum(tac_fee),
           sum(repeat_num),
           sum(repeat_fee),
           sum(nocard_num),
           sum(nocard_fee),
           sum(nosam_num),
           sum(nosam_fee),
           sum(notime_num),
           sum(notime_fee),
           sum(filere_num),
           sum(filere_fee),
           sum(dealerr_num),
           sum(dealerr_fee),
           sum(balance_num),
           sum(balance_fee),
           sum(test_num),
           sum(test_fee)
        from T#OP_mob_pay_rec_res;
        */
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day bala_day,
           day,
           sum(acc_num) acc_num,
           sum(acc_fee) acc_fee,
           sum(cs_city_num) cs_city_num,
           sum(cs_city_fee) cs_city_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(test_num) test_num,
           sum(test_fee) test_fee,
		   sum(returncard_num) returncard_num, --20160222 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
      from T#OP_mob_pay_rec_res
     group by day
     order by day;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_REC to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_MOB_PAY_REC to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_BUS_DIS
prompt ============================================
prompt
create or replace procedure acc_st.UP_OP_EST_DIS_RES_BUS_DIS(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_BUS_DIS
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--µÿÃ˙ø®π´Ωªœ˚∑—«Â∑÷Ω·π˚±®±Ì--ø€øÓ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20140422
  --±®±Ì±‡∫≈£∫04-010
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫Õıø…º—
  --∏¸∏ƒ»’∆⁄£∫20140703
  --∏¸∏ƒƒ⁄»›£∫‘⁄√ø‘¬“ª∫≈º”»Î…œ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›£ª
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫÷”◊”∆Ê
  --∏¸∏ƒ»’∆⁄£∫201604115
  --∏¸∏ƒƒ⁄»›£∫‘ˆº”…œ—Æ–°º∆ ÷–—Æ–°º∆ œ¬—Æ–°º∆
  -------------------------------------------------------------------------------
 as
  v_balance_day varchar(8);
  v_err_num  int;
  v_err_fee  int;
  v_max_day    integer;
  v_ii         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 8);

--------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ

  v_max_day:=substr(v_balance_day,7,2);
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into t#op_04_004_result
    values
      (substr(v_balance_day,1,6)||lpad(v_ii,2,0),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
     0,
       0,
       0,
       0,
       0);
       
     
    v_ii := v_ii + 1;
  end loop;

--------------------≤È—Ø‘≠ º ˝æ›-----------------------
--µÿÃ˙»∑»œ(◊‹ ˝)
----------------------------------------------------------------
--∏¸∏ƒƒ⁄»›
--»Áπ˚ «‘¬≥ı£¨‘Úµº»Î…œ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›
--µÿÃ˙»∑»œ ˝æ›
if substr(v_balance_day,7,2)='01' then
insert into T#OP_bus_diff_rpt2
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)
     from st_sts_mtr_audit_balance
     where substr(balance_water_no,1,8)=to_char(last_day(add_months(to_date(v_balance_day,'yyyymmdd'),-1)),'yyyymmdd')
        and pay_mode_id ='11'
     group by balance_water_no;
     --¥ÌŒÛ(∞¥¥ÌŒÛ¿‡–ÕÕ≥º∆)
 insert into t#op_bus_diff_rpt1 a
 select balance_water_no,
        err_code,
        count(*),
        sum(deal_fee)
   from st_ext_mtr_err_deal
     where substr(balance_water_no,1,8)=to_char(last_day(add_months(to_date(v_balance_day,'yyyymmdd'),-1)),'yyyymmdd')
        and pay_mode_id ='11'
   group by balance_water_no,err_code;
end if;
----------------------------------------------------------------
--µÿÃ˙»∑»œ
  insert into T#OP_bus_diff_rpt2
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)
     from st_sts_mtr_audit_balance
     where substr(balance_water_no,1,6) = substr(v_balance_day,1,6)
        and substr(balance_water_no,7,2)<=substr(v_balance_day,7,2)
        and pay_mode_id ='11'
     group by balance_water_no;
--¥ÌŒÛ(∞¥¥ÌŒÛ¿‡–ÕÕ≥º∆)
 insert into t#op_bus_diff_rpt1 a
 select balance_water_no,
        err_code,
        count(*),
        sum(deal_fee)
   from st_ext_mtr_err_deal
     where substr(balance_water_no,1,6) = substr(v_balance_day,1,6)
        and substr(balance_water_no,7,2)<=substr(v_balance_day,7,2)
        and pay_mode_id ='11'
   group by balance_water_no,err_code;

 update  t#op_bus_diff_rpt1 a set err_code=(
      select b.err_code_ext from st_cfg_err_acc_ext b where a.err_code=b.err_code_acc)
    where exists (select 1 from st_cfg_err_acc_ext b where a.err_code=b.err_code_acc);
--select*from acc_st_dev.st_ext_mtr_err_deal;
--select*from acc_st_dev.st_cfg_err_acc_ext;
--------------------------π´ΩªÀÕ≥ˆ(◊‹ ˝)-------------------------------
--µÿÃ˙»∑»œ◊‹º∆
insert into t#op_bus_diff_rpt3
  select balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee
   from t#op_bus_diff_rpt2;
 --¥ÌŒÛ◊‹º∆
insert into t#op_bus_diff_rpt3
  select b.balance_water_no,
     '99',
     sum(b.err_num),
     sum(b.err_fee)
   from t#op_bus_diff_rpt1 b
   group by b.balance_water_no;

---------------------------------------------------------------------------------
  --µº»ÎΩ·π˚ºØ
  ----µÿÃ˙ACCÀÕ≥ˆ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from t#op_bus_diff_rpt3
      group by to_number(substr(balance_water_no,1,8));
  ------“ªø®Õ®»∑»œ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt2
      group by to_number(substr(balance_water_no,1,8));
      ----≤Ó“Ï
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      group by to_number(substr(balance_water_no,1,8));
      ----TAC¥Ì
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '01'
     group by to_number(substr(balance_water_no,1,8));
     ----÷ÿ∏¥
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '02'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®ø®∫≈
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code= '15'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®SAM
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code= '14'
     group by to_number(substr(balance_water_no,1,8));
     -----∑«∑® ±º‰
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '13'
     group by to_number(substr(balance_water_no,1,8));
     ----Œƒº˛ƒ⁄÷ÿ∏¥
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      --where  err_code = '17'--≤ª»∑∂®
    --20160219 modify by mqf
    where  err_code = '000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
     group by to_number(substr(balance_water_no,1,8));
     ----Ωª“◊¿‡–Õ¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '10'
     group by to_number(substr(balance_water_no,1,8));
     ----∆±ø®”‡∂Ó∑«∑®
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '11'
     group by to_number(substr(balance_water_no,1,8));
     ----Œ¥÷™
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
       0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '99'
     group by to_number(substr(balance_water_no,1,8));

   --20160219 add by mqf
   ----“—ÕÀøÓø®¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '16'
     group by to_number(substr(balance_water_no,1,8));

   --20160219 add by mqf
   ----∫⁄√˚µ•¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
       0,
           0,
           sum(err_num),
           sum(err_fee)

      from T#OP_bus_diff_rpt1
      where  err_code = '17'
     group by to_number(substr(balance_water_no,1,8));
     
      --20160415 add by zzq
     ---…œ—ÆÕ≥º∆        
           if(v_max_day >=10) then
           insert into t#op_04_004_result
       select '…œ—Æ–°º∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num,

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where to_number(substr(t#op_04_004_result.day,7,2))<= 10;
           end if;
           
          -- 20160415 add by zzq
          ---÷–—ÆÕ≥º∆     
           if(v_max_day >=20) then
           insert into t#op_04_004_result
       select '÷–—Æ–°º∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num, --20160219 add by mqf

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where to_number(substr(t#op_04_004_result.day,7,2)) > 10 and to_number(substr(t#op_04_004_result.day,7,2)) <= 20;
           end if;
           
            -- 20160415 add by zzq
           ---œ¬—ÆÕ≥º∆    
           if(v_max_day =to_number(substr(to_char(last_day(to_date(v_balance_day,'yyyymmdd')),'yyyymmdd'),7,2))) then
           insert into t#op_04_004_result
       select 'œ¬—Æ–°º∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num, 

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where to_number(substr(t#op_04_004_result.day,7,2)) >20 and to_number(substr(t#op_04_004_result.day,7,2))<= v_max_day; 
           end if;
           
     ----ƒ©––∫œº∆
       insert into t#op_04_004_result
       select '∫œº∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num,

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆');

  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day bala_day,
           day,
           sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num, --20160219 add by mqf

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
      from t#op_04_004_result
     group by day
    order by 
    case day when '…œ—Æ–°º∆' then substr(v_balance_day,0,6)||'109'

                         when '÷–—Æ–°º∆' then substr(v_balance_day,0,6)||'209'

                         when 'œ¬—Æ–°º∆' then substr(v_balance_day,0,6)||'319'

                         when '∫œº∆'     then substr(v_balance_day,0,6)||'329'

                         else day
                         end;

end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_BUS_DIS to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_BUS_DIS to ACC_ST_DEV;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_BUS_DIS to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_BUS_DIS_QRY
prompt ================================================
prompt
create or replace procedure acc_st.UP_OP_EST_DIS_RES_BUS_DIS_QRY(
                                             
											 in_balance_day_begin    varchar,
                                             in_balance_day_end    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_BUS_DIS_QRY
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--µÿÃ˙ø®π´Ωªœ˚∑—«Â∑÷Ω·π˚±®±Ì--ø€øÓ ≤È—Ø
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160420
  --±®±Ì±‡∫≈£∫Œﬁ ‘¥”⁄04-010
  --¡Ÿ ±±Ì£∫T#OP_04_004_QRY_RESULT,T#OP_BUS_DIFF_RPT1_QRY,T#OP_BUS_DIFF_RPT2_QRY,T#OP_BUS_DIFF_RPT3_QRY
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫Õıø…º—
  --∏¸∏ƒ»’∆⁄£∫20140703
  --∏¸∏ƒƒ⁄»›£∫‘⁄√ø‘¬“ª∫≈º”»Î…œ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›£ª
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
 as
  v_balance_day_begin varchar(8);
  v_balance_day_end varchar(8);
  v_balance_day_begin_date date;
  v_balance_day_end_date date;
  v_balance_day_cur_date date;
  v_err_num  int;
  v_err_fee  int;
  v_max_day    integer;
  v_ii         integer;
BEGIN
  --œ»…æ≥˝¡Ÿ ±±Ì ˝æ›
  delete from  T#OP_04_004_QRY_RESULT;
  delete from  T#OP_BUS_DIFF_RPT1_QRY;
  delete from T#OP_BUS_DIFF_RPT2_QRY;
  delete from T#OP_BUS_DIFF_RPT3_QRY;
  
  --v_balance_day := substr(in_balance_day, 1, 8);
  v_balance_day_begin := substr(in_balance_day_begin, 1, 4)||substr(in_balance_day_begin, 6, 2)||substr(in_balance_day_begin, 9, 10);
  v_balance_day_end := substr(in_balance_day_end, 1, 4)||substr(in_balance_day_end, 6, 2)||substr(in_balance_day_end, 9, 10);
  --»’∆⁄¿‡–Õ
  v_balance_day_begin_date := to_date(v_balance_day_begin,'yyyymmdd');
  v_balance_day_end_date := to_date(v_balance_day_end,'yyyymmdd');
--------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
  v_balance_day_cur_date := v_balance_day_begin_date;
  --v_max_day:=substr(v_balance_day,7,2);
  --v_ii := 1;
  while v_balance_day_cur_date <= v_balance_day_end_date loop
    insert into T#OP_04_004_QRY_RESULT
    values
      (--substr(v_balance_day,1,6)||lpad(v_ii,2,0),
	   to_char(v_balance_day_cur_date, 'yyyymmdd'),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
	   0,
       0,
       0,
       0,
       0);
    --v_ii := v_ii + 1;
	v_balance_day_cur_date := v_balance_day_cur_date+1;
  end loop;

--------------------≤È—Ø‘≠ º ˝æ›-----------------------
--µÿÃ˙»∑»œ(◊‹ ˝)
----------------------------------------------------------------
--∏¸∏ƒƒ⁄»›
--»Áπ˚ «‘¬≥ı£¨‘Úµº»Î…œ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›
--µÿÃ˙»∑»œ ˝æ›
/*
if substr(v_balance_day,7,2)='01' then
insert into T#OP_BUS_DIFF_RPT2_QRY
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)
     from st_sts_mtr_audit_balance
     where substr(balance_water_no,1,8)=to_char(last_day(add_months(to_date(v_balance_day,'yyyymmdd'),-1)),'yyyymmdd')
        and pay_mode_id ='11'
     group by balance_water_no;
     --¥ÌŒÛ(∞¥¥ÌŒÛ¿‡–ÕÕ≥º∆)
 insert into T#OP_BUS_DIFF_RPT1_QRY a
 select balance_water_no,
        err_code,
        count(*),
        sum(deal_fee)
   from st_ext_mtr_err_deal
     where substr(balance_water_no,1,8)=to_char(last_day(add_months(to_date(v_balance_day,'yyyymmdd'),-1)),'yyyymmdd')
        and pay_mode_id ='11'
   group by balance_water_no,err_code;
end if;
*/
----------------------------------------------------------------
--µÿÃ˙»∑»œ
  insert into T#OP_BUS_DIFF_RPT2_QRY
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)
     from st_sts_mtr_audit_balance
     where substr(balance_water_no,1,8) >= v_balance_day_begin
        and substr(balance_water_no,1,8)<= v_balance_day_end
        and pay_mode_id ='11'
     group by balance_water_no;
--¥ÌŒÛ(∞¥¥ÌŒÛ¿‡–ÕÕ≥º∆)
 insert into T#OP_BUS_DIFF_RPT1_QRY a
 select balance_water_no,
        err_code,
        count(*),
        sum(deal_fee)
   from st_ext_mtr_err_deal
     where substr(balance_water_no,1,8) >= v_balance_day_begin
        and substr(balance_water_no,1,8)<= v_balance_day_end
        and pay_mode_id ='11'
   group by balance_water_no,err_code;

 update  T#OP_BUS_DIFF_RPT1_QRY a set err_code=(
      select b.err_code_ext from st_cfg_err_acc_ext b where a.err_code=b.err_code_acc)
    where exists (select 1 from st_cfg_err_acc_ext b where a.err_code=b.err_code_acc);
--select*from acc_st_dev.st_ext_mtr_err_deal;
--select*from acc_st_dev.st_cfg_err_acc_ext;
--------------------------π´ΩªÀÕ≥ˆ(◊‹ ˝)-------------------------------
--µÿÃ˙»∑»œ◊‹º∆
insert into T#OP_BUS_DIFF_RPT3_QRY
  select balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee
   from T#OP_BUS_DIFF_RPT2_QRY;
 --¥ÌŒÛ◊‹º∆
insert into T#OP_BUS_DIFF_RPT3_QRY
  select b.balance_water_no,
     '99',
     sum(b.err_num),
     sum(b.err_fee)
   from T#OP_BUS_DIFF_RPT1_QRY b
   group by b.balance_water_no;

---------------------------------------------------------------------------------
  --µº»ÎΩ·π˚ºØ
  ----π´ΩªÀÕ≥ˆ
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT3_QRY
      group by to_number(substr(balance_water_no,1,8));
  ------µÿÃ˙ACC»∑»œ
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT2_QRY
      group by to_number(substr(balance_water_no,1,8));
      ----≤Ó“Ï
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      group by to_number(substr(balance_water_no,1,8));
      ----TAC¥Ì
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '01'
     group by to_number(substr(balance_water_no,1,8));
     ----÷ÿ∏¥
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '02'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®ø®∫≈
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code= '15'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®SAM
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code= '14'
     group by to_number(substr(balance_water_no,1,8));
     -----∑«∑® ±º‰
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '13'
     group by to_number(substr(balance_water_no,1,8));
     ----Œƒº˛ƒ⁄÷ÿ∏¥
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      --where  err_code = '17'--≤ª»∑∂®
	  --20160219 modify by mqf
	  where  err_code = '000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
     group by to_number(substr(balance_water_no,1,8));
     ----Ωª“◊¿‡–Õ¥ÌŒÛ
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '10'
     group by to_number(substr(balance_water_no,1,8));
     ----∆±ø®”‡∂Ó∑«∑®
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '11'
     group by to_number(substr(balance_water_no,1,8));
     ----Œ¥÷™
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
		   0,
           0,
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '99'
     group by to_number(substr(balance_water_no,1,8));
	 
	 --20160219 add by mqf 
	 ----“—ÕÀøÓø®¥ÌŒÛ
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '16'
     group by to_number(substr(balance_water_no,1,8));
	 
	 --20160219 add by mqf 
	 ----∫⁄√˚µ•¥ÌŒÛ
  insert into T#OP_04_004_QRY_RESULT
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
		   0,
           0,
           sum(err_num),
           sum(err_fee)
           
      from T#OP_BUS_DIFF_RPT1_QRY
      where  err_code = '17'
     group by to_number(substr(balance_water_no,1,8));

	 /*
     ----ƒ©––∫œº∆
       insert into T#OP_04_004_QRY_RESULT
       select '∫œº∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
		   sum(returncard_num) returncard_num, --20160219 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
           from T#OP_04_004_QRY_RESULT;
		   */

  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day_begin bala_day_begin,
	       v_balance_day_end   bala_day_end,
           day,
           sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
		   sum(returncard_num) returncard_num, --20160219 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
      from T#OP_04_004_QRY_RESULT
     group by day
     order by day;

end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_BUS_DIS_QRY to ACC_ST_APP;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_BUS_REC
prompt ============================================
prompt
create or replace procedure acc_st.UP_OP_EST_DIS_RES_BUS_REC(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_BUS_REC
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--µÿÃ˙ø®π´Ωªœ˚∑—«Â∑÷Ω·π˚±®±Ì---≥‰÷µ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20140422
  --±®±Ì±‡∫≈£∫04-011
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
 as
  v_balance_day varchar(8);
  v_err_num  int;
  v_err_fee  int;
  v_max_day    integer;
  v_ii         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 8);
  
--------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
  v_max_day:=substr(v_balance_day,7,2);
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into t#op_04_004_result
    values
      (lpad(v_ii,2,0),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
	   0,
       0,
       0,
       0,
       0);
    v_ii := v_ii + 1;
  end loop;

--------------------≤È—Ø‘≠ º ˝æ›-----------------------
--µÿÃ˙»∑»œ(◊‹ ˝)
  insert into acc_st.T#OP_bus_diff_rpt2
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)
      from st_ext_mtr_audit_balance
     where substr(balance_water_no,1,8) = v_balance_day
     and pay_mode_id='14'
     group by balance_water_no;
     
       insert into acc_st.T#OP_bus_diff_rpt2
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)*(-1)
      from st_ext_mtr_audit_balance
     where substr(balance_water_no,1,8) = v_balance_day
     and pay_mode_id='18'
     group by balance_water_no;
--¥ÌŒÛ(∞¥¥ÌŒÛ¿‡–ÕÕ≥º∆)
insert into t#op_bus_diff_rpt1 a
 select b.balance_water_no,
        b.err_code,
        count(*),
        sum(b.deal_fee)
   from st_ext_mtr_err_trade b
   where substr(balance_water_no,1,8)=v_balance_day
          and b.pay_mode_id='14'
   group by b.balance_water_no,b.err_code;

insert into t#op_bus_diff_rpt1 a
 select b.balance_water_no,
        b.err_code,
        count(*),
        sum(b.deal_fee)*(-1)
   from st_ext_mtr_err_trade b
   where substr(balance_water_no,1,8)=v_balance_day
          and b.pay_mode_id='18'
   group by b.balance_water_no,b.err_code;
   
--------------------------π´ΩªÀÕ≥ˆ(◊‹ ˝)-------------------------------
--µÿÃ˙»∑»œ◊‹º∆
insert into t#op_bus_diff_rpt3
  select balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee
   from t#op_bus_diff_rpt2; 
 --¥ÌŒÛ◊‹º∆
insert into t#op_bus_diff_rpt3
  select b.balance_water_no,
     '99',
     sum(b.err_num),
     sum(b.err_fee)
   from t#op_bus_diff_rpt1 b
   group by b.balance_water_no;
    
---------------------------------------------------------------------------------
  --µº»ÎΩ·π˚ºØ
  ----µÿÃ˙ACCÀÕ≥ˆ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from t#op_bus_diff_rpt3
      group by to_number(substr(balance_water_no,1,8));
  ------“ªø®Õ®»∑»œ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt2
      group by to_number(substr(balance_water_no,1,8));
      ----≤Ó“Ï
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      group by to_number(substr(balance_water_no,1,8));
      ----TAC¥Ì
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '01'
     group by to_number(substr(balance_water_no,1,8));
     ----÷ÿ∏¥
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '02'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®ø®∫≈
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code= '15'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®SAM
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code= '14'
     group by to_number(substr(balance_water_no,1,8));
     -----∑«∑® ±º‰
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '13'
     group by to_number(substr(balance_water_no,1,8));
     ----Œƒº˛ƒ⁄÷ÿ∏¥
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      --where  err_code = '17'--≤ª»∑∂®
	  --20160219 modify by mqf
	  where  err_code = '000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
     group by to_number(substr(balance_water_no,1,8));
     ----Ωª“◊¿‡–Õ¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '10'
     group by to_number(substr(balance_water_no,1,8));
     ----∆±ø®”‡∂Ó∑«∑®
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
		   0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '11'
     group by to_number(substr(balance_water_no,1,8));
     ----Œ¥÷™
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
		   0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '99'
     group by to_number(substr(balance_water_no,1,8));
	 
	   --20160219 add by mqf 
	   ----“—ÕÀøÓø®¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '16'
     group by to_number(substr(balance_water_no,1,8));
	 
	   --20160219 add by mqf 
	   ----∫⁄√˚µ•¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee)
		   
      from T#OP_bus_diff_rpt1
      where  err_code = '17'
     group by to_number(substr(balance_water_no,1,8));

     /*----ƒ©––∫œº∆
       insert into t#op_04_004_result
       select '∫œº∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee
           from t#op_04_004_result;
           */
  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day bala_day,
           day,
           sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
		   sum(returncard_num) returncard_num, --20160219 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
      from t#op_04_004_result
     group by day
     order by day;

end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_BUS_REC to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_BUS_REC to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_CITY_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_RES_CITY_D (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_CITY_D
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥§…≥≥« –Õ®ø®«Â∑÷Ω·π˚»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20130915
  --±®±Ì±‡∫≈£∫rpt_04_002
  --¡Ÿ ±±Ì£∫t#op_res_city_result,t#op_res_city_rpt
  -------------------------------------------------------------------------------
 is
  v_balance_day char(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  ---------------------------------------------------------------------------------
----≤È—Ø‘≠ º ˝æ›
  insert into t#op_res_city_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where sys_type='01' and substr(balance_water_no,1,8) = v_balance_day;
---------------------------------------------------------------------------------
 --—∫Ω   ”–¥˝»∑∂®
  insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
        select v_balance_day,sum(acc_send_num),sum(acc_send_fee),0,0,0,0
        from  t#op_res_city_rpt
        where out_deal_type='a' and sys_type='01';
  --≥‰÷µ
  insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
    select  v_balance_day,0, 0,sum(acc_send_num),sum(acc_send_fee), 0, 0
     from t#op_res_city_rpt
     where out_deal_type='14' and sys_type='01';
  --≥Â’˝
  insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
    select  v_balance_day,0, 0,sum(acc_send_num),sum(acc_send_fee)*-1, 0, 0
     from t#op_res_city_rpt
     where out_deal_type='18' and sys_type='01';
  --œ˚∑—
  insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
    select v_balance_day,0, 0, 0, 0,sum(acc_send_num),sum(acc_send_fee)
     from t#op_res_city_rpt
     where sys_type='01'
     and out_deal_type in ('42','4C','92','9C','4A');

    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           sum(deposit_num) deposit_num,
           sum(deposit_fee) deposit_fee,
           sum(recharge_num) recharge_num,
           sum(recharge_fee) recharge_fee,
           sum(consume_num) consume_num,
           sum(consume_fee) consume_fee
      from t#op_res_city_result;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_CITY_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_CITY_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_CITY_M
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_RES_CITY_M (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_CITY_M
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥§…≥≥« –Õ®ø®«Â∑÷Ω·À„‘¬±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ wangkejia
  --¥¥Ω®»’∆⁄£∫20130915
  --±®±Ì±‡∫≈£∫rpt_04_003
  --¡Ÿ ±±Ì£∫t#op_res_city_rpt,t#op_res_city_result
  -------------------------------------------------------------------------------
 is
  v_balance_day char(6);
  v_day int ;
  v_max_day int;
BEGIN
  v_balance_day := substr(in_balance_day,1,6);
  v_day:=1;
  v_max_day:=30;
  ---------------------------------------------------------------------------------
----≤È—Ø‘≠ º ˝æ›
  insert into T#op_res_city_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where sys_type='01' and substr(balance_water_no,1,6) = v_balance_day;
  -------------------------------------------------------------------------------------
--≤Â»Î ˝æ›
select max(substr(balance_water_no,7,2)) into v_max_day from T#op_res_city_rpt
   where exists (select 1 from T#op_res_city_rpt);
   while v_day<=v_max_day
     loop
     --ππΩ®Ω·π˚ºØΩ·ππ
        insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
           select lpad(v_day,2,'0'),0,0,0,0,0,0
           from dual;
  --—∫Ω   ”–¥˝»∑∂®
       insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
           select substr(balance_water_no,7,2),sum(acc_send_num),sum(acc_send_fee),0,0,0,0
           from t#op_res_city_rpt
           where out_deal_type='a' and sys_type='01' and v_day=substr(balance_water_no,7,2)
           group by substr(balance_water_no,7,2);
  --≥‰÷µ
       insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
           select  substr(balance_water_no,7,2),0,0,sum(acc_send_num),sum(acc_send_fee), 0, 0
           from t#op_res_city_rpt
           where out_deal_type='14' and sys_type='01' and v_day=substr(balance_water_no,7,2)
           group by substr(balance_water_no,7,2);
  --≥Â’˝
       insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
           select  substr(balance_water_no,7,2), 0, 0,sum(acc_send_num),sum(acc_send_fee)*-1, 0, 0
           from t#op_res_city_rpt
           where out_deal_type='18' and sys_type='01' and v_day=substr(balance_water_no,7,2)
           group by substr(balance_water_no,7,2);
  --œ˚∑—
       insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
          select substr(balance_water_no,7,2), 0, 0, 0, 0,sum(acc_send_num),sum(acc_send_fee)
          from t#op_res_city_rpt
          where out_deal_type in ('42','4C','92','9C','4A')
          and sys_type='01' and v_day=substr(balance_water_no,7,2)
          group by substr(balance_water_no,7,2);
  v_day:=v_day+1;
  end loop;
  -------------------------------------------------------------------------------------
 --≤Â»Îƒ©––◊‹º∆
 insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
          select '◊‹º∆',sum(deposit_num),sum(deposit_fee),sum(recharge_num),sum(recharge_fee),sum(consume_num),sum(consume_fee)
          from t#op_res_city_result;
           --…œ—Æ–°º∆
 insert into t#op_res_city_result
 (day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
          select '10-01…œ—Æ–°º∆',
          nvl(sum(deposit_num),0),nvl(sum(deposit_fee),0),
          nvl(sum(recharge_num),0),nvl(sum(recharge_fee),0),
          nvl(sum(consume_num),0),nvl(sum(consume_fee),0)
          from t#op_res_city_result a
          where a.day in ('01','02','03','04','05','06','07','08','09','10');
       
           --÷–—Æ–°º∆
 insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
          select '20-11÷–—Æ–°º∆',nvl(sum(deposit_num),0),nvl(sum(deposit_fee),0),nvl(sum(recharge_num),0),nvl(sum(recharge_fee),0),nvl(sum(consume_num),0),nvl(sum(consume_fee),0)
          from t#op_res_city_result a
          where a.day in ('11','12','13','14','15','16','17','18','19','20');
           --œ¬—Æ–°º∆
 insert into t#op_res_city_result(day,deposit_num,deposit_fee,recharge_num,recharge_fee,consume_num,consume_fee)
          select '31-21œ¬—Æ–°º∆',nvl(sum(deposit_num),0),nvl(sum(deposit_fee),0),nvl(sum(recharge_num),0),nvl(sum(recharge_fee),0),nvl(sum(consume_num),0),nvl(sum(consume_fee),0)
          from t#op_res_city_result a
          where a.day in ('21','22','23','24','25','26','27','28','29','30','31');
          
    ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           day,
           sum(deposit_num) deposit_num,
           sum(deposit_fee) deposit_fee,
           sum(recharge_num) recharge_num,
           sum(recharge_fee) recharge_fee,
           sum(consume_num) consume_num,
           sum(consume_fee) consume_fee
      from t#op_res_city_result
      group by day
      order by day;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_CITY_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_CITY_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_CONSUME
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_RES_CONSUME (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_CONSUME
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--œ˚∑—«Â∑÷Ω·π˚‘¬ª„◊‹±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131021
  --±®±Ì±‡∫≈£∫rpt_04_001
  --¡Ÿ ±±Ì£∫t#op_04_001_result,t#op_04_001_rpt
  -------------------------------------------------------------------------------
 is
  v_balance_day   char(6);
  v_max_day integer;
  v_ii      integer;
BEGIN
  v_balance_day := substr(in_balance_day,1,6);--«ÂÀ„‘¬
  select max(substr(balance_water_no, 7, 2))
    into v_max_day
    from st_sts_diff_analysis
   where substr(balance_water_no, 1, 6) = v_balance_day;
----…Ë÷√Ω·π˚ºØøÚº‹
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into t#op_04_001_result
    values
      (lpad(v_ii,2,0), 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0);
    v_ii := v_ii + 1;
  end loop;
 ---------------------------------------------------------------------------------
----≤È—Ø‘≠ º ˝æ›
  insert into t#op_04_001_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where substr(balance_water_no,1,6) = v_balance_day;
----out_deal_type=v_deal_type≥‰÷µ'13'≥Â’˝'12'ø€øÓ
---------------------------------------------------------------------------------
--Ω´ ˝æ›µº»ÎΩ·π˚ºØ
  --≥« –Õ®ø®
  insert into t#op_04_001_result
    select lpad(substr(balance_water_no, 7, 2),2,0),
           sum(acc_send_num),
           sum(acc_send_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_04_001_rpt
     where sys_type='01'
     and out_deal_type in ('42','4C','92','9C','4A')
     group by substr(balance_water_no, 7, 2);
     /*
  -- –√Òø®
  insert into t#op_04_001_result
    select substr(balance_water_no, 7, 2),
           0,
           0,
           sum(out_affirm_num),
           sum(out_affirm_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
     from t#op_04_001_rpt
    where out_deal_type in (select c.pay_mode_id from op_prm_paymode_type_valid c where c.record_flag='0')
     --where out_deal_type='99' 
     and sys_type='01'
     group by substr(balance_water_no, 7, 2);
  --“∆∂Ø‘À”™…Ã
  insert into t#op_04_001_result
    select substr(balance_water_no, 7, 2),
           0,
           0,
           0,
           0,
           sum(out_affirm_num),
           sum(out_affirm_fee),
           0,
           0,
           0,
           0,
           0,
           0
     from t#op_04_001_rpt
     where out_deal_type='99' and sys_type='01'
     group by substr(balance_water_no, 7, 2);
  --–°∂Óœ˚∑—…Ãªß
  insert into t#op_04_001_result
    select substr(balance_water_no, 7, 2),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(out_affirm_num),
           sum(out_affirm_fee),
           0,
           0,
           0,
           0
      from t#op_04_001_rpt
     where out_deal_type='99' and sys_type='01'
     group by substr(balance_water_no, 7, 2);
  --“¯¡™
  insert into t#op_04_001_result
    select substr(balance_water_no, 7, 2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(out_affirm_num),
           sum(out_affirm_fee),
           0,
           0
    from t#op_04_001_rpt
     where out_deal_type='99' and sys_type='01'
     group by substr(balance_water_no, 7, 2);
     */
--Œ≤¡–∫œº∆
insert into t#op_04_001_result
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(acc_send_num),
           sum(acc_send_fee)
    from t#op_04_001_rpt
     where out_deal_type in ('42','4C','92','9C','4A')
     and sys_type='01'
     group by substr(balance_water_no, 7, 2);
----…œ÷–œ¬—∞
 insert into t#op_04_001_result a
 select '10-01…œ—Æ–°º∆',nvl(sum(city_num),0),nvl(sum(city_fee),0),nvl(sum(citizen_num),0),nvl(sum(citizen_fee),0),nvl(sum(mobile_num),0),nvl(sum(mobile_fee),0),nvl(sum(small_store_num),0),nvl(sum(small_store_fee),0),nvl(sum(unionpay_num),0),nvl(sum(unionpay_fee),0),nvl(sum(total_num),0),nvl(sum(total_fee),0)
 from  t#op_04_001_result
 where day>=1 and day<=10;
 
 insert into t#op_04_001_result a
 select '20-11÷–—Æ–°º∆',nvl(sum(city_num),0),nvl(sum(city_fee),0),nvl(sum(citizen_num),0),nvl(sum(citizen_fee),0),nvl(sum(mobile_num),0),nvl(sum(mobile_fee),0),nvl(sum(small_store_num),0),nvl(sum(small_store_fee),0),nvl(sum(unionpay_num),0),nvl(sum(unionpay_fee),0),nvl(sum(total_num),0),nvl(sum(total_fee),0)
 from  t#op_04_001_result
 where day in ('11','12','13','14','15','16','17','18','19','20');
 
 insert into t#op_04_001_result a
 select '31-21œ¬—Æ–°º∆',nvl(sum(city_num),0),nvl(sum(city_fee),0),nvl(sum(citizen_num),0),nvl(sum(citizen_fee),0),nvl(sum(mobile_num),0),nvl(sum(mobile_fee),0),nvl(sum(small_store_num),0),nvl(sum(small_store_fee),0),nvl(sum(unionpay_num),0),nvl(sum(unionpay_fee),0),nvl(sum(total_num),0),nvl(sum(total_fee),0)
 from  t#op_04_001_result b
 where day in ('21','22','23','24','25','26','27','28','29','30','31') ;
 --and substr(day,3,1)!='-';
 --ƒ©––◊‹º∆
 insert into t#op_04_001_result a
 select '∫œº∆',nvl(sum(city_num),0),nvl(sum(city_fee),0),nvl(sum(citizen_num),0),nvl(sum(citizen_fee),0),nvl(sum(mobile_num),0),nvl(sum(mobile_fee),0),nvl(sum(small_store_num),0),nvl(sum(small_store_fee),0),nvl(sum(unionpay_num),0),nvl(sum(unionpay_fee),0),nvl(sum(total_num),0),nvl(sum(total_fee),0)
 from  t#op_04_001_result b
 where substr(b.day,3,1)='-';
  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           day rowkey,
           sum(city_num) as city_num,
           sum(city_fee) as city_fee,
           sum(citizen_num) as citizen_num,
           sum(citizen_fee) as citizen_fee,
           sum(mobile_num) as mobile_num,
           sum(mobile_fee) as mobile_fee,
           sum(small_store_num) as small_store_num,
           sum(small_store_fee) as small_store_fee,
           sum(unionpay_num) as unionpay_num,
           sum(unionpay_fee) as unionpay_fee,
           sum(total_num) as total_num,
           sum(total_fee) as total_fee
      from t#op_04_001_result
     group by day
     order by day;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_CONSUME to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_CONSUME to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_DISCOUNT
prompt =============================================
prompt
create or replace procedure acc_st.UP_OP_EST_DIS_RES_DISCOUNT (

                                            in_line_id        varchar,

                                            in_station_id     varchar,

                                            in_card_main_id varchar,

                                            in_card_sub_id  varchar,

                                            in_squad_day      varchar,

                                            in_balance_day    varchar,

                                            out_cur_arg       out sys_refcursor)

--------------------------------------------------------------------------------

  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_DISCOUNT

  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥« –Õ®ø®«Â∑÷Ω·π˚≤Ó“ÏÕ≥º∆‘¬±®±Ì°™ø€øÓ

  -- ‰≥ˆ≤Œ ˝  : Œﬁ

  --¥¥Ω®’ﬂ£∫ Õıø…º—

  --¥¥Ω®»’∆⁄£∫20130805

  --±®±Ì±‡∫≈£∫04-005

  --◊¢ Õ:

  --¡Ÿ ±±Ì£∫t#op_04_004_rpt,t#op_04_004_result

  -------------------------------------------------------------------------------

  --∏¸∏ƒ’ﬂ£∫Õıø…º—

  --∏¸∏ƒ»’∆⁄£∫20140703

  --∏¸∏ƒƒ⁄»›£∫‘⁄‘¬≥ıº”»Î…œ“ª∏ˆ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›

  -------------------------------------------------------------

    --∏¸∏ƒ’ﬂ£∫Õıø…º—

  --∏¸∏ƒ»’∆⁄£∫20140813

  --∏¸∏ƒƒ⁄»›£∫÷ªªÒ»°µ±‘¬–°”⁄µ±«∞«ÂÀ„»’∆⁄µƒ ˝æ›

  -------------------------------------------------------------

  --∏¸∏ƒ’ﬂ£∫Õıø…º—

  --∏¸∏ƒ»’∆⁄£∫20140819

  --∏¸∏ƒƒ⁄»›£∫◊¢ Õ≤ø∑÷ƒ⁄»›

  -------------------------------------------------------------

  --∏¸∏ƒ’ﬂ£∫¿Ó¿Ú

  --∏¸∏ƒ»’∆⁄£∫20140905

  --∏¸∏ƒƒ⁄»›£∫÷ß∏∂¿‡–Õº”…œ4A

  -------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫÷‹—Ô
  --∏¸∏ƒ»’∆⁄£∫20160414
  --∏¸∏ƒƒ⁄»›£∫‘ˆº”…œ—Æ–°º∆ ÷–—Æ–°º∆ œ¬—Æ–°º∆
  -------------------------------------------------------------------------------

 is

  v_balance_day varchar(8);

  v_max_day    integer;

  v_ii         integer;

  v_out_type   char(2);

  v_last_day   date;  --2016.04.14 add by zy

BEGIN

  v_balance_day := substr(in_balance_day, 1, 8);

  v_out_type:='12';

  v_last_day := last_day(to_date(substr(v_balance_day,0,8), 'yyyymmdd'));  --2016.04.14 add by zy

  ---------------------------------------------------------------------------------

----≤È—Ø‘≠ º ˝æ›

----------------------------------------------------------------------------------

--‘ˆº”ƒ⁄»›

--‘¬≥ıº”»Î…œ“ª∏ˆ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›

if substr(v_balance_day,7,2)='01' then

  insert into t#op_04_004_rpt

    (balance_water_no,

     out_deal_type,

     acc_send_num,

     acc_send_fee,

     out_affirm_num,

     out_affirm_fee,

     error_id,

     error_num,

     error_fee,

     sys_type)

    select balance_water_no,

           out_deal_type,

           acc_send_num,

           acc_send_fee,

           out_affirm_num,

           out_affirm_fee,

           error_id,

           error_num,

           error_fee,

           sys_type

      from st_sts_diff_analysis

     where sys_type='01'
     and (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0') --ø€øÓ¥˙¬Î
           or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
     and substr(balance_water_no,1,8)=to_char(last_day(add_months(to_date(v_balance_day,'yyyymmdd'),-1)),'yyyymmdd');

end if;

----------------------------------------------------------------------------------



  insert into t#op_04_004_rpt

    (balance_water_no,

     out_deal_type,

     acc_send_num,

     acc_send_fee,

     out_affirm_num,

     out_affirm_fee,

     error_id,

     error_num,

     error_fee,

     sys_type)

    select balance_water_no,

           out_deal_type,

           acc_send_num,

           acc_send_fee,

           out_affirm_num,

           out_affirm_fee,

           error_id,

           error_num,

           error_fee,

           sys_type

      from st_sts_diff_analysis

     where sys_type='01'

     and (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0') --ø€øÓ¥˙¬Î
         or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
     and substr(balance_water_no,7,2) <= substr(v_balance_day,7,2)

     and substr(balance_water_no,1,6) = substr(v_balance_day,1,6);

--select pay_mode_id from op_prm_paymode_type_valid

  ---------------------------------------------------------------------------------

  --------------------------------------------------------------------------------

  /*----ππΩ®Ω·π˚ºØΩ·ππ

  select max(substr(balance_water_no,7,2)) into v_max_day from t#op_04_004_rpt

      where exists (select 1 from t#op_04_004_rpt);

    v_ii := 1;

    while v_ii <= v_max_day loop

      insert into t#op_04_004_result

      values

        (substr(v_balance_day,1,6)||lpad(v_ii,2,0),

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0);

      v_ii := v_ii + 1;

    end loop;

  */

  ------ ø€øÓ

    ----µÿÃ˙ACCÀÕ≥ˆ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             sum(acc_send_num),

             sum(acc_send_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

    ------“ªø®Õ®»∑»œ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             sum(out_affirm_num),

             sum(out_affirm_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

        ----≤Ó“Ï

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt where out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                                   or out_deal_type ='4A' --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

        ----TAC¥Ì

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
              and error_id = '01'

       group by substr(balance_water_no,1,8);

       ----÷ÿ∏¥

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '02'

       group by substr(balance_water_no,1,8);

       ----∑«∑®ø®∫≈

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
       and error_id= '15'

       group by substr(balance_water_no,1,8);

       ----∑«∑®SAM

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
       and error_id= '14'

       group by substr(balance_water_no,1,8);

       -----∑«∑® ±º‰

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '13'
       group by substr(balance_water_no,1,8);

       ----Œƒº˛ƒ⁄÷ÿ∏¥

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        --and error_id = '17'
    --20160219 modify by mqf Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
    and error_id = '000'

       group by substr(balance_water_no,1,8);

       ----Ωª“◊¿‡–Õ¥ÌŒÛ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '10'

       group by substr(balance_water_no,1,8);

       ----∆±ø®”‡∂Ó∑«∑®

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

       0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '11'

       group by substr(balance_water_no,1,8);

       ----Œ¥÷™

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

       0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '99'

       group by substr(balance_water_no,1,8);

     --20160217 add by mqf
     ----“—ÕÀøÓø®¥ÌŒÛ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

       0,

             0,

             sum(error_num),

             sum(error_fee),

       0,

             0



        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '16'

       group by substr(balance_water_no,1,8);


     --20160217 add by mqf
     ----∫⁄√˚µ•¥ÌŒÛ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

       0,

             0,

       0,

             0,

             sum(error_num),

             sum(error_fee)



        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '17'

       group by substr(balance_water_no,1,8);

       /*--±æ‘¬◊‹º∆

       if substr(v_balance_day,7,2)='01' then

       insert into t#op_04_004_result

         select '±æ‘¬∫œº∆', sum(acc_num) acc_num,

             nvl(sum(acc_fee),0) acc_fee,

             nvl(sum(cs_city_num),0) cs_city_num,

             nvl(sum(cs_city_fee),0) cs_city_fee,

             nvl(sum(diff_num),0) diff_num,

             nvl(sum(diff_fee),0) diff_fee,

             nvl(sum(tac_num),0) tac_num,

             nvl(sum(tac_fee),0) tac_fee,

             nvl(sum(repeat_num),0) repeat_num,

             nvl(sum(repeat_fee),0) repeat_fee,

             nvl(sum(nocard_num),0) nocard_num,

             nvl(sum(nocard_fee),0) nocard_fee,

             nvl(sum(nosam_num),0) nosam_num,

             nvl(sum(nosam_fee),0) nosam_fee,

             nvl(sum(notime_num),0) notime_num,

             nvl(sum(notime_fee),0) notime_fee,

             nvl(sum(filere_num),0) filere_num,

             nvl(sum(filere_fee),0) filere_fee,

             nvl(sum(dealerr_num),0) dealerr_num,

             nvl(sum(dealerr_fee),0) dealerr_fee,

             nvl(sum(balance_num),0) balance_num,

             nvl(sum(balance_fee),0) balance_fee,

             nvl(sum(ot_num),0) ot_num,

             nvl(sum(ot_fee),0) ot_fee

             from t#op_04_004_result

             where substr(day,1,6)=substr(v_balance_day,1,6);

       end if;*/

       ----…œ—Æ–°º∆  --2016.04.14 add by zy

        if to_number(substr(v_balance_day,7,2))>=10

        then begin

          insert into t#op_04_004_result

           select '…œ—Æ–°º∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆') and to_number(substr(day,7,2))<=10;

      end;

      end if;

        ----÷–—Æ–°º∆  --2016.04.14 add by zy

        if to_number(substr(v_balance_day,7,2))>=20

        then begin

          insert into t#op_04_004_result

           select '÷–—Æ–°º∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆') and to_number(substr(day,7,2)) >10 and to_number(substr(day,7,2)) <= 20;

      end;

      end if;

        ----œ¬—Æ–°º∆  --2016.04.14 add by zy

        if to_date(substr(v_balance_day,0,8),'yyyymmdd') = v_last_day

        then begin

          insert into t#op_04_004_result

           select 'œ¬—Æ–°º∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆')and to_number(substr(day,7,2)) >20;--20160412 add by zy

      end;

      end if;

       ----ƒ©––∫œº∆

         insert into t#op_04_004_result

         select '∫œº∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆');

  --------------------------------------------------------------------------------

    --∑µªÿΩ·π˚ºØ

    open out_cur_arg for

      select v_balance_day bala_day,

             day,

             sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

        from t#op_04_004_result

       group by day

       --order by day;  --2016.04.14 cancel by zy

       order by  --2016.04.14 modify by zy

            case day when '…œ—Æ–°º∆' then substr(v_balance_day,0,6)||'109'

                         when '÷–—Æ–°º∆' then substr(v_balance_day,0,6)||'209'

                         when 'œ¬—Æ–°º∆' then substr(v_balance_day,0,6)||'319'

                         when '∫œº∆'     then substr(v_balance_day,0,6)||'329'

                         else day

                         end;

  end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_DISCOUNT to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_DISCOUNT to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_DISCOUNT_QRY
prompt =================================================
prompt
create or replace procedure acc_st.UP_OP_EST_DIS_RES_DISCOUNT_QRY (
                                        
                                            in_balance_day_begin    varchar,

                                            in_balance_day_end    varchar,

                                            out_cur_arg       out sys_refcursor)

--------------------------------------------------------------------------------

  --π˝≥Ã√˚£∫  UP_OP_EST_DIS_RES_DISCOUNT_QRY

  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥« –Õ®ø®«Â∑÷Ω·π˚≤Ó“ÏÕ≥º∆‘¬±®±Ì°™ø€øÓ ≤È—Ø

  -- ‰≥ˆ≤Œ ˝  : Œﬁ

  --¥¥Ω®’ﬂ£∫ mqf

  --¥¥Ω®»’∆⁄£∫20160420

  --±®±Ì±‡∫≈£∫Œﬁ ‘¥”⁄04-005

  --◊¢ Õ:

  --¡Ÿ ±±Ì£∫T#OP_04_004_QRY,T#OP_04_004_QRY_RESULT

  -------------------------------------------------------------------------------

  --∏¸∏ƒ’ﬂ£∫Õıø…º—

  --∏¸∏ƒ»’∆⁄£∫20140703

  --∏¸∏ƒƒ⁄»›£∫‘⁄‘¬≥ıº”»Î…œ“ª∏ˆ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›

  -------------------------------------------------------------

    --∏¸∏ƒ’ﬂ£∫Õıø…º—

  --∏¸∏ƒ»’∆⁄£∫20140813

  --∏¸∏ƒƒ⁄»›£∫÷ªªÒ»°µ±‘¬–°”⁄µ±«∞«ÂÀ„»’∆⁄µƒ ˝æ›

  -------------------------------------------------------------

  --∏¸∏ƒ’ﬂ£∫Õıø…º—

  --∏¸∏ƒ»’∆⁄£∫20140819

  --∏¸∏ƒƒ⁄»›£∫◊¢ Õ≤ø∑÷ƒ⁄»›

  -------------------------------------------------------------

  --∏¸∏ƒ’ﬂ£∫¿Ó¿Ú

  --∏¸∏ƒ»’∆⁄£∫20140905

  --∏¸∏ƒƒ⁄»›£∫÷ß∏∂¿‡–Õº”…œ4A

  -------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------

 is

  v_balance_day_begin varchar(8);

  v_balance_day_end varchar(8);

  v_max_day    integer;

  v_ii         integer;

  v_out_type   char(2);

BEGIN

  --œ»…æ≥˝¡Ÿ ±±Ì ˝æ›
  delete from T#OP_04_004_QRY;
  delete from T#OP_04_004_QRY_RESULT;
  

  v_balance_day_begin := substr(in_balance_day_begin, 1, 4)||substr(in_balance_day_begin, 6, 2)||substr(in_balance_day_begin, 9, 10);
  v_balance_day_end := substr(in_balance_day_end, 1, 4)||substr(in_balance_day_end, 6, 2)||substr(in_balance_day_end, 9, 10);

  v_out_type:='12';

  ---------------------------------------------------------------------------------

----≤È—Ø‘≠ º ˝æ›

----------------------------------------------------------------------------------

--‘ˆº”ƒ⁄»›

--‘¬≥ıº”»Î…œ“ª∏ˆ‘¬◊Ó∫Û“ªÃÏµƒ ˝æ›
/*
if substr(v_balance_day,7,2)='01' then

  insert into T#OP_04_004_QRY

    (balance_water_no,

     out_deal_type,

     acc_send_num,

     acc_send_fee,

     out_affirm_num,

     out_affirm_fee,

     error_id,

     error_num,

     error_fee,

     sys_type)

    select balance_water_no,

           out_deal_type,

           acc_send_num,

           acc_send_fee,

           out_affirm_num,

           out_affirm_fee,

           error_id,

           error_num,

           error_fee,

           sys_type

      from st_sts_diff_analysis

     where sys_type='01'
     and (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0') --ø€øÓ¥˙¬Î
           or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
     and substr(balance_water_no,1,8)=to_char(last_day(add_months(to_date(v_balance_day,'yyyymmdd'),-1)),'yyyymmdd');

end if;
*/
----------------------------------------------------------------------------------



  insert into T#OP_04_004_QRY

    (balance_water_no,

     out_deal_type,

     acc_send_num,

     acc_send_fee,

     out_affirm_num,

     out_affirm_fee,

     error_id,

     error_num,

     error_fee,

     sys_type)

    select balance_water_no,

           out_deal_type,

           acc_send_num,

           acc_send_fee,

           out_affirm_num,

           out_affirm_fee,

           error_id,

           error_num,

           error_fee,

           sys_type

      from st_sts_diff_analysis

     where sys_type='01'

     and (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0') --ø€øÓ¥˙¬Î
         or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
     and substr(balance_water_no,1,8) >= v_balance_day_begin

     and substr(balance_water_no,1,8) <= v_balance_day_end;

--select pay_mode_id from op_prm_paymode_type_valid

  ---------------------------------------------------------------------------------

  --------------------------------------------------------------------------------

  /*----ππΩ®Ω·π˚ºØΩ·ππ

  select max(substr(balance_water_no,7,2)) into v_max_day from T#OP_04_004_QRY

      where exists (select 1 from T#OP_04_004_QRY);

    v_ii := 1;

    while v_ii <= v_max_day loop

      insert into T#OP_04_004_QRY_RESULT

      values

        (substr(v_balance_day,1,6)||lpad(v_ii,2,0),

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0,

         0);

      v_ii := v_ii + 1;

    end loop;

  */

  ------ ø€øÓ

    ----µÿÃ˙ACCÀÕ≥ˆ

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             sum(acc_send_num),

             sum(acc_send_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

    ------“ªø®Õ®»∑»œ

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             sum(out_affirm_num),

             sum(out_affirm_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

        ----≤Ó“Ï

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY where out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                                   or out_deal_type ='4A' --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

        ----TAC¥Ì

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
              and error_id = '01'

       group by substr(balance_water_no,1,8);

       ----÷ÿ∏¥

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '02'

       group by substr(balance_water_no,1,8);

       ----∑«∑®ø®∫≈

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
       and error_id= '15'

       group by substr(balance_water_no,1,8);

       ----∑«∑®SAM

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
       and error_id= '14'

       group by substr(balance_water_no,1,8);

       -----∑«∑® ±º‰

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '13'
       group by substr(balance_water_no,1,8);

       ----Œƒº˛ƒ⁄÷ÿ∏¥

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        --and error_id = '17'
    --20160219 modify by mqf Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
    and error_id = '000'

       group by substr(balance_water_no,1,8);

       ----Ωª“◊¿‡–Õ¥ÌŒÛ

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '10'

       group by substr(balance_water_no,1,8);

       ----∆±ø®”‡∂Ó∑«∑®

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

       0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '11'

       group by substr(balance_water_no,1,8);

       ----Œ¥÷™

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

       0,

             0,

             0,

             0

        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '99'

       group by substr(balance_water_no,1,8);

     --20160217 add by mqf
     ----“—ÕÀøÓø®¥ÌŒÛ

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

       0,

             0,

             sum(error_num),

             sum(error_fee),

       0,

             0



        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '16'

       group by substr(balance_water_no,1,8);


     --20160217 add by mqf
     ----∫⁄√˚µ•¥ÌŒÛ

    insert into T#OP_04_004_QRY_RESULT

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

       0,

             0,

       0,

             0,

             sum(error_num),

             sum(error_fee)



        from T#OP_04_004_QRY

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        and error_id = '17'

       group by substr(balance_water_no,1,8);

       /*--±æ‘¬◊‹º∆

       if substr(v_balance_day,7,2)='01' then

       insert into T#OP_04_004_QRY_RESULT

         select '±æ‘¬∫œº∆', sum(acc_num) acc_num,

             nvl(sum(acc_fee),0) acc_fee,

             nvl(sum(cs_city_num),0) cs_city_num,

             nvl(sum(cs_city_fee),0) cs_city_fee,

             nvl(sum(diff_num),0) diff_num,

             nvl(sum(diff_fee),0) diff_fee,

             nvl(sum(tac_num),0) tac_num,

             nvl(sum(tac_fee),0) tac_fee,

             nvl(sum(repeat_num),0) repeat_num,

             nvl(sum(repeat_fee),0) repeat_fee,

             nvl(sum(nocard_num),0) nocard_num,

             nvl(sum(nocard_fee),0) nocard_fee,

             nvl(sum(nosam_num),0) nosam_num,

             nvl(sum(nosam_fee),0) nosam_fee,

             nvl(sum(notime_num),0) notime_num,

             nvl(sum(notime_fee),0) notime_fee,

             nvl(sum(filere_num),0) filere_num,

             nvl(sum(filere_fee),0) filere_fee,

             nvl(sum(dealerr_num),0) dealerr_num,

             nvl(sum(dealerr_fee),0) dealerr_fee,

             nvl(sum(balance_num),0) balance_num,

             nvl(sum(balance_fee),0) balance_fee,

             nvl(sum(ot_num),0) ot_num,

             nvl(sum(ot_fee),0) ot_fee

             from T#OP_04_004_QRY_RESULT

             where substr(day,1,6)=substr(v_balance_day,1,6);

       end if;*/

       ----ƒ©––∫œº∆
/*
         insert into T#OP_04_004_QRY_RESULT

         select '∫œº∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from T#OP_04_004_QRY_RESULT;
			 */

  --------------------------------------------------------------------------------

    --∑µªÿΩ·π˚ºØ

    open out_cur_arg for

      select v_balance_day_begin bala_day_begin,

           v_balance_day_end bala_day_end,

             day,

             sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num, --20160217 add by mqf

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

        from T#OP_04_004_QRY_RESULT

       group by day

       order by day;

  end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_DISCOUNT_QRY to ACC_ST_APP;


prompt
prompt Creating procedure UP_OP_EST_DIS_RES_RECHARGE
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_EST_DIS_RES_RECHARGE (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_op_04_004_rpt
  --π¶ƒ‹√Ë ˆ£∫Õ‚≤ø«ÂÀ„¿‡±®±Ì--≥« –Õ®ø®«Â∑÷Ω·π˚≤Ó“ÏÕ≥º∆‘¬±®±Ì°™≥‰÷µ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ wangkejia
  --¥¥Ω®»’∆⁄£∫20130805
  --±®±Ì±‡∫≈£∫04-005
  --◊¢ Õ:
  --¡Ÿ ±±Ì£∫t#op_04_004_rpt,t#op_04_004_result
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄£∫20131009
  --–ﬁ∏ƒ¥Ê¥¢π˝≥Ã:UP_OP_EST_DIS_RES_RECHARGE 
  
  --±∏◊¢£∫≥« –Õ®ø®‘⁄µÿÃ˙≤ªƒ‹≥‰÷µ£¨÷µŒ™0
  -------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫mqf
  --∏¸∏ƒ»’∆⁄£∫20160217
  --∏¸∏ƒƒ⁄»›£∫‘ˆº” ∫⁄√˚µ•¥ÌŒÛ«ÂÀ„¥ÌŒÛ¿‡–ÕŒ™17°¢“—ÕÀøÓø®¥ÌŒÛ¿‡–Õ16
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_max_day    integer;
  v_ii         integer;
  v_deal_type  char(2); --'14'  ≥‰÷µ
BEGIN
  v_balance_day := substr(in_balance_day, 1, 8);
  v_deal_type  := '14';
--------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
select max(substr(balance_water_no,7,2)) into v_max_day from t#op_04_004_rpt 
    where exists (select 1 from t#op_04_004_rpt);
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into t#op_04_004_result
    values
      (lpad(v_ii,2,0),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
	   0,
       0,
       0,
       0,
       0);
    v_ii := v_ii + 1;
  end loop;
---------------------------------------------------------------------------------
----≤È—Ø‘≠ º ˝æ›
  insert into t#op_04_004_rpt
    (balance_water_no,
     out_deal_type,
     acc_send_num,
     acc_send_fee,
     out_affirm_num,
     out_affirm_fee,
     error_id,
     error_num,
     error_fee,
     sys_type)
    select balance_water_no,
           out_deal_type,
           acc_send_num,
           acc_send_fee,
           out_affirm_num,
           out_affirm_fee,
           error_id,
           error_num,
           error_fee,
           sys_type
      from st_sts_diff_analysis
     where substr(balance_water_no,1,6) = substr(v_balance_day,1,6)
           and out_deal_type in ('','');--≥‰÷µŒ¥÷™
----out_deal_type='14'≥‰÷µ'13'≥Â’˝'12'ø€øÓ£¨sys_type='01'µÿÃ˙∆±,sys_type='02'≥« –Õ®∆±
---------------------------------------------------------------------------------
  --'14'  ≥‰÷µ
  ----µÿÃ˙ACCÀÕ≥ˆ
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           sum(acc_send_num),
           sum(acc_send_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44'
      group by substr(balance_water_no,7,2);
  ------“ªø®Õ®»∑»œ
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           sum(out_affirm_num),
           sum(out_affirm_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44'
      group by substr(balance_water_no,7,2);
      ----≤Ó“Ï
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44'
      group by substr(balance_water_no,7,2);
      ----TAC¥Ì
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '01'
     group by substr(balance_water_no,7,2);
     ----÷ÿ∏¥
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '02'
     group by substr(balance_water_no,7,2);
     ----∑«∑®ø®∫≈
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44'
     and error_id= '15'
     group by substr(balance_water_no,7,2);
     ----∑«∑®SAM
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44'
     and error_id= '14'
     group by substr(balance_water_no,7,2);
     -----∑«∑® ±º‰
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '13'
     group by substr(balance_water_no,7,2);
     ----Œƒº˛ƒ⁄÷ÿ∏¥
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      --where out_deal_type='44' and error_id = '17'--≤ª»∑∂®
	  --20160219 modify by mqf
	  where out_deal_type='44' and error_id = '000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
     group by substr(balance_water_no,7,2);
     ----Ωª“◊¿‡–Õ¥ÌŒÛ
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '10'
     group by substr(balance_water_no,7,2);
     ----∆±ø®”‡∂Ó∑«∑®
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '11'
     group by substr(balance_water_no,7,2);
     ----Œ¥÷™
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee),
		   0,
		   0,
		   0,
		   0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '99'
     group by substr(balance_water_no,7,2);
	 
	 --20160217 add by mqf 
	 ----“—ÕÀøÓø®¥ÌŒÛ
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
           sum(error_num),
           sum(error_fee),
		   0,
		   0
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '16'
     group by substr(balance_water_no,7,2);
	 
	 --20160217 add by mqf 
	 ----∫⁄√˚µ•¥ÌŒÛ
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           sum(error_num),
           sum(error_fee)
		   
      from t#op_04_004_rpt
      where out_deal_type='44' and error_id = '17'
     group by substr(balance_water_no,7,2);
	 
	 
--------------------------------------------------------------------------------
-----------≥Â’˝
--------------------------------------------------------------------------------
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           sum(acc_send_num),
           sum(acc_send_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type='48'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           sum(out_affirm_num),
           sum(out_affirm_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type = '48' and error_id = '01'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '02'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '15'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '14'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '13'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '000' --and error_id = '17' Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '10'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
           0,
		   0,
		   0,
		   0,
		   0,
           0
      from t#op_04_004_rpt
      where out_deal_type = '48' and error_id = '11'
     group by substr(balance_water_no,7,2);
  insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(error_num),
           sum(error_fee) * (-1),
		   0,
		   0,
		   0,
		   0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '99'
     group by substr(balance_water_no,7,2);
	 
	 --20160217 add by mqf 
	 ----≥Â’˝ “—ÕÀøÓø®¥ÌŒÛ
	 insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
           sum(error_num),
           sum(error_fee) * (-1),
		   0,
		   0
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '16'
     group by substr(balance_water_no,7,2);
	 
	 --20160217 add by mqf 
	 ----≥Â’˝ ∫⁄√˚µ•¥ÌŒÛ
	 insert into t#op_04_004_result
    select substr(balance_water_no,7,2),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
		   0,
		   0,
		   0,
		   0,
           sum(error_num),
           sum(error_fee) * (-1)
		   
      from t#op_04_004_rpt
     where out_deal_type = '48' and error_id = '17'
     group by substr(balance_water_no,7,2);
	 
     ----ƒ©––∫œº∆
       insert into t#op_04_004_result
       select '∫œº∆', sum(acc_num) acc_num,
           sum(acc_fee) acc_fee,
           sum(cs_city_num) cs_city_num,
           sum(cs_city_fee) cs_city_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
		   sum(returncard_num) returncard_num, --20160217 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result;
  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day bala_day,
           day,
           sum(acc_num) acc_num,
           sum(acc_fee) acc_fee,
           sum(cs_city_num) cs_city_num,
           sum(cs_city_fee) cs_city_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
		   sum(returncard_num) returncard_num, --20160217 add by mqf

		   sum(returncard_fee) returncard_fee,
		 
		   sum(blacklist_num) blacklist_num,

		   sum(blacklist_fee) blacklist_fee
      from t#op_04_004_result
     group by day
     order by day;
end;
/
grant execute on ACC_ST.UP_OP_EST_DIS_RES_RECHARGE to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_EST_DIS_RES_RECHARGE to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_ACC_LCC_TOTAL
prompt =========================================
prompt
create or replace procedure acc_st.UP_OP_FN_ACC_LCC_TOTAL(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
in_begin_day char,
in_end_day char,
out_cursor  OUT sys_refcursor)
-------------------------------------------------------------------
--π˝≥Ã√˚:UP_OP_FN_ACC_LCC_TOTAL
--±®±Ì√˚£∫LCC∂‘’ÀΩ·π˚»’±®--œﬂÕ¯◊‹º∆
--π¶ƒ‹√Ë ˆ£∫ACC”ÎLCC∂‘’ÀΩ·π˚(À˘”–’æµ„)
--±®±Ìƒ£∞Â£∫rpt_12_007
--¥¥Ω®»À£∫¡ıµ¬‘ˆ
--÷–º‰±Ì£∫st_his_lcc,st_sts_acc
------------------------------------------------------------------


AS
V_balanceday varchar(8);
V_squadday varchar(8);
v_no_balance varchar(8);
v_line_name varchar2(100) := '';
v_begin_day varchar(8);
v_end_day varchar(8);
b_d char(4);
v_p integer;
BEGIN
 v_balanceday:=substr(in_balance_day,1,8);
 v_squadday:=substr(in_squad_day,1,8);
 v_no_balance:=to_char(add_months(to_date(substr(in_balance_day,1,6),'yyyymm'),-1),'yyyymm') || '26';
  v_begin_day:=substr(in_begin_day,1,8);
 v_end_day:=substr(in_end_day,1,8);
  b_d:=to_number(substr(in_end_day,5,4));
 select b.line_name into v_line_name from op_prm_line b where b.line_id=in_line_id and b.record_flag='0';

 --20150410
 INSERT INTO T#OP_TOTAL_RESULT_ACC
 SELECT a.account_date,
        diff_bom_sale_sjt_num,
        diff_bom_sale_sjt_fee,
        diff_tvm_sale_sjt_num,
        diff_tvm_sale_sjt_fee,
        diff_bom_sale_num,
        diff_bom_sale_deposit_fee,
        diff_bom_charge_fee,
        diff_tvm_charge_num,
        diff_tvm_charge_fee,
        diff_return_num,
        diff_return_fee,
        diff_non_return_num,
        diff_non_ret_deposit_fee,
        diff_non_ret_actual_ret_bala,
        diff_negative_charge_num,
        diff_negative_charge_fee,
        diff_deal_num,
        diff_deal_fee,
        diff_update_cash_num,
        diff_update_cash_fee,
        diff_update_noncash_num,
        diff_update_noncash_fee,
        diff_admin_num,
        diff_admin_return_fee,
        diff_admin_penalty_fee
 from st_sts_lcc_acc a
 WHERE substr(v_begin_day,1,8)<=substr(v_balanceday,1,8)
   and substr(v_balanceday,1,8)<=substr(v_end_day,1,8) and line_id=in_line_id;



----ƒ©––◊‹º∆
INSERT INTO T#OP_TOTAL_RESULT_ACC
select
    '◊‹º∆',
    sum(BOM_SALE_SJT_NUM) BOM_SALE_SJT_NUM,
    sum(BOM_SALE_SJT_FEE) BOM_SALE_SJT_FEE,
    sum(TVM_SALE_SJT_NUM) TVM_SALE_SJT_NUM,
    sum(TVM_SALE_SJT_FEE) TVM_SALE_SJT_FEE,
    sum(BOM_SALE_NUM) BOM_SALE_NUM,
    sum(BOM_SALE_DEPOSIT_FEE) BOM_SALE_DEPOSIT_FEE,
    sum(BOM_CHARGE_FEE) BOM_CHARGE_FEE,
    sum(TVM_CHARGE_NUM) TVM_CHARGE_NUM,
    sum(TVM_CHARGE_FEE) TVM_CHARGE_FEE,
    sum(RETURN_NUM) RETURN_NUM,
    sum(RETURN_FEE) RETURN_FEE,
    sum(NON_RETURN_NUM) NON_RETURN_NUM,
    sum(NON_RET_DEPOSIT_FEE) NON_RET_DEPOSIT_FEE,
    sum(NON_RET_ACTUAL_RET_BALA) NON_RET_ACTUAL_RET_BALA,
    sum(NEGATIVE_CHARGE_NUM) NEGATIVE_CHARGE_NUM,
    sum(NEGATIVE_CHARGE_FEE) NEGATIVE_CHARGE_FEE,
    sum(DEAL_NUM) DEAL_NUM,
    sum(DEAL_FEE) DEAL_FEE,
    sum(UPDATE_CASH_NUM) UPDATE_CASH_NUM,
    sum(UPDATE_CASH_FEE) UPDATE_CASH_FEE,
    sum(UPDATE_NONCASH_NUM) UPDATE_NONCASH_NUM,
    sum(UPDATE_NONCASH_FEE) UPDATE_NONCASH_FEE,
    sum(ADMIN_NUM) ADMIN_NUM,
    sum(ADMIN_RETURN_FEE) ADMIN_RETURN_FEE,
    sum(ADMIN_PENALTY_FEE) ADMIN_PENALTY_FEE
from T#OP_TOTAL_RESULT_ACC;
----∑µªÿΩ·π˚ºØ
 OPEN out_cursor for
 select
    v_line_name line_name,
    V_balanceday day,
    v_begin_day begin_day,
    v_end_day end_day,
    type,
    sum(BOM_SALE_SJT_NUM) BOM_SALE_SJT_NUM,
    sum(BOM_SALE_SJT_FEE) BOM_SALE_SJT_FEE,
    sum(TVM_SALE_SJT_NUM) TVM_SALE_SJT_NUM,
    sum(TVM_SALE_SJT_FEE) TVM_SALE_SJT_FEE,
    sum(BOM_SALE_NUM) BOM_SALE_NUM,
    sum(BOM_SALE_DEPOSIT_FEE) BOM_SALE_DEPOSIT_FEE,
    sum(BOM_CHARGE_FEE) BOM_CHARGE_FEE,
    sum(TVM_CHARGE_NUM) TVM_CHARGE_NUM,
    sum(TVM_CHARGE_FEE) TVM_CHARGE_FEE,
    sum(RETURN_NUM) RETURN_NUM,
    sum(RETURN_FEE) RETURN_FEE,
    sum(NON_RETURN_NUM) NON_RETURN_NUM,
    sum(NON_RET_DEPOSIT_FEE) NON_RET_DEPOSIT_FEE,
    sum(NON_RET_ACTUAL_RET_BALA) NON_RET_ACTUAL_RET_BALA,
    sum(NEGATIVE_CHARGE_NUM) NEGATIVE_CHARGE_NUM,
    sum(NEGATIVE_CHARGE_FEE) NEGATIVE_CHARGE_FEE,
    sum(DEAL_NUM) DEAL_NUM,
    sum(DEAL_FEE) DEAL_FEE,
    sum(UPDATE_CASH_NUM) UPDATE_CASH_NUM,
    sum(UPDATE_CASH_FEE) UPDATE_CASH_FEE,
    sum(UPDATE_NONCASH_NUM) UPDATE_NONCASH_NUM,
    sum(UPDATE_NONCASH_FEE) UPDATE_NONCASH_FEE,
    sum(ADMIN_NUM) ADMIN_NUM,
    sum(ADMIN_RETURN_FEE) ADMIN_RETURN_FEE,
    sum(ADMIN_PENALTY_FEE) ADMIN_PENALTY_FEE
from T#OP_TOTAL_RESULT_ACC where substr(v_begin_day,1,8)<=type
   and type<=substr(v_end_day,1,8)
group by type
order by type;

end;
/
grant execute on ACC_ST.UP_OP_FN_ACC_LCC_TOTAL to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_ACC_LCC_TOTAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_EST_DIS_RES_BUS_DIS
prompt ===============================================
prompt
create or replace procedure acc_st.UP_OP_FN_EST_DIS_RES_BUS_DIS(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             in_begin_day      varchar,
                                             in_end_day        varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_FN_EST_DIS_RES_BUS_DIS
  --π¶ƒ‹√Ë ˆ£∫≤∆ŒÒ±®±Ì--µÿÃ˙ø®π´Ωªœ˚∑—«Â∑÷Ω·π˚»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  :
  --¥¥Ω®’ﬂ£∫ ÷”◊”∆Ê
  --¥¥Ω®»’∆⁄£∫20170315
  --±®±Ì±‡∫≈£∫12-006
  --◊¢ Õ:±®±Ìƒ£∞Âª˘”⁄rpt_04_010,¥Ê¥¢π˝≥Ãª˘”⁄UP_OP_EST_DIS_RES_BUS_DIS–ﬁ∏ƒ
  --¡Ÿ ±±Ì£∫t#op_04_004_rpt,t#op_04_004_result
  -------------------------------------------------------------------------------

 as
  v_balance_day varchar(8);
  v_err_num  int;
  v_err_fee  int;
  v_max_day    integer;
  v_ii         integer;
  v_begin_day varchar(8);
  v_end_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day, 1, 8);
  v_begin_day := in_begin_day;
  v_end_day := in_end_day;

--------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ

 /* v_max_day:=substr(v_balance_day,7,2);
  v_ii := 1;
  while v_ii <= v_max_day loop
    insert into t#op_04_004_result
    values
      (substr(v_balance_day,1,6)||lpad(v_ii,2,0),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
     0,
       0,
       0,
       0,
       0);


    v_ii := v_ii + 1;
  end loop;*/

--------------------≤È—Ø‘≠ º ˝æ›-----------------------

----------------------------------------------------------------
--µÿÃ˙»∑»œ
  insert into T#OP_bus_diff_rpt2
    (balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee)
    select balance_water_no,
           '99',
           sum(total_deal_num),
           sum(total_deal_fee)
     from st_sts_mtr_audit_balance
    where substr(balance_water_no,1,8)>= v_begin_day
        and substr(balance_water_no,1,8)<= v_end_day
        and pay_mode_id ='11'
     group by balance_water_no;
--¥ÌŒÛ(∞¥¥ÌŒÛ¿‡–ÕÕ≥º∆)
 insert into t#op_bus_diff_rpt1 a
 select balance_water_no,
        err_code,
        count(*),
        sum(deal_fee)
   from st_ext_mtr_err_deal
        where substr(balance_water_no,1,8) >= v_begin_day
        and substr(balance_water_no,1,8)<= v_end_day
        and pay_mode_id ='11'
   group by balance_water_no,err_code;

 update  t#op_bus_diff_rpt1 a set err_code=(
      select b.err_code_ext from st_cfg_err_acc_ext b where a.err_code=b.err_code_acc)
    where exists (select 1 from st_cfg_err_acc_ext b where a.err_code=b.err_code_acc);

--------------------------π´ΩªÀÕ≥ˆ(◊‹ ˝)-------------------------------
--µÿÃ˙»∑»œ◊‹º∆
insert into t#op_bus_diff_rpt3
  select balance_water_no,
     pay_mode_id,
     total_deal_num,
     total_deal_fee
   from t#op_bus_diff_rpt2;
 --¥ÌŒÛ◊‹º∆
insert into t#op_bus_diff_rpt3
  select b.balance_water_no,
     '99',
     sum(b.err_num),
     sum(b.err_fee)
   from t#op_bus_diff_rpt1 b
   group by b.balance_water_no;

---------------------------------------------------------------------------------
  --µº»ÎΩ·π˚ºØ
  ----µÿÃ˙ACCÀÕ≥ˆ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from t#op_bus_diff_rpt3
      group by to_number(substr(balance_water_no,1,8));
  ------“ªø®Õ®»∑»œ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           sum(total_deal_num),
           sum(total_deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt2
      group by to_number(substr(balance_water_no,1,8));
      ----≤Ó“Ï
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      group by to_number(substr(balance_water_no,1,8));
      ----TAC¥Ì
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '01'
     group by to_number(substr(balance_water_no,1,8));
     ----÷ÿ∏¥
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '02'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®ø®∫≈
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code= '15'
     group by to_number(substr(balance_water_no,1,8));
     ----∑«∑®SAM
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code= '14'
     group by to_number(substr(balance_water_no,1,8));
     -----∑«∑® ±º‰
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '13'
     group by to_number(substr(balance_water_no,1,8));
     ----Œƒº˛ƒ⁄÷ÿ∏¥
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
    where  err_code = '000'--Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
     group by to_number(substr(balance_water_no,1,8));
     ----Ωª“◊¿‡–Õ¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0,
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '10'
     group by to_number(substr(balance_water_no,1,8));
     ----∆±ø®”‡∂Ó∑«∑®
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
       0,
           0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '11'
     group by to_number(substr(balance_water_no,1,8));
     ----Œ¥÷™
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(err_num),
           sum(err_fee),
       0,
           0,
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '99'
     group by to_number(substr(balance_water_no,1,8));


   ----“—ÕÀøÓø®¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
           sum(err_num),
           sum(err_fee),
           0,
           0
      from T#OP_bus_diff_rpt1
      where  err_code = '16'
     group by to_number(substr(balance_water_no,1,8));


   ----∫⁄√˚µ•¥ÌŒÛ
  insert into t#op_04_004_result
    select to_number(substr(balance_water_no,1,8)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
       0,
           0,
       0,
           0,
           sum(err_num),
           sum(err_fee)

      from T#OP_bus_diff_rpt1
      where  err_code = '17'
     group by to_number(substr(balance_water_no,1,8));



    /* ---…œ—ÆÕ≥º∆
           if(v_max_day >=10) then
           insert into t#op_04_004_result
       select '…œ—Æ–°º∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num,

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where to_number(substr(t#op_04_004_result.day,7,2))<= 10;
           end if;

          -- 20160415 add by zzq
          ---÷–—ÆÕ≥º∆
           if(v_max_day >=20) then
           insert into t#op_04_004_result
       select '÷–—Æ–°º∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num, --20160219 add by mqf

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where to_number(substr(t#op_04_004_result.day,7,2)) > 10 and to_number(substr(t#op_04_004_result.day,7,2)) <= 20;
           end if;

            -- 20160415 add by zzq
           ---œ¬—ÆÕ≥º∆
           if(v_max_day =to_number(substr(to_char(last_day(to_date(v_balance_day,'yyyymmdd')),'yyyymmdd'),7,2))) then
           insert into t#op_04_004_result
       select 'œ¬—Æ–°º∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num,

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result where to_number(substr(t#op_04_004_result.day,7,2)) >20 and to_number(substr(t#op_04_004_result.day,7,2))<= v_max_day;
           end if;
           */
     ----ƒ©––∫œº∆
       insert into t#op_04_004_result
       select '∫œº∆', sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee,
       sum(returncard_num) returncard_num,

       sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

       sum(blacklist_fee) blacklist_fee
           from t#op_04_004_result;
           /* where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆');*/

  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day bala_day,
           day,
           v_begin_day in_begin_day,
           v_end_day in_end_day,
           sum(acc_num) bus_out_num,
           sum(acc_fee) bus_out_fee,
           sum(cs_city_num) acc_in_num,
           sum(cs_city_fee) acc_in_fee,
           sum(diff_num) diff_num,
           sum(diff_fee) diff_fee,
           sum(tac_num) tac_num,
           sum(tac_fee) tac_fee,
           sum(repeat_num) repeat_num,
           sum(repeat_fee) repeat_fee,
           sum(nocard_num) nocard_num,
           sum(nocard_fee) nocard_fee,
           sum(nosam_num) nosam_num,
           sum(nosam_fee) nosam_fee,
           sum(notime_num) notime_num,
           sum(notime_fee) notime_fee,
           sum(filere_num) filere_num,
           sum(filere_fee) filere_fee,
           sum(dealerr_num) dealerr_num,
           sum(dealerr_fee) dealerr_fee,
           sum(balance_num) balance_num,
           sum(balance_fee) balance_fee,
           sum(blacklist_num) blacklist_num,
           sum(blacklist_fee) blacklist_fee,
           sum(returncard_num) returncard_num,
           sum(returncard_fee) returncard_fee,
           sum(ot_num) ot_num,
           sum(ot_fee) ot_fee

      from t#op_04_004_result
     group by day
    order by day;
    /*case day when '…œ—Æ–°º∆' then substr(v_balance_day,0,6)||'109'

                         when '÷–—Æ–°º∆' then substr(v_balance_day,0,6)||'209'

                         when 'œ¬—Æ–°º∆' then substr(v_balance_day,0,6)||'319'

                         when '∫œº∆'     then substr(v_balance_day,0,6)||'329'

                         else day
                         end;*/

end;
/
grant execute on ACC_ST.UP_OP_FN_EST_DIS_RES_BUS_DIS to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_EST_DIS_RES_BUS_DIS to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_EST_DIS_RES_DISCOUNT
prompt ================================================
prompt
create or replace procedure acc_st.UP_OP_FN_EST_DIS_RES_DISCOUNT (

                                            in_line_id        varchar,

                                            in_station_id     varchar,

                                            in_card_main_id varchar,

                                            in_card_sub_id  varchar,

                                            in_squad_day      varchar,

                                            in_balance_day    varchar,

                                            in_begin_day    varchar,

                                            in_end_day    varchar,

                                            out_cur_arg       out sys_refcursor)

--------------------------------------------------------------------------------

  --π˝≥Ã√˚£∫  UP_OP_FN_EST_DIS_RES_DISCOUNT

  --π¶ƒ‹√Ë ˆ£∫≤∆ŒÒ±®±Ì--≥§…≥≥« –Õ®ø®«Â∑÷Ω·π˚≤Ó“Ï±®±Ì-ø€÷µ

  -- ‰≥ˆ≤Œ ˝  : Œﬁ

  --¥¥Ω®’ﬂ£∫ ÷”◊”∆Ê

  --¥¥Ω®»’∆⁄£∫20170315

  --±®±Ì±‡∫≈£∫12-005

  --◊¢ Õ:±®±Ìƒ£∞Âª˘”⁄rpt_04_005,¥Ê¥¢π˝≥Ãª˘”⁄UP_OP_EST_DIS_RES_DISCOUNT–ﬁ∏ƒ

  --¡Ÿ ±±Ì£∫t#op_04_004_rpt,t#op_04_004_result

  -------------------------------------------------------------------------------


 is

  v_balance_day varchar(8);

  v_max_day    integer;

  v_ii         integer;

  v_out_type   char(2);

  v_last_day   date;

  v_begin_day  varchar(8);

  v_end_day    varchar(8);

BEGIN

  v_balance_day := substr(in_balance_day, 1, 8);

  v_out_type:='12';

  v_last_day := last_day(to_date(substr(v_balance_day,0,8), 'yyyymmdd'));

  v_begin_day := in_begin_day;

  v_end_day := in_end_day;


  ---------------------------------------------------------------------------------

----≤È—Ø‘≠ º ˝æ›

----------------------------------------------------------------------------------




  insert into t#op_04_004_rpt

    (balance_water_no,

     out_deal_type,

     acc_send_num,

     acc_send_fee,

     out_affirm_num,

     out_affirm_fee,

     error_id,

     error_num,

     error_fee,

     sys_type)

    select balance_water_no,

           out_deal_type,

           acc_send_num,

           acc_send_fee,

           out_affirm_num,

           out_affirm_fee,

           error_id,

           error_num,

           error_fee,

           sys_type

      from st_sts_diff_analysis

     where sys_type='01'

     and (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0') --ø€øÓ¥˙¬Î
         or out_deal_type ='4A') --∏¸–¬ø€øÓ

     and  substr(balance_water_no,1,8) >= v_begin_day

     and substr(balance_water_no,1,8) <= v_end_day;



  --------------------------------------------------------------------------------

  ------ ø€øÓ

    ----µÿÃ˙ACCÀÕ≥ˆ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             sum(acc_send_num),

             sum(acc_send_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --2014-9-5‘ˆº”∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

    ------“ªø®Õ®»∑»œ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             sum(out_affirm_num),

             sum(out_affirm_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

        ----≤Ó“Ï

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt where out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                                   or out_deal_type ='4A' --∏¸–¬ø€øÓ
        group by substr(balance_water_no,1,8);

        ----TAC¥Ì

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
              or out_deal_type ='4A') --∏¸–¬ø€øÓ
              and error_id = '01'

       group by substr(balance_water_no,1,8);

       ----÷ÿ∏¥

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '02'

       group by substr(balance_water_no,1,8);

       ----∑«∑®ø®∫≈

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
       and error_id= '15'

       group by substr(balance_water_no,1,8);

       ----∑«∑®SAM

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
       and error_id= '14'

       group by substr(balance_water_no,1,8);

       -----∑«∑® ±º‰

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '13'
       group by substr(balance_water_no,1,8);

       ----Œƒº˛ƒ⁄÷ÿ∏¥

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
    -- Œƒº˛ƒ⁄÷ÿ∏¥ √ª”–∂‘”¶µƒ÷µ
    and error_id = '000'

       group by substr(balance_water_no,1,8);

       ----Ωª“◊¿‡–Õ¥ÌŒÛ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

             0,

             0,

       0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '10'

       group by substr(balance_water_no,1,8);

       ----∆±ø®”‡∂Ó∑«∑®

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

             0,

             0,

       0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '11'

       group by substr(balance_water_no,1,8);

       ----Œ¥÷™

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             sum(error_num),

             sum(error_fee),

       0,

             0,

             0,

             0

        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '99'

       group by substr(balance_water_no,1,8);

     ----“—ÕÀøÓø®¥ÌŒÛ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

       0,

             0,

             sum(error_num),

             sum(error_fee),

       0,

             0



        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '16'

       group by substr(balance_water_no,1,8);


     ----∫⁄√˚µ•¥ÌŒÛ

    insert into t#op_04_004_result

      select substr(balance_water_no,1,8),

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

             0,

       0,

             0,

       0,

             0,

       0,

             0,

             sum(error_num),

             sum(error_fee)



        from t#op_04_004_rpt

        where (out_deal_type in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
                or out_deal_type ='4A') --∏¸–¬ø€øÓ
        and error_id = '17'

       group by substr(balance_water_no,1,8);


       ----…œ—Æ–°º∆  --2016.04.14 add by zy

      /*  if to_number(substr(v_balance_day,7,2))>=10

        then begin

          insert into t#op_04_004_result

           select '…œ—Æ–°º∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num,

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆') and to_number(substr(day,7,2))<=10;

      end;

      end if;

        ----÷–—Æ–°º∆

        if to_number(substr(v_balance_day,7,2))>=20

        then begin

          insert into t#op_04_004_result

           select '÷–—Æ–°º∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num,

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆') and to_number(substr(day,7,2)) >10 and to_number(substr(day,7,2)) <= 20;

      end;

      end if;

        ----œ¬—Æ–°º∆

        if to_date(substr(v_balance_day,0,8),'yyyymmdd') = v_last_day

        then begin

          insert into t#op_04_004_result

           select 'œ¬—Æ–°º∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num,

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result
             where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆')and to_number(substr(day,7,2)) >20;--20160412 add by zy

      end;

      end if;*/

       ----ƒ©––∫œº∆

         insert into t#op_04_004_result

         select '∫œº∆', sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee,

       sum(returncard_num) returncard_num,

             sum(returncard_fee) returncard_fee,

       sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee

             from t#op_04_004_result;

             --where DAY NOT IN('…œ—Æ–°º∆','÷–—Æ–°º∆','œ¬—Æ–°º∆');

  --------------------------------------------------------------------------------

    --∑µªÿΩ·π˚ºØ

    open out_cur_arg for

      select v_balance_day bala_day,

      --added by zzq 20170331
             v_begin_day in_begin_day,

             v_end_day in_end_day,

             day,

             sum(acc_num) acc_num,

             sum(acc_fee) acc_fee,

             sum(cs_city_num) cs_city_num,

             sum(cs_city_fee) cs_city_fee,

             sum(diff_num) diff_num,

             sum(diff_fee) diff_fee,

             sum(tac_num) tac_num,

             sum(tac_fee) tac_fee,

             sum(repeat_num) repeat_num,

             sum(repeat_fee) repeat_fee,

             sum(nocard_num) nocard_num,

             sum(nocard_fee) nocard_fee,

             sum(nosam_num) nosam_num,

             sum(nosam_fee) nosam_fee,

             sum(notime_num) notime_num,

             sum(notime_fee) notime_fee,

             sum(filere_num) filere_num,

             sum(filere_fee) filere_fee,

             sum(dealerr_num) dealerr_num,

             sum(dealerr_fee) dealerr_fee,

             sum(balance_num) balance_num,

             sum(balance_fee) balance_fee,

             sum(blacklist_num) blacklist_num,

             sum(blacklist_fee) blacklist_fee,

              sum(returncard_num) returncard_num,

             sum(returncard_fee) returncard_fee,

             sum(ot_num) ot_num,

             sum(ot_fee) ot_fee

        from t#op_04_004_result

       group by day

       order by day;  --2016.04.14 cancel by zy

      -- order by

        --    case day when '…œ—Æ–°º∆' then substr(v_balance_day,0,6)||'109'

                --         when '÷–—Æ–°º∆' then substr(v_balance_day,0,6)||'209'

                  --       when 'œ¬—Æ–°º∆' then substr(v_balance_day,0,6)||'319'

                   --      when '∫œº∆'     then substr(v_balance_day,0,6)||'329'

                     --    else day

                    --     end;

  end;
/
grant execute on ACC_ST.UP_OP_FN_EST_DIS_RES_DISCOUNT to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_EST_DIS_RES_DISCOUNT to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_INC_DISPART_STA_D
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_FN_INC_DISPART_STA_D (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             in_begin_day      varchar,
                                             in_end_day        varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_FN_INC_DISPART_STA_D
  --±®±Ì±‡∫≈£∫RPT_12_002
  --π¶ƒ‹√Ë ˆ£∫≤∆ŒÒ±®±Ì--øÕ‘À ’»Î«Â∑÷»’±®
  -- ˝æ›‘¥±Ì£∫st_sts_inc_consume
  --¡Ÿ ±±Ì£∫t#op_inc_dispart_result,t#op_inc_dispart_rpt
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zhouyang
  --¥¥Ω®»’∆⁄£∫20170316
---------------------------------------------------------------------------------
 --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170724
  --–ﬁ∏ƒƒ⁄»›£∫
     --–¬‘ˆ¥≈∏°Õ®«⁄ø®∆±÷÷
  -------------------------------------------------------------------------------------
 is
  v_line_id varchar(2);
  v_line_name varchar(20);
  v_begin_day varchar(8);
  v_end_day varchar(8);
BEGIN
   v_line_id:=substr(in_line_id,1,2);
   v_begin_day:=substr(in_begin_day,1,8);
   v_end_day:=substr(in_end_day,1,8);
if v_line_id != ' ' and v_line_id is not null then
select a.line_name into v_line_name from op_prm_line a
    where a.record_flag='0' and a.line_id=v_line_id
      and exists (select 1 from op_prm_line a
    where a.record_flag='0' and a.line_id=v_line_id);

end if;
 ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_inc_dispart_result
        select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0
         from op_prm_station a
         where a.record_flag='0' and a.line_id=v_line_id;

----≤È—Ø≤¢≤Â»Î ˝æ›
insert into t#op_inc_dispart_rpt
     (balance_day,squad_day,line_id,station_id,card_main_id,card_sub_id,deal_num,deal_fee)
    select substr(balance_water_no,1,8),squad_day,line_id,station_id,card_main_id,card_sub_id,deal_num,deal_fee
           from st_sts_inc_consume
    where substr(balance_water_no,1, 8) >= v_begin_day
           and substr(balance_water_no,1, 8)<=v_end_day
           and line_id=v_line_id;

 --Ω·π˚ºØ≤Â»Î ˝æ›
--∆’Õ®¥¢÷µ∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0
            from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='00'
     and line_id=v_line_id
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='01'
     and line_id=v_line_id
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='06'
     and line_id=v_line_id
     group by line_id,station_id;

  --“Ï–Œø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='07'
     and line_id=v_line_id
     group by line_id,station_id;

  -- ÷ª˙ø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='08'
     and line_id=v_line_id
     group by line_id,station_id;
       --¥≈∏°Õ®«⁄ø®   20170724
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
           from t#op_inc_dispart_rpt
     where  card_main_id='09' and card_sub_id='01'
     and line_id=v_line_id
     group by line_id,station_id;

  ----ƒ©––◊‹º∆
insert into t#op_inc_dispart_result
    select line_id,line_name,'99','99◊‹º∆',sum(num0),sum(fee0),sum(num1),sum(fee1),sum(num2),sum(fee2),sum(total_num),sum(total_fee),
    sum(num3),sum(fee3),sum(num4),sum(fee4),sum(num5),sum(fee5)
       from t#op_inc_dispart_result
    group by line_id,line_name;

       ----∏¸–¬œﬂ¬∑
   update t#op_inc_dispart_result a
     set a.line_name = (select b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
      where  exists (select 1 from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0');
      --∏¸–¬’æµ„
   update t#op_inc_dispart_result a
     set a.station_name = (select b.station_id || b.chinese_name from op_prm_station b
   where a.line_id = b.line_id and a.station_id=b.station_id and b.record_flag = '0')
      where exists (select 1 from op_prm_station b
   where a.line_id = b.line_id and a.station_id=b.station_id and b.record_flag = '0');


------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_begin_day||v_end_day v_day,
           v_line_name v_line_name,
           line_id,
           line_name,
           station_id,
           substr(station_name,3) station_name,
           sum(num0) num0,
           sum(fee0) fee0,
           sum(num1) num1,
           sum(fee1) fee1,
           sum(num2) num2,
           sum(fee2) fee2,
           sum(num3) num3,
           sum(fee3) fee3,
           sum(num4) num4,
           sum(fee4) fee4,
           sum(num5) num5,
           sum(fee5) fee5,
           sum(num0+num1+num2+num3+num4+num5) total_num,
           sum(fee0+fee1+fee2+fee3+fee4+fee5) total_fee
      from t#op_inc_dispart_result
     group by line_id,line_name,station_id,station_name
     order by station_id,station_name;
end;
/
grant execute on ACC_ST.UP_OP_FN_INC_DISPART_STA_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_INC_DISPART_STA_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_INC_LINE_INCOME_D
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_FN_INC_LINE_INCOME_D (
                                                     in_line_id varchar,
                                                     in_station_id varchar,
                                                     in_squad_day varchar,
                                                     in_balance_day varchar,
                                                     in_card_main_id varchar,
                                                     in_card_sub_id varchar,
                                                     in_begin_day   varchar,
                                                     in_end_day     varchar,
                                                     out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫UP_OP_INC_LINE_INCOME_M
--ƒ£∞Â√˚£∫rpt_12_001
--π¶ƒ‹√Ë ˆ£∫œ˙ € ’“Ê¿‡±®±Ì--œﬂ¬∑ ’“ÊÕ≥º∆»’±®
-- ˝æ›‘¥±Ì£∫st_sts_inc_station
--¡Ÿ ±±Ì£∫t#OP_INC_STA_INCOME_RPT£¨t#OP_INC_STA_INCOME_RESULT
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫ zhouyang
--¥¥Ω®»’∆⁄£∫20170315
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±÷÷Õ≥º∆
-------------------------------------------------------------------------------
AS
        v_begin_day varchar(8);
        v_end_day varchar(8);
BEGIN
v_begin_day:=substr(in_begin_day,1,8);
v_end_day:=substr(in_end_day,1,8);
--≤È—Øœ‡πÿ ˝æ›
 insert into  t#OP_INC_STA_INCOME_RPT
 (line_id,station_id,squad_day,tr_type_id,paymode_id,do_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty)
               select line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
                where  substr(balance_water_no,1,8)>=v_begin_day and substr(balance_water_no,1,8)<=v_end_day ;
-------------------µ•≥Ã∆±∑¢ €----------------------
--TVMµ•≥Ã∆±∑¢ €
     insert into t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='01'  and
               dev_type_id='02'    and
               tr_type_id='50'
        group by line_id;
--bomµ•≥Ã∆±∑¢ €
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              dev_type_id='03' and
              tr_type_id='50'
        group by line_id;
--µ•≥Ã∆±∑¢ €–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='50'
        group by line_id;
-------------------≥‰÷µΩ∂Ó----------------------
--TVM≥‰÷µ
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  dev_type_id='02' and
               tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;

--BOM≥‰÷µ
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where dev_type_id='03' and
              tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;

--≥‰÷µ–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;
----—∫Ω–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  (tr_type_id='50' or tr_type_id='51')
        group by line_id;
-------------------∏¸–¬Ω∂Ó----------------------
--------------œ÷Ω∏¸–¬£∫
--µ•≥À∆±œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='01'
        group by line_id;
--µÿÃ˙¥¢÷µ∆±œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
              tr_type_id='56' and paymode_id='01'
        group by line_id;
--≥« –Õ®œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='01'
       group by line_id;
---------------∏¸–¬∑«œ÷Ω(∏¸–¬Ω∂Ó≤ªŒ™0)£∫
---------------------- ˝æ›¿¥‘¥£∫deal±Ì---------------------------------
--µ•≥À∆±∑«œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id;
--≥« –Õ®∑«œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id;
-----------------------------------------------------------------------
--20140729∏¸–¬£ª
---------------------- ˝æ›¿¥‘¥£∫update±Ì---------------------------------
--∑«œ÷Ω∏¸–¬£∫
--µ•≥À∆±∑«œ÷Ω
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id;
----------------------------------------------------------------------
--∏¸–¬–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,sum(update_dc+update_dt+update_oct+update_dc2+update_dt2+update_oct2),0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RESULT
       group by line_id;
-------------------≥Â’˝----------------------
--µÿÃ˙¥¢÷µ∆±≥Â’˝
    insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'','','',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
             tr_type_id='54' and paymode_id='18'
       group by line_id;
--≥« –Õ®≥Â’˝
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='06' and
               tr_type_id='54' and paymode_id='18'
        group by line_id;
-------------------––’˛¥¶¿Ì----------------------
--√‚∑—Ω¯≥ˆ’æ∆± ˝¡ø
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='61' and do_type in('02')
        group by line_id;
--∏∂∑—≥ˆ’æ∆± ˝¡ø
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='61' and do_type='03'
        group by line_id;
--––’˛ ¬ŒÒ ’»Î
--––’˛ ¬ŒÒ÷ß≥ˆ
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),0,0,0,0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where tr_type_id='61'
          group by line_id;
-------------------ÕÀøÓ----------------------
--—∫Ω
--”‡∂Ó
--¥¢÷µ∆±≥À≥µø€
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
                 tr_type_id='57'
          group by line_id;
--µ•≥Ã∆±ÕÀøÓ
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_bala),0,0
         from t#OP_INC_STA_INCOME_RPT
          where card_main_code='01' and
                tr_type_id='57'
          group by line_id;
--ÕÀøÓ–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee+return_bala-penalty),0
         from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='57'
        group by line_id;
-------------------”¶ ’Ω∂Ó---------------------- = µ•≥Ã∆±∑¢ €–°º∆£´≥‰÷µ–°º∆£´—∫Ω–°º∆£´∏¸–¬–°º∆£´––’˛ ¬ŒÒ ’»Î£≠∏¸–¬£®∑«œ÷Ω£©£≠≥Â’˝Ω∂Ó£≠––’˛ ¬ŒÒ÷ß≥ˆ£≠ÕÀøÓ–°º∆
insert into t#OP_INC_STA_INCOME_RESULT
  select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(sale_total+add_total+fee_total+update_total-cut_oct-cut_dt-update_dc2-update_dt2-update_oct2+affair_penalty-affair_return-ret_total)
  from t#OP_INC_STA_INCOME_RESULT
             group by line_id;
--∏¸–¬œﬂ¬∑√˚
update t#OP_INC_STA_INCOME_RESULT a
set a.line_name =(
select b.line_id||b.line_name
from op_prm_line b
where b.record_flag='0' and a.line_id=b.line_id);
------------------------------------◊‹º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
          select '99','99◊‹º∆','99','◊‹º∆',
       sum(tvm_sale),--tvm∑¢ €
       sum(bom_sale ),--bom∑¢ €
       sum(sale_total),--∑¢ €–°º∆
       sum(tvm_add  ),--tvm≥‰÷µ
       sum(bom_add ),--bom≥‰÷µ
       sum(add_total),--≥‰÷µ–°º∆
       sum(fee_total ),--—∫Ω–°º∆
       sum(update_dc ),--∏¸–¬£®œ÷Ω£©µ•≥Ã∆±
       sum(update_dt ),--∏¸–¬£®œ÷Ω£©µÿÃ˙£®¥¢–Ó°¢“Ï–‘°¢ ÷ª˙°¢¥≈∏°£©
       sum(update_oct ),--∏¸–¬£®œ÷Ω£©≥« –Õ®
       sum(update_dc2 ),--∏¸–¬£®∑«œ÷Ω£©µ•≥Ã∆±
       sum(update_dt2 ),--∏¸–¬£®∑«œ÷Ω£©µÿÃ˙£®¥¢–Ó°¢“Ï–‘°¢ ÷ª˙°¢¥≈∏°£©
       sum(update_oct2 ),--∏¸–¬£®∑«œ÷Ω£©≥« –Õ®
       sum(update_total),--∏¸–¬–°º∆
       sum(cut_dt),--≥Â’˝µÿÃ˙£®¥¢–Ó°¢“Ï–‘°¢ ÷ª˙°¢¥≈∏°£©
       sum(cut_oct),--≥Â’˝≥« –Õ®
       sum(affair_02),--––’˛¥¶¿Ì √‚∑—Ω¯/≥ˆ’æ∆± ˝¡ø
       sum(affair_03),--––’˛¥¶¿Ì ∏∂∑—≥ˆ’æ∆± ˝¡ø
       sum(affair_penalty),--––’˛ ¬ŒÒ»Î
       sum(affair_return),--––’˛ ¬÷ß≥ˆ
       sum(ret_desosit),--ÕÀøÓ—∫Ω
       sum(ret_bala),--ÕÀøÓ”‡∂Ó
       sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
       sum(ret_sjt),--ÕÀøÓµ•≥Ã∆±
       sum(ret_total),--ÕÀøÓ–°º∆
       sum(total)--”¶ ’œ÷ΩΩ∂Ó
       from t#OP_INC_STA_INCOME_RESULT
       where line_id<>'99';
--∑µªÿΩ·π˚
open out_cursor for
select   v_begin_day||v_end_day v_day,
      line_id,substr(line_name,3) line_name,
      sum(tvm_sale)          tvm_sale,
      sum(bom_sale )         bom_sale,
      sum(sale_total)        sale_total,
      sum(tvm_add)           tvm_add  ,
      sum(bom_add )          bom_add ,
      sum(add_total)         add_total,
      sum(fee_total)         fee_total ,
      sum(update_dc)         update_dc ,
      sum(update_dt)         update_dt ,
      sum(update_oct)        update_oct ,
      sum(update_dc2)        update_dc2 ,
      sum(update_dt2)        update_dt2 ,
      sum(update_oct2)       update_oct2 ,
      sum(update_total)      update_total,
      sum(cut_dt)            cut_dt,
      sum(cut_oct)           cut_oct    ,
      sum(affair_02)         affair_02,
      sum(affair_03)         affair_03  ,
      sum(affair_penalty)    affair_penalty,
      sum(affair_return)     affair_return,
      sum(ret_desosit)       ret_desosit,
      sum(ret_bala)          ret_bala,
      sum(penalty)           penalty,
      sum(ret_sjt)           ret_sjt,
      sum(ret_total)         ret_total,
      sum(total)             total
      from t#OP_INC_STA_INCOME_RESULT
      group by line_id,line_name
      order by line_id,line_name;
      end;
/
grant execute on ACC_ST.UP_OP_FN_INC_LINE_INCOME_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_INC_LINE_INCOME_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_IST_INCOME_CONTC_D
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_FN_IST_INCOME_CONTC_D(in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             in_begin_day      varchar,
                                             in_end_day        varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_FN_IST_INCOME_CONTC_D
  --π¶ƒ‹√Ë ˆ£∫≤∆ŒÒ±®±Ì--‘À”™…Ã ’»Î»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ lucankun
  --¥¥Ω®»’∆⁄£∫20170316
  --±®±Ì±‡∫≈£∫rpt_12_004
  --¡Ÿ ±±Ì£∫t#op_03_009_result,t#op_03_009_rpt
  --Àµ√˜£∫ª˘”⁄rpt_03_009
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ:zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170723
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
  v_begin_day varchar(8);
  v_end_day   varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);
  v_begin_day := substr(in_begin_day,1,8);
  v_end_day := substr(in_end_day,1,8);
--¥”÷–º‰±Ì≤È—Ø ˝æ› Õ≥“ªΩ´Àƒ÷÷≥« –Õ®∆±OCT∂®Œ™0600
  insert into t#op_03_009_rpt
    (contc_id,squad_day,balance_water_no,card_sub_code,card_main_code,deal_fee)
    select contc_id,
           squad_day,
           balance_water_no,
           case when card_main_id='06' then '00' else card_sub_id end,
           card_main_id,
           deal_fee
    from st_sts_income_contc_card
      where balance_water_no between (v_begin_day || '00') and (v_end_day || '99');
      --and squad_day=v_squad_day;
--∆’Õ®≥…»Àµ•≥Ã∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '01'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--≥…»À∆’Õ®¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--—ß…˙∆’Õ®¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '01'
     group by b.contc_id, b.contc_name, squad_day;
--¿œ»À√‚∑—¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '02'
     group by b.contc_id, b.contc_name, squad_day;
--¿œ»À”≈ª›¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '03'
     group by b.contc_id, b.contc_name, squad_day;
  --∆’Õ®≥À¥Œ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '03'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
  --∆’Õ®ºÕƒÓ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '04'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
 --”≈ª›ºÕƒÓ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '04'
       and card_sub_code = '01'
     group by b.contc_id, b.contc_name, squad_day;
--≥« –Õ®∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '06'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--∆’Õ®“Ï–Œ¥¢÷µø®
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '07'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--∆’Õ® ÷ª˙∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '08'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--¥≈∏°Õ®«⁄ø®
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '09'
       and card_sub_code = '01'
     group by b.contc_id, b.contc_name, squad_day;
--–°º∆
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee)
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
     group by b.contc_id, b.contc_name, squad_day;
-------------------------------
-----ƒ©––◊‹º∆‘⁄ÀÆæß±®±Ì…Ë÷√----
-------------------------------
  ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           v_begin_day in_begin_day,
           v_end_day in_end_day,
           sequence || contc_name linekey1,
           sum(singl) as singl,
           sum(svt) as svt,
           sum(stu_svt) as stu_svt,
           sum(old_svt_free) as old_svt_free,
           sum(old_svt_pre) as old_svt_pre,
           sum(sin_times) as sin_times,
           sum(memory_sin) as memory_sin,
           sum(memory_pre) as memory_pre,
           sum(cs_city) as cs_city,
           sum(special) as special,
           sum(mobile) as mobile,
           sum(commuter) as commuter,
           sum(total) as total
     from t#op_03_009_result
     group by sequence, contc_name
     order by sequence, contc_name;
end;
/
grant execute on ACC_ST.UP_OP_FN_IST_INCOME_CONTC_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_IST_INCOME_CONTC_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_IST_ST_CONTC_DEAL_D
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_FN_IST_ST_CONTC_DEAL_D(in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             in_begin_day      varchar,
                                             in_end_day        varchar,
                                             out_cur_arg       out sys_refcursor)
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_FN_IST_ST_CONTC_DEAL_D
  --π¶ƒ‹√Ë ˆ£∫≤∆ŒÒ±®±Ì--‘À”™…ÃΩª“◊ ˝æ›Ω·À„»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zhouyang
  --¥¥Ω®»’∆⁄£∫20170502
  --±®±Ì±‡∫≈£∫rpt_12_003
  --¡Ÿ ±±Ì£∫t#op_03_010_result,t#OP_IST_SETTLE_CONTC_DEAL_D
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫ zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170722
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
  -------------------------------------------------------------------------------
 is
  v_begin_day varchar(8);
  v_end_day varchar(8);
BEGIN
  v_begin_day := substr(in_begin_day,1,8);
  v_end_day:=substr(in_end_day,1,8);
  -------------------------------------------------------------------------------
  ----≤È—Ø ˝æ› (µ•≥Ã∆±∑¢ € °¢≥‰÷µ°¢≥Â’˝°¢ÕÀøÓ°¢––’˛ ’∑—)
  insert into t#OP_IST_SETTLE_CONTC_DEAL_D
  (squad_day,contc_id,tr_type_id,pay_mode_id,deal_num,deal_fee)
    select
           squad_day,
           contc_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee
      from st_sts_balance_contc_trd
     where substr(balance_water_no, 1, 8)>= v_begin_day
        and substr(balance_water_no, 1, 8)<=v_end_day
        and
           (
             (tr_type_id ='50') --µ•≥Ã∆±∑¢ €
             or (tr_type_id = '54' and pay_mode_id = '14')--≥‰÷µ
             or (tr_type_id = '54' and pay_mode_id = '18')--≥Â’˝
             or (tr_type_id = '57')--ÕÀøÓ
             or (tr_type_id = '61')--––’˛ ’∑—
           );
  ----≤È—Ø ˝æ›£®—∫Ω°¢π§±æ∑—°¢œ˚∑—°¢∏¸–¬£©
  insert into t#OP_IST_SETTLE_CONTC_DEAL_D
   (contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,card_main_id,
    card_sub_id,tr_type_id,pay_mode_id,deal_num,deal_fee,deposit_type)
    select
           contc_id,
           belong_line_id,
           belong_contc_id,
           squad_day,
           balance_water_no,
           card_main_id,
           card_sub_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee,
           deposit_type
    from st_sts_income_contc_card_mode
     where substr(balance_water_no, 1, 8)>= v_begin_day
        and substr(balance_water_no, 1, 8)<=v_end_day
        and
           (
                (deposit_type = '1' and tr_type_id = '51') --—∫Ω
             or (deposit_type = '0' and tr_type_id = '51')--π§±æ∑—
             or (tr_type_id = '54' and pay_mode_id in('12','1C','42','4C','92','9C'))--œ˚∑—
             or ((tr_type_id = '56') or (tr_type_id = '54' and pay_mode_id in('1A','4A')))--∏¸–¬
           );
  -------------------------------------------------------------------------------
  ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_03_010_result
    select contc_name,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from op_prm_contc
     where record_flag = '0';
  --œ˙ €(µ•≥Ã∆±)
  insert into t#op_03_010_result
    select contc_id,
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '50'
     group by contc_id;
  --—∫Ω
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where deposit_type = '1' and tr_type_id = '51'
     group by contc_id;
  --π§±æ∑—
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where deposit_type = '0' and tr_type_id = '51'
     group by contc_id;
  --≥‰÷µ
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '54'
       and pay_mode_id = '14'
     group by contc_id;
  --≥Â’˝
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '54'
       and pay_mode_id = '18'
     group by contc_id;
  --œ˚∑—
     --µ•≥Ã∆±
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='01' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --µÿÃ˙¥¢÷µø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --π´Ωªø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='06' and card_sub_id in('00','01','02','03')
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --“Ï–Œø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='07' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --—ß…˙ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='01'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --¿œ»À√‚∑—ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='03'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
   --¥≈∏°Õ®«⁄ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='09' and card_sub_id='01'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
  --ÕÀøÓ
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '57'
     group by contc_id;
  --∏¸–¬
     --µ•≥Ã∆±
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where ((tr_type_id = '56') or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='01' and card_sub_id='00'
     group by contc_id;
     --µÿÃ˙¥¢÷µø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='00'
     group by contc_id;
     --π´Ωªø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='06' and card_sub_id in('00','01','02','03')
     group by contc_id;
     --“Ï–Œø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='07' and card_sub_id='00'
     group by contc_id;
     --—ß…˙ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='01'
     group by contc_id;
     --¿œ»À√‚∑—ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='03'
     group by contc_id;
     --¥≈∏°Õ®«⁄ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='09' and card_sub_id='01'
     group by contc_id;
  --––’˛ ’∑—
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '61'
     group by contc_id;

     --∏¸–¬‘À”™…Ã√˚
  update t#op_03_010_result a
     set contc_name = (select b.contc_id || b.contc_name from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0')
     where exists (select 1 from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0');

         ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_begin_day as begin_day,
           v_end_day   as end_day,
           contc_name rowkey,
           sum(sale_num) as sale_num ,
           sum(sale_fee) as sale_fee ,
           sum(deposit_num) as deposit_num ,
           sum(deposit_fee) as deposit_fee ,
           sum(cost_num) as cost_num,
           sum(cost_fee) as cost_fee,
           sum(charge_num) as charge_num ,
           sum(charge_fee) as charge_fee ,
           sum(cut_num) as cut_num ,
           sum(cut_fee) as cut_fee ,
           sum(consume_single_fee) as consume_single_fee ,
           sum(consume_metro_fee) as consume_metro_fee ,
           sum(consume_bus_fee) as consume_bus_fee ,
           sum(consume_alien_fee) as consume_alien_fee ,
           sum(consume_student_fee) as consume_student_fee ,
           sum(consume_old_fee) as consume_old_fee ,
           sum(consume_commuter_fee) as consume_commuter_fee ,
           sum(return_num) as return_num ,
           sum(return_fee) as return_fee ,
           sum(update_single_fee) as update_single_fee ,
           sum(update_metro_fee) as update_metro_fee ,
           sum(update_bus_fee) as update_bus_fee ,
           sum(update_alien_fee) as update_alien_fee ,
           sum(update_student_fee) as update_student_fee ,
           sum(update_old_fee) as update_old_fee ,
           sum(update_commuter_fee) as update_commuter_fee ,
           sum(affair_num) as affair_num ,
           sum(affair_fee) as affair_fee ,
           sum(sale_num + deposit_num + cost_num + charge_num + cut_num +
               return_num + affair_num) as total_num ,
           sum(sale_fee + deposit_fee + cost_fee + charge_fee + consume_single_fee + consume_metro_fee
            + consume_bus_fee + consume_alien_fee + consume_student_fee + consume_old_fee +  consume_commuter_fee - cut_fee
            - return_fee + update_single_fee + update_metro_fee + update_bus_fee
            + update_alien_fee + update_student_fee + update_old_fee + update_commuter_fee + affair_fee) as total_fee
      from t#op_03_010_result
     group by contc_name
     order by contc_name;
end;
/
grant execute on ACC_ST.UP_OP_FN_IST_ST_CONTC_DEAL_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_IST_ST_CONTC_DEAL_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_MB_STA_ACC_LCC_DAY
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_FN_MB_STA_ACC_LCC_DAY (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             in_begin_day      varchar,
                                             in_end_day        varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_FN_MB_STA_ACC_LCC_DAY
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì--ACC”Î ÷ª˙÷ß∏∂∂‘’À»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ldz
  --¥¥Ω®»’∆⁄£∫20170316
  --±®±Ì±‡∫≈£∫rpt_12_007
  --¡Ÿ ±±Ì£∫T#OP_MB_STA_ACC_LCC_DAY_RESULT

 is
  v_i      integer;
  v_j      integer;
  v_begin_day char(8);
  v_end_day char(8);
  v_balance_day varchar(8);

  v_date_begin_day Date;
  v_date_end_day Date;
  v_date Date;
BEGIN
  v_balance_day:=substr(in_balance_day, 1, 8);
  v_begin_day:= in_begin_day;
  v_end_day:= in_end_day;

  v_date_begin_day := to_date(in_begin_day,'yyyymmdd');
  v_date_end_day := to_date(in_end_day,'yyyymmdd');
  v_date := v_date_begin_day;
-----------------------------------------------------------------------------------
  --20170504 modify by mqf
  while v_date <= v_date_end_day loop
    v_j := 1;
    while v_j <= 3 loop
        insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        values
        (lpad(to_char(v_date,'yyyymmdd'),8,0),
             to_char(v_j),
             null,
             0,
             0,
             0,
             0,
             0,
             0,
             0,
             0);
        v_j := v_j + 1;
    end loop;
    v_date := v_date + 1;
  end loop;
---------------------------------------------------------------------------------
---- ÷ª˙÷ß∏∂LCC∂‘’À±Ì ∑¢ €Ω∂Ó º¥ ∑¢ €—∫Ω
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select substr(balance_water_no, 1, 8),
           '1',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.st_mb_sts_lcc
     where substr(balance_water_no,1,8) >= v_begin_day and substr(balance_water_no,1,8) <= v_end_day
     group by substr(balance_water_no, 1, 8);
---------------------------------------------------------------------------------
---- ÷ª˙÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select substr(balance_water_no, 1, 8),
           '2',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.st_mb_sts_acc
     where substr(balance_water_no,1,8) >= v_begin_day and substr(balance_water_no,1,8) <= v_end_day
     group by substr(balance_water_no, 1, 8);
---------------------------------------------------------------------------------
----- ÷ª˙÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select substr(balance_water_no, 1, 8),
           '3',
           null,
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0)),
           sum(nvl(diff_deal_num,0)),
           sum(nvl(diff_deal_fee,0)),
           sum(nvl(diff_return_num,0)),
           sum(nvl(diff_return_fee,0)),
           sum(nvl(diff_lock_num,0)),
           sum(nvl(diff_unlock_num,0))
      from acc_st.st_mb_sts_lcc_acc
     where substr(balance_water_no,1,8) >= v_begin_day and substr(balance_water_no,1,8) <= v_end_day
     group by substr(balance_water_no, 1, 8);
---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select '◊‹º∆',
           data_type,
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
      where data_type in ('1','2') --20160823 modify by mqf ÷ª¿€º∆÷ß∏∂∆ΩÃ®°¢ACC
      group by data_type;

  --20160823 modify by mqf  ◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select '◊‹º∆',
           '3',
           null,
           nvl(a.sale_num,0) - nvl(b.sale_num,0),
           nvl(a.deposit_fee,0) - nvl(b.deposit_fee,0),
           nvl(a.deal_num,0) - nvl(b.deal_num,0),
           nvl(a.deal_fee,0) - nvl(b.deal_fee,0),
           nvl(a.return_num,0) - nvl(b.return_num,0),
           nvl(a.return_fee,0) - nvl(b.return_fee,0),
           nvl(a.lock_num,0) - nvl(b.lock_num,0),
           nvl(a.unlock_num,0) - nvl(b.unlock_num,0)
     from
       (select sale_num, deposit_fee , deal_num, deal_fee, return_num, return_fee, lock_num, unlock_num
        from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='1' ) a,
        (select sale_num, deposit_fee , deal_num, deal_fee, return_num, return_fee, lock_num, unlock_num
        from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='2' ) b;


---------------------------------------------------------------------------------
--∏¸–¬data_type_name
  update acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
     set data_type_name= (case when data_type='1'then '÷ß∏∂∆ΩÃ®'
                            when data_type='2'then 'ACC'
                            when data_type='3'then '≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)'
                          end);
---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           v_begin_day begin_day,
           v_end_day end_day,
       day,
           data_type,
           data_type_name,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(return_num) as return_num,
           sum(return_fee) as return_fee,
           sum(lock_num) as lock_num,
           sum(unlock_num) as unlock_num
      from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
      group by day,data_type,data_type_name
      order by day,data_type,data_type_name;
end;
/
grant execute on ACC_ST.UP_OP_FN_MB_STA_ACC_LCC_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_MB_STA_ACC_LCC_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_FN_NP_STA_ACC_LCC_DAY
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_FN_NP_STA_ACC_LCC_DAY (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             in_begin_day      varchar,
                                             in_end_day        varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_FN_NP_STA_ACC_LCC_DAY
  --π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂±®±Ì--ACC”Îª•¡™Õ¯÷ß∏∂∂‘’À»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ¡ıµ¬‘ˆ
  --¥¥Ω®»’∆⁄£∫20170316
  --±®±Ì±‡∫≈£∫rpt_12_008
  --¡Ÿ ±±Ì£∫T#OP_NP_STA_ACC_LCC_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_i      integer;
  v_j      integer;
  v_begin_day char(8);
  v_end_day char(8);
  v_balance_day varchar(8);

  v_date_begin_day Date;
  v_date_end_day Date;
  v_date Date;
BEGIN
  v_balance_day:=substr(in_balance_day, 1, 8);
  v_begin_day:= in_begin_day;
  v_end_day:= in_end_day;

  v_date_begin_day := to_date(in_begin_day,'yyyymmdd');
  v_date_end_day := to_date(in_end_day,'yyyymmdd');
  v_date := v_date_begin_day;

-----------------------------------------------------------------------------------
  --20170504 modify by mqf
  while v_date <= v_date_end_day loop
    v_j := 1;
    while v_j <= 3 loop
      insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      values
      (lpad(to_char(v_date,'yyyymmdd'),8,0),
         to_char(v_j),
         null,
         0,
         0,
         0,
         0
          );
      v_j := v_j + 1;
    end loop;
    v_date := v_date + 1;
  end loop;

---------------------------------------------------------------------------------
----ª•¡™Õ¯÷ß∏∂LCC∂‘’À±Ì ∑¢ €Ω∂Ó º¥ ∑¢ €—∫Ω
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select substr(balance_water_no, 1, 8),
           '1',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(charge_num,0)),
           sum(nvl(charge_fee,0))
      from acc_st.st_np_sts_lcc
     where substr(balance_water_no,1,8) >= v_begin_day and substr(balance_water_no,1,8) <= v_end_day
     group by substr(balance_water_no, 1, 8);
---------------------------------------------------------------------------------
----ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select substr(balance_water_no, 1, 8),
           '2',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0))
      from acc_st.st_np_sts_acc
     where substr(balance_water_no,1,8) >= v_begin_day and substr(balance_water_no,1,8) <= v_end_day
     group by substr(balance_water_no, 1, 8);
---------------------------------------------------------------------------------
-----ª•¡™Õ¯÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select substr(balance_water_no, 1, 8),
           '3',
           null,
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0)),
           sum(nvl(diff_deal_num,0)),
           sum(nvl(diff_deal_fee,0))
      from acc_st.st_np_sts_lcc_acc
    where substr(balance_water_no,1,8) >= v_begin_day and substr(balance_water_no,1,8) <= v_end_day
     group by substr(balance_water_no, 1, 8);
---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select '◊‹º∆',
           data_type,
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0))
      from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      where data_type in ('1','2') --÷ª¿€º∆÷ß∏∂∆ΩÃ®°¢ACC
      group by data_type;

  -- ◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select '◊‹º∆',
           '3',
           null,
           nvl(a.sale_num,0) - nvl(b.sale_num,0),
           nvl(a.deposit_fee,0) - nvl(b.deposit_fee,0),
           nvl(a.deal_num,0) - nvl(b.deal_num,0),
           nvl(a.deal_fee,0) - nvl(b.deal_fee,0)
     from
       (select sale_num, deposit_fee , deal_num, deal_fee
        from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='1' ) a,
        (select sale_num, deposit_fee , deal_num, deal_fee
        from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='2' ) b;


---------------------------------------------------------------------------------
--∏¸–¬data_type_name
  update acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
     set data_type_name= (case when data_type='1'then '÷ß∏∂∆ΩÃ®'
                            when data_type='2'then 'ACC'
                            when data_type='3'then '≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)'
                          end);
---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           v_begin_day begin_day,
           v_end_day end_day,
           day,
           data_type,
           data_type_name,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee
      from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      group by day,data_type,data_type_name
      order by day,data_type,data_type_name;
end;
/
grant execute on ACC_ST.UP_OP_FN_NP_STA_ACC_LCC_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_FN_NP_STA_ACC_LCC_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_CHANGE_INCOME
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_CHANGE_INCOME (
------------------------------------------------------------------------------
--π˝≥Ã√˚£∫UP_OP_INC_CHANGE_INCOME
--π¶ƒ‹√Ë ˆ£∫ªª≥À ’“Ê±®±Ì ‘¬±®
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130906
--∂‘”¶ƒ£∞Â£∫rpt_02_028
-------------------------------------------------------------------------------
-- –ﬁ∏ƒ»’∆⁄£∫20170210
-- –ﬁ∏ƒ’ﬂ£∫lucankun
-- –ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
-----------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170220
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆœﬂ¬∑±®±Ì≤ªÕ≥º∆±Ìacc_st.OP_REPORT_LINE_NO_STAT£¨∆¡±Œ±Ì¿Ôœﬂ¬∑
--------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
       v_line_id             char(2);
       v_squad_month         char(6);
       v_balance_month       char(6);
       v_line_name           char(20);
 BEGIN
       v_squad_month:=substr(in_squad_day,1,6);
       v_balance_month:=substr(in_balance_day,1,6);
  --------------------------------------------------------------------------------------------------------------
  --ππΩ®Ω·π˚ºØΩ·ππ
    insert into t#op_change_income_rpt
    select a.line_id,'',b.line_id,'',0 from op_prm_line a,op_prm_line b
    where a.record_flag='0' and b.record_flag='0'
    --and a.line_id!='82' and b.line_id!='82';-- 20170210 add by lucankun
    and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t)
    and b.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
--≤È—Ø‘≠ º ˝æ›
       insert into t#op_change_income_rpt
       select
        (case when change_line_out is not null then change_line_out
        else
        case when b_line_id||b_station_id not in (select  line_id||station_id
        from  op_prm_station where record_flag='0') then e_line_id
        else b_line_id  end
        end)
        as chang_line_out,
        '',
        (case when change_line_in is not null then change_line_in
        else case when e_line_id||e_station_id not in (select  line_id||station_id
        from  op_prm_station where record_flag='0') then b_line_id
        else e_line_id end
        end)
        as chang_line_in,
        '',
        deal_fee
       from st_sts_change_income
       where balance_water_no>=v_balance_month||'0100' and balance_water_no<=v_balance_month||'3199' and squad_day>=v_squad_month||'01' and squad_day<=v_squad_month||'31';
----∏¸–¬œﬂ¬∑√˚
       update t#op_change_income_rpt a
       set a.begin_line_name=(
       select b.sequence||b.line_name from op_prm_line b
       where a.begin_line=b.line_id and b.record_flag='0');
       update t#op_change_income_rpt a
       set a.end_line_name=(
       select b.sequence||b.line_name from op_prm_line b
       where a.end_line=b.line_id and b.record_flag='0');
open out_cursor for
        select v_squad_month||v_balance_month mon,begin_line,begin_line_name,end_line,end_line_name,sum(deal_fee)
        from t#op_change_income_rpt
        group by   begin_line,begin_line_name,end_line,end_line_name
        order by begin_line_name,end_line_name;
 end;
/
grant execute on ACC_ST.UP_OP_INC_CHANGE_INCOME to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_CHANGE_INCOME to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_DISCOUNT_LINE_D
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_DISCOUNT_LINE_D(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_DISCOUNT_LINE_D
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_013
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑≥µ’æø€øÓÕ≥º∆»’±®
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
------------------------------------------------------------------
--20150129
--–¬‘ˆ∆±ø®£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨∆’Õ® ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_013
--Õıø…º—
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170126
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒƒ⁄»›£∫»•≥˝∑µªÿΩ·π˚÷–≥µ’æµƒ≈≈¡––Ú∫≈
-------------------------------------------------------------------------------
--20170724
--–¬‘ˆ∆±ø®£∫¥≈∏°Õ®«⁄ø®
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_013
--Œ‚Œƒ–—
-------------------------------------------------------------------
AS
 v_squad_date           char(8);       -- ‘À”™»’
 v_balance_date         char(8);
 BEGIN
 v_squad_date:=substr(in_squad_day,1,8);
 v_balance_date:=substr(in_balance_day,1,8);
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›
 insert into t#op_inc_discount_rpt
 (balance_water_no,squad_day,line_id,station_id,card_main_id,card_sub_id,deal_num,deal_fee)
 select balance_water_no,squad_day,line_id,station_id,
 card_main_id,card_sub_id,deal_num,deal_fee
 from st_sts_inc_consume
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and squad_day=v_squad_date;
----ππΩ®Ω·π˚ºØΩ·ππ
     --≤Â»ÎΩ·π˚ºØ
     insert into t#op_inc_discount_result
    select line_id,'',deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='01' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select line_id,'',0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='01';
     insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='02';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='03';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='03' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='06';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='07';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='08';
    --xiaowu 20170724 ¥≈∏°Õ®«⁄ø®
    insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0
       from t#op_inc_discount_rpt
        where card_main_id='09' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
       from t#op_inc_discount_rpt
       group by line_id;
           --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_discount_result a
    set a.name=(
    select b.line_id||b.line_name from op_prm_line b
    where a.id=b.line_id  and b.record_flag='0')
    where EXISTS (select 1 from op_prm_line b
    where a.id=b.line_id  and b.record_flag='0');
       ----œﬂ¬∑∫œº∆
    insert into t#op_inc_discount_result
    select '99','99∫œº∆',
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a;
----∑µªÿΩ·π˚ºØ
    open out_cursor for
 --   select v_balance_date||v_squad_date day,name as line_name,
 --∆¡±Œname«∞√Êµƒ≈≈–Ú–Ú∫≈
 select v_balance_date||v_squad_date day,substr(name,3) as line_name,
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a
    group by name
    order by name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_LINE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_LINE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_DISCOUNT_LINE_M
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_DISCOUNT_LINE_M(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_DISCOUNT_LINE_D
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_014
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑≥µ’æø€øÓÕ≥º∆‘¬±®
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
------------------------------------------------------------------
--20150129
--–¬‘ˆ∆±ø®£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨∆’Õ® ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_013
--Õıø…º—
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170126
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒƒ⁄»›£∫»•≥˝∑µªÿΩ·π˚÷–≥µ’æµƒ≈≈¡––Ú∫≈
-------------------------------------------------------------------------------
--20170724
--–¬‘ˆ∆±ø®£∫¥≈∏°”≈ª›∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_014
--–ﬁ∏ƒƒ⁄»›£∫œÚ¡Ÿ ±±Ì≤Â»Î ˝æ› ±‘ˆº”∆±ø®◊”¿‡–Õµƒπ˝¬ÀÃıº˛ 20170731
--≥¬÷”œÕ
-------------------------------------------------------------------
AS
 v_squad_date           char(6);       -- ‘À”™‘¬
 v_balance_date         char(6);
 BEGIN
 v_squad_date:=substr(in_squad_day,1,6);
 v_balance_date:=substr(in_balance_day,1,6);
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›£¨∆±ø® Ù–‘£∫ ˝¡ø01∫ÕΩ∂Ó02∑÷±¥¶¿Ì
 insert into t#op_inc_discount_rpt
 (balance_water_no,squad_day,line_id,station_id,card_main_id,card_sub_id,deal_num,deal_fee)
 select balance_water_no,squad_day,line_id,station_id,
 card_main_id,card_sub_id,deal_num,deal_fee
 from st_sts_inc_consume
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
--œÚ¡Ÿ ±±Ì≤Â»Î ˝æ› ±‘ˆº”∆±ø®◊”¿‡–Õµƒπ˝¬ÀÃıº˛
and ((card_main_id='01' and card_sub_id='00') or (card_main_id='02' and card_sub_id='00') or
 (card_main_id='02' and card_sub_id='01') or (card_main_id='02' and card_sub_id='02') or
 (card_main_id='02' and card_sub_id='03') or (card_main_id='03' and card_sub_id='00') or
 (card_main_id='04' and card_sub_id='00') or (card_main_id='04' and card_sub_id='01') or
 (card_main_id='06') or (card_main_id='07') or (card_main_id='08') or (card_main_id='09' and card_sub_id='01'));

----ππΩ®Ω·π˚ºØΩ·ππ
      --≤Â»ÎΩ·π˚ºØ
     insert into t#op_inc_discount_result
    select line_id,'',deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='01' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select line_id,'',0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='01';
     insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='02';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='03';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='03' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='06';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='07';

        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='08';
    --chenzx 20170724 ¥≈∏°Õ®«⁄ø®
    insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0
       from t#op_inc_discount_rpt
        where card_main_id='09' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select line_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
       from t#op_inc_discount_rpt
       group by line_id;
           --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_discount_result a
    set a.name=(
    select b.sequence||b.line_name from op_prm_line b
    where a.id=b.line_id  and b.record_flag='0')
    where EXISTS (select 1 from op_prm_line b
    where a.id=b.line_id  and b.record_flag='0');
       ----œﬂ¬∑∫œº∆
    insert into t#op_inc_discount_result
    select '99','99∫œº∆',
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a;
----∑µªÿΩ·π˚ºØ
    open out_cursor for
--    select v_balance_date||v_squad_date mon,name as line_name,
select v_balance_date||v_squad_date mon,substr(name,3) as line_name,
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a
    group by name
    order by name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_LINE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_LINE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_DISCOUNT_STA_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_DISCOUNT_STA_D(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_DISCOUNT_STA_D
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_0011
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑≥µ’æø€øÓÕ≥º∆»’±®
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
------------------------------------------------------------------
--20150129
--–¬‘ˆ∆±ø®£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨∆’Õ® ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_011
--Õıø…º—
------------------------------------------------------------------
--20170724
--–¬‘ˆ∆±ø®£∫¥≈∏°Õ®«⁄ø®
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_011
--Œ‚Œƒ–—
-------------------------------------------------------------------
AS
 v_squad_date           char(8);       -- ‘À”™»’
 v_balance_date         char(8);
 v_line_id              char(2);
 v_line_name            varchar(20);
 v_num_line int;
 BEGIN
 v_squad_date:=substr(in_squad_day,1,8);
 v_balance_date:=substr(in_balance_day,1,8);
 v_line_id:=in_line_id;
select count(line_name) into v_num_line from op_prm_line WHERE line_id = v_line_id and record_flag='0';
   --–ﬁ∏ƒ£∫‘ˆº”≈–∂œop_prm_line”–«“Ωˆ”–“ªÃı ˝æ›‘Ú∏≥÷µ
   IF  v_num_line=1 THEN
      SELECT line_name
      INTO v_line_name
      FROM op_prm_line
      WHERE line_id = v_line_id and record_flag='0';
   END IF;
 insert into t#op_inc_discount_rpt
 (balance_water_no,squad_day,line_id,station_id,card_main_id,card_sub_id,deal_num,deal_fee)
 select balance_water_no,squad_day,line_id,station_id,
 card_main_id,card_sub_id,deal_num,deal_fee
 from st_sts_inc_consume
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and squad_day=v_squad_date
 and line_id=v_line_id;
----ππΩ®Ω·π˚ºØΩ·ππ
     --≤Â»ÎΩ·π˚ºØ
     insert into t#op_inc_discount_result
    select station_id,'',deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='01' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select station_id,'',0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='01';
     insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='02';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='03';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='03' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='06';
        --20150129
    insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='07';
                insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='08';
    --xiaowu 20170724 ¥≈∏°Õ®«⁄ø®
    insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0
       from t#op_inc_discount_rpt
        where card_main_id='09' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
       from t#op_inc_discount_rpt
       group by station_id;
           --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_discount_result a
    set a.name=(
    select b.sequence||b.chinese_name from op_prm_station b
    where v_line_id=b.line_id and a.id=b.station_id and b.record_flag='0')
    where EXISTS (select 1 from op_prm_station b
    where v_line_id=b.line_id and a.id=b.station_id and b.record_flag='0');
       ----œﬂ¬∑∫œº∆
    insert into t#op_inc_discount_result
    select '99','99∫œº∆',
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a;
----∑µªÿΩ·π˚ºØ
    open out_cursor for
    select v_balance_date||v_squad_date day,v_line_name as line_name,name as station_name,
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a
    group by name
    order by name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_STA_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_STA_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_DISCOUNT_STA_M
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_DISCOUNT_STA_M(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_DISCOUNT_STA_M
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_012
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑≥µ’æø€øÓÕ≥º∆‘¬±®
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
------------------------------------------------------------------
--20150129
--–¬‘ˆ∆±ø®£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨∆’Õ® ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_012
--Õıø…º—
-------------------------------------------------------------------
--20170724
--–¬‘ˆ∆±ø®£∫¥≈∏°Õ®«⁄ø®
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_discount_result
--µ˜’˚ƒ£∞Â£∫rpt_02_012
--Œ‚Œƒ–—
-------------------------------------------------------------------
AS
 v_squad_date           char(6);       -- ‘À”™»’
 v_balance_date         char(6);
 v_line_id              char(2);
 v_line_name            varchar(20);
 v_num_line int;
 BEGIN
 v_squad_date:=substr(in_squad_day,1,6);
 v_balance_date:=substr(in_balance_day,1,6);
 v_line_id:=in_line_id;
select count(line_name) into v_num_line from op_prm_line WHERE line_id = v_line_id and record_flag='0';
   --–ﬁ∏ƒ£∫‘ˆº”≈–∂œop_prm_line”–«“Ωˆ”–“ªÃı ˝æ›‘Ú∏≥÷µ
   IF  v_num_line=1 THEN
      SELECT line_name
      INTO v_line_name
      FROM op_prm_line
      WHERE line_id = v_line_id and record_flag='0';
   END IF;
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›£¨∆±ø® Ù–‘£∫ ˝¡ø01∫ÕΩ∂Ó02∑÷±¥¶¿Ì
 insert into t#op_inc_discount_rpt
 (balance_water_no,squad_day,line_id,station_id,card_main_id,card_sub_id,deal_num,deal_fee)
 select balance_water_no,squad_day,line_id,station_id,
 card_main_id,card_sub_id,deal_num,deal_fee
 from st_sts_inc_consume
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 and line_id=v_line_id;
----ππΩ®Ω·π˚ºØΩ·ππ
          --≤Â»ÎΩ·π˚ºØ
     insert into t#op_inc_discount_result
    select station_id,'',deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='01' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select station_id,'',0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='00';
     insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='01';
     insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='02';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='02' and card_sub_id='03';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='03' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='00';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='04' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='06';
        --20150129
                insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='07';
                insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0
       from t#op_inc_discount_rpt
        where card_main_id='08';
    --xiaowu 20170724 ¥≈∏°Õ®«⁄ø®
    insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0
       from t#op_inc_discount_rpt
        where card_main_id='09' and card_sub_id='01';
        insert into t#op_inc_discount_result
    select station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
       from t#op_inc_discount_rpt
       group by station_id;
           --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_discount_result a
    set a.name=(
    select b.sequence||b.chinese_name from op_prm_station b
    where v_line_id=b.line_id and a.id=b.station_id and b.record_flag='0')
    where EXISTS (select 1 from op_prm_station b
    where v_line_id=b.line_id and a.id=b.station_id and b.record_flag='0');
       ----œﬂ¬∑∫œº∆
    insert into t#op_inc_discount_result
    select '99','99∫œº∆',
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a;
----∑µªÿΩ·π˚ºØ
    open out_cursor for
    select v_balance_date||v_squad_date mon,v_line_name as line_name,name as station_name,
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_discount_result a
    group by name
    order by name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_STA_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_DISCOUNT_STA_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_DISPART_STA_D
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_DISPART_STA_D (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_INC_DISPART_STA_D
  --π¶ƒ‹√Ë ˆ£∫ ’“Ê¿‡--øÕ‘À ’»Î«Â∑÷Ω·π˚»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20140610
  --±®±Ì±‡∫≈£∫RPT_02_031
  --¡Ÿ ±±Ì£∫t#op_inc_dispart_result,t#op_inc_dispart_rpt
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄£∫20140624
  --–ﬁ∏ƒƒ⁄»›£∫
     -- ˝æ›∞¸¿®£∫1>≥ˆ’¢ tr_type_id='54' and £®pay_mode_id in op_prm_paymode_type_valid where record_flag = '0')
              --2>--∑«œ÷Ωtr_type_id='54' and pay_mode_id in ('1A','4A')
  --±∏◊¢£∫ ’»Î ˝æ›∞¸¿®≥ˆ’¢∫Õ∏¸–¬£®∆±ø®÷ß∏∂£©µƒ±  ˝∫ÕΩ∂Ó
  --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄£∫20140721
  --–ﬁ∏ƒƒ⁄»›£∫
     --∏¸∏ƒ ˝æ›‘¥£∫÷–º‰±Ìst_sts_inc_consume
  --±∏◊¢£∫ ’»Î ˝æ›∞¸¿®≥ˆ’¢∫Õ∏¸–¬£®∆±ø®÷ß∏∂£©µƒ±  ˝∫ÕΩ∂Ó
  --------------------------------------------------------------------------------------
  --V1.3
  --‘ˆº”“Ï–Œø®£¨ ÷ª˙ø®
  --20150320
  --wangkejia
    --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170206
  --–ﬁ∏ƒƒ⁄»›£∫
     --∂‘stationΩ¯––Ωÿ»°£¨»•≥˝ ˝◊÷±‡∫≈
  --------------------------------------------------------------------------------------
    --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170724
  --–ﬁ∏ƒƒ⁄»›£∫
     --–¬‘ˆ¥≈∏°Õ®«⁄ø®∆±÷÷
  -------------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
  v_line_id varchar(2);
  v_line_name varchar(20);
BEGIN
   v_balance_day := substr(in_balance_day,1,8);
   v_squad_day:= substr(in_squad_day,1,8);
   v_line_id:=substr(in_line_id,1,2);

if v_line_id != ' ' and v_line_id is not null then
select a.line_name into v_line_name from op_prm_line a
    where a.record_flag='0' and a.line_id=v_line_id
      and exists (select 1 from op_prm_line a
    where a.record_flag='0' and a.line_id=v_line_id);

end if;
 ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_inc_dispart_result
        select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0
         from op_prm_station a
         where a.record_flag='0' and a.line_id=v_line_id;
--∏¸∏ƒ£∫
/*----≤È—Ø≤¢≤Â»Î ˝æ›
insert into t#op_inc_dispart_rpt
     (balance_day,squad_day,line_id,station_id,tr_type_id,pay_mode_id,do_type,card_main_id,card_sub_id,deal_num,deal_fee,penalty_fee)
    select substr(balance_WAter_no,1,8),squad_day,line_id,station_id,tr_type_id,pay_mode_id,do_type,card_main_id,card_sub_id,deal_num,deal_fee,penalty_fee
           from st_sts_inc_station
    where substr(balance_water_no,1, 8) = v_balance_day
           and squad_day=v_squad_day
           and line_id=v_line_id
           and tr_type_id in ('54','56');
 --Ω·π˚ºØ≤Â»Î ˝æ›
 --------------------ø€øÓ------------------------------------
 --∆’Õ®¥¢÷µ∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(deal_fee),0,0,0,0,0,0
            from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='00'
           and tr_type_id='54' and pay_mode_id in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(deal_fee),0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='01'
           and tr_type_id='54' and pay_mode_id in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(deal_fee),0,0
           from t#op_inc_dispart_rpt
      where  card_main_id='06'
           and tr_type_id='54' and pay_mode_id in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
      group by line_id,station_id;

 -------∏¸–¬-------------
  --∆’Õ®¥¢÷µ∆±
 insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(penalty_fee),0,0,0,0,0,0
            from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='00'
           and tr_type_id='54' and pay_mode_id in ('1A','4A')
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(penalty_fee),0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='01'
           and tr_type_id='54' and pay_mode_id in ('1A','4A')
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(penalty_fee),0,0
           from t#op_inc_dispart_rpt
      where  card_main_id='06'
           and tr_type_id='54' and pay_mode_id in ('1A','4A')
      group by line_id,station_id;
*/
--∆’Õ®¥¢÷µ∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0
            from st_sts_inc_consume
     where  card_main_id='02' and card_sub_id='00'
     and line_id=v_line_id
     and substr(balance_water_no,1,8)=v_balance_day
     and squad_day=v_squad_day
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0
           from st_sts_inc_consume
     where  card_main_id='02' and card_sub_id='01'
     and line_id=v_line_id
     and substr(balance_water_no,1,8)=v_balance_day
     and squad_day=v_squad_day
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0
           from st_sts_inc_consume
     where  card_main_id='06'
     and line_id=v_line_id
     and substr(balance_water_no,1,8)=v_balance_day
     and squad_day=v_squad_day
     group by line_id,station_id;

  --“Ï–Œø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0
           from st_sts_inc_consume
     where  card_main_id='07'
     and line_id=v_line_id
     and substr(balance_water_no,1,8)=v_balance_day
     and squad_day=v_squad_day
     group by line_id,station_id;

  -- ÷ª˙ø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0
           from st_sts_inc_consume
     where  card_main_id='08'
     and line_id=v_line_id
     and substr(balance_water_no,1,8)=v_balance_day
     and squad_day=v_squad_day
     group by line_id,station_id;


       --¥≈∏°¥¢÷µø®  20170724
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
           from st_sts_inc_consume
     where  card_main_id='09' and card_sub_id='01'
     and line_id=v_line_id
     and substr(balance_water_no,1,8)=v_balance_day
     and squad_day=v_squad_day
     group by line_id,station_id;

  ----ƒ©––◊‹º∆
  ----◊‹º∆ÃÌº”99±‡∫≈
  insert into t#op_inc_dispart_result
      select line_id,line_name,'99','99◊‹º∆',sum(num0),sum(fee0),sum(num1),sum(fee1),sum(num2),sum(fee2),sum(total_num),sum(total_fee),
      sum(num3),sum(fee3),sum(num4),sum(fee4),sum(num5),sum(fee5)--V1.3
         from t#op_inc_dispart_result
      group by line_id,line_name;
  --Œ≤¡–∫œº∆£®∑µªÿΩ·π˚ºØ ±Õ≥º∆£©

       ----∏¸–¬œﬂ¬∑
   update t#op_inc_dispart_result a
     set a.line_name = (select b.line_id || b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
      where  exists (select 1 from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0');
      --∏¸–¬’æµ„
   update t#op_inc_dispart_result a
     set a.station_name = (select b.station_id || b.chinese_name from op_prm_station b
   where a.line_id = b.line_id and a.station_id=b.station_id and b.record_flag = '0')
      where exists (select 1 from op_prm_station b
   where a.line_id = b.line_id and a.station_id=b.station_id and b.record_flag = '0');


------∑µªÿΩ·π˚ºØ
------∂‘stationΩ¯––Ωÿ»°£¨»•≥˝ ˝◊÷±‡∫≈
  open out_cur_arg for
    select v_balance_day||v_squad_day balance_day,
           v_line_name v_line_name,
           line_id,
           line_name,
           station_id,
           substr(station_name,3) station_name,
           /*station_name,*/
           sum(num0) num0,
           sum(fee0) fee0,
           sum(num1) num1,
           sum(fee1) fee1,
           sum(num2) num2,
           sum(fee2) fee2,
           sum(num3) num3,
           sum(fee3) fee3,
           sum(num4) num4,
           sum(fee4) fee4,
           sum(num5) num5,
           sum(fee5) fee5,
           sum(num0+num1+num2+num3+num4+num5) total_num,
           sum(fee0+fee1+fee2+fee3+fee4+fee5) total_fee
      from t#op_inc_dispart_result
     group by line_id,line_name,station_id,station_name
     order by line_id,line_name,station_id,station_name;
end;
/
grant execute on ACC_ST.UP_OP_INC_DISPART_STA_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_DISPART_STA_M
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_DISPART_STA_M (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_INC_DISPART_STA_M
  --π¶ƒ‹√Ë ˆ£∫ ’“Ê¿‡--øÕ‘À ’»Î«Â∑÷Ω·π˚‘¬±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20140610
  --±®±Ì±‡∫≈£∫RPT_02_032
  --¡Ÿ ±±Ì£∫t#op_inc_dispart_result,t#op_inc_dispart_rpt
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄£∫20140624
  --–ﬁ∏ƒƒ⁄»›£∫
     -- ˝æ›∞¸¿®£∫1>≥ˆ’¢ tr_type_id='54' and £®pay_mode_id in op_prm_paymode_type_valid where record_flag = '0')
              --2>--∑«œ÷Ωtr_type_id='54' and pay_mode_id in ('1A','4A')
  --±∏◊¢£∫ ’»Î ˝æ›∞¸¿®≥ˆ’¢∫Õ∏¸–¬£®∆±ø®÷ß∏∂£©µƒ±  ˝∫ÕΩ∂Ó
  --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄£∫20140721
  --–ﬁ∏ƒƒ⁄»›£∫
     --∏¸∏ƒ ˝æ›‘¥£∫÷–º‰±Ìst_sts_inc_consume
  --±∏◊¢£∫ ’»Î ˝æ›∞¸¿®≥ˆ’¢∫Õ∏¸–¬£®∆±ø®÷ß∏∂£©µƒ±  ˝∫ÕΩ∂Ó
  --------------------------------------------------------------------------------------
    --------------------------------------------------------------------------------------
  --V1.3
  --‘ˆº”“Ï–Œø®£¨ ÷ª˙ø®
  --20150320
  --wangkejia
      --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170206
  --–ﬁ∏ƒƒ⁄»›£∫
     --∂‘stationΩ¯––Ωÿ»°£¨»•≥˝ ˝◊÷±‡∫≈
  --------------------------------------------------------------------------------------
   --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170724
  --–ﬁ∏ƒƒ⁄»›£∫
     --–¬‘ˆ¥≈∏°Õ®«⁄ø®∆±÷÷
  -------------------------------------------------------------------------------------

 is
  v_balance_day varchar(6);
  v_squad_day varchar(6);
  v_line_id varchar(2);
  v_line_name varchar(20);
BEGIN
   v_balance_day := substr(in_balance_day,1,6);
   v_squad_day:= substr(in_squad_day,1,6);
   v_line_id:=substr(in_line_id,1,2);

if v_line_id != ' ' and v_line_id is not null then
select line_name into v_line_name from op_prm_line a
    where a.record_flag='0' and a.line_id=v_line_id
      and exists (select 1 from op_prm_line a
    where a.record_flag='0' and a.line_id=v_line_id);

end if;
 ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_inc_dispart_result
        select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0
         from op_prm_station a
         where a.record_flag='0' and a.line_id=v_line_id;
--∏¸∏ƒ∫Û£∫
--∆’Õ®¥¢÷µ∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0
            from st_sts_inc_consume
     where  card_main_id='02' and card_sub_id='00'
     and line_id=v_line_id
     and substr(balance_water_no,1,6)=v_balance_day
     and substr(squad_day,1,6)=v_squad_day
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0
           from st_sts_inc_consume
     where  card_main_id='02' and card_sub_id='01'
     and line_id=v_line_id
     and substr(balance_water_no,1,6)=v_balance_day
     and substr(squad_day,1,6)=v_squad_day
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0
           from st_sts_inc_consume
     where  card_main_id='06'
     and line_id=v_line_id
     and substr(balance_water_no,1,6)=v_balance_day
     and substr(squad_day,1,6)=v_squad_day
     group by line_id,station_id;
     ---------------------------------------------------------------------------------
--V1.3
  --“Ï–Œø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0
           from st_sts_inc_consume
     where  card_main_id='07'
     and line_id=v_line_id
     and substr(balance_water_no,1,6)=v_balance_day
     and substr(squad_day,1,6)=v_squad_day
     group by line_id,station_id;

  -- ÷ª˙ø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0
           from st_sts_inc_consume
     where  card_main_id='08'
     and line_id=v_line_id
     and substr(balance_water_no,1,6)=v_balance_day
     and substr(squad_day,1,6)=v_squad_day
     group by line_id,station_id;

       --¥≈∏°Õ®«⁄ø®   20170724
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee)
           from st_sts_inc_consume
     where  card_main_id='09' and card_sub_id='01'
     and line_id=v_line_id
     and substr(balance_water_no,1,6)=v_balance_day
     and substr(squad_day,1,6)=v_squad_day
     group by line_id,station_id;
-----------------------------------------------------------------------------------------
/*
--∏¸∏ƒ«∞£∫
----≤È—Ø≤¢≤Â»Î ˝æ›
insert into t#op_inc_dispart_rpt
     (balance_day,squad_day,line_id,station_id,tr_type_id,pay_mode_id,do_type,card_main_id,card_sub_id,deal_num,deal_fee,penalty_fee)
    select substr(balance_WAter_no,1,8),squad_day,line_id,station_id,tr_type_id,pay_mode_id,do_type,card_main_id,card_sub_id,deal_num,deal_fee,penalty_fee
           from st_sts_inc_station
    where substr(balance_water_no,1, 6) = v_balance_day
           and substr(squad_day,1,6)=v_squad_day
           and line_id=v_line_id
           and tr_type_id in ('54','56');
 --Ω·π˚ºØ≤Â»Î ˝æ›

 --------------------ø€øÓ------------------------------------
 --∆’Õ®¥¢÷µ∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(deal_fee),0,0,0,0,0,0
            from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='00'
           and tr_type_id='54' and pay_mode_id in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(deal_fee),0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='01'
           and tr_type_id='54' and pay_mode_id in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(deal_fee),0,0
           from t#op_inc_dispart_rpt
      where  card_main_id='06'
           and tr_type_id='54' and pay_mode_id in (select pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
      group by line_id,station_id;

 -------∏¸–¬-------------
  --∆’Õ®¥¢÷µ∆±
 insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',sum(deal_num),sum(penalty_fee),0,0,0,0,0,0
            from t#op_inc_dispart_rpt
     where card_main_id='02' and card_sub_id='00'
           and tr_type_id='54' and pay_mode_id in ('1A','4A')
     group by line_id,station_id;
 --∆’Õ®—ß…˙∆±
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,sum(deal_num),sum(penalty_fee),0,0,0,0
           from t#op_inc_dispart_rpt
     where  card_main_id='02' and card_sub_id='01'
           and tr_type_id='54' and pay_mode_id in ('1A','4A')
     group by line_id,station_id;
  --π´Ωªø®
insert into t#op_inc_dispart_result
     select line_id,'',station_id,'',0,0,0,0,sum(deal_num),sum(penalty_fee),0,0
           from t#op_inc_dispart_rpt
      where card_main_id='06'
           and tr_type_id='54' and pay_mode_id in ('1A','4A')
      group by line_id,station_id;
*/
  ----ƒ©––◊‹º∆
  ----◊‹º∆ÃÌº”99±‡∫≈
  insert into t#op_inc_dispart_result
      select line_id,line_name,'99','99◊‹º∆',sum(num0),sum(fee0),sum(num1),sum(fee1),sum(num2),sum(fee2),sum(total_num),sum(total_fee),
      sum(num3),sum(fee3),sum(num4),sum(fee4),sum(num5),sum(fee5)--V1.3
         from t#op_inc_dispart_result
      group by line_id,line_name;
  --Œ≤¡–∫œº∆(∑µªÿΩ·π˚ºØ ±«Û∫Õ)
  /*update t#op_inc_dispart_result a set a.total_num=a.num0+a.num1+a.num2;
  update t#op_inc_dispart_result a set a.total_fee=a.fee0+a.fee1+a.fee2;*/

       ----∏¸–¬œﬂ¬∑
   update t#op_inc_dispart_result a
     set a.line_name = (select b.line_id || b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
      where  exists (select 1 from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0');
        ----∏¸–¬’æµ„
   update t#op_inc_dispart_result a
     set a.station_name = (select b.station_id || b.chinese_name from op_prm_station b
   where a.line_id = b.line_id and a.station_id=b.station_id and b.record_flag = '0')
      where exists (select 1 from op_prm_station b
   where a.line_id = b.line_id and a.station_id=b.station_id and b.record_flag = '0');


------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day||v_squad_day balance_day,
           v_line_name v_line_name,
           line_id,
           line_name,
           station_id,
           substr(station_name,3) station_name,
           /*station_name,*/
           sum(num0) num0,
           sum(fee0) fee0,
           sum(num1) num1,
           sum(fee1) fee1,
           sum(num2) num2,
           sum(fee2) fee2,
           sum(num3) num3,
           sum(fee3) fee3,
           sum(num4) num4,
           sum(fee4) fee4,
           sum(num5) num5,
           sum(fee5) fee5,
           sum(num0+num1+num2+num3+num4+num5) total_num,
           sum(fee0+fee1+fee2+fee3+fee4+fee5) total_fee
      from t#op_inc_dispart_result
     group by line_id,line_name,station_id,station_name
     order by line_id,line_name,station_id,station_name;
end;
/
grant execute on ACC_ST.UP_OP_INC_DISPART_STA_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_BOM_D
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_BOM_D (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_LINE_BOM_D
--π¶ƒ‹√Ë ˆ£∫œ˙ € ’“Ê¿‡±®±Ì œﬂ¬∑BOM ’“Êª„◊‹»’±®
--¥¥Ω®’ﬂ£∫  WNANGKEJIA
--¥¥Ω®»’∆⁄£∫20130909
--∂‘”¶ƒ£∞Â£∫rpt_02_017
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140812
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫–ﬁ∏ƒ”¶ ’Ω∂ÓÕ≥º∆
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--v1.3
--–ﬁ∏ƒ»’∆⁄£∫20150320
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”“Ï–Œø® ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--V1.31
--–ﬁ∏ƒ»’∆⁄£∫20150330
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ÷ª˙∆± ˝æ›
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫zzq
--∏¸∏ƒ»’∆⁄£∫20160630
--∏¸∏ƒƒ⁄»›£∫–ﬁ’˝¿œ»À”≈ª›¥¢÷µ∆± ¿œ»À√‚∑—¥¢÷µ∆±µƒcard_sub_code£¨
--¿œ»À”≈ª›¥¢÷µ∆±∂‘”¶card_sub_code='02'°£
-- ¿œ»À√‚∑—¥¢÷µ∆±∂‘”¶card_sub_code='03'
---------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170126
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒƒ⁄»›£∫»•≥˝∑µªÿΩ·π˚÷–≥µ’æµƒ≈≈¡––Ú∫≈
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°¥¢÷µ∆±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170801
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫√‚∑—∆±º§ªÓ¥Œ ˝–ﬁ∏ƒŒ™Õ≥º∆¿œ»À√‚∑—∆±º§ªÓ¥Œ ˝
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
        v_squad_day char(8);
        v_balance_day char(8);
        v_iRet number(12,2);
    BEGIN
        v_squad_day:=substr(in_squad_day,1,8);
        v_balance_day:=substr(in_balance_day,1,8);
--------÷–º‰±ÌªÒ»° ˝æ›
   insert into  t#OP_INC_STA_BOM_RPT
   (squad_day,line_id,station_id,tr_type_id,do_type,pay_mode_id,pay_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee)
               select squad_day,line_id,station_id,tr_type_id,do_type,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
               where  balance_water_no>=v_balance_day||'00'
               and balance_water_no<=v_balance_day||'99'
               and squad_day = v_squad_day;
------------------------------------∑¢ €
--µ•≥Ã∆± ∆’Õ®µ•≥Ã∆±
  insert into  t#OP_INC_STA_BOM_result
      select
        line_id,'','','',
        sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='01' and card_sub_code='00'
    and dev_type_id='03' and tr_type_id='50'
    -- and pay_mode_id='01'
    group by  line_id;
-----------------------------------------
--≥…»À∆’Õ®¥¢÷µ∆±∑¢ €
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and  card_sub_code='00'
    and dev_type_id='03' and tr_type_id='51'
    group by  line_id;
---------------------------------------------------------------------------------------
--—ß…˙∆’Õ®¥¢÷µ∆±∑¢ €
 insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
         0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and  card_sub_code='01'
    and dev_type_id='03' and tr_type_id='51'
    group by   line_id;
-----------------------------------------
--¿œ»À√‚∑—¥¢∆±∑¢ €
 insert into  t#OP_INC_STA_BOM_result
  select
        line_id,'','','',
         0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and card_sub_code='03' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;
---------------------------------------------------------------------------------------
--¿œ»À”≈ª›¥¢÷µ
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,
     sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and card_sub_code='02' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;
---------------------------------------------------------------------------------------
--∆’Õ®≥À¥Œ∆± --
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,0,0,
     sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='03' and card_sub_code='00' and
          dev_type_id='03' and tr_type_id='51'
    group by line_id;
---------------------------------------------------------------------------------------
/*--∆’Õ®ºÕƒÓ∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,0,0,
     0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='04' and card_sub_code='00' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;*/
    --v1.31 ÷ª˙∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,0,0,
     0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='08' and card_sub_code='00' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;
/*--”≈ª›ºÕƒÓ∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='04' and card_sub_code='01' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;*/
   --v1.3“Ï–Œø®
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='07' and card_sub_code='00' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;
      --¥≈∏°∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        line_id,'','','',
     0,0,0,0,0,0,0,0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='09' and card_sub_code='01' and
          dev_type_id='03' and
          tr_type_id='51'
    group by line_id;
-----------------------------------------         —∫Ω∫œº∆
--¥¢÷µ∆±—∫Ω∫œº∆
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,
          0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where dev_type_id='03' and tr_type_id='51'
    group by line_id;
-----------------------------------------
--≥« –Õ®∆±
       insert into  t#OP_INC_STA_BOM_result
      select
         line_id,'','','',
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='06' and
           dev_type_id='03' and
           tr_type_id='51'
    group by line_id;
---------------------------------------------------------------------------------------
----√‚∑—∆±º§ªÓ¥Œ ˝(≤ª»∑∂®)
insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,
        sum(deal_num),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code || card_sub_code ='0203' and tr_type_id ='54' and pay_mode_id ='14' -- –ﬁ∏ƒŒ™Õ≥º∆¿œ√‚∆±ºØ∫œ¥Œ ˝
    group by line_id;
----------------------------------------- ≥‰÷µ
/*--µÿÃ˙¥¢÷µ∆±≥‰÷µ
insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and
           dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
           and tr_type_id='54'
    group by line_id;*/
/*    --v1.3µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®≥‰÷µ
insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07') and
           dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
           and tr_type_id='54'
    group by line_id;*/
        --v1.31µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±≥‰÷µ
insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09') and
           dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
           and tr_type_id='54'
    group by line_id;
---------------------------------------------------------------------------------------
--≥« –Õ®∆±≥‰÷µ
       insert into  t#OP_INC_STA_BOM_result
       select
       line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
          and tr_type_id='54'
    group by line_id;
----------------------------------------- ≥Â’˝
/*--µÿÃ˙¥¢÷µ∆±≥Â’˝
       insert into  t#OP_INC_STA_BOM_result
      select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by line_id;*/
   /* --v1.3µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®≥Â’˝
       insert into  t#OP_INC_STA_BOM_result
      select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07') and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by line_id;*/
    --v1.31µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±≥Â’˝
       insert into  t#OP_INC_STA_BOM_result
      select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        sum(deal_fee),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07','08','09') and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by line_id;
--≥« –Õ®∆±
      insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by line_id;
---------------------------------------------------------------------------------------     ∏¸–¬
--µÿÃ˙°¢“Ï–Œø®°¢ ÷ª˙∆±
--Ω¯≥ˆ’æ¬Î∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and
           dev_type_id='03' and pay_mode_id='01' and
           tr_type_id='56'  and  (do_type='03' or do_type='10' or do_type='12' or do_type='11')
   group by line_id;
--≥¨≥À∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         0,0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and
           dev_type_id='03' and
           tr_type_id='56' and pay_mode_id='01' and do_type='02'
    group by line_id;
--≥¨ ±∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and
           dev_type_id='03' and
           tr_type_id='56' and pay_mode_id='01' and do_type='01'
    group by line_id;
--≥« –Õ®∆±
--Ω¯≥ˆ’æ¬Î∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and
          tr_type_id='56' and pay_mode_id='01' and (do_type='03' or do_type='10' or do_type='12' or do_type='11')
    group by line_id;
--≥¨≥À∏¸–¬
  insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and
          tr_type_id='56' and pay_mode_id='01' and do_type='02'
    group by line_id;
--≥¨ ±∏¸–¬
  insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and
          tr_type_id='56' and pay_mode_id='01' and do_type='01'
   group by line_id;
---------------------------------------       ––’˛¥¶¿Ì
--√‚∑—Ω¯≥ˆ’æ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,
        0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61' and do_type in('02')
    group by line_id;
---------------------------------------------------------------------------------------
--∏∂∑—≥ˆ’æ
       insert into  t#OP_INC_STA_BOM_result
        select
       line_id,'','','',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       0,0,0,0,sum(deal_num),0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61' and  do_type='03'
    group by line_id;
-----------------------------------------
--––’˛¥¶¿Ì ’»Î
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       sum(penalty_fee),0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61'
    group by line_id;
--––’˛¥¶¿Ì÷ß≥ˆ
     insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,0,0,0,0,
      0,sum(return_balance),0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where dev_type_id='03' and
          tr_type_id='61'
    group by line_id;
--------------------------------------------------------------------------------------- ÕÀøÓΩ∂Ó
/*--¥¢÷µ∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code ='02'   and
           dev_type_id='03' and
           tr_type_id='57'
   group by line_id;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code ='02'   and
           dev_type_id='03' and
           tr_type_id='57'
   group by line_id;*/
   /*--V1.3¥¢÷µ∆±∫Õ“Ï–Œø®
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by line_id;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by line_id;*/
   --V1.31¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by line_id;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by line_id;
---------------------------------------------------------------------------------------
-----------------------------------------
--µ•≥Ã∆±ÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        line_id,'','','',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       sum(return_balance),0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='01' and
           dev_type_id='03' and
           tr_type_id='57'
    group by line_id;
--Õ≥º∆”¶ ’    --°∞”¶ ’Ω∂Ó°±£Ω∑¢ €Ω∂Ó£´≥‰÷µΩ∂Ó£´∏¸–¬Ω∂Ó£®œ÷Ω£©£´––’˛ ¬ŒÒ ’»Î£≠≥Â’˝Ω∂Ó£≠––’˛ ¬ŒÒ÷ß≥ˆ£≠ÕÀøÓΩ∂Ó
update t#OP_INC_STA_BOM_result
set total_fee=
        singl_fee
       +svt_fee
       +city_fee
       +charge_svt
       +charge_yct
       -cut_svt
       -cut_yct
       +update_dt1
       +update_dt2
       +update_dt3
       +update_yct1
       +update_yct2
       +update_yct3
       +affair_penalty
       -affair_return
       -deposit
       -bala
       +penalty
       -return_singl;

--∏¸–¬œﬂ¬∑
update t#OP_INC_STA_BOM_result a
--≈≈–Ú÷±Ω””√line_id
--set a.line_name=(select '('||b.line_id||')'||b.line_name
set a.line_name=(select b.line_name
            from op_prm_line b
            where a.line_id=b.line_id and b.record_flag='0');
--∑µªÿ±®±Ì ˝æ›
open out_cursor for
--select     v_squad_day||v_balance_day day,line_name,
select     v_squad_day||v_balance_day day,line_id,line_name,
      sum(singl_num) singl_num,
      sum(singl_fee) singl_fee,
      sum(svt_sin_num) svt_sin_num,
      sum(svt_sin_fee) svt_sin_fee,
      sum(svt_stu_num) svt_stu_num,
      sum(svt_stu_fee) svt_stu_fee,
      sum(svt_old_free_num) svt_old_free_num,
      sum(svt_old_free_fee) svt_old_free_fee,
      sum(svt_old_none_num) svt_old_none_num,
      sum(svt_old_none_fee) svt_old_none_fee,
      sum(sin_times_num) sin_times_num,
      sum(sin_times_fee) sin_times_fee,
      sum(memory_num) memory_num,
      sum(memory_fee) memory_fee,
      sum(pre_rem_num) pre_rem_num,
      sum(pre_rem_fee) pre_rem_fee,
      sum(commuter_num) commuter_num, --add by luck
      sum(commuter_fee) commuter_fee, --add by luck
      sum(svt_fee) svt_fee ,
      sum(city_num) city_num,
      sum(city_fee) city_fee,
      sum(free_times) free_times,
      sum(charge_svt)      charge_svt,
      sum(charge_yct)      charge_yct,
      sum(cut_svt)         cut_svt,
      sum(cut_yct)         cut_yct,
      sum(update_dt1)      update_dt1,
      sum(update_dt2)      update_dt2,
      sum(update_dt3)      update_dt3,
      sum(update_yct1)     update_yct1,
      sum(update_yct2)     update_yct2,
      sum(update_yct3)     update_yct3,
      sum(affair_num)      affair_num,
      sum(affair_num2)      affair_num2,
      sum(affair_penalty) affair_penalty,
      sum(affair_return)   affair_return,
      sum(deposit)         deposit,
      sum(bala)            bala,
      sum(penalty)         penalty,
      sum(return_singl)    return_singl,
      sum(total_fee)       total_fee
from t#OP_INC_STA_BOM_result
group by line_id,line_name
--order by line_name;
order by line_id,line_name;
 end;
/
grant execute on ACC_ST.UP_OP_INC_LINE_BOM_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_BOM_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_DISCOUNT_M
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_DISCOUNT_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ œﬂ¬∑∆±÷÷ø€øÓÕ≥º∆‘¬±®£®ø…∞¥œﬂ¬∑∆±ø®◊È∫œ≤È—Ø£©
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_010
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_ic_main_type char(2);
v_ic_sub_type char(2);
v_card_name varchar(20);
v_squad_day char(6);
v_balance_day char(6);
v_day int;
    BEGIN
     v_line_id:= in_line_id;
     v_ic_main_type:=in_card_main_id;
     v_ic_sub_type:=in_card_sub_id;
     v_squad_day:=substr(in_squad_day,1,6);
     v_balance_day:=substr(in_balance_day,1,6);
     v_day:=1;
    if  v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
    end if;
    if v_ic_main_type!=' ' and v_ic_sub_type!=' ' and v_ic_main_type||v_ic_sub_type is not null then
     select card_sub_name into v_card_name from op_prm_card_sub
     where card_main_id=v_ic_main_type and card_sub_id=v_ic_sub_type and record_flag='0';
    end if;
-------------------------------------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
while v_day<=30
  loop
    insert into t#OP_INC_LINE_DISCOUNT_result(squad_day,line_id,station_id,deal_fee,deal_num,deal_no_discount_fee)
    select lpad(v_day,2£¨0),a.line_id,a.station_id,0,0,0
    from op_prm_station a
    where a.record_flag='0' and a.line_id=v_line_id;
    v_day:=v_day+1;
  end loop;
    insert into t#OP_INC_LINE_DISCOUNT_result(squad_day,line_id,station_id,deal_fee,deal_num,deal_no_discount_fee)
    select '10-01…œ—Æ–°º∆',a.line_id,a.station_id,0,0,0
    from op_prm_station a
    where a.record_flag='0' and a.line_id=v_line_id;
    insert into t#OP_INC_LINE_DISCOUNT_result(squad_day,line_id,station_id,deal_fee,deal_num,deal_no_discount_fee)
    select '20-11÷–—Æ–°º∆',a.line_id,a.station_id,0,0,0
    from op_prm_station a
    where a.record_flag='0' and a.line_id=v_line_id;
    insert into t#OP_INC_LINE_DISCOUNT_result(squad_day,line_id,station_id,deal_fee,deal_num,deal_no_discount_fee)
    select '31-21œ¬—Æ–°º∆',a.line_id,a.station_id,0,0,0
    from op_prm_station a
    where a.record_flag='0' and a.line_id=v_line_id;
    insert into t#OP_INC_LINE_DISCOUNT_result(squad_day,line_id,station_id,deal_fee,deal_num,deal_no_discount_fee)
    select '∫œº∆',a.line_id,a.station_id,0,0,0
    from op_prm_station a
    where a.record_flag='0' and a.line_id=v_line_id;
 -------------------------------------------------------------------------------------------------------------
      ----≤È—Ø ˝æ› »°≥ˆ¬˙◊„Ãıº˛µƒÀ˘”– ˝æ›
      insert into t#OP_INC_LINE_DISCOUNT_rpt
      (squad_day,line_id,station_id,deal_fee,deal_num,deal_no_discount_fee)
      select squad_day,line_id,station_id,
             sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from st_sts_inc_consume
      where balance_water_no>= v_balance_day||'0100'
            and balance_water_no<=v_balance_day||'3199'
            and substr(squad_day,1,6)=v_squad_day
            and line_id=v_line_id
            and card_main_id=v_ic_main_type
            and card_sub_id=v_ic_sub_type
      group by squad_day,line_id,station_id;
      --œÚΩ·π˚ºØÃÌº” ˝æ›
      insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select lpad(substr(squad_day,7,2),2,0),line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee
      from t#OP_INC_LINE_DISCOUNT_rpt
      group by substr(squad_day,7,2),line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee;
      --ÃÌº”…œ—Æ–°º∆
            insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '10-01…œ—Æ–°º∆',line_id,station_id,card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      where to_number(substr(squad_day,7,2),'99')>=1
            and to_number(substr(squad_day,7,2),'99')<=10
      group by line_id,station_id,card_main_id,card_sub_id;
           /* --ÃÌº”Œ≤¡–…œ—Æ–°º∆
            insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,station_name,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '10 - 01 …œ—Æ–°º∆','99','99','∫œº∆',card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      where to_number(substr(squad_day,7,2),'99')>=1
            and to_number(substr(squad_day,7,2),'99')<=10
      group by card_main_id,card_sub_id;*/
      ----ÃÌº”÷–—Æ–°º∆
               insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '20-11÷–—Æ–°º∆',line_id,station_id,card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      where to_number(substr(squad_day,7,2),'99')>=11
            and to_number(substr(squad_day,7,2),'99')<=20
      group by line_id,station_id,card_main_id,card_sub_id;
      /*----ÃÌº”Œ≤¡–÷–—Æ–°º∆
               insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,station_name,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '20 - 11 ÷–—Æ–°º∆','99','99','∫œº∆',card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      where to_number(substr(squad_day,7,2),'99')>=11
            and to_number(substr(squad_day,7,2),'99')<=20
      group by card_main_id,card_sub_id;*/
      --ÃÌº”œ¬—Æ–°º∆
               insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '31-21œ¬—Æ–°º∆',line_id,station_id,card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      where to_number(substr(squad_day,7,2),'99')>=21
            and to_number(substr(squad_day,7,2),'99')<=31
      group by line_id,station_id,card_main_id,card_sub_id;
         /*--ÃÌº”Œ≤¡–œ¬—Æ–°º∆
               insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,station_name,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '31 - 21 …œ—Æ–°º∆','99','99','∫œº∆',card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      where to_number(substr(squad_day,7,2),'99')>=21
            and to_number(substr(squad_day,7,2),'99')<=31
      group by card_main_id,card_sub_id;*/
    /*  --≤Â»ÎŒ≤¡–∫œº∆
       insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,station_name,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select to_number(substr(squad_day,7,2),'99'),'99','99','∫œº∆',card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      group by to_number(substr(squad_day,7,2),'99'),line_id,station_id,card_main_id,card_sub_id;*/
      --≤Â»Îƒ©––∫œº∆
       insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '∫œº∆',line_id,station_id,card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      group by line_id,station_id,card_main_id,card_sub_id;
   /*  --≤Â»Îƒ©––Œ≤¡–◊‹∫œº∆
       insert into t#OP_INC_LINE_DISCOUNT_result
      (squad_day,line_id,station_id,station_name,card_main_id,card_sub_id,deal_fee,deal_num,deal_no_discount_fee)
      select '∫œº∆','99','99','∫œº∆',card_main_id,card_sub_id,sum(deal_fee),sum(deal_num),sum(deal_no_discount_fee)
      from t#OP_INC_LINE_DISCOUNT_rpt
      group by card_main_id,card_sub_id;   */
      --∏¸–¬’æµ„
      update t#OP_INC_LINE_DISCOUNT_result a
      set a.station_name=(
      select b.sequence||b.chinese_name from op_prm_station b where a.station_id=b.station_id and a.line_id=b.line_id and b.record_flag='0')
      where station_id!='99';
      --∑µªÿΩ·π˚ºØ
      open out_cursor for
      select v_squad_day||v_balance_day mon,v_line_name linename,v_card_name card_name,squad_day,station_name stationname,deal_fee as income,deal_num
      from t#OP_INC_LINE_DISCOUNT_result
      order by squad_day,station_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_LINE_DISCOUNT_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_DISCOUNT_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_INCOME_D
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_INCOME_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_LINE_INCOME_D
--ƒ£∞Â√˚£∫rpt_02_020
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑ ’“ÊÕ≥º∆»’±®
--¥¥Ω®’ﬂ£∫ wangkejia
--¥¥Ω®»’∆⁄£∫20130909
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140624
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');£®by lili£©
          --2>±®±Ì∑«œ÷Ω∏¸–¬–ﬁ∏ƒ£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140721
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬‘ˆº”£∫tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0;
            --2>±®±Ì‘ˆº”tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0µƒ∑«œ÷Ω∏¸–¬
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140729
--–ﬁ∏ƒƒ⁄»›£∫1>∑«œ÷Ω∏¸–¬:tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0
--∏ƒŒ™£∫tr_type_id='56' and  pay_mode_id ='02' and penalty_fee=0
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150320
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”“Ï–Œø® ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150330
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ÷ª˙∆± ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhouyang
--–ﬁ∏ƒ»’∆⁄£∫20170216
--–ﬁ∏ƒƒ⁄»›£∫»•µÙœﬂ¬∑√˚≥∆«∞µƒ¥˙¬Î
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±÷÷Õ≥º∆
-------------------------------------------------------------------------------
AS
        v_squad_day char(8);
        v_balance_day char(8);
BEGIN
v_squad_day:=substr(in_squad_day,1,8);
v_balance_day:=substr(in_balance_day,1,8);
--≤È—Øœ‡πÿ ˝æ›
 insert into  t#OP_INC_STA_INCOME_RPT
 (line_id,station_id,squad_day,tr_type_id,paymode_id,do_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty)
               select line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
                where  balance_water_no>=V_balance_day||'00' and balance_water_no<=V_balance_day||'99' and SUBSTR(squad_day,1,8)=v_squad_day;
------------------------------------µ•≥Ã∆±∑¢ €
--TVMµ•≥Ã∆±∑¢ €
        insert into t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='01'  and
               dev_type_id='02'    and
               tr_type_id='50'
        group by line_id;
--bomµ•≥Ã∆±∑¢ €
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              dev_type_id='03' and
              tr_type_id='50'
        group by line_id;
--µ•≥Ã∆±∑¢ €–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='50'
        group by line_id;
--------------------------------------≥‰÷µΩ∂Ó---------------------------------------
--TVM≥‰÷µ
         insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  dev_type_id='02' and
               tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id;
--BOM≥‰÷µ
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where dev_type_id='03' and
              tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;
--≥‰÷µ–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;
----—∫Ω–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  (tr_type_id='50' or tr_type_id='51')
        group by line_id;
-------------------∏¸–¬Ω∂Ó----------------------
--œ÷Ω∏¸–¬£∫
--µ•≥À∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='01'
        group by line_id;
/*--µÿÃ˙¥¢÷µ∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='02' and
              tr_type_id='56' and paymode_id='01'
        group by line_id;*/
        /*--v1.3
            insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07') and
              tr_type_id='56' and paymode_id='01'
        group by line_id;    */
                --v1.31
                --¥¢÷µ∆±°¢ ÷ª˙∆±°¢“Ï–Œø®°¢¥≈∏°∆±œ÷Ω
            insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07','08','09') and--20170724 ‘ˆº”¥≈∏°∆±
              tr_type_id='56' and paymode_id='01'
        group by line_id;
--≥« –Õ®œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='01'
       group by line_id;
--∑«œ÷Ω(∏¸–¬Ω∂Ó≤ªŒ™0)£∫
---------------------- ˝æ›¿¥‘¥£∫deal±Ì---------------------------------
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
/*
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id;*/
       /*--v1.3
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id;*/
       --v1.31
       --¥¢÷µ∆±°¢ ÷ª˙∆±°¢“Ï–Œø®°¢¥≈∏°∆±∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 ‘ˆº”¥≈∏°∆±
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id;
-----------------------------------------------------------------------
--20140729∏¸–¬£ª
---------------------- ˝æ›¿¥‘¥£∫update±Ì---------------------------------
--∑«œ÷Ω∏¸–¬£∫
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
/*
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id;*/
       /*--v1.3
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id;*/
       --v1.31
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08') and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id;
----------------------------------------------------------------------

----------------------------------------------------------------------
/*--20140721–¬‘ˆ£∫
--∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='00' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;*/
        --∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)

----------------------------------------------------------------------
--∏¸–¬–°º∆
insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,sum(update_dc+update_dt+update_oct+update_dc2+update_dt2+update_oct2),0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RESULT
       group by line_id;

-------------------------------------≥Â’˝--------------------------------------------------
--µÿÃ˙¥¢÷µ∆±≥Â’˝
/*
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'','','',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
             tr_type_id='54' and paymode_id='18'
       group by line_id;*/
       /*--v1.3
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'','','',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
             tr_type_id='54' and paymode_id='18'
       group by line_id;*/
       --v1.31
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'','','',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 ‘ˆº”¥≈∏°∆±
             tr_type_id='54' and paymode_id='18'
       group by line_id;
--≥« –Õ®≥Â’˝
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='06' and
               tr_type_id='54' and paymode_id='18'
        group by line_id;
---------------------------------------––’˛¥¶¿Ì--
--√‚∑—Ω¯≥ˆ’æ∆± ˝¡ø
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='61' and do_type in('02')
        group by line_id;
--∏∂∑—≥ˆ’æ∆± ˝¡ø
 insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='61' and do_type='03'
        group by line_id;
--––’˛ ¬ŒÒ ’»Î
--––’˛ ¬ŒÒ÷ß≥ˆ
insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),sum(return_bala),0,0,0,0,0,0
     from t#OP_INC_STA_INCOME_RPT
          where tr_type_id='61'
          group by line_id;
----------------------------------------ÕÀøÓ----------------------------------------------
--—∫Ω
--”‡∂Ó
--¥¢÷µ∆±≥À≥µø€
/*
  insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03') and
                 tr_type_id='57'
          group by line_id;*/
          /*--v1.3
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03','07') and
                 tr_type_id='57'
          group by line_id; */
          --v1.31
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','07','08','09') and--20170724 ‘ˆº”¥≈∏°∆±
                 tr_type_id='57'
          group by line_id;
--µ•≥Ã∆±ÕÀøÓ
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_bala),0,0
         from t#OP_INC_STA_INCOME_RPT
          where card_main_code='01' and
                tr_type_id='57'
          group by line_id;
--ÕÀøÓ–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee+return_bala-penalty),0
         from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='57'
        group by line_id;
------------------------------------------”¶ ’Ω∂Ó
insert into t#OP_INC_STA_INCOME_RESULT
  select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(sale_total+add_total+fee_total+update_total-cut_oct-cut_dt-update_dc2-update_dt2-update_oct2+affair_penalty-affair_return-ret_total)
  from t#OP_INC_STA_INCOME_RESULT
             group by line_id;
--∏¸–¬œﬂ¬∑√˚
update t#OP_INC_STA_INCOME_RESULT a
set a.line_name =(
select b.sequence || b.line_name
from op_prm_line b
where b.record_flag='0' and a.line_id=b.line_id);
------------------------------------◊‹º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
          select '99','99◊‹º∆','99','99◊‹º∆',
       sum(tvm_sale),
       sum(bom_sale ),
       sum(sale_total),
       sum(tvm_add  ),
       sum(bom_add ),
       sum(add_total),
       sum(fee_total ),
       sum(update_dc ),
       sum(update_dt ),
       sum(update_oct ),
       sum(update_dc2 ),
       sum(update_dt2 ),
       sum(update_oct2 ),
       sum(update_total),
       sum(cut_dt),
       sum(cut_oct),
       sum(affair_02),
       sum(affair_03),
       sum(affair_penalty),
       sum(affair_return),
       sum(ret_desosit),
       sum(ret_bala),
       sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
       sum(ret_sjt),
       sum(ret_total),
       sum(total)
       from t#OP_INC_STA_INCOME_RESULT
       where line_id<>'99';
--∑µªÿΩ·π˚
open out_cursor for
select   v_squad_day||v_balance_day day,substr(line_name,0,2) as sequence,substr(line_name,3) as line_name,
      sum(tvm_sale)          tvm_sale,
      sum(bom_sale )         bom_sale,
      sum(sale_total)        sale_total,
      sum(tvm_add)           tvm_add  ,
      sum(bom_add )          bom_add ,
      sum(add_total)         add_total,
      sum(fee_total)         fee_total ,
      sum(update_dc)         update_dc ,
      sum(update_dt)         update_dt ,
      sum(update_oct)        update_oct ,
      sum(update_dc2)        update_dc2 ,
      sum(update_dt2)        update_dt2 ,
      sum(update_oct2)       update_oct2 ,
      sum(update_total)      update_total,
      sum(cut_dt)            cut_dt,
      sum(cut_oct)           cut_oct    ,
      sum(affair_02)         affair_02,
      sum(affair_03)         affair_03  ,
      sum(affair_penalty)    affair_penalty,
      sum(affair_return)     affair_return,
      sum(ret_desosit)       ret_desosit,
      sum(ret_bala)          ret_bala,
      sum(penalty)           penalty,
      sum(ret_sjt)           ret_sjt,
      sum(ret_total)         ret_total,
      sum(total)             total
      from t#OP_INC_STA_INCOME_RESULT
      group by line_name
      order by sequence,line_name;
      end;
/
grant execute on ACC_ST.UP_OP_INC_LINE_INCOME_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_INCOME_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_INCOME_M
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_INCOME_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_LINE_INCOME_M
--ƒ£∞Â√˚£∫rpt_02_021
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑ ’“ÊÕ≥º∆‘¬±®
--¥¥Ω®’ﬂ£∫ wangkejia
--¥¥Ω®»’∆⁄£∫20130909
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140624
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');£®by lili£©
          --2>±®±Ì∑«œ÷Ω∏¸–¬–ﬁ∏ƒ£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140721
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬‘ˆº”£∫tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0;
            --2>±®±Ì‘ˆº”tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0µƒ∑«œ÷Ω∏¸–¬
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140729
--–ﬁ∏ƒƒ⁄»›£∫1>∑«œ÷Ω∏¸–¬:tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0
--∏ƒŒ™£∫tr_type_id='56' and  pay_mode_id ='02' and penalty_fee=0
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150320
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”“Ï–Œø® ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150330
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ÷ª˙∆± ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±Õ≥º∆

AS
        v_squad_day char(6);
        v_balance_day char(6);
BEGIN
v_squad_day:=substr(in_squad_day,1,6);
v_balance_day:=substr(in_balance_day,1,6);
--≤È—Øœ‡πÿ ˝æ›
 insert into  t#OP_INC_STA_INCOME_RPT
 (line_id,station_id,squad_day,tr_type_id,paymode_id,do_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty)
               select line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
                where  balance_water_no>=V_balance_day||'0100' and balance_water_no<=V_balance_day||'3199' and SUBSTR(squad_day,1,6)=v_squad_day;
------------------------------------µ•≥Ã∆±∑¢ €
--TVMµ•≥Ã∆±∑¢ €
        insert into t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='01'  and
               dev_type_id='02'    and
               tr_type_id='50'
        group by line_id;
--bomµ•≥Ã∆±∑¢ €
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              dev_type_id='03' and
              tr_type_id='50'
        group by line_id;
--µ•≥Ã∆±∑¢ €–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='50'
        group by line_id;
--------------------------------------≥‰÷µΩ∂Ó---------------------------------------
--TVM≥‰÷µ
         insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  dev_type_id='02' and
               tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;

--BOM≥‰÷µ
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where dev_type_id='03' and
              tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;

--≥‰÷µ–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='54' and paymode_id in ('14','94','54')
        group by line_id;
----—∫Ω–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  (tr_type_id='50' or tr_type_id='51')
        group by line_id;
-------------------∏¸–¬Ω∂Ó----------------------
--œ÷Ω∏¸–¬£∫
--µ•≥À∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='01'
        group by line_id;
/*--µÿÃ˙¥¢÷µ∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='02' and
              tr_type_id='56' and paymode_id='01'
        group by line_id;*/
        --v1.3
            insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
              tr_type_id='56' and paymode_id='01'
        group by line_id;
--≥« –Õ®œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='01'
       group by line_id;
--∑«œ÷Ω(∏¸–¬Ω∂Ó≤ªŒ™0)£∫
---------------------- ˝æ›¿¥‘¥£∫deal±Ì---------------------------------
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
/*
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id;*/
       --v1.3
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id;
-----------------------------------------------------------------------
--20140729∏¸–¬£ª
---------------------- ˝æ›¿¥‘¥£∫update±Ì---------------------------------
--∑«œ÷Ω∏¸–¬£∫
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
/*
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id;*/
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --20170724 –¬‘ˆ¥≈∏°∆±
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id;
----------------------------------------------------------------------

----------------------------------------------------------------------
/*--20140721–¬‘ˆ£∫
--∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='00' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;*/
        --∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)

----------------------------------------------------------------------
--∏¸–¬–°º∆
insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,sum(update_dc+update_dt+update_oct+update_dc2+update_dt2+update_oct2),0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RESULT
       group by line_id;
-------------------------------------≥Â’˝--------------------------------------------------
--µÿÃ˙¥¢÷µ∆±≥Â’˝
/*
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'','','',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
             tr_type_id='54' and paymode_id='18'
       group by line_id;*/
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'','','',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
             tr_type_id='54' and paymode_id='18'
       group by line_id;
--≥« –Õ®≥Â’˝
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='06' and
               tr_type_id='54' and paymode_id='18'
        group by line_id;
---------------------------------------––’˛¥¶¿Ì--
--√‚∑—Ω¯≥ˆ’æ∆± ˝¡ø
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='61' and do_type in('02')
        group by line_id;
--∏∂∑—≥ˆ’æ∆± ˝¡ø
 insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='61' and do_type='03'
        group by line_id;
--––’˛ ¬ŒÒ ’»Î
--––’˛ ¬ŒÒ÷ß≥ˆ
insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),0,0,0,0,0,0
     from t#OP_INC_STA_INCOME_RPT
          where tr_type_id='61'
          group by line_id;
----------------------------------------ÕÀøÓ----------------------------------------------
--—∫Ω
--”‡∂Ó
--¥¢÷µ∆±≥À≥µø€
/*
  insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03') and
                 tr_type_id='57'
          group by line_id;*/
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','07','08','09') and--20170724 –¬‘ˆ¥≈∏°∆±
                 tr_type_id='57'
          group by line_id;
--µ•≥Ã∆±ÕÀøÓ
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_bala),0,0
         from t#OP_INC_STA_INCOME_RPT
          where card_main_code='01' and
                tr_type_id='57'
          group by line_id;
--ÕÀøÓ–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee+return_bala-penalty),0
         from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='57'
        group by line_id;
------------------------------------------”¶ ’Ω∂Ó
insert into t#OP_INC_STA_INCOME_RESULT
  select line_id,'','','',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(sale_total+add_total+fee_total+update_total-cut_oct-cut_dt-update_dc2-update_dt2-update_oct2+affair_penalty-affair_return-ret_total)
  from t#OP_INC_STA_INCOME_RESULT
             group by line_id;
--∏¸–¬œﬂ¬∑√˚
update t#OP_INC_STA_INCOME_RESULT a
set a.line_name =(
select '('||b.line_id||')'||b.line_name
from op_prm_line b
where b.record_flag='0' and a.line_id=b.line_id);
------------------------------------◊‹º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
          select '99','◊‹º∆','99','◊‹º∆',
       sum(tvm_sale),
       sum(bom_sale ),
       sum(sale_total),
       sum(tvm_add  ),
       sum(bom_add ),
       sum(add_total),
       sum(fee_total ),
       sum(update_dc ),
       sum(update_dt ),
       sum(update_oct ),
       sum(update_dc2 ),
       sum(update_dt2 ),
       sum(update_oct2 ),
       sum(update_total),
       sum(cut_dt),
       sum(cut_oct),
       sum(affair_02),
       sum(affair_03),
       sum(affair_penalty),
       sum(affair_return),
       sum(ret_desosit),
       sum(ret_bala),
       sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
       sum(ret_sjt),
       sum(ret_total),
       sum(total)
       from t#OP_INC_STA_INCOME_RESULT
       where line_id<>'99';
--∑µªÿΩ·π˚
open out_cursor for
select   v_squad_day||v_balance_day mon,line_id,line_name,
      sum(tvm_sale)          tvm_sale,
      sum(bom_sale )         bom_sale,
      sum(sale_total)        sale_total,
      sum(tvm_add)           tvm_add  ,
      sum(bom_add )          bom_add ,
      sum(add_total)         add_total,
      sum(fee_total)         fee_total ,
      sum(update_dc)         update_dc ,
      sum(update_dt)         update_dt ,
      sum(update_oct)        update_oct ,
      sum(update_dc2)        update_dc2 ,
      sum(update_dt2)        update_dt2 ,
      sum(update_oct2)       update_oct2 ,
      sum(update_total)      update_total,
      sum(cut_dt)            cut_dt,
      sum(cut_oct)           cut_oct    ,
      sum(affair_02)         affair_02,
      sum(affair_03)         affair_03  ,
      sum(affair_penalty)    affair_penalty,
      sum(affair_return)     affair_return,
      sum(ret_desosit)       ret_desosit,
      sum(ret_bala)          ret_bala,
      sum(penalty)           penalty,
      sum(ret_sjt)           ret_sjt,
      sum(ret_total)         ret_total,
      sum(total)             total
      from t#OP_INC_STA_INCOME_RESULT
      group by line_id,line_name;
      end;
/
grant execute on ACC_ST.UP_OP_INC_LINE_INCOME_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_INCOME_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_RETURN_D
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_RETURN_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-----------------------------------------------------------------------------------------
--π¶ƒ‹£∫œﬂ¬∑ÕÀøÓÕ≥º∆»’±® œ˙ € ’“Ê¿‡±®±Ì
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥¡¢ ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_030
-----------------------------------------------------------------------------------------
AS
 v_line_id              char(2);
 v_line_name            varchar(20);
 v_squad_date           char(8);       -- ‘À”™»’
 v_balance_date         char(8);--«ÂÀ„»’
    BEGIN
    v_line_id:=in_line_id;
    v_squad_date:=substr(in_squad_day,1,8);
    v_balance_date:=substr(in_balance_day,1,8);
    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and substr(squad_day,1,8)=v_squad_date
 and line_id=v_line_id
 and card_main_id in('01','02','03');
  --ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '1','∞Ï¿Ì ˝¡ø',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and a.line_id=v_line_id and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '2','ÕÀªπ—∫Ω',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and a.line_id=v_line_id and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '3','’€À ˝¡ø',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and a.line_id=v_line_id and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
'4','ÕÀªπ”‡∂Ó',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and a.line_id=v_line_id and c.record_flag='0' and c.card_main_id in('01','02','03');
 ----------≤Â»ÎΩ·π˚ºØ --∞¥∆±ø® Ù–‘£®1∞Ï¿Ì ˝¡ø2ÕÀªπ—∫Ω3’€À ˝¡ø4ÕÀªπ”‡∂Ó£©∑÷¿‡
  insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
      insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
      -- ≤Â»ÎŒ≤¡––°º∆
           insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
      insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
 ----…æ≥˝µ•≥Ã∆±µƒ’€À ˝¡ø∫ÕÕÀªπ”‡∂Ó
 delete t#op_inc_sys_return_result where card_main_code='01' and return_code in('3','2');
 update t#op_inc_sys_return_result set return_para='ÕÀªπΩ∂Ó' where card_main_code='01' and return_code='2' ;
       --∏¸–¬
   --∏¸–¬’æµ„√˚
      update t#op_inc_sys_return_result a
   set a.station_name=(
   select b.sequence||b.chinese_name from op_prm_station  b where a.station_id=b.station_id and a.line_id=b.line_id and b.record_flag='0');
   --∏¸–¬ÕÀ∆±∑Ω Ω√˚
     update t#op_inc_sys_return_result a
   set a.return_name=(
   select b.return_name from st_cod_return_type  b where a.return_type=b.return_type);
   --∏¸–¬∆±ø®√˚≥∆
    update t#op_inc_sys_return_result a
   set a.card_name=(
   select b.card_sub_name from op_prm_card_sub b
   where a.card_main_code=b.card_main_id and a.card_sub_code=b.card_sub_id and b.record_flag='0')
   where a.card_main_code!=' '
   and a.card_main_code!='06';
    update t#op_inc_sys_return_result
   set card_name='≥« –Õ®∆±'
   where card_main_code='06';
if v_line_id is not null and v_line_id!=' ' then
select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
end if;
-----∑µªÿΩ·π˚ºØ
open out_cursor for
select v_squad_date||v_balance_date mon,v_line_name linename,station_name,return_type||return_name returnname,card_main_code||card_sub_code||card_name cardname,return_code||return_para return_cardpara,return_value
 from t#op_inc_sys_return_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_LINE_RETURN_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_RETURN_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_RETURN_M
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_RETURN_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-----------------------------------------------------------------------------------------
--π¶ƒ‹£∫œﬂ¬∑ÕÀøÓÕ≥º∆‘¬±® œ˙ € ’“Ê¿‡±®±Ì
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥¡¢ ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_009
-----------------------------------------------------------------------------------------
AS
 v_line_id              char(2);
 v_line_name            varchar(20);
 v_squad_date           char(6);       -- ‘À”™‘¬
 v_balance_date         char(6);
    BEGIN
    v_line_id:=in_line_id;
    v_squad_date:=substr(in_squad_day,1,6);
    v_balance_date:=substr(in_balance_day,1,6);
    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 and line_id=v_line_id;
  --ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '1','∞Ï¿Ì ˝¡ø',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '2','ÕÀªπ—∫Ω',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '3','’€À ˝¡ø',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select a.line_id,a.station_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
'4','ÕÀªπ”‡∂Ó',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
 ----------≤Â»ÎΩ·π˚ºØ --∞¥∆±ø® Ù–‘£®1∞Ï¿Ì ˝¡ø2ÕÀªπ—∫Ω3’€À ˝¡ø4ÕÀªπ”‡∂Ó£©∑÷¿‡
  insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
      insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,station_id,return_type,card_main_code,card_sub_code,
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type,card_main_code,card_sub_code;
      -- ≤Â»ÎŒ≤¡––°º∆
           insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
      insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,station_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,station_id,return_type,'','','∫œº∆',
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,station_id,return_type;
 ----…æ≥˝µ•≥Ã∆±µƒ’€À ˝¡ø∫ÕÕÀªπ”‡∂Ó
 delete t#op_inc_sys_return_result where card_main_code='01' and return_code in('3','2');
 update t#op_inc_sys_return_result set return_para='ÕÀªπΩ∂Ó' where card_main_code='01' and return_code='2' ;
       --∏¸–¬
   --∏¸–¬’æµ„√˚
      update t#op_inc_sys_return_result a
   set a.station_name=(
   select b.sequence||b.chinese_name from op_prm_station  b where a.station_id=b.station_id and a.line_id=b.line_id and b.record_flag='0');
   --∏¸–¬ÕÀ∆±∑Ω Ω√˚
     update t#op_inc_sys_return_result a
   set a.return_name=(
   select b.return_name from st_cod_return_type  b where a.return_type=b.return_type);
   --∏¸–¬∆±ø®√˚≥∆
    update t#op_inc_sys_return_result a
   set a.card_name=(
   select b.card_sub_name from op_prm_card_sub b
   where a.card_main_code=b.card_main_id and a.card_sub_code=b.card_sub_id and b.record_flag='0')
   where a.card_main_code!=' '
   and a.card_main_code!='06';
    update t#op_inc_sys_return_result
   set card_name='≥« –Õ®∆±'
   where card_main_code='06';
if v_line_id is not null and v_line_id!=' ' then
select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
end if;
-----∑µªÿΩ·π˚ºØ
open out_cursor for
select v_squad_date||v_balance_date mon,v_line_name linename,station_name,return_type||return_name returnname,card_main_code||card_sub_code||card_name cardname,return_code||return_para return_cardpara,return_value
 from t#op_inc_sys_return_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_LINE_RETURN_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_RETURN_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_LINE_SALE_D
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_LINE_SALE_D (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_LINE_SALE_D
--∂‘”¶ƒ£∞Â£∫rpt_02_004
--π¶ƒ‹√Ë ˆ£∫≥µ∆±∑¢ €Õ≥º∆»’±®-∞¥œﬂ¬∑≥µ’æÕ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_line_id char(2);
   v_line_name varchar(30);
   v_squad_date           char(8);       -- ‘À”™»’
   v_balance_date         char(8);
    BEGIN
     v_line_id:=in_line_id;
     v_balance_date:=substr(in_balance_day,1,8);
     v_squad_date:=substr(in_squad_day,1,8);
     if v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
     end if;
     ----≤È—Øœ‡πÿ ˝æ›
      insert into t#OP_SYS_SALE_rpt
 (line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,charge_fee)
 select line_id,station_id,dev_type_id,pay_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,sum(sale_num),sum(deposit_fee),sum(charge_fee)
                from st_sts_inc_sale
                where balance_water_no>=v_balance_date||'01'
                and balance_water_no<=v_balance_date||'99'
                and squad_day=v_squad_date
                and line_id=v_line_id
                and dev_type_id in ('03','02')
 group by line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id;
 ----ππΩ®Ω·π˚ºØΩ·ππ
     insert into t#OP_SYS_SALE_result
    (line_id,station_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,a.station_id,b.dev_type_id,c.payment_id,d.card_main_id,
                case when d.card_main_id='06' then '00' else d.card_sub_id end,'1','1 ˝¡ø',0
                from op_prm_station a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d
                where a.record_flag='0' and a.line_id=v_line_id and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';

     insert into t#OP_SYS_SALE_result
    (line_id,station_id,dev_type_id,payment_id,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select a.line_id,a.station_id,b.dev_type_id,c.payment_id,'',
                '','∫œº∆','1','1 ˝¡ø',0
                from op_prm_station a,op_prm_dev_type b,st_cod_payment c
                where a.record_flag='0' and a.line_id=v_line_id and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03');

                     insert into t#OP_SYS_SALE_result
    (line_id,station_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,a.station_id,b.dev_type_id,c.payment_id,d.card_main_id,
                case when d.card_main_id='06' then '00' else d.card_sub_id end,'2','2—∫Ω',0
                from op_prm_station a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d
                where a.record_flag='0' and a.line_id=v_line_id and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
          insert into t#OP_SYS_SALE_result
    (line_id,station_id,dev_type_id,payment_id,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select a.line_id,a.station_id,b.dev_type_id,c.payment_id,'',
                '','∫œº∆','2','2—∫Ω',0
                from op_prm_station a,op_prm_dev_type b,st_cod_payment c
                where a.record_flag='0' and a.line_id=v_line_id and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03');

                     insert into t#OP_SYS_SALE_result
    (line_id,station_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,a.station_id,b.dev_type_id,c.payment_id,d.card_main_id,
                case when d.card_main_id='06' then '00' else d.card_sub_id end,'3','3≥‰÷µ',0
                from op_prm_station a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d
                where a.record_flag='0' and a.line_id=v_line_id and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';

           insert into t#OP_SYS_SALE_result
    (line_id,station_id,dev_type_id,payment_id,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select a.line_id,a.station_id,b.dev_type_id,c.payment_id,'',
                '','∫œº∆','3','3≥‰÷µ',0
                from op_prm_station a,op_prm_dev_type b,st_cod_payment c
                where a.record_flag='0' and a.line_id=v_line_id and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03');
--∑÷±≤Â»Î∆±ø®»˝÷÷ Ù–‘µƒ÷µ :  ˝¡ø01 —∫Ω02 ≥‰÷µ03
    insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'',card_main_id,
                case when card_main_id='06' then '00' else card_sub_id end,
                '','1','1 ˝¡ø',sum(sale_num)
                from t#OP_SYS_SALE_rpt
                group by line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id;
------≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','1','1 ˝¡ø',sum(sale_num)
                from t#OP_SYS_SALE_rpt
              group by line_id,station_id,dev_type_id,pay_type;
                    insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'',card_main_id,
                case when card_main_id='06' then '00' else card_sub_id end,
                '','2','2—∫Ω',sum(deposit_fee)
                from t#OP_SYS_SALE_rpt
               group by line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id;
                             --≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','2','2—∫Ω',sum(deposit_fee)
                 from t#OP_SYS_SALE_rpt
              group by  line_id,station_id,dev_type_id,pay_type;
                        insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'',card_main_id,
                case when card_main_id='06' then '00' else card_sub_id end,
                '','3','3≥‰÷µ',sum(charge_fee)
                 from t#OP_SYS_SALE_rpt
              group by  line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id;
                --≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','3','3≥‰÷µ',sum(charge_fee)
                from t#OP_SYS_SALE_rpt where card_main_id!='01'
              group by  line_id,station_id,dev_type_id,pay_type;
                --≤Â»ÎŒ≤¡––°º∆ µ•≥Ã∆±Ω∂Ó
                 insert into t#OP_SYS_SALE_result
    (line_id,station_id,station_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,station_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','4','4Ω∂Ó',sum(charge_fee)
                from t#OP_SYS_SALE_rpt where card_main_id='01'
              group by  line_id,station_id,dev_type_id,pay_type;
                --∏¸–¬’æµ„
             update t#OP_SYS_SALE_result a
             set a.station_name=(
           select b.sequence||b.chinese_name from op_prm_station b where a.station_id=b.station_id and a.line_id=b.line_id and b.record_flag='0');
             --∏¸–¬…Ë±∏√˚
              update t#OP_SYS_SALE_result a
             set a.dev_name=(
             select dev_type_name from op_prm_dev_type b
             where a.dev_type_id=b.dev_type_id and record_flag='0');
             --∏¸–¬÷ß∏∂∑Ω Ω√˚
             update t#OP_SYS_SALE_result a
             set a.payment_name=(
             select b.payment_name from st_cod_payment b
             where a.payment_id=b.payment_id);
             --∏¸–¬∆±ø®√˚≥∆
                update t#OP_SYS_SALE_result a
             set a.card_name=(
             select card_sub_name from op_prm_card_sub B
     where b.card_main_id=a.card_main_code
     and b.card_sub_id=a.card_sub_code and b.record_flag='0')
         where card_main_code!=' ';
             update t#OP_SYS_SALE_result a
             set a.card_name='≥« –Õ®∆±',a.card_sub_code='00'
             where a.card_main_code='06';
            --∏¸–¬µ•≥Ã∆± Ω∂Ó
             update t#OP_SYS_SALE_result
             set sale_name='2Ω∂Ó'  where sale_code='3' and card_main_code='01'
             and card_sub_code='00';
             delete t#OP_SYS_SALE_result where sale_code='2' and card_main_code='01' and card_sub_code='00';
             --∑µªÿΩ·π˚ºØ
open out_cursor for
select v_squad_date||v_balance_date day,v_line_name linename,station_name stationname,dev_name,payment_name,card_main_code||card_sub_code||card_name cardname,sale_name,sum(num)
from t#OP_SYS_SALE_result
group by station_name,dev_name,payment_name,card_main_code,card_sub_code,card_name,sale_name
order by station_name,dev_name,payment_name,card_main_code,card_sub_code,card_name,sale_name;
end;
/
grant execute on ACC_ST.UP_OP_INC_LINE_SALE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_LINE_SALE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_PRE_CARD_M
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_PRE_CARD_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-----------------------------------------------------------------------
--¥¥Ω®’ﬂ£∫Õıø…º—
--Ω®¡¢ ±º‰£∫20131020
--∂‘”¶ƒ£∞Â£∫rpt_02_027
--π¶ƒ‹£∫”≈ª›∆±÷÷ ’“ÊÕ≥º∆‘¬±®
--π˝≥Ã√˚£∫UP_OP_INC_PRE_CARD_M
-----------------------------------------------------------------------
AS
v_balance_day char(6);
v_squad_day   char(6);
    BEGIN
    v_balance_day:=substr(in_balance_day,1,6);
    v_squad_day:=substr(in_squad_day,1,6);
    --≤È—Ø ˝æ›
    insert into t#op_inc_pre_card_rpt1
    (line_id,squad_day,balance_water_no,card_main_id,card_sub_id,deal_num,deal_fee,deal_no_discount_fee)
    select line_id,squad_day,balance_water_no,card_main_id,card_sub_id,deal_num,deal_fee,deal_no_discount_fee
    from st_sts_inc_consume
    where balance_water_no>=v_balance_day||'0100'
    and balance_water_no<=v_balance_day||'3199'
    and substr(squad_day,1,6)=v_squad_day
    and  card_main_id='02' ;
   insert into t#op_inc_pre_card_rpt0
      select line_id,'','’€ø€”≈ª›',
      deal_num,deal_no_discount_fee,deal_fee,deal_no_discount_fee-deal_fee,
      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from t#op_inc_pre_card_rpt1
   where card_main_id='02' and card_sub_id='01';
   insert into t#op_inc_pre_card_rpt0
      select line_id,'','’€ø€”≈ª›',0,0,0,0,
      deal_num,deal_no_discount_fee,deal_fee,deal_no_discount_fee-deal_fee,
      0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from t#op_inc_pre_card_rpt1
   where card_main_id='02' and card_sub_id='02';
   insert into t#op_inc_pre_card_rpt0
      select line_id,'','’€ø€”≈ª›',0,0,0,0,0,0,0,0,
      deal_num,deal_no_discount_fee,deal_fee,deal_no_discount_fee-deal_fee,
      0,0,0,0,0,0,0,0,0,0,0,0
      from t#op_inc_pre_card_rpt1
   where card_main_id='02' and card_sub_id='03';
   --ƒ©––◊‹º∆
   insert into t#op_inc_pre_card_rpt0
      select line_id,'','’€ø€”≈ª›',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
      deal_num,deal_no_discount_fee,deal_fee,deal_no_discount_fee-deal_fee
      from t#op_inc_pre_card_rpt1
      where card_main_id='02' and card_sub_id in('01','02','03');
   --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_pre_card_rpt0 a set a.line_name=(
       select  b.line_name from op_prm_line b
         where a.line_id=b.line_id and b.record_flag='0')
     where EXISTS (select 1 from op_prm_line b where a.line_id=b.line_id and b.record_flag='0');
--≤È—ØΩ·π˚ºØ
open out_cursor for
select v_balance_day||v_squad_day day,line_id,line_name,
sum(pre_num0) pre_num0,
sum(pre_bef_fee0) pre_bef_fee0,
sum(pre_aft_fee0) pre_aft_fee0,
sum(pre_fee0) pre_fee0,
sum(pre_num1) pre_num1,
sum(pre_bef_fee1) pre_bef_fee1,
sum(pre_aft_fee1) pre_aft_fee1,
sum(pre_fee1) pre_fee1,
sum(pre_num2) pre_num2,
sum(pre_bef_fee2) pre_bef_fee2,
sum(pre_aft_fee2) pre_aft_fee2,
sum(pre_fee2) pre_fee2,
sum(total_pre_num) total_pre_num,
sum(total_pre_bef_fee) total_pre_bef_fee,
sum(total_pre_aft_fee) total_pre_aft_fee,
sum(total_pre_fee) total_pre_fee
from   t#op_inc_pre_card_rpt0
group by line_id,line_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_PRE_CARD_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_PRE_CARD_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RECHARGE_D
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RECHARGE_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ ∆±ø®≥‰÷µÕ≥º∆»’±®£®≤È—ØÀ˘”–œﬂ¬∑£©
--∂‘”¶ƒ£∞Â£∫rpt_02_023
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(8);
v_balance_day char(8);
    BEGIN
     v_squad_day:=substr(in_squad_day,1,8);
     v_balance_day:=substr(in_balance_day,1,8);
     v_line_id:=in_line_id;
    if v_line_id !=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line
     where line_id=v_line_id and record_flag='0';
   end if;
     --≤È—Øœ‡πÿ ˝æ›
      insert into t#op_inc_recharge_rpt
     (line_id,station_id,dev_type_id,card_main_id,card_sub_id,deal_fee,num)
     select line_id,station_id,dev_type_id,card_main_id,card_sub_id,charge_fee,charge_num
     from st_sts_inc_charge a
      where balance_water_no<=v_balance_day||'99'
         and  balance_water_no>=v_balance_day||'00'
         and  substr(squad_day,1,8)=v_squad_day
         and  line_id=v_line_id
         and card_main_id in ('02','03','04')
         and dev_type_id in ('02','03');
     --ππΩ®Ω·π˚ºØΩ·ππ
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±',c.card_main_id,c.card_sub_id,' ˝¡ø',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');

     insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆',' ˝¡ø',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±',c.card_main_id,c.card_sub_id,'Ω∂Ó',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');
     insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆','Ω∂Ó',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');
          --µº»ÎΩ·π˚ºØ
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±',card_main_id,card_sub_id,'',' ˝¡ø',sum(num)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id,card_main_id,card_sub_id;
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±',card_main_id,card_sub_id,'','Ω∂Ó',sum(deal_fee)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id,card_main_id,card_sub_id;
      --≤Â»ÎŒ≤¡–∫œº∆
              insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆',' ˝¡ø',sum(num)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id;
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆','Ω∂Ó',sum(deal_fee)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id;
----∏¸–¬∆±ø®√˚
     update t#op_inc_recharge_result a
     set card_name=(
     select card_sub_name from op_prm_card_sub b
     where a.card_main_id=b.card_main_id and a.card_sub_id=b.card_sub_id and b.record_flag='0')
     where a.card_main_id!=' ';
     ----∏¸–¬’æµ„√˚
     update t#op_inc_recharge_result  a
     set a.station_name=(select b.sequence||b.chinese_name from op_prm_station b where a.line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0');
     --∏¸–¬…Ë±∏√˚
     update t#op_inc_recharge_result set dev_type_name='TVM' where dev_type_id='02';
     update t#op_inc_recharge_result set dev_type_name='BOM' where dev_type_id='03';
       --≤È—ØΩ·π˚ºØ
     open out_cursor for
     select v_squad_day||v_balance_day day,v_line_name linename,station_name,dev_type_name,ic_main_name,card_main_id||card_sub_id||card_name,deal_name,num
     from t#op_inc_recharge_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_RECHARGE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RECHARGE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RECHARGE_DAY
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RECHARGE_DAY (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ ∆±ø®≥‰÷µÕ≥º∆»’±®£®≤È—ØÀ˘”–œﬂ¬∑£©
--∂‘”¶ƒ£∞Â£∫rpt_02_023
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--¡Ÿ ±±Ì£∫t#op_inc_recharge_rpt£¨t#op_inc_recharge
--------------------------------------------------------------
--–ﬁ∏ƒ ±º‰£∫20140130
--‘ˆº”–¬∆±÷÷£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨∆’Õ® ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_recharge
--µ˜’˚∂‘”¶±®±Ì£∫rpt_02_023
--–ﬁ∏ƒ’ﬂ£∫wangkejia
--------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170206
  --–ﬁ∏ƒƒ⁄»›£∫
     --∂‘stationΩ¯––Ωÿ»°£¨»•≥˝ ˝◊÷±‡∫≈
  --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫÷”◊”∆Ê
  --–ﬁ∏ƒ»’∆⁄£∫20170723
  --–ﬁ∏ƒƒ⁄»›£∫
    --–¬‘ˆ¥≈∏°Õ®«⁄ø®
  --------------------------------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(8);
v_balance_day char(8);
v_num_line int;
    BEGIN
     v_squad_day:=substr(in_squad_day,1,8);
     v_balance_day:=substr(in_balance_day,1,8);
     v_line_id:=in_line_id;
     select count(line_name) into v_num_line from op_prm_line
     where line_id=v_line_id and record_flag='0';
    if v_num_line=1 then
     select line_name into v_line_name from op_prm_line
     where line_id=v_line_id and record_flag='0';
   end if;
   --ππΩ®Ω·π˚ºØ
   insert into t#op_inc_recharge
        select station_id,'','02','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id;
   insert into t#op_inc_recharge
        select station_id,'','03','',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from op_prm_station b
          where b.record_flag='0' and b.line_id=v_line_id;
     --≤È—Øœ‡πÿ ˝æ›
      insert into t#op_inc_recharge_rpt
     (line_id,station_id,dev_type_id,card_main_id,card_sub_id,deal_fee,num)
     select line_id,station_id,dev_type_id,card_main_id,card_sub_id,charge_fee,charge_num
     from st_sts_inc_charge a
      where balance_water_no<=v_balance_day||'99'
         and  balance_water_no>=v_balance_day||'00'
         and  substr(squad_day,1,8)=v_squad_day
         and  line_id=v_line_id
         --and card_main_id in ('02','03','04','07','08')--20150130‘ˆº”'07'°¢'08'
         and card_main_id||card_sub_id in ('0200','0201','0202','0203','0300','0400','0401','0700','0800','0901')--–¬‘ˆ¥≈∏°Õ®«⁄ø®0901,»•µÙ»ﬂ”‡ ˝æ›
         and dev_type_id in ('02','03');
     --≤Â»ÎΩ·π˚ºØ
      insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='01';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='02';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='03';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='03' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='04' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='04' and card_sub_id='01';
          --20150130
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='07' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='08' and card_sub_id='00';
          --20170723 ¥≈∏°Õ®«⁄ø®
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='09' and card_sub_id='01';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(num),sum(deal_fee)
        from t#op_inc_recharge_rpt
          group by station_id,dev_type_id;
     ----∏¸–¬’æµ„√˚
     update t#op_inc_recharge  a
     set a.station_name=
     (select b.sequence||b.chinese_name from op_prm_station b
     where v_line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0')
     where exists (select 1 from op_prm_station b
     where v_line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0');
     --∏¸–¬…Ë±∏√˚
     update t#op_inc_recharge set dev_name='TVM' where dev_type='02';
     update t#op_inc_recharge set dev_name='BOM' where dev_type='03';
       --≤È—ØΩ·π˚ºØ
       --∑÷¿Îstation_name,∞¥’’sequence≈≈–Ú£¨Õ¨ ±≤ªœ‘ æ ˝◊÷±‡∫≈
     open out_cursor for
     select v_squad_day||v_balance_day day,v_line_name linename,
     /*station_name*/
     substr(station_name,1,2) as sequence,
     substr(station_name,3) station_name, dev_name,
     sum(num0) num0,
     sum(fee0) fee0,
     sum(num1) num1,
     sum(fee1) fee1,
     sum(num2) num2,
     sum(fee2) fee2,
     sum(num3) num3,
     sum(fee3) fee3,
     sum(num4) num4,
     sum(fee4) fee4,
     sum(num5) num5,
     sum(fee5) fee5,
     sum(num6) num6,
     sum(fee6) fee6,
     sum(num7) num7,
     sum(fee7) fee7,
     sum(num8) num8,
     sum(fee8) fee8,
     sum(num9) num9,
     sum(fee9) fee9,
     sum(total_num) total_num,
     sum(total_fee) total_fee
     from t#op_inc_recharge
     group by station_name,dev_name
     order by sequence,dev_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_RECHARGE_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RECHARGE_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RECHARGE_M
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RECHARGE_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ ∆±ø®≥‰÷µÕ≥º∆‘¬±®£®≤È—ØÀ˘”–œﬂ¬∑£©
--∂‘”¶ƒ£∞Â£∫rpt_02_024
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(6);
v_balance_day char(6);
    BEGIN
     v_squad_day:=substr(in_squad_day,1,6);
     v_balance_day:=substr(in_balance_day,1,6);
     v_line_id:=in_line_id;
 if v_line_id !=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line
     where line_id=v_line_id and record_flag='0';
   end if;
     --≤È—Øœ‡πÿ ˝æ›
      insert into t#op_inc_recharge_rpt
     (line_id,station_id,dev_type_id,card_main_id,card_sub_id,deal_fee,num)
     select line_id,station_id,dev_type_id,card_main_id,card_sub_id,charge_fee,charge_num
     from st_sts_inc_charge a
      where balance_water_no<=v_balance_day||'99'
         and  balance_water_no>=v_balance_day||'00'
         and  substr(squad_day,1,6)=v_squad_day
         and  line_id=v_line_id
         and card_main_id in ('02','03','04')
         and dev_type_id in ('02','03');
        --ππΩ®Ω·π˚ºØΩ·ππ
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±',c.card_main_id,c.card_sub_id,' ˝¡ø',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');

     insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆',' ˝¡ø',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±',c.card_main_id,c.card_sub_id,'Ω∂Ó',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');
     insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select a.line_id,a.station_id,b.dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆','Ω∂Ó',0
     from op_prm_station a,op_prm_dev_type b,op_prm_card_sub c
     where a.line_id=v_line_id and a.record_flag=0 and b.record_flag=0 and b.dev_type_id in ('02','03') and c.record_flag=0 and c.card_main_id in('02','03','04');
               --µº»ÎΩ·π˚ºØ
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±',card_main_id,card_sub_id,'',' ˝¡ø',sum(num)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id,card_main_id,card_sub_id;
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±',card_main_id,card_sub_id,'','Ω∂Ó',sum(deal_fee)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id,card_main_id,card_sub_id;
      --≤Â»ÎŒ≤¡–∫œº∆
              insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆',' ˝¡ø',sum(num)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id;
      insert into t#op_inc_recharge_result
     (line_id,station_id,dev_type_id,ic_main_name,card_main_id,card_sub_id,card_name,deal_name,num)
     select line_id,station_id,dev_type_id,'µÿÃ˙¥¢÷µ∆±','','','∫œº∆','Ω∂Ó',sum(deal_fee)
     from t#op_inc_recharge_rpt
     group by line_id,station_id,dev_type_id;
----∏¸–¬∆±ø®√˚
     update t#op_inc_recharge_result a
     set card_name=(
     select card_sub_name from op_prm_card_sub b
     where a.card_main_id=b.card_main_id and a.card_sub_id=b.card_sub_id and b.record_flag='0')
     where a.card_main_id!=' ';
          ----∏¸–¬’æµ„√˚
     update t#op_inc_recharge_result  a
     set a.station_name=(select b.sequence||b.chinese_name from op_prm_station b where a.line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0');
     --∏¸–¬…Ë±∏√˚
     update t#op_inc_recharge_result set dev_type_name='TVM' where dev_type_id='02';
     update t#op_inc_recharge_result set dev_type_name='BOM' where dev_type_id='03';
     --Ω·π˚ºØ
     open out_cursor for
     select v_squad_day||v_balance_day mon,v_line_name linename,station_name,dev_type_name,ic_main_name,card_main_id||card_sub_id||card_name cardname,deal_name,num
     from t#op_inc_recharge_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_RECHARGE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RECHARGE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RECHARGE_MON
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RECHARGE_MON (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ ∆±ø®≥‰÷µÕ≥º∆‘¬±®£®≤È—ØÀ˘”–œﬂ¬∑£©
--∂‘”¶ƒ£∞Â£∫rpt_02_024
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--¡Ÿ ±±Ì£∫t#op_inc_recharge_rpt£¨t#op_inc_recharge
--------------------------------------------------------------
--–ﬁ∏ƒ ±º‰£∫20140130
--‘ˆº”–¬∆±÷÷£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨∆’Õ® ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_recharge
--µ˜’˚∂‘”¶±®±Ì£∫rpt_02_023
--–ﬁ∏ƒ’ﬂ£∫wangkejia
--------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhouyang
--–ﬁ∏ƒ»’∆⁄£∫20170216
--–ﬁ∏ƒƒ⁄»›£∫»•µÙstation_name÷–µƒ≥µ’æ¥˙¬Î
--------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒ»’∆⁄£∫20170723
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°Õ®«⁄ø®
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(6);
v_balance_day char(6);
v_num_line int;
    BEGIN
     v_squad_day:=substr(in_squad_day,1,6);
     v_balance_day:=substr(in_balance_day,1,6);
     v_line_id:=in_line_id;
     select count(line_name) into v_num_line from op_prm_line
     where line_id=v_line_id and record_flag='0';
    if v_num_line=1 then
     select line_name into v_line_name from op_prm_line
     where line_id=v_line_id and record_flag='0';
   end if;
     --≤È—Øœ‡πÿ ˝æ›
      insert into t#op_inc_recharge_rpt
     (line_id,station_id,dev_type_id,card_main_id,card_sub_id,deal_fee,num)
     select line_id,station_id,dev_type_id,card_main_id,card_sub_id,charge_fee,charge_num
     from st_sts_inc_charge a
      where balance_water_no<=v_balance_day||'3199'
         and  balance_water_no>=v_balance_day||'0100'
         and  substr(squad_day,1,6)=v_squad_day
         and  line_id=v_line_id
         --and card_main_id in ('02','03','04','07','08')--20150130‘ˆº”'07'°¢'08'
         and card_main_id||card_sub_id in ('0200','0201','0202','0203','0300','0400','0401','0700','0800','0901') --–¬‘ˆ¥≈∏°Õ®«⁄ø®0901,»•µÙ»ﬂ”‡ ˝æ›
         and dev_type_id in ('02','03');
     --≤Â»ÎΩ·π˚ºØ
      insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='01';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='02';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='02' and card_sub_id='03';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='03' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='04' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='04' and card_sub_id='01';

          --20150130
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='07' and card_sub_id='00';
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='08' and card_sub_id='00';
          --20170723
          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,num,deal_fee,0,0
        from t#op_inc_recharge_rpt
          where card_main_id='09' and card_sub_id='01';

          insert into t#op_inc_recharge
        select station_id,'',dev_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(num),sum(deal_fee)
        from t#op_inc_recharge_rpt
          group by station_id,dev_type_id;
     ----∏¸–¬’æµ„√˚
     update t#op_inc_recharge  a
     set a.station_name=
     (select b.sequence || b.chinese_name from op_prm_station b
     where v_line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0')
     where exists (select 1 from op_prm_station b
     where v_line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0');
     --∏¸–¬…Ë±∏√˚
     update t#op_inc_recharge set dev_name='TVM' where dev_type='02';
     update t#op_inc_recharge set dev_name='BOM' where dev_type='03';
       --≤È—ØΩ·π˚ºØ
     open out_cursor for
     select v_squad_day||v_balance_day mon,v_line_name linename,substr(station_name,0,2) as sequence,
     substr(station_name,3) as station_name,dev_name,
     sum(num0) num0,
     sum(fee0) fee0,
     sum(num1) num1,
     sum(fee1) fee1,
     sum(num2) num2,
     sum(fee2) fee2,
     sum(num3) num3,
     sum(fee3) fee3,
     sum(num4) num4,
     sum(fee4) fee4,
     sum(num5) num5,
     sum(fee5) fee5,
     sum(num6) num6,
     sum(fee6) fee6,
     sum(num7) num7,
     sum(fee7) fee7,
     sum(num8) num8,
     sum(fee8) fee8,
     sum(num9) num9,
     sum(fee9) fee9,
     sum(total_num) total_num,
     sum(total_fee) total_fee
     from t#op_inc_recharge
     group by station_name,dev_name
     order by sequence,dev_name;--20170216 zhouyang
    END;
/
grant execute on ACC_ST.UP_OP_INC_RECHARGE_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RECHARGE_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RETURN_LINE_D
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RETURN_LINE_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_030
--π¶ƒ‹√Ë ˆ£∫ÕÀøÓÕ≥º∆»’±®-∞¥œﬂ¬∑/’æµ„Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
--ÕÀøÓÕ≥º∆Õ®”√¡Ÿ ±±Ì£∫t#op_inc_sys_return_rpt,t#op_inc_sys_return
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”≈–∂œ£∫op_prm_line±Ì¿Ô”– ˝æ›≤≈∂‘v_line_name∏≥÷µ£¨»∑±£line_id¥ÌŒÛ“≤≤ªª·≤˙…˙¥ÌŒÛ±®±Ì
--–ﬁ∏ƒ ±º‰£∫20140221
----------------------------------------------------------------
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫zzq
--∏¸∏ƒ»’∆⁄£∫20160630
--∏¸∏ƒƒ⁄»›£∫–ﬁ’˝¿œ»À”≈ª›¥¢÷µ∆± ¿œ»À√‚∑—¥¢÷µ∆±µƒcard_sub_code£¨
--¿œ»À”≈ª›¥¢÷µ∆±∂‘”¶card_sub_code='02'°£
-- ¿œ»À√‚∑—¥¢÷µ∆±∂‘”¶card_sub_code='03'
---------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170126
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒƒ⁄»›£∫»•≥˝∑µªÿΩ·π˚÷–≥µ’æµƒ≈≈¡––Ú∫≈
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170722
--–ﬁ∏ƒ’ﬂ£∫zhouyang
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
-------------------------------------------------------------------------------
AS
 v_squad_date           char(8);
 v_balance_date         char(8);
 v_line_id              char(2);
 v_line_name            varchar(20);
 v_num int;
    BEGIN
    v_squad_date:=substr(in_squad_day,1,8);
    v_balance_date:=substr(in_balance_day,1,8);
    v_line_id:=in_line_id;

   select count(line_name) into v_num from op_prm_line WHERE line_id = v_line_id and record_flag='0';
   --–ﬁ∏ƒ£∫‘ˆº”≈–∂œop_prm_line”– ˝æ›‘Ú∏≥÷µ
   IF  v_num=1 THEN
      SELECT line_name
      INTO v_line_name
      FROM op_prm_line
      WHERE line_id = v_line_id and record_flag='0';
   END IF;
 ----ππΩ®Ω·π˚ºØ
   insert into t#op_inc_sys_return
    select a.station_id,'',b.return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_station a,st_cod_return_type b
     where a.record_flag='0' and a.line_id=v_line_id;

    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,
       return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and substr(squad_day,1,8)=v_squad_date
 and line_id=v_line_id
 and card_main_id in('01','02','03','07','08','09');
--µ•≥Ã∆±
 insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    return_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='01' and card_sub_code='00';
--∆’Õ®≥…»À¥¢÷µ∆±
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='00';
--—ß…˙∆’Õ®¥¢÷µ∆±
      insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='01';
--¿œ»À√‚∑—¥¢÷µ∆±
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='03';
--¿œ»À”≈ª›¥¢÷µ
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='02';
--∆’Õ®≥À¥Œ
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='03' and card_sub_code='00';
--∆’Õ®“Ï–Œ¥¢÷µø®
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='07' and card_sub_code='00';
--∆’Õ® ÷ª˙∆±
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='08' and card_sub_code='00';
--¥≈∏°Õ®«⁄ø®
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='09' and card_sub_code='01';
--Œ≤¡––°º∆
     insert into t#op_inc_sys_return
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_num),sum(return_deposit_fee),sum(bad_num),sum(return_balance_fee)
    from t#op_inc_sys_return_rpt
    group by station_id,return_type;
     ----∏¸–¬’æµ„√˚
     update t#op_inc_sys_return a set a.name=(
         select b.sequence||b.Chinese_name from op_prm_station b
         where v_line_id=b.line_id and b.record_flag='0' and b.station_id=a.id)
     where exists
     (select 1 from op_prm_station b
     where v_line_id=b.line_id and a.id=b.station_id and b.record_flag='0');
    ----∏¸–¬ÕÀøÓ∑Ω Ω√˚
     update t#op_inc_sys_return a set a.type_name=(
         select b.return_name from st_cod_return_type b where a.type_id=b.return_type);
     open out_cursor for
--select v_balance_date||v_squad_date day,v_line_name as line_name,a.name as station_name,a.type_name,
--∑÷¿Î≥µ’æ√˚«∞√Ê≈≈–Ú£¨sequence”√”⁄±®±Ì∫Û–¯¥¶¿Ì ±◊˜Œ™≈≈–Ú“¿æ›
select v_balance_date||v_squad_date day,v_line_name as line_name,substr(a.name,1,2) as sequence,substr(a.name,3) as station_name,a.type_name,
     sum(a.return_num) return_num,
     sum(a.return_deposit_fee) return_deposit_fee,
     sum(a.return_num1) return_num1,
     sum(a.return_deposit_fee1) return_deposit_fee1,
     sum(a.bad_num1) bad_num1,
     sum(a.return_balance_fee1) return_balance_fee1,
     sum(a.return_num2) return_num2,
     sum(a.return_deposit_fee2) return_deposit_fee2,
     sum(a.bad_num2) bad_num2,
     sum(a.return_balance_fee2) return_balance_fee2,
     sum(a.return_num3) return_num3,
     sum(a.return_deposit_fee3) return_deposit_fee3,
     sum(a.bad_num3) bad_num3,
     sum(a.return_balance_fee3) return_balance_fee3,
     sum(a.return_num4) return_num4,
     sum(a.return_deposit_fee4) return_deposit_fee4,
     sum(a.bad_num4) bad_num4,
     sum(a.return_balance_fee4) return_balance_fee4,
     sum(a.return_num5) return_num5,
     sum(a.return_deposit_fee5) return_deposit_fee5,
     sum(a.bad_num5) bad_num5,
     sum(a.return_balance_fee5) return_balance_fee5,
     sum(a.return_num6) return_num6,
     sum(a.return_deposit_fee6) return_deposit_fee6,
     sum(a.bad_num6) bad_num6,
     sum(a.return_balance_fee6) return_balance_fee6,
     sum(a.return_num7) return_num7,
     sum(a.return_deposit_fee7) return_deposit_fee7,
     sum(a.bad_num7) bad_num7,
     sum(a.return_balance_fee7) return_balance_fee7,
     sum(a.return_num8) return_num8,
     sum(a.return_deposit_fee8) return_deposit_fee8,
     sum(a.bad_num8) bad_num8,
     sum(a.return_balance_fee8) return_balance_fee8,
     sum(a.total_return_num) total_return_num1,
     sum(a.total_return_deposit_fee) total_return_deposit_fee,
     sum(a.total_bad_num) total_bad_num,
     sum(a.total_return_balance_fee) total_return_balance_fee
from t#op_inc_sys_return a
group by a.name,a.type_name
order by sequence,a.name,a.type_name;
end ;
/
grant execute on ACC_ST.UP_OP_INC_RETURN_LINE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RETURN_LINE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RETURN_LINE_M
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RETURN_LINE_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_009
--π¶ƒ‹√Ë ˆ£∫ÕÀøÓÕ≥º∆‘¬±®-∞¥œﬂ¬∑/’æµ„Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
--ÕÀøÓÕ≥º∆Õ®”√¡Ÿ ±±Ì£∫t#op_inc_sys_return_rpt,t#op_inc_sys_return
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”≈–∂œ£∫op_prm_line±Ì¿Ô”– ˝æ›≤≈∂‘v_line_name∏≥÷µ£¨»∑±£line_id¥ÌŒÛ“≤≤ªª·≤˙…˙¥ÌŒÛ±®±Ì
--–ﬁ∏ƒ ±º‰£∫20140221

--–ﬁ∏ƒƒ⁄»›: ‘ˆº” v_line_id=b.line_id
--–ﬁ∏ƒ ±º‰£∫20160607 mqf
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫zzq
--∏¸∏ƒ»’∆⁄£∫20160630
--∏¸∏ƒƒ⁄»›£∫–ﬁ’˝¿œ»À”≈ª›¥¢÷µ∆± ¿œ»À√‚∑—¥¢÷µ∆±µƒcard_sub_code£¨
--¿œ»À”≈ª›¥¢÷µ∆±∂‘”¶card_sub_code='02'°£
-- ¿œ»À√‚∑—¥¢÷µ∆±∂‘”¶card_sub_code='03'
---------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170723
--–ﬁ∏ƒ’ﬂ£∫yangze
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
-------------------------------------------------------------------------------
AS
 v_squad_date           char(6);
 v_balance_date         char(6);
 v_line_id              char(2);
 v_line_name            varchar(20);
 v_num int;
    BEGIN
    v_squad_date:=substr(in_squad_day,1,6);
    v_balance_date:=substr(in_balance_day,1,6);
    v_line_id:=in_line_id;

   select count(line_name) into v_num from op_prm_line WHERE line_id = v_line_id and record_flag='0';
   --–ﬁ∏ƒ£∫‘ˆº”≈–∂œop_prm_line”– ˝æ›‘Ú∏≥÷µ
   IF  v_num=1 THEN
      SELECT line_name
      INTO v_line_name
      FROM op_prm_line
      WHERE line_id = v_line_id and record_flag='0';
   END IF;
   ----ππΩ®Ω·π˚ºØ
   insert into t#op_inc_sys_return
    select a.station_id,'',b.return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_station a,st_cod_return_type b
     where a.record_flag='0' and a.line_id=v_line_id;
    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,
       return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 and line_id=v_line_id
 and card_main_id in('01','02','03','07','08','09');
--µ•≥Ã∆±
 insert into t#op_inc_sys_return
 (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    return_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='01' and card_sub_code='00';
--∆’Õ®≥…»À¥¢÷µ∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='00';
--—ß…˙∆’Õ®¥¢÷µ∆±
      insert into t#op_inc_sys_return
      (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='01';
--¿œ»À√‚∑—¥¢÷µ∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='03';
--¿œ»À”≈ª›¥¢÷µ
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='02';
--∆’Õ®≥À¥Œ
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='03' and card_sub_code='00';
--∆’Õ®“Ï–Œ¥¢÷µø®
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='07' and card_sub_code='00';
--∆’Õ® ÷ª˙∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='08' and card_sub_code='00';
--¥≈∏°Õ®«⁄ø®
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='09' and card_sub_code='01';
--Œ≤¡––°º∆
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select station_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_num),sum(return_deposit_fee),sum(bad_num),sum(return_balance_fee)
    from t#op_inc_sys_return_rpt
    group by station_id,return_type;
     ----∏¸–¬’æµ„√˚
     update t#op_inc_sys_return a set a.name=(

         select b.sequence||b.Chinese_name from op_prm_station b
         where b.record_flag='0' and b.station_id=a.id and v_line_id=b.line_id) --20160607 mqf ‘ˆº” v_line_id=b.line_id
     where exists (select 1 from op_prm_station b
     where v_line_id=b.line_id and a.id=b.station_id and b.record_flag='0');
    ----∏¸–¬ÕÀøÓ∑Ω Ω√˚
     update t#op_inc_sys_return a set a.type_name=(
         select b.return_name from st_cod_return_type b where a.type_id=b.return_type);
     open out_cursor for
select v_balance_date||v_squad_date mon,v_line_name as line_name,a.name as station_name,a.type_name,
     sum(a.return_num) return_num,
     sum(a.return_deposit_fee) return_deposit_fee,
     sum(a.return_num1) return_num1,
     sum(a.return_deposit_fee1) return_deposit_fee1,
     sum(a.bad_num1) bad_num1,
     sum(a.return_balance_fee1) return_balance_fee1,
     sum(a.return_num2) return_num2,
     sum(a.return_deposit_fee2) return_deposit_fee2,
     sum(a.bad_num2) bad_num2,
     sum(a.return_balance_fee2) return_balance_fee2,
     sum(a.return_num3) return_num3,
     sum(a.return_deposit_fee3) return_deposit_fee3,
     sum(a.bad_num3) bad_num3,
     sum(a.return_balance_fee3) return_balance_fee3,
     sum(a.return_num4) return_num4,
     sum(a.return_deposit_fee4) return_deposit_fee4,
     sum(a.bad_num4) bad_num4,
     sum(a.return_balance_fee4) return_balance_fee4,
     sum(a.return_num5) return_num5,
     sum(a.return_deposit_fee5) return_deposit_fee5,
     sum(a.bad_num5) bad_num5,
     sum(a.return_balance_fee5) return_balance_fee5,
     sum(a.return_num6) return_num6,
     sum(a.return_deposit_fee6) return_deposit_fee6,
     sum(a.bad_num6) bad_num6,
     sum(a.return_balance_fee6) return_balance_fee6,
     sum(a.return_num7) return_num7,
     sum(a.return_deposit_fee7) return_deposit_fee7,
     sum(a.bad_num7) bad_num7,
     sum(a.return_balance_fee7) return_balance_fee7,
     sum(a.return_num8) return_num8,
     sum(a.return_deposit_fee8) return_deposit_fee8,
     sum(a.bad_num8) bad_num8,
     sum(a.return_balance_fee8) return_balance_fee8,
     sum(a.total_return_num) total_return_num1,
     sum(a.total_return_deposit_fee) total_return_deposit_fee,
     sum(a.total_bad_num) total_bad_num,
     sum(a.total_return_balance_fee) total_return_balance_fee
from t#op_inc_sys_return a
group by a.name,a.type_name
order by a.name,a.type_name;
end ;
/
grant execute on ACC_ST.UP_OP_INC_RETURN_LINE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RETURN_LINE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RETURN_SYS_D
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RETURN_SYS_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_007
--π¶ƒ‹√Ë ˆ£∫ÕÀøÓÕ≥º∆»’±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
----------------------------------------------------------------
--20150230
--V1.3
--wangkejia
--‘ˆº” ÷ª˙ø®“Ï–Œø®
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20160630
--–ﬁ∏ƒ’ﬂ£∫÷‹—Ô
--–ﬁ∏ƒƒ⁄»›£∫Ω´¿œ»À√‚∑—¥¢÷µ∆±µƒ ˝æ›”Î¿œ»À”≈ª›¥¢÷µ∆± ˝æ›µ˜ªª
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170228
--–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒƒ⁄»›£∫Ω´œﬂ¬∑«∞√Êµƒ±‡∫≈”Îœﬂ¬∑√˚≥∆∑÷¿Î
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170723
--–ﬁ∏ƒ’ﬂ£∫—Ó‘Û
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°Õ®«⁄ø®0901¿‡–Õ
-------------------------------------------------------------------------------
AS
 v_squad_date           char(8);
 v_balance_date         char(8);
    BEGIN
    v_squad_date:=substr(in_squad_day,1,8);
    v_balance_date:=substr(in_balance_day,1,8);
    ----------ππΩ®
 insert into t#op_inc_sys_return
 select a.line_id,a.line_name,b.return_type,'',
 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_line a,st_cod_return_type b
    where a.record_flag='0'
    and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t)
    and b.return_type in('0','2');
    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,
       return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and substr(squad_day,1,8)=v_squad_date
 and card_main_id in('01','02','03','07','08','09');
--µ•≥Ã∆±
 insert into t#op_inc_sys_return
 (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    nvl(return_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='01' and card_sub_code='00';
--∆’Õ®≥…»À¥¢÷µ∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='00';
--—ß…˙∆’Õ®¥¢÷µ∆±
      insert into t#op_inc_sys_return
      (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='01';
--¿œ»À”≈ª›¥¢÷µ∆± 2016.06.30 modified by zhouyang
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='02';
--¿œ»À√‚∑—¥¢÷µ∆± 2016.06.30 modified by zhouyang
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='03';
--∆’Õ®≥À¥Œ
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='03' and card_sub_code='00';
--∆’Õ®“Ï–Œ¥¢÷µø®
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='07' and card_sub_code='00';
--∆’Õ® ÷ª˙∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='08' and card_sub_code='00';
--¥≈∏°Õ®«⁄ø®
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0),0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='09' and card_sub_code='01';
--Œ≤¡––°º∆
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nvl(return_num,0),nvl(return_deposit_fee,0),nvl(bad_num,0),nvl(return_balance_fee,0)
    from t#op_inc_sys_return_rpt;

     ----∏¸–¬œﬂ¬∑√˚
     update t#op_inc_sys_return a set a.name=(
         select b.sequence||b.line_name from op_prm_line b
         where b.record_flag='0' and b.line_id=a.id)
     where exists
     (select 1 from op_prm_line b where b.record_flag='0' and b.line_id=a.id);
    ----∏¸–¬ÕÀøÓ∑Ω Ω√˚
     update t#op_inc_sys_return a set a.type_name=(
         select b.return_name from st_cod_return_type b where a.type_id=b.return_type);
     open out_cursor for
--∑÷¿Îœﬂ¬∑±‡∫≈∫Õœﬂ¬∑√˚
select v_balance_date||v_squad_date day,
     substr(a.name,0,2) as sequence,
     substr(a.name,3)  station_name,
--¥À¥¶Œ™œﬂ¬∑√˚£¨Œ™∑Ω±„÷∆◊˜ÀÆæß±®±Ì
     a.type_name,
     sum(a.return_num) return_num,
     sum(a.return_deposit_fee) return_deposit_fee,
     sum(a.return_num1) return_num1,
     sum(a.return_deposit_fee1) return_deposit_fee1,
     sum(a.bad_num1) bad_num1,
     sum(a.return_balance_fee1) return_balance_fee1,
     sum(a.return_num2) return_num2,
     sum(a.return_deposit_fee2) return_deposit_fee2,
     sum(a.bad_num2) bad_num2,
     sum(a.return_balance_fee2) return_balance_fee2,
     sum(a.return_num3) return_num3,
     sum(a.return_deposit_fee3) return_deposit_fee3,
     sum(a.bad_num3) bad_num3,
     sum(a.return_balance_fee3) return_balance_fee3,
     sum(a.return_num4) return_num4,
     sum(a.return_deposit_fee4) return_deposit_fee4,
     sum(a.bad_num4) bad_num4,
     sum(a.return_balance_fee4) return_balance_fee4,
     sum(a.return_num5) return_num5,
     sum(a.return_deposit_fee5) return_deposit_fee5,
     sum(a.bad_num5) bad_num5,
     sum(a.return_balance_fee5) return_balance_fee5,
     sum(a.return_num6) return_num6,
     sum(a.return_deposit_fee6) return_deposit_fee6,
     sum(a.bad_num6) bad_num6,
     sum(a.return_balance_fee6) return_balance_fee6,
     sum(a.return_num7) return_num7,
     sum(a.return_deposit_fee7) return_deposit_fee7,
     sum(a.bad_num7) bad_num7,
     sum(a.return_balance_fee7) return_balance_fee7,
     sum(a.return_num8) return_num8,
     sum(a.return_deposit_fee8) return_deposit_fee8,
     sum(a.bad_num8) bad_num8,
     sum(a.return_balance_fee8) return_balance_fee8,
     sum(a.total_return_num) total_return_num1,
     sum(a.total_return_deposit_fee) total_return_deposit_fee,
     sum(a.total_bad_num) total_bad_num,
     sum(a.total_return_balance_fee) total_return_balance_fee
from t#op_inc_sys_return a
group by a.name,a.type_name
order by sequence,a.type_name;
end ;
/
grant execute on ACC_ST.UP_OP_INC_RETURN_SYS_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RETURN_SYS_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_RETURN_SYS_M
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_RETURN_SYS_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_008
--π¶ƒ‹√Ë ˆ£∫ÕÀøÓÕ≥º∆‘¬±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
----------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20160630
--–ﬁ∏ƒ’ﬂ£∫÷‹—Ô
--–ﬁ∏ƒƒ⁄»›£∫Ω´¿œ»À√‚∑—¥¢÷µ∆±µƒ ˝æ›”Î¿œ»À”≈ª›¥¢÷µ∆± ˝æ›µ˜ªª
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170228
--–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒƒ⁄»›£∫Ω´œﬂ¬∑«∞√Êµƒ±‡∫≈”Îœﬂ¬∑√˚≥∆∑÷¿Î
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170723
--–ﬁ∏ƒ’ﬂ£∫—Ó‘Û
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°Õ®«⁄ø®0901¿‡–Õ
-------------------------------------------------------------------------------
AS
 v_squad_date           char(6);
 v_balance_date         char(6);
    BEGIN
    v_squad_date:=substr(in_squad_day,1,6);
    v_balance_date:=substr(in_balance_day,1,6);
    ----------ππΩ®
 insert into t#op_inc_sys_return
 select a.line_id,a.line_name,b.return_type,'',
 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_line a,st_cod_return_type b
    where a.record_flag='0'
    and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t)
    and b.return_type in('0','2');
    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,
       return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 and card_main_id in('01','02','03','07','08','09');
--µ•≥Ã∆±
 insert into t#op_inc_sys_return
 (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    return_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='01' and card_sub_code='00';
--∆’Õ®≥…»À¥¢÷µ∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='00';
--—ß…˙∆’Õ®¥¢÷µ∆±
      insert into t#op_inc_sys_return
      (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='01';
--¿œ»À”≈ª›¥¢÷µ∆± 2016.06.30 modified by zhouyang
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='02';
--¿œ»À√‚∑—¥¢÷µ∆± 2016.06.30 modified by zhouyang
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='02' and card_sub_code='03';
--∆’Õ®≥À¥Œ
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='03' and card_sub_code='00';
--∆’Õ®“Ï–Œ¥¢÷µø®
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='07' and card_sub_code='00';
--∆’Õ® ÷ª˙∆±
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='08' and card_sub_code='00';
--¥≈∏°Õ®«⁄ø®
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee,0,0,0,0
    from t#op_inc_sys_return_rpt
     where card_main_code='09' and card_sub_code='01';
--Œ≤¡––°º∆
     insert into t#op_inc_sys_return
     (id,name,type_id,type_name,return_num,return_deposit_fee,return_num1,return_deposit_fee1,bad_num1,return_balance_fee1,
 return_num2,return_deposit_fee2,bad_num2,return_balance_fee2,return_num3,return_deposit_fee3,bad_num3,return_balance_fee3,
 return_num4,return_deposit_fee4,bad_num4,return_balance_fee4,return_num5,return_deposit_fee5,bad_num5,return_balance_fee5,
 return_num6,return_deposit_fee6,bad_num6,return_balance_fee6,return_num7,return_deposit_fee7,bad_num7,return_balance_fee7,
 return_num8,return_deposit_fee8,bad_num8,return_balance_fee8,total_return_num,total_return_deposit_fee,total_bad_num,total_return_balance_fee)
    select line_id,'',return_type,'',
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,return_num,return_deposit_fee,bad_num,return_balance_fee
    from t#op_inc_sys_return_rpt;
     ----∏¸–¬œﬂ¬∑√˚
     update t#op_inc_sys_return a set a.name=(
         select b.sequence||b.line_name from op_prm_line b
         where b.record_flag='0' and b.line_id=a.id)
      where EXISTS (select 1 from op_prm_line b
         where b.record_flag='0' and b.line_id=a.id);
    ----∏¸–¬ÕÀøÓ∑Ω Ω√˚
     update t#op_inc_sys_return a set a.type_name=(
         select b.return_name from st_cod_return_type b where a.type_id=b.return_type);
     open out_cursor for
     --∑÷¿Îœﬂ¬∑±‡∫≈∫Õœﬂ¬∑√˚
select v_balance_date||v_squad_date mon,
     substr(a.name,1,2) as sequence,
     substr(a.name,3) as station_name,
--¥À¥¶Œ™œﬂ¬∑√˚£¨Œ™∑Ω±„÷∆◊˜ÀÆæß±®±Ì
     a.type_name,
     sum(a.return_num) return_num,
     sum(a.return_deposit_fee) return_deposit_fee,
     sum(a.return_num1) return_num1,
     sum(a.return_deposit_fee1) return_deposit_fee1,
     sum(a.bad_num1) bad_num1,
     sum(a.return_balance_fee1) return_balance_fee1,
     sum(a.return_num2) return_num2,
     sum(a.return_deposit_fee2) return_deposit_fee2,
     sum(a.bad_num2) bad_num2,
     sum(a.return_balance_fee2) return_balance_fee2,
     sum(a.return_num3) return_num3,
     sum(a.return_deposit_fee3) return_deposit_fee3,
     sum(a.bad_num3) bad_num3,
     sum(a.return_balance_fee3) return_balance_fee3,
     sum(a.return_num4) return_num4,
     sum(a.return_deposit_fee4) return_deposit_fee4,
     sum(a.bad_num4) bad_num4,
     sum(a.return_balance_fee4) return_balance_fee4,
     sum(a.return_num5) return_num5,
     sum(a.return_deposit_fee5) return_deposit_fee5,
     sum(a.bad_num5) bad_num5,
     sum(a.return_balance_fee5) return_balance_fee5,
     sum(a.return_num6) return_num6,
     sum(a.return_deposit_fee6) return_deposit_fee6,
     sum(a.bad_num6) bad_num6,
     sum(a.return_balance_fee6) return_balance_fee6,
     sum(a.return_num7) return_num7,
     sum(a.return_deposit_fee7) return_deposit_fee7,
     sum(a.bad_num7) bad_num7,
     sum(a.return_balance_fee7) return_balance_fee7,
     sum(a.return_num8) return_num8,
     sum(a.return_deposit_fee8) return_deposit_fee8,
     sum(a.bad_num8) bad_num8,
     sum(a.return_balance_fee8) return_balance_fee8,
     sum(a.total_return_num) total_return_num1,
     sum(a.total_return_deposit_fee) total_return_deposit_fee,
     sum(a.total_bad_num) total_bad_num,
     sum(a.total_return_balance_fee) total_return_balance_fee
from t#op_inc_sys_return a
group by a.name,a.type_name
order by sequence,a.type_name;
end ;
/
grant execute on ACC_ST.UP_OP_INC_RETURN_SYS_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_RETURN_SYS_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SALE_LINE_DAY
prompt ==========================================
prompt
create or replace procedure acc_st.UP_OP_INC_SALE_LINE_DAY(
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SALE_LINE_DAY
--∂‘”¶ƒ£∞Â£rrpt_02_004
--π¶ƒ‹√Ë ˆ:≥µ∆±∑¢ €Õ≥º∆»’±®-∞¥œﬂ¬∑/’æµ„Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”≈–∂œ£∫op_prm_line±Ì¿Ô”– ˝æ›≤≈∂‘v_line_name∏≥÷µ£¨»∑±£line_id¥ÌŒÛ“≤≤ªª·≤˙…˙¥ÌŒÛ±®±Ì
--–ﬁ∏ƒ ±º‰£∫20140221
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140812
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫µ•≥Ã∆±Ω∂Ó◊÷∂Œ∏ƒŒ™charge_fee
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20150130
--–ﬁ∏ƒ»À£∫Õıø…º—
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#OP_INC_LINE_SALE
--µ˜’˚ƒ£∞Â£∫rpt_02_004
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170216
--–ﬁ∏ƒ»À£∫÷‹—Ô
--–ﬁ∏ƒƒ⁄»›£∫»•µÙ°∞∏¸–¬’æµ„°±÷–µƒ’æµ„¥˙¬Î
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒ»À£∫¡ıµ¬‘ˆ
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°¥¢÷µ∆±∆±÷÷
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_squad_date           char(8);       -- ‘À”™»’
   v_balance_date         char(8);       --«ÂÀ„»’
   v_line_id              char(2);
   v_line_name            varchar(20);
   v_num int ;
    BEGIN
     v_balance_date:=substr(in_balance_day,1,8);
     v_squad_date:=substr(in_squad_day,1,8);
     v_line_id:=in_line_id;
   select count(line_name) into v_num from op_prm_line WHERE line_id = v_line_id and record_flag='0';
   --–ﬁ∏ƒ£∫‘ˆº”≈–∂œop_prm_line”–«“Ωˆ”–“ªÃı ˝æ›‘Ú∏≥÷µ
   IF  v_num=1 THEN
      SELECT line_name
      INTO v_line_name
      FROM op_prm_line
      WHERE line_id = v_line_id and record_flag='0';
   END IF;
 -----≤È—Øœ‡πÿ ˝æ›
 insert into t#OP_INC_LINE_SALE_rpt
 (line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,charge_fee)
 select line_id,station_id,dev_type_id,
        case when pay_type='05' then '00' else pay_type end as pay_type,
        card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,
        sum(sale_num),sum(deposit_fee),sum(charge_fee)
                from st_sts_inc_sale
                where balance_water_no>= v_balance_date||'00' and balance_water_no<=v_balance_date||'99'
                and squad_day=v_squad_date
                and line_id=v_line_id
                and dev_type_id in ('03','02')
                group by line_id,station_id,dev_type_id,pay_type,card_main_id,card_sub_id;
 /* ----ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#OP_INC_LINE_SALE
    select a.line_id,a.line_name,b.dev_type_id,b.dev_type_name,c.payment_id,c.payment_name,
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_line a,op_prm_dev_type b,st_cod_payment c
    where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in ('02','03') and c.payment_id in ('01','02','03');
*/
  -----≤Â»Î ˝æ›
INSERT INTO t#OP_INC_LINE_SALE(station_id,station_name,dev_type,dev_name,payment_id,payment_name,sale_num1,charge_fee1)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='01' and card_sub_id='00'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num2,deposit_fee2,charge_fee2)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='02' and card_sub_id='00'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num3,deposit_fee3,charge_fee3)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='02' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num4,deposit_fee4,charge_fee4)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='02' and card_sub_id='02'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num5,deposit_fee5,charge_fee5)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='02' and card_sub_id='03'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num6,deposit_fee6,charge_fee6)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='03' and card_sub_id='00'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num7,deposit_fee7,charge_fee7)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='04' and card_sub_id='00'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num8,deposit_fee8,charge_fee8)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='04' and card_sub_id='01'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num9,deposit_fee9,charge_fee9)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='06'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num10,deposit_fee10,charge_fee10)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='07'
          group by station_id,dev_type_id,pay_type;
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num11,deposit_fee11,charge_fee11)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='08'
          group by station_id,dev_type_id,pay_type;
          --20170724
INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num12,deposit_fee12,charge_fee12)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt where card_main_id='09' and card_sub_id='01'
          group by station_id,dev_type_id,pay_type;

INSERT INTO t#OP_INC_LINE_SALE(station_id,line_name,dev_type,dev_name,payment_id,payment_name,total_sale_num,total_deposit_fee,total_charge_fee)
   select station_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_INC_LINE_SALE_rpt
          group by station_id,dev_type_id,pay_type;
    --∏¸–¬’æµ„
         update t#OP_INC_LINE_SALE a
         set a.station_name=
             (select b.sequence||b.chinese_name from op_prm_station b
             where a.station_id=b.station_id and b.line_id=v_line_id and b.record_flag='0')
         where EXISTS (select 1 from op_prm_station b
             where a.station_id=b.station_id and b.line_id=v_line_id and b.record_flag='0');
             --∏¸–¬…Ë±∏√˚
         update t#OP_INC_LINE_SALE a set a.dev_name=
           (select dev_type_name from op_prm_dev_type b
             where a.dev_type=b.dev_type_id and b.record_flag='0')
         where EXISTS (select 1 from op_prm_dev_type b where a.dev_type=b.dev_type_id and b.record_flag='0');
             --∏¸–¬÷ß∏∂∑Ω Ω√˚
         update t#OP_INC_LINE_SALE a
           set a.payment_name=
             (select b.payment_name from st_cod_payment b where a.payment_id=b.payment_id)
         where EXISTS (select 1 from st_cod_payment b where a.payment_id=b.payment_id);

open out_cursor for
     select v_squad_date||v_balance_date DAY,v_line_name as line_name,substr(station_name,3) as station_name,
       substr(station_name,0,2) as sequence,dev_name,payment_name,
      sum(nvl(sale_num1,0)) sale_num1,
      sum(nvl(charge_fee1,0)) charge_fee1,
      sum(nvl(sale_num2,0)) sale_num2,
      sum(nvl(deposit_fee2,0)) deposit_fee2,
      sum(nvl(charge_fee2,0)) charge_fee2,
      sum(nvl(sale_num3,0)) sale_num3,
      sum(nvl(deposit_fee3,0)) deposit_fee3,
      sum(nvl(charge_fee3,0)) charge_fee3,
      sum(nvl(sale_num4,0)) sale_num4,
      sum(nvl(deposit_fee4,0)) deposit_fee4,
      sum(nvl(charge_fee4,0)) charge_fee4,
      sum(nvl(sale_num5,0)) sale_num5,
      sum(nvl(deposit_fee5,0)) deposit_fee5,
      sum(nvl(charge_fee5,0)) charge_fee5,
      sum(nvl(sale_num6,0)) sale_num6,
      sum(nvl(deposit_fee6,0)) deposit_fee6,
      sum(nvl(charge_fee6,0)) charge_fee6,
      sum(nvl(sale_num7,0))  sale_num7,
      sum(nvl(deposit_fee7,0)) deposit_fee7,
      sum(nvl(charge_fee7,0)) charge_fee7,
      sum(nvl(sale_num8,0)) sale_num8,
      sum(nvl(deposit_fee8,0)) deposit_fee8,
      sum(nvl(charge_fee8,0)) charge_fee8,
      sum(nvl(sale_num9,0)) sale_num9,
      sum(nvl(deposit_fee9,0)) deposit_fee9,
      sum(nvl(charge_fee9,0)) charge_fee9 ,

      sum(nvl(sale_num10,0)) sale_num10,
      sum(nvl(deposit_fee10,0)) deposit_fee10,
      sum(nvl(charge_fee10,0)) charge_fee10 ,

      sum(nvl(sale_num11,0)) sale_num11,
      sum(nvl(deposit_fee11,0)) deposit_fee11,
      sum(nvl(charge_fee11,0)) charge_fee11 ,
--20170724
      sum(nvl(sale_num12,0)) sale_num12,
      sum(nvl(deposit_fee12,0)) deposit_fee12,
      sum(nvl(charge_fee12,0)) charge_fee12 ,

      sum(nvl(total_sale_num,0)) total_sale_num,
      sum(nvl(total_deposit_fee,0)) total_deposit_fee,
      sum(nvl(total_charge_fee,0)) total_charge_fee
from t#OP_INC_LINE_SALE
group by station_name,dev_name,payment_name
order by sequence,dev_name,payment_name;
END;
/
grant execute on ACC_ST.UP_OP_INC_SALE_LINE_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SALE_LINE_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SALE_SYS_DAY
prompt =========================================
prompt
create or replace procedure acc_st.UP_OP_INC_SALE_SYS_DAY(
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SYS_SALE_D
--∂‘”¶ƒ£∞Â£rrpt_02_001
--π¶ƒ‹√Ë ˆ:≥µ∆±∑¢ €Õ≥º∆»’±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140812
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫µ•≥Ã∆±Ω∂Ó◊÷∂Œ∏ƒŒ™charge_fee
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄:20150130
--–ﬁ∏ƒ»À£∫wangkejia
--–¬‘ˆ∆±ø®£∫∆’Õ®“Ï–Œ¥¢÷µø®°£ ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#OP_SYS_SALE
--µ˜’˚ƒ£∞Â£∫rpt_02_001
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170210
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170213
--–ﬁ∏ƒ»À£∫zhouyang
--–ﬁ∏ƒƒ⁄»›£∫TVM√ª”–°∞––’˛¥¶¿Ì°±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170220
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆœﬂ¬∑±®±Ì≤ªÕ≥º∆±Ìacc_st.OP_REPORT_LINE_NO_STAT£¨∆¡±Œ±Ì¿Ôœﬂ¬∑
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170607
--–ﬁ∏ƒ»À£∫liudezeng
--–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ∏∂∑—∑Ω Ωµƒ¥¢÷µø®∫Õ–≈”√ø®÷ß∏∂
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170722
--–ﬁ∏ƒ»À£∫taidibao
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±0901
--------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_squad_date           varchar(8);       -- ‘À”™»’
   v_balance_date         varchar(8);       --«ÂÀ„»’
    BEGIN
     v_balance_date:=substr(in_balance_day,1,8);
     v_squad_date:=substr(in_squad_day,1,8);
 -----≤È—Øœ‡πÿ ˝æ›
 insert into t#OP_SYS_SALE_rpt
 (line_id,dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,charge_fee)
 select line_id,dev_type_id,
        case when pay_type='05' then '00' else pay_type end,
        card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,
        sum(sale_num),sum(deposit_fee),sum(charge_fee)
                from st_sts_inc_sale
                where substr(balance_water_no,1,8)= v_balance_date  and squad_day=v_squad_date
                and dev_type_id in ('03','02')
                group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;

  ----ππΩ®Ω·π˚ºØΩ·ππ

insert into t#OP_SYS_SALE
    select a.line_id,a.line_name,b.dev_type_id,b.dev_type_name,c.payment_id,c.payment_name,
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_line a,op_prm_dev_type b,st_cod_payment c
    where a.record_flag='0'
    --and a.line_id!='82' --201702210 add by lucankun
    and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t) --20170220 modify by lucankun
    and b.record_flag='0' and b.dev_type_id in ('02','03')
      and c.payment_id in ('00','01');

  -----TVM≤ªΩ¯––"––’˛¥¶¿Ì"   20170213 add by zhouyang
  delete from t#OP_SYS_SALE where dev_type = '02' and payment_id = '00';

  -----≤Â»Î ˝æ›

INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num1,charge_fee1)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='01' and card_sub_id='00'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num2,deposit_fee2,charge_fee2)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='00'
                    group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num3,deposit_fee3,charge_fee3)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num4,deposit_fee4,charge_fee4)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='02'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num5,deposit_fee5,charge_fee5)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='03'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num6,deposit_fee6,charge_fee6)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='03' and card_sub_id='00'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num7,deposit_fee7,charge_fee7)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='04' and card_sub_id='00'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num8,deposit_fee8,charge_fee8)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='04' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num9,deposit_fee9,charge_fee9)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='06'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num10,deposit_fee10,charge_fee10)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='07'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num11,deposit_fee11,charge_fee11)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='08'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num12,deposit_fee12,charge_fee12)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='09' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
          --modify by tdb 20170722

INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,total_sale_num,total_deposit_fee,total_charge_fee)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt
          group by line_id,dev_type_id,pay_type;
    --∏¸–¬’æµ„
      update t#OP_SYS_SALE a
         set a.line_name=(
             select b.line_name from op_prm_line b
             where a.line_id=b.line_id and b.record_flag='0')
      where EXISTS (select 1 from op_prm_line b
             where a.line_id=b.line_id and b.record_flag='0');
             --∏¸–¬…Ë±∏√˚
      update t#OP_SYS_SALE a
         set a.dev_name=(
             select dev_type_name from op_prm_dev_type b
             where a.dev_type=b.dev_type_id and b.record_flag='0')
      where EXISTS (select 1 from op_prm_dev_type b
             where a.dev_type=b.dev_type_id and b.record_flag='0');
             --∏¸–¬÷ß∏∂∑Ω Ω√˚
      update t#OP_SYS_SALE a
         set a.payment_name=(
             select b.payment_name from st_cod_payment b
             where a.payment_id=b.payment_id)
      where EXISTS (select 1 from st_cod_payment b
             where a.payment_id=b.payment_id);

             open out_cursor for
select v_squad_date||v_balance_date DAY,line_id,line_name,dev_name,payment_name,
      sum(nvl(sale_num1,0)) sale_num1,
      sum(nvl(charge_fee1,0)) charge_fee1,
      sum(nvl(sale_num2,0)) sale_num2,
      sum(nvl(deposit_fee2,0)) deposit_fee2,
      sum(nvl(charge_fee2,0)) charge_fee2,
      sum(nvl(sale_num3,0)) sale_num3,
      sum(nvl(deposit_fee3,0)) deposit_fee3,
      sum(nvl(charge_fee3,0)) charge_fee3,
      sum(nvl(sale_num4,0)) sale_num4,
      sum(nvl(deposit_fee4,0)) deposit_fee4,
      sum(nvl(charge_fee4,0)) charge_fee4,
      sum(nvl(sale_num5,0)) sale_num5,
      sum(nvl(deposit_fee5,0)) deposit_fee5,
      sum(nvl(charge_fee5,0)) charge_fee5,
      sum(nvl(sale_num6,0)) sale_num6,
      sum(nvl(deposit_fee6,0)) deposit_fee6,
      sum(nvl(charge_fee6,0)) charge_fee6,
      sum(nvl(sale_num7,0))  sale_num7,
      sum(nvl(deposit_fee7,0)) deposit_fee7,
      sum(nvl(charge_fee7,0)) charge_fee7,
      sum(nvl(sale_num8,0)) sale_num8,
      sum(nvl(deposit_fee8,0)) deposit_fee8,
      sum(nvl(charge_fee8,0)) charge_fee8,
      sum(nvl(sale_num9,0)) sale_num9,
      sum(nvl(deposit_fee9,0)) deposit_fee9,
      sum(nvl(charge_fee9,0)) charge_fee9 ,
      sum(nvl(sale_num10,0)) sale_num10,
      sum(nvl(deposit_fee10,0)) deposit_fee10,
      sum(nvl(charge_fee10,0)) charge_fee10,
      sum(nvl(sale_num11,0)) sale_num11,
      sum(nvl(deposit_fee11,0)) deposit_fee11,
      sum(nvl(charge_fee11,0)) charge_fee11,
      sum(nvl(sale_num12,0)) sale_num12,
      sum(nvl(deposit_fee12,0)) deposit_fee12,
      sum(nvl(charge_fee12,0)) charge_fee12,
      --modify by tdb 20170722
      sum(nvl(total_sale_num,0)) total_sale_num,
      sum(nvl(total_deposit_fee,0)) total_deposit_fee,
      sum(nvl(total_charge_fee,0)) total_charge_fee
from t#OP_SYS_SALE
group by line_id,line_name,dev_name,payment_name
order by line_id,dev_name,payment_name;
END;
/
grant execute on ACC_ST.UP_OP_INC_SALE_SYS_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SALE_SYS_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SALE_SYS_MON
prompt =========================================
prompt
create or replace procedure acc_st.UP_OP_INC_SALE_SYS_MON(
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SALE_SYS_MON
--∂‘”¶ƒ£∞Â£rrpt_02_002
--π¶ƒ‹√Ë ˆ:≥µ∆±∑¢ €Õ≥º∆»’±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140812
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫µ•≥Ã∆±Ω∂Ó◊÷∂Œ∏ƒŒ™charge_fee
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄:20150130
--–ﬁ∏ƒ»À£∫wangkejia
--–¬‘ˆ∆±ø®£∫∆’Õ®“Ï–Œ¥¢÷µø®°£ ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#OP_SYS_SALE
--µ˜’˚ƒ£∞Â£∫rpt_02_001
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170210
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170213
--–ﬁ∏ƒ»À£∫zhouyang
--–ﬁ∏ƒƒ⁄»›£∫TVM√ª”–°∞––’˛¥¶¿Ì°±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170220
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆœﬂ¬∑±®±Ì≤ªÕ≥º∆±Ìacc_st.OP_REPORT_LINE_NO_STAT£¨∆¡±Œ±Ì¿Ôœﬂ¬∑
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170607
--–ﬁ∏ƒ»À£∫liudezeng
--–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ∏∂∑—∑Ω Ωµƒ¥¢÷µø®∫Õ–≈”√ø®÷ß∏∂
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170722
--–ﬁ∏ƒ»À£∫taidibao
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±0901
--------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_squad_date           char(6);       -- ‘À”™»’
   v_balance_date         char(6);       --«ÂÀ„»’
    BEGIN
     v_balance_date:=substr(in_balance_day,1,6);
     v_squad_date:=substr(in_squad_day,1,6);
 -----≤È—Øœ‡πÿ ˝æ›
 insert into t#OP_SYS_SALE_rpt
 (line_id,dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,charge_fee)
 select line_id,dev_type_id,
        case when pay_type='05' then '00' else pay_type end as pay_type,
        card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,
        sum(sale_num),sum(deposit_fee),sum(charge_fee)
                from st_sts_inc_sale
                where substr(balance_water_no,1,6)=v_balance_date and substr(squad_day,1,6)=v_squad_date
                and dev_type_id in ('03','02')
                group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;

  ----ππΩ®Ω·π˚ºØΩ·ππ

insert into t#OP_SYS_SALE
    select a.line_id,a.line_name,b.dev_type_id,b.dev_type_name,c.payment_id,c.payment_name,
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from op_prm_line a,op_prm_dev_type b,st_cod_payment c
    where a.record_flag='0'
    --and a.line_id!='82' --201702210 add by lucankun
    and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t) --20170220 modify by lucankun
    and b.record_flag='0' and b.dev_type_id in ('02','03')
      and c.payment_id in ('00','01');
  -----TVM≤ªΩ¯––"––’˛¥¶¿Ì"   20170213 add by zhouyang
  delete from t#OP_SYS_SALE where dev_type = '02' and payment_id = '00';

  -----≤Â»Î ˝æ›

INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num1,charge_fee1)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='01' and card_sub_id='00'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num2,deposit_fee2,charge_fee2)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='00'
                    group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num3,deposit_fee3,charge_fee3)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num4,deposit_fee4,charge_fee4)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='02'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num5,deposit_fee5,charge_fee5)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='02' and card_sub_id='03'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num6,deposit_fee6,charge_fee6)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='03' and card_sub_id='00'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num7,deposit_fee7,charge_fee7)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='04' and card_sub_id='00'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num8,deposit_fee8,charge_fee8)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='04' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num9,deposit_fee9,charge_fee9)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='06'
          group by line_id,dev_type_id,pay_type;
          --20150130
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num10,deposit_fee10,charge_fee10)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='07'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num11,deposit_fee11,charge_fee11)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='08'
          group by line_id,dev_type_id,pay_type;
INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,sale_num12,deposit_fee12,charge_fee12)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt where card_main_id='09' and card_sub_id='01'
          group by line_id,dev_type_id,pay_type;
          --modify by tdb 20170724

INSERT INTO t#OP_SYS_SALE(line_id,line_name,dev_type,dev_name,payment_id,payment_name,total_sale_num,total_deposit_fee,total_charge_fee)
   select line_id,'',dev_type_id,'',pay_type,'',sum(sale_num),sum(deposit_fee),sum(charge_fee)
          from t#OP_SYS_SALE_rpt
          group by line_id,dev_type_id,pay_type;
    --∏¸–¬’æµ„
      update t#OP_SYS_SALE a
         set a.line_name=(
             select b.line_name from op_prm_line b
             where a.line_id=b.line_id and b.record_flag='0')
      where EXISTS (select 1 from op_prm_line b
             where a.line_id=b.line_id and b.record_flag='0');
             --∏¸–¬…Ë±∏√˚
      update t#OP_SYS_SALE a
         set a.dev_name=(
             select dev_type_name from op_prm_dev_type b
             where a.dev_type=b.dev_type_id and b.record_flag='0')
      where EXISTS (select 1 from op_prm_dev_type b
             where a.dev_type=b.dev_type_id and b.record_flag='0');
             --∏¸–¬÷ß∏∂∑Ω Ω√˚
      update t#OP_SYS_SALE a
         set a.payment_name=(
             select b.payment_name from st_cod_payment b
             where a.payment_id=b.payment_id)
      where EXISTS (select 1 from st_cod_payment b
             where a.payment_id=b.payment_id);

             open out_cursor for
select v_squad_date||v_balance_date DAY,line_id,line_name,dev_name,payment_name,
      sum(nvl(sale_num1,0)) sale_num1,
      sum(nvl(charge_fee1,0)) charge_fee1,
      sum(nvl(sale_num2,0)) sale_num2,
      sum(nvl(deposit_fee2,0)) deposit_fee2,
      sum(nvl(charge_fee2,0)) charge_fee2,
      sum(nvl(sale_num3,0)) sale_num3,
      sum(nvl(deposit_fee3,0)) deposit_fee3,
      sum(nvl(charge_fee3,0)) charge_fee3,
      sum(nvl(sale_num4,0)) sale_num4,
      sum(nvl(deposit_fee4,0)) deposit_fee4,
      sum(nvl(charge_fee4,0)) charge_fee4,
      sum(nvl(sale_num5,0)) sale_num5,
      sum(nvl(deposit_fee5,0)) deposit_fee5,
      sum(nvl(charge_fee5,0)) charge_fee5,
      sum(nvl(sale_num6,0)) sale_num6,
      sum(nvl(deposit_fee6,0)) deposit_fee6,
      sum(nvl(charge_fee6,0)) charge_fee6,
      sum(nvl(sale_num7,0))  sale_num7,
      sum(nvl(deposit_fee7,0)) deposit_fee7,
      sum(nvl(charge_fee7,0)) charge_fee7,
      sum(nvl(sale_num8,0)) sale_num8,
      sum(nvl(deposit_fee8,0)) deposit_fee8,
      sum(nvl(charge_fee8,0)) charge_fee8,
      sum(nvl(sale_num9,0)) sale_num9,
      sum(nvl(deposit_fee9,0)) deposit_fee9,
      sum(nvl(charge_fee9,0)) charge_fee9 ,
      sum(nvl(sale_num10,0)) sale_num10,
      sum(nvl(deposit_fee10,0)) deposit_fee10,
      sum(nvl(charge_fee10,0)) charge_fee10 ,
      sum(nvl(sale_num11,0)) sale_num11,
      sum(nvl(deposit_fee11,0)) deposit_fee11,
      sum(nvl(charge_fee11,0)) charge_fee11 ,
      sum(nvl(sale_num12,0)) sale_num12,
      sum(nvl(deposit_fee12,0)) deposit_fee12,
      sum(nvl(charge_fee12,0)) charge_fee12 ,
      --modify by tdb 20170724
      sum(nvl(total_sale_num,0)) total_sale_num,
      sum(nvl(total_deposit_fee,0)) total_deposit_fee,
      sum(nvl(total_charge_fee,0)) total_charge_fee
from t#OP_SYS_SALE
group by line_id,line_name,dev_name,payment_name
order by line_id,dev_name,payment_name;
END;
/
grant execute on ACC_ST.UP_OP_INC_SALE_SYS_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SALE_SYS_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SALE_SYS_YEAR
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SALE_SYS_YEAR (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SALE_SYS_YEAR
--ƒ£∞Â√˚£∫rpt_02_003
--π¶ƒ‹√Ë ˆ£∫œﬂÕ¯≥µ∆±œ˙ €Õ≥º∆ƒÍ±®£®∫¨∑¢ €°¢∏¸–¬°¢ÕÀøÓ£©
--¥¥Ω®’ﬂ£∫ wangkejia
--¥¥Ω®»’∆⁄£∫20130909
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150130
--‘ˆº”–¬∆±÷÷£∫∆’Õ®“Ï–Œ¥¢÷µø®£¨ ÷ª˙∆±
--–ﬁ∏ƒ¡Ÿ ±±ÌΩ·ππ£∫t#op_inc_sales_year
--µ˜’˚ƒ£∞Â£∫rpt_02_003
-------------------------------------------------------------------------------
-- –ﬁ∏ƒ»’∆⁄£∫20170210
-- –ﬁ∏ƒ’ﬂ£∫lucankun
-- –ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
-------------------------------------------------------------------------------
-- –ﬁ∏ƒ’ﬂ£∫zhouyang
-- –ﬁ∏ƒ»’∆⁄£∫20170216
-- –ﬁ∏ƒƒ⁄»›£∫»•µÙœﬂ¬∑¥˙¬Î
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170220
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆœﬂ¬∑±®±Ì≤ªÕ≥º∆±Ìacc_st.OP_REPORT_LINE_NO_STAT£¨∆¡±Œ±Ì¿Ôœﬂ¬∑
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170307
--–ﬁ∏ƒ»À£∫zhouyang
--–ﬁ∏ƒƒ⁄»›£∫‘⁄Œ≤º∆÷–‘ˆº”Õ≥º∆°∞∆’Õ®“Ï–Œ¥¢÷µø®°±”Î°∞∆’Õ® ÷ª˙∆±°±µƒ÷µ
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170824
--–ﬁ∏ƒ»À£∫liudezeng
--–ﬁ∏ƒƒ⁄»›£∫–ﬁ∏ƒ∑÷±Ì»°÷µÃıº˛
--------------------------------------------------------------------------------
AS
        v_squad_day char(4);
        v_balance_day char(4);
        v_year_begin varchar(8);
        v_year_end varchar(8);
        v_balance_year_b varchar(8);
        v_balance_year_e varchar(8);
        v_count int;
        v_table_name varchar(50);
        v_sql varchar(1000);
    BEGIN
    v_squad_day:=substr(in_squad_day,1,4);
    v_balance_day:=substr(in_balance_day,1,4);
    v_year_begin:=v_squad_day||'0101';
    v_year_end:=v_squad_day||'1231';
    v_balance_year_b:=v_balance_day||'0101';
    v_balance_year_e:=v_balance_day||'1231';

   --≤È—Ø ˝æ›
        insert into t#op_inc_sales_year_rpt
              (line_id,tr_type_id,card_main_id,card_sub_id,deal_num,deal_fee,return_balance,penalty_fee)
        select line_id,tr_type_id,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,deal_num,deal_fee,return_balance,penalty_fee
        from st_sts_inc_station
        where balance_water_no>=v_balance_day||'010100'
        and balance_water_no<=v_balance_day||'123199'
        and substr(squad_day,1,4)=v_squad_day
        and tr_type_id in('50','51','56','57');


        -----¿˙ ∑±Ìµº»Î ˝æ›
---------------¥”À˜“˝±Ì»°∑÷±Ì ˝æ›£®¥”∑÷±Ì»° ˝æ›£©

select count(*) into v_count from st_idx_rpt_history a
  where a.origin_table_name='acc_st.st_sts_inc_station'
      -- and a.min_squad_day>=v_year_begin and nvl(a.max_squad_day,v_year_end)<=v_year_end;
      --modify by ldz 20170824
      and a.min_squad_day <= v_year_end
      and a.max_squad_day >=v_year_begin;
----À˜“˝±Ì”–µ±«∞÷–º‰±Ìµƒ∑÷±Ì£¨æÕ¥”∑÷±Ì»° ˝æ›
if v_count>0 then

declare
      cursor v_cursor is
  select a.table_name from st_idx_rpt_history a
       where a.origin_table_name='acc_st.st_sts_inc_station'
       --and a.min_squad_day>=v_year_begin and nvl(a.max_squad_day,v_year_end)<=v_year_end;
       --modify by ldz 20170824
      and a.min_squad_day <= v_year_end
      and a.max_squad_day >=v_year_begin;

 begin
   open v_cursor;
   fetch v_cursor into v_table_name;
     v_sql:='insert into t#op_inc_sales_year_rpt
           (line_id,tr_type_id,card_main_id,card_sub_id,deal_num,deal_fee,return_balance,penalty_fee)
           select line_id,tr_type_id,card_main_id,
           case when card_main_id=''''||06||'''' then ''''||00||'''' else card_sub_id end as card_sub_id,
           deal_num,deal_fee,return_balance,penalty_fee
           from ';

    v_sql:=v_sql||v_table_name||' ';

    v_sql:=v_sql||' where '||' (squad_day>='||v_year_begin||' and squad_day<='||v_year_end||')'
           ||' and substr(balance_water_no,1,4)='||v_balance_day
           ||' and tr_type_id in('||''''||50||''''||','||''''||51||''''||','||''''||56||''''||','||''''||57||''''||')';

    Execute Immediate v_sql;
   close v_cursor;
 end;

end if;
 ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_inc_sales_year
    select a.line_id,a.line_name,'51','∑¢ €',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
     -- and a.line_id!='82';-- 20170210 add by lucankun
     and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
insert into t#op_inc_sales_year
    select a.line_id,a.line_name,'56','∏¸–¬',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
     -- and a.line_id!='82';-- 20170210 add by lucankun
      and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
insert into t#op_inc_sales_year
    select a.line_id,a.line_name,'57','ÕÀøÓ',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
      --and a.line_id!='82';-- 20170210 add by lucankun
       and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun

     --≤Â»ÎΩ·π˚ºØ
     ----µ•≥Ã∆±
insert into t#op_inc_sales_year
    select line_id,'',case when tr_type_id='50' then '51' else tr_type_id end,'',sum(deal_num),
          case
             when tr_type_id='50' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='01' and card_sub_id='00' and tr_type_id in ('50','56','57')
    group by line_id,tr_type_id;

    ---≥…»À¥¢÷µ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='02' and card_sub_id='00' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
----—ß…˙¥¢÷µ∆±

        insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='02' and card_sub_id='01' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;

 --¿œ»À√‚∑—¥¢÷µ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='02' and card_sub_id='02' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
 --¿œ»À”≈ª›¥¢÷µ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='02' and card_sub_id='03' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
   --∆’Õ®≥À¥Œ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='03' and card_sub_id='00' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
  --∆’Õ®ºÕƒÓ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='04' and card_sub_id='00' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
   --”≈ª›ºÕƒÓ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='04' and card_sub_id='01' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
   --≥« –Õ®∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='06' and card_sub_id='00' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;

   --20150130
   --∆’Õ®“Ï–Œ¥¢÷µ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='07' and card_sub_id='00' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
   --∆’Õ® ÷ª˙∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='08' and card_sub_id='00' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;

--¥≈∏°¥¢÷µ∆±
insert into t#op_inc_sales_year
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),
          case
             when tr_type_id='51' then sum(deal_fee)
             when tr_type_id='56' then sum(penalty_fee)
             when tr_type_id='57' then sum(deal_fee+return_balance)
          end as deal_fee
          ,0,0
    from t#op_inc_sales_year_rpt
        where card_main_id='09' and card_sub_id='01' and tr_type_id in ('51','56','57')
    group by line_id,tr_type_id;
   --Œ≤¡––°º∆

update t#op_inc_sales_year set total_sale_num=
    sale_num0+sale_num1+sale_num2+sale_num3+sale_num4+sale_num5+sale_num6+sale_num7+sale_num8
    +sale_num9+sale_num10;--20170307 add by zhouyang
update t#op_inc_sales_year set total_sale_fee=
    sale_fee0+sale_fee1+sale_fee2+sale_fee3+sale_fee4+sale_fee5+sale_fee6+sale_fee7+sale_fee8
    +sale_fee9+sale_fee10;--20170307 add by zhouyang


 ----Ω´ÕÀøÓΩ∂Ó÷√∏∫∑Ω±„«Û∫Õ(ÀÆæß±®±Ìƒ£∞Âœ‘ æ’˝ ˝)
   update t#op_inc_sales_year a
     set sale_fee0=sale_fee0*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee1=sale_fee1*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee2=sale_fee2*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee3=sale_fee3*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee4=sale_fee4*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee5=sale_fee5*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee6=sale_fee6*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee7=sale_fee7*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee8=sale_fee8*(-1) where sale_type='57';
--20150130
     update t#op_inc_sales_year a
     set sale_fee9=sale_fee9*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set sale_fee10=sale_fee10*(-1) where sale_type='57';
     --20170724
     update t#op_inc_sales_year a
     set sale_fee11=sale_fee11*(-1) where sale_type='57';
     update t#op_inc_sales_year a
     set total_sale_fee=total_sale_fee*(-1) where sale_type='57';

    --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_sales_year a
      set line_name=
         (select b.sequence||b.line_name from op_prm_line b
          where a.line_id=b.line_id and b.record_flag='0')
    where EXISTS (select 1 from op_prm_line b
          where a.line_id=b.line_id and b.record_flag='0');

    --∏¸–¬œ˙ €∑Ω Ω
    update t#op_inc_sales_year a
    set sale_name='∑¢ €'
    where sale_type='51';
    update t#op_inc_sales_year a
    set sale_name='∏¸–¬'
    where sale_type='56';
    update t#op_inc_sales_year a
    set sale_name='ÕÀøÓ'
    where sale_type='57';
    open out_cursor for
    select v_balance_day||v_squad_day year,substr(line_name,0,2) as sequence,substr(line_name,3) as line_name,sale_name,
    sum(a.sale_num0) sale_num0,
    sum(a.sale_fee0) sale_fee0,
    sum(a.sale_num1) sale_num1,
    sum(a.sale_fee1) sale_fee1,
    sum(a.sale_num2) sale_num2,
    sum(a.sale_fee2) sale_fee2,
    sum(a.sale_num3) sale_num3,
    sum(a.sale_fee3) sale_fee3,
    sum(a.sale_num4) sale_num4,
    sum(a.sale_fee4) sale_fee4,
    sum(a.sale_num5) sale_num5,
    sum(a.sale_fee5) sale_fee5,
    sum(a.sale_num6) sale_num6,
    sum(a.sale_fee6) sale_fee6,
    sum(a.sale_num7) sale_num7,
    sum(a.sale_fee7) sale_fee7,
    sum(a.sale_num8) sale_num8,
    sum(a.sale_fee8) sale_fee8,
    sum(a.sale_num9) sale_num9,
    sum(a.sale_fee9) sale_fee9,
    sum(a.sale_num10) sale_num10,
    sum(a.sale_fee10) sale_fee10,
    sum(a.sale_num11) sale_num11,
    sum(a.sale_fee11) sale_fee11,
    sum(a.total_sale_num) total_sale_num,
    sum(a.total_sale_fee) total_sale_fee
    from t#op_inc_sales_year a
    group by line_name,sale_name
    order by sequence,line_name,sale_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_SALE_SYS_YEAR to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SALE_SYS_YEAR to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_STA_BOM_D
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_STA_BOM_D (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_STA_BOM_D
--π¶ƒ‹√Ë ˆ£∫œ˙ € ’“Ê¿‡±®±Ì ≥µ’æBOM ’“Êª„◊‹»’±®
--¥¥Ω®’ﬂ£∫  WNANGKEJIA
--¥¥Ω®»’∆⁄£∫20130906
--±®±Ìƒ£∞Â£∫02-015
--¡Ÿ ±±Ì£∫t#OP_INC_STA_BOM_rpt£¨t#OP_INC_STA_BOM_result
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140812
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫–ﬁ∏ƒ”¶ ’Ω∂ÓÕ≥º∆
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20150320
--∞Ê±æ£∫V1.3
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”“Ï–Œø®
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20150330
--∞Ê±æ£∫V1.31
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ÷ª˙∆±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20160630
--–ﬁ∏ƒ’ﬂ£∫÷‹—Ô
--–ﬁ∏ƒƒ⁄»›£∫Ω´¿œ»À√‚∑—¥¢÷µ∆±µƒ ˝æ›”Î¿œ»À”≈ª›¥¢÷µ∆± ˝æ›µ˜ªª
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170126
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒƒ⁄»›£∫»•≥˝∑µªÿΩ·π˚÷–≥µ’æµƒ≈≈¡––Ú∫≈
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°¥¢÷µ∆±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170801
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫√‚∑—∆±º§ªÓ¥Œ ˝–ﬁ∏ƒŒ™Õ≥º∆¿œ»À√‚∑—∆±º§ªÓ¥Œ ˝
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
        v_line_id char(2);
        v_line_name char(20);
        v_squad_day char(8);
        v_balance_day char(8);
    BEGIN
        v_line_id:=in_line_id;
        v_squad_day:=substr(in_squad_day,1,8);
        v_balance_day:=substr(in_balance_day,1,8);
   if v_line_id!=' ' and v_line_id is not null then
         select line_name into v_line_name from op_prm_line
         where line_id=v_line_id and record_flag='0';
   end if;
--≤È—Ø ˝æ›
   insert into  t#OP_INC_STA_BOM_rpt
   (squad_day,line_id,station_id,tr_type_id,do_type,pay_mode_id,pay_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee)
               select squad_day,line_id,station_id,tr_type_id,do_type,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
               where  balance_water_no>=v_balance_day||'00'
               and balance_water_no<=v_balance_day||'99'
               and squad_day = v_squad_day
               and line_id=v_line_id;
------------------------------------∑¢ €
--µ•≥Ã∆± ∆’Õ®µ•≥Ã∆±
  insert into  t#OP_INC_STA_BOM_result
      select
        '','',station_id,'',
        sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='01' and card_sub_code='00'
    and dev_type_id='03' and tr_type_id='50'
    --and pay_mode_id='01'
    group by  station_id;
-----------------------------------------
--≥…»À∆’Õ®¥¢÷µ∆±∑¢ €
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and  card_sub_code='00'
    and dev_type_id='03' and tr_type_id='51'
    group by  station_id;
---------------------------------------------------------------------------------------
--—ß…˙∆’Õ®¥¢÷µ∆±∑¢ €
 insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
         0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and  card_sub_code='01'
    and dev_type_id='03' and tr_type_id='51'
    group by   station_id;
-----------------------------------------
--¿œ»À”≈ª›¥¢÷µ 2016.06.30 modified by zhouyang
 insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,0,0,0,
     sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and card_sub_code='02' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;
---------------------------------------------------------------------------------------
--¿œ»À√‚∑—¥¢∆±∑¢ € 2016.06.30 modified by zhouyang
  insert into  t#OP_INC_STA_BOM_result
  select
        '','',station_id,'',
         0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and card_sub_code='03' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;
---------------------------------------------------------------------------------------
--∆’Õ®≥À¥Œ∆± --
  insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,
     0,0,0,0,0,
     sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='03' and card_sub_code='00' and
          dev_type_id='03' and tr_type_id='51'
    group by station_id;
---------------------------------------------------------------------------------------
/*--∆’Õ®ºÕƒÓ∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='04' and card_sub_code='00' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;*/
    --V1.31 ÷ª˙∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='08' and card_sub_code='00' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;
/*--”≈ª›ºÕƒÓ∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='04' and card_sub_code='01' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;*/
    --V1.3“Ï–Œø®
  insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='07' and card_sub_code='00' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;
      --¥≈∏°∆±
  insert into  t#OP_INC_STA_BOM_result
   select
        '','',station_id,'',
     0,0,0,0,0,
     0,0,0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='09' and card_sub_code='01' and
          dev_type_id='03' and
          tr_type_id='51'
    group by station_id;
-----------------------------------------         —∫Ω∫œº∆
--µ•≥Ã∆±¥¢÷µ∆±—∫Ω∫œº∆
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,0,0,
          0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and tr_type_id='51'
    group by station_id;
-----------------------------------------
--≥« –Õ®∆±
       insert into  t#OP_INC_STA_BOM_result
      select
         '','',station_id,'',
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='06' and
           dev_type_id='03' and
           tr_type_id='51'
    group by station_id;
---------------------------------------------------------------------------------------
----√‚∑—∆±º§ªÓ¥Œ ˝(≤ª»∑∂®)
insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,
        sum(deal_num),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code || card_sub_code ='0203' and tr_type_id ='54' and pay_mode_id ='14' -- –ﬁ∏ƒŒ™Õ≥º∆¿œ√‚∆±ºØ∫œ¥Œ ˝
    group by station_id;
----------------------------------------- ≥‰÷µ
/*--µÿÃ˙¥¢÷µ∆±≥‰÷µ
insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and
           dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
           and tr_type_id='54'
    group by station_id;*/
   /* --V1.3µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®≥‰÷µ
insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07') and
           dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
           and tr_type_id='54'
    group by station_id;*/
        --V1.31µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±≥‰÷µ
insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09') and
           dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
           and tr_type_id='54'
    group by station_id;
---------------------------------------------------------------------------------------
--≥« –Õ®∆±≥‰÷µ
       insert into  t#OP_INC_STA_BOM_result
       select
       '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
          and tr_type_id='54'
    group by station_id;
----------------------------------------- ≥Â’˝
/*--µÿÃ˙¥¢÷µ∆±≥Â’˝
       insert into  t#OP_INC_STA_BOM_result
      select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by station_id;*/
 /*   --v1.3µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®≥Â’˝
       insert into  t#OP_INC_STA_BOM_result
      select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07') and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by station_id;*/
        --v1.31µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±≥Â’˝
       insert into  t#OP_INC_STA_BOM_result
      select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        sum(deal_fee),
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07','08','09') and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by station_id;
--≥« –Õ®∆±
      insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and pay_mode_id='18'
         and tr_type_id='54'
    group by station_id;
---------------------------------------------------------------------------------------     ∏¸–¬
--µÿÃ˙
--Ω¯≥ˆ’æ¬Î∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and
           dev_type_id='03' and pay_mode_id='01' and
           tr_type_id='56'  and  (do_type='03' or do_type='10' or do_type='12' or do_type='11')
   group by station_id;

--≥¨≥À∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         0,0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and
           dev_type_id='03' and
           tr_type_id='56' and pay_mode_id='01' and do_type='02'
    group by station_id;
--≥¨ ±∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and
           dev_type_id='03' and
           tr_type_id='56' and pay_mode_id='01' and do_type='01'
    group by station_id;
--≥« –Õ®∆±
--Ω¯≥ˆ’æ¬Î∏¸–¬
    insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and
          tr_type_id='56' and pay_mode_id='01' and (do_type='03' or do_type='10' or do_type='12' or do_type='11')
    group by station_id;
--≥¨≥À∏¸–¬
  insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,
        '',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and
          tr_type_id='56' and pay_mode_id='01' and do_type='02'
    group by station_id;
--≥¨ ±∏¸–¬
  insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and
          dev_type_id='03' and
          tr_type_id='56' and pay_mode_id='01' and do_type='01'
   group by station_id;
---------------------------------------       ––’˛¥¶¿Ì
--√‚∑—Ω¯≥ˆ’æ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,
        '',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61' and do_type in('02')
    group by station_id;
---------------------------------------------------------------------------------------
--∏∂∑—≥ˆ’æ
       insert into  t#OP_INC_STA_BOM_result
        select
       '','',station_id,
       '',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       0,0,0,0,sum(deal_num),0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61' and  do_type='03'
    group by station_id;
-----------------------------------------
--––’˛¥¶¿Ì ’»Î
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       sum(penalty_fee),0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61'
    group by station_id;
--––’˛¥¶¿Ì÷ß≥ˆ
     insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,0,0,0,0,
      0,sum(return_balance),0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where dev_type_id='03' and
          tr_type_id='61'
    group by station_id;
--------------------------------------------------------------------------------------- ÕÀøÓΩ∂Ó
/*--¥¢÷µ∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code ='02'   and
           dev_type_id='03' and
           tr_type_id='57'
   group by station_id;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code ='02'   and
           dev_type_id='03' and
           tr_type_id='57'
   group by station_id;*/
  --V1.31
  --¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by station_id;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by station_id;
   /*--V1.3
  --¥¢÷µ∆±∫Õ“Ï–Œø®
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by station_id;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07')   and
           dev_type_id='03' and
           tr_type_id='57'
   group by station_id; */
---------------------------------------------------------------------------------------
-----------------------------------------
--µ•≥Ã∆±ÕÀøÓ
       insert into  t#OP_INC_STA_BOM_result
        select
        '','',station_id,'',
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,
       sum(return_balance),0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='01' and
           dev_type_id='03' and
           tr_type_id='57'
    group by line_id,station_id;
 ------------------------------------------------------------------------------------
--Õ≥º∆”¶ ’
--°∞”¶ ’Ω∂Ó°±£Ω∑¢ €Ω∂Ó£´≥‰÷µΩ∂Ó£´∏¸–¬Ω∂Ó£®œ÷Ω£©£´––’˛ ¬ŒÒ ’»Î£≠≥Â’˝Ω∂Ó£≠––’˛ ¬ŒÒ÷ß≥ˆ£≠ÕÀøÓΩ∂Ó
update t#OP_INC_STA_BOM_result
set total_fee=
        singl_fee
       --+svt_sin_fee
       --+svt_stu_fee
       --+svt_old_free_fee
       --+svt_old_none_fee
       --+sin_times_fee
       --+memory_fee
       --+pre_rem_fee
       +svt_fee
       +city_fee
       +charge_svt
       +charge_yct
       -cut_svt
       -cut_yct
       +update_dt1
       +update_dt2
       +update_dt3
       +update_yct1
       +update_yct2
       +update_yct3
       +affair_penalty
       -affair_return
       -deposit
       -bala
       +penalty
       -return_singl;

 ------------------------------------------------------------------------------------
--∏¸–¬’æ√˚
update t#OP_INC_STA_BOM_result a
--»•≥˝station_nameµƒ≈≈–Ú±‡∫≈
--set a.station_name=(select b.sequence||b.chinese_name
set a.station_name=(select b.chinese_name
            from op_prm_station b
            where b.record_flag='0' and b.line_id=v_line_id and a.station_id=b.station_id);
--∑µªÿ±®±Ì ˝æ›
open out_cursor for
select     v_squad_day||v_balance_day day,v_line_name line_name,station_id,station_name,
      sum(singl_num) singl_num,
      sum(singl_fee) singl_fee,
      sum(svt_sin_num) svt_sin_num,
      sum(svt_sin_fee) svt_sin_fee,
      sum(svt_stu_num) svt_stu_num,
      sum(svt_stu_fee) svt_stu_fee,
      sum(svt_old_free_num) svt_old_free_num,
      sum(svt_old_free_fee) svt_old_free_fee,
      sum(svt_old_none_num) svt_old_none_num,
      sum(svt_old_none_fee) svt_old_none_fee,
      sum(sin_times_num) sin_times_num,
      sum(sin_times_fee) sin_times_fee,
      sum(memory_num) memory_num,
      sum(memory_fee) memory_fee,
      sum(pre_rem_num) pre_rem_num,
      sum(pre_rem_fee) pre_rem_fee,
      sum(commuter_num) commuter_num, --add by luck
      sum(commuter_fee)  commuter_fee, --add by luck
      sum(svt_fee) svt_fee ,
      sum(city_num) city_num,
      sum(city_fee) city_fee,
      sum(free_times) free_times,
      sum(charge_svt)      charge_svt,
      sum(charge_yct)      charge_yct,
      sum(cut_svt)         cut_svt,
      sum(cut_yct)         cut_yct,
      sum(update_dt1)      update_dt1,
      sum(update_dt2)      update_dt2,
      sum(update_dt3)      update_dt3,
      sum(update_yct1)     update_yct1,
      sum(update_yct2)     update_yct2,
      sum(update_yct3)     update_yct3,
      sum(affair_num)      affair_num,
      sum(affair_num2)      affair_num2,
      sum(affair_penalty) affair_penalty,
      sum(affair_return)   affair_return,
      sum(deposit)         deposit,
      sum(bala)            bala,
      sum(penalty)         penalty,
      sum(return_singl)    return_singl,
      sum(total_fee)       total_fee
from t#OP_INC_STA_BOM_result
group by station_id,station_name
order by station_id,station_name;
 end;
/
grant execute on ACC_ST.UP_OP_INC_STA_BOM_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_STA_BOM_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_STA_BOM_OPER_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_STA_BOM_OPER_D (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_STA_BOM_OPER_D
--π¶ƒ‹√Ë ˆ£∫œ˙ € ’“Ê¿‡±®±Ì ≥µ’æ≤Ÿ◊˜‘± ’“Êª„◊‹»’±®
--¥¥Ω®’ﬂ£∫  WANGKEJIA
--¥¥Ω®»’∆⁄£∫20130909
--∂‘”¶ƒ£∞Â£∫rpt_02_016
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20140812
--–ﬁ∏ƒ»À£∫wangkejia
--–ﬁ∏ƒƒ⁄»›£∫–ﬁ∏ƒ”¶ ’Ω∂ÓÕ≥º∆
-------------------------------------------------------------------------------
--20140320
--Õıø…º—
--‘ˆº”“Ï–Œø®
--V1.3
------------------------------------------------------------------------------
--20140330
--Õıø…º—
--‘ˆº” ÷ª˙ø®
--V1.31
------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170126
--–ﬁ∏ƒ’ﬂ£∫zhongziqi
--–ﬁ∏ƒƒ⁄»›£∫»•≥˝∑µªÿΩ·π˚÷–≥µ’æµƒ≈≈¡––Ú∫≈
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°¥¢÷µ∆±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170801
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫√‚∑—∆±º§ªÓ¥Œ ˝–ﬁ∏ƒŒ™Õ≥º∆¿œ»À√‚∑—∆±º§ªÓ¥Œ ˝
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
        v_line_id char(2);
        v_line_name char(20);
        v_squad_day char(8);--‘À”™»’
        v_balance_day char(8);--«ÂÀ„»’
    BEGIN
        v_line_id:=in_line_id;
        v_squad_day:=substr(in_squad_day,1,8);
        v_balance_day:=substr(in_balance_day,1,8);
    if v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name
         from op_prm_line
         where line_id=v_line_id and record_flag='0';
    end if;
    ------¥”÷–º‰±ÌªÒ»° ˝æ›
   insert into  t#OP_INC_STA_BOM_rpt
   (squad_day,line_id,station_id,tr_type_id,do_type,pay_mode_id,pay_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee)
               select squad_day,line_id,station_id,tr_type_id,do_type,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
               where  balance_water_no>=v_balance_day||'00'
               and balance_water_no<=v_balance_day||'99'
               and squad_day = v_squad_day
               and line_id=v_line_id;
------------------------------------∑¢ €
--µ•≥Ã∆± ∆’Õ®µ•≥Ã∆±
  insert into  t#OP_INC_STA_BOM_OPER_RPT
      select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='01' and card_sub_code='00'
    and dev_type_id='03' and tr_type_id='50'
    --and pay_mode_id='01'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
-----------------------------------------
--≥…»À∆’Õ®¥¢÷µ∆±∑¢ €
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and  card_sub_code='00'
    and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
--—ß…˙∆’Õ®¥¢÷µ∆±∑¢ €
 insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
         0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='02' and  card_sub_code='01'
    and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
-----------------------------------------
--¿œ»À√‚∑—¥¢∆±∑¢ €
 insert into  t#OP_INC_STA_BOM_OPER_RPT
  select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
         0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and card_sub_code='02' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
--¿œ»À”≈ª›¥¢÷µ
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and card_sub_code='03' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
--∆’Õ®≥À¥Œ∆±
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,
     0,0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='03' and card_sub_code='00' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
/*--∆’Õ®ºÕƒÓ∆±
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='04' and card_sub_code='00' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;*/
 -- ÷ª˙∆±V1.31
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='08' and card_sub_code='00' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
/*--”≈ª›ºÕƒÓ∆±
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='04' and card_sub_code='01' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;*/
 --V1.3“Ï–Œø®
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,
     0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='07' and card_sub_code='00' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;

     --¥≈∏°∆±
  insert into  t#OP_INC_STA_BOM_OPER_RPT
   select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
     0,0,0,0,0,
     0,0,0,0,0,0,0,
     0,0,0,0,sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='09' and card_sub_code='01' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
-----------------------------------------         —∫Ω∫œº∆
--¥¢÷µ∆±—∫Ω∫œº∆
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
          0,0,0,0,0,
          0,0,0,0,0,0,0,
          0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
-----------------------------------------
--≥« –Õ®∆±
       insert into  t#OP_INC_STA_BOM_OPER_RPT
      select
         '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         sum(deal_num),sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='06' and dev_type_id='03' and tr_type_id='51'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
----√‚∑—∆±º§ªÓ¥Œ ˝(≤ª»∑∂®)
insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,
        sum(deal_num),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code || card_sub_code ='0203' and tr_type_id ='54' and pay_mode_id ='14' -- –ﬁ∏ƒŒ™Õ≥º∆¿œ√‚∆±ºØ∫œ¥Œ ˝
    group by station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
----------------------------------------- ≥‰÷µ
/*--µÿÃ˙¥¢÷µ∆±≥‰÷µ
insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and dev_type_id='03' and tr_type_id='54' and pay_mode_id in('14','54','94')-- and pay_mode_id='14'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;*/
/*   --V1.3µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®≥‰÷µ
insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07') and dev_type_id='03' and tr_type_id='54' and pay_mode_id in('14','54','94')-- and pay_mode_id='14'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID; */
       --V1.31µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±≥‰÷µ∫Õ¥≈∏°∆±
insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07','08','09') and dev_type_id='03' and tr_type_id='54' and pay_mode_id in('14','54','94')-- and pay_mode_id='14'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
--≥« –Õ®∆±≥‰÷µ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
       select
       '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and dev_type_id='03' and tr_type_id='54' and pay_mode_id in('14','54','94')--and pay_mode_id='14'
    group by station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
----------------------------------------- ≥Â’˝
/*--µÿÃ˙¥¢÷µ∆±≥Â’˝
       insert into  t#OP_INC_STA_BOM_OPER_RPT
      select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='02' and dev_type_id='03' and tr_type_id='54' and pay_mode_id='18'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;*/
/*--v1.3µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®≥Â’˝
       insert into  t#OP_INC_STA_BOM_OPER_RPT
      select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07') and dev_type_id='03' and tr_type_id='54' and pay_mode_id='18'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;    */
    --µÿÃ˙¥¢÷µ∆±∫Õ“Ï–Œø®∫Õ ÷ª˙∆±∫Õ¥≈∏°∆±≥Â’˝
       insert into  t#OP_INC_STA_BOM_OPER_RPT
      select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code in ('02','07','08','09') and dev_type_id='03' and tr_type_id='54' and pay_mode_id='18'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥« –Õ®∆±
      insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
  from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and dev_type_id='03' and tr_type_id='54' and pay_mode_id='18'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------     ∏¸–¬
--µÿÃ˙/“Ï–Œø®∫Õ ÷ª˙∆± ¥≈∏°
--Ω¯≥ˆ’æ¬Î∏¸–¬
    insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and dev_type_id='03' and pay_mode_id='01' and tr_type_id='56' and (do_type='03' or do_type='10' or do_type='12' or do_type='11')
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥¨≥À∏¸–¬
    insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,
         0,0,0,0,0,0,0,0,0,
         0,0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and dev_type_id='03' and pay_mode_id='01' and tr_type_id='56' and pay_mode_id='01' and do_type='02'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥¨ ±∏¸–¬
    insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        0,0,0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code<>'06' and dev_type_id='03' and pay_mode_id='01' and tr_type_id='56' and pay_mode_id='01' and do_type='01'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥« –Õ®∆±
--Ω¯≥ˆ’æ¬Î∏¸–¬
    insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,
        sum(penalty_fee),0,0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and dev_type_id='03' and pay_mode_id='01' and tr_type_id='56' and pay_mode_id='01' and (do_type='03' or do_type='10' or do_type='12' or do_type='11')
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥¨≥À∏¸–¬
  insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,sum(penalty_fee),0,0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and dev_type_id='03' and pay_mode_id='01' and tr_type_id='56' and pay_mode_id='01' and do_type='02'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥¨ ±∏¸–¬
  insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,0,0,0,
       0,0,sum(penalty_fee),0,0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where card_main_code='06' and dev_type_id='03' and pay_mode_id='01' and tr_type_id='56' and pay_mode_id='01' and do_type='01'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------       ––’˛¥¶¿Ì
--√‚∑—Ω¯≥ˆ’æ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and tr_type_id='61' and do_type in('02')
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
--∏∂∑—≥ˆ’æ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
       '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,
       0,0,0,0,sum(deal_num),0,0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and tr_type_id='61' and  do_type='03'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
-----------------------------------------
--––’˛¥¶¿Ì ’»Î
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,
       0,0,0,0,0,sum(penalty_fee),0,0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  dev_type_id='03' and
           tr_type_id='61'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--––’˛¥¶¿Ì÷ß≥ˆ
     insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,
      0,0,0,0,0,0,0,0,0,0,0,0,0,0,
      0,sum(return_balance),0,0,0,0,0
    from t#OP_INC_STA_BOM_rpt
    where dev_type_id='03' and tr_type_id='61'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--------------------------------------------------------------------------------------- ÕÀøÓΩ∂Ó
/*--¥¢÷µ∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code ='02' and  dev_type_id='03' and tr_type_id='57'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code ='02' and  dev_type_id='03' and tr_type_id='57'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;*/
   /*--V1.3
   --¥¢÷µ∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07') and  dev_type_id='03' and tr_type_id='57'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07') and  dev_type_id='03' and tr_type_id='57'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;*/
   --V1.31
   --¥¢÷µ∆±°¢“Ï–Œø®°¢ ÷ª˙∆±
--—∫ΩÕÀøÓ
--”‡∂ÓÕÀøÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,sum(deal_fee),sum(return_balance),0,0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09') and  dev_type_id='03' and tr_type_id='57'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--≥À≥µø€øÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,
        0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,nvl(sum(penalty_fee),0),0,0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code in ('02','07','08','09') and  dev_type_id='03' and tr_type_id='57'
   group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
---------------------------------------------------------------------------------------
-----------------------------------------
--µ•≥Ã∆±ÕÀøÓ
       insert into  t#OP_INC_STA_BOM_OPER_RPT
        select
        '','',station_id,'',OPERATOR_ID,DEVICE_ID,SHIFT_ID,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,
       0,0,0,0,0,0,0,
       0,0,0,0,0,0,0,0,0,0,0,0,
       sum(return_balance),0
    from t#OP_INC_STA_BOM_rpt
    where  card_main_code='01' and dev_type_id='03' and tr_type_id='57'
    group by  station_id,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
--Õ≥º∆”¶ ’    --°∞”¶ ’Ω∂Ó°±£Ω∑¢ €Ω∂Ó£´≥‰÷µΩ∂Ó£´∏¸–¬Ω∂Ó£®œ÷Ω£©£´––’˛ ¬ŒÒ ’»Î£≠≥Â’˝Ω∂Ó£≠––’˛ ¬ŒÒ÷ß≥ˆ£≠ÕÀøÓΩ∂Ó
update t#OP_INC_STA_BOM_OPER_RPT
set total_fee=
        singl_fee
       +svt_fee
       +city_fee
       +charge_svt
       +charge_yct
       -cut_svt
       -cut_yct
       +update_dt1
       +update_dt2
       +update_dt3
       +update_yct1
       +update_yct2
       +update_yct3
       +affair_penalty
       -affair_return
       -deposit
       -bala
       +penalty
       -return_singl;
--∏¸–¬’æ√˚
--»•≥˝station_nameµƒ≈≈–Ú±‡∫≈
update t#OP_INC_STA_BOM_OPER_RPT a
--set a.station_name=(select b.sequence||b.chinese_name
set a.station_name=(select b.chinese_name
            from op_prm_station b
            where b.record_flag='0' and b.line_id=v_line_id
            and a.station_id = b.station_id);
-----ƒ©–– »´≤ø’æµ„∫œº∆
insert into t#OP_INC_STA_BOM_OPER_RPT
select '','',
      '99','∫œº∆',
      '','','',
      sum(singl_num) singl_num,
      sum(singl_fee) singl_fee,
      sum(svt_sin_num) svt_sin_num,
      sum(svt_sin_fee) svt_sin_fee,
      sum(svt_stu_num) svt_stu_num,
      sum(svt_stu_fee) svt_stu_fee,
      sum(svt_old_free_num) svt_old_free_num,
      sum(svt_old_free_fee) svt_old_free_fee,
      sum(svt_old_none_num) svt_old_none_num,
      sum(svt_old_none_fee) svt_old_none_fee,
      sum(sin_times_num) sin_times_num,
      sum(sin_times_fee) sin_times_fee,
      sum(memory_num) memory_num,
      sum(memory_fee) memory_fee,
      sum(pre_rem_num) pre_rem_num,
      sum(pre_rem_fee) pre_rem_fee,
      sum(commuter_num) commuter_num, --add by luck
      sum(commuter_fee) commuter_fee, --add by luck
      sum(svt_fee) svt_fee ,
      sum(city_num) city_num,
      sum(city_fee) city_fee,
      sum(free_times) free_times,
      sum(charge_svt)      charge_svt,
      sum(charge_yct)      charge_yct,
      sum(cut_svt)         cut_svt,
      sum(cut_yct)         cut_yct,
      sum(update_dt1)      update_dt1,
      sum(update_dt2)      update_dt2,
      sum(update_dt3)      update_dt3,
      sum(update_yct1)     update_yct1,
      sum(update_yct2)     update_yct2,
      sum(update_yct3)     update_yct3,
      sum(affair_num)      affair_num,
      sum(affair_num2)      affair_num2,
      sum(affair_penalty) affair_penalty,
      sum(affair_return)   affair_return,
      sum(deposit)         deposit,
      sum(bala)            bala,
      sum(penalty)         penalty,
      sum(return_singl)    return_singl,
      sum(total_fee)       total_fee
from t#OP_INC_STA_BOM_OPER_RPT;
-----∞¥≤Ÿ◊˜‘±–°º∆
insert into t#OP_INC_STA_BOM_OPER_RPT
select '','',
      station_id,station_name,
      substr(OPERATOR_ID,1,6)||''||'–°º∆','','',
      sum(singl_num) singl_num,
      sum(singl_fee) singl_fee,
      sum(svt_sin_num) svt_sin_num,
      sum(svt_sin_fee) svt_sin_fee,
      sum(svt_stu_num) svt_stu_num,
      sum(svt_stu_fee) svt_stu_fee,
      sum(svt_old_free_num) svt_old_free_num,
      sum(svt_old_free_fee) svt_old_free_fee,
      sum(svt_old_none_num) svt_old_none_num,
      sum(svt_old_none_fee) svt_old_none_fee,
      sum(sin_times_num) sin_times_num,
      sum(sin_times_fee) sin_times_fee,
      sum(memory_num) memory_num,
      sum(memory_fee) memory_fee,
      sum(pre_rem_num) pre_rem_num,
      sum(pre_rem_fee) pre_rem_fee,
      sum(commuter_num) commuter_num, --add by luck
      sum(commuter_fee) commuter_fee, --add by luck
      sum(svt_fee) svt_fee ,
      sum(city_num) city_num,
      sum(city_fee) city_fee,
      sum(free_times) free_times,
      sum(charge_svt)      charge_svt,
      sum(charge_yct)      charge_yct,
      sum(cut_svt)         cut_svt,
      sum(cut_yct)         cut_yct,
      sum(update_dt1)      update_dt1,
      sum(update_dt2)      update_dt2,
      sum(update_dt3)      update_dt3,
      sum(update_yct1)     update_yct1,
      sum(update_yct2)     update_yct2,
      sum(update_yct3)     update_yct3,
      sum(affair_num)      affair_num,
      sum(affair_num2)      affair_num2,
      sum(affair_penalty) affair_penalty,
      sum(affair_return)   affair_return,
      sum(deposit)         deposit,
      sum(bala)            bala,
      sum(penalty)         penalty,
      sum(return_singl)    return_singl,
      sum(total_fee)       total_fee
from t#OP_INC_STA_BOM_OPER_RPT
where station_id!='99'
group by station_id,station_name,OPERATOR_ID;

--∑µªÿ±®±Ì ˝æ›
open out_cursor for
select     v_squad_day||v_balance_day day,
      v_line_name line_name,

      station_id,station_name,
      OPERATOR_ID,DEVICE_ID,SHIFT_ID,
      sum(singl_num) singl_num,
      sum(singl_fee) singl_fee,
      sum(svt_sin_num) svt_sin_num,
      sum(svt_sin_fee) svt_sin_fee,
      sum(svt_stu_num) svt_stu_num,
      sum(svt_stu_fee) svt_stu_fee,
      sum(svt_old_free_num) svt_old_free_num,
      sum(svt_old_free_fee) svt_old_free_fee,
      sum(svt_old_none_num) svt_old_none_num,
      sum(svt_old_none_fee) svt_old_none_fee,
      sum(sin_times_num) sin_times_num,
      sum(sin_times_fee) sin_times_fee,
      sum(memory_num) memory_num,
      sum(memory_fee) memory_fee,
      sum(pre_rem_num) pre_rem_num,
      sum(pre_rem_fee) pre_rem_fee,
      sum(commuter_num) commuter_num, --add by luck
      sum(commuter_fee) commuter_fee, --add by luck
      sum(svt_fee) svt_fee ,
      sum(city_num) city_num,
      sum(city_fee) city_fee,
      sum(free_times) free_times,
      sum(charge_svt)      charge_svt,
      sum(charge_yct)      charge_yct,
      sum(cut_svt)         cut_svt,
      sum(cut_yct)         cut_yct,
      sum(update_dt1)      update_dt1,
      sum(update_dt2)      update_dt2,
      sum(update_dt3)      update_dt3,
      sum(update_yct1)     update_yct1,
      sum(update_yct2)     update_yct2,
      sum(update_yct3)     update_yct3,
      sum(affair_num)      affair_num,
      sum(affair_num2)      affair_num2,
      sum(affair_penalty) affair_penalty,
      sum(affair_return)   affair_return,
      sum(deposit)         deposit,
      sum(bala)            bala,
      sum(penalty)         penalty,
      sum(return_singl)    return_singl,
      sum(total_fee)       total_fee
from t#OP_INC_STA_BOM_OPER_RPT
group by OPERATOR_ID,DEVICE_ID,SHIFT_ID,station_id,station_name
order by station_id,station_name,OPERATOR_ID,DEVICE_ID,SHIFT_ID;
 end;
/
grant execute on ACC_ST.UP_OP_INC_STA_BOM_OPER_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_STA_BOM_OPER_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_STA_DISCOUNT_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_STA_DISCOUNT_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ œﬂ¬∑≥µ’æø€øÓÕ≥º∆»’±®  £®ø…∞¥œﬂ¬∑≤È—ØÀ˘”–∆±ø®£©
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_011
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(8);
v_balance_day char(8);
    BEGIN
     v_line_id:= in_line_id;
     v_squad_day:=substr(in_squad_day,1,8);
     v_balance_day:=substr(in_balance_day,1,8);
     if v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line where line_id=v_line_id
     and record_flag='0';
     end if;
      ----≤È—Ø ˝æ› »°≥ˆ¬˙◊„Ãıº˛µƒÀ˘”– ˝æ›
      insert into t#OP_INC_STA_DISCOUNT_rpt
      (squad_day,line_id,station_id,card_main_id,card_sub_id,income,deal_num)
      select squad_day,line_id,station_id,card_main_id,
      case when card_main_id='06' then '00' else card_sub_id end,
             sum(deal_fee),sum(deal_num)
      from st_sts_inc_consume
      where balance_water_no>= v_balance_day||'00'
            and balance_water_no<=v_balance_day||'99'
            and substr(squad_day,1,8)=v_squad_day
            and line_id=v_line_id
            and card_main_id!='05'--‘±π§∆±
      group by squad_day,line_id,station_id,card_main_id,card_sub_id;
----ππΩ®Ω·π˚ºØΩ·ππ
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,a.station_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'1',' ˝¡ø',0
      from op_prm_station a,op_prm_card_sub b
      where a.record_flag=0 and a.line_id=v_line_id and b.record_flag=0 and b.card_main_id!='05';
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,a.station_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'2','Ω∂Ó',0.00
      from op_prm_station a,op_prm_card_sub b
      where a.record_flag=0 and a.line_id=v_line_id and b.record_flag=0 and b.card_main_id!='05';
      --≤Â»Îƒ©––◊‹º∆
       insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,station_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','99','∫œº∆',b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'1',' ˝¡ø',0
      from op_prm_card_sub b
      where b.record_flag=0 and b.card_main_id!='05';

      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,station_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','99','∫œº∆',b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'2','Ω∂Ó',0
      from op_prm_card_sub b
      where b.record_flag=0 and b.card_main_id!='05';
      --œÚΩ·π˚ºØÃÌº” ˝æ› Ω´01 ˝¡ø∫Õ02Ω∂Ó∑÷±≤Â»Î £®±„”⁄Ωª≤Ê±Ì£©
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,station_id,card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,station_id,card_main_id,card_sub_id,deal_num;
           insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,station_id,card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,station_id,card_main_id,card_sub_id;
      --≤Â»Îƒ©––◊‹º∆
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,station_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','99','∫œº∆',card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,station_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','99','∫œº∆',card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
      --∏¸–¬’æµ„
      update t#OP_INC_STA_DISCOUNT_result a
      set a.station_name=(
      select b.sequence||b.chinese_name from op_prm_station b where a.station_id=b.station_id and a.line_id=b.line_id and b.record_flag='0')
      where station_id!='99';
      --∏¸–¬œﬂ¬∑√˚
      update t#OP_INC_STA_DISCOUNT_result a
      set a.line_name=(
      select b.sequence||b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0')
      where station_id!='99';
      --∏¸–¬∆±ø®√˚≥∆
      update t#OP_INC_STA_DISCOUNT_result a
      set a.card_name=(
      select b.card_sub_name from op_prm_card_sub b
      where a.card_main_id=b.card_main_id
        and a.card_sub_id=b.card_sub_id and b.record_flag='0')
        where a.card_main_id!='06';
       update t#OP_INC_STA_DISCOUNT_result
       set card_name='≥« –Õ®∆±' where card_main_id='06';
      --∑µªÿΩ·π˚ºØ
      open out_cursor for
      select v_squad_day||v_balance_day day,v_line_name linename,station_name,card_main_id||card_sub_id||card_name card_name,disc_name,sum(num)
      from t#OP_INC_STA_DISCOUNT_result
      group by line_name,station_name,card_main_id,card_sub_id,card_name,disc_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_STA_DISCOUNT_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_STA_DISCOUNT_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_STA_DISCOUNT_M
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_STA_DISCOUNT_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ œﬂ¬∑≥µ’æø€øÓÕ≥º∆‘¬±®  £®ø…∞¥œﬂ¬∑≤È—ØÀ˘”–∆±ø®£©
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_012
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(6);
v_balance_day char(6);
    BEGIN
     v_line_id:= in_line_id;
     v_squad_day:=substr(in_squad_day,1,6);
     v_balance_day:=substr(in_balance_day,1,6);
     if v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
     end if;
      ----≤È—Ø ˝æ› »°≥ˆ¬˙◊„Ãıº˛µƒÀ˘”– ˝æ›
      insert into t#OP_INC_STA_DISCOUNT_rpt
      (squad_day,line_id,station_id,card_main_id,card_sub_id,income,deal_num)
      select squad_day,line_id,station_id,card_main_id,
      case when card_main_id='06' then '00' else card_sub_id end,
             sum(deal_fee),sum(deal_num)
      from st_sts_inc_consume
      where balance_water_no>= v_balance_day||'0100'
            and balance_water_no<=v_balance_day||'3199'
            and substr(squad_day,1,6)=v_squad_day
            and line_id=v_line_id
      group by squad_day,line_id,station_id,card_main_id,card_sub_id;
----ππΩ®Ω·π˚ºØΩ·ππ
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,a.station_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'1',' ˝¡ø',0
      from op_prm_station a,op_prm_card_sub b
      where a.record_flag=0 and b.record_flag=0;
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,a.station_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'2','Ω∂Ó',0.00
      from op_prm_station a,op_prm_card_sub b
      where a.record_flag=0 and b.record_flag=0;
      --œÚΩ·π˚ºØÃÌº” ˝æ› Ω´01 ˝¡ø∫Õ02Ω∂Ó∑÷±≤Â»Î £®±„”⁄Ωª≤Ê±Ì£©
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,station_id,card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,station_id,card_main_id,card_sub_id;
           insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,station_id,card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,station_id,card_main_id,card_sub_id;
            --≤Â»Îƒ©––◊‹º∆
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,station_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','99','∫œº∆',card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,station_id,station_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','99','∫œº∆',card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
      --∏¸–¬’æµ„
      update t#OP_INC_STA_DISCOUNT_result a
      set a.station_name=(
      select b.sequence||b.chinese_name from op_prm_station b where a.station_id=b.station_id and a.line_id=b.line_id and b.record_flag='0')
      where station_id!='99';
      --∏¸–¬œﬂ¬∑√˚
      update t#OP_INC_STA_DISCOUNT_result a
      set a.line_name=(
      select b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0');
      --∏¸–¬∆±ø®√˚≥∆
      update t#OP_INC_STA_DISCOUNT_result a
      set a.card_name=(
      select b.card_sub_name from op_prm_card_sub b
      where a.card_main_id=b.card_main_id
        and a.card_sub_id=b.card_sub_id and b.record_flag='0')
        where a.card_main_id!='06';
       update t#OP_INC_STA_DISCOUNT_result
       set card_name='≥« –Õ®∆±' where card_main_id='06';
      --∑µªÿΩ·π˚ºØ
      open out_cursor for
      select v_squad_day||v_balance_day mon,v_line_name linename,station_name stationname,card_main_id||card_sub_id||card_name card_name,disc_name,num
      from t#OP_INC_STA_DISCOUNT_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_STA_DISCOUNT_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_STA_DISCOUNT_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_STA_INCOME_D
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_STA_INCOME_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_STA_INCOME_D
--π¶ƒ‹√Ë ˆ£∫≥µ’æ ’“ÊÕ≥º∆»’±®
--¥¥Ω®’ﬂ£∫ wangkejia
--¥¥Ω®»’∆⁄£∫20130909
--∂‘”¶ƒ£∞Â:rpt_02_018
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140624
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');£®by lili£©
          --2>±®±Ì∑«œ÷Ω∏¸–¬–ﬁ∏ƒ£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140721
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬‘ˆº”£∫tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0;
            --2>±®±Ì‘ˆº”tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0µƒ∑«œ÷Ω∏¸–¬
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140729
--–ﬁ∏ƒƒ⁄»›£∫1>∑«œ÷Ω∏¸–¬:tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0
--∏ƒŒ™£∫tr_type_id='56' and  pay_mode_id ='02' and penalty_fee=0
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150320
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”“Ï–Œø® ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--v1.31
--–ﬁ∏ƒ»’∆⁄£∫20150330
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ÷ª˙∆± ˝æ›
    --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170206
  --–ﬁ∏ƒƒ⁄»›£∫
     --»•≥˝’æµ„«∞√Êµƒ ˝◊÷±‡∫≈
  --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°¥¢÷µ∆±
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170801
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫”¶ ’Ω∂Óºı»•∏¸’˝∑«œ÷Ω
AS
        v_squad_day char(8);
        v_balance_day char(8);
BEGIN
v_squad_day:=substr(in_squad_day,1,8);
v_balance_day:=substr(in_balance_day,1,8);
 insert into  t#OP_INC_STA_INCOME_RPT
 (line_id,station_id,squad_day,tr_type_id,paymode_id,do_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty)
               select line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
                where  balance_water_no>=V_balance_day||'00' and balance_water_no<=V_balance_day||'99' and substr(squad_day,1,8)=v_squad_day;
------------------------------------µ•≥Ã∆±∑¢ €
--TVMµ•≥Ã∆±∑¢ €
        insert into t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='01'  and
               dev_type_id='02'    and
               tr_type_id='50'
               --and paymode_id<>'05'
        group by line_id,station_id;
--bomµ•≥Ã∆±∑¢ €
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              dev_type_id='03' and
              tr_type_id='50'
        group by line_id,station_id;
--µ•≥Ã∆±∑¢ €–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='50'
        group by line_id,station_id;
--------------------------------------≥‰÷µΩ∂Ó---------------------------------------
--TVM≥‰÷µ
         insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  dev_type_id='02' and
               tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id,station_id;

--BOM≥‰÷µ
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where dev_type_id='03' and
              tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id,station_id;

--≥‰÷µ–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id,station_id;
----—∫Ω–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  (tr_type_id='50' or tr_type_id='51')
        group by line_id,station_id;
-------------------∏¸–¬Ω∂Ó----------------------
--œ÷Ω∏¸–¬£∫
--µ•≥À∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='01'
        group by line_id,station_id;
        /*
--µÿÃ˙¥¢÷µ∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='02' and
              tr_type_id='56' and paymode_id='01'
        group by line_id,station_id;*/
        /*--V1.3
  insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07') and
              tr_type_id='56' and paymode_id='01'
        group by line_id,station_id;*/
                --V1.31
  insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
              tr_type_id='56' and paymode_id='01'
        group by line_id,station_id;
--≥« –Õ®œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='01'
       group by line_id,station_id;
--∑«œ÷Ω(∏¸–¬Ω∂Ó≤ªŒ™0)£∫
---------------------- ˝æ›¿¥‘¥£∫deal±Ì---------------------------------
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id,station_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
/*
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;*/
       /*--V1.3
           insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;    */
              --V1.31
           insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id,station_id;
-----------------------------------------------------------------------
--20140729∏¸–¬£ª
---------------------- ˝æ›¿¥‘¥£∫update±Ì---------------------------------
--∑«œ÷Ω∏¸–¬£∫
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id,station_id;
--v1.3
        /*
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id,station_id;*/
              /* insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id,station_id;*/
       --v1.31
                      insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id,station_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id,station_id;
----------------------------------------------------------------------

----------------------------------------------------------------------
/*--20140721–¬‘ˆ£∫
--∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='00' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;*/
        --∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)

----------------------------------------------------------------------
--∏¸–¬–°º∆
insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,0,sum(update_dc+update_dt+update_oct+update_dc2+update_dt2+update_oct2),0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RESULT
       group by line_id,station_id;
-------------------------------------≥Â’˝--------------------------------------------------
--µÿÃ˙¥¢÷µ∆±≥Â’˝
/*
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'',station_id,'',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
             tr_type_id='54' and paymode_id='18'
       group by line_id,station_id;*/
      /* --V1.3
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'',station_id,'',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
             tr_type_id='54' and paymode_id='18'
       group by line_id,station_id;*/
              --V1.31
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'',station_id,'',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
             tr_type_id='54' and paymode_id='18'
       group by line_id,station_id;
--≥« –Õ®≥Â’˝
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='06' and
               tr_type_id='54' and paymode_id='18'
        group by line_id,station_id;
---------------------------------------––’˛¥¶¿Ì--
--√‚∑—Ω¯≥ˆ’æ∆± ˝¡ø
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='61' and do_type in('02')
        group by line_id,station_id;
--∏∂∑—≥ˆ’æ∆± ˝¡ø
 insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='61' and do_type='03'
        group by line_id,station_id;
--––’˛ ¬ŒÒ ’»Î
--––’˛ ¬ŒÒ÷ß≥ˆ
insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,sum(penalty),sum(return_bala),0,0,0,0,0,0
     from t#OP_INC_STA_INCOME_RPT
          where tr_type_id='61'
          group by line_id,station_id;
----------------------------------------ÕÀøÓ----------------------------------------------
--—∫Ω
--”‡∂Ó
--¥¢÷µ∆±≥À≥µø€
/*
  insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03') and
                 tr_type_id='57'
          group by line_id,station_id;*/
   /*--V1.3
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03','07') and
                 tr_type_id='57'
          group by line_id,station_id;  */
            --V1.3
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
                 tr_type_id='57'
          group by line_id,station_id;

--µ•≥Ã∆±ÕÀøÓ
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_bala),0,0
         from t#OP_INC_STA_INCOME_RPT
          where card_main_code='01' and
                tr_type_id='57'
          group by line_id,station_id;
--ÕÀøÓ–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee+return_bala-penalty),0
         from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='57'
        group by line_id,station_id;

------------------------------------------”¶ ’Ω∂Ó
--- ºı»•∏¸’˝∑«œ÷Ω luck 20170801
insert into t#OP_INC_STA_INCOME_RESULT
  select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(sale_total+add_total+fee_total+update_total-update_dc2-update_dt2-update_oct2-cut_oct-cut_dt+affair_penalty-affair_return-ret_total)
  from t#OP_INC_STA_INCOME_RESULT
             group by line_id,station_id;
--∏¸–¬’æ√˚
--»•µÙ’æµ„«∞µƒ ˝◊÷±‡∫≈
update t#OP_INC_STA_INCOME_RESULT a
set a.station_name =(
select /*'('||c.line_id||b.sequence||')'||*/b.chinese_name
from op_prm_station b,op_prm_line c
where b.record_flag='0' and c.record_flag='0' and a.line_id=b.line_id and a.station_id=b.station_id and a.line_id=c.line_id);
-------------------------------------œﬂ¬∑–°º∆
--»•µÙ∫œº∆«∞µƒ ˝◊÷±‡∫≈
        insert into  t#OP_INC_STA_INCOME_RESULT
          select a.line_id,'','99', /*'('||b.line_id||'99'||b.line_name||')'||*/b.line_name||'∫œº∆',
          sum(tvm_sale),
          sum(bom_sale),
          sum(sale_total),
          sum(tvm_add),
          sum(bom_add),
          sum(add_total),
          sum(fee_total),
          sum(update_dc),
          sum(update_dt),
          sum(update_oct),
          sum(update_dc2),
          sum(update_dt2),
          sum(update_oct2),
          sum(update_total),
          sum(cut_dt),
          sum(cut_oct),
          sum(affair_02),
          sum(affair_03),
          sum(affair_penalty),
          sum(affair_return),
          sum(ret_desosit),
          sum(ret_bala),
          sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
          sum(ret_sjt),
          sum(ret_total),
          sum(total)
          from t#OP_INC_STA_INCOME_RESULT a,op_prm_line b
          where a.line_id=b.line_id and b.record_flag='0'
          group by    a.line_id,b.line_id,b.line_name;
------------------------------------◊‹º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
          select '99','','99','◊‹º∆',
       sum(tvm_sale),
       sum(bom_sale ),
       sum(sale_total),
       sum(tvm_add  ),
       sum(bom_add ),
       sum(add_total),
       sum(fee_total ),
       sum(update_dc ),
       sum(update_dt ),
       sum(update_oct ),
       sum(update_dc2 ),
       sum(update_dt2 ),
       sum(update_oct2 ),
       sum(update_total),
       sum(cut_dt),
       sum(cut_oct),
       sum(affair_02),
       sum(affair_03),
       sum(affair_penalty),
       sum(affair_return),
       sum(ret_desosit),
       sum(ret_bala),
       sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
       sum(ret_sjt),
       sum(ret_total),
       sum(total)
       from t#OP_INC_STA_INCOME_RESULT
       where station_id<>'99';
--∑µªÿΩ·π˚
open out_cursor for
select   v_squad_day||v_balance_day day,line_id,station_id,
      station_name,
      sum(tvm_sale)          tvm_sale,
      sum(bom_sale )         bom_sale,
      sum(sale_total)        sale_total,
      sum(tvm_add)           tvm_add,
      sum(bom_add )          bom_add,
      sum(add_total)         add_total,
      sum(fee_total)         fee_total,
      sum(update_dc)         update_dc,
      sum(update_dt)         update_dt,
      sum(update_oct)        update_oct,
      sum(update_dc2)        update_dc2,
      sum(update_dt2)        update_dt2,
      sum(update_oct2)       update_oct2,
      sum(update_total)      update_total,
      sum(cut_dt)            cut_dt,
      sum(cut_oct)           cut_oct,
      sum(affair_02)         affair_02,
      sum(affair_03)         affair_03,
      sum(affair_penalty)    affair_penalty,
      sum(affair_return)     affair_return,
      sum(ret_desosit)       ret_desosit,
      sum(ret_bala)          ret_bala,
      sum(penalty)           penalty,
      sum(ret_sjt)           ret_sjt,
      sum(ret_total)         ret_total,
      sum(total)             total
      from t#OP_INC_STA_INCOME_RESULT
      group by line_id,station_id,station_name
      order by line_id,station_id,station_name;
      end;
/
grant execute on ACC_ST.UP_OP_INC_STA_INCOME_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_STA_INCOME_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_STA_INCOME_M
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_STA_INCOME_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_STA_INCOME_M
--π¶ƒ‹√Ë ˆ£∫≥µ’æ ’“ÊÕ≥º∆‘¬±®
--¥¥Ω®’ﬂ£∫ wangkejia
--¥¥Ω®»’∆⁄£∫20130909
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140624
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');£®by lili£©
          --2>±®±Ì∑«œ÷Ω∏¸–¬–ﬁ∏ƒ£∫tr_type_id='54' and  pay_mode_id in ('1A','4A');
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140721
--–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±Ì∑«œ÷Ω∏¸–¬‘ˆº”£∫tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0;
            --2>±®±Ì‘ˆº”tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0µƒ∑«œ÷Ω∏¸–¬
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ ±º‰£∫20140729
--–ﬁ∏ƒƒ⁄»›£∫1>∑«œ÷Ω∏¸–¬:tr_type_id='56' and  pay_mode_id ='00' and penalty_fee=0
--∏ƒŒ™£∫tr_type_id='56' and  pay_mode_id ='02'  and penalty=0
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20150320
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”“Ï–Œø® ˝æ›
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫Õıø…º—
--V1.31
--–ﬁ∏ƒ»’∆⁄£∫20150330
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ÷ª˙∆± ˝æ›
    --------------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫¡ıµ¬‘ˆ
  --–ﬁ∏ƒ»’∆⁄£∫20170206
  --–ﬁ∏ƒƒ⁄»›£∫
     --»•≥˝’æµ„«∞√Êµƒ ˝◊÷±‡∫≈
  --------------------------------------------------------------------------------------
    --–ﬁ∏ƒ»’∆⁄£∫20170724
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫1£©–¬‘ˆ¥≈∏°¥¢÷µ∆±
--          2£©–ﬁ∏ƒµÿÃ˙¥¢÷µ∆±œ÷Ω£¨÷Æ«∞µƒ–¥∑®Œ™µÿÃ˙¥¢÷µ∆±∑«œ÷Ωœ÷Ω
-------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170801
--–ﬁ∏ƒ’ﬂ£∫luck
--–ﬁ∏ƒƒ⁄»›£∫”¶ ’Ω∂Óºı»•∏¸’˝∑«œ÷Ω
AS
        v_squad_day char(6);
        v_balance_day char(6);

BEGIN
v_squad_day:=substr(in_squad_day,1,6);
v_balance_day:=substr(in_balance_day,1,6);
 insert into  t#OP_INC_STA_INCOME_RPT
 (line_id,station_id,squad_day,tr_type_id,paymode_id,do_type,operator_id,card_main_code,card_sub_code,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty)
               select line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,deal_num,shift_id,device_id,penalty_fee
               from st_sts_inc_station
                where  balance_water_no>=V_balance_day||'0100' and balance_water_no<=V_balance_day||'3199' and SUBSTR(squad_day,1,6)=v_squad_day;
------------------------------------µ•≥Ã∆±∑¢ €
--TVMµ•≥Ã∆±∑¢ €
        insert into t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='01'  and
               dev_type_id='02'    and
               tr_type_id='50'
        group by line_id,station_id;
--bomµ•≥Ã∆±∑¢ €
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              dev_type_id='03' and
              tr_type_id='50'
        group by line_id,station_id;
--µ•≥Ã∆±∑¢ €–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='50'
        group by line_id,station_id;
--------------------------------------≥‰÷µΩ∂Ó---------------------------------------
--TVM≥‰÷µ
         insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  dev_type_id='02' and
               tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id,station_id;
--BOM≥‰÷µ
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where dev_type_id='03' and
              tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id,station_id;
--≥‰÷µ–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='54' and paymode_id in ('14','54','94')
        group by line_id,station_id;
----—∫Ω–°º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  (tr_type_id='50' or tr_type_id='51')
        group by line_id,station_id;
-------------------∏¸–¬Ω∂Ó----------------------
--œ÷Ω∏¸–¬£∫
--µ•≥À∆±œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='01'
        group by line_id,station_id;
--µÿÃ˙¥¢÷µ∆±œ÷Ω
/*
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;*/
       /*--V1.3
           insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;   */
              --V1.31--µÿÃ˙¥¢÷µ∆±°¢“Ï–Œø®°¢ ÷ª˙∆±œ÷Ω
       /*    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08') and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;*/
       -- –ﬁ∏ƒµÿÃ˙¥¢÷µ∆±œ÷Ω luck
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
              tr_type_id='56' and paymode_id='01'
        group by line_id,station_id;
--≥« –Õ®œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='01'
       group by line_id,station_id;
--∑«œ÷Ω(∏¸–¬Ω∂Ó≤ªŒ™0)£∫
---------------------- ˝æ›¿¥‘¥£∫deal±Ì---------------------------------
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id,station_id;

/*--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;*/
       /*insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;*/
       --v1.31¥¢÷µ∆±°¢“Ï–Œø®°¢ ÷ª˙∆±∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
              tr_type_id='54' and paymode_id in ('1A','4A')
       group by line_id,station_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='54' and paymode_id in ('1A','4A')
        group by line_id,station_id;
-----------------------------------------------------------------------
--20140729∏¸–¬£ª
---------------------- ˝æ›¿¥‘¥£∫update±Ì---------------------------------
--∑«œ÷Ω∏¸–¬£∫
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id,station_id;

        /*
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        --v1.3
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id,station_id;*/
               /*insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id,station_id;*/
       --v1.31¥¢÷µ∆±°¢ ÷ª˙∆±°¢“Ï–Œø®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
              tr_type_id='56' and paymode_id='02' and penalty=0
       group by line_id,station_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='02' and penalty=0
        group by line_id,station_id;
----------------------------------------------------------------------

----------------------------------------------------------------------
/*--20140721–¬‘ˆ£∫
--∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)
--µ•≥À∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='01' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;
--µÿÃ˙¥¢÷µ∆±∑«œ÷Ω
        insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
              tr_type_id='56' and paymode_id='00' and penalty=0
       group by line_id;
--≥« –Õ®∑«œ÷Ω
       insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'','','',
        0,0,0,0,0,0,0,0,0,0,0,0,sum(penalty),0,0,0,0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where card_main_code='06' and
              tr_type_id='56' and paymode_id='00' and penalty=0
        group by line_id;*/
        --∑«œ÷Ω(∏¸–¬Ω∂ÓŒ™0)

----------------------------------------------------------------------
--∏¸–¬–°º∆
insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,0,sum(update_dc+update_dt+update_oct+update_dc2+update_dt2+update_oct2),0,0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RESULT
       group by line_id,station_id;
-------------------------------------≥Â’˝--------------------------------------------------
--µÿÃ˙¥¢÷µ∆±≥Â’˝
/*
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'',station_id,'',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code='02' and
             tr_type_id='54' and paymode_id='18'
       group by line_id,station_id;*/
       /*--V1.3
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'',station_id,'',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07') and
             tr_type_id='54' and paymode_id='18'
       group by line_id,station_id;*/
       --v1.31
       insert into  t#OP_INC_STA_INCOME_RESULT
       select line_id,'',station_id,'',
       0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0,0
       from t#OP_INC_STA_INCOME_RPT
       where card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
             tr_type_id='54' and paymode_id='18'
       group by line_id,station_id;
--≥« –Õ®≥Â’˝
    insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),0,0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  card_main_code='06' and
               tr_type_id='54' and paymode_id='18'
        group by line_id,station_id;
---------------------------------------––’˛¥¶¿Ì--
--√‚∑—Ω¯≥ˆ’æ∆± ˝¡ø
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='61' and do_type in('02','04')
        group by line_id,station_id;
--∏∂∑—≥ˆ’æ∆± ˝¡ø
 insert into  t#OP_INC_STA_INCOME_RESULT
        select line_id,'',station_id,'',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_num),0,0,0,0,0,0,0,0
        from t#OP_INC_STA_INCOME_RPT
        where tr_type_id='61' and do_type='03'
        group by line_id,station_id;
--––’˛ ¬ŒÒ ’»Î
--––’˛ ¬ŒÒ÷ß≥ˆ
insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee),sum(return_bala),0,0,0,0,0,0
     from t#OP_INC_STA_INCOME_RPT
          where tr_type_id='61'
          group by line_id,station_id;
----------------------------------------ÕÀøÓ----------------------------------------------
--—∫Ω
--”‡∂Ó
--¥¢÷µ∆±≥À≥µø€
--¥¢÷µ∆±≥À≥µø€
/*
  insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03') and
                 tr_type_id='57'
          group by line_id,station_id;*/
   /*--V1.3
   insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','03','07') and
                 tr_type_id='57'
          group by line_id,station_id;  */
          --v1.31
          --¥¢÷µ∆±°¢ ÷ª˙∆±°¢“Ï–Œø®
          insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          0,0,0,0,0,
          sum(deal_fee),sum(return_bala),sum(penalty),0,0,0
          from t#OP_INC_STA_INCOME_RPT
          where  card_main_code in ('02','07','08','09') and --‘ˆº”¥≈∏°∆±
                 tr_type_id='57'
          group by line_id,station_id;
--µ•≥Ã∆±ÕÀøÓ
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(return_bala),0,0
         from t#OP_INC_STA_INCOME_RPT
          where card_main_code='01' and
                tr_type_id='57'
          group by line_id,station_id;
--ÕÀøÓ–°º∆
     insert into  t#OP_INC_STA_INCOME_RESULT
          select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(deal_fee+return_bala-penalty),0
         from t#OP_INC_STA_INCOME_RPT
        where  tr_type_id='57'
        group by line_id,station_id;
------------------------------------------”¶ ’Ω∂Ó
--ºı»•∏¸’˝∑«œ÷Ω luck 20170801
insert into t#OP_INC_STA_INCOME_RESULT
  select line_id,'',station_id,'',
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,sum(sale_total+add_total+fee_total+update_total-update_dc2-update_dt2-update_oct2-cut_oct-cut_dt+affair_penalty-affair_return-ret_total)
  from t#OP_INC_STA_INCOME_RESULT
             group by line_id,station_id;
--∏¸–¬’æ√˚
--»•µÙ’æµ„«∞µƒ ˝◊÷±‡∫≈
update t#OP_INC_STA_INCOME_RESULT a
set a.station_name =(
select  /*'('||c.line_id||b.sequence||')'||*/b.chinese_name
from op_prm_station b,op_prm_line c
where b.record_flag='0' and c.record_flag='0' and a.line_id=b.line_id and a.station_id=b.station_id and a.line_id=c.line_id);
-------------------------------------œﬂ¬∑–°º∆
--»•µÙ∫œº∆«∞µƒ ˝◊÷±‡∫≈
        insert into  t#OP_INC_STA_INCOME_RESULT
          select a.line_id,'','99', /*'('||b.line_id||'99'||b.line_name||')'||*/b.line_name||'∫œº∆',
          sum(tvm_sale),
          sum(bom_sale),
          sum(sale_total),
          sum(tvm_add),
          sum(bom_add),
          sum(add_total),
          sum(fee_total),
          sum(update_dc),
          sum(update_dt),
          sum(update_oct),
          sum(update_dc2),
          sum(update_dt2),
          sum(update_oct2),
          sum(update_total),
          sum(cut_dt),
          sum(cut_oct),
          sum(affair_02),
          sum(affair_03),
          sum(affair_penalty),
          sum(affair_return),
          sum(ret_desosit),
          sum(ret_bala),
          sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
          sum(ret_sjt),
          sum(ret_total),
          sum(total)
          from t#OP_INC_STA_INCOME_RESULT a,op_prm_line b
          where a.line_id=b.line_id and b.record_flag='0'
          group by    a.line_id,b.line_id,b.line_name;
------------------------------------◊‹º∆
        insert into  t#OP_INC_STA_INCOME_RESULT
          select '99','','99','◊‹º∆',
       sum(tvm_sale),
       sum(bom_sale ),
       sum(sale_total),
       sum(tvm_add  ),
       sum(bom_add ),
       sum(add_total),
       sum(fee_total ),
       sum(update_dc ),
       sum(update_dt ),
       sum(update_oct ),
       sum(update_dc2 ),
       sum(update_dt2 ),
       sum(update_oct2),
       sum(update_total),
       sum(cut_dt),
       sum(cut_oct),
       sum(affair_02),
       sum(affair_03),
       sum(affair_penalty),
       sum(affair_return),
       sum(ret_desosit),
       sum(ret_bala),
       sum(penalty), --–¬‘ˆ≥À≥µø€øÓ
       sum(ret_sjt),
       sum(ret_total),
       sum(total)
       from t#OP_INC_STA_INCOME_RESULT
       where station_id<>'99';
--∑µªÿΩ·π˚
open out_cursor for
select   v_squad_day||v_balance_day mon,line_id,station_id,station_name,
      sum(tvm_sale)          tvm_sale,
      sum(bom_sale )         bom_sale,
      sum(sale_total)        sale_total,
      sum(tvm_add)           tvm_add  ,
      sum(bom_add )          bom_add ,
      sum(add_total)         add_total,
      sum(fee_total)         fee_total ,
      sum(update_dc)         update_dc ,
      sum(update_dt)         update_dt ,
      sum(update_oct)        update_oct ,
      sum(update_dc2)        update_dc2 ,
      sum(update_dt2)        update_dt2 ,
      sum(update_oct2)       update_oct2 ,
      sum(update_total)      update_total,
      sum(cut_dt)            cut_dt,
      sum(cut_oct)           cut_oct,
      sum(affair_02)         affair_02,
      sum(affair_03)         affair_03  ,
      sum(affair_penalty)    affair_penalty,
      sum(affair_return)     affair_return,
      sum(ret_desosit)       ret_desosit,
      sum(ret_bala)          ret_bala,
      sum(penalty)           penalty,
      sum(ret_sjt)           ret_sjt,
      sum(ret_total)         ret_total,
      sum(total)             total
      from t#OP_INC_STA_INCOME_RESULT
      group by line_id,station_id,station_name
      order by line_id,station_id,station_name;
      end;
/
grant execute on ACC_ST.UP_OP_INC_STA_INCOME_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_STA_INCOME_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_DISCOUNT_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_DISCOUNT_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ œﬂ¬∑≥µ’æø€øÓÕ≥º∆»’±®  £®≤È—ØÀ˘”–œﬂ¬∑£©
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_013
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(8);
v_balance_day char(8);
BEGIN
     v_squad_day:=substr(in_squad_day,1,8);
     v_balance_day:=substr(in_balance_day,1,8);
      ----≤È—Ø ˝æ› »°≥ˆ¬˙◊„Ãıº˛µƒÀ˘”– ˝æ›
      insert into t#OP_INC_STA_DISCOUNT_rpt
      (squad_day,line_id,card_main_id,card_sub_id,income,deal_num)
      select squad_day,line_id,card_main_id,
      case when card_main_id='06' then '00' else card_sub_id end,
             sum(deal_fee),sum(deal_num)
      from st_sts_inc_consume
      where balance_water_no>= v_balance_day||'00'
            and balance_water_no<=v_balance_day||'99'
            and substr(squad_day,1,8)=v_squad_day
      group by squad_day,line_id,station_id,card_main_id,card_sub_id;
----ππΩ®Ω·π˚ºØΩ·ππ
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'1',' ˝¡ø',0.00
      from op_prm_line a,op_prm_card_sub b
      where a.record_flag=0 and b.record_flag=0;
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'2','Ω∂Ó',0.00
      from op_prm_line a,op_prm_card_sub b
      where a.record_flag=0 and b.record_flag=0;
      --œÚΩ·π˚ºØÃÌº” ˝æ› Ω´01 ˝¡ø∫Õ02Ω∂Ó∑÷±≤Â»Î £®±„”⁄Ωª≤Ê±Ì£©
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,card_main_id,card_sub_id;
           insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,card_main_id,card_sub_id;
--≤Â»Îƒ©––◊‹º∆
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,line_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','∫œº∆',card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,line_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','∫œº∆',card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
      --∏¸–¬œﬂ¬∑√˚
      update t#OP_INC_STA_DISCOUNT_result a
      set a.line_name=(
      select b.sequence||b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0')
      where line_id!='99';
      --∏¸–¬∆±ø®√˚≥∆
      update t#OP_INC_STA_DISCOUNT_result a
      set a.card_name=(
      select b.card_sub_name from op_prm_card_sub b
      where a.card_main_id=b.card_main_id
        and a.card_sub_id=b.card_sub_id
        and b.record_flag='0')
        where card_main_id!='06';
      update t#OP_INC_STA_DISCOUNT_result
      set card_name='≥« –Õ®∆±' where card_main_id='06';
      --∑µªÿΩ·π˚ºØ
      open out_cursor for
      select v_squad_day||v_balance_day day,line_name linename,card_main_id||card_sub_id||card_name card_name,disc_name,num
      from t#OP_INC_STA_DISCOUNT_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_SYS_DISCOUNT_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_DISCOUNT_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_DISCOUNT_M
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_DISCOUNT_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
--------------------------------------------------------------
--π¶ƒ‹£∫œ˙ € ’“Ê¿‡ œﬂ¬∑≥µ’æø€øÓÕ≥º∆»’±®  £®≤È—ØÀ˘”–œﬂ¬∑£©
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130830
--∂‘”¶ƒ£∞Â£∫rpt_02_014
--------------------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(6);
v_balance_day char(6);
    BEGIN
     v_squad_day:=substr(in_squad_day,1,6);
     v_balance_day:=substr(in_balance_day,1,6);
      ----≤È—Ø ˝æ› »°≥ˆ¬˙◊„Ãıº˛µƒÀ˘”– ˝æ›
      insert into t#OP_INC_STA_DISCOUNT_rpt
      (squad_day,line_id,card_main_id,card_sub_id,income,deal_num)
      select squad_day,line_id,card_main_id,
      case when card_main_id='06' then '00' else card_sub_id end,
             sum(deal_fee),sum(deal_num)
      from st_sts_inc_consume
      where balance_water_no>= v_balance_day||'0100'
            and balance_water_no<=v_balance_day||'3199'
            and substr(squad_day,1,6)=v_squad_day
      group by squad_day,line_id,station_id,card_main_id,card_sub_id;
----ππΩ®Ω·π˚ºØΩ·ππ
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'1',' ˝¡ø',0.00
      from op_prm_line a,op_prm_card_sub b
      where a.record_flag=0 and b.record_flag=0;
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select a.line_id,b.card_main_id,case when b.card_main_id='06' then '00' else b.card_sub_id end,'2','Ω∂Ó',0.00
      from op_prm_line a,op_prm_card_sub b
      where a.record_flag=0 and b.record_flag=0;
      --œÚΩ·π˚ºØÃÌº” ˝æ› Ω´01 ˝¡ø∫Õ02Ω∂Ó∑÷±≤Â»Î £®±„”⁄Ωª≤Ê±Ì£©
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,card_main_id,card_sub_id;
           insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,card_main_id,card_sub_id,disc_code,disc_name,num)
      select line_id,card_main_id,card_sub_id,'2','Ω∂Ó',sum(income)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by line_id,card_main_id,card_sub_id;
--≤Â»Îƒ©––◊‹º∆
      insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,line_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','∫œº∆',card_main_id,card_sub_id,'1',' ˝¡ø',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
            insert into t#OP_INC_STA_DISCOUNT_result
      (line_id,line_name,card_main_id,card_sub_id,disc_code,disc_name,num)
      select '99','∫œº∆',card_main_id,card_sub_id,'2','Ω∂Ó',sum(deal_num)
      from t#OP_INC_STA_DISCOUNT_rpt
      group by card_main_id,card_sub_id;
      --∏¸–¬œﬂ¬∑√˚
      update t#OP_INC_STA_DISCOUNT_result a
      set a.line_name=(
      select b.sequence||b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0')
      where line_id!='99';
      --∏¸–¬∆±ø®√˚≥∆
      update t#OP_INC_STA_DISCOUNT_result a
      set a.card_name=(
      select b.card_sub_name from op_prm_card_sub b
      where a.card_main_id=b.card_main_id
        and a.card_sub_id=b.card_sub_id and b.record_flag='0')
        where card_main_id!='06';
      update t#OP_INC_STA_DISCOUNT_result
      set card_name='≥« –Õ®∆±' where card_main_id='06';
      --∑µªÿΩ·π˚ºØ
      open out_cursor for
      select v_squad_day||v_balance_day mon,line_name linename,card_main_id||card_sub_id||card_name card_name,disc_name,num
      from t#OP_INC_STA_DISCOUNT_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_SYS_DISCOUNT_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_DISCOUNT_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_RETURN_D
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_RETURN_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_007
--π¶ƒ‹√Ë ˆ£∫ÕÀøÓÕ≥º∆»’±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
----------------------------------------------------------------
AS
 v_squad_date           char(8);
 v_balance_date         char(8);
    BEGIN
    v_squad_date:=substr(in_squad_day,1,8);
    v_balance_date:=substr(in_balance_day,1,8);
    ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and substr(squad_day,1,8)=v_squad_date
 and card_main_id in('01','02','03');
   --ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '1','∞Ï¿Ì ˝¡ø',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '2','ÕÀªπ—∫Ω',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '3','’€À ˝¡ø',0
  from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
 insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '4','ÕÀªπ”‡∂Ó',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
 ----------≤Â»ÎΩ·π˚ºØ --∞¥∆±ø® Ù–‘£®1∞Ï¿Ì ˝¡ø2ÕÀªπ—∫Ω3’€À ˝¡ø4ÕÀªπ”‡∂Ó£©∑÷¿‡
  insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
      insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
      -- ≤Â»ÎŒ≤¡––°º∆
           insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,'99','99',
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
      insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,'99','99',
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,'99','99',
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,'99','99',
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
----…æ≥˝µ•≥Ã∆±µƒ’€À ˝¡ø∫ÕÕÀªπ”‡∂Ó
 delete t#op_inc_sys_return_result where card_main_code='01' and return_code in('3','2');
 update t#op_inc_sys_return_result set return_para='ÕÀªπΩ∂Ó' where card_main_code='01' and return_code='2' ;
-------∏¸–¬
        --∏¸–¬œﬂ¬∑√˚
   update t#op_inc_sys_return_result a
   set a.line_name=(
   select b.sequence||b.line_name from op_prm_line  b where a.line_id=b.line_id and b.record_flag='0');
      --∏¸–¬ÕÀ∆±∑Ω Ω√˚
     update t#op_inc_sys_return_result a
   set a.return_name=(
   select b.return_name from st_cod_return_type  b where a.return_type=b.return_type);
   --∏¸–¬∆±ø®√˚≥∆
    update t#op_inc_sys_return_result a
   set a.card_name=(
       select b.card_sub_name
  from op_prm_card_sub b where b.record_flag='0' and a.card_main_code||a.card_sub_code=b.card_main_id||b.card_sub_id)
   where a.card_main_code!='99' and a.card_main_code!='06';
   update t#op_inc_sys_return_result
   set card_name='≥« –Õ®∆±' where card_main_code='06';
   update t#op_inc_sys_return_result
   set card_name='∫œº∆',card_main_code='',card_sub_code='' where card_main_code='99';
open out_cursor for
select v_squad_date||v_balance_date day,line_name linename,return_type||return_name returnname,card_main_code||card_sub_code||card_name cardname,return_code||return_para return_cardpara,return_value
 from t#op_inc_sys_return_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_SYS_RETURN_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_RETURN_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_RETURN_M
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_RETURN_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-----------------------------------------------------------------------------------------
--π¶ƒ‹£∫œﬂÕ¯ÕÀøÓÕ≥º∆‘¬±® œ˙ € ’“Ê¿‡±®±Ì
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥¡¢ ±º‰£∫20130830
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_008
-----------------------------------------------------------------------------------------
AS
 v_squad_date           char(6);       -- ‘À”™‘¬
 v_balance_date         char(6);
    BEGIN
    v_squad_date:=substr(in_squad_day,1,6);
    v_balance_date:=substr(in_balance_day,1,6);
     ----------≤È—Ø ˝æ›
 insert into t#op_inc_sys_return_rpt
      (line_id,station_id,return_type,card_main_code,card_sub_code,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
 select line_id,station_id,return_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
 from st_sts_inc_return
 where  balance_water_no>= v_balance_date||'0001'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 and card_main_id in('01','02','03');
  --ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '1','∞Ï¿Ì ˝¡ø',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '2','ÕÀªπ—∫Ω',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '3','’€À ˝¡ø',0
  from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
 insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
  select a.line_id,b.return_type,c.card_main_id,case when c.card_main_id='06' then '00' else c.card_sub_id end,
 '4','ÕÀªπ”‡∂Ó',0
 from op_prm_station a,st_cod_return_type b,op_prm_card_sub c
 where a.record_flag='0' and c.record_flag='0' and c.card_main_id in('01','02','03');
 ----------≤Â»ÎΩ·π˚ºØ --∞¥∆±ø® Ù–‘£®1∞Ï¿Ì ˝¡ø2ÕÀªπ—∫Ω3’€À ˝¡ø4ÕÀªπ”‡∂Ó£©∑÷¿‡
  insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
      insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,return_code,return_para,return_value)
 select line_id,return_type,card_main_code,card_sub_code,
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type,card_main_code,card_sub_code;
      -- ≤Â»ÎŒ≤¡––°º∆
           insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,return_type,'99','99','∫œº∆',
 '1','∞Ï¿Ì ˝¡ø',sum(return_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
      insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,return_type,'99','99','∫œº∆',
 '2','ÕÀªπ—∫Ω',sum(return_deposit_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,return_type,'99','99','∫œº∆',
 '3','’€À ˝¡ø',sum(bad_num)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
       insert into t#op_inc_sys_return_result
      (line_id,return_type,card_main_code,card_sub_code,card_name,return_code,return_para,return_value)
 select line_id,return_type,'99','99','∫œº∆',
'4','ÕÀªπ”‡∂Ó',sum(return_balance_fee)
 from t#op_inc_sys_return_rpt
 group by line_id,return_type;
----…æ≥˝µ•≥Ã∆±µƒ’€À ˝¡ø∫ÕÕÀªπ”‡∂Ó
 delete t#op_inc_sys_return_result where card_main_code='01' and return_code in('3','2');
 update t#op_inc_sys_return_result set return_para='ÕÀªπΩ∂Ó' where card_main_code='01' and return_code='2' ;
-------∏¸–¬
        --∏¸–¬œﬂ¬∑√˚
   update t#op_inc_sys_return_result a
   set a.line_name=(
   select b.sequence||b.line_name from op_prm_line  b where a.line_id=b.line_id and b.record_flag='0');
     --∏¸–¬ÕÀ∆±∑Ω Ω√˚
     update t#op_inc_sys_return_result a
   set a.return_name=(
   select b.return_name from st_cod_return_type  b where a.return_type=b.return_type);
   --∏¸–¬∆±ø®√˚≥∆
    update t#op_inc_sys_return_result a
   set a.card_name=(
       select b.card_sub_name
  from op_prm_card_sub b where b.record_flag='0' and a.card_main_code||a.card_sub_code=b.card_main_id||b.card_sub_id)
   where a.card_main_code!='99' and a.card_main_code!='06';
   update t#op_inc_sys_return_result
   set card_name='≥« –Õ®∆±' where card_main_code='06';
open out_cursor for
select v_squad_date||v_balance_date day,line_name linename,return_type||return_name returnname,card_main_code||card_sub_code||card_name cardname,return_code||return_para return_cardpara,return_value
 from t#op_inc_sys_return_result;
    END;
/
grant execute on ACC_ST.UP_OP_INC_SYS_RETURN_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_RETURN_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_SALES_YEAR
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_SALES_YEAR (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SYS_SALES_YEAR
--ƒ£∞Â√˚£∫rpt_02_003
--π¶ƒ‹√Ë ˆ£∫œﬂÕ¯≥µ∆±œ˙ €Õ≥º∆ƒÍ±®£®∫¨∑¢ €°¢∏¸–¬°¢ÕÀøÓ£©
--¥¥Ω®’ﬂ£∫ wangkejia
--¥¥Ω®»’∆⁄£∫20130909
-------------------------------------------------------------------------------
AS
        v_squad_day char(4);
        v_balance_day char(4);
    BEGIN
    v_squad_day:=substr(in_squad_day,1,4);
    v_balance_day:=substr(in_balance_day,1,4);
   --≤È—Ø ˝æ›
        insert into t#op_inc_sales_year_rpt
              (line_id,tr_type_id,card_main_id,card_sub_id,deal_num,deal_fee)
        select line_id,tr_type_id,card_main_id,  case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,deal_num,deal_fee
        from st_sts_inc_station
        where balance_water_no>=v_balance_day||'010100'
        and balance_water_no<=v_balance_day||'123199'
        and substr(squad_day,1,4)=v_squad_day
        and tr_type_id in('51','56','57');
   --≤Â»ÎΩ·π˚ºØ
 insert into  t#op_inc_sales_year_result
        (line_id,line_name,tr_type_id,tr_type_name,card_main_id,card_sub_id,card_name,deal_code,num)
    select   a.line_id,b.sequence||b.line_name,a.tr_type_id,'',a.card_main_id,
    case when a.card_main_id='06' then '00' else a.card_sub_id end,
    '','1 ˝¡ø',sum(deal_num)
    from t#op_inc_sales_year_rpt a,op_prm_line b
    where a.line_id=b.line_id and b.record_flag='0'
    group by  a.line_id,b.sequence,b.line_name,a.tr_type_id,a.card_main_id,a.card_sub_id;
     insert into  t#op_inc_sales_year_result
        (line_id,line_name,tr_type_id,tr_type_name,card_main_id,card_sub_id,card_name,deal_code,num)
    select   a.line_id,b.sequence||b.line_name,a.tr_type_id,'',a.card_main_id,case when a.card_main_id='06' then '00' else a.card_sub_id end,
    '','2Ω∂Ó',sum(deal_fee)
    from t#op_inc_sales_year_rpt a,op_prm_line b
    where a.line_id=b.line_id and b.record_flag='0'
     group by  a.line_id,b.sequence,b.line_name,a.tr_type_id,a.card_main_id,a.card_sub_id;
    --≤Â»ÎŒ≤¡–∫œº∆
    insert into  t#op_inc_sales_year_result
        (line_id,line_name,tr_type_id,tr_type_name,card_main_id,card_sub_id,card_name,deal_code,num)
    select   a.line_id,b.sequence||b.line_name,a.tr_type_id,'','99','99','∫œº∆','1 ˝¡ø',sum(deal_num)
    from t#op_inc_sales_year_rpt a,op_prm_line b
    where a.line_id=b.line_id and b.record_flag='0'
    group by a.line_id,b.sequence,b.line_name,a.tr_type_id;
        insert into  t#op_inc_sales_year_result
        (line_id,line_name,tr_type_id,tr_type_name,card_main_id,card_sub_id,card_name,deal_code,num)
    select   a.line_id,b.sequence||b.line_name,a.tr_type_id,'','99','99','∫œº∆','2Ω∂Ó',sum(deal_fee)
    from t#op_inc_sales_year_rpt a,op_prm_line b
    where a.line_id=b.line_id and b.record_flag='0'
    group by a.line_id,b.sequence,b.line_name,a.tr_type_id;
    --∏¸–¬œ˙ €∑Ω Ω
    update t#op_inc_sales_year_result a
    set tr_type_name='∑¢ €'
    where tr_type_id='51';
    update t#op_inc_sales_year_result a
    set tr_type_name='∏¸–¬'
    where tr_type_id='56';
    update t#op_inc_sales_year_result a
    set tr_type_name='ÕÀøÓ'
    where tr_type_id='57';
    --∏¸–¬∆±ø®√˚
    update t#op_inc_sales_year_result a
    set card_name=(
     select card_sub_name from op_prm_card_sub b
     where b.card_main_id=a.card_main_id
     and b.card_sub_id=a.card_sub_id
     and b.record_flag='0')
    where card_main_id not in('06','99');
     update t#op_inc_sales_year_result a
    set card_name='≥« –Õ®∆±',card_sub_id='00'
    where card_main_id='06';
    open out_cursor for
    select v_balance_day||v_squad_day year,line_name,tr_type_name,card_main_id||card_sub_id||card_name cardname,deal_code,num
    from t#op_inc_sales_year_result
    order by line_name asc,tr_type_name asc,card_main_id asc,card_sub_id asc,deal_code desc;
    END;
/
grant execute on ACC_ST.UP_OP_INC_SYS_SALES_YEAR to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_SALES_YEAR to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_SALE_D
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_SALE_D (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SYS_SALE_D
--∂‘”¶ƒ£∞Â£rrpt_02_001
--π¶ƒ‹√Ë ˆ:≥µ∆±∑¢ €Õ≥º∆»’±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_squad_date           char(8);       -- ‘À”™»’
   v_balance_date         char(8);       --«ÂÀ„»’
    BEGIN
     v_balance_date:=substr(in_balance_day,1,8);
     v_squad_date:=substr(in_squad_day,1,8);
 -----≤È—Øœ‡πÿ ˝æ›
 insert into t#OP_SYS_SALE_rpt
 (line_id,dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,charge_fee)
 select line_id,dev_type_id,pay_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,sum(sale_num),sum(deposit_fee),sum(charge_fee)
                from st_sts_inc_sale
                where balance_water_no>= v_balance_date||'00' and balance_water_no<=v_balance_date||'99' and squad_day=v_squad_date
                and dev_type_id in ('03','02')
                group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
 ----ππΩ®Ω·π˚ºØΩ·ππ
     insert into t#OP_SYS_SALE_result
    (line_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,b.dev_type_id,c.payment_id,card_main_id,card_sub_id,'1','1 ˝¡ø',0
                from op_prm_line a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d
                where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
      insert into t#OP_SYS_SALE_result
    (line_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,b.dev_type_id,c.payment_id,card_main_id,card_sub_id,'2','2—∫Ω',0
                from op_prm_line a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d
                where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
       insert into t#OP_SYS_SALE_result
    (line_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,b.dev_type_id,c.payment_id,card_main_id,card_sub_id,'3','3≥‰÷µ',0
                from op_prm_line a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d
                where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in('02','03')
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
--∑÷±≤Â»Î∆±ø®»˝÷÷ Ù–‘µƒ÷µ :  ˝¡ø01 —∫Ω02 ≥‰÷µ03 µ•≥Ã∆±Ω∂Ó04
---- ˝¡ø1
    insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'',card_main_id,card_sub_id,'','1','1 ˝¡ø',sum(sale_num)
                from t#OP_SYS_SALE_rpt
                group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
--≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','1','1 ˝¡ø',sum(sale_num)
                from t#OP_SYS_SALE_rpt
              group by  line_id,dev_type_id,pay_type;
    -- —∫Ω2
                    insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'',card_main_id,card_sub_id,'','2','2—∫Ω',sum(deposit_fee)
                from t#OP_SYS_SALE_rpt
               group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
                             --≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','2','2—∫Ω',sum(deposit_fee)
               from t#OP_SYS_SALE_rpt
              group by  line_id,dev_type_id,pay_type;
  ---  ≥‰÷µ3
                        insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'',card_main_id,card_sub_id,'','3','3≥‰÷µ',sum(charge_fee)
                from t#OP_SYS_SALE_rpt
              group by  line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
                --≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','3','3≥‰÷µ',sum(charge_fee)
                from t#OP_SYS_SALE_rpt where card_main_id!='01'--µ•≥Ã∆±Ω∂Ó¡ÌÕ‚Õ≥º∆
              group by  line_id,dev_type_id,pay_type;

  -- 4µ•≥Ã∆±Ω∂Ó–°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','','','∫œº∆','4','4Ω∂Ó',sum(charge_fee)
                from t#OP_SYS_SALE_rpt where card_main_id='01'--µ•≥Ã∆±Ω∂Ó¡ÌÕ‚Õ≥º∆
              group by  line_id,dev_type_id,pay_type;

                --∏¸–¬’æµ„
             update t#OP_SYS_SALE_result a
             set a.line_name=(
             select b.sequence||b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0');
             --∏¸–¬…Ë±∏√˚
              update t#OP_SYS_SALE_result a
             set a.dev_name=(
             select dev_type_name from op_prm_dev_type b
             where a.dev_type_id=b.dev_type_id and b.record_flag='0');
             --∏¸–¬÷ß∏∂∑Ω Ω√˚
             update t#OP_SYS_SALE_result a
             set a.payment_name=(
             select b.payment_name from st_cod_payment b
             where a.payment_id=b.payment_id);
             --∏¸–¬∆±ø®√˚≥∆
             update t#OP_SYS_SALE_result a
             set a.card_name=(
            select card_sub_name from op_prm_card_sub b
            where b.card_main_id=a.card_main_code and b.card_sub_id=a.card_sub_code and b.record_flag='0')
             where a.card_main_code!=' '
             and a.card_main_code!='06';
             update t#OP_SYS_SALE_result a
             set a.card_name='≥« –Õ®∆±',a.card_sub_code='00'
             where a.card_main_code='06';

             --update t#OP_SYS_SALE_result set card_main_code=null,card_sub_code=null where card_main_code='99';
             --∏¸–¬∆±ø® Ù–‘√˚
             update t#OP_SYS_SALE_result
             set sale_name='2Ω∂Ó'  where sale_code='3' and card_main_code='01'
             and card_sub_code='00';
             delete t#OP_SYS_SALE_result where sale_code='2' and card_main_code='01' and card_sub_code='00';
             --∑µªÿΩ·π˚ºØ
open out_cursor for
select v_squad_date||v_balance_date day,line_name linename,dev_name,payment_name,card_main_code||card_sub_code||card_name cardname,sale_code,sale_name,sum(num)
from t#OP_SYS_SALE_result
group by line_id,line_name,dev_name,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name
order by line_name,dev_name,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name;
end;
/
grant execute on ACC_ST.UP_OP_INC_SYS_SALE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_SALE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_SALE_M
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_SALE_M (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_SYS_SALE_M
--∂‘”¶ƒ£∞Â£trpt_02_002
--π¶ƒ‹√Ë ˆ:≥µ∆±∑¢ €Õ≥º∆‘¬±®-∞¥œµÕ≥/œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_squad_date           char(6);       -- ‘À”™»’
   v_balance_date         char(6);
    BEGIN

     v_balance_date:=substr(in_balance_day,1,6);
     v_squad_date:=substr(in_squad_day,1,6);
     
 -----≤È—Øœ‡πÿ ˝æ›
 insert into t#OP_SYS_SALE_rpt
 (line_id,dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,charge_fee)
 select line_id,dev_type_id,pay_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,sum(sale_num),sum(deposit_fee),sum(charge_fee)
                from st_sts_inc_sale    
                where balance_water_no>= v_balance_date||'0100' and balance_water_no<=v_balance_date||'3199' and substr(squad_day,1,6)=v_squad_date
                and dev_type_id in ('03','02')
                group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
 
 ----ππΩ®Ω·π˚ºØΩ·ππ
     insert into t#OP_SYS_SALE_result
    (line_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,b.dev_type_id,c.payment_id,card_main_id,card_sub_id,'1','1 ˝¡ø',0
                from op_prm_line a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d   
                where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in('02','03') 
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
      insert into t#OP_SYS_SALE_result
    (line_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,b.dev_type_id,c.payment_id,card_main_id,card_sub_id,'2','2—∫Ω',0
                from op_prm_line a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d   
                where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in('02','03') 
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
       insert into t#OP_SYS_SALE_result
    (line_id,dev_type_id,payment_id,card_main_code,card_sub_code,sale_code,sale_name,num)
                select a.line_id,b.dev_type_id,c.payment_id,card_main_id,card_sub_id,'3','3≥‰÷µ',0
                from op_prm_line a,op_prm_dev_type b,st_cod_payment c,op_prm_card_sub d   
                where a.record_flag='0' and b.record_flag='0' and b.dev_type_id in('02','03') 
                and c.payment_id in('01','02','03') and d.record_flag='0' and d.card_main_id!='05';
 
--∑÷±≤Â»Î∆±ø®»˝÷÷ Ù–‘µƒ÷µ :  ˝¡ø01 —∫Ω02 ≥‰÷µ03
---- ˝¡ø1
    insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'',card_main_id,card_sub_id,'','1','1 ˝¡ø',sum(sale_num)
                from t#OP_SYS_SALE_rpt    
                group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
--≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','99','99','–°º∆','1','1 ˝¡ø',sum(sale_num)
                from t#OP_SYS_SALE_rpt        
              group by  line_id,dev_type_id,pay_type;
                
    -- —∫Ω2           
                    insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'',card_main_id,card_sub_id,'','2','2—∫Ω',sum(deposit_fee)
                from t#OP_SYS_SALE_rpt 
               group by line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
               
                             --≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','99','99','–°º∆','2','2—∫Ω',sum(deposit_fee)
               from t#OP_SYS_SALE_rpt 
              group by  line_id,dev_type_id,pay_type;
                
  ---  ≥‰÷µ3           
                        insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'',card_main_id,card_sub_id,'','3','3≥‰÷µ',sum(charge_fee)
                from t#OP_SYS_SALE_rpt 
              group by  line_id,dev_type_id,pay_type,card_main_id,card_sub_id;
                
                --≤Â»ÎŒ≤¡––°º∆
                 insert into t#OP_SYS_SALE_result
    (line_id,line_name,dev_type_id,dev_name,payment_id,payment_name,card_main_code,card_sub_code,card_name,sale_code,sale_name,num)
                select line_id,'',dev_type_id,'',pay_type,'','99','99','–°º∆','3','3≥‰÷µ',sum(charge_fee)
                from t#OP_SYS_SALE_rpt 
              group by  line_id,dev_type_id,pay_type;
                
                --∏¸–¬’æµ„
             update t#OP_SYS_SALE_result a
             set a.line_name=(
             select b.sequence||b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0');
             --∏¸–¬…Ë±∏√˚
              update t#OP_SYS_SALE_result a
             set a.dev_name=(
             select dev_type_name from op_prm_dev_type b
             where a.dev_type_id=b.dev_type_id and record_flag='0');
             --∏¸–¬÷ß∏∂∑Ω Ω√˚
             update t#OP_SYS_SALE_result a
             set a.payment_name=(
             select b.payment_name from st_cod_payment b
             where a.payment_id=b.payment_id);
             --∏¸–¬∆±ø®√˚≥∆
              update t#OP_SYS_SALE_result a
             set a.card_name=(
            select card_sub_name from op_prm_card_sub b 
            where b.card_main_id=a.card_main_code and b.card_sub_id=a.card_sub_code and record_flag='0')
             where a.card_main_code!='99'
             and a.card_main_code!='06';
             
             update t#OP_SYS_SALE_result a
             set a.card_name='≥« –Õ®∆±',a.card_sub_code='00'
             where a.card_main_code='06';
             
             --∏¸–¬∆±ø® Ù–‘√˚
             update t#OP_SYS_SALE_result
             set sale_name='Ω∂Ó'  where sale_code='3' and card_main_code='01'
             and card_sub_code='00';
             
             --∑µªÿΩ·π˚ºØ
open out_cursor for
select v_squad_date||v_balance_date mon,line_name linename,dev_name,payment_name,card_main_code||card_sub_code||card_name card_name,sale_name,sum(num) 
from t#OP_SYS_SALE_result
group by line_id,line_name,dev_name,payment_name,card_main_code,card_sub_code,card_name,sale_name
order by line_name,dev_name,payment_name,card_main_code,card_sub_code,card_name,sale_name;

end;
/
grant execute on ACC_ST.UP_OP_INC_SYS_SALE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_SALE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_UPDATE_D
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_UPDATE_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_rpt_sale_sys_day
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_005
--π¶ƒ‹√Ë ˆ£∫≥µ∆±∏¸–¬Õ≥º∆»’±®-∞¥œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
------------------------------------------------------------------
AS
 v_squad_date           char(8);       -- ‘À”™»’
 v_balance_date         char(8);
 BEGIN
 v_squad_date:=substr(in_squad_day,1,8);
 v_balance_date:=substr(in_balance_day,1,8);
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›£¨∆±ø® Ù–‘£∫ ˝¡ø01∫ÕΩ∂Ó02∑÷±¥¶¿Ì
 insert into t#op_inc_sys_update_rpt
 (line_id,pay_type,card_main_id,card_sub_id,update_code,num)
 select line_id,pay_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,' ˝¡ø',sum(update_num)
 from st_sts_inc_update
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and squad_day=v_squad_date
 group by line_id,pay_type,card_main_id,card_sub_id;
  insert into t#op_inc_sys_update_rpt
 (line_id,pay_type,card_main_id,card_sub_id,update_code,num)
 select line_id,pay_type,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,'Ω∂Ó',sum(update_fee)
 from st_sts_inc_update
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and squad_day=v_squad_date
 group by line_id,pay_type,card_main_id,card_sub_id;
 ----ππΩ®Ω·π˚ºØΩ·ππ
   insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,update_name,num)
   select a.line_id,'01','œ÷Ω',c.card_main_id,case when c.card_main_id='06' then ' ' else c.card_sub_id end,' ˝¡ø',0
   from op_prm_line a,op_prm_card_sub c
   where a.record_flag='0' and c.record_flag='0' and card_main_id!='05';
   --Œ≤¡–∫œº∆
   insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,card_name,update_name,num)
   select a.line_id,'01','œ÷Ω','','','∫œº∆',' ˝¡ø',0
   from op_prm_line a
   where a.record_flag='0';

      insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,update_name,num)
   select a.line_id,'02','∆±ø®',c.card_main_id,case when c.card_main_id='06' then ' ' else c.card_sub_id end,'Ω∂Ó',0
   from op_prm_line a,op_prm_card_sub c
   where a.record_flag='0' and c.record_flag='0' and card_main_id!='05';
  --Œ≤¡–∫œº∆
     insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,card_name,update_name,num)
   select a.line_id,'02','∆±ø®','','','∫œº∆','Ω∂Ó',0
   from op_prm_line a
   where a.record_flag='0';
   --œÚΩ·π˚ºØ≤Â»Î ˝æ›
   insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','01','œ÷Ω',card_main_id,card_sub_id,'',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type='01'
   group by line_id,pay_type,card_main_id,card_sub_id,update_code;

   insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','02','∆±ø®',card_main_id,card_sub_id,'',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type in ('02','03')
   group by line_id,pay_type,card_main_id,card_sub_id,update_code;
   --≤Â»ÎŒ≤¡––°º∆
    insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','01','œ÷Ω','','','∫œº∆',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type='01'
   group by line_id,pay_type,update_code;
    insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','02','∆±ø®','','','∫œº∆',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type in('02','03')
   group by line_id,pay_type,update_code;
   --∏¸–¬œﬂ¬∑√˚
   update t#op_inc_sys_update_result a
   set a.line_name=(
   select b.sequence||b.line_name from op_prm_line  b where a.line_id=b.line_id and b.record_flag='0');
   --∏¸–¬∆±ø®√˚≥∆
    update t#op_inc_sys_update_result a
   set a.card_name=(
 select card_sub_name
  from op_prm_card_sub b where record_flag='0' and a.card_main_id=b.card_main_id and a.card_sub_id=b.card_sub_id and record_flag='0')
   where a.card_main_id!=' ';
   update t#op_inc_sys_update_result a
   set a.card_name='≥« –Õ®∆±',a.card_sub_id=' ' where card_main_id='06';
   open out_cursor for
   select v_squad_date||v_balance_date day,line_name,pay_name,card_main_id||card_sub_id||card_name card_name,update_code||update_name updatevalue,sum(num)
   from t#op_inc_sys_update_result
   group by line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_code,update_name
   order by line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name;
   end;
/
grant execute on ACC_ST.UP_OP_INC_SYS_UPDATE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_UPDATE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_SYS_UPDATE_M
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_SYS_UPDATE_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_rpt_sale_sys_day
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_006
--π¶ƒ‹√Ë ˆ£∫≥µ∆±∏¸–¬Õ≥º∆‘¬±®-∞¥œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
------------------------------------------------------------------
AS
 v_squad_date           char(6);       -- ‘À”™»’
 v_balance_date         char(6);
 BEGIN
 v_squad_date:=substr(in_squad_day,1,6);
 v_balance_date:=substr(in_balance_day,1,6);
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›£¨∆±ø® Ù–‘£∫ ˝¡ø01∫ÕΩ∂Ó02∑÷±¥¶¿Ì
 insert into t#op_inc_sys_update_rpt
 (line_id,pay_type,card_main_id,card_sub_id,update_code,num)
 select line_id,pay_type,card_main_id,case when card_main_id='06' then ' ' else card_sub_id end as card_sub_id,' ˝¡ø',sum(update_num)
 from st_sts_inc_update
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 group by line_id,pay_type,card_main_id,card_sub_id;
  insert into t#op_inc_sys_update_rpt
 (line_id,pay_type,card_main_id,card_sub_id,update_code,num)
 select line_id,pay_type,card_main_id,case when card_main_id='06' then ' ' else card_sub_id end as card_sub_id,'Ω∂Ó',sum(update_fee)
 from st_sts_inc_update
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date
 group by line_id,pay_type,card_main_id,card_sub_id;
 ----ππΩ®Ω·π˚ºØΩ·ππ
   insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,update_name,num)
   select a.line_id,'01','œ÷Ω',c.card_main_id,case when c.card_main_id='06' then ' ' else c.card_sub_id end,' ˝¡ø',0
   from op_prm_line a,op_prm_card_sub c
   where a.record_flag='0' and c.record_flag='0' and card_main_id!='05';
   --Œ≤¡–∫œº∆
   insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,card_name,update_name,num)
   select a.line_id,'01','œ÷Ω','','','∫œº∆',' ˝¡ø',0
   from op_prm_line a
   where a.record_flag='0';

      insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,update_name,num)
   select a.line_id,'02','∆±ø®',c.card_main_id,case when c.card_main_id='06' then ' ' else c.card_sub_id end,'Ω∂Ó',0
   from op_prm_line a,op_prm_card_sub c
   where a.record_flag='0' and c.record_flag='0' and card_main_id!='05';
  --Œ≤¡–∫œº∆
     insert into t#op_inc_sys_update_result
   (line_id,pay_type,pay_name£¨card_main_id,card_sub_id,card_name,update_name,num)
   select a.line_id,'02','∆±ø®','','','∫œº∆','Ω∂Ó',0
   from op_prm_line a
   where a.record_flag='0';
   --œÚΩ·π˚ºØ≤Â»Î ˝æ›
   insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','01','œ÷Ω',card_main_id,card_sub_id,'',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type='01'
   group by line_id,pay_type,card_main_id,card_sub_id,update_code;

   insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','02','∆±ø®',card_main_id,card_sub_id,'',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type in ('02','03')
   group by line_id,pay_type,card_main_id,card_sub_id,update_code;
   --≤Â»ÎŒ≤¡––°º∆
    insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','01','œ÷Ω','','','∫œº∆',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type='01'
   group by line_id,pay_type,update_code;
    insert into t#op_inc_sys_update_result
   (line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name,num)
   select line_id,'','02','∆±ø®','','','∫œº∆',update_code,sum(num)
   from t#op_inc_sys_update_rpt
   where pay_type in('02','03')
   group by line_id,pay_type,update_code;
   --∏¸–¬œﬂ¬∑√˚
   update t#op_inc_sys_update_result a
   set a.line_name=(
   select b.sequence||b.line_name from op_prm_line  b where a.line_id=b.line_id and b.record_flag='0');
   --∏¸–¬∆±ø®√˚≥∆
    update t#op_inc_sys_update_result a
   set a.card_name=(
 select card_sub_name
  from op_prm_card_sub b where record_flag='0' and a.card_main_id=b.card_main_id and a.card_sub_id=b.card_sub_id and record_flag='0')
   where a.card_main_id!=' ';
   update t#op_inc_sys_update_result a
   set a.card_name='≥« –Õ®∆±',a.card_sub_id=' ' where card_main_id='06';
   /*--∏¸–¬∆±ø® Ù–‘ 01Œ™ ˝¡ø 02Œ™Ω∂Ó
    update t#op_inc_sys_update_result a
   set a.update_name=' ˝¡ø' where a.update_code='01';
    update t#op_inc_sys_update_result a
   set a.update_name='Ω∂Ó' where a.update_code='02';*/
   open out_cursor for
   select v_squad_date||v_balance_date mon,line_name,pay_name,card_main_id||card_sub_id||card_name card_name,update_name updatevalue,sum(num)
   from t#op_inc_sys_update_result
   group by line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name
   order by line_id,line_name,pay_type,pay_name,card_main_id,card_sub_id,card_name,update_name;
   end;
/
grant execute on ACC_ST.UP_OP_INC_SYS_UPDATE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_SYS_UPDATE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_TK_DELAY_D
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_TK_DELAY_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-----------------------------------------------------------------
--π¶ƒ‹√Ë ˆ£∫≥¡µÌ◊ Ω»’Õ≥º∆±Ì
--∂‘”¶ƒ£∞Â£∫rpt_02_029
--¥¥Ω®’ﬂ£∫Õıø…º—
-- ±º‰£∫20130906
--π˝≥Ã√˚£∫UP_OP_INC_TK_DELAY_D
-----------------------------------------------------------------
AS
v_balance_day char(8);
v_squad_day   char(8);
    BEGIN
    v_balance_day:=substr(in_balance_day,1,8);
    v_squad_day:=substr(in_squad_day,1,8);
open out_cursor for
select  v_squad_day||v_balance_day day,a.card_main_id||case when a.card_main_id='06' then '00' else a.card_sub_id end||b.card_sub_name cardname,sum(a.total_num),sum(a.total_bal_fee),sum(a.total_deposit_fee)
from st_sts_inc_balance a,op_prm_card_sub b
where  substr(a.balance_water_no,1,8)=v_balance_day
and a.card_main_id=b.card_main_id
and a.card_sub_id=b.card_sub_id
and b.record_flag='0'
group by a.card_main_id,a.card_sub_id,b.card_sub_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_TK_DELAY_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_TK_DELAY_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_TK_DELAY_M
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_TK_DELAY_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
-----------------------------------------------------------------
--π¶ƒ‹√Ë ˆ£∫π˝∆⁄∆±”‡∂Ó‘¬Õ≥º∆±Ì
--∂‘”¶ƒ£∞Â£∫rpt_02_022
--¥¥Ω®’ﬂ£∫Õıø…º—
-- ±º‰£∫20130906
--π˝≥Ã√˚£∫UP_OP_INC_TK_DELAY_M
-----------------------------------------------------------------
AS
v_balance_day char(6);
v_squad_day   char(6);
 BEGIN
    v_balance_day:=substr(in_balance_day,1,6);
    v_squad_day:=substr(in_squad_day,1,6);
open out_cursor for
select  v_squad_day||v_balance_day day,a.card_main_id||case when a.card_main_id='06' then '00' else a.card_sub_id end||b.card_sub_name cardname,sum(a.total_num),sum(a.total_bal_fee),sum(a.total_deposit_fee)
from st_sts_inc_balance_expired a,op_prm_card_sub b
where  substr(a.balance_water_no,1,6)=v_balance_day
and substr(squad_day,1,6)=v_squad_day
and a.card_main_id=b.card_main_id
and a.card_sub_id=b.card_sub_id
and b.record_flag='0'
group by a.card_main_id,a.card_sub_id,b.card_sub_name;
    END;
/
grant execute on ACC_ST.UP_OP_INC_TK_DELAY_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_TK_DELAY_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_TVM_SALE_D
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_TVM_SALE_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------
--π¶ƒ‹√Ë ˆ£∫TVM ∑¢ €µ•≥Ã∆± ˝¡øÕ≥º∆»’±®
--∂‘”¶ƒ£∞Â£∫rpt_02_025
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130906
--------------------------------------------------
--------------------------------------------------
--∏¸∏ƒ’ﬂ£∫÷”◊”∆Ê
--∏¸∏ƒ»’∆⁄£∫20160628
--∏¸∏ƒƒ⁄»›£∫Œﬁ ˝æ› ±∑µªÿ“ªÃıø’º«¬º
--------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(8);
v_balance_day char(8);
v_fare int;
v_sqlcount INT;

    BEGIN
     v_line_id:= in_line_id;
     v_squad_day:=substr(in_squad_day,1,8);
     v_balance_day:=substr(in_balance_day,1,8);
     v_fare:=2;
  if v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
  end if;
    --≤È—Øœ‡πÿ ˝æ›
    insert into t#op_tvm_sale_rpt
    (line_id,station_id,sale_fee,sale_num)
    select line_id,station_id,sale_fee,sum(sale_num)
    from  ST_STS_INC_FARE
    where balance_water_no>= v_balance_day||'00'
            and balance_water_no<=v_balance_day||'99'
            and substr(squad_day,1,8)=v_squad_day
            and line_id=v_line_id
            and dev_type_id='02'
            and card_main_id='01'
            and card_sub_id='00'
    group by line_id,station_id,sale_fee;
    -- ˝æ›µº»ÎΩ·π˚ºØ
   while v_fare<=19
         loop
         /*
         insert into t#op_tvm_sale_result
         (line_id,station_id,station_name,sale_fee,sale_num)
         select b.line_id,b.station_id,b.sequence||b.chinese_name,lpad(v_fare,2,0),0
         from op_prm_station b
         where b.line_id=v_line_id and b.record_flag='0';
         */
         insert into t#op_tvm_sale_result
         (line_id,station_id,station_name,sale_fee,sale_num)
         select a.line_id,a.station_id,b.sequence||b.chinese_name,lpad(v_fare,2,0),sum(a.sale_num)
         from t#op_tvm_sale_rpt a,op_prm_station b
         where to_number(a.sale_fee,'99')=v_fare
         and a.station_id=b.station_id
         AND a.line_id=b.line_id
         and b.record_flag='0'
         group by a.line_id,a.station_id,b.sequence,b.chinese_name,a.sale_fee;
         v_fare:=v_fare+1;
         end loop;




         -----∫œº∆‘⁄ÀÆæß±®±Ì
         --≤È—ØΩ·π˚ºØ
       /*  open out_cursor for
         select v_balance_day||v_squad_day day,
         v_line_name linename,
         station_name,
         sale_fee||'‘™' as sale_
         fee,
         sale_num
         from t#op_tvm_sale_result;
       */
         --Œﬁ ˝æ› ±≤Â»Î“ªÃıø’º«¬º  modify by zzq
         select count(*) INTO v_sqlcount from  t#op_tvm_sale_result;
        IF v_sqlcount > 0  THEN
         open out_cursor for
           select
             v_balance_day||v_squad_day day,
             v_line_name linename,
             station_name,
             sale_fee||'‘™' as sale_fee,
             sale_num
           from t#op_tvm_sale_result;
        ELSE
         open out_cursor FOR
           select
             v_balance_day||v_squad_day day,
             v_line_name linename,
             ' ' station_name,
             NULL sale_fee,
             NULL sale_num
           from dual ;

        END IF;
    END;
/
grant execute on ACC_ST.UP_OP_INC_TVM_SALE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_TVM_SALE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_TVM_SALE_M
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_TVM_SALE_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------
--π¶ƒ‹√Ë ˆ£∫TVM ∑¢ €µ•≥Ã∆± ˝¡øÕ≥º∆‘¬±®
--∂‘”¶ƒ£∞Â£∫rpt_02_026
--¥¥Ω®’ﬂ£∫Õıø…º—
--¥¥Ω® ±º‰£∫20130906
--------------------------------------------------
--∏¸∏ƒ’ﬂ£∫÷‹—Ô
--∏¸∏ƒ»’∆⁄£∫20160630
--∏¸∏ƒƒ⁄»›£∫Œﬁ ˝æ› ±∑µªÿ“ªÃıø’º«¬º
--------------------------------------------------
AS
v_line_id char(2);
v_line_name varchar(20);
v_squad_day char(6);
v_balance_day char(6);
v_fare int;
v_count int;--2016.06.30 add by zhouyang
    BEGIN
     v_line_id:= in_line_id;
     v_squad_day:=substr(in_squad_day,1,6);
     v_balance_day:=substr(in_balance_day,1,6);
     v_fare:=2;
  if v_line_id!=' ' and v_line_id is not null then
     select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
  end if;
    --≤È—Øœ‡πÿ ˝æ›
    insert into t#op_tvm_sale_rpt
    (line_id,station_id,sale_fee,sale_num)
    select line_id,station_id,sale_fee,sum(sale_num)
    from ST_STS_INC_FARE
    where balance_water_no>= v_balance_day||'0100'
            and balance_water_no<=v_balance_day||'3199'
            and substr(squad_day,1,6)=v_squad_day
            and line_id=v_line_id
            and dev_type_id='02'
            and card_main_id='01'
            and card_sub_id='00'
    group by line_id,station_id,sale_fee;
    -- ˝æ›µº»ÎΩ·π˚ºØ
   while v_fare<=19
         loop
         /*insert into t#op_tvm_sale_result
         (line_id,station_id,station_name,sale_fee,sale_num)
         select b.line_id,b.station_id,b.sequence||b.chinese_name,lpad(v_fare,2,0),0
         from op_prm_station b
         where b.line_id=v_line_id and b.record_flag='0';*/
         insert into t#op_tvm_sale_result
         (line_id,station_id,station_name,sale_fee,sale_num)
         select a.line_id,a.station_id,b.sequence||b.chinese_name,to_number(a.sale_fee,'99'),sum(a.sale_num)
         from t#op_tvm_sale_rpt a,op_prm_station b
         where to_number(a.sale_fee,'99')=v_fare
         and a.station_id=b.station_id
         and a.line_id=b.line_id
         and b.record_flag='0'
         group by a.line_id,a.station_id,b.sequence,b.chinese_name,a.sale_fee;
         v_fare:=v_fare+1;
         end loop;
         ------------------
         --∫œº∆‘⁄ÀÆæß±®±Ì--
         ------------------
         --≤È—ØΩ·π˚ºØ
         select count(*) into v_count from t#op_tvm_sale_result;--2016.06.30 add by zhouyang
         if v_count > 0 then
               open out_cursor for
                    select v_balance_day||v_squad_day mon,v_line_name linename,station_name,sale_fee||'‘™' as sale_fee,sale_num
                    from t#op_tvm_sale_result;
         else--Œﬁ ˝æ› ±∑µªÿ“ªÃıø’º«¬º 2016.06.30 add by zhouyang
               open out_cursor for
                    select v_balance_day||v_squad_day mon,v_line_name linename,' ' station_name,' ' sale_fee,' ' sale_num
                    from dual;
         end if;
    END;
/
grant execute on ACC_ST.UP_OP_INC_TVM_SALE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_TVM_SALE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_UPDATE_SYS_D
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_UPDATE_SYS_D (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_UPDATE_SYS_D
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_005
--π¶ƒ‹√Ë ˆ£∫≥µ∆±∏¸–¬Õ≥º∆»’±®-∞¥œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
--–ﬁ∏ƒ 2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
------------------------------------------------------------------
-- –ﬁ∏ƒ»’∆⁄£∫20170210
-- –ﬁ∏ƒ’ﬂ£∫lucankun
-- –ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170220
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆœﬂ¬∑±®±Ì≤ªÕ≥º∆±Ìacc_st.OP_REPORT_LINE_NO_STAT£¨∆¡±Œ±Ì¿Ôœﬂ¬∑
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170722
--–ﬁ∏ƒ»À£∫yangze
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±ø®¿‡–Õ0901£¨t#op_inc_update_sys_result±Ì–¬‘ˆnum11°¢fee11◊÷∂Œ
------------------------------------------------------------------------------------
AS
 v_squad_date           char(8);       -- ‘À”™»’
 v_balance_date         char(8);
 BEGIN
 v_squad_date:=substr(in_squad_day,1,8);
 v_balance_date:=substr(in_balance_day,1,8);
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›£¨∆±ø® Ù–‘£∫ ˝¡ø01∫ÕΩ∂Ó02∑÷±¥¶¿Ì
 insert into t#op_inc_update_sys_rpt
 (line_id,tr_type_id,card_main_id,card_sub_id,deal_num,deal_fee)
 select line_id,case when pay_type='03' then '02' else pay_type end,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,update_num,update_fee
 from st_sts_inc_update
 where  balance_water_no>= v_balance_date||'00'
 and balance_water_no<=v_balance_date||'99'
 and squad_day=v_squad_date;
  ----pay_type='01'œ÷Ω£¨°Æ02°Ø¥¢÷µø®£¨°Æ03°Ø“ªø®Õ®£ªΩ´¥¢÷µø®∫Õ“ªø®Õ®…Ë≥…∆±ø®
----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_inc_update_sys_result
(line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select a.line_id,a.line_name,'01','œ÷Ω',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
      --and a.line_id!='82';-- 20170210 add by lucankun
       and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
insert into t#op_inc_update_sys_result
(line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select a.line_id,a.line_name,'02','∆±ø®',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
      --and a.line_id!='82';-- 20170210 add by lucankun
      and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
     --≤Â»ÎΩ·π˚ºØ
     insert into t#op_inc_update_sys_result
     (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='01' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='01';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='02';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='03';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='03' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='04' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='04' and card_sub_id='01';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='06' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='07' and card_sub_id='00';--2015-1-30‘ˆº”
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='08' and card_sub_id='00';--2015-1-30‘ˆº”
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='09' and card_sub_id='01';--2017-7-22‘ˆº”

        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee
       from t#op_inc_update_sys_rpt;
        --where card_main_id='01' and card_sub_id='00';
    --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_update_sys_result a
      set line_name=(
       select b.sequence||b.line_name from op_prm_line b
        where a.line_id=b.line_id and b.record_flag='0')
    where EXISTS (select 1 from op_prm_line b
        where a.line_id=b.line_id and b.record_flag='0');
    --∏¸–¬œ˙ €∑Ω Ω
    update t#op_inc_update_sys_result a
    set a.pay_name='œ÷Ω'
    where a.pay_type='01';
    update t#op_inc_update_sys_result a
    set a.pay_name='∆±ø®'
    where a.pay_type='02';
    open out_cursor for
    select v_balance_date||v_squad_date day,line_name,pay_name,
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_update_sys_result a
    group by line_name,pay_name
    order by line_name,pay_name desc;


    END;
/
grant execute on ACC_ST.UP_OP_INC_UPDATE_SYS_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_UPDATE_SYS_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_INC_UPDATE_SYS_M
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_INC_UPDATE_SYS_M (
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_INC_UPDATE_SYS_M
--∂‘”¶ƒ£∞Â√˚£∫rpt_02_006
--π¶ƒ‹√Ë ˆ£∫≥µ∆±∏¸–¬Õ≥º∆‘¬±®-∞¥œﬂ¬∑Õ≥º∆
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130828
--–ﬁ∏ƒ 2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
------------------------------------------------------------------
-- –ﬁ∏ƒ»’∆⁄£∫20170210
-- –ﬁ∏ƒ’ﬂ£∫lucankun
-- –ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
-----------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170220
--–ﬁ∏ƒ»À£∫lucankun
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆœﬂ¬∑±®±Ì≤ªÕ≥º∆±Ìacc_st.OP_REPORT_LINE_NO_STAT£¨∆¡±Œ±Ì¿Ôœﬂ¬∑
--------------------------------------------------------------------------------
--–ﬁ∏ƒ»’∆⁄£∫20170722
--–ﬁ∏ƒ»À£∫yangze
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°∆±ø®¿‡–Õ0901£¨t#op_inc_update_sys_result±Ì–¬‘ˆnum11°¢fee11◊÷∂Œ
------------------------------------------------------------------------------------
AS
 v_squad_date           char(6);       -- ‘À”™»’
 v_balance_date         char(6);
 BEGIN
 v_squad_date:=substr(in_squad_day,1,6);
 v_balance_date:=substr(in_balance_day,1,6);
 --œÚ¡Ÿ ±±Ì≤Â»Î ˝æ›£¨∆±ø® Ù–‘£∫ ˝¡ø01∫ÕΩ∂Ó02∑÷±¥¶¿Ì
 insert into t#op_inc_update_sys_rpt
 (line_id,tr_type_id,card_main_id,card_sub_id,deal_num,deal_fee)
 select line_id,case when pay_type='03' then '02' else pay_type end,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,update_num,update_fee
 from st_sts_inc_update
 where  balance_water_no>= v_balance_date||'0100'
 and balance_water_no<=v_balance_date||'3199'
 and substr(squad_day,1,6)=v_squad_date;
  ----pay_type='01'œ÷Ω£¨°Æ02°Ø¥¢÷µø®£¨°Æ03°Ø“ªø®Õ®£ªΩ´¥¢÷µø®∫Õ“ªø®Õ®…Ë≥…∆±ø®
----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_inc_update_sys_result
(line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select a.line_id,a.line_name,'01','œ÷Ω',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
      --and a.line_id!='82';-- 20170210 add by lucankun
      and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
insert into t#op_inc_update_sys_result
(line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select a.line_id,a.line_name,'02','∆±ø®',
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
      from op_prm_line a
      where a.record_flag='0'
      --and a.line_id!='82';-- 20170210 add by lucankun
      and a.line_id not in (select t.line_id from acc_st.OP_REPORT_LINE_NO_STAT t);--20170220 modify by lucankun
     --≤Â»ÎΩ·π˚ºØ
     insert into t#op_inc_update_sys_result
     (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='01' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='01';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='02';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='02' and card_sub_id='03';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='03' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='04' and card_sub_id='00';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='04' and card_sub_id='01';
        insert into t#op_inc_update_sys_result
        (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='06' and card_sub_id='00';
       insert into t#op_inc_update_sys_result
       (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='07' and card_sub_id='00';--2015-1-30‘ˆº”
       insert into t#op_inc_update_sys_result
       (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='08' and card_sub_id='00';--2015-1-30‘ˆº”
       insert into t#op_inc_update_sys_result
       (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee,0,0
       from t#op_inc_update_sys_rpt
        where card_main_id='09' and card_sub_id='01';--2017-7-22‘ˆº”

       insert into t#op_inc_update_sys_result
       (line_id,line_name,pay_type,pay_name,num0,fee0,num1,fee1,num2,fee2,num3,fee3,num4,fee4,num5,fee5,
num6,fee6,num7,fee7,num8,fee8,num9,fee9,num10,fee10,num11,fee11,total_num,total_fee)
    select line_id,'',tr_type_id,'',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,deal_num,deal_fee
       from t#op_inc_update_sys_rpt;
        --where card_main_id='01' and card_sub_id='00';
    --∏¸–¬œﬂ¬∑√˚
    update t#op_inc_update_sys_result a
      set line_name=(
       select b.sequence||b.line_name from op_prm_line b
        where a.line_id=b.line_id and b.record_flag='0')
    where EXISTS (select 1 from op_prm_line b
        where a.line_id=b.line_id and b.record_flag='0');
    --∏¸–¬œ˙ €∑Ω Ω
    update t#op_inc_update_sys_result a
    set a.pay_name='œ÷Ω'
    where a.pay_type='01';
    update t#op_inc_update_sys_result a
    set a.pay_name='∆±ø®'
    where a.pay_type='02';
    open out_cursor for
    select v_balance_date||v_squad_date mon,line_name,pay_name,
    sum(a.num0) num0 ,
    sum(a.fee0) fee0,
    sum(a.num1) num1,
    sum(a.fee1) fee1,
    sum(a.num2) num2,
    sum(a.fee2) fee2,
    sum(a.num3) num3,
    sum(a.fee3) fee3,
    sum(a.num4) num4,
    sum(a.fee4) fee4,
    sum(a.num5) num5,
    sum(a.fee5) fee5,
    sum(a.num6) num6,
    sum(a.fee6) fee6,
    sum(a.num7) num7,
    sum(a.fee7) fee7,
    sum(a.num8) num8,
    sum(a.fee8) fee8,
    sum(a.num9) num9,
    sum(a.fee9) fee9,
    sum(a.num10) num10,
    sum(a.fee10) fee10,
    sum(a.num11) num11,
    sum(a.fee11) fee11,
    sum(a.total_num) total_num,
    sum(a.total_fee) total_fee
    from t#op_inc_update_sys_result a
    group by line_name,pay_name
    order by line_name,pay_name desc;
    END;
/
grant execute on ACC_ST.UP_OP_INC_UPDATE_SYS_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_INC_UPDATE_SYS_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_DISPART_CONTC_D
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_DISPART_CONTC_D (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_DISPART_CONTC_D
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…Ã«Â∑÷Ω·π˚»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131010
  --±®±Ì±‡∫≈£∫rpt_03_006
  --¡Ÿ ±±Ì£∫t#op_03_006_rpt
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄:20140624
  --–ﬁ∏ƒƒ⁄»›£∫”≈ªØ
  ------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄:20170220
  --–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);--«ÂÀ„±ÌŒﬁ¥À◊÷∂Œ
  ----ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_03_006_rpt
   select a.line_id,'',b.contc_id,0
    from op_prm_line a,op_prm_contc b
      where b.record_flag = '0'
       and a.record_flag = '0'
       and a.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT);--20170220 add by zhouyang
----≤È—Ø ˝æ›
  insert into t#op_03_006_rpt
    select line_id, '', contc_id, sum(deal_fee)
      from st_sts_dispart_contc
       where substr(balance_water_no,1, 8) = v_balance_day
        group by contc_id,line_id;
----∏¸–¬«Â∑÷¿¥‘¥£∫œﬂ¬∑
  update t#op_03_006_rpt a
     set a.line_name = (select b.line_id || b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
     where exists (select 1 from op_prm_line b
                   where a.line_id = b.line_id and b.record_flag = '0');
----∏¸–¬«Â∑÷Ω·π˚£∫‘À”™…Ã
  update t#op_03_006_rpt a
     set a.other_contc = (select b.contc_id || b.contc_name from op_prm_contc b
                          where a.other_contc = b.contc_id and b.record_flag = '0')
     where exists (select 1 from op_prm_contc b
                          where a.other_contc = b.contc_id and b.record_flag = '0');
  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           line_name linekey,
           other_contc rowkey,
           sum(deal_fee) value
      from t#op_03_006_rpt
     group by line_name, other_contc;
end;
/
grant execute on ACC_ST.UP_OP_IST_DISPART_CONTC_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_DISPART_CONTC_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_DISPART_CONTC_M
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_DISPART_CONTC_M (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_DISPART_CONTC_M
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…Ã«Â∑÷Ω·π˚‘¬±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131014
  --±®±Ì±‡∫≈£∫RPT_03_008
  --¡Ÿ ±±Ì£∫t#op_03_006_rpt£®”Î»’±®±Ìπ≤”√£©
  -------------------------------------------------------------------------------
    --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄:20140624
  --–ﬁ∏ƒƒ⁄»›£∫”≈ªØ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄:20170220
  --–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_squad_day varchar(6);
BEGIN
  v_balance_day := substr(in_balance_day,1,6);
  v_squad_day:= substr(in_squad_day,1,6);
  ----ππΩ®Ω·ππ
  insert into t#op_03_006_rpt
   select a.line_id,'',b.contc_id,0
    from op_prm_line a,op_prm_contc b
      where b.record_flag = '0'
       and a.record_flag = '0'
       and a.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT);--20170220 add by zhouyang
----≤È—Ø≤¢≤Â»Î ˝æ›
  insert into t#op_03_006_rpt
    select line_id, '', contc_id, sum(deal_fee)
      from st_sts_dispart_contc
       where substr(balance_water_no,1, 6) = v_balance_day
        group by contc_id,line_id;
----∏¸–¬«Â∑÷¿¥‘¥£∫œﬂ¬∑
  update t#op_03_006_rpt a
     set a.line_name = (select b.line_id || b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
     where exists (select 1 from op_prm_line b
                   where a.line_id = b.line_id and b.record_flag = '0');
----∏¸–¬«Â∑÷Ω·π˚£∫‘À”™…Ã
  update t#op_03_006_rpt a
     set a.other_contc = (select b.contc_id || b.contc_name from op_prm_contc b
                          where a.other_contc = b.contc_id and b.record_flag = '0')
     where exists (select 1 from op_prm_contc b
                          where a.other_contc = b.contc_id and b.record_flag = '0');

----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           line_name linekey,
           other_contc rowkey,
           sum(deal_fee) value
      from t#op_03_006_rpt
     group by line_name, other_contc;
end;
/
grant execute on ACC_ST.UP_OP_IST_DISPART_CONTC_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_DISPART_CONTC_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_DISPART_LINE_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_DISPART_LINE_D (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_DISPART_LINE_D
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--œﬂ¬∑«Â∑÷Ω·π˚»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131013
  --±®±Ì±‡∫≈£∫RPT_03_005
  --¡Ÿ ±±Ì£∫t#op_03_005_rpt
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄:20140624
  --–ﬁ∏ƒƒ⁄»›£∫”≈ªØ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄:20170220
  --–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
   v_balance_day := substr(in_balance_day,1,8);
   v_squad_day:= substr(in_squad_day,1,8);
 ----ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_03_005_rpt
   select a.line_id,'',b.line_id,0
    from op_prm_line a,op_prm_line b
      where b.record_flag = '0'
       and a.record_flag = '0'
       and a.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT)--20170220 add by zhouyang
       and b.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT);--20170220 add by zhouyang
----≤È—Ø≤¢≤Â»Î ˝æ›
  insert into t#op_03_005_rpt
    select line_id, '',line_id_dispart, sum(deal_fee)
      from st_sts_dispart_line
     where substr(balance_water_no,1, 8) = v_balance_day
     group by line_id,line_id_dispart;
  ----∏¸–¬«Â∑÷¿¥‘¥ œﬂ¬∑
   update t#op_03_005_rpt a
     set a.line_sourse = (select b.line_id || b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
      where  exists (select 1 from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0');
----∏¸–¬«Â∑÷Ω·π˚  œﬂ¬∑
    update t#op_03_005_rpt a
     set a.line_result = (select b.line_id || b.line_name from op_prm_line b
    where a.line_result = b.line_id and b.record_flag = '0')
    where exists (select 1 from op_prm_line b
    where a.line_result = b.line_id and b.record_flag = '0');
    ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           line_sourse as line_sourse,
           line_result as line_result,
           sum(deal_fee) as value
      from t#op_03_005_rpt
     group by line_sourse, line_result;
end;
/
grant execute on ACC_ST.UP_OP_IST_DISPART_LINE_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_DISPART_LINE_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_DISPART_LINE_M
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_DISPART_LINE_M (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_DISPART_LINE_M
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--œﬂ¬∑«Â∑÷Ω·π˚‘¬±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20130802
  --∂‘”¶ƒ£∞Â£∫rpt_03_007
  --¡Ÿ ±±Ì£∫t#op_03_005_rpt  ”Î»’±®π≤”√
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫Õıø…º—
  --–ﬁ∏ƒ»’∆⁄:20140624
  --–ﬁ∏ƒƒ⁄»›£∫”≈ªØ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄:20170220
  --–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_squad_day varchar(6);
BEGIN
  v_balance_day := substr(in_balance_day,1,6);
  v_squad_day:= substr(in_squad_day,1,6);
  ----ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_03_005_rpt
   select a.line_id,'',b.line_id,0
    from op_prm_line a,op_prm_line b
      where b.record_flag = '0'
       and a.record_flag = '0'
       and a.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT)--20170220 add by zhouyang
       and b.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT);--20170220 add by zhouyang
----≤È—Ø≤¢≤Â»Î ˝æ›
  insert into t#op_03_005_rpt
    select line_id, '',line_id_dispart, sum(deal_fee)
      from st_sts_dispart_line
     where substr(balance_water_no,1, 6) = v_balance_day
     group by line_id,line_id_dispart;
  ----∏¸–¬«Â∑÷¿¥‘¥ œﬂ¬∑
   update t#op_03_005_rpt a
     set a.line_sourse = (select b.line_id || b.line_name from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0')
      where  exists (select 1 from op_prm_line b
   where a.line_id = b.line_id and b.record_flag = '0');
----∏¸–¬«Â∑÷Ω·π˚  œﬂ¬∑
    update t#op_03_005_rpt a
     set a.line_result = (select b.line_id || b.line_name from op_prm_line b
    where a.line_result = b.line_id and b.record_flag = '0')
    where exists (select 1 from op_prm_line b
    where a.line_result = b.line_id and b.record_flag = '0');
    ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           line_sourse as line_sourse,
           line_result as line_result,
           sum(deal_fee) as value
      from t#op_03_005_rpt
     group by line_sourse, line_result;
end;
/
grant execute on ACC_ST.UP_OP_IST_DISPART_LINE_M to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_DISPART_LINE_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_INCOME_CONTC_D
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_INCOME_CONTC_D(in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_INCOME_CONTC_D
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…Ã ’»Î»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131012
  --±®±Ì±‡∫≈£∫rpt_03_009
  --¡Ÿ ±±Ì£∫t#op_03_009_result,t#op_03_009_rpt
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ:wangkejia
  --–ﬁ∏ƒ»’∆⁄£∫20140624
  --–ﬁ∏ƒƒ⁄»›£∫”≈ªØ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ:zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170722
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);
--¥”÷–º‰±Ì≤È—Ø ˝æ› Õ≥“ªΩ´Àƒ÷÷≥« –Õ®∆±OCT∂®Œ™0600
  insert into t#op_03_009_rpt
    (contc_id,squad_day,balance_water_no,card_sub_code,card_main_code,deal_fee)
    select contc_id,
           squad_day,
           balance_water_no,
           case when card_main_id='06' then '00' else card_sub_id end,
           card_main_id,
           deal_fee
    from st_sts_income_contc_card
    where balance_water_no >= v_balance_day || '00'
      and balance_water_no <= v_balance_day || '99';
      --and squad_day=v_squad_day;
--∆’Õ®≥…»Àµ•≥Ã∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '01'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--≥…»À∆’Õ®¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--—ß…˙∆’Õ®¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '01'
     group by b.contc_id, b.contc_name, squad_day;
--¿œ»À√‚∑—¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '02'
     group by b.contc_id, b.contc_name, squad_day;
--¿œ»À”≈ª›¥¢÷µ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '02'
       and card_sub_code = '03'
     group by b.contc_id, b.contc_name, squad_day;
  --∆’Õ®≥À¥Œ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '03'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
  --∆’Õ®ºÕƒÓ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '04'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
 --”≈ª›ºÕƒÓ∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '04'
       and card_sub_code = '01'
     group by b.contc_id, b.contc_name, squad_day;
--≥« –Õ®∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '06'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--∆’Õ®“Ï–Œ¥¢÷µø®
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '07'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--∆’Õ® ÷ª˙∆±
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0,
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '08'
       and card_sub_code = '00'
     group by b.contc_id, b.contc_name, squad_day;
--¥≈∏°Õ®«⁄ø®
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee),
           0
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
       and card_main_code = '09'
       and card_sub_code = '01'
     group by b.contc_id, b.contc_name, squad_day;
--–°º∆
  insert into t#op_03_009_result
    select b.contc_id,
           b.contc_name,
           squad_day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(a.deal_fee)
      from t#op_03_009_rpt a, op_prm_contc b
     where a.contc_id = b.contc_id
       and b.record_flag = '0'
     group by b.contc_id, b.contc_name, squad_day;
-------------------------------
-----ƒ©––◊‹º∆‘⁄ÀÆæß±®±Ì…Ë÷√----
-------------------------------
  ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           sequence || contc_name linekey1,
           sum(singl) as singl,
           sum(svt) as svt,
           sum(stu_svt) as stu_svt,
           sum(old_svt_free) as old_svt_free,
           sum(old_svt_pre) as old_svt_pre,
           sum(sin_times) as sin_times,
           sum(memory_sin) as memory_sin,
           sum(memory_pre) as memory_pre,
           sum(cs_city) as cs_city,
           sum(special) as special,
           sum(mobile) as mobile,
           sum(commuter) as commuter,
           sum(total) as total
   from t#op_03_009_result
     group by sequence, contc_name
     order by sequence, contc_name;
end;
/
grant execute on ACC_ST.UP_OP_IST_INCOME_CONTC_D to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_INCOME_CONTC_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_SETTLE_CONTC
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_SETTLE_CONTC (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_SETTLE_CONTC
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…ÃΩ·À„»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131011
  --±®±Ì±‡∫≈£rrpt_03_004
  --¡Ÿ ±±Ì£∫t#op_03_004_result,t#op_03_004_rpt
  -------------------------------------------------------------------------------
    --–ﬁ∏ƒ’ﬂ£∫ Õıø…º—
    --–ﬁ∏ƒ»’∆⁄£∫20140624
    --–ﬁ∏ƒƒ⁄»›£∫
     --1>÷–º‰±ÌÕ≥º∆ ˝æ›-œ÷Ω∏¸–¬¥”st_his_update»°£¨tr_type_id='56'£¨pay_mode_id='01';
     --2>÷–º‰±ÌÕ≥º∆ ˝æ›-∑«œ÷Ω∏¸–¬¥”st_his_deal»°,tr_type_id='54'£¨pay_mode_id in ('1A','4A');(BY LILI)
     --3>µÿÃ˙œ˚∑—Ω·À„£∫
	  --≥ˆ’¢œ˚∑—£∫tr_type_id='54' and £®pay_mode_id in op_prm_paymode_type_valid where record_flag = '0')
	  --∑«œ÷Ω∏¸–¬£∫tr_type_id='54' and pay_mode_id in ('1A','4A')
	  --œ÷Ω∏¸–¬£∫tr_type_id='56'
     --4>µ˜’˚Ω·À„∑˛ŒÒ∑—¬ 
  --±∏◊¢£∫µÿÃ˙œ˚∑—Ω·À„∞¸¿®≥ˆ’¢∫Õ∏¸–¬µƒ±  ˝∫ÕΩ∂Ó
   -------------------------------------------------------------------------------
   -- ∑˛ŒÒ∑—¬ –ﬁ∏ƒŒ™∞¥‘À”™…Ã≤È—Ø modify by lindaquan 20160328

 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);

  -----------------------------------------------------------------------------
  ----≤È—Ø‘≠ º ˝æ›
  insert into t#op_03_004_rpt
  (squad_day,contc_store,tr_type_id,pay_mode_id,deal_num,deal_fee,balance_ser_fee)
    select squad_day,
           contc_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee,
           balance_ser_fee
      from st_sts_balance_contc_inc
     where substr(balance_water_no,1,8)= v_balance_day;
  -----------------------------------------------------------------------------
  -----µÿÃ˙≥À≥µœ˚∑—
     --≥ˆ’¢
  insert into t#op_03_004_result
    select b.contc_id||b.contc_name,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_004_rpt  a, op_prm_contc b
     where a.contc_store = b.contc_id and b.record_flag = '0'
       and a.tr_type_id = '54'
       and a.pay_mode_id in (select c.pay_mode_id from op_prm_paymode_type_valid c where c.record_flag='0')
     group by b.contc_id,b.contc_name;
      --∏¸–¬
  insert into t#op_03_004_result
    select b.contc_id||b.contc_name,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from t#op_03_004_rpt  a, op_prm_contc b
     where a.contc_store = b.contc_id and b.record_flag = '0'
       and ((a.tr_type_id = '54' and a.pay_mode_id in ('1A','4A'))--∑«œ÷Ω∏¸–¬
       or (a.tr_type_id = '56'))--œ÷Ω∏¸–¬
     group by b.contc_id,b.contc_name;
  ---––’˛ ’∑—
  insert into t#op_03_004_result
    select b.contc_id||b.contc_name,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           '00'
      from t#op_03_004_rpt  a, op_prm_contc b
     where a.contc_store = b.contc_id
       and b.record_flag = '0' and (a.tr_type_id = '61')
     group by b.contc_id,b.contc_name;
  /*--œ˚∑—£®“ª∞„œ˚∑—°¢–°∂Óœ˚∑—£©£®Œ¥∂®“Â£©
  insert into t#op_03_004_result
    select b.store_name,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           '99'
      from t#op_03_004_rpt  a, op_cod_store b
     where a.contc_store = b.store_id
       and b.record_flag = '0' and (a.tr_type_id = '54' and a.pay_mode_id = '17')
     group by b.store_name;*/
      ----œ˙ €(¥¢÷µ∆±)
  insert into t#op_03_004_result
    select b.contc_id||b.contc_name,
     '0',
      0,
      0,
      0,
      0,
      0,
      0,
    sum(a.deal_num),
    sum(a.deal_fee),
      0,
      0,
      0,
      0
      from t#op_03_004_rpt a,op_prm_contc b
     where a.contc_store = b.contc_id
       and b.record_flag = '0'
       and a.tr_type_id = '51'
     group by b.contc_id||b.contc_name;

  -----Ω·À„–°º∆
    update t#op_03_004_result set balance_num = dt_num + affair_num + con_num + sale_num;
    update t#op_03_004_result set balance_fee = dt_fee + affair_fee + con_fee + sale_fee;
  ---Ω·À„∑˛ŒÒ∑—(Œ¥∂®“Â)
    update t#op_03_004_result a set a.service_fee=a.balance_fee*(
       select b.service_rate from op_prm_contc_service_rate b where record_flag='0' and b.CONTC_ID=substr(a.contc_name,0,2)
       );

  -------------------Ω·À„◊‹ ’»Î
  update t#op_03_004_result set sum_fee = balance_fee - service_fee;
  -----≤Â»Îƒ©––◊‹º∆
  /*--∏¸–¬–Ú¡–∫≈
    update t#op_03_004_result a
     set a.sequence =
         (select b.contc_id
            from op_prm_contc b
           where a.contc_name = b.contc_name
             and b.record_flag = '0');*/
   ----≤Â»Îƒ©––◊‹º∆
  insert into t#op_03_004_result
  select '99◊‹º∆',
           sum(dt_num) as dt_num,
           sum(dt_fee) as dt_fee,
           sum(affair_num) as affair_num,
           sum(affair_fee) as affair_fee,
           sum(con_num) as con_num,
           sum(con_fee) as con_fee,
           sum(sale_num) as sale_num,
           sum(sale_fee) as sale_fee,
           sum(balance_num) as balance_num,
           sum(balance_fee) as balance_fee,
           sum(service_fee) as service_fee,
           sum(sum_fee) as sum_fee,
           ''
   from  t#op_03_004_result;
  ---------------------------------------
  ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day as balance_day,
           contc_name,
           sum(dt_num) as dt_num,
           sum(dt_fee) as dt_fee,
           sum(affair_num) as affair_num,
           sum(affair_fee) as affair_fee,
           sum(con_num) as con_num,
           sum(con_fee) as con_fee,
           sum(sale_num) as sale_num,
           sum(sale_fee) as sale_fee,
           sum(balance_num) as balance_num,
           sum(balance_fee) as balance_fee,
           sum(service_fee) as service_fee,
           sum(sum_fee) as sum_fee,
           sequence
      from t#op_03_004_result
     group by contc_name, sequence
     order by  contc_name,sequence;
end;
/
grant execute on ACC_ST.UP_OP_IST_SETTLE_CONTC to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_SETTLE_CONTC to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_SETTLE_CONTC_DEAL
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL(in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_SETTLE_CONTC_DEAL
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…ÃΩª“◊ ˝æ›Ω·À„»’ª„◊‹±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131011
  --±®±Ì±‡∫≈£∫rpt_03_002
  --¡Ÿ ±±Ì£∫t#op_03_002_result,t#op_03_002_rpt
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫ wangkejia
  --¥¥–ﬁ∏ƒ»’∆⁄£∫20140624
  --±®±Ì±‡∫≈£rrpt_03_001
  --–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±ÌÕ≥º∆ ˝æ›-œ÷Ω∏¸–¬¥”st_his_update»°£¨tr_type_id='56'£¨pay_mode_id='01';
            --2>÷–º‰±ÌÕ≥º∆ ˝æ›-∑«œ÷Ω∏¸–¬¥”st_his_deal»°,tr_type_id='54'£¨pay_mode_id in ('1A','4A');(BY LILI)
   --±∏◊¢£∫
   --1>≥À≥µœ˚∑—£∫∞¸¿®≥ˆ’¢∫Õ∏¸–¬∫Û≥ˆ’¢µƒ±  ˝∫ÕΩ∂Ó
     --tr_type_id='54' and (pay_mode_id in op_prm_paymode_type_valid where record_flag = '0')
   --2>∏¸–¬£∫∞¸¿®œ÷Ω”Î∑«œ÷Ω∏¸–¬µƒ±  ˝∫ÕΩ∂Ó
     --œ÷Ω∏¸–¬:tr_type_id='56' and pay_mode_id='01'
  --∑«œ÷Ω∏¸–¬:tr_type_id='54' and pay_mode_id in ('1A','4A')
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫ zhouyang
  --¥¥–ﬁ∏ƒ»’∆⁄£∫20170802
  --–ﬁ∏ƒƒ⁄»›£∫‘⁄°∞Ω·À„Ω·π˚°±÷–µƒ°∞≥Â’˝°±”Î°∞ÕÀøÓ°±∏ƒŒ™°∞∏∫ ˝°±
  -------------------------------------------------------------------------------

 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);
  -------------------------------------------------------------------------------
  ----≤È—Ø ˝æ›
  insert into t#op_03_002_rpt
  (squad_day,contc_store,tr_type_id,pay_mode_id,deal_num,deal_fee)
    select
           squad_day,
           contc_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee
      from st_sts_balance_contc_trd
     where substr(balance_water_no, 1, 8) = v_balance_day;
  -------------------------------------------------------------------------------
  ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_03_002_result
    select contc_name,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from op_prm_contc
     where record_flag = '0';
  --œ˙ €(µ•≥Ã∆±)
  insert into t#op_03_002_result
    select contc_store,
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where tr_type_id = '50'
     group by contc_store;
  --—∫Ω
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where tr_type_id = '51'---A
     group by contc_store;
  --≥‰÷µ
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  tr_type_id = '54'
       and pay_mode_id = '14'
     group by contc_store;
  --≥Â’˝
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  tr_type_id = '54'
       and pay_mode_id = '18'
     group by contc_store;
  --œ˚∑—
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  tr_type_id = '54'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_store;
  --ÕÀøÓ
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  tr_type_id = '57'
     group by contc_store;
     --∏¸–¬£®∏¸∏ƒ∫Û£©
     insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  (tr_type_id = '56')
         or (tr_type_id = '54' and pay_mode_id in ('1A','4A'))
     group by contc_store;

  /*  ∏¸∏ƒ«∞
  --∏¸–¬
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  tr_type_id = '56'
     --and pay_mode_id in ( '01','02')
     group by contc_store;
     */
  --––’˛ ’∑—
  insert into t#op_03_002_result
    select contc_store,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           contc_store
      from t#op_03_002_rpt
     where  tr_type_id = '61'
     group by contc_store;
     --∏¸–¬‘À”™…Ã√˚
  update t#op_03_002_result a
     set contc_name = (select b.contc_id || b.contc_name from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0')
     where exists (select 1 from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0');

         ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day as balance_day,
           contc_name rowkey,
           sum(sale_num) as sale_num_sum ,
           sum(sale_fee) as sale_fee_sum ,
           sum(deposit_num) as deposit_num_sum ,
           sum(deposit_fee) as deposit_fee_sum ,
           sum(charge_num) as charge_num_sum ,
           sum(charge_fee) as charge_fee_sum ,
           sum(cut_num) as cut_num_sum ,
           sum(cut_fee) as cut_fee_sum ,
           sum(consume_num) as consume_num_sum ,
           sum(consume_fee) as consume_fee_sum ,
           sum(return_num) as return_num_sum ,
           sum(return_fee) as return_fee_sum ,
           sum(update_num) as update_num_sum ,
           sum(update_fee) as update_fee_sum ,
           sum(affair_num) as affair_num_sum ,
           sum(affair_fee) as affair_fee_sum ,
           sum(sale_num + deposit_num + charge_num + consume_num + cut_num +
               return_num + update_num + affair_num) as total_num_sum ,
           sum(sale_fee + deposit_fee + charge_fee + consume_fee - cut_fee -
               return_fee + update_fee + affair_fee) as total_fee_sum
      from t#op_03_002_result
     group by contc_name
     order by contc_name;
end;
/
grant execute on ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_SETTLE_CONTC_DEAL_D
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL_D(in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_SETTLE_CONTC_DEAL_D
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…ÃΩª“◊ ˝æ›Ω·À„»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zhouyang
  --¥¥Ω®»’∆⁄£∫20161206
  --±®±Ì±‡∫≈£∫rpt_03_010
  --¡Ÿ ±±Ì£∫t#op_03_010_result,t#OP_IST_SETTLE_CONTC_DEAL_D
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫ zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170722
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);
  -------------------------------------------------------------------------------
  ----≤È—Ø ˝æ› (µ•≥Ã∆±∑¢ € °¢≥‰÷µ°¢≥Â’˝°¢ÕÀøÓ°¢––’˛ ’∑—)
  insert into t#OP_IST_SETTLE_CONTC_DEAL_D
  (squad_day,contc_id,tr_type_id,pay_mode_id,deal_num,deal_fee)
    select
           squad_day,
           contc_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee
      from st_sts_balance_contc_trd
     where substr(balance_water_no, 1, 8) = v_balance_day
        and
           (
             (tr_type_id ='50') --µ•≥Ã∆±∑¢ €
             or (tr_type_id = '54' and pay_mode_id = '14')--≥‰÷µ
             or (tr_type_id = '54' and pay_mode_id = '18')--≥Â’˝
             or (tr_type_id = '57')--ÕÀøÓ
             or (tr_type_id = '61')--––’˛ ’∑—
           );
  ----≤È—Ø ˝æ›£®—∫Ω°¢π§±æ∑—°¢œ˚∑—°¢∏¸–¬£©
  insert into t#OP_IST_SETTLE_CONTC_DEAL_D
   (contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,card_main_id,
    card_sub_id,tr_type_id,pay_mode_id,deal_num,deal_fee,deposit_type)
    select
           contc_id,
           belong_line_id,
           belong_contc_id,
           squad_day,
           balance_water_no,
           card_main_id,
           card_sub_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee,
           deposit_type
    from st_sts_income_contc_card_mode
     where substr(balance_water_no, 1, 8) = v_balance_day
        and
           (
                (deposit_type = '1' and tr_type_id = '51') --—∫Ω
             or (deposit_type = '0' and tr_type_id = '51')--π§±æ∑—
             or (tr_type_id = '54' and pay_mode_id in('12','1C','42','4C','92','9C'))--œ˚∑—
             or ((tr_type_id = '56') or (tr_type_id = '54' and pay_mode_id in('1A','4A')))--∏¸–¬
           );
  -------------------------------------------------------------------------------
  ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_03_010_result
    select contc_name,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from op_prm_contc
     where record_flag = '0';
  --œ˙ €(µ•≥Ã∆±)
  insert into t#op_03_010_result
    select contc_id,
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '50'
     group by contc_id;
  --—∫Ω
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where deposit_type = '1' and tr_type_id = '51'
     group by contc_id;
  --π§±æ∑—
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where deposit_type = '0' and tr_type_id = '51'
     group by contc_id;
  --≥‰÷µ
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '54'
       and pay_mode_id = '14'
     group by contc_id;
  --≥Â’˝
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '54'
       and pay_mode_id = '18'
     group by contc_id;
  --œ˚∑—
     --µ•≥Ã∆±
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='01' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --µÿÃ˙¥¢÷µø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --π´Ωªø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='06' and card_sub_id in('00','01','02','03')
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --“Ï–Œø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='07' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --—ß…˙ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='01'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --¿œ»À√‚∑—ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='03'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
   --¥≈∏°Õ®«⁄ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='09' and card_sub_id='01'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
  --ÕÀøÓ
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '57'
     group by contc_id;
  --∏¸–¬
     --µ•≥Ã∆±
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where ((tr_type_id = '56') or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='01' and card_sub_id='00'
     group by contc_id;
     --µÿÃ˙¥¢÷µø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='00'
     group by contc_id;
     --π´Ωªø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='06' and card_sub_id in('00','01','02','03')
     group by contc_id;
     --“Ï–Œø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='07' and card_sub_id='00'
     group by contc_id;
     --—ß…˙ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='01'
     group by contc_id;
     --¿œ»À√‚∑—ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='03'
     group by contc_id;
     --¥≈∏°Õ®«⁄ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='09' and card_sub_id='01'
     group by contc_id;
  --––’˛ ’∑—
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '61'
     group by contc_id;

     --∏¸–¬‘À”™…Ã√˚
  update t#op_03_010_result a
     set contc_name = (select b.contc_id || b.contc_name from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0')
     where exists (select 1 from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0');

         ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day as balance_day,
           contc_name rowkey,
           sum(sale_num) as sale_num ,
           sum(sale_fee) as sale_fee ,
           sum(deposit_num) as deposit_num ,
           sum(deposit_fee) as deposit_fee ,
           sum(cost_num) as cost_num,
           sum(cost_fee) as cost_fee,
           sum(charge_num) as charge_num ,
           sum(charge_fee) as charge_fee ,
           sum(cut_num) as cut_num ,
           sum(cut_fee) as cut_fee ,
           sum(consume_single_fee) as consume_single_fee ,
           sum(consume_metro_fee) as consume_metro_fee ,
           sum(consume_bus_fee) as consume_bus_fee ,
           sum(consume_alien_fee) as consume_alien_fee ,
           sum(consume_student_fee) as consume_student_fee ,
           sum(consume_old_fee) as consume_old_fee ,
           sum(consume_commuter_fee) as consume_commuter_fee ,
           sum(return_num) as return_num ,
           sum(return_fee) as return_fee ,
           sum(update_single_fee) as update_single_fee ,
           sum(update_metro_fee) as update_metro_fee ,
           sum(update_bus_fee) as update_bus_fee ,
           sum(update_alien_fee) as update_alien_fee ,
           sum(update_student_fee) as update_student_fee ,
           sum(update_old_fee) as update_old_fee ,
           sum(update_commuter_fee) as update_commuter_fee ,
           sum(affair_num) as affair_num ,
           sum(affair_fee) as affair_fee ,
           sum(sale_num + deposit_num + cost_num + charge_num + cut_num +
               return_num + affair_num) as total_num ,
           sum(sale_fee + deposit_fee + cost_fee + charge_fee + consume_single_fee + consume_metro_fee
            + consume_bus_fee + consume_alien_fee + consume_student_fee + consume_old_fee+ consume_commuter_fee
             - cut_fee - return_fee + update_single_fee + update_metro_fee + update_bus_fee
            + update_alien_fee + update_student_fee + update_old_fee + update_commuter_fee + affair_fee) as total_fee
      from t#op_03_010_result
     group by contc_name
     order by contc_name;
end;
/
grant execute on ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL_D to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_SETTLE_CONTC_DEAL_M
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL_M(in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_SETTLE_CONTC_DEAL_M
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--‘À”™…ÃΩª“◊ ˝æ›Ω·À„‘¬±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zhouyang
  --¥¥Ω®»’∆⁄£∫20161207
  --±®±Ì±‡∫≈£∫rpt_03_011
  --¡Ÿ ±±Ì£∫t#op_03_010_result,t#OP_IST_SETTLE_CONTC_DEAL_D
  -------------------------------------------------------------------------------
 --–ﬁ∏ƒ’ﬂ£∫ zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170722
  --–ﬁ∏ƒƒ⁄»›£∫‘ˆº”°∞¥≈∏°Õ®«⁄ø®°±
  -------------------------------------------------------------------------------
 is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,6);
  v_squad_day:=substr(in_squad_day,1,6);
  -------------------------------------------------------------------------------
  ----≤È—Ø ˝æ› (µ•≥Ã∆±∑¢ € °¢≥‰÷µ°¢≥Â’˝°¢ÕÀøÓ°¢––’˛ ’∑—)
  insert into t#OP_IST_SETTLE_CONTC_DEAL_D
  (squad_day,contc_id,tr_type_id,pay_mode_id,deal_num,deal_fee)
    select
           squad_day,
           contc_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee
      from st_sts_balance_contc_trd
     where substr(balance_water_no, 1, 6) = v_balance_day
        and
           (
             (tr_type_id ='50') --µ•≥Ã∆±∑¢ €
             or (tr_type_id = '54' and pay_mode_id = '14')--≥‰÷µ
             or (tr_type_id = '54' and pay_mode_id = '18')--≥Â’˝
             or (tr_type_id = '57')--ÕÀøÓ
             or (tr_type_id = '61')--––’˛ ’∑—
           );
  ----≤È—Ø ˝æ›£®—∫Ω°¢π§±æ∑—°¢œ˚∑—°¢∏¸–¬£©
  insert into t#OP_IST_SETTLE_CONTC_DEAL_D
   (contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,card_main_id,
    card_sub_id,tr_type_id,pay_mode_id,deal_num,deal_fee,deposit_type)
    select
           contc_id,
           belong_line_id,
           belong_contc_id,
           squad_day,
           balance_water_no,
           card_main_id,
           card_sub_id,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee,
           deposit_type
    from st_sts_income_contc_card_mode
     where substr(balance_water_no, 1, 6) = v_balance_day
        and
           (
                (deposit_type = '1' and tr_type_id = '51') --—∫Ω
             or (deposit_type = '0' and tr_type_id = '51')--π§±æ∑—
             or (tr_type_id = '54' and pay_mode_id in('12','1C','42','4C','92','9C'))--œ˚∑—
             or ((tr_type_id = '56') or (tr_type_id = '54' and pay_mode_id in('1A','4A')))--∏¸–¬
           );
  -------------------------------------------------------------------------------
  ----ππΩ®Ω·π˚ºØΩ·ππ
insert into t#op_03_010_result
    select contc_name,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from op_prm_contc
     where record_flag = '0';
  --œ˙ €(µ•≥Ã∆±)
  insert into t#op_03_010_result
    select contc_id,
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '50'
     group by contc_id;
  --—∫Ω
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where deposit_type = '1' and tr_type_id = '51'
     group by contc_id;
  --π§±æ∑—
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where deposit_type = '0' and tr_type_id = '51'
     group by contc_id;
  --≥‰÷µ
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '54'
       and pay_mode_id = '14'
     group by contc_id;
  --≥Â’˝
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '54'
       and pay_mode_id = '18'
     group by contc_id;
  --œ˚∑—
     --µ•≥Ã∆±
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='01' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --µÿÃ˙¥¢÷µø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --π´Ωªø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='06' and card_sub_id in('00','01','02','03')
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --“Ï–Œø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='07' and card_sub_id='00'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --—ß…˙ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='01'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
     --¿œ»À√‚∑—ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='02' and card_sub_id='03'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
   --¥≈∏°Õ®«⁄ø®
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where tr_type_id = '54' and card_main_id='09' and card_sub_id='01'
       and pay_mode_id  in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')
     group by contc_id;
  --ÕÀøÓ
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '57'
     group by contc_id;
  --∏¸–¬
     --µ•≥Ã∆±
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='01' and card_sub_id='00'
     group by contc_id;
     --µÿÃ˙¥¢÷µø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='00'
     group by contc_id;
     --π´Ωªø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='06' and card_sub_id in('00','01','02','03')
     group by contc_id;
     --“Ï–Œø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='07' and card_sub_id='00'
     group by contc_id;
     --—ß…˙ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='01'
     group by contc_id;
     --¿œ»À√‚∑—ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='02' and card_sub_id='03'
     group by contc_id;
     --¥≈∏°Õ®«⁄ø®
     insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_fee),
           0,
           0,
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where (tr_type_id = '56' or (tr_type_id = '54' and pay_mode_id in ('1A','4A')))
       and card_main_id='09' and card_sub_id='01'
     group by contc_id;
  --––’˛ ’∑—
  insert into t#op_03_010_result
    select contc_id,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           contc_id
      from t#OP_IST_SETTLE_CONTC_DEAL_D
     where  tr_type_id = '61'
     group by contc_id;

     --∏¸–¬‘À”™…Ã√˚
  update t#op_03_010_result a
     set contc_name = (select b.contc_id || b.contc_name from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0')
     where exists (select 1 from op_prm_contc b
         where a.contc_id = b.contc_id and b.record_flag = '0');

         ----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day as balance_day,
           contc_name rowkey,
           sum(sale_num) as sale_num ,
           sum(sale_fee) as sale_fee ,
           sum(deposit_num) as deposit_num ,
           sum(deposit_fee) as deposit_fee ,
           sum(cost_num) as cost_num,
           sum(cost_fee) as cost_fee,
           sum(charge_num) as charge_num ,
           sum(charge_fee) as charge_fee ,
           sum(cut_num) as cut_num ,
           sum(cut_fee) as cut_fee ,
           sum(consume_single_fee) as consume_single_fee ,
           sum(consume_metro_fee) as consume_metro_fee ,
           sum(consume_bus_fee) as consume_bus_fee ,
           sum(consume_alien_fee) as consume_alien_fee ,
           sum(consume_student_fee) as consume_student_fee ,
           sum(consume_old_fee) as consume_old_fee ,
           sum(consume_commuter_fee) as consume_commuter_fee ,
           sum(return_num) as return_num ,
           sum(return_fee) as return_fee ,
           sum(update_single_fee) as update_single_fee ,
           sum(update_metro_fee) as update_metro_fee ,
           sum(update_bus_fee) as update_bus_fee ,
           sum(update_alien_fee) as update_alien_fee ,
           sum(update_student_fee) as update_student_fee ,
           sum(update_old_fee) as update_old_fee ,
           sum(update_commuter_fee) as update_commuter_fee ,
           sum(affair_num) as affair_num ,
           sum(affair_fee) as affair_fee ,
           sum(sale_num + deposit_num + cost_num + charge_num + cut_num +
               return_num + affair_num) as total_num ,
           sum(sale_fee + deposit_fee + cost_fee + charge_fee + consume_single_fee + consume_metro_fee
            + consume_bus_fee + consume_alien_fee + consume_student_fee + consume_old_fee+ consume_commuter_fee
             - cut_fee - return_fee + update_single_fee + update_metro_fee + update_bus_fee
            + update_alien_fee + update_student_fee + update_old_fee + update_commuter_fee + affair_fee) as total_fee
      from t#op_03_010_result
     group by contc_name
     order by contc_name;
end;
/
grant execute on ACC_ST.UP_OP_IST_SETTLE_CONTC_DEAL_M to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_SETTLE_LINE
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_SETTLE_LINE(in_line_id   varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_SETTLE_LINE
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--œﬂ¬∑Ω·À„»’±®±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ Õıø…º—
  --¥¥Ω®»’∆⁄£∫20131010
  --±®±Ì±‡∫≈£∫rpt_03_003
  --¡Ÿ ±±Ì£∫t#op_03_003_result,t#op_03_003_rpt
  -------------------------------------------------------------------------------
    --–ﬁ∏ƒ’ﬂ£∫ Õıø…º—
    --–ﬁ∏ƒ»’∆⁄£∫20140624
    --–ﬁ∏ƒƒ⁄»›£∫
     --1>÷–º‰±ÌÕ≥º∆ ˝æ›-œ÷Ω∏¸–¬¥”st_his_update»°£¨tr_type_id='56'£¨pay_mode_id='01';
     --2>÷–º‰±ÌÕ≥º∆ ˝æ›-∑«œ÷Ω∏¸–¬¥”st_his_deal»°,tr_type_id='54'£¨pay_mode_id in ('1A','4A');(BY LILI)
     --3>µÿÃ˙œ˚∑—Ω·À„£∫
	  --≥ˆ’¢œ˚∑—£∫tr_type_id='54' and £®pay_mode_id in op_prm_paymode_type_valid where record_flag = '0')
	  --∑«œ÷Ω∏¸–¬£∫tr_type_id='54' and pay_mode_id in ('1A','4A')
	  --œ÷Ω∏¸–¬£∫tr_type_id='56'

  --±∏◊¢£∫µÿÃ˙œ˚∑—Ω·À„∞¸¿®≥ˆ’¢∫Õ∏¸–¬µƒ±  ˝∫ÕΩ∂Ó
  -------------------------------------------------------------------------------
  -- ∑˛ŒÒ∑—¬ –ﬁ∏ƒŒ™∞¥œﬂ¬∑≤È—Ø modify by lindaquan 20160328
  

 is
  v_balance_day char(8);
  v_squad_day char(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);

  insert into t#op_03_003_rpt
          (squad_day,
           line_id_dispart,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee,
           balance_ser_fee)
    select squad_day,
           line_id_dispart,
           tr_type_id,
           pay_mode_id,
           deal_num,
           deal_fee,
           balance_ser_fee
      from st_sts_balance_line_inc
     where balance_water_no >= v_balance_day || '00'
       and balance_water_no <= v_balance_day || '99';
  ----------------µÿÃ˙≥À≥µœ˚∑—
       --≥ˆ’¢ø€∑—
  insert into t#op_03_003_result
    select b.line_id||b.line_name,
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           ''
      from t#op_03_003_rpt a, op_prm_line b
     where a.line_id_dispart = b.line_id and b.record_flag = '0'
       and a.tr_type_id = '54'
       and a.pay_mode_id in (select c.pay_mode_id from op_prm_paymode_type_valid c where c.record_flag='0')
     group by b.line_id,b.line_name;
         --∏¸–¬£®œ÷Ω∏¸–¬∫Õ∑«œ÷Ω∏¸–¬£©
    insert into t#op_03_003_result
    select b.line_id||b.line_name,
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           ''
      from t#op_03_003_rpt a, op_prm_line b
     where a.line_id_dispart = b.line_id and b.record_flag = '0'
       and ((a.tr_type_id = '54' and a.pay_mode_id in ('1A','4A'))----∑«œ÷Ω∏¸–¬
       OR (a.tr_type_id = '56'))--œ÷Ω∏¸–¬
     group by b.line_id,b.line_name;
  ---––’˛ ’∑—
  insert into t#op_03_003_result
    select b.line_id||b.line_name,
           '0',
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           ''
      from t#op_03_003_rpt a, op_prm_line b
     where a.line_id_dispart = b.line_id
       and b.record_flag = '0' and (a.tr_type_id = '61')
     group by b.line_id,b.line_name;
  /*--œ˚∑—£®“ª∞„œ˚∑—/–°∂Óœ˚∑—µ»£©(Œ¥∂®“Â)
  insert into t#op_03_003_result
    select b.line_name,
           '1',
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           ''
      from t#op_03_003_rpt a, op_prm_line b
     where a.line_id_dispart = b.line_id
       and b.record_flag = '0'
       and (a.tr_type_id = '54' and a.pay_mode_id = '17')
     group by b.line_name;*/
  ----œ˙ €£®¥¢÷µ∆±£©
  insert into t#op_03_003_result
    select b.line_id||b.line_name,
     '0',
      0,
      0,
      0,
      0,
      0,
      0,
    sum(a.deal_num),
    sum(a.deal_fee),
      0,
      0,
      0,
      0,
      ''
      from t#op_03_003_rpt a,op_prm_line b
     where a.line_id_dispart = b.line_id
       and b.record_flag = '0'
       and a.tr_type_id = '51'
     group by b.line_id,b.line_name;

--Ω·À„–°º∆
update t#op_03_003_result set balance_num=dt_num+affair_num+con_num+sale_num;
update t#op_03_003_result set balance_fee=dt_fee+affair_fee+con_fee+sale_fee;
  ---Ω·À„∑˛ŒÒ∑—(∏¸–¬Ω·À„∑˛ŒÒ∑—) -- ∑˛ŒÒ∑—¬ –ﬁ∏ƒŒ™∞¥œﬂ¬∑≤È—Ø 
update t#op_03_003_result a set a.service_fee=a.balance_fee*(
       select b.service_rate from op_prm_line_service_rate b where record_flag='0' and b.line_id=substr(a.contc_name,0,2)
       );
--Ω·À„◊‹ ’»Î
update t#op_03_003_result set sum_fee=balance_fee-service_fee;

----ƒ©––◊‹º∆
insert into t#op_03_003_result
select '99◊‹º∆','',
           sum(dt_num) as dt_num,
           sum(dt_fee) as dt_fee,
           sum(affair_num) as affair_num,
           sum(affair_fee) as affair_fee,
           sum(con_num) as con_num,
           sum(con_fee) as con_fee,
           sum(sale_num) as sale_num,
           sum(sale_fee) as sale_fee,
           sum(balance_num) as balance_num,
           sum(balance_fee) as balance_fee,
           sum(service_fee) as service_fee,
           sum(sum_fee) as sum_fee,
           ''
           from t#op_03_003_result;
  ---------------------------------------
  --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day as balance_day,
           contc_name,
           sum(dt_num) as dt_num,
           sum(dt_fee) as dt_fee,
           sum(affair_num) as affair_num,
           sum(affair_fee) as affair_fee,
           sum(con_num) as con_num,
           sum(con_fee) as con_fee,
           sum(sale_num) as sale_num,
           sum(sale_fee) as sale_fee,
           sum(balance_num) as balance_num,
           sum(balance_fee) as balance_fee,
           sum(service_fee) as service_fee,
           sum(sum_fee) as sum_fee
      from t#op_03_003_result
     group by contc_name
     order by contc_name;
end;
/
grant execute on ACC_ST.UP_OP_IST_SETTLE_LINE to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_SETTLE_LINE to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_IST_SETTLE_LINE_DEAL
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_IST_SETTLE_LINE_DEAL(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_IST_SETTLE_LINE_DEAL
  --π¶ƒ‹√Ë ˆ£∫ƒ⁄≤ø«ÂÀ„¿‡±®±Ì--œﬂ¬∑Ωª“◊ ˝æ›Ω·À„»’ª„◊‹±Ì
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ wangkejia
  --¥¥Ω®»’∆⁄£∫20131010
  --±®±Ì±‡∫≈£rrpt_03_001
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫ wangkejia
  --¥¥–ﬁ∏ƒ»’∆⁄£∫20140624
  --±®±Ì±‡∫≈£rrpt_03_001
  --–ﬁ∏ƒƒ⁄»›£∫1>÷–º‰±ÌÕ≥º∆ ˝æ›-œ÷Ω∏¸–¬¥”st_his_update»°£¨tr_type_id='56'£¨pay_mode_id='01';
            --2>÷–º‰±ÌÕ≥º∆ ˝æ›-∑«œ÷Ω∏¸–¬¥”st_his_deal»°,tr_type_id='54'£¨pay_mode_id in ('1A','4A');(BY LILI)
   --±∏◊¢£∫
   --1>≥À≥µœ˚∑—£∫∞¸¿®≥ˆ’¢∫Õ∏¸–¬∫Û≥ˆ’¢µƒ±  ˝∫ÕΩ∂Ó
       --tr_type_id='54' and (pay_mode_id in op_prm_paymode_type_valid where record_flag = '0')
   --2>∏¸–¬£∫∞¸¿®œ÷Ω”Î∑«œ÷Ω∏¸–¬µƒ±  ˝∫ÕΩ∂Ó
       --œ÷Ω∏¸–¬:tr_type_id='56' and pay_mode_id='01'
    --∑«œ÷Ω∏¸–¬:tr_type_id='54' and pay_mode_id in ('1A','4A')
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫ zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170220
  --–ﬁ∏ƒƒ⁄»›£∫∆¡±Œ°∞82–Èƒ‚œﬂ¬∑°±
  -------------------------------------------------------------------------------

  --–ﬁ∏ƒ’ﬂ£∫ zhouyang
  --¥¥–ﬁ∏ƒ»’∆⁄£∫20170802
  --–ﬁ∏ƒƒ⁄»›£∫‘⁄°∞Ω·À„Ω·π˚°±÷–µƒ°∞≥Â’˝°±”Î°∞ÕÀøÓ°±∏ƒŒ™°∞∏∫ ˝°±
  -------------------------------------------------------------------------------
is
  v_balance_day varchar(8);
  v_squad_day varchar(8);
BEGIN
  v_balance_day := substr(in_balance_day,1,8);
  v_squad_day:=substr(in_squad_day,1,8);
----------------------------------------------------------------------------------
  --≤È—Ø ˝æ›
  insert into t#op_03_001_rpt
    (squad_day,line_id_dispart,tr_type_id,pay_mode_id,deal_num,deal_fee)
    select squad_day,line_id_dispart,tr_type_id,pay_mode_id,deal_num,deal_fee
      from st_sts_balance_line_trd
     where substr(balance_water_no, 1, 8) = v_balance_day;
----------------------------------------------------------------------------------
--ππΩ®Ω·π˚ºØΩ·ππ
  insert into t#op_03_001_result
    select line_name,
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           line_id
      from op_prm_line
     where record_flag = '0'
           and line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT);--20170220 add by zhouyang
  --œ˙ €(µ•≥Ã∆±)
  insert into t#op_03_001_result
    select '',
           '0',
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where tr_type_id = '50'
     group by line_id_dispart;
  --—∫Ω
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where tr_type_id = '51'
     group by line_id_dispart;
  --≥‰÷µ
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where  tr_type_id = '54'
       and pay_mode_id = '14'
     group by line_id_dispart;
  --≥Â’˝
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where tr_type_id = '54'
       and pay_mode_id = '18'
     group by line_id_dispart;
  --œ˚∑—(≥À≥µ)
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where  tr_type_id = '54'
       and pay_mode_id in (select b.pay_mode_id from op_prm_paymode_type_valid b where b.record_flag='0')--pay_mode_id≤Œøºop_prm_paymode_type_valid
     group by line_id_dispart;
  --ÕÀøÓ
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where tr_type_id = '57'
     group by line_id_dispart;
       --∏¸–¬£®∏¸∏ƒ∫Û£©
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where (tr_type_id = '56')
           or (tr_type_id = '54' and pay_mode_id in ('1A','4A'))
     group by line_id_dispart;

     /*
  --∏¸–¬
  --∏¸∏ƒ«∞£∫
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where tr_type_id = '56'
     --and pay_mode_id in ( '01','02')
     group by line_id_dispart;*/

  --––’˛ ’∑—
  insert into t#op_03_001_result
    select '',
           '0',
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(deal_num),
           sum(deal_fee),
           0,
           0,
           line_id_dispart
      from t#op_03_001_rpt
     where  tr_type_id = '61'
     group by line_id_dispart;
   ----∏¸–¬œﬂ¬∑√˚
  update t#op_03_001_result a
     set contc_name = (select b.line_id || b.line_name from op_prm_line b
             where a.line_id_dispart = b.line_id and b.record_flag = '0')
     where exists (select 1 from op_prm_line b
             where a.line_id_dispart = b.line_id and b.record_flag = '0');

     --∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day as balance_day,
           contc_name rowkey,
           sum(sale_num) as sale_num_sum ,
           sum(sale_fee) as sale_fee_sum ,
           sum(deposit_num) as deposit_num_sum ,
           sum(deposit_fee) as deposit_fee_sum ,
           sum(charge_num) as charge_num_sum ,
           sum(charge_fee) as charge_fee_sum ,
           sum(cut_num) as cut_num_sum ,
           sum(cut_fee) as cut_fee_sum ,
           sum(consume_num) as consume_num_sum ,
           sum(consume_fee) as consume_fee_sum ,
           sum(return_num) as return_num_sum ,
           sum(return_fee) as return_fee_sum ,
           sum(update_num) as update_num_sum ,
           sum(update_fee) as update_fee_sum ,
           sum(affair_num) as affair_num_sum ,
           sum(affair_fee) as affair_fee_sum ,
           sum(sale_num + deposit_num + charge_num + consume_num + cut_num +
               return_num + update_num + affair_num) as total_num_sum ,
           sum(sale_fee + deposit_fee + charge_fee + consume_fee - cut_fee -
               return_fee + update_fee + affair_fee) as total_fee_sum
      from t#op_03_001_result
     group by contc_name
     order by contc_name;
end;
/
grant execute on ACC_ST.UP_OP_IST_SETTLE_LINE_DEAL to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_IST_SETTLE_LINE_DEAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_MB_CONSUME_DAY
prompt =======================================
prompt
create or replace procedure acc_st.UP_OP_MB_CONSUME_DAY(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id   varchar,
                                             in_card_sub_id    varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_CONSUME_DAY
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì-- ÷ª˙÷ß∏∂œ˚∑—»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zzq
  --¥¥Ω®»’∆⁄£∫20160419
  --±®±Ì±‡∫≈£∫rpt_10_007.rpt
  --¡Ÿ ±±Ì£∫T#UP_OP_MB_CONSUME_DAY_RESULT
  -------------------------------------------------------------------------------
  ---------------------------------------------------------------------------------
  --∏¸∏ƒ’ﬂ£∫ zzq
  --∏¸∏ƒ»’∆⁄£∫20160518
  --∏¸∏ƒƒ⁄»›£∫ÃÌº” ‰»Î≤Œ ˝
  -------------------------------------------------------------------------------
is
  v_balance_begin_day char(8);
  v_balance_cur_day char(8);
  v_last_day      char(8);
  v_i      integer;

begin
  v_balance_cur_day := substr(in_balance_day,1,8);
  v_last_day := to_char(last_day(to_date(v_balance_cur_day,'yyyymmdd')),'yyyymmdd');
  v_balance_begin_day := substr(in_balance_day,1,6) || '01';
---------------------------------------------------------------------------
  --ππΩ®Ω·π˚ºØ
v_i := 1;
while v_i <= substr(in_balance_day,7,2) loop
    insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT
    values
      (lpad(v_i,2,0),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0);
    v_i := v_i + 1;
  end loop;
--------------------------------------------------------------------------
  --1∫≈œﬂ
  insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT (
     day,
     line_01_num,
     line_01_fee,
     line_02_num,
     line_02_fee,
     line_60_num,
     line_60_fee,
     bus_num,
     bus_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from acc_st.ST_MB_EXT_STS_DEAL_LINE
     where substr(balance_water_no,1,8) >= v_balance_begin_day
           and substr(balance_water_no,1,8) <= v_balance_cur_day
           and LINE_ID = '01'
     group by substr(balance_water_no, 7, 2);
--------------------------------------------------------------------------
  --2∫≈œﬂ
  insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT (
     day,
     line_01_num,
     line_01_fee,
     line_02_num,
     line_02_fee,
     line_60_num,
     line_60_fee,
     bus_num,
     bus_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0,
           0,
           0,
           0,
           0
      from acc_st.ST_MB_EXT_STS_DEAL_LINE
     where substr(balance_water_no,1,8) >= v_balance_begin_day
             and substr(balance_water_no,1,8) <= v_balance_cur_day
             and LINE_ID = '02'
     group by substr(balance_water_no, 7, 2);
--------------------------------------------------------------------------
 -- ¥≈∏°œﬂ
    insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT (
     day,
     line_01_num,
     line_01_fee,
     line_02_num,
     line_02_fee,
     line_60_num,
     line_60_fee,
     bus_num,
     bus_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0,
           0,
           0
      from acc_st.ST_MB_EXT_STS_DEAL_LINE
     where substr(balance_water_no,1,8) >= v_balance_begin_day
           and substr(balance_water_no,1,8) <= v_balance_cur_day
           and LINE_ID = '60'
     group by substr(balance_water_no, 7, 2);
--------------------------------------------------------------------------
  --π´Ωª
    insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT (
     day,
     line_01_num,
     line_01_fee,
     line_02_num,
     line_02_fee,
     line_60_num,
     line_60_fee,
     bus_num,
     bus_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0
      from acc_st.ST_MB_EXT_STS_DEAL_BUS
     where substr(balance_water_no,1,8) >= v_balance_begin_day
           and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);

--------------------------------------------------------------------------
 --Œ≤¡–∫œº∆
 insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT (
     day,
     line_01_num,
     line_01_fee,
     line_02_num,
     line_02_fee,
     line_60_num,
     line_60_fee,
     bus_num,
     bus_fee,
     total_num,
     total_fee)
     select day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
          sum(nvl(line_01_num,0)) + sum(nvl(line_02_num,0)) + sum(nvl(line_60_num,0)) + sum(nvl(bus_num,0)) ,
          sum(nvl(line_01_fee,0)) + sum(nvl(line_02_fee,0)) + sum(nvl(line_60_fee,0)) + sum(nvl(bus_fee,0))
      from acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT
     group by day;
--------------------------------------------------------------------------
--ƒ©––◊‹º∆
 insert into acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT(
     day,
     line_01_num,
     line_01_fee,
     line_02_num,
     line_02_fee,
     line_60_num,
     line_60_fee,
     bus_num,
     bus_fee,
     total_num,
     total_fee)
    select '◊‹º∆',
           sum(nvl(line_01_num,0)),
           sum(nvl(line_01_fee,0)),
           sum(nvl(line_02_num,0)),
           sum(nvl(line_02_fee,0)),
           sum(nvl(line_60_num,0)),
           sum(nvl(line_60_fee,0)),
           sum(nvl(bus_num,0)),
           sum(nvl(bus_fee,0)),
           sum(nvl(total_num,0)),
           sum(nvl(total_fee,0))
      from acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT ;

--------------------------------------------------------------------------
 ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_day balance_day,
           day,
           sum(line_01_num) as line_01_num,
           sum(line_01_fee) as line_01_fee,
           sum(line_02_num) as line_02_num,
           sum(line_02_fee) as line_02_fee,
           sum(line_60_num) as line_60_num,
           sum(line_60_fee) as line_60_fee,
           sum(bus_num) as bus_num,
           sum(bus_fee) as bus_fee,
           sum(total_num) as total_num,
           sum(total_fee) as total_fee
      from acc_st.T#UP_OP_MB_CONSUME_DAY_RESULT
      group by day
      order by day;
end UP_OP_MB_CONSUME_DAY;
/
grant execute on ACC_ST.UP_OP_MB_CONSUME_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_MB_DIS_RES_DEAL
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_MB_DIS_RES_DEAL (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_DIS_RES_DEAL
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì-- ÷ª˙÷ß∏∂«Â∑÷Ω·π˚≤Ó“Ï‘¬±®-≥‰÷µ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160112
  --±®±Ì±‡∫≈£∫rpt_10_005
  --◊¢ Õ:
  --¡Ÿ ±±Ì£∫T#OP_MB_DIS_RES_DEAL_ERR_RTP,T#OP_MB_DIS_RES_DEAL_RES

  --ƒ⁄≤ø«ÂÀ„¥ÌŒÛ¥˙¬Î£∫
  --'41':tac¬Î≤ª∫œ∑®
  --'42':º«¬º÷ÿ∏¥
  --'43':…Ë±∏∑«∑®
  --'44':Ωª“◊ ±º‰∑«∑®ªÚ≥¨π˝…Ë∂®∆⁄œﬁ
  --'45':∆±ø®¿‡–Õ∑«∑®
  --'46':Ωª“◊Ω∂Ó∑«∑®ªÚ≥¨π˝…Ë∂®…œœﬁ
  --'47'  :∫⁄√˚µ•ø®
  --'48' : “—ÕÀøÓø®
  --'55':∆‰À˚¥ÌŒÛ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170210
  --–ﬁ∏ƒƒ⁄»›£∫1°¢–ﬁ∏ƒ°∞◊‹≤Ó“Ï°±◊‹ «œ‘ æŒ™0µƒŒ Ã‚
  ------------2°¢–ﬁ∏ƒ°∞TAC≤Ó“Ï°± ˝¡ø”ÎΩ∂Ó ˝æ›ΩªªªŒ Ã‚
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫wuwenxing
  --–ﬁ∏ƒ»’∆⁄£∫20170524
  --–ﬁ∏ƒƒ⁄»›£∫ƒ©––‘ˆº”°∞◊‹º∆°±
---------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_max_day    integer;
  v_i         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
---------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from acc_st.st_mb_sts_acc -- ÷ª˙÷ß∏∂ACC∂‘’À±Ì
   where substr(balance_water_no,1,6) = v_balance_day;
  v_i := 1;
  while v_i <= v_max_day loop
    insert into acc_st.T#OP_MB_DIS_RES_DEAL_RES
    values
      (lpad(v_i,2,0),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0);
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------
--¥ÌŒÛÕ≥º∆±Ì
  insert into acc_st.T#OP_MB_DIS_RES_DEAL_ERR_RTP (
      day,
      deal_fee,
      err_num,
      err_code)
    select substr(balance_water_no,7,2),
          sum(nvl(deal_fee,0)),--20170210 zhouyang ”Îcount(*)µ˜ªªŒª÷√
          count(*),
          err_code
    from acc_st.st_mb_err_deal
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2),err_code;
---------------------------------------------------------------------------

--÷ß∏∂∆ΩÃ®ÀÕ≥ˆ£∫  ÷ª˙÷ß∏∂LCC∂‘’À±Ì
  insert into acc_st.T#OP_MB_DIS_RES_DEAL_RES (
      day,
      mb_deal_num,
      mb_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          sum(nvl(deal_num,0)),
          sum(nvl(deal_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_mb_sts_lcc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);

---------------------------------------------------------------------------
--ACC»∑»œ£∫  ÷ª˙÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_MB_DIS_RES_DEAL_RES (
      day,
      mb_deal_num,
      mb_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          0,
          0,
          sum(nvl(deal_num,0)),
          sum(nvl(deal_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_mb_sts_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
--≤Ó“Ï£∫ ÷ª˙÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_MB_DIS_RES_DEAL_RES (
      day,
      mb_deal_num,
      mb_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          0,
          0,
          0,
          0,
          sum(nvl(diff_deal_num,0)),--20170210 zhouyang
          sum(nvl(diff_deal_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_mb_sts_lcc_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
----≤Ó“Ï‘≠“Ú
  insert into acc_st.T#OP_MB_DIS_RES_DEAL_RES (
      day,
      mb_deal_num,
      mb_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee)
    select day,
          0,
          0,
          0,
          0,
          0,
          0,
          case when err_code = '41' then nvl(err_num,0) else 0 end, ----TAC¥Ì
          case when err_code = '41' then nvl(deal_fee,0) else 0 end,
          case when err_code = '42' then nvl(err_num,0) else 0 end, ----÷ÿ∏¥
          case when err_code = '42' then nvl(deal_fee,0) else 0 end,
          case when err_code = '43' then nvl(err_num,0) else 0 end, ----∑«∑®ø®∫≈
          case when err_code = '43' then nvl(deal_fee,0) else 0 end,
          case when err_code = '47' then nvl(err_num,0) else 0 end, ----∫⁄√˚µ•ø® 47
          case when err_code = '47' then nvl(deal_fee,0) else 0 end,
          case when err_code = '44' then nvl(err_num,0) else 0 end, ----∑«∑® ±º‰
          case when err_code = '44' then nvl(deal_fee,0) else 0 end,
          case when err_code = '45' then nvl(err_num,0) else 0 end, ----Ωª“◊¿‡–Õ¥ÌŒÛ
          case when err_code = '45' then nvl(deal_fee,0) else 0 end,
          case when err_code = '46' then nvl(err_num,0) else 0 end, ----∆±ø®”‡∂Ó∑«∑®
          case when err_code = '46' then nvl(deal_fee,0) else 0 end,

      case when err_code = '48' then nvl(err_num,0) else 0 end, ----“—ÕÀøÓø®
          case when err_code = '48' then nvl(deal_fee,0) else 0 end,

          case when err_code = '55' then nvl(err_num,0) else 0 end, ----Œ¥÷™
          case when err_code = '55' then nvl(deal_fee,0) else 0 end
      from acc_st.T#OP_MB_DIS_RES_DEAL_ERR_RTP;
---------------------------------------------------------------------------
--add by wuwenxing 20170524
--◊‹º∆
  insert into acc_st.T#OP_MB_DIS_RES_DEAL_RES (
      day,
      mb_deal_num,
      mb_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee)
    select '◊‹º∆',
    sum(nvl(mb_deal_num,0)),
      sum(nvl(mb_deal_fee,0)),
      sum(nvl(acc_deal_num,0)),
      sum(nvl(acc_deal_fee,0)),
      sum(nvl(diff_num,0)),
      sum(nvl(diff_fee,0)),
      sum(nvl(tac_num,0)),
      sum(nvl(tac_fee,0)),
      sum(nvl(repeat_num,0)),
      sum(nvl(repeat_fee,0)),
      sum(nvl(nocard_num,0)),
      sum(nvl(nocard_fee,0)),
      sum(nvl(black_list_num,0)),
      sum(nvl(black_list_fee,0)),
      sum(nvl(notime_num,0)),
      sum(nvl(notime_fee,0)),
      sum(nvl(dealerr_num,0)),
      sum(nvl(dealerr_fee,0)),
      sum(nvl(balance_num,0)),
      sum(nvl(balance_fee,0)),
      sum(nvl(returncard_num,0)),
      sum(nvl(returncard_fee,0)),
      sum(nvl(ot_num,0)),
      sum(nvl(ot_fee,0))
    from acc_st.T#OP_MB_DIS_RES_DEAL_RES
          group by day;
---------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           day,
           sum(mb_deal_num) as mb_deal_num,
           sum(mb_deal_fee) as mb_deal_fee,
           sum(acc_deal_num) as acc_deal_num,
           sum(acc_deal_fee) as acc_deal_fee,
           sum(diff_num) as diff_num,
           sum(diff_fee) as diff_fee,
           sum(tac_num) as tac_num,
           sum(tac_fee) as tac_fee,
           sum(repeat_num) as repeat_num,
           sum(repeat_fee) as repeat_fee,
           sum(nocard_num) as nocard_num,
           sum(nocard_fee) as nocard_fee,
           sum(black_list_num) as black_list_num,
           sum(black_list_fee) as black_list_fee,
           sum(notime_num) as notime_num,
           sum(notime_fee) as notime_fee,
           sum(dealerr_num) as dealerr_num,
           sum(dealerr_fee) as dealerr_fee,
           sum(balance_num) as balance_num,
           sum(balance_fee) as balance_fee,
       sum(returncard_num) as returncard_num,
           sum(returncard_fee) as returncard_fee,
           sum(ot_num) as ot_num,
           sum(ot_fee) as ot_fee
      from acc_st.T#OP_MB_DIS_RES_DEAL_RES
     group by day
     order by day;
end;
/
grant execute on ACC_ST.UP_OP_MB_DIS_RES_DEAL to ACC_ST_RPT;
grant execute on ACC_ST.UP_OP_MB_DIS_RES_DEAL to ACC_TK_RPT;


prompt
prompt Creating procedure UP_OP_MB_DIS_RES_RETURN
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_MB_DIS_RES_RETURN (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_DIS_RES_RETURN
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì-- ÷ª˙÷ß∏∂«Â∑÷Ω·π˚≤Ó“Ï‘¬±®-ÕÀøÓ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160112
  --±®±Ì±‡∫≈£∫rpt_10_006
  --◊¢ Õ:
  --¡Ÿ ±±Ì£∫T#OP_MB_DIS_RES_RETURN_ERR_RTP,T#OP_MB_DIS_RES_RETURN_RES

  --ƒ⁄≤ø«ÂÀ„¥ÌŒÛ¥˙¬Î£∫
  --'41':tac¬Î≤ª∫œ∑®
  --'42':º«¬º÷ÿ∏¥
  --'43':…Ë±∏∑«∑®
  --'44':Ωª“◊ ±º‰∑«∑®ªÚ≥¨π˝…Ë∂®∆⁄œﬁ
  --'45':∆±ø®¿‡–Õ∑«∑®
  --'46':Ωª“◊Ω∂Ó∑«∑®ªÚ≥¨π˝…Ë∂®…œœﬁ
  --'47' :∫⁄√˚µ•ø®
  --'48' : “—ÕÀøÓø®
  --'55':∆‰À˚¥ÌŒÛ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫wuwenxing
  --–ﬁ∏ƒ»’∆⁄£∫20170517
  --–ﬁ∏ƒƒ⁄»›£∫ƒ©––‘ˆº”°∞◊‹º∆°±
---------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_max_day    integer;
  v_i         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
---------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from acc_st.st_mb_sts_acc -- ÷ª˙÷ß∏∂ACC∂‘’À±Ì
   where substr(balance_water_no,1,6) = v_balance_day;
  v_i := 1;
  while v_i <= v_max_day loop
    insert into acc_st.T#OP_MB_DIS_RES_RETURN_RES
    values
      (lpad(v_i,2,0),
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
       0,
     0,
       0,
       0);
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------
--¥ÌŒÛÕ≥º∆±Ì ¥ÌŒÛΩ∂Ó = ÕÀø®ƒ⁄Ω∂Ó + ÕÀ—∫Ω - ∑£øÓ -  ÷–¯∑—
  insert into acc_st.T#OP_MB_DIS_RES_RETURN_ERR_RTP (
      day,
      return_fee,
      err_num,
      err_code)
    select substr(balance_water_no,7,2),
          sum(nvl(return_balance_fee,0) + nvl(return_deposit_fee,0) - nvl(penalty_fee,0) - nvl(auxi_fee,0)),
      count(*),
          err_code
    from acc_st.st_mb_err_return
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2),err_code;
---------------------------------------------------------------------------

--÷ß∏∂∆ΩÃ®ÀÕ≥ˆ£∫  ÷ª˙÷ß∏∂LCC∂‘’À±Ì
  insert into acc_st.T#OP_MB_DIS_RES_RETURN_RES (
      day,
      mb_return_num,
      mb_return_fee,
      acc_return_num,
      acc_return_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee
    )
    select substr(balance_water_no,7,2),
          sum(nvl(return_num,0)),
          sum(nvl(return_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
      0,
          0,
          0
    from acc_st.st_mb_sts_lcc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);

---------------------------------------------------------------------------
--ACC»∑»œ£∫  ÷ª˙÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_MB_DIS_RES_RETURN_RES (
      day,
      mb_return_num,
      mb_return_fee,
      acc_return_num,
      acc_return_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee
    )
    select substr(balance_water_no,7,2),
          0,
          0,
          sum(nvl(return_num,0)),
          sum(nvl(return_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
      0,
          0,
          0
    from acc_st.st_mb_sts_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
--≤Ó“Ï£∫  ÷ª˙÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_MB_DIS_RES_RETURN_RES (
      day,
      mb_return_num,
      mb_return_fee,
      acc_return_num,
      acc_return_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee
    )
    select substr(balance_water_no,7,2),
          0,
          0,
      0,
          0,
          sum(nvl(diff_return_num,0)),
          sum(nvl(diff_return_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
      0,
          0,
          0
    from acc_st.st_mb_sts_lcc_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
----≤Ó“Ï‘≠“Ú
  insert into acc_st.T#OP_MB_DIS_RES_RETURN_RES (
      day,
      mb_return_num,
      mb_return_fee,
      acc_return_num,
      acc_return_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee
    )
    select day,
          0,
          0,
          0,
          0,
          0,
          0,
          case when err_code = '41' then nvl(err_num,0) else 0 end, ----TAC¥Ì
          case when err_code = '41' then nvl(return_fee,0) else 0 end,
          case when err_code = '42' then nvl(err_num,0) else 0 end, ----÷ÿ∏¥
          case when err_code = '42' then nvl(return_fee,0) else 0 end,
          case when err_code = '43' then nvl(err_num,0) else 0 end, ----∑«∑®ø®∫≈
          case when err_code = '43' then nvl(return_fee,0) else 0 end,
          case when err_code = '47' then nvl(err_num,0) else 0 end, ----∫⁄√˚µ•ø® 47
          case when err_code = '47' then nvl(return_fee,0) else 0 end,
          case when err_code = '44' then nvl(err_num,0) else 0 end, ----∑«∑® ±º‰
          case when err_code = '44' then nvl(return_fee,0) else 0 end,
          case when err_code = '45' then nvl(err_num,0) else 0 end, ----Ωª“◊¿‡–Õ¥ÌŒÛ
          case when err_code = '45' then nvl(return_fee,0) else 0 end,
          case when err_code = '46' then nvl(err_num,0) else 0 end, ----∆±ø®”‡∂Ó∑«∑®
          case when err_code = '46' then nvl(return_fee,0) else 0 end,

      case when err_code = '48' then nvl(err_num,0) else 0 end, ----“—ÕÀøÓø®
          case when err_code = '48' then nvl(return_fee,0) else 0 end,

          case when err_code = '55' then nvl(err_num,0) else 0 end, ----Œ¥÷™
          case when err_code = '55' then nvl(return_fee,0) else 0 end

      from acc_st.T#OP_MB_DIS_RES_RETURN_ERR_RTP;
---------------------------------------------------------------------------
--add by wuwenxing 20170517
--◊‹º∆
  insert into acc_st.T#OP_MB_DIS_RES_RETURN_RES (
      day,
      mb_return_num,
      mb_return_fee,
      acc_return_num,
      acc_return_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
    returncard_num,
    returncard_fee,
      ot_num,
      ot_fee
    )
    select '◊‹º∆',
    sum(nvl(mb_return_num,0)),
      sum(nvl(mb_return_fee,0)),
      sum(nvl(acc_return_num,0)),
      sum(nvl(acc_return_fee,0)),
      sum(nvl(diff_num,0)),
      sum(nvl(diff_fee,0)),
      sum(nvl(tac_num,0)),
      sum(nvl(tac_fee,0)),
      sum(nvl(repeat_num,0)),
      sum(nvl(repeat_fee,0)),
      sum(nvl(nocard_num,0)),
      sum(nvl(nocard_fee,0)),
      sum(nvl(black_list_num,0)),
      sum(nvl(black_list_fee,0)),
      sum(nvl(notime_num,0)),
      sum(nvl(notime_fee,0)),
      sum(nvl(dealerr_num,0)),
      sum(nvl(dealerr_fee,0)),
      sum(nvl(balance_num,0)),
      sum(nvl(balance_fee,0)),
      sum(nvl(returncard_num,0)),
      sum(nvl(returncard_fee,0)),
      sum(nvl(ot_num,0)),
      sum(nvl(ot_fee,0))
    from acc_st.T#OP_MB_DIS_RES_RETURN_RES
          group by day;
---------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           day,
           sum(mb_return_num) as mb_return_num,
           sum(mb_return_fee) as mb_return_fee,
           sum(acc_return_num) as acc_return_num,
           sum(acc_return_fee) as acc_return_fee,
           sum(diff_num) as diff_num,
           sum(diff_fee) as diff_fee,
           sum(tac_num) as tac_num,
           sum(tac_fee) as tac_fee,
           sum(repeat_num) as repeat_num,
           sum(repeat_fee) as repeat_fee,
           sum(nocard_num) as nocard_num,
           sum(nocard_fee) as nocard_fee,
           sum(black_list_num) as black_list_num,
           sum(black_list_fee) as black_list_fee,
           sum(notime_num) as notime_num,
           sum(notime_fee) as notime_fee,
           sum(dealerr_num) as dealerr_num,
           sum(dealerr_fee) as dealerr_fee,
           sum(balance_num) as balance_num,
           sum(balance_fee) as balance_fee,
       sum(returncard_num) as returncard_num,
           sum(returncard_fee) as returncard_fee,
           sum(ot_num) as ot_num,
           sum(ot_fee) as ot_fee

      from acc_st.T#OP_MB_DIS_RES_RETURN_RES
     group by day
     order by day;
end;
/
grant execute on ACC_ST.UP_OP_MB_DIS_RES_RETURN to ACC_ST_RPT;
grant execute on ACC_ST.UP_OP_MB_DIS_RES_RETURN to ACC_TK_RPT;


prompt
prompt Creating procedure UP_OP_MB_STA_ACC_LCC_DAY
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_MB_STA_ACC_LCC_DAY (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_STA_ACC_LCC_DAY
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì--ACC”Î ÷ª˙÷ß∏∂∂‘’À»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160112
  --±®±Ì±‡∫≈£∫rpt_10_003
  --¡Ÿ ±±Ì£∫T#OP_MB_STA_ACC_LCC_DAY_RESULT
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫mqf
  --–ﬁ∏ƒ»’∆⁄£∫20160823
  --–ﬁ∏ƒƒ⁄»›£∫◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)”…¿€º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)£¨∏ƒŒ™◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  -------------------------------------------------------------------------------
 is
  v_balance_begin_day char(8);
  v_balance_cur_day char(8);
  v_i      integer;
  v_j      integer;
BEGIN
  v_balance_cur_day := substr(in_balance_day,1,8);
  v_balance_begin_day := substr(in_balance_day,1,6) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,7,2) loop
    v_j := 1;
    while v_j <= 3 loop
        insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        values
        (lpad(v_i,2,0),
             to_char(v_j),
             null,
             0,
             0,
             0,
             0,
             0,
             0,
             0,
             0);
        v_j := v_j + 1;
    end loop;
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------------
---- ÷ª˙÷ß∏∂LCC∂‘’À±Ì ∑¢ €Ω∂Ó º¥ ∑¢ €—∫Ω
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           '1',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.st_mb_sts_lcc
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
---- ÷ª˙÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           '2',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.st_mb_sts_acc
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
----- ÷ª˙÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           '3',
           null,
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0)),
           sum(nvl(diff_deal_num,0)),
           sum(nvl(diff_deal_fee,0)),
           sum(nvl(diff_return_num,0)),
           sum(nvl(diff_return_fee,0)),
           sum(nvl(diff_lock_num,0)),
           sum(nvl(diff_unlock_num,0))
      from acc_st.st_mb_sts_lcc_acc
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select '◊‹º∆',
           data_type,
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
      where data_type in ('1','2') --20160823 modify by mqf ÷ª¿€º∆÷ß∏∂∆ΩÃ®°¢ACC
      group by data_type;

  --20160823 modify by mqf  ◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select '◊‹º∆',
           '3',
           null,
           nvl(a.sale_num,0) - nvl(b.sale_num,0),
           nvl(a.deposit_fee,0) - nvl(b.deposit_fee,0),
           nvl(a.deal_num,0) - nvl(b.deal_num,0),
           nvl(a.deal_fee,0) - nvl(b.deal_fee,0),
           nvl(a.return_num,0) - nvl(b.return_num,0),
           nvl(a.return_fee,0) - nvl(b.return_fee,0),
           nvl(a.lock_num,0) - nvl(b.lock_num,0),
           nvl(a.unlock_num,0) - nvl(b.unlock_num,0)
     from
       (select sale_num, deposit_fee , deal_num, deal_fee, return_num, return_fee, lock_num, unlock_num
        from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='1' ) a,
        (select sale_num, deposit_fee , deal_num, deal_fee, return_num, return_fee, lock_num, unlock_num
        from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='2' ) b;


---------------------------------------------------------------------------------
--∏¸–¬data_type_name
  update acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
     set data_type_name= (case when data_type='1'then '÷ß∏∂∆ΩÃ®'
                            when data_type='2'then 'ACC'
                            when data_type='3'then '≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)'
                          end);
---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_day balance_day,
           day,
           data_type,
           data_type_name,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(return_num) as return_num,
           sum(return_fee) as return_fee,
           sum(lock_num) as lock_num,
           sum(unlock_num) as unlock_num
      from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
      group by day,data_type,data_type_name
      order by day,data_type,data_type_name;
end;
/
grant execute on ACC_ST.UP_OP_MB_STA_ACC_LCC_DAY to ACC_ST_RPT;
grant execute on ACC_ST.UP_OP_MB_STA_ACC_LCC_DAY to ACC_TK_RPT;


prompt
prompt Creating procedure UP_OP_MB_STA_ACC_LCC_MON
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_MB_STA_ACC_LCC_MON (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_STA_ACC_LCC_MON
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì--ACC”Î ÷ª˙÷ß∏∂∂‘’À‘¬±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160112
  --±®±Ì±‡∫≈£∫rpt_10_004
  --¡Ÿ ±±Ì£∫T#OP_MB_STA_ACC_LCC_DAY_RESULT
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫mqf
  --–ﬁ∏ƒ»’∆⁄£∫20160823
  --–ﬁ∏ƒƒ⁄»›£∫◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)”…¿€º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)£¨∏ƒŒ™◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  -------------------------------------------------------------------------------
 is
  v_balance_begin_mon char(6);
  v_balance_cur_mon char(6);
  v_i      integer;
  v_j      integer;
BEGIN
  v_balance_cur_mon := substr(in_balance_day,1,6);
  v_balance_begin_mon := substr(in_balance_day,1,4) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,5,2) loop
    v_j := 1;
    while v_j <= 3 loop
        insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        values
        (lpad(v_i,2,0),
             to_char(v_j),
             null,
             0,
             0,
             0,
             0,
             0,
             0,
             0,
             0);
        v_j := v_j + 1;
    end loop;
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------------
---- ÷ª˙÷ß∏∂LCC∂‘’À±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select lpad(substr(balance_water_no,5,2),2,0),
           '1',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.st_mb_sts_lcc
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no,5,2);
---------------------------------------------------------------------------------
---- ÷ª˙÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select lpad(substr(balance_water_no,5,2),2,0),
           '2',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.st_mb_sts_acc
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no,5,2);
---------------------------------------------------------------------------------
----- ÷ª˙÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select lpad(substr(balance_water_no,5,2),2,0),
           '3',
           null,
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0)),
           sum(nvl(diff_deal_num,0)),
           sum(nvl(diff_deal_fee,0)),
           sum(nvl(diff_return_num,0)),
           sum(nvl(diff_return_fee,0)),
           sum(nvl(diff_lock_num,0)),
           sum(nvl(diff_unlock_num,0))
      from acc_st.st_mb_sts_lcc_acc
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no,5,2);
---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select '◊‹º∆',
           data_type,
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0))
      from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
      where data_type in ('1','2') --20160823 modify by mqf ÷ª¿€º∆÷ß∏∂∆ΩÃ®°¢ACC
      group by data_type;

  --20160823 modify by mqf  ◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  insert into acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num)
    select '◊‹º∆',
           '3',
           null,
           nvl(a.sale_num,0) - nvl(b.sale_num,0),
           nvl(a.deposit_fee,0) - nvl(b.deposit_fee,0),
           nvl(a.deal_num,0) - nvl(b.deal_num,0),
           nvl(a.deal_fee,0) - nvl(b.deal_fee,0),
           nvl(a.return_num,0) - nvl(b.return_num,0),
           nvl(a.return_fee,0) - nvl(b.return_fee,0),
           nvl(a.lock_num,0) - nvl(b.lock_num,0),
           nvl(a.unlock_num,0) - nvl(b.unlock_num,0)
     from
       (select sale_num, deposit_fee , deal_num, deal_fee, return_num, return_fee, lock_num, unlock_num
        from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='1' ) a,
        (select sale_num, deposit_fee , deal_num, deal_fee, return_num, return_fee, lock_num, unlock_num
        from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='2' ) b;
---------------------------------------------------------------------------------
--∏¸–¬data_type_name
  update acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
     set data_type_name= (case when data_type='1'then '÷ß∏∂∆ΩÃ®'
                            when data_type='2'then 'ACC'
                            when data_type='3'then '≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)'
                          end);
---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_mon balance_day,
           day,
           data_type,
           data_type_name,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(return_num) as return_num,
           sum(return_fee) as return_fee,
           sum(lock_num) as lock_num,
           sum(unlock_num) as unlock_num
      from acc_st.T#OP_MB_STA_ACC_LCC_DAY_RESULT
      group by day,data_type,data_type_name
      order by day,data_type,data_type_name;
end;
/
grant execute on ACC_ST.UP_OP_MB_STA_ACC_LCC_MON to ACC_ST_RPT;
grant execute on ACC_ST.UP_OP_MB_STA_ACC_LCC_MON to ACC_TK_RPT;


prompt
prompt Creating procedure UP_OP_MB_STA_DEAL_DAY
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_MB_STA_DEAL_DAY (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_STA_DEAL_DAY
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì--ø’÷–Ωª“◊ª„◊‹»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160112
  --±®±Ì±‡∫≈£∫rpt_10_001
  --¡Ÿ ±±Ì£∫T#OP_MB_STA_DEAL_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_balance_begin_day char(8);
  v_balance_cur_day char(8);
  v_i      integer;
BEGIN
  v_balance_cur_day := substr(in_balance_day,1,8);
  v_balance_begin_day := substr(in_balance_day,1,6) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,7,2) loop
    insert into T#OP_MB_STA_DEAL_DAY_RESULT
    values
      (lpad(v_i,2,0), 
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0);
    v_i := v_i + 1;
  end loop;
---- ÷ª˙÷ß∏∂∑¢ €Õ≥º∆±Ì
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from acc_st.st_mb_sts_sale
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
-- ÷ª˙÷ß∏∂≥‰÷µÕ≥º∆±Ì
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0,
           0,
           0,
           0,
           0
      from acc_st.st_mb_sts_deal
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
-- ÷ª˙÷ß∏∂ÕÀøÓÕ≥º∆±Ì ÕÀøÓΩ∂Ó = ÕÀø®ƒ⁄Ω∂Ó + ÕÀ—∫Ω - ∑£øÓ -  ÷–¯∑—
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           0,
           0,
           sum(nvl(return_num,0)),
		   sum(nvl(return_balance_fee,0) + nvl(return_deposit_fee,0) - nvl(penalty_fee,0) - nvl(auxi_fee,0)),
           0,
           0,
           0,
           0
      from acc_st.st_mb_sts_return
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
-- ÷ª˙÷ß∏∂º”Ω‚À¯Õ≥º∆±Ì
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(case lock_flag when '1' then nvl(lock_num,0) else 0 end) lock_num,
           sum(case lock_flag when '2' then nvl(lock_num,0) else 0 end) unlock_num,
           0,
           0
      from acc_st.st_mb_sts_lock
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------  
--Œ≤¡–∫œº∆      
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(nvl(sale_num,0) + nvl(deal_num,0) + nvl(return_num,0)+nvl(lock_num,0)+nvl(unlock_num,0)) total_num,
           sum(nvl(deposit_fee,0) + nvl(deal_fee,0) - nvl(return_fee,0)) total_fee
      from acc_st.T#OP_MB_STA_DEAL_DAY_RESULT
     group by day;
--------------------------------------------------------------------------------- 
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select '◊‹º∆',
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0)),
           sum(nvl(total_num,0)),
           sum(nvl(total_fee,0))
      from acc_st.T#OP_MB_STA_DEAL_DAY_RESULT;
--------------------------------------------------------------------------------- 
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_day balance_day,
           day,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(return_num) as return_num,
           sum(return_fee) as return_fee,
           sum(lock_num) as lock_num,
           sum(unlock_num) as unlock_num,
           sum(total_num) as total_num,
           sum(total_fee) as total_fee
      from T#OP_MB_STA_DEAL_DAY_RESULT
      group by day
      order by day;
end;
/
grant execute on ACC_ST.UP_OP_MB_STA_DEAL_DAY to ACC_ST_RPT;
grant execute on ACC_ST.UP_OP_MB_STA_DEAL_DAY to ACC_TK_RPT;


prompt
prompt Creating procedure UP_OP_MB_STA_DEAL_MON
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_MB_STA_DEAL_MON (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_MB_STA_DEAL_MON
  --π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂±®±Ì--ø’÷–Ωª“◊ª„◊‹‘¬±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ mqf
  --¥¥Ω®»’∆⁄£∫20160112
  --±®±Ì±‡∫≈£∫rpt_10_002
  --¡Ÿ ±±Ì£∫T#OP_MB_STA_DEAL_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_balance_begin_mon char(6);
  v_balance_cur_mon char(6);
  v_i      integer;
BEGIN
  v_balance_cur_mon := substr(in_balance_day,1,6);
  v_balance_begin_mon := substr(in_balance_day,1,4) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,5,2) loop
    insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT
    values
      (lpad(v_i,2,0), 
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0);
    v_i := v_i + 1;
  end loop;
---- ÷ª˙÷ß∏∂∑¢ €Õ≥º∆±Ì
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 5, 2),2,0),
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0
      from acc_st.st_mb_sts_sale
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no, 5, 2);
---------------------------------------------------------------------------------
-- ÷ª˙÷ß∏∂≥‰÷µÕ≥º∆±Ì
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 5, 2),2,0),
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0,
           0,
           0,
           0,
           0
      from acc_st.st_mb_sts_deal
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no, 5, 2);
---------------------------------------------------------------------------------
-- ÷ª˙÷ß∏∂ÕÀøÓÕ≥º∆±Ì  ÕÀøÓΩ∂Ó = ÕÀø®ƒ⁄Ω∂Ó + ÕÀ—∫Ω - ∑£øÓ -  ÷–¯∑—
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 5, 2),2,0),
           0,
           0,
           0,
           0,
           sum(nvl(return_num,0)),
		   sum(nvl(return_balance_fee,0) + nvl(return_deposit_fee,0) - nvl(penalty_fee,0) - nvl(auxi_fee,0)),
           0,
           0,
           0,
           0
      from acc_st.st_mb_sts_return
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no, 5, 2);
---------------------------------------------------------------------------------
-- ÷ª˙÷ß∏∂º”Ω‚À¯Õ≥º∆±Ì
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 5, 2),2,0),
           0,
           0,
           0,
           0,
           0,
           0,
           sum(case lock_flag when '1' then nvl(lock_num,0) else 0 end) lock_num,
           sum(case lock_flag when '2' then nvl(lock_num,0) else 0 end) unlock_num,
           0,
           0
      from acc_st.st_mb_sts_lock
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no, 5, 2);
---------------------------------------------------------------------------------  
--Œ≤¡–∫œº∆      
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select day,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           0,
           sum(nvl(sale_num,0) + nvl(deal_num,0) + nvl(return_num,0)+nvl(lock_num,0)+nvl(unlock_num,0)) total_num,
           sum(nvl(deposit_fee,0) + nvl(deal_fee,0) - nvl(return_fee,0)) total_fee
      from acc_st.T#OP_MB_STA_DEAL_DAY_RESULT
     group by day;
--------------------------------------------------------------------------------- 
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_MB_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee,
     return_num,
     return_fee,
     lock_num,
     unlock_num,
     total_num,
     total_fee)
    select '◊‹º∆',
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(return_num,0)),
           sum(nvl(return_fee,0)),
           sum(nvl(lock_num,0)),
           sum(nvl(unlock_num,0)),
           sum(nvl(total_num,0)),
           sum(nvl(total_fee,0))
      from acc_st.T#OP_MB_STA_DEAL_DAY_RESULT;
--------------------------------------------------------------------------------- 
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_mon balance_day,
           day,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(return_num) as return_num,
           sum(return_fee) as return_fee,
           sum(lock_num) as lock_num,
           sum(unlock_num) as unlock_num,
           sum(total_num) as total_num,
           sum(total_fee) as total_fee
      from acc_st.T#OP_MB_STA_DEAL_DAY_RESULT
      group by day
      order by day;
end;
/
grant execute on ACC_ST.UP_OP_MB_STA_DEAL_MON to ACC_ST_RPT;
grant execute on ACC_ST.UP_OP_MB_STA_DEAL_MON to ACC_TK_RPT;


prompt
prompt Creating procedure UP_OP_NP_DIS_RES_DEAL
prompt ========================================
prompt
create or replace procedure acc_st.UP_OP_NP_DIS_RES_DEAL(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_DIS_RES_DEAL
  --π¶ƒ‹√Ë ˆ£∫Õ≥º∆ª•¡™Õ¯÷ß∏∂≥‰÷µ«Â∑÷Ω·π˚≤Ó“Ï‘¬±®
  --±®±Ì√˚£∫ª•¡™Õ¯÷ß∏∂«Â∑÷Ω·π˚≤Ó“Ï‘¬±®-≥‰÷µ
  --±®±Ì±‡∫≈£∫rpt_11_006
  --‘≠ º±Ì£∫st_np_err_deal,st_np_sts_lcc,st_np_sts_acc,st_np_sts_lcc_acc
  --¡Ÿ ±±Ì£∫T#OP_NP_DIS_RES_DEAL_ERR_RTP,T#OP_NP_DIS_RES_DEAL_RES
  --¥¥Ω®’ﬂ£∫ zzq
  --¥¥Ω®»’∆⁄£∫20161125


  --ƒ⁄≤ø«ÂÀ„¥ÌŒÛ¥˙¬Î£∫
  --'41':tac¬Î≤ª∫œ∑®
  --'42':º«¬º÷ÿ∏¥
  --'43':…Ë±∏∑«∑®
  --'44':Ωª“◊ ±º‰∑«∑®ªÚ≥¨π˝…Ë∂®∆⁄œﬁ
  --'45':∆±ø®¿‡–Õ∑«∑®
  --'46':Ωª“◊Ω∂Ó∑«∑®ªÚ≥¨π˝…Ë∂®…œœﬁ
  --'47'  :∫⁄√˚µ•ø®
  --'55':∆‰À˚¥ÌŒÛ
---------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170516
  --–ﬁ∏ƒƒ⁄»›£∫ƒ©––‘ˆº”°∞◊‹º∆°±
---------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_max_day    integer;
  v_i         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
---------------------------------------------------------------------------
insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES
    values
      ('01',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '');
----ππΩ®Ω·π˚ºØΩ·ππ
  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from acc_st.st_np_sts_acc --ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
   where substr(balance_water_no,1,6) = v_balance_day;
  v_i := 1;
  while v_i <= v_max_day loop
    insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES
    values
      (lpad(v_i,2,0),
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '');
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------
--¥ÌŒÛÕ≥º∆±Ì
  insert into acc_st.T#OP_NP_DIS_RES_DEAL_ERR_RTP (
      day,
      err_num,
      deal_fee,
      err_code)
    select substr(balance_water_no,7,2),
          count(*),
          sum(nvl(deal_fee,0)),
          err_code
    from acc_st.st_np_err_deal
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2),err_code;
---------------------------------------------------------------------------

--÷ß∏∂∆ΩÃ®ÀÕ≥ˆ£∫ª•¡™Õ¯÷ß∏∂LCC∂‘’À±Ì
  insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES (
      day,
      np_deal_num,
      np_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          sum(nvl(charge_num,0)),
          sum(nvl(charge_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_np_sts_lcc --ª•¡™Õ¯÷ß∏∂LCC∂‘’ÀÕ≥º∆±Ì
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);

---------------------------------------------------------------------------
--ACC»∑»œ£∫ ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES (
      day,
      np_deal_num,
      np_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          0,
          0,
          sum(nvl(deal_num,0)),
          sum(nvl(deal_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_np_sts_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
--≤Ó“Ï£∫ª•¡™Õ¯÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES (
      day,
      np_deal_num,
      np_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          0,
          0,
          0,
          0,
          sum(nvl(diff_deal_num,0)),
          sum(nvl(diff_deal_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_np_sts_lcc_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
----≤Ó“Ï‘≠“Ú
  insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES (
      day,
      np_deal_num,
      np_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select day,
          0,
          0,
          0,
          0,
          0,
          0,
          case when err_code = '41' then nvl(err_num,0) else 0 end, ----TAC¥Ì
          case when err_code = '41' then nvl(deal_fee,0) else 0 end,
          case when err_code = '42' then nvl(err_num,0) else 0 end, ----÷ÿ∏¥
          case when err_code = '42' then nvl(deal_fee,0) else 0 end,
          case when err_code = '43' then nvl(err_num,0) else 0 end, ----∑«∑®ø®∫≈
          case when err_code = '43' then nvl(deal_fee,0) else 0 end,
          case when err_code = '47' then nvl(err_num,0) else 0 end, ----∫⁄√˚µ•ø® 47
          case when err_code = '47' then nvl(deal_fee,0) else 0 end,
          case when err_code = '44' then nvl(err_num,0) else 0 end, ----∑«∑® ±º‰
          case when err_code = '44' then nvl(deal_fee,0) else 0 end,
          case when err_code = '45' then nvl(err_num,0) else 0 end, ----Ωª“◊¿‡–Õ¥ÌŒÛ
          case when err_code = '45' then nvl(deal_fee,0) else 0 end,
          case when err_code = '46' then nvl(err_num,0) else 0 end, ----∆±ø®”‡∂Ó∑«∑®
          case when err_code = '46' then nvl(deal_fee,0) else 0 end,
          case when err_code = '55' then nvl(err_num,0) else 0 end, ----Œ¥÷™
          case when err_code = '55' then nvl(deal_fee,0) else 0 end
      from acc_st.T#OP_NP_DIS_RES_DEAL_ERR_RTP;
---------------------------------------------------------------------------
--add by zhouyang 20170516
--◊‹º∆
  insert into acc_st.T#OP_NP_DIS_RES_DEAL_RES (
      day,
      np_deal_num,
      np_deal_fee,
      acc_deal_num,
      acc_deal_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select '◊‹º∆',
      sum(nvl(np_deal_num,0)),
      sum(nvl(np_deal_fee,0)),
      sum(nvl(acc_deal_num,0)),
      sum(nvl(acc_deal_fee,0)),
      sum(nvl(diff_num,0)),
      sum(nvl(diff_fee,0)),
      sum(nvl(tac_num,0)),
      sum(nvl(tac_fee,0)),
      sum(nvl(repeat_num,0)),
      sum(nvl(repeat_fee,0)),
      sum(nvl(nocard_num,0)),
      sum(nvl(nocard_fee,0)),
      sum(nvl(black_list_num,0)),
      sum(nvl(black_list_fee,0)),
      sum(nvl(notime_num,0)),
      sum(nvl(notime_fee,0)),
      sum(nvl(dealerr_num,0)),
      sum(nvl(dealerr_fee,0)),
      sum(nvl(balance_num,0)),
      sum(nvl(balance_fee,0)),
      sum(nvl(ot_num,0)),
      sum(nvl(ot_fee,0))
    from acc_st.T#OP_NP_DIS_RES_DEAL_RES
          group by day;
---------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           day,
           nvl(sum(np_deal_num),0) as np_deal_num,
           nvl(sum(np_deal_fee),0) as np_deal_fee,
           nvl(sum(acc_deal_num),0) as acc_deal_num,
           nvl(sum(acc_deal_fee),0) as acc_deal_fee,
           nvl(sum(diff_num),0) as diff_num,
           nvl(sum(diff_fee),0) as diff_fee,
           nvl(sum(tac_num),0) as tac_num,
           nvl(sum(tac_fee),0) as tac_fee,
           nvl(sum(repeat_num),0) as repeat_num,
           nvl(sum(repeat_fee),0) as repeat_fee,
           nvl(sum(nocard_num),0) as nocard_num,
           nvl(sum(nocard_fee),0) as nocard_fee,
           nvl(sum(black_list_num),0) as black_list_num,
           nvl(sum(black_list_fee),0) as black_list_fee,
           nvl(sum(notime_num),0) as notime_num,
           nvl(sum(notime_fee),0) as notime_fee,
           nvl(sum(dealerr_num),0) as dealerr_num,
           nvl(sum(dealerr_fee),0) as dealerr_fee,
           nvl(sum(balance_num),0) as balance_num,
           nvl(sum(balance_fee),0) as balance_fee,
           nvl(sum(ot_num),0) as ot_num,
           nvl(sum(ot_fee),0) as ot_fee
      from acc_st.T#OP_NP_DIS_RES_DEAL_RES
     group by day
     order by day;
end  ;
/
grant execute on ACC_ST.UP_OP_NP_DIS_RES_DEAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_DIS_RES_SALE
prompt ========================================
prompt
create or replace procedure acc_st.UP_OP_NP_DIS_RES_SALE(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_DIS_RES_SALE
  --π¶ƒ‹√Ë ˆ£∫Õ≥º∆ª•¡™Õ¯÷ß∏∂∑¢ €«Â∑÷Ω·π˚≤Ó“Ï ‘¬±®
  --±®±Ì√˚◊÷£∫ª•¡™Õ¯÷ß∏∂«Â∑÷Ω·π˚≤Ó“Ï‘¬±®-∑¢ €
  --±®±Ì±‡∫≈£∫rpt_11_005
  --‘≠ º±Ì£∫st_np_err_sale,st_np_sts_lcc,st_np_sts_acc,st_np_sts_lcc_acc
  --¡Ÿ ±±Ì£∫T#OP_NP_DIS_RES_SALE_ERR_RTP,T#OP_NP_DIS_RES_SALE_RES
  --¥¥Ω®’ﬂ£∫ zzq
  --¥¥Ω®»’∆⁄£∫20161128


  --ƒ⁄≤ø«ÂÀ„¥ÌŒÛ¥˙¬Î£∫
  --'41':tac¬Î≤ª∫œ∑®
  --'42':º«¬º÷ÿ∏¥
  --'43':…Ë±∏∑«∑®
  --'44':Ωª“◊ ±º‰∑«∑®ªÚ≥¨π˝…Ë∂®∆⁄œﬁ
  --'45':∆±ø®¿‡–Õ∑«∑®
  --'46':Ωª“◊Ω∂Ó∑«∑®ªÚ≥¨π˝…Ë∂®…œœﬁ
  --'47'  :∫⁄√˚µ•ø®
  --'55':∆‰À˚¥ÌŒÛ
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170516
  --–ﬁ∏ƒƒ⁄»›£∫ƒ©––‘ˆº”°∞◊‹º∆°±
---------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_max_day    integer;
  v_i         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
---------------------------------------------------------------------------
insert into acc_st.T#OP_NP_DIS_RES_SALE_RES
    values
      ('01',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '');
----ππΩ®Ω·π˚ºØΩ·ππ
  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from acc_st.st_np_sts_acc --ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
   where substr(balance_water_no,1,6) = v_balance_day;
  v_i := 1;
  while v_i <= v_max_day loop
    insert into acc_st.T#OP_NP_DIS_RES_SALE_RES
    values
      (lpad(v_i,2,0),
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '',
       '',
       '',
      '',
       '',
       '');
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------
--¥ÌŒÛÕ≥º∆±Ì
  insert into acc_st.T#OP_NP_DIS_RES_SALE_ERR_RTP (
      day,
      err_num,
      sale_fee,
      err_code)
    select substr(balance_water_no,7,2),
          count(*),
          sum(nvl(sale_fee,0)),
          err_code
    from acc_st.st_np_err_sale
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2),err_code;
---------------------------------------------------------------------------

--÷ß∏∂∆ΩÃ®ÀÕ≥ˆ£∫ª•¡™Õ¯÷ß∏∂LCC∂‘’À±Ì
  insert into acc_st.T#OP_NP_DIS_RES_SALE_RES (
      day,
      np_sale_num,
      np_sale_fee,
      acc_sale_num,
      acc_sale_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          sum(nvl(sale_num,0)),
          sum(nvl(sale_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_np_sts_lcc --ª•¡™Õ¯÷ß∏∂LCC∂‘’ÀÕ≥º∆±Ì
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);

---------------------------------------------------------------------------
--ACC»∑»œ£∫ ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_NP_DIS_RES_SALE_RES (
      day,
      np_sale_num,
      np_sale_fee,
      acc_sale_num,
      acc_sale_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          0,
          0,
          sum(nvl(sale_num,0)),
          sum(nvl(sale_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_np_sts_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
--≤Ó“Ï£∫ª•¡™Õ¯÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_NP_DIS_RES_SALE_RES (
      day,
      np_sale_num,
      np_sale_fee,
      acc_sale_num,
      acc_sale_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select substr(balance_water_no,7,2),
          0,
          0,
          0,
          0,
          sum(nvl(diff_sale_num,0)),
          sum(nvl(diff_sale_fee,0)),
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0
    from acc_st.st_np_sts_lcc_acc
    where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);
---------------------------------------------------------------------------
----≤Ó“Ï‘≠“Ú
  insert into acc_st.T#OP_NP_DIS_RES_SALE_RES (
      day,
      np_sale_num,
      np_sale_fee,
      acc_sale_num,
      acc_sale_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select day,
          0,
          0,
          0,
          0,
          0,
          0,
          case when err_code = '41' then nvl(err_num,0) else 0 end, ----TAC¥Ì
          case when err_code = '41' then nvl(sale_fee,0) else 0 end,
          case when err_code = '42' then nvl(err_num,0) else 0 end, ----÷ÿ∏¥
          case when err_code = '42' then nvl(sale_fee,0) else 0 end,
          case when err_code = '43' then nvl(err_num,0) else 0 end, ----∑«∑®ø®∫≈
          case when err_code = '43' then nvl(sale_fee,0) else 0 end,
          case when err_code = '47' then nvl(err_num,0) else 0 end, ----∫⁄√˚µ•ø® 47
          case when err_code = '47' then nvl(sale_fee,0) else 0 end,
          case when err_code = '44' then nvl(err_num,0) else 0 end, ----∑«∑® ±º‰
          case when err_code = '44' then nvl(sale_fee,0) else 0 end,
          case when err_code = '45' then nvl(err_num,0) else 0 end, ----Ωª“◊¿‡–Õ¥ÌŒÛ
          case when err_code = '45' then nvl(sale_fee,0) else 0 end,
          case when err_code = '46' then nvl(err_num,0) else 0 end, ----∆±ø®”‡∂Ó∑«∑®
          case when err_code = '46' then nvl(sale_fee,0) else 0 end,
          case when err_code = '55' then nvl(err_num,0) else 0 end, ----Œ¥÷™
          case when err_code = '55' then nvl(sale_fee,0) else 0 end
      from acc_st.T#OP_NP_DIS_RES_SALE_ERR_RTP;
---------------------------------------------------------------------------
--add by zhouyang 20170516
--◊‹º∆
  insert into acc_st.T#OP_NP_DIS_RES_SALE_RES (
      day,
      np_sale_num,
      np_sale_fee,
      acc_sale_num,
      acc_sale_fee,
      diff_num,
      diff_fee,
      tac_num,
      tac_fee,
      repeat_num,
      repeat_fee,
      nocard_num,
      nocard_fee,
      black_list_num,
      black_list_fee,
      notime_num,
      notime_fee,
      dealerr_num,
      dealerr_fee,
      balance_num,
      balance_fee,
      ot_num,
      ot_fee)
    select '◊‹º∆',
      sum(nvl(np_sale_num,0)),
      sum(nvl(np_sale_fee,0)),
      sum(nvl(acc_sale_num,0)),
      sum(nvl(acc_sale_fee,0)),
      sum(nvl(diff_num,0)),
      sum(nvl(diff_fee,0)),
      sum(nvl(tac_num,0)),
      sum(nvl(tac_fee,0)),
      sum(nvl(repeat_num,0)),
      sum(nvl(repeat_fee,0)),
      sum(nvl(nocard_num,0)),
      sum(nvl(nocard_fee,0)),
      sum(nvl(black_list_num,0)),
      sum(nvl(black_list_fee,0)),
      sum(nvl(notime_num,0)),
      sum(nvl(notime_fee,0)),
      sum(nvl(dealerr_num,0)),
      sum(nvl(dealerr_fee,0)),
      sum(nvl(balance_num,0)),
      sum(nvl(balance_fee,0)),
      sum(nvl(ot_num,0)),
      sum(nvl(ot_fee,0))
    from acc_st.T#OP_NP_DIS_RES_SALE_RES
    group by day;
---------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
           day,
           nvl(sum(np_sale_num),0) as np_sale_num,
           nvl(sum(np_sale_fee),0) as np_sale_fee,
           nvl(sum(acc_sale_num),0) as acc_sale_num,
           nvl(sum(acc_sale_fee),0) as acc_sale_fee,
           nvl(sum(diff_num),0) as diff_num,
           nvl(sum(diff_fee),0) as diff_fee,
           nvl(sum(tac_num),0) as tac_num,
           nvl(sum(tac_fee),0) as tac_fee,
           nvl(sum(repeat_num),0) as repeat_num,
           nvl(sum(repeat_fee),0) as repeat_fee,
           nvl(sum(nocard_num),0) as nocard_num,
           nvl(sum(nocard_fee),0) as nocard_fee,
           nvl(sum(black_list_num),0) as black_list_num,
           nvl(sum(black_list_fee),0) as black_list_fee,
           nvl(sum(notime_num),0) as notime_num,
           nvl(sum(notime_fee),0) as notime_fee,
           nvl(sum(dealerr_num),0) as dealerr_num,
           nvl(sum(dealerr_fee),0) as dealerr_fee,
           nvl(sum(balance_num),0) as balance_num,
           nvl(sum(balance_fee),0) as balance_fee,
           nvl(sum(ot_num),0) as ot_num,
           nvl(sum(ot_fee),0) as ot_fee
      from acc_st.T#OP_NP_DIS_RES_SALE_RES
     group by day
     order by day;
end  ;
/
grant execute on ACC_ST.UP_OP_NP_DIS_RES_SALE to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_ORD_DEAL_DIS_DEAL
prompt =============================================
prompt
create or replace procedure acc_st.UP_OP_NP_ORD_DEAL_DIS_DEAL(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_ORD_DEAL_DIS_DEAL
  --π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂±®±Ì--ª•¡™Õ¯∂©µ•”ÎΩª“◊≤Ó“Ïª„◊‹‘¬±®-≥‰÷µ
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ldz
  --¥¥Ω®»’∆⁄£∫20161129
  --±®±Ì±‡∫≈£∫rpt_11_008
  --◊¢ Õ:
  --¡Ÿ ±±Ì£∫T#OP_NP_ORD_DEAL_DIS_RESULT

  --modify by ldz 2016.12.12
  --∂©µ•£∫ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”Õ≥º∆±Ìdeal_num∏ƒ≥…order_num
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170516
  --–ﬁ∏ƒƒ⁄»›£∫ƒ©––‘ˆº”°∞◊‹º∆°±
---------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_max_day    integer;
  v_i         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
 ---------------------------------------------------------------------------
insert into acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
    values
      (
      '01',
       '',
       '',
       '',
       '',
      '',
       '');

  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from acc_st.st_np_sts_order_imp --ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”Õ≥º∆±Ì
   where substr(balance_water_no,1,6) = v_balance_day;
  v_i := 1;
  while v_i <= v_max_day loop
    insert into acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
    values
      (lpad(v_i,2,0),
       '',
       '',
       '',
       '',
      '',
       '');
     v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------
 --∂©µ•£∫ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”Õ≥º∆±Ì
     insert into acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT(
     day,
     order_deal_num,
     order_deal_fee,
     acc_deal_num,
     acc_deal_fee,
     diff_num,
     diff_fee)
       select substr(balance_water_no,7,2),
          sum(nvl(order_num,0)),
          sum(nvl(deal_fee,0)),
          0,
          0,
          0,
          0
          from acc_st.st_np_sts_order_imp
          where substr(balance_water_no,1,6) = v_balance_day and status in ('01') and order_type in ('02')
          group by substr(balance_water_no,7,2);

---------------------------------------------------------------------------
--ACCΩª“◊£∫ ª•¡™Õ¯÷ß∏∂∑¢ €Õ≥º∆±Ì
       insert into acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
      (
     day,
     order_deal_num,
     order_deal_fee,
     acc_deal_num,
     acc_deal_fee,
     diff_num,
     diff_fee)
       select substr(balance_water_no,7,2),
          0,
          0,
          sum(nvl(deal_num,0)),
          sum(nvl(deal_fee,0)),
          0,
          0
          from acc_st.st_np_sts_deal
          where substr(balance_water_no,1,6) = v_balance_day and pay_mode_id = '14'
          group by substr(balance_water_no,7,2);


---------------------------------------------------------------------------
--≤Ó“Ï£∫ ∂©µ•-ACCΩª“◊
          insert into acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
          (
          day,
          order_deal_num,
          order_deal_fee,
          acc_deal_num,
          acc_deal_fee,
          diff_num,
          diff_fee)
           select day,
           0,
           0,
           0,
           0,
           order_deal_num - acc_deal_num,
           order_deal_fee - acc_deal_fee
           from acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT;
---------------------------------------------------------------------------
--add by zhouyang 20170516
--◊‹º∆
       insert into acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
        (
         day,
         order_deal_num,
         order_deal_fee,
         acc_deal_num,
         acc_deal_fee,
         diff_num,
         diff_fee)
       select '◊‹º∆',
         sum(nvl(order_deal_num,0)),
         sum(nvl(order_deal_fee,0)),
         sum(nvl(acc_deal_num,0)),
         sum(nvl(acc_deal_fee,0)),
         sum(nvl(diff_num,0)),
         sum(nvl(diff_fee,0))
       from acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
       group by day;


---------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
     day,
     nvl(sum(order_deal_num),0) as order_deal_num,
     nvl(sum(order_deal_fee),0) as order_deal_fee,
     nvl(sum(acc_deal_num),0) as acc_deal_num,
     nvl(sum(acc_deal_fee),0) as acc_deal_fee,
     nvl(sum(diff_num),0) as diff_num,
     nvl(sum(diff_fee),0) as diff_fee
     from acc_st.T#OP_NP_ORD_DEAL_DIS_RESULT
     group by day
     order by day;
end  ;
/
grant execute on ACC_ST.UP_OP_NP_ORD_DEAL_DIS_DEAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_ORD_DEAL_DIS_SALE
prompt =============================================
prompt
create or replace procedure acc_st.UP_OP_NP_ORD_DEAL_DIS_SALE(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_ORD_DEAL_DIS_SALE
  --π¶ƒ‹√Ë ˆ£∫Õ≥º∆ª•¡™Õ¯∂©µ•∑¢ €”ÎΩª“◊≤Ó“Ï ‘¬±®
  --±®±Ì√˚£∫ª•¡™Õ¯∂©µ•”ÎΩª“◊≤Ó“Ï‘¬±®-∑¢ €
  --±®±Ì±‡∫≈£∫rpt_11_007
  --‘≠ º±Ì£∫st_np_sts_order_imp,st_np_sts_sale
  --¡Ÿ ±±Ì£∫T#OP_NP_ORD_DEAL_DIS_SALE_RES
  --¥¥Ω®’ﬂ£∫ zzq
  --¥¥Ω®»’∆⁄£∫20161129


  --∂©µ•◊¥Ã¨¥˙¬Î£∫
  --'01':Ωª“◊≥…π¶
  --'02':Ωª“◊≤ø∑÷≥…π¶
  --'10':∂©µ•»°œ˚
  --'11':∂©µ•≤ø∑÷ÕÀøÓ
  --'99':∆‰À˚

  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒ»’∆⁄£∫20170516
  --–ﬁ∏ƒƒ⁄»›£∫ƒ©––‘ˆº”°∞◊‹º∆°±
---------------------------------------------------------------------------------
 is
  v_balance_day varchar(6);
  v_max_day    integer;
  v_i         integer;
BEGIN
  v_balance_day := substr(in_balance_day, 1, 6);
 ---------------------------------------------------------------------------
insert into acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
    values
      ('01',
       '',
       '',
       '',
       '',
      '',
       '');

  select max(to_number(substr(balance_water_no,7,2)))
    into v_max_day
    from acc_st.st_np_sts_order_imp --ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”Õ≥º∆±Ì
   where substr(balance_water_no,1,6) = v_balance_day;
  v_i := 1;
  while v_i <= v_max_day loop
    insert into acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
    values
      (lpad(v_i,2,0),
       '',
       '',
       '',
       '',
      '',
       '');
     v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------
 --∂©µ•£∫ª•¡™Õ¯÷ß∏∂∂©µ•÷¥––Ω·π˚∂”Õ≥º∆±Ì
       insert into acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES(
       day,
       np_sale_num,
       np_sale_fee,
       acc_sale_num,
       acc_sale_fee,
       diff_sale_num,
       diff_sale_fee)
       select substr(balance_water_no,7,2),
          sum(nvl(deal_num,0)),
          sum(nvl(deal_fee,0)),
          0,
          0,
          0,
          0
          from acc_st.st_np_sts_order_imp
          where substr(balance_water_no,1,6) = v_balance_day and status in ('01','02')
          group by substr(balance_water_no,7,2);

---------------------------------------------------------------------------
--ACCΩª“◊£∫ ª•¡™Õ¯÷ß∏∂∑¢ €Õ≥º∆±Ì
       insert into acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
      (day,
       np_sale_num,
       np_sale_fee,
       acc_sale_num,
       acc_sale_fee,
       diff_sale_num,
       diff_sale_fee)
       select substr(balance_water_no,7,2),
          0,
          0,
          sum(nvl(sale_num,0)),
          sum(nvl(sale_fee,0)),
          0,
          0
          from acc_st.st_np_sts_sale
          where substr(balance_water_no,1,6) = v_balance_day
          group by substr(balance_water_no,7,2);


---------------------------------------------------------------------------
--≤Ó“Ï£∫ ∂©µ•-ACCΩª“◊
          insert into acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
          (day,
           np_sale_num,
           np_sale_fee,
           acc_sale_num,
           acc_sale_fee,
           diff_sale_num,
           diff_sale_fee)
           select day,
           0,
           0,
           0,
           0,
           np_sale_num - acc_sale_num,
           np_sale_fee - acc_sale_fee
           from acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES;
---------------------------------------------------------------------------
--add by zhouyang 20170516
--◊‹º∆
          insert into acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
          (day,
           np_sale_num,
           np_sale_fee,
           acc_sale_num,
           acc_sale_fee,
           diff_sale_num,
           diff_sale_fee)
          select '◊‹º∆',
           sum(nvl(np_sale_num,0)),
           sum(nvl(np_sale_fee,0)),
           sum(nvl(acc_sale_num,0)),
           sum(nvl(acc_sale_fee,0)),
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0))
          from acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
          group by day;
---------------------------------------------------------------------------
----∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_day balance_day,
     day,
     nvl(sum(np_sale_num),0) as np_sale_num,
     nvl(sum(np_sale_fee),0) as np_sale_fee,
     nvl(sum(acc_sale_num),0) as acc_sale_num,
     nvl(sum(acc_sale_fee),0) as acc_sale_fee,
     nvl(sum(diff_sale_num),0) as diff_sale_num,
     nvl(sum(diff_sale_fee),0) as diff_sale_fee
     from acc_st.T#OP_NP_ORD_DEAL_DIS_SALE_RES
     group by day
     order by day;
end  ;
/
grant execute on ACC_ST.UP_OP_NP_ORD_DEAL_DIS_SALE to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_STA_ACC_LCC_DAY
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_NP_STA_ACC_LCC_DAY (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_STA_ACC_LCC_DAY
  --π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂±®±Ì--ACC”Îª•¡™Õ¯÷ß∏∂∂‘’À»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zy
  --¥¥Ω®»’∆⁄£∫20161125
  --±®±Ì±‡∫≈£∫rpt_11_003
  --¡Ÿ ±±Ì£∫T#OP_NP_STA_ACC_LCC_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_balance_begin_day char(8);
  v_balance_cur_day char(8);
  v_i      integer;
  v_j      integer;
BEGIN
  v_balance_cur_day := substr(in_balance_day,1,8);
  v_balance_begin_day := substr(in_balance_day,1,6) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,7,2) loop
    v_j := 1;
    while v_j <= 3 loop
        insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        values
        (lpad(v_i,2,0),
             to_char(v_j),
             null,
             0,
             0,
             0,
             0);
        v_j := v_j + 1;
    end loop;
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------------
----ª•¡™Õ¯÷ß∏∂LCC∂‘’À±Ì ∑¢ €Ω∂Ó º¥ ∑¢ €—∫Ω
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           '1',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(charge_num,0)),
           sum(nvl(charge_fee,0))
      from acc_st.st_np_sts_lcc
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
----ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           '2',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0))
      from acc_st.st_np_sts_acc
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
-----ª•¡™Õ¯÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           '3',
           null,
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0)),
           sum(nvl(diff_deal_num,0)),
           sum(nvl(diff_deal_fee,0))
      from acc_st.st_np_sts_lcc_acc
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select '◊‹º∆',
           data_type,
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0))
      from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      where data_type in ('1','2') --÷ª¿€º∆÷ß∏∂∆ΩÃ®°¢ACC
      group by data_type;

  -- ◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select '◊‹º∆',
           '3',
           null,
           nvl(a.sale_num,0) - nvl(b.sale_num,0),
           nvl(a.deposit_fee,0) - nvl(b.deposit_fee,0),
           nvl(a.deal_num,0) - nvl(b.deal_num,0),
           nvl(a.deal_fee,0) - nvl(b.deal_fee,0)
     from
       (select sale_num, deposit_fee , deal_num, deal_fee
        from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='1' ) a,
        (select sale_num, deposit_fee , deal_num, deal_fee
        from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='2' ) b;


---------------------------------------------------------------------------------
--∏¸–¬data_type_name
  update acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
     set data_type_name= (case when data_type='1'then '÷ß∏∂∆ΩÃ®'
                            when data_type='2'then 'ACC'
                            when data_type='3'then '≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)'
                          end);
---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_day balance_day,
           day,
           data_type,
           data_type_name,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee
      from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      group by day,data_type,data_type_name
      order by day,data_type,data_type_name;
end;
/
grant execute on ACC_ST.UP_OP_NP_STA_ACC_LCC_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_STA_ACC_LCC_MON
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_NP_STA_ACC_LCC_MON (
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_STA_ACC_LCC_MON
  --π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂±®±Ì--ACC”Îª•¡™Õ¯÷ß∏∂∂‘’À‘¬±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ zy
  --¥¥Ω®»’∆⁄£∫20161128
  --±®±Ì±‡∫≈£∫rpt_11_004
  --¡Ÿ ±±Ì£∫T#OP_NP_STA_ACC_LCC_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_balance_begin_mon char(6);
  v_balance_cur_mon char(6);
  v_i      integer;
  v_j      integer;
BEGIN
  v_balance_cur_mon := substr(in_balance_day,1,6);
  v_balance_begin_mon := substr(in_balance_day,1,4) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,5,2) loop
    v_j := 1;
    while v_j <= 3 loop
        insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        values
        (lpad(v_i,2,0),
             to_char(v_j),
             null,
             0,
             0,
             0,
             0);
        v_j := v_j + 1;
    end loop;
    v_i := v_i + 1;
  end loop;
---------------------------------------------------------------------------------
----ª•¡™Õ¯÷ß∏∂LCC∂‘’À±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select lpad(substr(balance_water_no,5,2),2,0),
           '1',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(charge_num,0)),
           sum(nvl(charge_fee,0))
      from acc_st.st_np_sts_lcc
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no,5,2);
---------------------------------------------------------------------------------
----ª•¡™Õ¯÷ß∏∂ACC∂‘’À±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select lpad(substr(balance_water_no,5,2),2,0),
           '2',
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0))
      from acc_st.st_np_sts_acc
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no,5,2);
---------------------------------------------------------------------------------
-----ª•¡™Õ¯÷ß∏∂LCC_ACC∂‘’ÀΩ·π˚±Ì
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select lpad(substr(balance_water_no,5,2),2,0),
           '3',
           null,
           sum(nvl(diff_sale_num,0)),
           sum(nvl(diff_sale_fee,0)),
           sum(nvl(diff_deal_num,0)),
           sum(nvl(diff_deal_fee,0))
      from acc_st.st_np_sts_lcc_acc
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no,5,2);
---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select '◊‹º∆',
           data_type,
           null,
           sum(nvl(sale_num,0)),
           sum(nvl(deposit_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0))
      from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      where data_type in ('1','2') -- ÷ª¿€º∆÷ß∏∂∆ΩÃ®°¢ACC
      group by data_type;

  -- ◊‹º∆≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC) = ◊‹º∆÷ß∏∂∆ΩÃ® - ◊‹º∆ACC
  insert into acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT (
     day,
     data_type,
     data_type_name,
     sale_num,
     deposit_fee,
     deal_num,
     deal_fee)
    select '◊‹º∆',
           '3',
           null,
           nvl(a.sale_num,0) - nvl(b.sale_num,0),
           nvl(a.deposit_fee,0) - nvl(b.deposit_fee,0),
           nvl(a.deal_num,0) - nvl(b.deal_num,0),
           nvl(a.deal_fee,0) - nvl(b.deal_fee,0)
     from
       (select sale_num, deposit_fee , deal_num, deal_fee
        from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='1' ) a,
        (select sale_num, deposit_fee , deal_num, deal_fee
        from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
        where day = '◊‹º∆' and  data_type ='2' ) b;
---------------------------------------------------------------------------------
--∏¸–¬data_type_name
  update acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
     set data_type_name= (case when data_type='1'then '÷ß∏∂∆ΩÃ®'
                            when data_type='2'then 'ACC'
                            when data_type='3'then '≤Ó“Ï ˝£®÷ß∏∂∆ΩÃ®-ACC)'
                          end);
---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_mon balance_day,
           day,
           data_type,
           data_type_name,
           sum(sale_num) as sale_num,
           sum(deposit_fee) as deposit_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee
      from acc_st.T#OP_NP_STA_ACC_LCC_DAY_RESULT
      group by day,data_type,data_type_name
      order by day,data_type,data_type_name;
end;
/
grant execute on ACC_ST.UP_OP_NP_STA_ACC_LCC_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_STA_DEAL_DAY
prompt ========================================
prompt
create or replace procedure acc_st.UP_OP_NP_STA_DEAL_DAY(                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_STA_DEAL_DAY
  --π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂±®±Ì--ª•¡™Õ¯Ωª“◊ª„◊‹»’±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ldz
  --¥¥Ω®»’∆⁄£∫20161125
  --±®±Ì±‡∫≈£∫rpt_11_001
  --¡Ÿ ±±Ì£∫T#OP_NP_STA_DEAL_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_balance_begin_day char(8);
  v_balance_cur_day char(8);
  v_i      integer;
BEGIN
  v_balance_cur_day := substr(in_balance_day,1,8);
  v_balance_begin_day := substr(in_balance_day,1,6) || '01';
-----------------------------------------------------------------------------------
  v_i := 1;
while v_i <= substr(in_balance_day,7,2) loop
    insert into T#OP_NP_STA_DEAL_DAY_RESULT
    values
      (lpad(v_i,2,0),
           0,
           0,
           0,
           0,
           0,
           0);
    v_i := v_i + 1;
  end loop;
  ----ª•¡™Õ¯Ωª“◊∑¢ €Õ≥º∆±Ì
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT(
       day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           0,
           0,
           0,
           0
           from acc_st.st_np_sts_sale
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
  ----ª•¡™Õ¯Ωª“◊≥‰÷µÕ≥º∆±Ì
   insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 7, 2),2,0),
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0
      from acc_st.st_np_sts_deal
     where substr(balance_water_no,1,8) >= v_balance_begin_day and substr(balance_water_no,1,8) <= v_balance_cur_day
     group by substr(balance_water_no, 7, 2);
     ---------------------------------------------------------------------------------
--Œ≤¡–∫œº∆
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select day,
           0,
           0,
           0,
           0,
           sum(nvl(sale_num,0) + nvl(deal_num,0)) total_num,
           sum(nvl(sale_fee,0) + nvl(deal_fee,0)) total_fee
      from acc_st.T#OP_NP_STA_DEAL_DAY_RESULT
     group by day;
     ---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select '◊‹º∆',
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(total_num,0)),
           sum(nvl(total_fee,0))
      from acc_st.T#OP_NP_STA_DEAL_DAY_RESULT;
------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_day balance_day,
           day,
           sum(sale_num) as sale_num,
           sum(sale_fee) as sale_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(total_num) as total_num,
           sum(total_fee) as total_fee
      from T#OP_NP_STA_DEAL_DAY_RESULT
      group by day
      order by day;
end;
/
grant execute on ACC_ST.UP_OP_NP_STA_DEAL_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_NP_STA_DEAL_MON
prompt ========================================
prompt
create or replace procedure acc_st.UP_OP_NP_STA_DEAL_MON(
                                             in_line_id        varchar,
                                             in_station_id     varchar,
                                             in_card_main_id varchar,
                                             in_card_sub_id  varchar,
                                             in_squad_day      varchar,
                                             in_balance_day    varchar,
                                             out_cur_arg       out sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_NP_STA_DEAL_MON
  --π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂±®±Ì--ª•¡™Õ¯Ωª“◊ª„◊‹‘¬±®
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ldz
  --¥¥Ω®»’∆⁄£∫20161128
  --±®±Ì±‡∫≈£∫rpt_11_002
  --¡Ÿ ±±Ì£∫T#OP_NP_STA_DEAL_DAY_RESULT
  -------------------------------------------------------------------------------
 is
  v_balance_begin_mon char(6);
  v_balance_cur_mon char(6);
  v_i      integer;
BEGIN
  v_balance_cur_mon := substr(in_balance_day,1,6);
  v_balance_begin_mon := substr(in_balance_day,1,4) || '01';
-----------------------------------------------------------------------------------
v_i := 1;
while v_i <= substr(in_balance_day,5,2) loop
    insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT
    values
      (lpad(v_i,2,0),
           0,
           0,
           0,
           0,
           0,
           0);
    v_i := v_i + 1;
  end loop;
  ----ª•¡™Õ¯Ωª“◊∑¢ €Õ≥º∆±Ì
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 5, 2),2,0),
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           0,
           0,
           0,
           0
      from acc_st.st_np_sts_sale
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no, 5, 2);
     ---------------------------------------------------------------------------------
--ª•¡™Õ¯Ωª“◊≥‰÷µÕ≥º∆±Ì
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select lpad(substr(balance_water_no, 5, 2),2,0),
           0,
           0,
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           0,
           0
      from acc_st.st_np_sts_deal
     where substr(balance_water_no,1,6) >= v_balance_begin_mon and substr(balance_water_no,1,6) <= v_balance_cur_mon
     group by substr(balance_water_no, 5, 2);
     ---------------------------------------------------------------------------------
--Œ≤¡–∫œº∆
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select day,
           0,
           0,
           0,
           0,
           sum(nvl(sale_num,0) + nvl(deal_num,0)) total_num,
           sum(nvl(sale_fee,0) + nvl(deal_fee,0)) total_fee
      from acc_st.T#OP_NP_STA_DEAL_DAY_RESULT
     group by day;
     ---------------------------------------------------------------------------------
--ƒ©––◊‹º∆
  insert into acc_st.T#OP_NP_STA_DEAL_DAY_RESULT (
     day,
     sale_num,
     sale_fee,
     deal_num,
     deal_fee,
     total_num,
     total_fee)
    select '◊‹º∆',
           sum(nvl(sale_num,0)),
           sum(nvl(sale_fee,0)),
           sum(nvl(deal_num,0)),
           sum(nvl(deal_fee,0)),
           sum(nvl(total_num,0)),
           sum(nvl(total_fee,0))
      from acc_st.T#OP_NP_STA_DEAL_DAY_RESULT;
      ---------------------------------------------------------------------------------
    ------∑µªÿΩ·π˚ºØ
  open out_cur_arg for
    select v_balance_cur_mon balance_day,
           day,
           sum(sale_num) as sale_num,
           sum(sale_fee) as sale_fee,
           sum(deal_num) as deal_num,
           sum(deal_fee) as deal_fee,
           sum(total_num) as total_num,
           sum(total_fee) as total_fee
      from acc_st.T#OP_NP_STA_DEAL_DAY_RESULT
      group by day
      order by day;
end ;
/
grant execute on ACC_ST.UP_OP_NP_STA_DEAL_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_CARD_FARE_DAY
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_CARD_FARE_DAY (
---------------------------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫  rpt_05_008
--π¶ƒ‹√Ë ˆ£∫∆±ø®«¯∂Œ»’±®
--–ﬁ∏ƒ’ﬂ£∫  Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20130810
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
       v_balanceday char(8);
       v_squadday char(8);
       v_retval int;
       v_type_name varchar2(50);--¥Ûœﬂ¬∑√˚≥∆£®πÏµ¿œﬂ°¢¥≈∏°œﬂ£©
    BEGIN
       v_balanceday:=substr(in_balance_day,1,8);
       v_squadday:=substr(in_squad_day,1,8);
       select distinct description into v_type_name from acc_st.op_cod_line_type where type_id= in_line_id;

--insert into t#op_fare_zone_rpt4 values ('01','00','∆’Õ®≥…»Àµ•≥Ã∆±');
--insert into t#op_fare_zone_rpt4 values ('02','00','≥…»À∆’Õ®¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('02','01','—ß…˙∆’Õ®¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('02','02','¿œ»À√‚∑—¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('02','03','¿œ»À”≈ª›¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('03','00','∆’Õ®≥À¥Œ∆±');
--insert into t#op_fare_zone_rpt4 values ('04','00','∆’Õ®ºÕƒÓ∆±');
--insert into t#op_fare_zone_rpt4 values ('04','01','”≈ª›ºÕƒÓ∆±');
--insert into t#op_fare_zone_rpt4 values ('06','00','≥« –Õ®∆±');
   insert into t#op_fare_zone_rpt4
     select card_main_id,card_sub_id,card_sub_name
       from op_prm_card_sub where record_flag='0' and card_main_id!='06';
   insert into t#op_fare_zone_rpt4 values ('06','00','≥« –Õ®∆±');
   /*
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'1');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'2');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'3');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'4');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'5');
   */
--≤È—Øœ‡πÿ ˝æ›
   insert into  t#op_fare_zone_rpt2
(card_main_code,card_sub_code,fare_zone,person_num)
                select card_main_id,card_sub_code,trim(fare_zone),sum(person_num) from (
                select card_main_id,case when card_main_id='06' then '00' else card_sub_id end card_sub_code,
                fare_zone,person_num
                from st_sts_od_card_zone
                where balance_water_no>=v_balanceday||'00'
                and balance_water_no<=v_balanceday||'99'
                and substr(squad_day,1,8)=v_squadday
                and line_id in(select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
                )
                group by card_main_id,card_sub_code,trim(fare_zone);
--ππ‘ÏΩ·π˚ºØΩ·ππ
   insert into t#op_fare_zone_rpt1
   select a.card_main_code||a.card_sub_code||a.card_sub_desc,b.fare_id,0
   from t#op_fare_zone_rpt4 a,acc_st.OP_PRM_FARE_NAME b;
----œÚΩ·π˚ºØµº»Î ˝æ›
   update t#op_fare_zone_rpt1 a set a.value=(
          select person_num b from t#op_fare_zone_rpt2 b
          where trim(b.FARE_ZONE)=a.rowkey and instr(a.linekey,b.card_main_code||b.card_sub_code)>0
   ) where exists (
     select 1 from t#op_fare_zone_rpt2 b
     where trim(b.FARE_ZONE)=a.rowkey and instr(a.linekey,b.card_main_code||b.card_sub_code)>0
   );
   /*
   insert into t#op_fare_zone_rpt1
   select a.card_main_code||a.card_sub_code,'«¯∂Œ'||a.fare_zone,a.person_num
   from t#op_fare_zone_rpt2 a;

   update t#op_fare_zone_rpt1 a
       set a.linekey=
          (select b.card_main_code||b.card_sub_code||b.card_sub_desc from t#op_fare_zone_rpt4 b
           where a.linekey=b.card_main_code||b.card_sub_code)
   where EXISTS (select 1 from t#op_fare_zone_rpt4 b
           where a.linekey=b.card_main_code||b.card_sub_code);
           */
----∑µªÿΩ·π˚ºØ
 OPEN out_cursor FOR
     select v_type_name type_name, v_squadday||v_balanceday day,a.linekey,b.fare_name rowkey, a.rowkey fare_id, sum(a.value) as value
     from t#op_fare_zone_rpt1 a, acc_st.OP_PRM_FARE_NAME b
     where a.rowkey=b.fare_id(+)
     group by a.linekey ,b.fare_name, a.rowkey
     order by a.linekey , a.rowkey,b.fare_name;
    end;
/
grant execute on ACC_ST.UP_OP_OD_CARD_FARE_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_CARD_FARE_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_CARD_FARE_MON
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_CARD_FARE_MON (
---------------------------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫  rpt_05_009
--π¶ƒ‹√Ë ˆ£∫∆±ø®«¯∂Œ‘¬±®
--–ﬁ∏ƒ’ﬂ£∫  Õıø…º—
--–ﬁ∏ƒ»’∆⁄£∫20130810
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
       v_balanceday char(6);
       v_squadday char(6);
       v_type_name varchar2(50);--¥Ûœﬂ¬∑√˚≥∆£®πÏµ¿œﬂ°¢¥≈∏°œﬂ£©
    BEGIN
       v_balanceday:=substr(in_balance_day,1,6);
       v_squadday:=substr(in_squad_day,1,6);
       select distinct description into v_type_name from acc_st.op_cod_line_type where type_id= in_line_id;

--insert into t#op_fare_zone_rpt4 values ('01','00','∆’Õ®≥…»Àµ•≥Ã∆±');
--insert into t#op_fare_zone_rpt4 values ('02','00','≥…»À∆’Õ®¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('02','01','—ß…˙∆’Õ®¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('02','02','¿œ»À√‚∑—¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('02','03','¿œ»À”≈ª›¥¢÷µ∆±');
--insert into t#op_fare_zone_rpt4 values ('03','00','∆’Õ®≥À¥Œ∆±');
--insert into t#op_fare_zone_rpt4 values ('04','00','∆’Õ®ºÕƒÓ∆±');
--insert into t#op_fare_zone_rpt4 values ('04','01','”≈ª›ºÕƒÓ∆±');
--insert into t#op_fare_zone_rpt4 values ('06','00','≥« –Õ®∆±');
  insert into t#op_fare_zone_rpt4
     select card_main_id,card_sub_id,card_sub_name
       from op_prm_card_sub where record_flag='0' and card_main_id!='06';
   insert into t#op_fare_zone_rpt4 values ('06','00','≥« –Õ®∆±');
   /*
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'1');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'2');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'3');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'4');
   insert into t#op_fare_zone_rpt3 values('«¯∂Œ'||'5');
   */
--≤È—Øœ‡πÿ ˝æ›
   insert into  t#op_fare_zone_rpt2
(card_main_code,card_sub_code,fare_zone,person_num)
          select card_main_id,card_sub_code,fare_zone,sum(person_num) from (
                select card_main_id,case when card_main_id='06' then '00' else card_sub_id end card_sub_code,
                trim(fare_zone) fare_zone,person_num
                from st_sts_od_card_zone
                where balance_water_no>=v_balanceday||'0100'
                and balance_water_no<=v_balanceday||'3199'
                and substr(squad_day,1,6)=v_squadday
                and line_id in(select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
                )
                group by card_main_id,card_sub_code,fare_zone;
--ππ‘ÏΩ·π˚ºØΩ·ππ
   insert into t#op_fare_zone_rpt1
   select a.card_main_code||a.card_sub_code||a.card_sub_desc,b.fare_id,0
   from t#op_fare_zone_rpt4 a,acc_st.OP_PRM_FARE_NAME b;
----œÚΩ·π˚ºØµº»Î ˝æ›
   update t#op_fare_zone_rpt1 a set a.value=(
          select person_num b from t#op_fare_zone_rpt2 b
          where trim(b.FARE_ZONE)=a.rowkey and instr(a.linekey,b.card_main_code||b.card_sub_code)>0
   ) where exists (
     select 1 from t#op_fare_zone_rpt2 b
     where trim(b.FARE_ZONE)=a.rowkey and instr(a.linekey,b.card_main_code||b.card_sub_code)>0
   );

 OPEN out_cursor FOR
     select v_type_name type_name, v_squadday||v_balanceday day,a.linekey,b.fare_name rowkey, a.rowkey fare_id, sum(a.value) as value
     from t#op_fare_zone_rpt1 a, acc_st.OP_PRM_FARE_NAME b
     where a.rowkey=b.fare_id(+)
     group by a.linekey ,b.fare_name, a.rowkey
     order by a.linekey , a.rowkey,b.fare_name;
    end;
/
grant execute on ACC_ST.UP_OP_OD_CARD_FARE_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_CARD_FARE_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_CARD_STA_DAY
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_CARD_STA_DAY
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_CARD_STA_DAY
--∂‘”¶±®±Ìƒ£∞Â£∫rpt_05_004
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--∑÷Œˆ±®±Ì£∫∆±ø®’æµ„OD∑÷Œˆ»’±®
--‘⁄’æµ„OD∑÷Œˆ»’±®ª˘¥°…œº”»Î∆±ø®Ãıº˛
-- ‰≥ˆ≤Œ ˝  :
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130808
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
    v_line_no                char(2);     -- œﬂ¬∑¥˙¬Î
    v_squad_day           varchar(8);     -- ‘À”™»’
    v_balance_day         varchar(8);     -- «ÂÀ„»’
    v_card_main_id           char(2);
    v_card_sub_id            char(2);
    v_card_name          varchar(20);
    v_line_name          varchar(20);     -- œﬂ¬∑√˚≥∆
    v_total_num                  int;     -- –°º∆
    v_line_no_sequence       char(2);     -- –Ú∫≈
    v_type_id          varchar2(2):='01'; --¥Ûœﬂ¬∑ID
BEGIN
  v_squad_day:= substr(in_squad_day,1,8);
  v_balance_day:=substr(in_balance_day,1,8);
  v_card_main_id:=in_card_main_id;
  v_card_sub_id:=in_card_sub_id;
  v_line_no:=in_line_id;
  if v_line_no is not null and v_line_no!=' ' then
    SELECT line_name into v_line_name FROM op_prm_line
 WHERE line_id = v_line_no and record_flag='0';
  end if;
  if v_card_main_id||v_card_sub_id is not null and v_card_main_id!=' ' and v_card_sub_id!=' ' then
   select card_sub_name into v_card_name from op_prm_card_sub
   where card_main_id=v_card_main_id and card_sub_id=v_card_sub_id
   and record_flag='0';
end if;
select type_id into v_type_id from acc_st.op_cod_line_type where line_id=v_line_no;

--≤È—Øœ‡πÿ ˝æ› ≤¢∑≈»Î¡Ÿ ±±Ì
INSERT INTO T#OP_OD_STA_RESULT1
 (begin_line_code, begin_station_code, end_line_code, end_station_code, num )
 SELECT b_line_id, b_station_id, e_line_id, e_station_id, SUM(person_num)
    FROM st_sts_od_card
  WHERE substr(squad_day,1,8) =v_squad_day
    AND balance_water_no>=v_balance_day||'00'
    and balance_water_no<=v_balance_day||'99'
    and e_line_id=v_line_no
    and card_main_id=v_card_main_id
    and card_sub_id=v_card_sub_id
    and b_station_id!='00' and e_station_id!='00'
    GROUP BY b_line_id, b_station_id, e_line_id,e_station_id;
----- ◊È∫œ’æµ„øÕ¡˜±ÌΩ·ππ(∆ º’æµ„Œ™À˘”–’æµ„£¨÷’÷π’æµ„Œ™ Ù”⁄∏√Ãıœﬂ¬∑µƒ’æµ„)
    INSERT INTO T#OP_OD_STA_RESULT(begin_line_code,begin_line_name, begin_station_code, begin_station_name,end_line_code,end_line_name, end_station_code,end_station_name,num)
     SELECT A.line_id,'--', A.station_id,'--', B.line_id,'--', B.station_id,'--',0
     FROM op_prm_station A,op_prm_station B
            WHERE A.record_flag = '0'
            AND B.record_flag = '0'
            AND B.belong_line_id = v_line_no
            and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id = v_type_id);
----- ˝æ›µº»ÎµΩΩ·π˚ºØ
INSERT INTO T#OP_OD_STA_RESULT
 (begin_line_code, begin_station_code, end_line_code, end_station_code, num )
 SELECT begin_line_code, begin_station_code, end_line_code, end_station_code, SUM(num)
    FROM T#OP_OD_STA_RESULT1
    GROUP BY begin_line_code, begin_station_code, end_line_code,end_station_code;
    -- ∏¸–¬∆ º’æµ„÷–Œƒ√˚≥∆
    UPdate T#OP_OD_STA_RESULT A
    SET (begin_station_name,begin_line_name) =(
    select '(' || B.sequence || ')' || B.chinese_name,c.sequence||c.LINE_NAME
    FROM op_prm_station B,op_prm_line C
    WHERE A.begin_line_code = B.line_id AND A.begin_station_code = B.station_id and   B.record_flag= '0'
        AND   A.begin_line_code = C.line_id  and c.record_flag= '0'
        AND   B.belong_line_id = C.line_id);
    -- ∏¸–¬÷’÷π’æµ„÷–Œƒ√˚≥∆
   UPdate T#OP_OD_STA_RESULT A
   SET (end_station_name,end_line_name)=(
   select '(' || B.sequence || ')' || B.chinese_name,c.sequence||C.LINE_NAME
   FROM op_prm_station B,op_prm_line C
        WHERE A.end_line_code = B.line_id AND A.end_station_code = B.station_id and   B.record_flag= '0'
        AND A.END_LINE_CODE=C.LINE_ID AND B.belong_line_id = C.line_id and c.record_flag= '0');
    -- ∑µªÿΩ·π˚
    open out_cursor for
    SELECT v_squad_day||v_balance_day day,v_line_name linename,v_card_name cardname,begin_station_name, end_station_name, SUM(num),begin_line_name,end_line_name
        FROM T#OP_OD_STA_RESULT
        GROUP BY begin_station_name, end_station_name,begin_line_name, end_line_name
        ORDER BY begin_station_name, end_station_name;
END;
/
grant execute on ACC_ST.UP_OP_OD_CARD_STA_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_CARD_STA_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_CARD_STA_MON
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_CARD_STA_MON
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_CARD_STA_DAY
--∂‘”¶±®±Ìƒ£∞Â£∫rpt_05_004
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--∑÷Œˆ±®±Ì£∫∆±ø®’æµ„OD∑÷Œˆ‘¬±®
--‘⁄’æµ„OD∑÷Œˆ»’±®ª˘¥°…œº”»Î∆±ø®Ãıº˛
-- ‰≥ˆ≤Œ ˝  :
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130808
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
    v_line_no                char(2);     -- œﬂ¬∑¥˙¬Î
    v_squad_day           varchar(6);     -- ‘À”™»’
    v_balance_day         varchar(6);     -- «ÂÀ„»’
    v_card_main_id           char(2);
    v_card_sub_id            char(2);
    v_card_name          varchar(20);
    v_line_name          varchar(20);     -- œﬂ¬∑√˚≥∆
    v_type_id          varchar2(2):='01'; --¥Ûœﬂ¬∑ID
BEGIN
  v_squad_day:= substr(in_squad_day,1,6);
  v_balance_day:=substr(in_balance_day,1,6);
  v_card_main_id:=in_card_main_id;
  v_card_sub_id:=in_card_sub_id;
  v_line_no:=in_line_id;
    if v_line_no is not null and v_line_no!=' ' then
    SELECT line_name into v_line_name FROM op_prm_line
 WHERE line_id = v_line_no and record_flag='0';
  end if;
  if v_card_main_id||v_card_sub_id is not null and v_card_main_id!=' ' and v_card_sub_id!=' ' then
   select card_sub_name into v_card_name from op_prm_card_sub
   where card_main_id=v_card_main_id and card_sub_id=v_card_sub_id
   and record_flag='0';
end if;
 select type_id into v_type_id from acc_st.op_cod_line_type where line_id=v_line_no;
 
--≤È—Øœ‡πÿ ˝æ› ≤¢∑≈»Î¡Ÿ ±±Ì
 INSERT INTO T#OP_OD_STA_RESULT1(begin_line_code, begin_station_code, end_line_code, end_station_code, num )
    SELECT b_line_id, b_station_id, e_line_id, e_station_id, SUM(person_num)
    FROM st_sts_od_card
    WHERE substr(squad_day,1,6) =v_squad_day
    AND balance_water_no>=v_balance_day||'0100'
    and balance_water_no<=v_balance_day||'3199'
    and e_line_id=v_line_no
    and card_main_id=v_card_main_id
    and card_sub_id=v_card_sub_id
    and e_station_id!='00' and b_Station_id!='00'
    GROUP BY b_line_id, b_station_id, e_line_id,e_station_id;
----- ◊È∫œ’æµ„øÕ¡˜±ÌΩ·ππ(∆ º’æµ„Œ™À˘”–’æµ„£¨÷’÷π’æµ„Œ™ Ù”⁄∏√Ãıœﬂ¬∑µƒ’æµ„)
    INSERT INTO T#OP_OD_STA_RESULT(begin_line_code,begin_line_name, begin_station_code, begin_station_name,end_line_code,end_line_name, end_station_code,end_station_name,num)
     SELECT A.line_id,'--', A.station_id,'--', B.line_id,'--', B.station_id,'--',0
     FROM op_prm_station A,op_prm_station B
            WHERE A.record_flag = '0'
            AND B.record_flag = '0'
            AND B.belong_line_id = v_line_no
            and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id = v_type_id);
----- ˝æ›µº»ÎµΩΩ·π˚ºØ
INSERT INTO T#OP_OD_STA_RESULT
 (begin_line_code, begin_station_code, end_line_code, end_station_code, num )
 SELECT begin_line_code, begin_station_code, end_line_code, end_station_code, SUM(num)
    FROM T#OP_OD_STA_RESULT1
    GROUP BY begin_line_code, begin_station_code, end_line_code,end_station_code;
    -- ∏¸–¬∆ º’æµ„÷–Œƒ√˚≥∆
    UPdate T#OP_OD_STA_RESULT A
    SET (begin_station_name,begin_line_name) =(
    select '(' || B.sequence || ')' || B.chinese_name  ,c.SEQUENCE||c.LINE_NAME
    FROM op_prm_station B,op_prm_line C
        WHERE A.begin_line_code = B.line_id
        AND   A.begin_line_code = C.line_id
        AND   A.begin_station_code = B.station_id
        AND   B.belong_line_id = C.line_id
         and   B.record_flag= '0' and c.record_flag= '0');
    -- ∏¸–¬÷’÷π’æµ„÷–Œƒ√˚≥∆
   UPdate T#OP_OD_STA_RESULT A
   SET (end_station_name,end_line_name)=(
   select'(' || B.sequence || ')' || B.chinese_name,c.SEQUENCE||C.LINE_NAME
   FROM op_prm_station B,op_prm_line C
        WHERE A.end_line_code = B.line_id
        AND A.END_LINE_CODE=C.LINE_ID
        AND A.end_station_code = B.station_id
        AND B.belong_line_id = C.line_id
         and   B.record_flag= '0' and c.record_flag= '0');
    -- ∑µªÿΩ·π˚
    open out_cursor for
    SELECT v_squad_day||v_balance_day day,v_line_name linename,v_card_name cardname,begin_station_name, end_station_name, SUM(num),begin_line_name,end_line_name
        FROM T#OP_OD_STA_RESULT
        GROUP BY begin_station_name, end_station_name,begin_line_name, end_line_name
        ORDER BY begin_station_name, end_station_name;
END;
/
grant execute on ACC_ST.UP_OP_OD_CARD_STA_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_CARD_STA_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_COUNT_LINE
prompt ======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_COUNT_LINE
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_PFL_LINE_DAY
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--Ω·À„±®±Ì£∫øÕ¡˜¿‡±®±Ì
--±®±Ì√˚◊÷£∫∂˛∫≈µÍøÕ¡˜±®±Ì
-- ‰≥ˆ≤Œ ˝  :
--◊¢ Õ:
--–ﬁ∏ƒ’ﬂ£∫  WANGKEJIA
--–ﬁ∏ƒ»’∆⁄£∫20140428
--∂‘”¶ƒ£∞Â£∫rpt_01_015
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫wangkejia
--–ﬁ∏ƒ»’∆⁄£∫20140912
--–ﬁ∏ƒƒ⁄»›£∫∞¥«ÂÀ„»’‘À”™»’Õ≥º∆ ˝æ›
--∞Ê±æ∫≈£∫v1.2
-------------------------------------------------------------------------------
--–ﬁ∏ƒ≥µ’æ≥¨≥ˆ19∏ˆ’æ ±µƒ±®±ÌÕ≥º∆   by lindaquan 20160408

--–ﬁ∏ƒ’ﬂ£∫  mqf
--–ﬁ∏ƒ»’∆⁄£∫20160614
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”≤È—ØÃıº˛ v_line_id
-------------------------------------------------------------------------------
(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
V_balanceday varchar(8);
V_squadday varchar(8);
v_line_id char(2);
v_max_num int;

BEGIN
 v_balanceday:=substr(in_balance_day,1,8);
 v_squadday:=substr(in_squad_day,1,8);
 v_line_id:=in_line_id;
--------------------------------------------------------------------------------
--------≤È—Ø ˝æ›(Ω¯≥ˆ’æøÕ¡˜)
insert into t#op_pfl_line_day_rpt3 a(line_id,line_name,station_id,station_name,entry_num,export_num,total_num)
  select b.line_id,'',b.station_id,'',sum(entry_num),sum(export_num),sum(entry_num+export_num)
  from st_sts_flw_station b
    where b.line_id=v_line_id
        and substr(b.balance_water_no,1,8)=v_balanceday
    and b.squad_day=v_squadday
  and b.line_id=v_line_id --20160614 add by mqf
    group by b.line_id,b.station_id;
insert into t#op_pfl_line_day_rpt3 a(line_id,line_name,station_id,station_name,entry_num,export_num,total_num)
  select b.line_id,'',b.station_id,'',0,0,0
  from op_prm_station b
  where b.record_flag='0'
     and b.line_id=v_line_id --20160614 add by mqf
     and b.station_id not in (select station_id from t#op_pfl_line_day_rpt3);
 ---------------------------------------------------------------------------------
 --∂œ√ÊøÕ¡˜µº»Î¡Ÿ ±±Ì£®∞¥’æµ„ ±∂ŒÕ≥º∆£©
 --…œ––
insert into t#op_pfl_line_day_rpt5 a
   select b.line_id,'',b.b_station_id,'',sum(b.num),b.time_section,''
   from st_sts_realflow_section b
   where  b.squad_day=V_squadday
     and substr(b.balance_water_no,1,8)=V_balanceday
     and b.change_line_out_dir='0'
   and b.line_id=v_line_id --20160614 add by mqf
group by b.line_id,b.b_station_id,b.time_section ;
--œ¬––
insert into t#op_pfl_line_day_rpt6 a
   select b.line_id,'',b.b_station_id,'',sum(b.num),b.time_section,''
   from st_sts_realflow_section b
   where  b.squad_day=V_squadday
     and substr(b.balance_water_no,1,8)=V_balanceday
     and b.change_line_out_dir='1'
   and b.line_id=v_line_id --20160614 add by mqf
group by b.line_id,b.b_station_id,b.time_section;
----∞¥’æµ„ ÷∏ˆ≤Â»Î∂œ√Ê◊Ó¥ÛøÕ¡˜µƒ ˝æ›
declare cursor csr is select station_id from acc_st.op_prm_station where record_flag='0' and line_id=v_line_id order by station_id desc;
begin
   for c_row in csr loop
        insert into t#op_pfl_line_day_rpt7 a
         select distinct b.line_id,'',b.station_id,'',b.max_num0,min(b.max_hour),''
         from t#op_pfl_line_day_rpt5 b
          where b.max_num0 = (
          select distinct max(max_num0) from t#op_pfl_line_day_rpt5 b where b.station_id=lpad(c_row.station_id,2,0))
          and b.station_id=lpad(c_row.station_id,2,0)
          group by b.line_id,b.station_id,b.max_num0;
         -- and b.max_hour=(select min(max_hour) from t#op_pfl_line_day_rpt5 c where b.line_id=c.line_id and b.station_id=b.station_id);
        insert into t#op_pfl_line_day_rpt8 a
           select distinct b.line_id,'',b.station_id,'',b.max_num1,min(b.max_hour),''
           from t#op_pfl_line_day_rpt6 b
            where b.max_num1 = (
            select distinct max(max_num1) from t#op_pfl_line_day_rpt6 b where b.station_id=lpad(c_row.station_id,2,0))
            and b.station_id=lpad(c_row.station_id,2,0)
            group by b.line_id,b.station_id,b.max_num1;
         --  and b.max_hour=(select min(c.max_hour) from t#op_pfl_line_day_rpt6 c where b.line_id=c.line_id and b.station_id=b.station_id);
    end loop;
end;

    -------------Ω´¡Ÿ ±±Ìstation_id≤π»´
insert into t#op_pfl_line_day_rpt7 a
  select b.line_id,'',b.station_id,'',0,'','' from op_prm_station b
  where b.record_flag='0'
     and b.line_id=v_line_id --20160614 add by mqf
     and b.station_id not in (select distinct station_id from t#op_pfl_line_day_rpt5);

insert into t#op_pfl_line_day_rpt8 a
  select b.line_id,'',b.station_id,'',0,'','' from op_prm_station b
  where b.record_flag='0'
     and b.line_id=v_line_id --20160614 add by mqf
     and b.station_id not in (select distinct station_id from t#op_pfl_line_day_rpt6);
      ---------------------------------------------------------------
 ----ππΩ®∂œ√ÊøÕ¡˜¡Ÿ ±±Ì
insert into t#op_pfl_line_day_rpt4 a
  select b.line_id,b.line_name,b.station_id,b.station_name,b.max_num0,c.max_num1,nvl(b.max_hour,'  ')||nvl(c.max_hour,'  '),''
  from t#op_pfl_line_day_rpt7 b left join t#op_pfl_line_day_rpt8 c
  on b.line_id=c.line_id and b.station_id=c.station_id;

---Ω≤¡Ω∏ˆ¡Ÿ ±±Ì ˝æ›µº»ÎµΩΩ·π˚ºØ
insert into t#op_pfl_line_day_rpt1
(line_id,line_name,station_id,station_name,
entry_num,export_num,total_num,max_num0,max_num1,max_hour,max_hour1,remarks)
  select
   b.line_id,b.line_name,b.station_id,b.station_name,
   b.entry_num,b.export_num,b.total_num,
   c.max_num0,c.max_num1,substr(c.max_hour,1,2),substr(c.max_hour,3,2),c.remarks
  from t#op_pfl_line_day_rpt3  b FULL OUTER JOIN t#op_pfl_line_day_rpt4 c
  on b.line_id=c.line_id and b.station_id=c.station_id;


--ƒ©––◊‹º∆
insert into t#op_pfl_line_day_rpt1
  select line_id,line_name,'99','99∫œº∆',
         sum(entry_num) entry_num,sum(export_num) export_num,sum(total_num) total_num,
         sum(max_num0) max_num0,sum(max_num1) max_num1,'/',remarks,'/'
      from t#op_pfl_line_day_rpt1
      group by line_id,line_name,remarks;
  ----∏¸–¬œﬂ¬∑√˚
        update t#op_pfl_line_day_rpt1 a
        set line_name=(
        select '('||b.line_id||')'||b.line_name from op_prm_line b
        where a.line_id=b.line_id and b.record_flag='0');

        update t#op_pfl_line_day_rpt1 a
        set station_name=(
        select b.station_id||b.chinese_name from op_prm_station b
        where a.line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0')
        where EXISTS ( select 1 from op_prm_station b
        where a.line_id=b.line_id and a.station_id=b.station_id and b.record_flag='0');
--∑µªÿΩ·π˚ºØ
          open out_cursor for
          select v_squadday||v_balanceday day,line_name,station_name,
          sum(entry_num) entry_num,sum(export_num) export_num,sum(total_num) total_num,
          sum(max_num0) max_num0,sum(max_num1) max_num1,max_hour,max_hour1,remarks
      from t#op_pfl_line_day_rpt1
      group by line_name,station_name,max_hour,max_hour1,remarks
      order by line_name,station_name asc;
      /*select * from t#op_pfl_line_day_rpt8 order by station_id;*/
    end;
/
grant execute on ACC_ST.UP_OP_OD_COUNT_LINE to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_COUNT_LINE to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_COUNT_LINE_TOTAL
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_COUNT_LINE_TOTAL
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_PFL_LINE_DAY
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--Ω·À„±®±Ì£∫øÕ¡˜¿‡±®±Ì
--–¬‘ˆ±®±Ì:œﬂ¬∑øÕ¡˜Õ≥º∆»’±®(‘≠∂˛∫≈œﬂøÕ¡˜±Ì)
--±®±Ì√˚◊÷£∫œﬂ¬∑ OD ∑÷Œˆ»’±®
-- ‰≥ˆ≤Œ ˝  :
--◊¢ Õ:
--–ﬁ∏ƒ’ﬂ£∫  WANGKEJIA
--–ﬁ∏ƒ»’∆⁄£∫20140429
--∂‘”¶ƒ£∞Â£∫rpt_01_015

--–ﬁ∏ƒ’ﬂ£∫  mqf
--–ﬁ∏ƒ»’∆⁄£∫20160614
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº”≤È—ØÃıº˛ v_line_id
-------------------------------------------------------------------------------
--∏¸∏ƒ’ﬂ:zhouy
--∏¸∏ƒ ±º‰£∫20171229
--∏¸∏ƒƒ⁄»›£∫–ﬁ∏ƒ‘À”™»’Œ™ƒÍ≥ı ±ªÒ»°…œ“ªƒÍÀ˘”– ˝æ›µƒ»° ˝¬ﬂº≠
--∏¸∏ƒ’ﬂ:mqf
--∏¸∏ƒ ±º‰£∫20171229
--∏¸∏ƒƒ⁄»›£∫∏∂∑—«¯µƒ∆±ø®¿‡–Õ≥˝¡À0203£¨‘Ÿ‘ˆº”OCT¿œ»À∆±0603°¢∆’Õ®‘±π§∆±05
-------------------------------------------------------------------------------
(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
V_balanceday varchar(8);
V_squadday varchar(8);
v_line_id char(2);
v_average_mon int;
v_average_year int;
v_table_name varchar(30);
v_sql varchar(500);
v_where varchar(200);
v_year_begin varchar(100);
v_year_end varchar(100);
v_mon_begin varchar(100);
v_mon_end varchar(100);
v_count int;
v_year_begin_balance varchar(100);
v_year_end_balance varchar(100);
BEGIN
 v_balanceday:=substr(in_balance_day,1,8);
 v_squadday:=substr(in_squad_day,1,8);
 v_line_id:=in_line_id;
  v_table_name:='';
  v_count:=0;
  v_where:=' where ';
  v_year_begin:=to_char(add_months(to_date(v_squadday,'yyyy-mm-dd hh24:mi:ss'),-12),'yyyy')||'0101';
  v_year_end:=to_char(add_months(to_date(v_squadday,'yyyy-mm-dd hh24:mi:ss'),-12),'yyyy')||'1231';
  v_mon_begin:=to_char(add_months(to_date(substr(v_squadday,1,6),'yyyymm'),-1),'yyyymm')||'01';
  v_mon_end:=to_char(add_months(to_date(substr(v_squadday,1,6),'yyyymm'),-1),'yyyymm')||'31';

  v_year_begin_balance:=to_char(add_months(to_date(v_balanceday,'yyyymmdd'),-12),'yyyymmdd');
  v_year_end_balance:=v_balanceday;
-----------------------------------------------------------------------------

----»Áπ˚ «ƒÍ≥ı£¨‘Úµº»Î…œ“ªƒÍµƒÀ˘”– ˝æ›
if substr(v_squadday,5,4)='0101' then
    begin

--------≤È—Ø ˝æ›(÷–º‰±Ì ˝æ›)
insert into T#OP_station_inout_rpt
(line_id,station_id,squad_day,card_main_code,card_sub_code,entry_num,export_num,section_no)
   select b.line_id,station_id,b.squad_day,b.card_main_id,b.card_sub_id,b.entry_num,b.export_num,b.time_section_id
   from st_sts_flw_station b
   --where substr(b.balance_water_no,1,8)>=v_balanceday
   --20171229 modify by zhouy
   where substr(b.balance_water_no,1,8)>=v_year_begin_balance and substr(b.balance_water_no,1,8)<v_year_end_balance
   and b.line_id=v_line_id --20160614 add by mqf
   --and ((b.squad_day>=v_year_begin and b.squad_day<=v_year_end) or(b.squad_day=v_squadday));
   and ((b.squad_day>=v_year_begin and b.squad_day<=v_year_end));--20171229 modify by zhouy

---------------¥”À˜“˝±Ì»°∑÷±Ì ˝æ›£®¥”∑÷±Ì»° ˝æ›£©

select count(*) into v_count from st_idx_rpt_history a
  where a.origin_table_name='acc_st.st_sts_flw_station'
       and nvl(a.min_squad_day,0)>=v_year_begin and nvl(a.max_squad_day,v_year_end)<=v_year_end;
----À˜“˝±Ì”–µ±«∞÷–º‰±Ìµƒ∑÷±Ì£¨æÕ¥”∑÷±Ì»° ˝æ›
if v_count>0 then

declare
      cursor v_cursor is
  select a.table_name from st_idx_rpt_history a
       where a.origin_table_name='acc_st.st_sts_flw_station'
       and nvl(a.min_squad_day,0)>=v_year_begin and nvl(a.max_squad_day,v_year_end)<=v_year_end;

 begin
   open v_cursor;
   fetch v_cursor into v_table_name;
     v_sql:='insert into T#OP_station_inout_rpt
           (line_id,station_id,squad_day,card_main_code,card_sub_code,entry_num,export_num,section_no)
           select b.line_id,b.station_id,b.squad_day,b.card_main_id,b.card_sub_id,b.entry_num,b.export_num,b.time_section_id
           from ';

    v_sql:=v_sql||v_table_name||' b';

    v_sql:=v_sql||v_where||' (b.squad_day>='||v_year_begin||' and b.squad_day<='||v_year_end||')';

    --v_sql:=v_sql||' and substr(b.balance_Water_no)>=v_year_begin_balance and substr(b.balance_Water_no)<=v_year_end_balance ';
  ----20160614 modify by mqf
  --v_sql:=v_sql||' and substr(b.balance_Water_no,1,8)>=' || v_year_begin_balance || ' and substr(b.balance_Water_no,1,8)<=' || v_year_end_balance;
  v_sql:=v_sql||' and substr(b.balance_Water_no,1,8)>=' || v_year_begin_balance || ' and substr(b.balance_Water_no,1,8)<' || v_year_end_balance;--20171229 modify by zhouy
  --20160614 add by mqf
  v_sql:=v_sql||' and b.line_id='''||v_line_id || '''';
    Execute Immediate v_sql;
   close v_cursor;
 end;

end if;
     ----…œƒÍÃÏ ˝
  select decode(count(distinct squad_day),0,365,count(distinct squad_day))
      into v_average_year from T#OP_station_inout_rpt b
      where b.squad_day>=v_year_begin and b.squad_day<=v_year_end;
        ----…œ‘¬ÃÏ ˝
 select decode(count(distinct squad_day),0,30,count(distinct squad_day)) into v_average_mon from T#OP_station_inout_rpt a
   where  a.squad_day>=v_mon_begin and a.squad_day<=v_mon_end;

end;
--------------------------------------------------------------------------------
-----------------------------------------------------------------------------
----»Áπ˚ «‘¬≥ı£¨‘Úµº»Î…œ“ª‘¬µƒÀ˘”– ˝æ›
elsif substr(v_squadday,7,2)='01' then
    begin

--------≤È—Ø ˝æ›
insert into T#OP_station_inout_rpt
(line_id,station_id,squad_day,card_main_code,card_sub_code,entry_num,export_num,section_no)
   select b.line_id,station_id,b.squad_day,b.card_main_id,b.card_sub_id,b.entry_num,b.export_num,b.time_section_id
   from st_sts_flw_station b
    where ((b.squad_day>=v_mon_begin and b.squad_day<=v_mon_end))
    and b.line_id=v_line_id --20160614 add by mqf
      and (substr(b.balance_water_no,1,8)>=to_char(add_months(to_date(v_balanceday,'yyyymmdd'),-1),'yyyymmdd')
            and (substr(b.balance_water_no,1,8)<v_balanceday));
    ----…œ‘¬ÃÏ ˝
 select decode(count(distinct squad_day),0,30,count(distinct squad_day)) into v_average_mon from T#OP_station_inout_rpt a
   where  a.squad_day>=v_mon_begin and a.squad_day<=v_mon_end;
end;
-----------------------------------------------------------------------------
----»Áπ˚ «÷‹“ª£¨‘Úµº»Î…œ“ª÷‹µƒÀ˘”– ˝æ›
elsif to_char(to_date(substr(v_squadday,1,8),'yyyy-mm-dd hh24:mi:ss') - 1,'d')='1' then
    begin
--------≤È—Ø ˝æ›
insert into T#OP_station_inout_rpt
(line_id,station_id,squad_day,card_main_code,card_sub_code,entry_num,export_num,section_no)
   select b.line_id,station_id,b.squad_day,b.card_main_id,b.card_sub_id,b.entry_num,b.export_num,b.time_section_id
   from st_sts_flw_station b
    where ((b.squad_day<=v_squadday-1 and b.squad_day>=v_squadday-7))
    and b.line_id=v_line_id --20160614 add by mqf
      and ((substr(b.balance_water_no,1,8)<=v_balanceday-1 and substr(b.balance_water_no,1,8)>=v_balanceday-7));
end;
end if;
--------------------------------------------------------------------------------

 -----------------------------------------------------------------------------------------------
if to_char(to_date(substr(v_squadday,1,8),'yyyy-mm-dd hh24:mi:ss') - 1,'d')='1' then
    begin
    ----÷‹
    --01øÕ‘À◊‹¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_week,remarks)
  select '01øÕ‘À◊‹¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day<=v_squadday-1
        and b.squad_day>=v_squadday-7;
    ---∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_week,remarks)
  select '02∏∂∑—øÕ‘À¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day<=v_squadday-1
        and b.squad_day>=v_squadday-7
    --and b.card_main_code||b.card_sub_code !='0203';
    and b.card_main_code||b.card_sub_code not in ('0203','0603') and b.card_main_code !='05';
     ---∑«∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_week,remarks)
  select '03∑«∏∂∑—øÕ‘À¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day<=v_squadday-1
        and b.squad_day>=v_squadday-7
    --and b.card_main_code||b.card_sub_code ='0203';
    and (b.card_main_code||b.card_sub_code in ('0203','0603') or b.card_main_code ='05');
    --»’æ˘øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_week,remarks)
  select '04»’æ˘øÕ‘À¡ø',0,nvl(sum(b.entry_num),0)/7,''
  from T#OP_station_inout_rpt b
    where b.squad_day<=v_squadday-1
        and b.squad_day>=v_squadday-7;
    end;
end if;

if substr(v_squadday,7,2)='01' then
    begin
    ----‘¬
    --01øÕ‘À◊‹¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_mon,remarks)
  select '01øÕ‘À◊‹¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where  b.squad_day>=v_mon_begin and b.squad_day<=v_mon_end;
    ---∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_mon,remarks)
  select '02∏∂∑—øÕ‘À¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where  b.squad_day>=v_mon_begin and b.squad_day<=v_mon_end
    --and b.card_main_code||b.card_sub_code !='0203';
    and b.card_main_code||b.card_sub_code not in ('0203','0603') and b.card_main_code !='05';
     ---∑«∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_mon,remarks)
  select '03∑«∏∂∑—øÕ‘À¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day>=v_mon_begin and b.squad_day<=v_mon_end
    --and b.card_main_code||b.card_sub_code ='0203';
    and (b.card_main_code||b.card_sub_code in ('0203','0603') or b.card_main_code ='05');
    --04»’æ˘øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_mon,remarks)
  select '04»’æ˘øÕ‘À¡ø',0,nvl(sum(b.entry_num),0)/v_average_mon,''
  from T#OP_station_inout_rpt b
    where b.squad_day>=v_mon_begin
        and b.squad_day<=v_mon_end;
    end;
end if;

      ----ƒÍ
    --01øÕ‘À◊‹¡ø
if substr(v_squadday,5,4)='0101' then
    begin

insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_year,remarks)
  select '01øÕ‘À◊‹¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day>=v_year_begin and b.squad_day<=v_year_end;
    ---∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_year,remarks)
  select '02∏∂∑—øÕ‘À¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day>=v_year_begin and b.squad_day<=v_year_end
    --and b.card_main_code||b.card_sub_code !='0203';
    and b.card_main_code||b.card_sub_code not in ('0203','0603') and b.card_main_code !='05';
     ---∑«∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_year,remarks)
  select '03∑«∏∂∑—øÕ‘À¡ø',0,nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day>=v_year_begin and b.squad_day<=v_year_end
    --and b.card_main_code||b.card_sub_code ='0203';
    and (b.card_main_code||b.card_sub_code in ('0203','0603') or b.card_main_code ='05');
        --04»’æ˘øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,cycle_year,remarks)
  select '04»’æ˘øÕ‘À¡ø',0,nvl(sum(b.entry_num),0)/v_average_year,''
  from T#OP_station_inout_rpt b
    where b.squad_day>=v_year_begin and b.squad_day<=v_year_end;
    end;
end if;

-----------------------------------------------------------------------------
----µ±«∞«ÂÀ„»’∆⁄
--------≤È—Ø ˝æ›
insert into T#OP_station_inout_rpt
(line_id,station_id,squad_day,card_main_code,card_sub_code,entry_num,export_num,section_no)
   select b.line_id,station_id,b.squad_day,b.card_main_id,b.card_sub_id,b.entry_num,b.export_num,b.time_section_id
   from st_sts_flw_station b
    where b.squad_day=v_squadday
  and b.line_id=v_line_id --20160614 add by mqf
    and substr(b.balance_water_no,1,8)=v_balanceday;

--------------------------------------------------------------------------------
--»’øÕ‘À¡ø

--øÕ‘À◊‹¡ø

insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,remarks)
  select '01øÕ‘À◊‹¡ø',nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where  b.squad_day=v_squadday;
 --∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,remarks)
  select '02∏∂∑—øÕ‘À¡ø',nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where  b.squad_day=v_squadday
       --and card_main_code||card_sub_code!='0203';
       and b.card_main_code||b.card_sub_code not in ('0203','0603') and b.card_main_code !='05';
  --∑«∏∂∑—«¯øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,remarks)
  select '03∑«∏∂∑—øÕ‘À¡ø',nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where  b.squad_day=v_squadday
    --and b.card_main_code||b.card_sub_code='0203';
    and (b.card_main_code||b.card_sub_code in ('0203','0603') or b.card_main_code ='05');
----»’æ˘øÕ‘À¡ø
insert into t#op_pfl_line_day_rpt2(passenger_index,cycle_day,remarks)
  select '04»’æ˘øÕ‘À¡ø',nvl(sum(b.entry_num),0),''
  from T#OP_station_inout_rpt b
    where b.squad_day=v_squadday;
------∏¸–¬œﬂ¬∑√˚
update t#op_pfl_line_day_rpt2 a set a.line_id=v_line_id;

update t#op_pfl_line_day_rpt2 a set a.line_name=(
      select b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0');

--∑µªÿΩ·π˚ºØ
  open out_cursor for
       select v_squadday||v_balanceday day,a.line_name,
            a.passenger_index,
            sum(a.cycle_day) cycle_day,
            sum(a.cycle_week) cycle_week,
            sum(a.cycle_mon) cycle_mon,
            sum(a.cycle_year) cycle_year,
            a.remarks
      from t#op_pfl_line_day_rpt2 a
      group by line_name,a.passenger_index,a.remarks
      order by line_name asc;

    end;
/
grant execute on ACC_ST.UP_OP_OD_COUNT_LINE_TOTAL to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_COUNT_LINE_TOTAL to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_LINE_DAY
prompt ====================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_LINE_DAY
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_LINE_DAY
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--Ω·À„±®±Ì£∫OD ∑÷Œˆ¿‡±®±Ì
--±®±Ì√˚◊÷£∫œﬂ¬∑ OD ∑÷Œˆ»’±®
--–ﬁ∏ƒ’ﬂ£∫  WANGKEJIA
--–ﬁ∏ƒ»’∆⁄£∫20130807
--∂‘”¶ƒ£∞Â£∫rpt_05_001
-------------------------------------------------------------------------------
--‘ˆº”œﬂ¬∑≤È—ØÃıº˛ by lindaquan 20160317
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫zhouyang
--–ﬁ∏ƒƒ⁄»›£∫Ω´°∞82–Èƒ‚œﬂ°±∆¡±Œ
--–ﬁ∏ƒ»’∆⁄£∫20170220
-------------------------------------------------------------------------------

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
V_balanceday char(8);
V_squadday char(8);
v_type_name varchar2(50);
BEGIN
 v_balanceday:=substr(in_balance_day,1,8);
 v_squadday:=substr(in_squad_day,1,8);

 select distinct description into v_type_name from acc_st.op_cod_line_type where type_id= in_line_id;
--------------------------------------------------------------------------------
--------≤È—Ø ˝æ›
insert into t#op_od_line_result1
select b_line_id linekey,e_line_id rowkey,sum(person_num) value
            from st_sts_od_line
 where balance_water_no>=V_balanceday||'00'
 and balance_water_no<=V_balanceday||'99'
 and squad_day=V_squadday
 and b_line_id in (select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
 and e_line_id in (select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
 group by b_line_id,e_line_id;
--------------------------------------------------------------------------------
----µº»ÎΩ·π˚ºØ
insert into t#op_od_line_rpt1(linekey,rowkey)
select a.line_id,b.line_id from op_prm_line a,op_prm_line b
where a.record_flag='0' and b.record_flag='0'
and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
and b.line_id in (select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
and a.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT)--20160220 add by zhouyang
and b.line_id not in(select line_id from acc_st.OP_REPORT_LINE_NO_STAT);--20160220 add by zhouyang
insert into t#op_od_line_result(begin_line_no,end_line_no,person_num)
select linekey,rowkey,0 from t#op_od_line_rpt1;
insert into t#op_od_line_result
(begin_line_no,end_line_no,person_num)
select  a.linekey linekey,a.rowkey rowkey,nvl(b.person_num,0)
from t#op_od_line_rpt1 a ,t#op_od_line_result1 b
where a.linekey=b.begin_line_no and a.rowkey=b.end_line_no;
 ----∏¸–¬œﬂ¬∑√˚
        update t#op_od_line_result
        set begin_line_name=(
        select line_name from op_prm_line
        where begin_line_no=line_id and record_flag='0');
        update t#op_od_line_result
        set end_line_name=(
        select line_name from op_prm_line
        where end_line_no=line_id and record_flag='0');
--∑µªÿΩ·π˚ºØ
          open out_cursor for
          select v_type_name type_name, v_squadday||v_balanceday day,begin_line_name linekey,end_line_name rowkey,sum(person_num) as person_num
      from t#op_od_line_result
      group by begin_line_name,end_line_name;
    end;
/
grant execute on ACC_ST.UP_OP_OD_LINE_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_LINE_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_STA_DAY
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_STA_DAY
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_STA_DAY
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--∑÷Œˆ±®±Ì£∫’æµ„OD∑÷Œˆ»’±®
-- ‰≥ˆ≤Œ ˝  :
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130808
--∂‘”¶ƒ£∞Â£∫rpt_05_002
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
    v_line_id                char(2);     -- œﬂ¬∑¥˙¬Î
    v_squad_day           varchar(8);     -- ‘À”™»’
    v_balance_day         varchar(8);     -- «ÂÀ„»’
    v_line_name          varchar(50);     -- œﬂ¬∑√˚≥∆
    v_total_num                  int;     -- –°º∆
    v_line_no_sequence       char(2);     -- –Ú∫≈
    v_type_id          varchar2(2):='01'; --¥Ûœﬂ¬∑ID
BEGIN
  v_squad_day:= substr(in_squad_day,1,8);
  v_balance_day:=substr(in_balance_day,1,8);
  v_line_id:=in_line_id;
  if v_line_id !=' ' and v_line_id is not null then
    SELECT line_name into v_line_name FROM op_prm_line
 WHERE line_id = v_line_id and record_flag='0';
 end if ;
 select type_id into v_type_id from acc_st.op_cod_line_type where line_id=v_line_id;
 
--≤È—Øœ‡πÿ ˝æ› ≤¢∑≈»Î¡Ÿ ±±Ì
    INSERT INTO T#OP_OD_STA_RESULT1(begin_line_code, begin_station_code, end_line_code, end_station_code, num )
    SELECT b_line_id, b_station_id, e_line_id, e_station_id, SUM(person_num)
    FROM st_sts_od_card
    WHERE substr(squad_day,1,8) =v_squad_day
    AND balance_water_no>=v_balance_day||'00'
    and balance_water_no<=v_balance_day||'99'
    and e_line_id=v_line_id
    and b_station_id!='00' and e_station_id!='00'
    GROUP BY b_line_id, b_station_id, e_line_id,e_station_id;
    -- ◊È∫œ’æµ„øÕ¡˜±ÌΩ·ππ(∆ º’æµ„Œ™À˘”–’æµ„£¨÷’÷π’æµ„Œ™ Ù”⁄∏√Ãıœﬂ¬∑µƒ’æµ„)
    INSERT INTO T#OP_OD_STA_RESULT(begin_line_code,begin_line_name, begin_station_code, begin_station_name,end_line_code,end_line_name, end_station_code,end_station_name,num)
     SELECT A.line_id,'--', A.station_id,'--', B.line_id,'--', B.station_id,'--',0
     FROM op_prm_station A,op_prm_station B
            WHERE A.record_flag = '0'
            AND B.record_flag = '0'
            AND B.belong_line_id = v_line_id
            and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id = v_type_id);
 -- ∏¸–¬øÕ¡˜»À¥Œ
    INSERT INTO T#OP_OD_STA_RESULT(begin_line_code, begin_station_code,end_line_code, end_station_code,num)
     SELECT begin_line_code, begin_station_code, end_line_code, end_station_code, num
     FROM T#OP_OD_STA_RESULT1;
    -- ∏¸–¬∆ º’æµ„÷–Œƒ√˚≥∆
    UPdate T#OP_OD_STA_RESULT A
    SET (begin_station_name,begin_line_name) =(
    select '(' || B.sequence || ')' || B.chinese_name  ,c.sequence||c.line_name
    FROM op_prm_station B,op_prm_line C
        WHERE A.begin_line_code = B.line_id
        AND   A.begin_line_code = C.line_id
        AND   A.begin_station_code = B.station_id
        AND   B.belong_line_id = C.line_id
        and   B.record_flag= '0' and c.record_flag= '0');
    -- ∏¸–¬÷’÷π’æµ„÷–Œƒ√˚≥∆
   UPdate T#OP_OD_STA_RESULT A
   SET (end_station_name,end_line_name)=(
   select'(' ||B.sequence || ')' || B.chinese_name,c.sequence||c.line_name
   FROM op_prm_station B,op_prm_line C
        WHERE A.end_line_code = B.line_id
        AND A.END_LINE_CODE=C.LINE_ID
        AND A.end_station_code = B.station_id
        AND B.belong_line_id = C.line_id
        and B.record_flag= '0' and c.record_flag= '0');
    -- ∑µªÿΩ·π˚
    open out_cursor for
    SELECT v_squad_day||v_balance_day day,v_line_name linename,begin_station_name, end_station_name, SUM(num),begin_line_name,end_line_name
        FROM T#OP_OD_STA_RESULT
        GROUP BY begin_station_name, end_station_name,begin_line_name, end_line_name
        ORDER BY begin_line_name,begin_station_name, end_station_name;
END UP_OP_OD_STA_DAY;
/
grant execute on ACC_ST.UP_OP_OD_STA_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_STA_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_STA_HOUR_DAY
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_STA_HOUR_DAY
 ---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_STA_HOUR_DAY
--π¶ƒ‹¿‡–Õ£∫∆±ø®’æµ„ OD ∑÷Œˆ»’±®(∞¥ ±∂Œ)
--–ﬁ∏ƒ’ﬂ£∫  wangkejia
--–ﬁ∏ƒ»’∆⁄£∫20130809
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ±∂Œ
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
  v_squad_day char(8);
  v_balance_day char(8);
  v_line_no char(2);
  v_line_name varchar(20);
  v_card_main_id char(2);
  v_card_sub_id char(2);
  v_card_name varchar(20);
  v_beginsection int;
  v_endsection int;
  v_type_id          varchar2(2):='01'; --¥Ûœﬂ¬∑ID
  
    BEGIN
  v_squad_day:= substr(in_squad_day,1,8);
  v_balance_day:=substr(in_balance_day,1,8);
  v_line_no:= in_line_id;
  v_card_main_id:=in_card_main_id;
  v_card_sub_id:=in_card_sub_id;
  v_beginsection:=0;
  v_endsection:=1;
    
   if v_line_no is not null and v_line_no!=' ' then
    SELECT line_name into v_line_name FROM op_prm_line
 WHERE line_id = v_line_no and record_flag='0';
  end if;
  if v_card_main_id||v_card_sub_id is not null and v_card_main_id!=' ' and v_card_sub_id!=' ' then
   select card_sub_name into v_card_name from op_prm_card_sub
   where card_main_id=v_card_main_id and card_sub_id=v_card_sub_id
   and record_flag='0';
end if;
select type_id into v_type_id from acc_st.op_cod_line_type where line_id=v_line_no;

--≤È—Øœ‡πÿ ˝æ› ≤¢∑≈»Î¡Ÿ ±±Ì
 INSERT INTO T#OP_OD_STA_RESULT1(begin_line_code, begin_station_code, end_line_code, end_station_code, num,time_section_id )
    SELECT b_line_id, b_station_id, e_line_id, e_station_id, SUM(person_num),time_section_id
    FROM st_sts_od_card
    WHERE substr(squad_day,1,8) =v_squad_day
    AND balance_water_no>=v_balance_day||'00'
    and balance_water_no<=v_balance_day||'99'
    and e_line_id=v_line_no
    and card_main_id=v_card_main_id
    and card_sub_id=v_card_sub_id
    and e_station_id!='00' and b_Station_id!='00'
    GROUP BY b_line_id, b_station_id, e_line_id,e_station_id,time_section_id;
-------------------------------------------------------------------------------
   while v_beginsection<=23
          loop
            ----œÚΩ·π˚ºØÃÌº” ˝æ›
     INSERT INTO T#OP_OD_STA_RESULT(time_section,begin_line_code, begin_station_code,end_line_code,end_station_code,num)
     SELECT lpad(v_beginsection,2,'0')||':00-'||lpad(v_endsection,2,'0')||':00',begin_line_code, begin_station_code, end_line_code, end_station_code,num
     FROM T#OP_OD_STA_RESULT1
        WHERE to_number(TIME_SECTION_ID)>=v_beginsection AND to_number(TIME_SECTION_ID)<v_endsection;
 -------------------------------------------------------------------------------
 ------ ◊È∫œ’æµ„øÕ¡˜±ÌΩ·ππ(∆ º’æµ„Œ™À˘”–’æµ„£¨÷’÷π’æµ„Œ™ Ù”⁄∏√Ãıœﬂ¬∑µƒ’æµ„)
     INSERT INTO T#OP_OD_STA_RESULT(time_section,begin_line_code,begin_line_name, begin_station_code, begin_station_name,end_line_code,end_line_name, end_station_code,end_station_name,num)
     SELECT lpad(v_beginsection,2,'0')||':00-'||lpad(v_endsection,2,'0')||':00',A.line_id,'', A.station_id,'', B.line_id,'', B.station_id,'',0
     FROM op_prm_station A,op_prm_station B
        WHERE   A.record_flag = '0'
            AND B.record_flag = '0'
            AND B.LINE_ID=v_line_no
            and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id = v_type_id);
-------------------------------------------------------------------------------

           v_beginsection:=v_beginsection+1;
           v_endsection:=v_beginsection+1;
          end loop;
-------------------------------------------------------------------------------
-----∏¸–¬œﬂ¬∑’æµ„÷–Œƒ√˚
update T#OP_OD_STA_RESULT a set begin_station_name=(
      select b.sequence||b.chinese_name from op_prm_station b
where b.record_flag='0' and a.begin_line_code=b.line_id and a.begin_station_code=b.station_id);
update T#OP_OD_STA_RESULT a set end_station_name=(
      select b.sequence||b.chinese_name from op_prm_station b
where b.record_flag='0' and a.end_line_code=b.line_id and a.end_station_code=b.station_id);
update T#OP_OD_STA_RESULT a set begin_line_name=(
      select b.line_id||b.line_name from op_prm_line b
where b.record_flag='0' and a.begin_line_code=b.line_id);
update T#OP_OD_STA_RESULT a set end_line_name=(
      select b.line_id||b.line_name from op_prm_line b
where b.record_flag='0' and a.end_line_code=b.line_id);
    -- ∑µªÿΩ·π˚
    open out_cursor for
    SELECT v_squad_day||v_balance_day day,v_line_name linename,v_card_name cardname,time_section,begin_station_name, end_station_name, SUM(num),begin_line_name,end_line_name
        FROM T#OP_OD_STA_RESULT
        GROUP BY time_section,begin_station_name, end_station_name,begin_line_name, end_line_name
        ORDER BY time_section,begin_station_name, end_station_name;
END;
/
grant execute on ACC_ST.UP_OP_OD_STA_HOUR_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_STA_HOUR_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_STA_HOUR_MON
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_STA_HOUR_MON
 ---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_STA_HOUR_MON
--π¶ƒ‹¿‡–Õ£∫∆±ø®’æµ„ OD ∑÷Œˆ»’±®(∞¥ ±∂Œ)
--–ﬁ∏ƒ’ﬂ£∫  wangkejia
--–ﬁ∏ƒ»’∆⁄£∫20130809
--–ﬁ∏ƒƒ⁄»›£∫‘ˆº” ±∂Œ
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
  v_squad_day char(6);
  v_balance_day char(6);
  v_line_no char(2);
  v_line_name varchar(20);
  v_card_main_id char(2);
  v_card_sub_id char(2);
  v_card_name varchar(20);
  v_beginsection int;
  v_endsection int;
  v_type_id          varchar2(2):='01'; --¥Ûœﬂ¬∑ID
    BEGIN
  v_squad_day:= substr(in_squad_day,1,6);
  v_balance_day:=substr(in_balance_day,1,6);
  v_line_no:= in_line_id;
  v_card_main_id:=in_card_main_id;
  v_card_sub_id:=in_card_sub_id;
  v_beginsection:=0;
  v_endsection:=1;
   if v_line_no is not null and v_line_no!=' ' then
    SELECT line_name into v_line_name FROM op_prm_line
 WHERE line_id = v_line_no and record_flag='0';
  end if;
  if v_card_main_id||v_card_sub_id is not null and v_card_main_id!=' ' and v_card_sub_id!=' ' then
   select card_sub_name into v_card_name from op_prm_card_sub
   where card_main_id=v_card_main_id and card_sub_id=v_card_sub_id
   and record_flag='0';
end if;
select type_id into v_type_id from acc_st.op_cod_line_type where line_id=v_line_no;

--≤È—Øœ‡πÿ ˝æ› ≤¢∑≈»Î¡Ÿ ±±Ì
 INSERT INTO T#OP_OD_STA_RESULT1(begin_line_code, begin_station_code, end_line_code, end_station_code, num,time_section_id )
    SELECT b_line_id, b_station_id, e_line_id, e_station_id, SUM(person_num),time_section_id
    FROM st_sts_od_card
    WHERE substr(squad_day,1,6) =v_squad_day
    AND balance_water_no>=v_balance_day||'0100'
    and balance_water_no<=v_balance_day||'3199'
    and e_line_id=v_line_no
    and card_main_id=v_card_main_id
    and card_sub_id=v_card_sub_id
    and e_station_id!='00' and b_Station_id!='00'
    GROUP BY b_line_id, b_station_id, e_line_id,e_station_id,time_section_id;
-------------------------------------------------------------------------------
   while v_beginsection<=23
          loop
            ----œÚΩ·π˚ºØÃÌº” ˝æ›
     INSERT INTO T#OP_OD_STA_RESULT(time_section,begin_line_code, begin_station_code,end_line_code,end_station_code,num)
     SELECT lpad(v_beginsection,2,'0')||':00-'||lpad(v_endsection,2,'0')||':00',begin_line_code, begin_station_code, end_line_code, end_station_code,num
     FROM T#OP_OD_STA_RESULT1
        WHERE to_number(TIME_SECTION_ID)>=v_beginsection AND to_number(TIME_SECTION_ID)<v_endsection;
 -------------------------------------------------------------------------------
 ------ ◊È∫œ’æµ„øÕ¡˜±ÌΩ·ππ(∆ º’æµ„Œ™À˘”–’æµ„£¨÷’÷π’æµ„Œ™ Ù”⁄∏√Ãıœﬂ¬∑µƒ’æµ„)
     INSERT INTO T#OP_OD_STA_RESULT(time_section,begin_line_code,begin_line_name, begin_station_code, begin_station_name,end_line_code,end_line_name, end_station_code,end_station_name,num)
     SELECT lpad(v_beginsection,2,'0')||':00-'||lpad(v_endsection,2,'0')||':00',A.line_id,'', A.station_id,'', B.line_id,'', B.station_id,'',0
     FROM op_prm_station A,op_prm_station B
        WHERE   A.record_flag = '0'
            AND B.record_flag = '0'
            AND B.LINE_ID=v_line_no
            and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id = v_type_id);
-------------------------------------------------------------------------------

           v_beginsection:=v_beginsection+1;
           v_endsection:=v_beginsection+1;
          end loop;
-------------------------------------------------------------------------------
-----∏¸–¬œﬂ¬∑’æµ„÷–Œƒ√˚
update T#OP_OD_STA_RESULT a set begin_station_name=(
      select b.sequence||b.chinese_name from op_prm_station b
where b.record_flag='0' and a.begin_line_code=b.line_id and a.begin_station_code=b.station_id);
update T#OP_OD_STA_RESULT a set end_station_name=(
      select b.sequence||b.chinese_name from op_prm_station b
where b.record_flag='0' and a.end_line_code=b.line_id and a.end_station_code=b.station_id);
update T#OP_OD_STA_RESULT a set begin_line_name=(
      select b.line_id||b.line_name from op_prm_line b
where b.record_flag='0' and a.begin_line_code=b.line_id);
update T#OP_OD_STA_RESULT a set end_line_name=(
      select b.line_id||b.line_name from op_prm_line b
where b.record_flag='0' and a.end_line_code=b.line_id);
    -- ∑µªÿΩ·π˚
    open out_cursor for
    SELECT v_squad_day||v_balance_day day,v_line_name linename,v_card_name cardname,time_section,begin_station_name, end_station_name, SUM(num),begin_line_name,end_line_name
        FROM T#OP_OD_STA_RESULT
        GROUP BY time_section,begin_station_name, end_station_name,begin_line_name, end_line_name
        ORDER BY time_section,begin_station_name, end_station_name;
END;
/
grant execute on ACC_ST.UP_OP_OD_STA_HOUR_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_STA_HOUR_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_OD_STA_MON
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_OD_STA_MON
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_OD_STA_MON
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--∑÷Œˆ±®±Ì£∫’æµ„OD∑÷Œˆ‘¬±®
-- ‰≥ˆ≤Œ ˝  :
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130808
--∂‘”¶ƒ£∞Â£∫UP_OP_OD_STA_MON
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

(
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
    v_line_no                char(2);     -- œﬂ¬∑¥˙¬Î
    v_squad_day           varchar(6);     -- ‘À”™»’
    v_balance_day         varchar(6);     -- «ÂÀ„»’
    v_line_name          varchar(50);     -- œﬂ¬∑√˚≥∆
    v_total_num                  int;     -- –°º∆
    v_line_no_sequence       char(2);     -- –Ú∫≈
    v_type_id          varchar2(2):='01'; --¥Ûœﬂ¬∑ID
BEGIN
  v_squad_day:= substr(in_squad_day,1,6);
  v_balance_day:=substr(in_balance_day,1,6);
  v_line_no:=in_line_id;
  if v_line_no!=' ' and v_line_no is not null then
    SELECT line_name into v_line_name FROM op_prm_line
 WHERE line_id = v_line_no and record_flag='0';
 end if;
 select type_id into v_type_id from acc_st.op_cod_line_type where line_id=v_line_no;
 
--≤È—Øœ‡πÿ ˝æ› ≤¢∑≈»Î¡Ÿ ±±Ì
    INSERT INTO T#OP_OD_STA_RESULT1(begin_line_code, begin_station_code, end_line_code, end_station_code, num )
    SELECT b_line_id, b_station_id, e_line_id, e_station_id, SUM(person_num)
    FROM st_sts_od_card
    WHERE substr(squad_day,1,6) =v_squad_day
    AND balance_water_no>=v_balance_day||'0100'
    and balance_water_no<=v_balance_day||'3199'
    and e_line_id=v_line_no
    and b_station_id!='00' and e_station_id!='00'
    GROUP BY b_line_id, b_station_id, e_line_id,e_station_id;
    -- ◊È∫œ’æµ„øÕ¡˜±ÌΩ·ππ(∆ º’æµ„Œ™À˘”–’æµ„£¨÷’÷π’æµ„Œ™ Ù”⁄∏√Ãıœﬂ¬∑µƒ’æµ„)
    INSERT INTO T#OP_OD_STA_RESULT(begin_line_code,begin_line_name, begin_station_code, begin_station_name,end_line_code,end_line_name, end_station_code,end_station_name,num)
     SELECT A.line_id,'--', A.station_id,'--', B.line_id,'--', B.station_id,'--',0
     FROM op_prm_station A,op_prm_station B
            WHERE A.record_flag = '0'
            AND B.record_flag = '0'
            AND B.belong_line_id = v_line_no
            and a.line_id in (select line_id from acc_st.op_cod_line_type where type_id = v_type_id);
 -- ∏¸–¬øÕ¡˜»À¥Œ
    INSERT INTO T#OP_OD_STA_RESULT(begin_line_code, begin_station_code,end_line_code, end_station_code,num)
     SELECT begin_line_code, begin_station_code, end_line_code, end_station_code, num
     FROM T#OP_OD_STA_RESULT1;
    -- ∏¸–¬∆ º’æµ„÷–Œƒ√˚≥∆
    UPdate T#OP_OD_STA_RESULT A
    SET (begin_station_name,begin_line_name) =(
    select '(' || B.sequence || ')' || B.chinese_name  ,c.sequence||c.line_name
    FROM op_prm_station B,op_prm_line C
        WHERE A.begin_line_code = B.line_id
        AND   A.begin_line_code = C.line_id
        AND   A.begin_station_code = B.station_id
        AND   B.belong_line_id = C.line_id
        and   B.record_flag= '0' and c.record_flag= '0');
    -- ∏¸–¬÷’÷π’æµ„÷–Œƒ√˚≥∆
   UPdate T#OP_OD_STA_RESULT A
   SET (end_station_name,end_line_name)=(
   select'(' ||B.sequence || ')' || B.chinese_name,c.sequence||c.line_name
   FROM op_prm_station B,op_prm_line C
        WHERE A.end_line_code = B.line_id
        AND A.END_LINE_CODE=C.LINE_ID
        AND A.end_station_code = B.station_id
        AND B.belong_line_id = C.line_id
        and B.record_flag= '0' and c.record_flag= '0');
    -- ∑µªÿΩ·π˚
    open out_cursor for
    SELECT v_squad_day||v_balance_day day,v_line_name linename,begin_station_name, end_station_name, SUM(num),begin_line_name,end_line_name
        FROM T#OP_OD_STA_RESULT
        GROUP BY begin_station_name, end_station_name,begin_line_name, end_line_name
        ORDER BY begin_station_name, end_station_name;
END;
/
grant execute on ACC_ST.UP_OP_OD_STA_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_OD_STA_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_AVE_DIST_MON
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_AVE_DIST_MON (
 ---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_PFL_AVE_DIST_MON
--∂‘”¶ƒ£∞Â£∫rpt_01_001
--π¶ƒ‹√Ë ˆ£∫∆Ωæ˘≥Àæ‡Õ≥º∆‘¬±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--–ﬁ∏ƒ»À:wangkejia
--»’∆⁄£∫20130819
----------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan
--20170725‘ˆº”¥≈∏°Õ®«⁄ø®09  yaoshiwen

in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_balanceday   char(6);--«ÂÀ„‘¬
   v_squadday     char(6);--‘À”™‘¬
   v_day          int;--»’
   v_max_day      int;
   v_type_name varchar2(50);--¥Ûœﬂ¬∑√˚≥∆£®πÏµ¿œﬂ°¢¥≈∏°œﬂ£©
BEGIN
 v_balanceday:= substr(in_balance_day,1,6);
 v_squadday:= substr(in_squad_day,1,6);
 v_day:=1;
 v_max_day:=1;
 select distinct description into v_type_name from acc_st.op_cod_line_type where type_id= in_line_id;

    insert into t#op_ave_dist_rpt(card_main_code,card_sub_code,card_sub_desc)
      select card_main_id,card_sub_id,card_sub_name
  from op_prm_card_sub
    where card_main_id in('01','02','03','04','07','08','09')--2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø® 20170725‘ˆº”¥≈∏°Õ®«⁄ø®
    and record_flag='0';
    insert into t#op_ave_dist_rpt(card_main_code,card_sub_code,card_sub_desc) values ('06',' ','≥« –Õ®∆±');
--≤È—Ø ˝æ›
   insert into  t#op_ave_dist_result1
   (card_main_code,card_sub_code,squad_day,distance_num,total_distance)
   select card_main_id,case when card_main_id='06' then ' ' else card_sub_id end as card_sub_id,squad_day,sum(nvl(distance_num,0)),sum(nvl(total_distance,0))
   from ST_STS_FLW_AVERAGE_DISTANCE
   where balance_water_no>=v_balanceday||'0100'
   and balance_water_no<=v_balanceday||'3199'
   and  squad_day>=v_squadday||'01'
   and squad_day<=v_squadday||'31'
   and card_main_id in('01','02','03','04','06','07','08','09')--2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø® 20170725‘ˆº”¥≈∏°Õ®«⁄ø®
   and BEGIN_LINE in(select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
   group by card_main_id,card_sub_id,squad_day;
------------------------------------------------------------------------------------
 /*-----ππΩ®Ω·π˚ºØΩ·ππ
 select max(squad_day) into v_max_day from ST_STS_FLW_AVERAGE_DISTANCE
 where  substr(balance_water_no,1,8)=v_balanceday;
 while v_day<=v_max_day --‘À––”√v_max_day,≤‚ ‘ƒ£∞Â”√30
   loop
 insert into  t#op_ave_dist_result
   select lpad(v_day,2,0),card_main_code,card_sub_code,card_sub_desc,0
   from t#op_ave_dist_rpt;
   v_day:=v_day+1;
   end loop;*/
------------------------------------------------------------------------------------
--œÚ¡Ÿ ±Ω·π˚±ÌÃÌº” ˝æ›
   insert into  t#op_ave_dist_result
   select  substr(a.squad_day,7,2),a.card_main_code,a.card_sub_code,b.card_sub_desc,round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   group by substr(a.squad_day,7,2),a.card_main_code,a.card_sub_code, b.card_sub_desc;
   --…œ—Æ–°º∆
      insert into  t#op_ave_dist_result
   select  '10…œ—Æ–°º∆',a.card_main_code,a.card_sub_code,b.card_sub_desc,round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   and substr(a.squad_day,7,2)<=10
   group by a.card_main_code,a.card_sub_code, b.card_sub_desc;
    --÷–—Æ–°º∆
      insert into  t#op_ave_dist_result
   select  '20÷–—Æ–°º∆',a.card_main_code,a.card_sub_code,b.card_sub_desc,round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   and substr(a.squad_day,7,2)<=20 and substr(a.squad_day,7,2)>=11
   group by a.card_main_code,a.card_sub_code, b.card_sub_desc;
     --œ¬—Æ–°º∆
      insert into  t#op_ave_dist_result
   select  '31œ¬—Æ–°º∆',a.card_main_code,a.card_sub_code,b.card_sub_desc,round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   and substr(a.squad_day,7,2)<=31 and substr(a.squad_day,7,2)>=21
   group by a.card_main_code,a.card_sub_code, b.card_sub_desc;
   --…œ—Æ Œ≤¡–∫œº∆
         insert into  t#op_ave_dist_result
   select  '10…œ—Æ–°º∆','','','∫œº∆',nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where  substr(a.squad_day,7,2)<=10;
   --÷–—Æ Œ≤¡–∫œº∆
         insert into  t#op_ave_dist_result
   select  '20÷–—Æ–°º∆','','','∫œº∆',nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where  substr(a.squad_day,7,2)<=20 and substr(a.squad_day,7,2)>=11;
    --œ¬—Æ Œ≤¡–∫œº∆
         insert into  t#op_ave_dist_result
   select  '31œ¬—Æ–°º∆','','','∫œº∆',nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where  substr(a.squad_day,7,2)<=31 and substr(a.squad_day,7,2)>=21;
   -------------------------------------------Œ≤¡– √ø»’∫œº∆
   insert into  t#op_ave_dist_result
   select substr(a.squad_day,7,2),'','','∫œº∆',round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   group by substr(a.squad_day,7,2);
   -------------------------------------------∞¥∆±ø®‘¬◊‹º∆
   insert into  t#op_ave_dist_result
   select  '∆Ωæ˘≥Àæ‡∫œº∆', a.card_main_code,a.card_sub_code,
   b.card_sub_desc,nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where     a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   group by  a.card_main_code,a.card_sub_code, b.card_sub_desc;
   --------------------------------------------‘¬◊‹º∆
   insert into  t#op_ave_dist_result
   select   '∆Ωæ˘≥Àæ‡∫œº∆','','','∫œº∆', nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b;
open out_cursor for
   select v_type_name type_name, v_squadday||v_balanceday mon,day,card_main_id||card_sub_id||card_name as card_name,sum(distance) distance from t#op_ave_dist_result
   group by day,card_main_id,card_sub_id,card_name,distance
   order by day,card_main_id||card_sub_id||card_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_AVE_DIST_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_AVE_DIST_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_AVE_DIST_YEAR
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_AVE_DIST_YEAR (
 ---------------------------------------------------------------------------------
--ƒ£∞Â£∫rpt_01_002
--π¶ƒ‹√Ë ˆ£∫∆Ωæ˘≥Àæ‡Õ≥º∆ƒÍ±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--–ﬁ∏ƒ»À:wangkejia
--»’∆⁄£∫20130819
--–ﬁ∏ƒ 2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®

--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan
--–ﬁ∏ƒ 20160510 mqf ‘ˆº”≤È—Ø¿˙ ∑±Ì ˝æ›
--20170725‘ˆº”¥≈∏°Õ®«⁄ø®09 yaoshiwen
-------------------------------------------------------------------------------

in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_balanceyear   char(4);--«ÂÀ„ƒÍ
   v_squadyear     char(4);--‘À”™ƒÍ∑›
   v_day           int;
   v_type_name varchar2(50);--¥Ûœﬂ¬∑√˚≥∆£®πÏµ¿œﬂ°¢¥≈∏°œﬂ£©
   v_sql           varchar2(2048);
BEGIN
 v_balanceyear:= substr(in_balance_day,1,4);
 v_squadyear:= substr(in_squad_day,1,4);
 v_day:=1;
 select distinct description into v_type_name from acc_st.op_cod_line_type where type_id= in_line_id;

     insert into t#op_ave_dist_rpt(card_main_code,card_sub_code,card_sub_desc)
      select card_main_id,card_sub_id,card_sub_name
  from op_prm_card_sub
    where card_main_id in('01','02','03','04','07','08','09')--2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø® 20170725‘ˆº”¥≈∏°Õ®«⁄ø®
    and record_flag='0';
    insert into t#op_ave_dist_rpt(card_main_code,card_sub_code,card_sub_desc)
    values ('06',' ','≥« –Õ®∆±');
--≤È—Ø ˝æ›
   insert into  t#op_ave_dist_result1
   (card_main_code,card_sub_code,squad_day,distance_num,total_distance)
   select card_main_id,case when card_main_id='06' then ' ' else card_sub_id end as card_sub_id,squad_day,sum(nvl(distance_num,0)),sum(nvl(total_distance,0))
   from ST_STS_FLW_AVERAGE_DISTANCE
   where balance_water_no>=v_balanceyear||'010100'
   and balance_water_no<=v_balanceyear||'123199'
   and  squad_day>=v_squadyear||'0101'
   and squad_day<=v_squadyear||'1231'
   and card_main_id in('01','02','03','04','06','07','08','09')--2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø® 20170725‘ˆº”¥≈∏°Õ®«⁄ø®
   and BEGIN_LINE in(select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
   group by card_main_id,card_sub_id,squad_day;

   --20160510 mqf ‘ˆº”≤È—Ø¿˙ ∑±Ì ˝æ›
   begin
  declare
    cursor index_table is
    select table_name    temp_table_name
      from acc_st.st_idx_rpt_history t
    where origin_table_name = 'acc_st.st_sts_flw_average_distance'
       and min_squad_day <= v_squadyear||'1231'
       and max_squad_day >= v_squadyear||'0101'
       order by table_name desc;

  begin
    for t_cur in index_table loop

      v_sql := 'insert into  acc_st.t#op_ave_dist_result1 ' ||
           '(card_main_code,card_sub_code,squad_day,distance_num,total_distance) ' ||
           ' select card_main_id,case when card_main_id=''06'' then '' '' else card_sub_id end as card_sub_id,squad_day,sum(nvl(distance_num,0)),sum(nvl(total_distance,0)) ' ||
           ' from acc_st.' || t_cur.temp_table_name ||
           ' where balance_water_no>=''' || v_balanceyear || '010100''' ||
           ' and balance_water_no<=''' || v_balanceyear || '123199''' ||
           ' and  squad_day>=''' || v_squadyear || '0101''' ||
           ' and squad_day<=''' || v_squadyear || '1231''' ||
           ' and card_main_id in(''01'',''02'',''03'',''04'',''06'',''07'',''08'',''09'')' ||   --20170725‘ˆº”¥≈∏°Õ®«⁄ø®
           ' and BEGIN_LINE in(select line_id from acc_st.op_cod_line_type where type_id= ''' ||in_line_id || ''')' ||
           ' group by card_main_id,card_sub_id,squad_day';
      execute immediate v_sql;

    end loop;

  end;
  end;
------------------------------------------------------------------------------------
--œÚ¡Ÿ ±Ω·π˚±ÌÃÌº” ˝æ›
   insert into  t#op_ave_dist_result
   select  a.squad_day,a.card_main_code,a.card_sub_code,b.card_sub_desc,round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   group by a.squad_day,a.card_main_code,a.card_sub_code, b.card_sub_desc;
  --------------------------------------------Œ≤¡– √ø»’∫œº∆
   insert into  t#op_ave_dist_result
   select squad_day,'','','∫œº∆',round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   group by squad_day;
   -------------------------------------------ƒÍ ∞¥∆±ø®◊‹º∆
   insert into  t#op_ave_dist_result
   select  '∆Ωæ˘≥Àæ‡∫œº∆', a.card_main_code,a.card_sub_code,
   b.card_sub_desc,nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b
   where     a.card_main_code=b.card_main_code
   and a.card_sub_code=b.card_sub_code
   group by  a.card_main_code,a.card_sub_code, b.card_sub_desc;
   --------------------------------------------ƒÍ◊‹º∆
   insert into  t#op_ave_dist_result
   select   '∆Ωæ˘≥Àæ‡∫œº∆','','','∫œº∆', nvl(round(decode(sum(a.distance_num),0,0,sum(a.total_distance)/sum(a.distance_num)),2),0)
   from t#op_ave_dist_result1 a,t#op_ave_dist_rpt b;
   /*--∏¸–¬∆±ø®√˚
   update t#op_ave_dist_result
   set card_sub_id='00',card_name='≥« –Õ®∆±'
   where card_main_id='06';*/
open out_cursor for
   select v_type_name type_name, v_squadyear||v_balanceyear year,day,card_main_id||card_sub_id||card_name as card_name,distance from t#op_ave_dist_result
   group by day,card_main_id,card_sub_id,card_name,distance
   order by day,card_main_id||card_sub_id||card_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_AVE_DIST_YEAR to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_AVE_DIST_YEAR to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_CHANGE_MON
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_CHANGE_MON (
---------------------------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫  rpt_01_011
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--‘¬ªª≥ÀøÕ¡˜«ÈøˆÕ≥º∆±Ì
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫ Õıø…º—
--¥¥Ω®»’∆⁄£∫20130826
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_balance_month       char(6);        -- «ÂÀ„‘¬
   v_squad_month         char(6);        -- ‘À”™‘¬
   v_card_main_code      char(2);
   v_card_sub_code       char(2);
   v_card_name           varchar(30);
   v_day                 int;
begin
    v_balance_month:=substr(in_balance_day,1,6);
    v_card_main_code:=in_card_main_id;
    v_card_sub_code:=in_card_sub_id;
    v_squad_month:=substr(in_squad_day,1,6);
    v_day:=1;
if v_card_sub_code||v_card_sub_code is not null and v_card_sub_code!=' ' and v_card_sub_code!=' ' then
  select card_sub_name into v_card_name
  from op_prm_card_sub
     where card_main_id=v_card_main_code
     and card_sub_id=v_card_sub_code
     and record_flag='0';
 end if;
--≤È—Ø ˝æ›
     insert into t#op_PFL_CHANGE_rpt
     (change_in_line,change_out_line,num,squad_day,card_main_code,card_sub_code)
                select change_line_in,change_line_out,sum(num),squad_day,card_main_id,card_sub_id
                from st_sts_flw_change a
                   where  balance_water_no>=v_balance_month||'0100'
                   and balance_water_no<=v_balance_month||'3199'
                   and card_main_id=v_card_main_code and  card_sub_id=v_card_sub_code
                   and substr(squad_day,1,6)=v_squad_month
                group by change_line_in,change_line_out,squad_day,card_main_id,card_sub_id;
-------------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
 while v_day<=30
      loop
  insert into t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'01','02','“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'01','03','“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'01','04','“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'02','01','∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'02','03','∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'02','04','∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'03','01','»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'03','02','»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'03','04','»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'04','01','Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'04','02','Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',0);
    insert into t#op_PFL_CHANGE_result (day,change_out,change_in,change_out_name,change_in_name,num)
  values (v_day,'04','03','Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',0);
  v_day:=v_day+1;
  end loop;
 -------------------------------------------------------------------------------------
       ------------------------“ª∫≈œﬂªª≥À÷¡∆‰À¸¬∑œﬂ
    INSERT INTO t#op_PFL_CHANGE_result
    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='02' and change_out_line='01'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
    INSERT INTO t#op_PFL_CHANGE_result
        (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='03' and change_out_line='01'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
      INSERT INTO t#op_PFL_CHANGE_result
          (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='04' and change_out_line='01'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
       ------------------------∂˛∫≈œﬂªª≥À÷¡
      INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='01' and change_out_line='02'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
  INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='03' and change_out_line='02'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
  INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='04' and change_out_line='02'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
     ------------------------ »˝∫≈œﬂªª≥À÷¡
  INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='01' and change_out_line='03'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
   INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='02' and change_out_line='03'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
             INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='04' and change_out_line='03'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
      ------------------------ Àƒ∫≈œﬂªª≥À÷¡
  INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='01' and change_out_line='04'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
              INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='02' and change_out_line='04'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
              INSERT INTO t#op_PFL_CHANGE_result    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line,'Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='03' and change_out_line='04'
            group by to_number(substr(squad_day,7,2),'99'),change_out_line,change_in_line;
   --À˘”–œﬂ¬∑
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','“ª∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='01'
     group by day,change_in;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','∂˛∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='02'
     group by day,change_in;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','»˝∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='03'
     group by day,change_in;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','Àƒ∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='04'
     group by day,change_in;
/*--∏¸–¬œﬂ¬∑–Ú∫≈
update t#op_PFL_CHANGE_result a
set a.change_in=(select b.sequence
from ic_cod_line_code b
where a.change_in=b.line_id and b.record_flag='0');
update t#op_PFL_CHANGE_result a
set a.change_out=(select b.sequence
from ic_cod_line_code b
where a.change_out=b.line_id and b.record_flag='0');
*/
open out_cursor for
select  v_card_name cardname,v_squad_month||v_balance_month as month,day,change_in||change_in_name as change_in,change_out||change_out_name as change_out,sum(num) as num
from t#op_PFL_CHANGE_result
group by day,change_in,change_out,change_in_name,change_in,change_out_name
order by day,change_in,change_out,change_in_name,change_out_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_CHANGE_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_CHANGE_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_CHANGE_STA_DAY
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_CHANGE_STA_DAY (
-----------------------
--π¶ƒ‹√Ë ˆ£∫ªª≥ÀøÕ¡˜OD∑÷Œˆ»’±®
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130810
--∂‘”¶ƒ£∞Â£∫rpt_01_009
--–ﬁ∏ƒ 2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
--------------------------------------------------------
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫zzq
--∏¸∏ƒ»’∆⁄£∫20160630
--∏¸∏ƒƒ⁄»›£∫–ﬁ’˝¿œ»À”≈ª›¥¢÷µ∆± ¿œ»À√‚∑—¥¢÷µ∆±◊¢ Õ£¨
--¿œ»À”≈ª›¥¢÷µ∆±∂‘”¶svt_old_num◊÷∂Œ°£
-- ¿œ»À√‚∑—¥¢÷µ∆±∂‘”¶svt_oldfree_num◊÷∂Œ
---------------------------------------------------------
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫ysw
--∏¸∏ƒ»’∆⁄£∫20170722
--∏¸∏ƒƒ⁄»›£∫‘ˆº”¥≈∏°Õ®«⁄ø®
--¥≈∏°Õ®«⁄ø®◊÷∂Œmaglev_commute_num◊÷∂Œ
---------------------------------------------------------
--------------------------------
    in_line_id            char,
    in_station_id         char,
    in_card_main_id       char,
    in_card_sub_id        char,
    in_squad_day          char,
    in_balance_day        char,
    out_cor OUT sys_refcursor)
----------------------------------------------------------------------------------
aS
       v_squad_day         char(8);
       v_balance_day       char(8);
 BEGIN
       v_balance_day:=substr(in_balance_day,1,8);
       v_squad_day:=substr(in_squad_day,1,8);
--≤È—Øœ‡πÿ ˝æ›
  insert into t#op_change_sta_rpt
  (num,card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in)
  select num,card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in
  from st_sts_flw_change
  where balance_water_no>= v_balance_day||'00'
  and balance_water_no<= v_balance_day||'99'
  and substr(squad_day,1,8)=v_squad_day;
  --∆’Õ®≥…»Àµ•≥Ã∆±
  insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,sum(num),0,0,0,0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='01' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --≥…»À∆’Õ®¥¢÷µ∆±
   insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,sum(num),0,0,0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --—ß…˙∆’Õ®¥¢÷µ∆±
  insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,sum(num),0,0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '01'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
   --¿œ»À”≈ª›¥¢÷µ∆±
  insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,sum(num),0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '02'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --¿œ»À√‚∑—¥¢÷µ∆±
  insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,sum(num),0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '03'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --∆’Õ®≥À¥Œ∆±
  insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,sum(num),0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='03' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --∆’Õ®ºÕƒÓ∆±
    insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,sum(num),0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='04' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
    --”≈ª›ºÕƒÓ∆±
    insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,sum(num),0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='04' and card_sub_id= '01'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --≥« –Õ®∆±
    insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,sum(num),0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='06'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
 --∆’Õ®“Ï–Õ¥¢÷µø® 2015-1-30‘ˆº”
    insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,0,sum(num),0,0
  from t#op_change_sta_rpt
  where  card_main_id='07'and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
 --∆’Õ® ÷ª˙∆±2015-1-30‘ˆº”
    insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,0,0,sum(num),0
  from t#op_change_sta_rpt
  where  card_main_id='08'and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --¥≈∏°Õ®«⁄ø®20170722‘ˆº”
    insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,0,0,0,sum(num)
  from t#op_change_sta_rpt
  where  card_main_id='09'and card_sub_id= '01'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
--∏¸–¬◊‹º∆
 update t#op_change_sta_result
  set deal_num = single_normal_num + svt_normal_num + svt_student_num  + svt_old_num  + svt_oldfree_num
  +normal_times_num+normal_memo_num +pre_memo_num +city_num+different_num+mobile_num + maglev_commute_num;
--∏¸–¬’æµ„ œﬂ¬∑√˚
  update t#op_change_sta_result a
  set station_name=(select line_id||sequence||chinese_name from op_prm_station b
  where a.change_line=b.line_id  and a.change_station=b.station_id
  and b.record_flag='0');
  update t#op_change_sta_result a
  set in_line_name=(select b.line_name
  from op_prm_line b
  where a.change_line_in=b.line_id and b.record_flag='0');
  update t#op_change_sta_result a
  set out_line_name=(select b.line_name
  from op_prm_line b
  where a.change_line_out=b.line_id and b.record_flag='0');
open out_cor for
  select v_squad_day||v_balance_day day,
        station_name,in_line_name,out_line_name,
  sum(single_normal_num) as single_normal_num,
  sum(svt_normal_num) as svt_normal_num,
  sum(svt_student_num) as svt_student_num,
  sum(svt_old_num) as svt_old_num,
  sum(svt_oldfree_num) as svt_oldfree_num,
  sum(normal_times_num) as nomal_times_num,
  sum(normal_memo_num) as normal_memo_num,
  sum(pre_memo_num) as pre_memo_num,
  sum(city_num) as city_num,
  sum(different_num) as different_num,
  sum(mobile_num) as mobile_num,
  sum(maglev_commute_num)as maglev_commute_num,
  sum(deal_num) as deal_num
  from t#op_change_sta_result
  group by station_name,in_line_name,out_line_name
  order by station_name,in_line_name,out_line_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_CHANGE_STA_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_CHANGE_STA_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_CHANGE_STA_MON
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_CHANGE_STA_MON (
-----------------------
--π¶ƒ‹√Ë ˆ£∫ªª≥ÀøÕ¡˜OD∑÷Œˆ‘¬±®
--∂‘”¶ƒ£∞Â£∫rpt_01_010
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130810
--–ﬁ∏ƒ 2015-1-30‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
--------------------------------------------------------
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫zzq
--∏¸∏ƒ»’∆⁄£∫20160630
--∏¸∏ƒƒ⁄»›£∫–ﬁ’˝¿œ»À”≈ª›¥¢÷µ∆± ¿œ»À√‚∑—¥¢÷µ∆±◊¢ Õ£¨
--¿œ»À”≈ª›¥¢÷µ∆±∂‘”¶svt_old_num◊÷∂Œ°£
-- ¿œ»À√‚∑—¥¢÷µ∆±∂‘”¶svt_oldfree_num◊÷∂Œ
---------------------------------------------------------
--------------------------------------------------------
--∏¸∏ƒ’ﬂ£∫ysw
--∏¸∏ƒ»’∆⁄£∫20170722
--∏¸∏ƒƒ⁄»›£∫‘ˆº”¥≈∏°Õ®«⁄ø®
--¥≈∏°Õ®«⁄ø®◊÷∂Œmaglev_commute_num◊÷∂Œ
---------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
       v_squad_day         char(6);
       v_balance_day       char(6);
 BEGIN
       v_balance_day:=substr(in_balance_day,1,6);
       v_squad_day:=substr(in_squad_day,1,6);
  /*insert into t#op_change_sta_rpt1
  (change_out_line,change_LINE,change_in_line,
  change_station)
  select distinct n.CHANGE_LINE_OUT,n.CHANGE_line,n.CHANGE_LINE_IN,
  n.CHANGE_STATION
  from st_list_change_detail n
  where record_flag='0';*/
--≤È—Øœ‡πÿ ˝æ›
  insert into t#op_change_sta_rpt
  (num,card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in)
  select num,card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in
  from st_sts_flw_change
  where balance_water_no>= v_balance_day||'0100'
  and balance_water_no<= v_balance_day||'3199'
  and substr(squad_day,1,6)=v_squad_day;
  --∆’Õ®≥…»Àµ•≥Ã∆±
  insert into t#op_change_sta_result
   (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,sum(num),0,0,0,0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='01' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --≥…»À∆’Õ®¥¢÷µ∆±
   insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,sum(num),0,0,0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --—ß…˙∆’Õ®¥¢÷µ∆±
  insert into t#op_change_sta_result
   (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,sum(num),0,0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '01'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
   --¿œ»À”≈ª›¥¢÷µ∆±
  insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,sum(num),0,0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '02'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --¿œ»À√‚∑—¥¢÷µ∆±
  insert into t#op_change_sta_result
   (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,sum(num),0,0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='02' and card_sub_id= '03'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --∆’Õ®≥À¥Œ∆±
  insert into t#op_change_sta_result
   (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,sum(num),0,0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='03' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --∆’Õ®ºÕƒÓ∆±
    insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,sum(num),0,0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='04' and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
    --”≈ª›ºÕƒÓ∆±
    insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,sum(num),0,0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='04' and card_sub_id= '01'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --≥« –Õ®∆±
    insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,sum(num),0,0,0
  from t#op_change_sta_rpt
  where  card_main_id='06'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
 --∆’Õ®“Ï–Õ¥¢÷µø® 2015-1-30‘ˆº”
    insert into t#op_change_sta_result
  (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,0,sum(num),0,0
  from t#op_change_sta_rpt
  where  card_main_id='07'and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
 --∆’Õ® ÷ª˙∆±2015-1-30‘ˆº”
    insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,0,0,sum(num),0
  from t#op_change_sta_rpt
  where  card_main_id='08'and card_sub_id= '00'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;
  --¥≈∏°Õ®«⁄ø®20170722‘ˆº”
    insert into t#op_change_sta_result
 (card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,single_normal_num,svt_normal_num,svt_student_num,svt_old_num,svt_oldfree_num,normal_times_num,normal_memo_num,pre_memo_num,city_num,different_num,mobile_num,maglev_commute_num)
  select card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in,0,0,0,0,0,0,0,0,0,0,0,sum(num)
  from t#op_change_sta_rpt
  where  card_main_id='09'and card_sub_id= '01'
  group by card_main_id,card_sub_id,change_line,change_station,change_line_out,change_line_in;

--∏¸–¬◊‹º∆
 update t#op_change_sta_result
  set deal_num = single_normal_num + svt_normal_num+ svt_student_num  + svt_old_num  + svt_oldfree_num +normal_times_num
   +normal_memo_num +pre_memo_num +city_num+different_num+mobile_num + maglev_commute_num;
--∏¸–¬’æµ„ œﬂ¬∑√˚
  update t#op_change_sta_result a
  set a.station_name=(select b.sequence||b.chinese_name from op_prm_station b
  where a.change_line=b.line_id  and a.change_station=b.station_id
  and b.record_flag='0');
  update t#op_change_sta_result a
  set in_line_name=(select b.sequence||b.line_name
  from op_prm_line b
  where a.change_line_in=b.line_id and b.record_flag='0');
  update t#op_change_sta_result a
  set out_line_name=(select b.sequence||b.line_name
  from op_prm_line b
  where a.change_line_out=b.line_id and b.record_flag='0');
open out_cursor for
  select v_squad_day||v_balance_day day,
        station_name,in_line_name,out_line_name,
  sum(single_normal_num) as single_normal_num,
  sum(svt_normal_num) as svt_normal_num,
  sum(svt_student_num) as svt_student_num,
  sum(svt_old_num) as svt_old_num,
  sum(svt_oldfree_num) as svt_oldfree_num,
  sum(normal_times_num) as nomal_times_num,
  sum(normal_memo_num) as normal_memo_num,
  sum(pre_memo_num) as pre_memo_num,
  sum(city_num) as city_num,
  sum(different_num) as different_num,
  sum(mobile_num) as mobile_num,
  sum(maglev_commute_num)as maglev_commute_num,
  sum(deal_num) as deal_num
  from t#op_change_sta_result
  group by station_name,in_line_name,out_line_name
  order by station_name,in_line_name,out_line_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_CHANGE_STA_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_CHANGE_STA_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_CHANGE_YEAR
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_CHANGE_YEAR (
---------------------------------------------------------------------------------
--∂‘”¶ƒ£∞Â√˚£∫  rpt_01_012
--π¶ƒ‹√Ë ˆ£∫ƒÍªª≥ÀøÕ¡˜«ÈøˆÕ≥º∆±Ì
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫ Õıø…º—
--¥¥Ω®»’∆⁄£∫20130826
--–ﬁ∏ƒ 20160621 zy ‘ˆº”≤È—Ø¿˙ ∑±Ì ˝æ›
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_balance_year       char(4);        --«ÂÀ„ƒÍ
   v_squad_year         char(4);        -- ‘À”™ƒÍ
   v_card_main_code      char(2);
   v_card_sub_code       char(2);
   v_card_name           varchar(30);
   v_max_day             int;
   v_ii                  int;
   v_sql                varchar2(2048);
begin
    v_balance_year:=substr(in_balance_day,1,4);
    v_card_main_code:=in_card_main_id;
    v_card_sub_code:=in_card_sub_id;
    v_squad_year:=substr(in_squad_day,1,4);
 if v_card_sub_code||v_card_sub_code is not null and v_card_sub_code!=' ' and v_card_sub_code!=' ' then
  select card_sub_name into v_card_name
  from op_prm_card_sub
     where card_main_id=v_card_main_code
     and card_sub_id=v_card_sub_code
     and record_flag='0';
 end if;
--≤È—Ø ˝æ›
     insert into t#op_PFL_CHANGE_rpt
     (change_in_line,change_out_line,num,squad_day,card_main_code,card_sub_code)
                select change_line_in,change_line_out,sum(num),squad_day,card_main_id,card_sub_id
                from st_sts_flw_change a
                   where  balance_water_no>=v_balance_year||'010100' and balance_water_no<=v_balance_year||'123199' and substr(squad_day,1,4)=v_squad_year
                and card_main_id=v_card_main_code and  card_sub_id=v_card_sub_code
                 group by change_line_in,change_line_out,squad_day,card_main_id,card_sub_id;
--20160621 zy ‘ˆº”≤È—Ø¿˙ ∑±Ì ˝æ›
begin
  declare
    cursor index_table is
    select table_name    temp_table_name
      from acc_st.st_idx_rpt_history t
    where origin_table_name = 'acc_st.st_sts_flw_change'
       and min_squad_day <= v_squad_year ||'1231'
       and max_squad_day >= v_squad_year||'0101'
       order by table_name desc;

  begin
    for t_cur in index_table loop

      v_sql := 'INSERT INTO t#op_PFL_CHANGE_rpt ' ||
      ' (change_in_line,change_out_line,num,squad_day,card_main_code,card_sub_code) ' ||
            ' SELECT change_line_in,change_line_out,sum(num),squad_day,card_main_id,card_sub_id ' ||
            ' from acc_st.' || t_cur.temp_table_name ||  '  b ' ||
            ' where b.balance_water_no >= ''' || v_balance_year || '010100''' ||
            ' and b.balance_water_no <= ''' || v_balance_year || '123199''' ||
            ' and substr(squad_day,1,4) = ''' || v_squad_year || '''' ||
            ' and b.card_main_id = ''' || v_card_main_code || '''' ||
            ' and b.card_sub_id = ''' || v_card_sub_code || '''' ||
            ' group by change_line_in,change_line_out,squad_day,card_main_id,card_sub_id';

      execute immediate v_sql;

    end loop;

  end;
  end;
       ------------------------ ªª»Î1œﬂ
    INSERT INTO t#op_PFL_CHANGE_result
    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='02' and change_out_line='01'
            group by squad_day,change_out_line,change_in_line;
    INSERT INTO t#op_PFL_CHANGE_result
    (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='03' and change_out_line='01'
            group by squad_day,change_out_line,change_in_line;
      INSERT INTO t#op_PFL_CHANGE_result
      (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'“ª∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='04' and change_out_line='01'
            group by squad_day,change_out_line,change_in_line;
       ------------------------ 2œﬂ
      INSERT INTO t#op_PFL_CHANGE_result
      (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='01' and change_out_line='02'
            group by squad_day,change_out_line,change_in_line;
  INSERT INTO t#op_PFL_CHANGE_result
  (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='03' and change_out_line='02'
            group by squad_day,change_out_line,change_in_line;
  INSERT INTO t#op_PFL_CHANGE_result
  (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'∂˛∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='04' and change_out_line='02'
            group by squad_day,change_out_line,change_in_line;
     ------------------------ 3œﬂ
  INSERT INTO t#op_PFL_CHANGE_result
  (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='01' and change_out_line='03'
            group by squad_day,change_out_line,change_in_line;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='02' and change_out_line='03'
            group by squad_day,change_out_line,change_in_line;
             INSERT INTO t#op_PFL_CHANGE_result
             (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'»˝∫≈œﬂ','¡⁄œﬂªª≥À÷¡Àƒ∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='04' and change_out_line='03'
            group by squad_day,change_out_line,change_in_line;
      ------------------------ 4œﬂ
  INSERT INTO t#op_PFL_CHANGE_result
  (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡“ª∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='01' and change_out_line='04'
            group by squad_day,change_out_line,change_in_line;
              INSERT INTO t#op_PFL_CHANGE_result
              (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡∂˛∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='02' and change_out_line='04'
            group by squad_day,change_out_line,change_in_line;
              INSERT INTO t#op_PFL_CHANGE_result
              (day,change_out,change_in,change_out_name,change_in_name,num)
          SELECT squad_day,change_out_line,change_in_line,'Àƒ∫≈œﬂ','¡⁄œﬂªª≥À÷¡»˝∫≈œﬂøÕ¡˜',sum(nvl(num,0))
            FROM t#op_PFL_CHANGE_rpt
            where change_in_line='03' and change_out_line='04'
            group by squad_day,change_out_line,change_in_line;
    --À˘”–œﬂ¬∑
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','“ª∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='01'
     group by day,change_in;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','∂˛∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='02'
     group by day,change_in;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','»˝∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='03'
     group by day,change_in;
   INSERT INTO t#op_PFL_CHANGE_result
   (day,change_out,change_in,change_out_name,change_in_name,num)
     SELECT day,change_in,'','Àƒ∫≈œﬂ','À˘”–œﬂ¬∑ªª»ÎøÕ¡˜',sum(num)
     FROM t#op_PFL_CHANGE_result
     where change_in='04'
     group by day,change_in;
/*--∏¸–¬œﬂ¬∑–Ú∫≈
update t#op_PFL_CHANGE_result a
set a.change_in=(select b.sequence
from ic_cod_line_code b
where a.change_in=b.line_id and b.record_flag='0');
update t#op_PFL_CHANGE_result a
set a.change_out=(select b.sequence
from ic_cod_line_code b
where a.change_out=b.line_id and b.record_flag='0');
*/
open out_cursor for
select  v_card_name cardname,v_squad_year||v_balance_year as year,day,change_in||change_in_name as changein,change_out||change_out_name as changeout,sum(num) as num
from t#op_PFL_CHANGE_result
group by day,change_in,change_out,change_in_name,change_in,change_out_name
order by day,change_in,change_out,change_in_name,change_out_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_CHANGE_YEAR to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_CHANGE_YEAR to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_LINE_INOUT_DAY
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_LINE_INOUT_DAY (
--π˝≥Ã√˚£∫  UP_OP_PFL_line_inout_DAY
--∂‘”¶ƒ£∞Â£∫rpt_01_005
--π¶ƒ‹√Ë ˆ£∫œﬂ¬∑Ω¯≥ˆ’æøÕ¡˜∑÷Œˆ»’±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130822
-------------------------------------------------------------------------------
--–ﬁ∏ƒ’ﬂ£∫ ldz
--–ﬁ∏ƒ»’∆⁄£∫20160817
--–ﬁ∏ƒƒ⁄»›£∫≤È—ØΩ·π˚‘ˆº”nvl
--modify by ldz 2016.12.26:–ﬁ∏ƒ24 ±section_no='00';
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_line_no            char(2);
   v_squad_date         char(8);
   v_balance_date       char(8);
   v_line_name varchar(20);
   begin
    v_squad_date:=in_squad_day;
    v_balance_date:=in_balance_day;
    v_line_no:=in_line_id;
if v_line_no!=' ' and v_line_no is not null then
    select line_name into v_line_name from op_prm_line where line_id=v_line_no and record_flag = '0';
end if;
  /*--≤Â»Î∆±ø®¿‡–Õ
    insert into t#OP_line_inout_card(ic_main_code,ic_sub_code,ic_sub_desc)
         select card_main_id,card_sub_id,card_sub_name
  from op_prm_card_sub where record_flag='0'
   and card_main_id in('01','02','03','04');
    insert into t#OP_line_inout_card values ('06','00','≥« –Õ®∆±');*/

----Ω·π˚ºØøÚº‹
INSERT INTO T#OP_line_inout_result
  SELECT
    v_line_no,
    card_main_id,
    case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,
    '','',0,0,0, 0, 0,0,0,0,0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0
  from op_prm_card_sub
  where card_main_id !='05' and record_flag='0';
    --≤È—Ø ˝æ›
     INSERT INTO T#OP_line_inout_rpt
     (squad_day,line_id,card_main_code,card_sub_code,entry_num,export_num,section_no)
            SELECT squad_day,line_id,card_main_id,case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,sum(entry_num),sum(export_num),time_section_id
            from st_sts_flw_station b
            where b.line_id =v_line_no
            AND b.squad_day = v_squad_date
            and balance_water_no>=v_balance_date||'00'
            and balance_water_no<=v_balance_date||'99'
      group by line_id,card_main_id,card_sub_id,squad_day,time_section_id;
--------------------≤Â»ÎΩ·π˚ºØ--------------------
        --∏¸–¬Ω·π˚ºØ 4 ±
        insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='04';
        --∏¸–¬Ω·π˚ºØ 5 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='05';
        --∏¸–¬Ω·π˚ºØ 6 ±
        insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='06';
        --∏¸–¬Ω·π˚ºØ 7 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='07';
        --∏¸–¬Ω·π˚ºØ 8 ±
        insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='08';
        --∏¸–¬Ω·π˚ºØ 9 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='09';
        --∏¸–¬Ω·π˚ºØ 10 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='10';
        --∏¸–¬Ω·π˚ºØ 11 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='11';
        --∏¸–¬Ω·π˚ºØ 12 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='12';
        --∏¸–¬Ω·π˚ºØ 13 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='13';
        --∏¸–¬Ω·π˚ºØ 14 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='14';
        --∏¸–¬Ω·π˚ºØ 15 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='15';
        --∏¸–¬Ω·π˚ºØ16 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      AND section_no='16';
        --∏¸–¬Ω·π˚ºØ 17 ±
      insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='17';
        --∏¸–¬Ω·π˚ºØ 18 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='18';
        --∏¸–¬Ω·π˚ºØ 19 ±
      insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='19';
        --∏¸–¬Ω·π˚ºØ 20 ±
      insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='20';
        --∏¸–¬Ω·π˚ºØ 21 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='21';
        --∏¸–¬Ω·π˚ºØ 22 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='22';
        --∏¸–¬Ω·π˚ºØ 23 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='23';
        --∏¸–¬Ω·π˚ºØ 24 ±
      insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='00';
        --∏¸–¬Ω·π˚ºØ 1 ±
       insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='01';
        --∏¸–¬Ω·π˚ºØ 2 ±
     insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='02';
        --∏¸–¬Ω·π˚ºØ 3 ±
  insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,card_main_code,card_sub_code,nvl(entry_num,0),nvl(export_num,0)
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
            AND section_no='03';
         --∏¸–¬Ω·π˚ºØ Œ≤¡–∫œº∆
           insert into T#OP_line_inout_result
 (line_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,card_main_code,card_sub_code,sum(nvl(entry_num,0)),sum(nvl(export_num,0))
    from  T#OP_line_inout_rpt B
    WHERE card_main_code = B.card_main_code
      AND card_sub_code = B.card_sub_code
      group by line_id,card_main_code,card_sub_code;
         --∏¸–¬∆±ø®√˚≥∆
  update T#OP_line_inout_result A
      set a.card_sub_desc=(
         select b.card_sub_name from op_prm_card_sub B
         where a.card_main_code=b.card_main_id and a.card_sub_code=b.card_sub_id and b.record_flag='0')
      where EXISTS (select 1 from op_prm_card_sub B
         where a.card_main_code=b.card_main_id and a.card_sub_code=b.card_sub_id and b.record_flag='0');
  update T#OP_line_inout_result A
      set a.card_sub_desc='≥« –Õ®∆±' where a.card_main_code='06';
         -----------------------------------------
         ---- ƒ©–– ∞¥ ±∂Œ◊‹º∆‘⁄ÀÆæß±®±Ì…Ë÷√-------
         -----------------------------------------
         -- ∑µªÿΩ·π˚
         open out_cursor for
     --modify by ldz 20160817 ‘ˆº”nvl
     SELECT v_line_name line_name,v_squad_date||v_balance_date squad_day,line_code line_code, card_main_code||card_sub_code||card_sub_desc as card_name,
sum(nvl(entry_num0,0)) entry_num0,sum(nvl(export_num0,0)) export_num0,
sum(nvl(entry_num1,0)) entry_num1,sum(nvl(export_num1,0)) export_num1,
sum(nvl(entry_num2,0)) entry_num2,sum(nvl(export_num2,0)) export_num2,
sum(nvl(entry_num3,0)) entry_num3,sum(nvl(export_num3,0)) export_num3,
sum(nvl(entry_num4,0)) entry_num4,sum(nvl(export_num4,0)) export_num4,
sum(nvl(entry_num5,0)) entry_num5,sum(nvl(export_num5,0)) export_num5,
sum(nvl(entry_num6,0)) entry_num6,sum(nvl(export_num6,0)) export_num6,
sum(nvl(entry_num7,0)) entry_num7,sum(nvl(export_num7,0)) export_num7,
sum(nvl(entry_num8,0)) entry_num8,sum(nvl(export_num8,0)) export_num8,
sum(nvl(entry_num9,0)) entry_num9,sum(nvl(export_num9,0)) export_num9,
sum(nvl(entry_num10,0)) entry_num10,sum(nvl(export_num10,0)) export_num10,
sum(nvl(entry_num11,0)) entry_num11,sum(nvl(export_num11,0)) export_num11,
sum(nvl(entry_num12,0)) entry_num12,sum(nvl(export_num12,0)) export_num12,
sum(nvl(entry_num13,0)) entry_num13,sum(nvl(export_num13,0)) export_num13,
sum(nvl(entry_num14,0)) entry_num14,sum(nvl(export_num14,0)) export_num14,
sum(nvl(entry_num15,0)) entry_num15,sum(nvl(export_num15,0)) export_num15,
sum(nvl(entry_num16,0)) entry_num16,sum(nvl(export_num16,0)) export_num16,
sum(nvl(entry_num17,0)) entry_num17,sum(nvl(export_num17,0)) export_num17,
sum(nvl(entry_num18,0)) entry_num18,sum(nvl(export_num18,0)) export_num18,
sum(nvl(entry_num19,0)) entry_num19,sum(nvl(export_num19,0)) export_num19,
sum(nvl(entry_num20,0)) entry_num20,sum(nvl(export_num20,0)) export_num20,
sum(nvl(entry_num21,0)) entry_num21,sum(nvl(export_num21,0)) export_num21,
sum(nvl(entry_num22,0)) entry_num22,sum(nvl(export_num22,0)) export_num22,
sum(nvl(entry_num23,0)) entry_num23,sum(nvl(export_num23,0)) export_num23,
sum(nvl(total_entry_num,0)) total_entry_num,sum(nvl(total_export_num,0)) total_export_num
        FROM T#OP_line_inout_result
        group by line_code,card_main_code,card_sub_code,card_sub_desc
    ORDER BY line_code,card_main_code,card_sub_code,card_sub_desc;
end;
/
grant execute on ACC_ST.UP_OP_PFL_LINE_INOUT_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_LINE_INOUT_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_LINE_PASS_MON
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_LINE_PASS_MON (
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  rpt_01_013
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--ªª≥ÀøÕ¡˜æ∂¬∑∑÷Œˆ±Ì(‘¬±®±Ì ∞¥∆±ø®Õ≥º∆)
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130827
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_balance_month       char(6);       --«ÂÀ„‘¬
   v_squad_month         char(6);       -- ‘À”™‘¬
   v_card_main_code      char(2);
   v_card_sub_code       char(2);
   v_card_name       varchar(30);
   v_day                 int;
begin
v_balance_month:=substr(in_balance_day,1,6);
v_squad_month:=substr(in_squad_day,1,6);
v_card_main_code:=in_card_main_id;
v_card_sub_code:=in_card_sub_id;
v_day:=1;
if v_card_sub_code||v_card_sub_code is not null and v_card_sub_code!=' ' and v_card_sub_code!=' ' then
  select card_sub_name into v_card_name
  from op_prm_card_sub
     where card_main_id=v_card_main_code
     and card_sub_id=v_card_sub_code
     and record_flag='0';
 end if;
 ----»°≥ˆ‘≠ º ˝æ›
  insert into t#OP_PFL_LINE_PASS_rpt
  (begin_line,pass_line,num,squad_day,balance_water_no,card_main_code,card_sub_code)
  select b_line_id,p_line_id,sum(num),squad_day,balance_water_no,card_main_id,card_sub_id
  from st_sts_flw_line_pass
  where  balance_water_no>=v_balance_month||'0100'
  and balance_water_no<=v_balance_month||'3199'
  and card_main_id=v_card_main_code and card_sub_id=v_card_sub_code
  and substr(squad_day,1,6)=v_squad_month
  and b_line_id!=p_line_id
  group by  b_line_id,p_line_id,squad_day,balance_water_no,card_main_id,card_sub_id;
 ----------------------------------------------------------------------------------------
----ππΩ®Ω·π˚ºØΩ·ππ
while v_day<=30
      loop
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'02','01','∂˛∫≈œﬂ','“ª∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'03','01','»˝∫≈œﬂ','“ª∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'04','01','Àƒ∫≈œﬂ','“ª∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'01','02','“ª∫≈œﬂ','∂˛∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'03','02','»˝∫≈œﬂ','∂˛∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'04','02','Àƒ∫≈œﬂ','∂˛∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'01','03','“ª∫≈œﬂ','»˝∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'02','03','∂˛∫≈œﬂ','»˝∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'04','03','Àƒ∫≈œﬂ','»˝∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'01','04','“ª∫≈œﬂ','Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'02','04','∂˛∫≈œﬂ','Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'03','04','»˝∫≈œﬂ','Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'01','99','“ª∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'02','99','∂˛∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'03','99','»˝∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',0);
  insert into t#OP_PFL_LINE_PASS_result    (day,pass_id,begin_id,pass_name,begin_name,num)
  values (v_day,'04','99','Àƒ∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',0);
  v_day:=v_day+1;
  end loop;
  ----------------------------------------------------------------------------------------
--“ª∫≈œﬂΩ¯’ææ≠π˝µƒ¬∑œﬂ
insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'∂˛∫≈œﬂ','“ª∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='01' and pass_line='02'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'»˝∫≈œﬂ','“ª∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='01' and pass_line='03'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'Àƒ∫≈œﬂ','“ª∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='01' and pass_line='04'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
--∂˛∫≈œﬂΩ¯’ææ≠π˝µƒ¬∑œﬂ
 INSERT INTO t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'“ª∫≈œﬂ','∂˛∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='02' and pass_line='01'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'»˝∫≈œﬂ','∂˛∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='02' and pass_line='03'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
  insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'Àƒ∫≈œﬂ','∂˛∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='02' and pass_line='04'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
--»˝∫≈œﬂΩ¯’ææ≠π˝µƒ¬∑œﬂ
 INSERT INTO t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'“ª∫≈œﬂ','»˝∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='03' and pass_line='01'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'∂˛∫≈œﬂ','»˝∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='03' and pass_line='02'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'Àƒ∫≈œﬂ','»˝∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='03' and pass_line='04'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
--Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒ¬∑œﬂ
 INSERT INTO t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'“ª∫≈œﬂ','Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='04' and pass_line='01'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'∂˛∫≈œﬂ','Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='04' and pass_line='02'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
 insert into t#OP_PFL_LINE_PASS_result
          SELECT to_number(substr(squad_day,7,2),'99'),pass_line,begin_line,'»˝∫≈œﬂ','Àƒ∫≈œﬂΩ¯’ææ≠π˝µƒœﬂ¬∑',sum(nvl(num,0))
            FROM t#OP_PFL_LINE_PASS_rpt
            where begin_line='04' and pass_line='03'
            group by to_number(substr(squad_day,7,2),'99'),begin_line,pass_line;
--À˘”–œﬂ¬∑
   INSERT INTO t#OP_PFL_LINE_PASS_result
     SELECT to_number(substr(squad_day,7,2),'99'),pass_line,'99','“ª∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',sum(num)
     FROM t#OP_PFL_LINE_PASS_rpt
     where pass_line='01'
     group by to_number(substr(squad_day,7,2),'99'),pass_line;
        INSERT INTO t#OP_PFL_LINE_PASS_result
     SELECT to_number(substr(squad_day,7,2),'99'),pass_line,'99','∂˛∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',sum(num)
     FROM t#OP_PFL_LINE_PASS_rpt
     where pass_line='02'
     group by to_number(substr(squad_day,7,2),'99'),pass_line;
        INSERT INTO t#OP_PFL_LINE_PASS_result
     SELECT to_number(substr(squad_day,7,2),'99'),pass_line,'99','»˝∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',sum(num)
     FROM t#OP_PFL_LINE_PASS_rpt
     where pass_line='03'
     group by to_number(substr(squad_day,7,2),'99'),pass_line;
        INSERT INTO t#OP_PFL_LINE_PASS_result
     SELECT to_number(substr(squad_day,7,2),'99'),pass_line,'99','Àƒ∫≈œﬂ','À˘”–œﬂ¬∑Ω¯’ææ≠π˝µƒœﬂ¬∑',sum(num)
     FROM t#OP_PFL_LINE_PASS_rpt
     where pass_line='04'
     group by to_number(substr(squad_day,7,2),'99'),pass_line;
open out_cursor for
  select  v_card_name cardname,v_squad_month||v_balance_month as month,day,
  begin_id||begin_name as beginname,pass_id||pass_name as passname,sum(num) as num
  from t#OP_PFL_LINE_PASS_result
  group by day, begin_id,begin_name,pass_id,pass_name
  order by day, begin_id,begin_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_LINE_PASS_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_LINE_PASS_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_LINE_TK_MON
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_LINE_TK_MON (
---------------------------------------------------------------------------------
--∂‘”¶ƒ£∞Â£∫rpt_01_003
--π¶ƒ‹√Ë ˆ:œﬂ¬∑∆±÷÷øÕ¡˜∑÷Œˆ‘¬±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130820
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_line_id        char(2);
   v_station_id     char(2);
   v_squad_month    char(6);--‘À”™‘¬
   v_card_main_code char(2);
   v_card_sub_code  char(2);
   v_line_name      varchar(50);
   v_card_name      varchar(50);
   v_balance_month  char(6);--«ÂÀ„‘¬
   v_day            int;
BEGIN
   v_balance_month:=substr(in_balance_day,1,6);
   v_squad_month:=substr(in_squad_day,1,6);
   v_card_main_code:=in_card_main_id;
   v_card_sub_code:=in_card_sub_id;
   v_line_id:=in_line_id;
   v_station_id:=in_station_id;
   v_day:=1;
if v_line_id!=' ' and v_line_id is not null then
   select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
end if;
if v_card_main_code!=' ' and v_card_sub_code!=' ' and v_card_main_code||v_card_sub_code is not null then
   select card_sub_name into v_card_name from op_prm_card_sub a where a.card_main_id=v_card_main_code and a.card_sub_id=v_card_sub_code and a.record_flag='0';
end if;
    insert into t#OP_line_tk_rpt1
    (line_id,station_id,chinese_name,belong_line_id,sequence)
select line_id,station_id,chinese_name,belong_line_id,sequence
from op_prm_station
 where record_flag = '0';
 --≤È—Ø ˝æ›
 insert into t#OP_line_tk_rpt2
 (balance_water_no,line_id,station_id,card_main_code,card_sub_code,squad_day,entry_num,export_num)
 select  balance_water_no,line_id,nvl(station_id,0),card_main_id,card_sub_id,squad_day,entry_num,export_num
 from st_sts_flw_line_card
 where balance_water_no<=v_balance_month||'3199'
 and balance_water_no>=v_balance_month||'0100'
 and squad_day<=v_squad_month||'31'
 and squad_day>=v_squad_month||'01'
 and card_main_id=v_card_main_code
 and card_sub_id=v_card_sub_code
 and line_id=v_line_id;
 --------------------------------------------------------------------------------------
 -----ππΩ®Ω·π˚ºØΩ·ππ
while v_day<=30
  loop
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select lpad(v_day,2,'0'),a.line_id,a.station_id,v_card_main_code,v_card_sub_code,0,0
  from op_prm_station a
  where a.record_flag=0 and a.line_id=v_line_id;
  v_day:=v_day+1;
  end loop;
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '10-01…œ—Æ–°º∆',a.line_id,a.station_id,v_card_main_code,v_card_sub_code,0,0
  from op_prm_station a
  where a.record_flag=0 and a.line_id=v_line_id;
     insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '20-11÷–—Æ–°º∆',a.line_id,a.station_id,v_card_main_code,v_card_sub_code,0,0
  from op_prm_station a
  where a.record_flag=0 and a.line_id=v_line_id;
     insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '31-21œ¬—Æ–°º∆',a.line_id,a.station_id,v_card_main_code,v_card_sub_code,0,0
  from op_prm_station a
  where a.record_flag=0 and a.line_id=v_line_id;
  insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '∫œº∆',a.line_id,a.station_id,v_card_main_code,v_card_sub_code,0,0
  from op_prm_station a
  where a.record_flag=0 and a.line_id=v_line_id;
  ---------------------------------------------------------------------------------------
 --œÚ¡Ÿ ±Ω·π˚±Ì≤Â»Î ˝æ›
  insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select substr(squad_day,7,2),a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id and a.station_id=b.station_id
  group by substr(squad_day,7,2),a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
 -------------------------------------------------…œ—Æ –°º∆
 insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '10-01…œ—Æ–°º∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,7,2)<=10
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
   ------------------------------------------------÷–—Æ  –°º∆
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '20-11÷–—Æ–°º∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,7,2)<=20 and substr(a.squad_day,7,2)>=11
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
    ------------------------------------------------œ¬—Æ –°º∆
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select '31-21œ¬—Æ–°º∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,7,2)<=31 and substr(a.squad_day,7,2)>=21
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
  -----------------------------------------------∞¥’æµ„ ‘¬∫œº∆
     insert into  t#OP_line_tk_result
     (day,line_id,station_id,station_name,card_main_code,card_sub_code,entry_num,export_num)
   select '∫œº∆',a.line_id,a.station_id,'',a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
   from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
  ----------Œ≤¡–∫œº∆ ∫Õ ◊‹∫œº∆ ‘⁄ÀÆæß±®±Ìº∆À„
  ----∏¸–¬’æµ„√˚≥∆
update t#OP_line_tk_result a set station_name=(
  select sequence||chinese_name from op_prm_station c
    where a.line_id=c.line_id
      and a.station_id=c.station_id
      and c.record_flag='0')
where EXISTS (select 1 from op_prm_station c
    where a.line_id=c.line_id
      and a.station_id=c.station_id
      and c.record_flag='0');
open out_cursor for
  select v_squad_month||v_balance_month mon,day,v_line_name line_name,v_card_name cardname,station_name stationname,sum(entry_num) as entry_num
  from t#OP_line_tk_result
  group by day,station_name
  order by day,station_name;
 end;
/
grant execute on ACC_ST.UP_OP_PFL_LINE_TK_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_LINE_TK_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_LINE_TK_YEAR
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_LINE_TK_YEAR (
---------------------------------------------------------------------------------
--∂‘”¶ƒ£∞Â£∫rpt_01_004
--π¶ƒ‹√Ë ˆ:œﬂ¬∑∆±÷÷øÕ¡˜∑÷ŒˆƒÍ±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  Õıø…º—
--¥¥Ω®»’∆⁄£∫20130820
-------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
aS
   v_line_id        char(2);
   v_station_id     char(2);
   v_squad_month    char(4);--‘À”™‘¬
   v_card_main_code char(2);
   v_card_sub_code  char(2);
   v_line_name      varchar(50);
   v_card_name      varchar(50);
   v_balance_month  char(4);--«ÂÀ„‘¬
   v_table_name varchar(30);
v_sql varchar(500);
v_where varchar(200);
v_year_begin varchar(100);
v_year_end varchar(100);
v_mon_begin varchar(100);
v_mon_end varchar(100);
v_count int;
   BEGIN
   v_balance_month:=substr(in_balance_day,1,4);
   v_squad_month:=substr(in_squad_day,1,4);
   v_card_main_code:=in_card_main_id;
   v_card_sub_code:=in_card_sub_id;
   v_line_id:=in_line_id;
   v_station_id:=in_station_id;
  v_table_name:='';
  v_count:=0;
  v_where:=' where ';
  v_year_begin:=v_squad_month||'0101';
  v_year_end:=v_squad_month||'1231';

   
if v_line_id!=' ' and v_line_id is not null then
   select line_name into v_line_name from op_prm_line where line_id=v_line_id and record_flag='0';
end if;
if v_card_main_code!=' ' and v_card_sub_code!=' ' and v_card_main_code||v_card_sub_code is not null then
   select card_sub_name into v_card_name from op_prm_card_sub a where a.card_main_id=v_card_main_code and a.card_sub_id=v_card_sub_code and a.record_flag='0';
end if;
    insert into t#OP_line_tk_rpt1
    (line_id,station_id,chinese_name,belong_line_id,sequence)
select line_id,station_id,chinese_name,belong_line_id,sequence
from op_prm_station
 where record_flag = '0' and station_id!='00';
 /*   insert into t#OP_line_tk_rpt1(
     line_id,station_id,belong_line_id,sequence,chinese_name)
     values ('99','99','99','99','∫œº∆');
 */
 --≤È—Ø ˝æ›
 insert into t#OP_line_tk_rpt2
 (balance_water_no,line_id,station_id,card_main_code,card_sub_code,squad_day,entry_num,export_num)
 select  balance_water_no,line_id,nvl(station_id,0),card_main_id,card_sub_id,squad_day,entry_num,export_num
 from st_sts_flw_line_card
 where balance_water_no<=v_balance_month||'123199'
 and balance_water_no>=v_balance_month||'010100'
 and squad_day<=v_squad_month||'1231'
 and squad_day>=v_squad_month||'0101'
 and card_main_id=v_card_main_code
 and card_sub_id=v_card_sub_code
 and line_id=v_line_id;
 
 ---------------¥”À˜“˝±Ì»°∑÷±Ì ˝æ›£®¥”∑÷±Ì»° ˝æ›£©

select count(*) into v_count from st_idx_rpt_history a
  where a.origin_table_name='acc_st.st_sts_flw_line_card'
       and a.min_squad_day>=v_year_begin and nvl(a.max_squad_day,v_year_end)<=v_year_end;
----À˜“˝±Ì”–µ±«∞÷–º‰±Ìµƒ∑÷±Ì£¨æÕ¥”∑÷±Ì»° ˝æ›     
if v_count>0 then

declare 
      cursor v_cursor is
  select a.table_name from st_idx_rpt_history a
       where a.origin_table_name='acc_st.st_sts_flw_line_card'
       and a.min_squad_day>=v_year_begin and nvl(a.max_squad_day,v_year_end)<=v_year_end;
       
 begin
   open v_cursor;
   fetch v_cursor into v_table_name; 
     v_sql:='insert into t#OP_line_tk_rpt2
 (balance_water_no,line_id,station_id,card_main_code,card_sub_code,squad_day,entry_num,export_num)
 select  balance_water_no,line_id,nvl(station_id,0),card_main_id,card_sub_id,squad_day,entry_num,export_num
 from ';
          
    v_sql:=v_sql||v_table_name||' b';

    v_sql:=v_sql||v_where||' substr(b.balance_water_no,1,4)='||v_balance_month
            ||' and substr(b.squad_day,1,4)='||v_squad_month
            ||' and card_main_id||card_sub_id='||v_card_main_code||v_card_sub_code
            ||' and line_id='||v_line_id;

    Execute Immediate v_sql;
   close v_cursor;
 end;
 
end if;
 
 
  -----ππΩ®Ω·π˚ºØΩ·ππ
 insert into t#OP_line_tk_result
  (day,line_id,station_id,entry_num,export_num)
 select v_squad_month||'0331“ªºæ∂»∫œº∆',a.line_id,a.station_id,0,0
  from op_prm_station a
  where a.line_id=v_line_id  and a.record_flag='0';
   insert into t#OP_line_tk_result
  (day,line_id,station_id,entry_num,export_num)
 select v_squad_month||'0630∂˛ºæ∂»∫œº∆',a.line_id,a.station_id,0,0
  from op_prm_station a
  where a.line_id=v_line_id and a.record_flag='0';
   insert into t#OP_line_tk_result
  (day,line_id,station_id,entry_num,export_num)
 select v_squad_month||'0930»˝ºæ∂»∫œº∆',a.line_id,a.station_id,0,0
  from op_prm_station a
  where a.line_id=v_line_id and a.record_flag='0';
     insert into t#OP_line_tk_result
  (day,line_id,station_id,entry_num,export_num)
 select v_squad_month||'1231Àƒºæ∂»∫œº∆',a.line_id,a.station_id,0,0
  from op_prm_station a
  where a.line_id=v_line_id and a.record_flag='0';
 --œÚ¡Ÿ ±Ω·π˚±Ì≤Â»Î ˝æ›
  insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select squad_day,a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id and a.station_id=b.station_id
  group by squad_day,a.line_id,a.station_id,a.card_main_code,a.card_sub_code
  order by squad_day,a.station_id;
 -------------------------------------------------“ªºæ∂»∫œº∆
 insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select v_squad_month||'0331“ªºæ∂»∫œº∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,1,8)<=v_squad_month||'0331'
  and substr(a.squad_day,1,8)>=v_squad_month||'0101'
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
   ------------------------------------------------∂˛ºæ∂»∫œº∆
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select v_squad_month||'0630∂˛ºæ∂»∫œº∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,1,8)<=v_squad_month||'0631'
  and substr(a.squad_day,1,8)>=v_squad_month||'0401'
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
    ------------------------------------------------»˝ºæ∂»∫œº∆
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select v_squad_month||'0930»˝ºæ∂»∫œº∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,1,8)<=v_squad_month||'0931'
  and substr(a.squad_day,1,8)>=v_squad_month||'0701'
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
      ------------------------------------------------Àƒºæ∂»∫œº∆
   insert into t#OP_line_tk_result
  (day,line_id,station_id,card_main_code,card_sub_code,entry_num,export_num)
 select v_squad_month||'1231Àƒºæ∂»∫œº∆',a.line_id,a.station_id,a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
  from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  and substr(a.squad_day,1,8)<=v_squad_month||'1231'
  and substr(a.squad_day,1,8)>=v_squad_month||'1001'
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
  -----------------------------------------------∞¥’æµ„ ƒÍ∫œº∆
     insert into  t#OP_line_tk_result
     (day,line_id,station_id,station_name,card_main_code,card_sub_code,entry_num,export_num)
   select '◊‹º∆',a.line_id,a.station_id,'',a.card_main_code,a.card_sub_code,sum(a.entry_num),sum(a.export_num)
   from t#OP_line_tk_rpt2 a,t#OP_line_tk_rpt1 b
  where a.line_id=b.line_id
  and a.station_id=b.station_id
  group by a.line_id,a.station_id,a.card_main_code,a.card_sub_code;
  ----------Œ≤¡–∫œº∆ ∫Õ ◊‹∫œº∆ ‘⁄ÀÆæß±®±Ìº∆À„
  ----∏¸–¬’æµ„√˚≥∆
  update t#OP_line_tk_result a
  set station_name=(
  select sequence||chinese_name from op_prm_station c
  where a.line_id=c.line_id
  and a.station_id=c.station_id
  and c.record_flag='0')
  where line_id!='99';
  open out_cursor for
  select v_squad_month||v_balance_month mon,day,v_line_name line_name,v_card_name cardname,station_name stationname,entry_num
  from t#OP_line_tk_result
  order by day,station_name;
 end;
/
grant execute on ACC_ST.UP_OP_PFL_LINE_TK_YEAR to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_LINE_TK_YEAR to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_REALFLOW_SECTION
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_REALFLOW_SECTION (
in_line_id char,
in_station_id char,
in_card_main_id char,
in_card_sub_id char,
in_squad_day char,
in_balance_day char,
out_cursor  OUT sys_refcursor)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_OP_PFL_REALFLOW_SECTION
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--øÕ¡˜±®±Ì£∫∂œ√ÊøÕ¡˜»’±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫ Õıø…º—
--¥¥Ω®»’∆⁄£∫20131017
--∂‘”¶ƒ£∞Â£∫rpt_01_014
-------------------------------------------------------------------------------
--ÃÌº”œﬂ¬∑Ãıº˛≤È—Ø£∫20160318  by lindaquan

AS
v_balance_day char(8);
v_squad_day char(8);
v_hour char(2);
v_type_name varchar2(50);

   BEGIN
   v_balance_day:=substr(in_balance_day,1,8);
   v_squad_day:=substr(in_squad_day,1,8);
   v_hour:='00';
   select distinct description into v_type_name from acc_st.op_cod_line_type where type_id= in_line_id;
   
insert into t#op_realflow_section
(time_section,direction_flag,line_id,b_station_id,e_station_id,num)
             select time_section,change_line_out_dir,line_id,b_station_id,e_station_id,sum(num)
             from st_sts_realflow_section
             where  substr(balance_water_no,1,8)=v_balance_day
                  and squad_day=v_squad_day
                  and line_id in (select line_id from acc_st.op_cod_line_type where type_id= in_line_id)
group by time_section,change_line_out_dir,line_id,b_station_id,e_station_id;
----0 ±
v_hour:='02';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num0)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----1 ±
v_hour:='03';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num1)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----2 ±
v_hour:='04';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num2)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----3 ±
v_hour:='05';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num3)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----4 ±
v_hour:='06';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num4)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----5 ±
v_hour:='07';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num5)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----6 ±
v_hour:='08';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num6)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----7 ±
v_hour:='09';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num7)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
--8 ±
v_hour:='10';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num8)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----9 ±
v_hour:='11';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num9)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----10 ±
v_hour:='12';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num10)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----11 ±
v_hour:='13';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num11)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----12 ±
v_hour:='14';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num12)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----13 ±
v_hour:='15';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num13)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----14 ±
v_hour:='16';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num14)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----15 ±
v_hour:='17';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num15)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----16 ±
v_hour:='18';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num16)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----17 ±
v_hour:='19';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num17)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----18 ±
v_hour:='20';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num18)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----19 ±
v_hour:='21';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num19)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----20 ±
v_hour:='22';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num20)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----21 ±
v_hour:='23';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num21)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----22 ±
v_hour:='00';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num22)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----23
v_hour:='01';
insert into t#op_realflow_sec_result
(line_id,line_name,direction_flag,direction_name,direction_seq,b_station_id,
b_name,e_station_id,e_name,num23)
select a.line_id,'',a.direction_flag,'',a.direction_seq,a.b_station_id,'',a.e_station_id,'',a.num
from t#op_realflow_section a
where  a.time_section=v_hour;
----∏¸–¬œﬂ¬∑’æµ„÷–Œƒ√˚
update t#op_realflow_sec_result a set line_name=
(select b.line_name from op_prm_line b where a.line_id=b.line_id and b.record_flag='0');
update t#op_realflow_sec_result a set b_name=
(select b.chinese_name from op_prm_station b where a.line_id=b.line_id and a.b_station_id=b.station_id and b.record_flag='0');
update t#op_realflow_sec_result a set e_name=
(select b.chinese_name from op_prm_station b where a.line_id=b.line_id and a.e_station_id=b.station_id and b.record_flag='0');
update t#op_realflow_sec_result set direction_name='…œ––' where direction_flag='0';
update t#op_realflow_sec_result set direction_name='œ¬––' where direction_flag='1';
----∑µªÿΩ·π˚ºØ
open out_cursor for
    select v_type_name type_name,v_squad_day||v_balance_day as day,line_id, line_name, direction_flag, direction_name, direction_seq, b_line_id, b_station_id, b_name, e_line_id, e_station_id, e_name,
    sum(nvl(num0,0)) num0, sum(nvl(num1,0)) num1, sum(nvl(num2,0)) num2, sum(nvl(num3,0)) num3, sum(nvl(num4,0)) num4,
    sum(nvl(num5,0)) num5, sum(nvl(num6,0)) num6, sum(nvl(num7,0)) num7, sum(nvl(num8,0)) num8, sum(nvl(num9,0)) num9,
    sum(nvl(num10,0)) num10, sum(nvl(num11,0)) num11, sum(nvl(num12,0)) num12, sum(nvl(num13,0)) num13, sum(nvl(num14,0)) num14,
    sum(nvl(num15,0)) num15, sum(nvl(num16,0)) num16, sum(nvl(num17,0)) num17, sum(nvl(num18,0)) num18, sum(nvl(num19,0)) num19,
    sum(nvl(num20,0)) num20, sum(nvl(num21,0)) num21, sum(nvl(num22,0)) num22, sum(nvl(num23,0)) num23
     from t#op_realflow_sec_result
     group by line_id, line_name, direction_flag, direction_name, direction_seq, b_line_id, b_station_id, b_name, e_line_id, e_station_id, e_name
     order by line_id,direction_flag,direction_seq;
     end;
/
grant execute on ACC_ST.UP_OP_PFL_REALFLOW_SECTION to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_REALFLOW_SECTION to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_STATION_INOUT_DAY
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_STATION_INOUT_DAY (
--π˝≥Ã√˚£∫  UP_OP_PFL_LINE_inout_DAY
--π¶ƒ‹√Ë ˆ£∫≥µ’æΩ¯≥ˆ’æøÕ¡˜∑÷Œˆ»’±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130822
-------------------------------------------------------------------------------
--V1.3
--–ﬁ∏ƒƒ⁄»›£∫£®1£©ππΩ®Ω·π˚ºØ‘ˆº”°Æ07°Ø£¨°Æ08°Ø∆±÷÷
--          £®2£©≤È—ØΩ·π˚ºØ ±£¨‘ˆº”nvl∫Ø ˝
--wangkejia
--20150320

--modify by ldz 2016.12.26:–ﬁ∏ƒ24 ±section_no='00';
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--V1.4
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°”≈ª›∆±0901
--taidibao
--20170722
--------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_line_no            char(2);--œﬂ¬∑
   v_squad_date         char(8);--‘À”™»’
   v_balance_date       char(8);--«ÂÀ„»’
   v_line_name varchar(50);
   begin
    v_squad_date:=substr(in_squad_day,1,8);
    v_balance_date:=substr(in_balance_day,1,8);
    v_line_no:=in_line_id;
if v_line_no!=' ' and v_line_no is not null then
    select line_name into v_line_name from op_prm_line
    where line_id=v_line_no and record_flag = '0';
 end if;
 --∆±ø®¿‡–Õ
    insert into t#OP_STATION_inout_card(ic_main_code,ic_sub_code,ic_sub_desc)
    select card_main_id,card_sub_id,card_sub_name
    from op_prm_card_sub
    where card_main_id in('01','02','03','04','07','08','09')--20150320 --modify by tdb 20170722
    and record_flag='0';
    insert into t#OP_STATION_inout_card
    values ('06','00','≥« –Õ®∆±');
    insert into t#OP_STATION_inout_card
    values ('99','99','±æ’æ–°º∆');
  --’æµ„
    insert into t#op_station_inout_sta(line_id,station_id,station_name)
    select line_id,station_id,sequence||chinese_name
    from op_prm_station
    where line_id=v_line_no
    and record_flag='0';
----Ω·π˚ºØøÚº‹
  INSERT INTO T#OP_station_inout_result
            SELECT a.line_id,a.station_id,'',b.ic_main_code,b.ic_sub_code,'','',0, 0, 0,0,0,0,0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0
            from t#op_station_inout_sta a,t#OP_STATION_inout_card b
            where a.line_id=v_line_no;
    --≤È—Ø ˝æ›
     INSERT INTO T#OP_station_inout_rpt
     (squad_day,line_id,station_id,card_main_code,card_sub_code,section_no,entry_num,export_num)
            SELECT squad_day,line_id,station_id,card_main_id,  case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,time_section_id,nvl(sum(entry_num),0),nvl(sum(export_num),0)
            from st_sts_flw_station b
            where b.line_id = v_line_no
            AND b.squad_day = v_squad_date
            and balance_water_no>=v_balance_date||'00'
            and balance_water_no<=v_balance_date||'99'
            group by  line_id,station_id,card_main_id,card_sub_id,squad_day,time_section_id;
------------------------------∏¸–¬Ω·π˚ºØ 4 ±-------------------------------------
      insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04';
------------------------------∏¸–¬Ω·π˚ºØ 5 ±-------------------------------------
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05';
----------------------------∏¸–¬Ω·π˚ºØ 6 ±-------------------------------------
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06';
----------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 7 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07';
-------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 8 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08';
------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 9 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09';
------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 10 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 11 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 12 ±
          insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 13 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 14 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 15 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ16 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 17 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 18 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 19 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 20 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 21 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 22 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 23 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 24 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 1 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 2 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 3 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03';
------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
----Œ≤¡–∫œº∆
       insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       group by line_id,station_id;
                --∏¸–¬Ω·π˚ºØ ƒ©–– À˘”–’æµ„À˘”–∆±ø®–°º∆
       insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B;
-------------------------------------------------------------------------------------
         --∏¸–¬∆±ø®√˚≥∆
          update T#OP_station_inout_result A
         set card_sub_desc=(
         select card_sub_name from op_prm_card_sub B
     where b.card_main_id=a.card_main_code
     and b.card_sub_id=a.card_sub_code
     and b.record_flag='0')
         where card_main_code!='99'
         and card_main_code!='06';
         update T#OP_station_inout_result
         set card_sub_desc='≥« –Õ®∆±'  where card_main_code='06';
          update T#OP_station_inout_result A
         set card_sub_desc='±æ’æ–°º∆'
         where card_main_code='99' and station_code!='99';
         --∏¸–¬’æµ„√˚≥∆
          update T#OP_station_inout_result A
         set station_name=(
         select sequence||chinese_name
         from op_prm_station B
         where A.line_code = B.line_id
         AND A.station_code= B.station_id
         AND B.record_flag='0')
         where station_code!='99';
          update T#OP_station_inout_result A
         set station_name='◊‹º∆'
         where station_code='99';
         -- ∑µªÿΩ·π˚
         open out_cursor for
     SELECT v_line_name line_name,v_squad_date||v_balance_date day,station_name as stationname,card_main_code||card_sub_code||card_sub_desc as card_name,
nvl(sum(entry_num0),0) entry_num0,nvl(sum(export_num0),0) export_num0,
nvl(sum(entry_num1),0) entry_num1,nvl(sum(export_num1),0) export_num1,
nvl(sum(entry_num2),0) entry_num2,nvl(sum(export_num2),0) export_num2,
nvl(sum(entry_num3),0) entry_num3,nvl(sum(export_num3),0) export_num3,
nvl(sum(entry_num4),0) entry_num4,nvl(sum(export_num4),0) export_num4,
nvl(sum(entry_num5),0) entry_num5,nvl(sum(export_num5),0) export_num5,
nvl(sum(entry_num6),0) entry_num6,nvl(sum(export_num6),0) export_num6,
nvl(sum(entry_num7),0) entry_num7,nvl(sum(export_num7),0) export_num7,
nvl(sum(entry_num8),0) entry_num8,nvl(sum(export_num8),0) export_num8,
nvl(sum(entry_num9),0) entry_num9,nvl(sum(export_num9),0) export_num9,
nvl(sum(entry_num10),0) entry_num10,nvl(sum(export_num10),0) export_num10,
nvl(sum(entry_num11),0) entry_num11,nvl(sum(export_num11),0) export_num11,
nvl(sum(entry_num12),0) entry_num12,nvl(sum(export_num12),0) export_num12,
nvl(sum(entry_num13),0) entry_num13,nvl(sum(export_num13),0) export_num13,
nvl(sum(entry_num14),0) entry_num14,nvl(sum(export_num14),0) export_num14,
nvl(sum(entry_num15),0) entry_num15,nvl(sum(export_num15),0) export_num15,
nvl(sum(entry_num16),0) entry_num16,nvl(sum(export_num16),0) export_num16,
nvl(sum(entry_num17),0) entry_num17,nvl(sum(export_num17),0) export_num17,
nvl(sum(entry_num18),0) entry_num18,nvl(sum(export_num18),0) export_num18,
nvl(sum(entry_num19),0) entry_num19,nvl(sum(export_num19),0) export_num19,
nvl(sum(entry_num20),0) entry_num20,nvl(sum(export_num20),0) export_num20,
nvl(sum(entry_num21),0) entry_num21,nvl(sum(export_num21),0) export_num21,
nvl(sum(entry_num22),0) entry_num22,nvl(sum(export_num22),0) export_num22,
nvl(sum(entry_num23),0) entry_num23,nvl(sum(export_num23),0) export_num23,
nvl(sum(total_entry_num),0) total_entry_num,nvl(sum(total_export_num),0) total_export_num
FROM T#OP_station_inout_result
group by line_code,station_code,station_name,card_main_code,card_sub_code,card_sub_desc
    ORDER BY station_code,station_name,card_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_STATION_INOUT_DAY to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_STATION_INOUT_DAY to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_STATION_INOUT_MON
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_STATION_INOUT_MON (
--π˝≥Ã√˚£∫  UP_OP_PFL_STATION_INOUT_MON
--π¶ƒ‹√Ë ˆ£∫≥µ’æΩ¯≥ˆ’æøÕ¡˜∑÷Œˆ‘¬±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130822
-------------------------------------------------------------------------------
--V1.3
--–ﬁ∏ƒƒ⁄»›£∫£®1£©ππΩ®Ω·π˚ºØ‘ˆº”°Æ07°Ø£¨°Æ08°Ø∆±÷÷
--          £®2£©≤È—ØΩ·π˚ºØ ±£¨‘ˆº”nvl∫Ø ˝
--wangkejia
--20150320


--modify by ldz 2016.12.26:–ﬁ∏ƒ24 ±section_no='00';
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--V1.4
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°”≈ª›∆±0901
--taidibao
--20170724
--------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_line_no            char(2);--œﬂ¬∑
   v_squad_date         char(6);--‘À”™»’
   v_balance_date       char(6);--«ÂÀ„»’
   v_line_name varchar(50);
   begin
    v_squad_date:=substr(in_squad_day,1,6);
    v_balance_date:=substr(in_balance_day,1,6);
    v_line_no:=in_line_id;
if v_line_no!=' ' and v_line_no is not null then
    select line_name into v_line_name from op_prm_line
    where line_id=v_line_no and record_flag = '0';
 end if;
  --∆±ø®¿‡–Õ
    insert into t#OP_STATION_inout_card(ic_main_code,ic_sub_code,ic_sub_desc)
    select card_main_id,card_sub_id,card_sub_name
    from op_prm_card_sub
    where card_main_id in('01','02','03','04','07','08','09')--20150320 --modify by tdb 20170724
    and record_flag='0';
    insert into t#OP_STATION_inout_card
    values ('06','00','≥« –Õ®∆±');
    insert into t#OP_STATION_inout_card
    values ('99','99','±æ’æ–°º∆');
  --’æµ„
    insert into t#op_station_inout_sta(line_id,station_id,station_name)
    select line_id,station_id,sequence||chinese_name
    from op_prm_station
    where line_id=v_line_no
    and record_flag='0';
----Ω·π˚ºØøÚº‹
  INSERT INTO T#OP_station_inout_result
            SELECT a.line_id,a.station_id,'',b.ic_main_code,b.ic_sub_code,'','',0, 0, 0,0,0,0,0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0
            from t#op_station_inout_sta a,t#OP_STATION_inout_card b;
    --≤È—Ø ˝æ›
     INSERT INTO T#OP_station_inout_rpt
     (squad_day,line_id,station_id,card_main_code,card_sub_code,section_no,entry_num,export_num)
            SELECT squad_day,line_id,station_id,card_main_id,  case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,time_section_id,nvl(sum(entry_num),0),nvl(sum(export_num),0)
            from st_sts_flw_station b
            where b.line_id = v_line_no
            AND substr(b.squad_day,1,6) = v_squad_date
            and balance_water_no>=v_balance_date||'0100'
            and balance_water_no<=v_balance_date||'3199'
            group by  line_id,station_id,card_main_id,card_sub_id,squad_day,time_section_id;
------------------------------∏¸–¬Ω·π˚ºØ 4 ±-------------------------------------
      insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04';
------------------------------∏¸–¬Ω·π˚ºØ 5 ±-------------------------------------
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05';
----------------------------∏¸–¬Ω·π˚ºØ 6 ±-------------------------------------
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06';
----------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 7 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07';
-------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 8 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08';
------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 9 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09';
------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 10 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 11 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 12 ±
          insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 13 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 14 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 15 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ16 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 17 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 18 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 19 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 20 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 21 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 22 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 23 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 24 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 1 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 2 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 3 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03';
------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
----Œ≤¡–∫œº∆
       insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       group by line_id,station_id;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
       insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B;
-------------------------------------------------------------------------------------
         --∏¸–¬∆±ø®√˚≥∆
          update T#OP_station_inout_result A
         set card_sub_desc=(
         select card_sub_name from op_prm_card_sub B
     where b.card_main_id=a.card_main_code
     and b.card_sub_id=a.card_sub_code
     and b.record_flag='0')
         where card_main_code!='99'
         and card_main_code!='06';
         update T#OP_station_inout_result
         set card_sub_desc='≥« –Õ®∆±'  where card_main_code='06';
          update T#OP_station_inout_result A
         set card_sub_desc='±æ’æ–°º∆'
         where card_main_code='99' and station_code!='99';
         --∏¸–¬’æµ„√˚≥∆
          update T#OP_station_inout_result A
         set station_name=(
         select sequence||chinese_name
         from op_prm_station B
         where A.line_code = B.line_id
         AND A.station_code= B.station_id
         AND B.record_flag='0')
         where station_code!='99';
          update T#OP_station_inout_result A
         set station_name='◊‹º∆'
         where station_code='99';
         -- ∑µªÿΩ·π˚
         open out_cursor for
     SELECT v_line_name line_name,v_squad_date||v_balance_date mon,station_name as stationname,card_main_code||card_sub_code||card_sub_desc as card_name,
nvl(sum(entry_num0),0) entry_num0,nvl(sum(export_num0),0) export_num0,
nvl(sum(entry_num1),0) entry_num1,nvl(sum(export_num1),0) export_num1,
nvl(sum(entry_num2),0) entry_num2,nvl(sum(export_num2),0) export_num2,
nvl(sum(entry_num3),0) entry_num3,nvl(sum(export_num3),0) export_num3,
nvl(sum(entry_num4),0) entry_num4,nvl(sum(export_num4),0) export_num4,
nvl(sum(entry_num5),0) entry_num5,nvl(sum(export_num5),0) export_num5,
nvl(sum(entry_num6),0) entry_num6,nvl(sum(export_num6),0) export_num6,
nvl(sum(entry_num7),0) entry_num7,nvl(sum(export_num7),0) export_num7,
nvl(sum(entry_num8),0) entry_num8,nvl(sum(export_num8),0) export_num8,
nvl(sum(entry_num9),0) entry_num9,nvl(sum(export_num9),0) export_num9,
nvl(sum(entry_num10),0) entry_num10,nvl(sum(export_num10),0) export_num10,
nvl(sum(entry_num11),0) entry_num11,nvl(sum(export_num11),0) export_num11,
nvl(sum(entry_num12),0) entry_num12,nvl(sum(export_num12),0) export_num12,
nvl(sum(entry_num13),0) entry_num13,nvl(sum(export_num13),0) export_num13,
nvl(sum(entry_num14),0) entry_num14,nvl(sum(export_num14),0) export_num14,
nvl(sum(entry_num15),0) entry_num15,nvl(sum(export_num15),0) export_num15,
nvl(sum(entry_num16),0) entry_num16,nvl(sum(export_num16),0) export_num16,
nvl(sum(entry_num17),0) entry_num17,nvl(sum(export_num17),0) export_num17,
nvl(sum(entry_num18),0) entry_num18,nvl(sum(export_num18),0) export_num18,
nvl(sum(entry_num19),0) entry_num19,nvl(sum(export_num19),0) export_num19,
nvl(sum(entry_num20),0) entry_num20,nvl(sum(export_num20),0) export_num20,
nvl(sum(entry_num21),0) entry_num21,nvl(sum(export_num21),0) export_num21,
nvl(sum(entry_num22),0) entry_num22,nvl(sum(export_num22),0) export_num22,
nvl(sum(entry_num23),0) entry_num23,nvl(sum(export_num23),0) export_num23,
nvl(sum(total_entry_num),0) total_entry_num,nvl(sum(total_export_num),0) total_export_num
FROM T#OP_station_inout_result
group by line_code,station_code,station_name,card_main_code,card_sub_code,card_sub_desc
    ORDER BY station_code,station_name,card_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_STATION_INOUT_MON to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_STATION_INOUT_MON to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_PFL_STATION_INOUT_YEAR
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_PFL_STATION_INOUT_YEAR (
--π˝≥Ã√˚£∫  UP_OP_PFL_STATION_INOUT_YEAR
--π¶ƒ‹√Ë ˆ£∫≥µ’æΩ¯≥ˆ’æøÕ¡˜∑÷ŒˆƒÍ±®
-- ‰≥ˆ≤Œ ˝  : Œﬁ
--¥¥Ω®’ﬂ£∫  wangkejia
--¥¥Ω®»’∆⁄£∫20130822
-------------------------------------------------------------------------------
--V1.3
--–ﬁ∏ƒƒ⁄»›£∫£®1£©ππΩ®Ω·π˚ºØ‘ˆº”'07'£¨'08'∆±÷÷
--          £®2£©≤È—ØΩ·π˚ºØ ±£¨‘ˆº”nvl∫Ø ˝
--wangkejia
--20150320

--–ﬁ∏ƒ 20160616 mqf ‘ˆº”≤È—Ø¿˙ ∑±Ì ˝æ›


--modify by ldz 2016.12.26:–ﬁ∏ƒ24 ±section_no='00';
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
--V1.4
--–ﬁ∏ƒƒ⁄»›£∫–¬‘ˆ¥≈∏°”≈ª›∆±0901
--taidibao
--20170724
--------------------------------------------------------------------------------
in_line_id char,
in_station_id char,
in_squad_day char,
in_balance_day char,
in_card_main_id char,
in_card_sub_id char,
out_cursor  OUT sys_refcursor)
AS
   v_line_no            char(2);--œﬂ¬∑
   v_squad_date         char(4);--‘À”™ƒÍ
   v_balance_date       char(4);--«ÂÀ„ƒÍ
   v_line_name varchar(50);
   v_sql           varchar2(2048);
   begin
    v_squad_date:=substr(in_squad_day,1,4);
    v_balance_date:=substr(in_balance_day,1,4);
    v_line_no:=in_line_id;
if v_line_no!=' ' and v_line_no is not null then
    select line_name into v_line_name from op_prm_line
    where line_id=v_line_no and record_flag = '0';
 end if;
  --∆±ø®¿‡–Õ
    insert into t#OP_STATION_inout_card(ic_main_code,ic_sub_code,ic_sub_desc)
    select card_main_id,card_sub_id,card_sub_name
    from op_prm_card_sub
    where card_main_id in('01','02','03','04','07','08','09')--20150230 --modify by tdb 20170724
    and record_flag='0';
    insert into t#OP_STATION_inout_card
    values ('06','00','≥« –Õ®∆±');
    insert into t#OP_STATION_inout_card
    values ('99','99','±æ’æ–°º∆');
  --’æµ„
    insert into t#op_station_inout_sta(line_id,station_id,station_name)
    select line_id,station_id,sequence||chinese_name
    from op_prm_station
    where line_id=v_line_no
    and record_flag='0';
----Ω·π˚ºØøÚº‹
  INSERT INTO T#OP_station_inout_result
            SELECT a.line_id,a.station_id,'',b.ic_main_code,b.ic_sub_code,'','',0, 0, 0,0,0,0,0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0,0,0,0
            from t#op_station_inout_sta a,t#OP_STATION_inout_card b;
    --≤È—Ø ˝æ›
     INSERT INTO T#OP_station_inout_rpt
     (squad_day,line_id,station_id,card_main_code,card_sub_code,section_no,entry_num,export_num)
            SELECT squad_day,line_id,station_id,card_main_id,  case when card_main_id='06' then '00' else card_sub_id end as card_sub_id,time_section_id,nvl(sum(entry_num),0),nvl(sum(export_num),0)
            from st_sts_flw_station b
            where b.line_id = v_line_no
            AND substr(b.squad_day,1,4) = v_squad_date
            and balance_water_no>=v_balance_date||'010100'
            and balance_water_no<=v_balance_date||'123199'
            group by  line_id,station_id,card_main_id,card_sub_id,squad_day,time_section_id;

  --20160616 mqf ‘ˆº”≤È—Ø¿˙ ∑±Ì ˝æ›
  begin
  declare
    cursor index_table is
    select table_name    temp_table_name
      from acc_st.st_idx_rpt_history t
    where origin_table_name = 'acc_st.st_sts_flw_station'
       and min_squad_day <= v_squad_date||'1231'
       and max_squad_day >= v_squad_date||'0101'
       order by table_name desc;

  begin
    for t_cur in index_table loop

      v_sql := 'INSERT INTO T#OP_station_inout_rpt ' ||
      '(squad_day,line_id,station_id,card_main_code,card_sub_code,section_no,entry_num,export_num) ' ||
            ' SELECT squad_day,line_id,station_id,card_main_id,  case when card_main_id=''06'' then ''00'' else card_sub_id end as card_sub_id,time_section_id,nvl(sum(entry_num),0),nvl(sum(export_num),0) ' ||
            ' from acc_st.' || t_cur.temp_table_name ||  ' b ' ||
            ' where b.line_id = ''' || v_line_no || '''' ||
            ' AND substr(b.squad_day,1,4) = ''' || v_squad_date || '''' ||
            ' and balance_water_no>= ''' || v_balance_date||'010100''' ||
            ' and balance_water_no<= ''' || v_balance_date||'123199''' ||
            ' group by  line_id,station_id,card_main_id,card_sub_id,squad_day,time_section_id';

      execute immediate v_sql;

    end loop;

  end;
  end;
------------------------------∏¸–¬Ω·π˚ºØ 4 ±-------------------------------------
      insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num0,export_num0)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='04';
------------------------------∏¸–¬Ω·π˚ºØ 5 ±-------------------------------------
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num1,export_num1)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='05';
----------------------------∏¸–¬Ω·π˚ºØ 6 ±-------------------------------------
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num2,export_num2)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='06';
----------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 7 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num3,export_num3)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='07';
-------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 8 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num4,export_num4)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='08';
------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 9 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num5,export_num5)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='09';
------------------------------------------------------------------------------------
--∏¸–¬Ω·π˚ºØ 10 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num6,export_num6)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='10';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 11 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num7,export_num7)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='11';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 12 ±
          insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num8,export_num8)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='12';
------------------------------------------------------------------------------------    --∏¸–¬Ω·π˚ºØ 13 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13'
       group by line_id,station_id,card_main_code,card_sub_code;
--∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num9,export_num9)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='13';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 14 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num10,export_num10)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='14';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 15 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num11,export_num11)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='15';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ16 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num12,export_num12)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='16';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 17 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num13,export_num13)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='17';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 18 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num14,export_num14)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='18';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 19 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num15,export_num15)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='19';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 20 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num16,export_num16)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='20';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 21 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num17,export_num17)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='21';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 22 ±
             insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num18,export_num18)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='22';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 23 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num19,export_num19)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='23';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 24 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='00'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num20,export_num20)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='24';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 1 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num21,export_num21)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='01';
------------------------------------------------------------------------------------        --∏¸–¬Ω·π˚ºØ 2 ±
           insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02'
       group by line_id,station_id;
 --∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num22,export_num22)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='02';
------------------------------------------------------------------------------------       --∏¸–¬Ω·π˚ºØ 3 ±
            insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03'
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03'
       group by line_id,station_id;
--∏¸–¬Ω·π˚ºØ ƒ©––∫œº∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,entry_num23,export_num23)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       WHERE section_no='03';
------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------
----Œ≤¡–∫œº∆
       insert into  T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,station_id,card_main_code,card_sub_code,nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       group by line_id,station_id,card_main_code,card_sub_code;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
         insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select line_id,station_id,'99','99',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B
       group by line_id,station_id;
                --∏¸–¬Ω·π˚ºØ ’æµ„À˘”–∆±ø®–°º∆
       insert into T#OP_station_inout_result (line_code,station_code,card_main_code,card_sub_code,total_entry_num,total_export_num)
    select '99','99','','',nvl(sum(entry_num),0),nvl(sum(export_num),0)
       FROM T#OP_station_inout_rpt B;
-------------------------------------------------------------------------------------
         --∏¸–¬∆±ø®√˚≥∆
          update T#OP_station_inout_result A
         set card_sub_desc=(
         select card_sub_name from op_prm_card_sub B
     where b.card_main_id=a.card_main_code
     and b.card_sub_id=a.card_sub_code
     and b.record_flag='0')
         where card_main_code!='99'
         and card_main_code!='06';
         update T#OP_station_inout_result
         set card_sub_desc='≥« –Õ®∆±'  where card_main_code='06';
          update T#OP_station_inout_result A
         set card_sub_desc='±æ’æ–°º∆'
         where card_main_code='99' and station_code!='99';
         --∏¸–¬’æµ„√˚≥∆
          update T#OP_station_inout_result A
         set station_name=(
         select sequence||chinese_name
         from op_prm_station B
         where A.line_code = B.line_id
         AND A.station_code= B.station_id
         AND B.record_flag='0')
         where station_code!='99';
          update T#OP_station_inout_result A
         set station_name='◊‹º∆'
         where station_code='99';
         -- ∑µªÿΩ·π˚
         open out_cursor for
     SELECT v_line_name line_name,v_squad_date||v_balance_date YEAR,station_name as stationname,card_main_code||card_sub_code||card_sub_desc as card_name,
nvl(sum(entry_num0),0) entry_num0,nvl(sum(export_num0),0) export_num0,
nvl(sum(entry_num1),0) entry_num1,nvl(sum(export_num1),0) export_num1,
nvl(sum(entry_num2),0) entry_num2,nvl(sum(export_num2),0) export_num2,
nvl(sum(entry_num3),0) entry_num3,nvl(sum(export_num3),0) export_num3,
nvl(sum(entry_num4),0) entry_num4,nvl(sum(export_num4),0) export_num4,
nvl(sum(entry_num5),0) entry_num5,nvl(sum(export_num5),0) export_num5,
nvl(sum(entry_num6),0) entry_num6,nvl(sum(export_num6),0) export_num6,
nvl(sum(entry_num7),0) entry_num7,nvl(sum(export_num7),0) export_num7,
nvl(sum(entry_num8),0) entry_num8,nvl(sum(export_num8),0) export_num8,
nvl(sum(entry_num9),0) entry_num9,nvl(sum(export_num9),0) export_num9,
nvl(sum(entry_num10),0) entry_num10,nvl(sum(export_num10),0) export_num10,
nvl(sum(entry_num11),0) entry_num11,nvl(sum(export_num11),0) export_num11,
nvl(sum(entry_num12),0) entry_num12,nvl(sum(export_num12),0) export_num12,
nvl(sum(entry_num13),0) entry_num13,nvl(sum(export_num13),0) export_num13,
nvl(sum(entry_num14),0) entry_num14,nvl(sum(export_num14),0) export_num14,
nvl(sum(entry_num15),0) entry_num15,nvl(sum(export_num15),0) export_num15,
nvl(sum(entry_num16),0) entry_num16,nvl(sum(export_num16),0) export_num16,
nvl(sum(entry_num17),0) entry_num17,nvl(sum(export_num17),0) export_num17,
nvl(sum(entry_num18),0) entry_num18,nvl(sum(export_num18),0) export_num18,
nvl(sum(entry_num19),0) entry_num19,nvl(sum(export_num19),0) export_num19,
nvl(sum(entry_num20),0) entry_num20,nvl(sum(export_num20),0) export_num20,
nvl(sum(entry_num21),0) entry_num21,nvl(sum(export_num21),0) export_num21,
nvl(sum(entry_num22),0) entry_num22,nvl(sum(export_num22),0) export_num22,
nvl(sum(entry_num23),0) entry_num23,nvl(sum(export_num23),0) export_num23,
nvl(sum(total_entry_num),0) total_entry_num,nvl(sum(total_export_num),0) total_export_num
FROM T#OP_station_inout_result
group by line_code,station_code,station_name,card_main_code,card_sub_code,card_sub_desc
    ORDER BY station_code,station_name,card_name;
end;
/
grant execute on ACC_ST.UP_OP_PFL_STATION_INOUT_YEAR to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_PFL_STATION_INOUT_YEAR to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_QUERY_DEAL_DATA
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_QUERY_DEAL_DATA(in_start_time VARCHAR2, --ø™ º ±º‰
                                                  in_end_time   VARCHAR2, -- Ω· ¯ ±º‰
                                                  in_logi_id    VARCHAR2, -- ¬ﬂº≠ø®∫≈
                                                  in_deal_type  VARCHAR2, --Ωª“◊¿‡–Õ
                                                  out_cur_arg   OUT sys_refcursor)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_QUERY_DEAL_DATA
  --π¶ƒ‹√Ë ˆ£∫‘À”™÷––ƒ≤È—ØœµÕ≥--∆±ø®Ωª“◊≤È—Ø
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ≈∑—ÙŒ¬‹ﬂ
  --¥¥Ω®»’∆⁄£∫20130802
  --¡Ÿ ±±Ì£∫t#table_name_initi ≥ı ºªØ±Ì√˚ --»°œ˚ π”√ modify by mqf
  --        t#table_name_hunch ‘§∏∂÷µ±Ì√˚ --»°œ˚ π”√ modify by mqf
  --        t#op_query_deal_data_tmp_name Ωª“◊¿˙ ∑±Ì√˚
  --        t#op_query_deal_data_tmp1  Ωª“◊¿˙ ∑º«¬º
  --        t#op_query_deal_data_tmp2
  --    ‘ˆº”t#op_query_deal_data_tbl_es  ES∑÷±Ì√˚  add by mqf
  --–ﬁ∏ƒ 2013-11-14
  --±£¥Ê±Ì√˚µƒÀ˜“˝∫≈£¨8Œª±‰≥…3Œª£¨
  --–ﬁ∏ƒ∂‘”⁄Ωª“◊¿‡–Õµƒ—È÷§£¨‘≠¥Û–¥œ÷‘⁄ø…ºÊ»›–°–¥
  --–ﬁ∏ƒ 2014-05-04
  --…æ≥˝πÿ”⁄±Ìop_prm_outdate_station£®“—…æ≥˝£©µƒ≈–∂œ
  --–ﬁ∏ƒ 2014-08-07
  --ÃÌº”≤È’“π´Ωªœ˚∑— acc_st_his.st_ext_mtr_his_deal acc_st.st_ext_mtr_que_deal£®Ωª“◊¿‡–Õ11 π´Ωªœ˚∑—£©
  --–ﬁ∏ƒ 2014-09-03
  --∫œ≤¢µ•≥Ã∆±∑¢ €”Î≥ˆ’æ∆±∑¢ €µƒ≤È—Ø”Ôæ‰
  --÷∏∂®≤ø∑÷¥Û ˝æ›¡ø±Ì∞¥À˜“˝≤È—Ø°£
  --–ﬁ∏ƒ 2014-09-05
  --À˘”–µƒ±Ì∂º÷∏∂®∞¥À˜“˝≤È—Ø°£
  --–ﬁ∏ƒ 2015-08-29
  --–ﬁ∏ƒπÿ”⁄ ˝æ›±Ì«®“∆∫Û≤È—Ø¿˙ ∑±Ì¥Ê‘⁄µƒ≥Ã–Úbug
  --–ﬁ∏ƒ 2016-01-15 ‘ˆº”πÿ”⁄ø’∑¢ø®Ωª“◊µƒ≤È—Ø
  --–ﬁ∏ƒ 2016-10-13 µ•≥Ã∆±∑¢ € deposit_fee≥…±æ—∫ΩΩ∂Ó∏ƒŒ™sale_feeΩª“◊Ω∂Ó
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫zhouyang
  --–ﬁ∏ƒƒ⁄»›£∫1°¢‘ˆº”°∞π´Ωªœ˚∑—°±∑÷±Ì≤È—Øπ¶ƒ‹£ª2°¢Ω´±Ì√˚£®»Á£∫v_name)µƒ◊÷∑˚≥§∂»Õ≥“ª∏ƒŒ™char(30)
  --–ﬁ∏ƒ»’∆⁄£∫2017-02-23
  -------------------------------------------------------------------------------
  --–ﬁ∏ƒ’ﬂ£∫mqf
  --–ﬁ∏ƒƒ⁄»›£∫1°¢∆’Õ®¥¢÷µ∆±÷ÿ”√,…æ≥˝÷ÿ”√µƒ∆’Õ®¥¢∆±µƒæ… ˝æ›
  --          2°¢–ﬁ∏ƒESœ‡πÿ±Ì≤È—Ø£¨‘ˆº”≤È—Ø ÷ª˙∆±≥ı ºªØIC_MB_INITI_INFOµƒ∑÷±Ì°¢≥µ∆±÷ÿ±‡¬Îic_es_again_infoµƒ∑÷±Ì°¢≥µ∆±◊¢œ˙ic_es_logout_infoµƒ∑÷±Ì£¨
  --             »°œ˚ π”√t#table_name_initi°¢t#table_name_hunch°¢‘ˆº”ES∑÷±Ì√˚t#op_query_deal_data_tbl_es
  --          3°¢≤È—Ø–¬‘ˆµƒES¥¢÷µ∆±÷ÿ±‡¬Îº«¬º±Ìic_es_again_info_svt
  --          4°¢≤È—Øic_es_initi_info°¢ic_es_hunch_info°¢ic_es_again_info°¢ic_es_again_info_svt°¢ic_es_logout_infoΩ´manu_time(÷∆ø® ±º‰)∏ƒŒ™hdl_time(¥¶¿Ì ±º‰)
  --             ≤È—Ø”√manu_time≥ˆœ÷manu_time±»±Ìst_act_svt_againµƒagain_time«∞£¨¥¢÷µ∆±÷ÿ±‡¬Îº«¬º±ªπÈµΩæ…ø®º«¬ºΩ´±ª…æ≥˝£¨
  --             ¥¢÷µ∆±÷ÿ±‡¬Î ±º‰º«¬º±Ìst_act_svt_againµƒagain_time»°÷µ”Îhdl_time“ª÷¬£¨±»manu_time∫Û
  --          5°¢‘ˆº”≤È—Ø‘∆π∫∆±ª˙µƒµ•≥Ã∆±∑¢ €£∫acc_st_his.st_np_his_sale°¢acc_st.st_np_que_sale£¨
  --             ‘∆π∫∆±ª˙µƒ¥¢÷µø®µƒ≥‰÷µ£∫acc_st_his.st_np_his_deal°¢acc_st.st_np_que_deal
  --–ﬁ∏ƒ»’∆⁄£∫2017-04-01
  -------------------------------------------------------------------------------

 IS
  v_name        CHAR(30); --±Ì√˚
  v_name_50     CHAR(30); --±Ì√˚
  v_name_53     CHAR(30); --±Ì√˚
  v_name_94     CHAR(30); --±Ì√˚
  v_n           int; --–Ú∫≈
  v_n_50        int; --–Ú∫≈
  v_n_53        int; --–Ú∫≈
  v_n_94        int; --–Ú∫≈
  v_i           int; --º«¬º ˝
  v_sql         VARCHAR2(2000); --
  v_sql_1       VARCHAR2(2000); --
  v_name_56     CHAR(30); --±Ì√˚
  v_n_56        int; --–Ú∫≈
  v_col_count   int; --±Ì¿Ô√Êµƒ◊÷∂Œ≥§∂»
  v_table_count int; --±Ì¿Ô√Êµƒ ˝æ›¡ø
  -----------------------------------------
  ----es_initi_info es_hunch_info∑÷±Ì π”√
  -----------------------------------------
  v_tableName    VARCHAR2(100);
  v_maxTime      VARCHAR2(20);
  v_proBeginTime date;
BEGIN
  --œ»…æ≥˝¡Ÿ ±±Ì ˝æ›
  --delete from t#table_name_initi;
  --delete from t#table_name_hunch;
  delete from t#op_query_deal_data_tmp_name;
  delete from t#op_query_deal_data_tmp1;
  delete from t#op_query_deal_data_tmp2;

  --20170401 add by mqf ES∑÷±Ì√˚
  delete from acc_st.t#op_query_deal_data_tbl_es;

  --≤ª «‘±π§∆±

  BEGIN
    v_proBeginTime := sysdate;
    DBMS_OUTPUT.PUT_LINE('%%≤È—Øø™ º-' || 'µ±«∞ ±º‰£∫' ||
                         to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss'));
    ---------------- ≤È—Ø±Ì√˚ø™ º-------------------
  --20170401 modify by mqf “ª¥Œ≤È—Ø ≥ı ºªØ°¢‘§∏≥÷µ°¢÷ÿ±‡¬Î°¢◊¢œ˙°¢ ÷ª˙÷ß∏∂∆±ø®≥ı ºªØ±Ì(IC_MB_INITI_INFO)µƒµ±«∞±Ì°¢∑÷±Ì
    IF (in_deal_type = '%' OR in_deal_type in ('62','63','64','65') ) THEN
      BEGIN
        --≤È’“ ±º‰…œ∑˚∫œ“™«ÛµƒES∑÷±Ì
        INSERT INTO acc_st.t#op_query_deal_data_tbl_es
          (origin_table_name,table_name)
          SELECT origin_table_name,his_table
            FROM acc_tk.ic_idx_history
           WHERE recd_type = '99'
             AND not ((TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss') <
                      TO_DATE(begin_time, 'yyyy_mm_dd hh24:mi:ss')) OR
                      (TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') >
                      TO_DATE(nvl(end_time, '2999-01-01 00:00:00'),
                               'yyyy_mm_dd hh24:mi:ss')));

/*
        DBMS_OUTPUT.PUT_LINE('62-65≤È—Ø≥ı ºªØ-' || 'µ±«∞ ±º‰£∫' ||
                             to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                             'œ˚∫ƒ ±º‰£∫' ||
                             (sysdate - v_proBeginTime) * 24 * 60 * 60);
        v_proBeginTime := sysdate;
    */
      END;
    END IF;

  /*
    --a1: »Áπ˚≤È—ØÀ˘”–Ωª“◊¿‡–ÕªÚ≥ı ºªØ ‘Ú≤È—Ø≥ı ºªØ±Ì√˚
    IF (in_deal_type = '%' OR in_deal_type = '62') THEN
      BEGIN
        --≤È’“ ±º‰…œ∑˚∫œ“™«Ûµƒ∑÷±Ì
        INSERT INTO t#table_name_initi
          (table_name)
          SELECT his_table
            FROM acc_tk.ic_idx_history
           WHERE SUBSTR(his_table, 1, 16) = 'ic_es_initi_info'
             AND not ((TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss') <
                      TO_DATE(begin_time, 'yyyy_mm_dd hh24:mi:ss')) OR
                      (TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') >
                      TO_DATE(nvl(end_time, '2999-01-01 00:00:00'),
                               'yyyy_mm_dd hh24:mi:ss')));
        --∑÷±Ìµƒ◊Ó¥Û ±º‰
        begin
          SELECT end_time
            INTO v_maxTime
            FROM acc_tk.ic_idx_history
           WHERE SUBSTR(his_table, 1, 16) = 'ic_es_initi_info';
        EXCEPTION
          WHEN OTHERS THEN
            v_maxTime := null;
        end;

        --∑÷±Ìµƒ◊Ó¥Û ±º‰≤ª¥Ê‘⁄
        IF (v_maxTime IS NULL) THEN
          BEGIN
            INSERT INTO t#table_name_initi
              (table_name)
            values
              ('ic_es_initi_info');

          END;
        ELSE
          --≤È—Ø ±º‰≥¨π˝∆ º ±º‰ªÚΩ· ¯ ±º‰≥¨π˝∑÷±Ìµƒ◊Ó¥Û ±º‰
          BEGIN
            IF ((TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') >
               TO_DATE(v_maxTime, 'yyyy_mm_dd hh24:mi:ss')) OR
               (TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss') >
               TO_DATE(v_maxTime, 'yyyy_mm_dd hh24:mi:ss'))) THEN
              INSERT INTO t#table_name_initi
                (table_name)
              values
                ('ic_es_initi_info');
            END IF;

          END;

        END IF;

        DBMS_OUTPUT.PUT_LINE('62≤È—Ø≥ı ºªØ-' || 'µ±«∞ ±º‰£∫' ||
                             to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                             'œ˚∫ƒ ±º‰£∫' ||
                             (sysdate - v_proBeginTime) * 24 * 60 * 60);
        v_proBeginTime := sysdate;
      END;
    END IF;
    --a2: »Áπ˚≤È—ØÀ˘”–Ωª“◊¿‡–ÕªÚ‘§∏∂÷µ ‘Ú≤È—Ø‘§∏∂÷µ±Ì√˚
    IF (in_deal_type = '%' OR in_deal_type = '63') THEN
      BEGIN

        --≤È’“ ±º‰…œ∑˚∫œ“™«Ûµƒ∑÷±Ì
        INSERT INTO t#table_name_hunch
          (table_name)
          SELECT his_table
            FROM acc_tk.ic_idx_history
           WHERE SUBSTR(his_table, 1, 16) = 'ic_es_hunch_info'
             AND not ((TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss') <
                      TO_DATE(begin_time, 'yyyy_mm_dd hh24:mi:ss')) OR
                      (TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') >
                      TO_DATE(nvl(end_time, '2999-01-01 00:00:00'),
                               'yyyy_mm_dd hh24:mi:ss')));
        --∑÷±Ìµƒ◊Ó¥Û ±º‰
        begin
          SELECT end_time
            INTO v_maxTime
            FROM acc_tk.ic_idx_history
           WHERE SUBSTR(his_table, 1, 16) = 'ic_es_hunch_info';
        EXCEPTION
          WHEN OTHERS THEN
            v_maxTime := null;
        end;
        --∑÷±Ìµƒ◊Ó¥Û ±º‰≤ª¥Ê‘⁄
        IF (v_maxTime IS NULL) THEN
          BEGIN
            INSERT INTO t#table_name_hunch
              (table_name)
            values
              ('ic_es_hunch_info');
          END;
        ELSE
          --≤È—Ø ±º‰≥¨π˝∆ º ±º‰ªÚΩ· ¯ ±º‰≥¨π˝∑÷±Ìµƒ◊Ó¥Û ±º‰
          BEGIN
            IF ((TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') >
               TO_DATE(v_maxTime, 'yyyy_mm_dd hh24:mi:ss')) OR
               (TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss') >
               TO_DATE(v_maxTime, 'yyyy_mm_dd hh24:mi:ss'))) THEN
              INSERT INTO t#table_name_hunch
                (table_name)
              values
                ('ic_es_hunch_info');
            END IF;
          END;
        END IF;

        DBMS_OUTPUT.PUT_LINE('63≤È—Ø‘§∏∂÷µ-' || 'µ±«∞ ±º‰£∫' ||
                             to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                             'œ˚∫ƒ ±º‰£∫' ||
                             (sysdate - v_proBeginTime) * 24 * 60 * 60);
        v_proBeginTime := sysdate;
      END;
    END IF;
  */


    ------------------------------------------
    --a5: ≤È—ØΩª“◊¿˙ ∑±Ì√˚
    INSERT INTO t#op_query_deal_data_tmp_name
      (table_name, num, recd_type)
      SELECT table_name, SUBSTR(RTRIM(table_name), -4), recd_type
        FROM acc_st.st_idx_trx_history
       WHERE upper(data_type) = 'TRX'
         AND not
              ((TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss') < begin_date) OR
               (TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') >
               nvl(end_date,
                    TO_DATE('2999-01-01 00:00:00', 'yyyy_mm_dd hh24:mi:ss'))));
    ----------------------- ≤È—Ø±Ì√˚Ω· ¯ -------------------

    -------------------- ∞¥Ωª“◊¿‡–Õ≤È—ØΩª“◊¿˙ ∑º«¬ºø™ º---------------
    --------------- »Áπ˚≤È—ØÀ˘”–Ωª“◊¿‡–Õ------------

    -------’“≥ˆ◊Ó–¬µƒ¿˙ ∑±Ì
    -------------------1 µ•≥Ã∆±∑¢ €
    IF (in_deal_type = '%' OR in_deal_type = '50') THEN

      BEGIN
        begin
          --≤È—Øst_his_sale_sjt
          insert into t#op_query_deal_data_tmp1
            select /*+index(st_his_sale_sjt) */
             case
               when pay_type = '05' then
                '01≥ˆ’æ∆±∑¢ €'
               when pay_type = '00' then
                '01≥ˆ’æ∆±∑¢ €'
               else
                '01µ•≥Ã∆±∑¢ €'
             end,
             card_logical_id,
             sale_datetime,
             line_id,
             station_id,
             sale_fee, --deposit_fee, 20161013 deposit_fee≥…±æ—∫ΩΩ∂Ó∏ƒŒ™sale_feeΩª“◊Ω∂Ó
             0,
             device_id,
             dev_type_id,
             card_main_id,
             card_sub_id,
             operator_id,
             '0000',
             0,
             0,
             0,
             ''
              from st_his_sale_sjt
             where card_logical_id = in_logi_id
               and (sale_datetime between
                   to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                   to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

          --≤È—Øst_que_sale_sjt
          insert into t#op_query_deal_data_tmp1
            select /*+index(st_que_sale_sjt) */
             case
               when pay_type = '05' then
                '01≥ˆ’æ∆±∑¢ €'
               when pay_type = '00' then
                '01≥ˆ’æ∆±∑¢ €'
               else
                '01µ•≥Ã∆±∑¢ €'
             end,
             card_logical_id,
             sale_datetime,
             line_id,
             station_id,
             sale_fee,--deposit_fee, 20161013 deposit_fee≥…±æ—∫ΩΩ∂Ó∏ƒŒ™sale_feeΩª“◊Ω∂Ó
             0,
             device_id,
             dev_type_id,
             card_main_id,
             card_sub_id,
             operator_id,
             '0000',
             0,
             0,
             0,
             ''
              from st_que_sale_sjt
             where card_logical_id = in_logi_id
               and (sale_datetime between
                   to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                   to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

        end;

      --≤È—Øª•¡™Õ¯÷ß∏∂∑¢ €±Ìst_np_his_sale  20170417 add by mqf
      insert into t#op_query_deal_data_tmp1
      select
       case
         when pay_type = '05' then
        '01≥ˆ’æ∆±∑¢ €'
         when pay_type = '00' then
        '01≥ˆ’æ∆±∑¢ €'
         else
        '01µ•≥Ã∆±∑¢ €'
       end,
       card_logical_id,
       sale_datetime,
       line_id,
       station_id,
       sale_fee,
       0,
       device_id,
       dev_type_id,
       card_main_id,
       card_sub_id,
       operator_id,
       '0000',
       0,
       0,
       0,
       ''
        from acc_st_his.st_np_his_sale
       where card_logical_id = in_logi_id
         and (sale_datetime between
           to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
           to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

      --≤È—Øª•¡™Õ¯÷ß∏∂∑¢ €±Ìacc_st.st_np_que_sale  20170417 add by mqf
      insert into t#op_query_deal_data_tmp1
      select
       case
         when pay_type = '05' then
        '01≥ˆ’æ∆±∑¢ €'
         when pay_type = '00' then
        '01≥ˆ’æ∆±∑¢ €'
         else
        '01µ•≥Ã∆±∑¢ €'
       end,
       card_logical_id,
       sale_datetime,
       line_id,
       station_id,
       sale_fee,
       0,
       device_id,
       dev_type_id,
       card_main_id,
       card_sub_id,
       operator_id,
       '0000',
       0,
       0,
       0,
       ''
        from acc_st.st_np_que_sale
       where card_logical_id = in_logi_id
         and (sale_datetime between
           to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
           to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));


        --≤È—Ø¿˙ ∑±Ì
        begin
          SELECT COUNT(*)
            INTO v_i
            FROM t#op_query_deal_data_tmp_name
           WHERE recd_type = '50';
        EXCEPTION
          WHEN OTHERS THEN
            v_i := 0;
        end;
        begin
          SELECT table_name, TO_NUMBER(num)
            INTO v_name_50, v_n_50
            FROM t#op_query_deal_data_tmp_name
           WHERE num = (SELECT MAX(num)
                          FROM t#op_query_deal_data_tmp_name
                         WHERE recd_type = '50')
             AND recd_type = '50';
        EXCEPTION
          WHEN OTHERS THEN
            v_name_50 := null;
            v_n_50    := null;
        end;
        IF (v_name_50 IS NOT NULL) THEN
          BEGIN

            WHILE (v_i > 0) LOOP

              SELECT table_name
                INTO v_name_50
                FROM t#op_query_deal_data_tmp_name
               WHERE TO_NUMBER(num) = v_n_50
                 AND recd_type = '50';
              v_sql   := ' insert into t#op_query_deal_data_tmp1  ' ||
                         'select /*+index(' || v_name_50 ||
                         ') */ case when pay_type=''05'' then ''01≥ˆ’æ∆±∑¢ €'' ' ||
                         'when  pay_type = ''00'' then ''01≥ˆ’æ∆±∑¢ €'' ' ||
                         'else ''01µ•≥Ã∆±∑¢ €'' end,' ||
                         'card_logical_id,sale_datetime,line_id,station_id,sale_fee,0,' || --20161013 deposit_fee≥…±æ—∫ΩΩ∂Ó∏ƒŒ™sale_feeΩª“◊Ω∂Ó
                         'device_id,dev_type_id,card_main_id,card_sub_id,operator_id,''0000'',0,0,0,'''' ' ||
                         'from acc_st_his.' || v_name_50 || '    where ';
              v_sql_1 := ' card_logical_id = ''' || in_logi_id ||
                         ''' and  (sale_datetime between to_date(''' ||
                         in_start_time ||
                         ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                         in_end_time || ''',''yyyy_mm_dd hh24:mi:ss'') ) ';
              EXECUTE IMMEDIATE v_sql || v_sql_1;

              v_i    := v_i - 1;
              v_n_50 := v_n_50 - 1;
            END LOOP;
          END;
        END IF;
      END;

      DBMS_OUTPUT.PUT_LINE('50≤È—ØΩ¯’æ∆±-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;

    -------------------3∑«µ•≥Ã∆±∑¢ €
    IF (in_deal_type = '%' OR in_deal_type = '51') THEN
      BEGIN
        --≤È—Øst_his_sale
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_his_sale) */
           '01∑«µ•≥Ã∆±∑¢ €',
           card_logical_id,
           sale_datetime,
           line_id,
           station_id,
           deposit_fee,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_his_sale
           WHERE sale_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
        --≤È—Øst_que_sale
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_que_sale) */
           '01∑«µ•≥Ã∆±∑¢ €',
           card_logical_id,
           sale_datetime,
           line_id,
           station_id,
           deposit_fee,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_que_sale
           WHERE sale_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
      END;
      --≤È—Øacc_st.st_mb_que_sale
      INSERT INTO t#op_query_deal_data_tmp1
        SELECT /*+index(acc_st.st_mb_que_sale) */
         '01∑«µ•≥Ã∆±∑¢ €',
         card_logical_id,
         sale_datetime,
         line_id,
         station_id,
         deposit_fee,
         0,
         device_id,
         dev_type_id,
         card_main_id,
         card_sub_id,
         operator_id,
         '0000',
         0,
         0,
         0,
         ''
          FROM acc_st.st_mb_que_sale
         WHERE sale_datetime BETWEEN
               TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
               TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
           AND card_logical_id = in_logi_id;
      --   ≤È—Ø   acc_st_his.st_mb_his_sale
      INSERT INTO t#op_query_deal_data_tmp1
        SELECT /*+index(acc_st_his.st_mb_his_sale) */
         '01∑«µ•≥Ã∆±∑¢ €',
         card_logical_id,
         sale_datetime,
         line_id,
         station_id,
         deposit_fee,
         0,
         device_id,
         dev_type_id,
         card_main_id,
         card_sub_id,
         operator_id,
         '0000',
         0,
         0,
         0,
         ''
          FROM acc_st_his.st_mb_his_sale
         WHERE sale_datetime BETWEEN
               TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
               TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
           AND card_logical_id = in_logi_id;
      DBMS_OUTPUT.PUT_LINE('51∑«µ•≥Ã∆±∑¢ €-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------4 Ω¯’æº«¬º
    IF (in_deal_type = '%' OR in_deal_type = '53') THEN
      begin
        --≤È—Øst_his_entry
        insert into t#op_query_deal_data_tmp1
          select /*+index(st_his_entry) */
           '01Ω¯’æº«¬º',
           card_logical_id,
           entry_datetime,
           line_id,
           station_id,
           0,
           balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           '000000',
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from st_his_entry
           where

           card_logical_id = in_logi_id
           and (entry_datetime between
           to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
           to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

        --≤È—Øst_que_entry
        insert into t#op_query_deal_data_tmp1
          select /*+index(st_que_entry) */
           '01Ω¯’æº«¬º',
           card_logical_id,
           entry_datetime,
           line_id,
           station_id,
           0,
           balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           '000000',
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from st_que_entry
           where card_logical_id = in_logi_id
             and (entry_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

      end;

      begin
        SELECT COUNT(*)
          INTO v_i
          FROM t#op_query_deal_data_tmp_name
         WHERE recd_type = '53';
      EXCEPTION
        WHEN OTHERS THEN
          v_i := null;
      end;
      begin
        -------’“≥ˆ◊Ó–¬µƒ¿˙ ∑±Ì
        SELECT table_name, TO_NUMBER(num)
          INTO v_name_53, v_n_53
          FROM t#op_query_deal_data_tmp_name
         WHERE num = (SELECT MAX(num)
                        FROM t#op_query_deal_data_tmp_name
                       WHERE recd_type = '53')
           AND recd_type = '53';
      EXCEPTION
        WHEN OTHERS THEN
          v_name_53 := null;
          v_n_53    := null;
      end;
      IF (v_name_53 IS NOT NULL) THEN
        BEGIN
          WHILE (v_i > 0) LOOP
            begin
              SELECT table_name
                INTO v_name_53
                FROM t#op_query_deal_data_tmp_name
               WHERE TO_NUMBER(num) = v_n_53
                 AND recd_type = '53';
            EXCEPTION
              when others then
                v_name_53 := null;
            end;
            if (v_name_53 is not null) then
              v_sql := ' insert into t#op_query_deal_data_tmp1  ' ||
                       'select /*+index(' || v_name_53 ||
                       ') */ ''01Ω¯’æº«¬º'',card_logical_id,entry_datetime,line_id,station_id,0,balance_fee,' ||
                       'device_id,dev_type_id,card_main_id,card_sub_id,''000000'',' ||
                       ' ''0000'',0,0,0 ,card_expired_flag ' ||
                       'from acc_st_his.' || v_name_53 || '    where ';

              v_sql_1 := '  card_logical_id = ''' || in_logi_id ||
                         ''' and   (entry_datetime between to_date(''' ||
                         in_start_time ||
                         ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                         in_end_time || ''',''yyyy_mm_dd hh24:mi:ss'') ) ';
              EXECUTE IMMEDIATE v_sql || v_sql_1;
            end if;
            v_i    := v_i - 1;
            v_n_53 := v_n_53 - 1;
          END LOOP;
        END;
      END IF;

      DBMS_OUTPUT.PUT_LINE('53≤È—ØΩ¯’æº«¬º-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    end if;
    -------------------5 «Æ∞¸Ωª“◊
    IF (in_deal_type = '%' OR in_deal_type = '54') THEN
      begin
        --≤È—Øst_his_deal
        insert into t#op_query_deal_data_tmp1
          select /*+index(st_his_deal) */
           case
             when pay_mode_id = '14' then
              '01∆±ø®≥‰÷µ'
             when pay_mode_id = '18' then
              '01∆±ø®≥Â’˝'
             when pay_mode_id in ('1A', '4A') then
              '01∆±ø®∏¸–¬'
             else
              '01≥ˆ’æø€∑—'
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from st_his_deal
           where card_logical_id = in_logi_id
             and (deal_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));
        --≤È—Øst_que_deal
        insert into t#op_query_deal_data_tmp1
          select /*+index(st_que_deal) */
           case
             when pay_mode_id = '14' then
              '01∆±ø®≥‰÷µ'
             when pay_mode_id = '18' then
              '01∆±ø®≥Â’˝'
             when pay_mode_id in ('1A', '4A') then
              '01∆±ø®∏¸–¬'
             else
              '01≥ˆ’æø€∑—'
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from st_que_deal
           where card_logical_id = in_logi_id
             and (deal_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));
        --≤È—Øacc_st.st_mb_que_deal
        insert into t#op_query_deal_data_tmp1
          select /*+index(acc_st.st_mb_que_deal) */
           case
             when pay_mode_id = '14' then
              '01∆±ø®≥‰÷µ'
             when pay_mode_id = '18' then
              '01∆±ø®≥Â’˝'
             when pay_mode_id in ('1A', '4A') then
              '01∆±ø®∏¸–¬'
             else
              '01≥ˆ’æø€∑—'
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from acc_st.st_mb_que_deal
           where card_logical_id = in_logi_id
             and (deal_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));
        --≤È—Øacc_st_his.st_mb_his_deal
        insert into t#op_query_deal_data_tmp1
          select /*+index(acc_st_his.st_mb_his_deal) */
           case
             when pay_mode_id = '14' then
              '01∆±ø®≥‰÷µ'
             when pay_mode_id = '18' then
              '01∆±ø®≥Â’˝'
             when pay_mode_id in ('1A', '4A') then
              '01∆±ø®∏¸–¬'
             else
              '01≥ˆ’æø€∑—'
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from acc_st_his.st_mb_his_deal
           where card_logical_id = in_logi_id
             and (deal_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

    --20170417 add by mqf ≤È—Ø‘∆π∫∆±ª˙µƒ¥¢÷µø®µƒ≥‰÷µ
        --≤È—Øacc_st_his.st_np_his_deal
        insert into t#op_query_deal_data_tmp1
          select
           case
             when pay_mode_id = '14' then
              '01∆±ø®≥‰÷µ'
             when pay_mode_id = '18' then
              '01∆±ø®≥Â’˝'
             when pay_mode_id in ('1A', '4A') then
              '01∆±ø®∏¸–¬'
             else
              '01≥ˆ’æø€∑—'
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from acc_st_his.st_np_his_deal
           where card_logical_id = in_logi_id
             and (deal_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

    --20170417 add by mqf ≤È—Ø‘∆π∫∆±ª˙µƒ¥¢÷µø®µƒ≥‰÷µ
        --≤È—Øacc_st.st_np_que_deal
        insert into t#op_query_deal_data_tmp1
          select
           case
             when pay_mode_id = '14' then
              '01∆±ø®≥‰÷µ'
             when pay_mode_id = '18' then
              '01∆±ø®≥Â’˝'
             when pay_mode_id in ('1A', '4A') then
              '01∆±ø®∏¸–¬'
             else
              '01≥ˆ’æø€∑—'
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from acc_st.st_np_que_deal
           where card_logical_id = in_logi_id
             and (deal_datetime between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss'));

      end;



      begin
        SELECT COUNT(*)
          INTO v_i
          FROM t#op_query_deal_data_tmp_name
         WHERE recd_type = '54';
      EXCEPTION
        WHEN OTHERS THEN
          v_i := null;
      end;
      -------’“≥ˆ◊Ó–¬µƒ¿˙ ∑±Ì
      begin
        SELECT table_name, TO_NUMBER(num)
          INTO v_name, v_n
          FROM t#op_query_deal_data_tmp_name
         WHERE num = (SELECT MAX(num)
                        FROM t#op_query_deal_data_tmp_name
                       WHERE recd_type = '54')
           AND recd_type = '54';
      EXCEPTION
        when others then
          v_name := null;
          v_n    := null;
      end;
      IF (v_name IS NOT NULL) THEN
        BEGIN

          WHILE (v_i > 0) LOOP

            begin
              SELECT table_name
                INTO v_name
                FROM t#op_query_deal_data_tmp_name
               WHERE TO_NUMBER(num) = v_n
                 AND recd_type = '54';
            EXCEPTION
              when others then
                v_name := null;
            end;
            if (v_name is not null) then
              v_sql := ' insert into t#op_query_deal_data_tmp1  ' ||
                       'select /*+index(' || v_name ||
                       ') */ case when pay_mode_id=''14'' then ''01∆±ø®≥‰÷µ'' ' ||
                       'when  pay_mode_id = ''18'' then ''01∆±ø®≥Â’˝'' ' ||
                       'when  pay_mode_id in (''1A'',''4A'') then ''01∆±ø®∏¸–¬'' ' ||
                       'else ''01≥ˆ’æø€∑—'' end' ||


',card_logical_id,deal_datetime,line_id,station_id,deal_fee,deal_balance_fee,device_id,dev_type_id,card_main_id,card_sub_id,operator_id,' ||
                       ' ''0000'',0,0,0 ,card_expired_flag ' ||
                       'from acc_st_his.' || v_name || '    where ';

              v_sql_1 := ' card_logical_id = ''' || in_logi_id ||
                         ''' and  (deal_datetime between to_date(''' ||
                         in_start_time ||
                         ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                         in_end_time || ''',''yyyy_mm_dd hh24:mi:ss'') )  ';
              EXECUTE IMMEDIATE v_sql || v_sql_1;
            end if;
            v_i := v_i - 1;
            v_n := v_n - 1;
          END LOOP;
        END;
      END IF;

      DBMS_OUTPUT.PUT_LINE('54≤È—Ø«Æ∞¸Ωª“◊-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    end if;
    -------------------
    --π´Ωªœ˚∑— 11
    IF (in_deal_type = '%' OR in_deal_type = '11') THEN
      begin
        --≤È—Øst_ext_mtr_his_deal
        insert into t#op_query_deal_data_tmp1
          select /*+index(acc_st_his.st_ext_mtr_his_deal) */
           case
             when pay_mode_id = '11' then
              '11π´Ωªœ˚∑—'
             else
              pay_mode_id
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from acc_st_his.st_ext_mtr_his_deal
           WHERE deal_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;

        --≤È—Øst_ext_mtr_que_deal
        INSERT INTO t#op_query_deal_data_tmp1
          select /*+index(acc_st_his.st_ext_mtr_que_deal) */
           case
             when pay_mode_id = '11' then
              '11π´Ωªœ˚∑—'
             else
              pay_mode_id
           end,
           card_logical_id,
           deal_datetime,
           line_id,
           station_id,
           deal_fee,
           deal_balance_fee,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           card_expired_flag
            from acc_st.st_ext_mtr_que_deal
           WHERE deal_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;


      ----‘ˆº”∑÷±Ì≤È—Øπ¶ƒ‹ 20170222 add by zhouyang
      begin
        SELECT COUNT(*)
          INTO v_i
          FROM t#op_query_deal_data_tmp_name
         WHERE recd_type = '94';
      EXCEPTION
        WHEN OTHERS THEN
          v_i := null;
      end;
      begin
        -------’“≥ˆ◊Ó–¬µƒ¿˙ ∑±Ì
        SELECT table_name, TO_NUMBER(num)
          INTO v_name_94, v_n_94
          FROM t#op_query_deal_data_tmp_name
         WHERE num = (SELECT MAX(num)
                        FROM t#op_query_deal_data_tmp_name
                       WHERE recd_type = '94')
           AND recd_type = '94';
      EXCEPTION
        WHEN OTHERS THEN
          v_name_94 := null;
          v_n_94    := null;
      end;
      IF (v_name_94 IS NOT NULL) THEN
        BEGIN
          WHILE (v_i > 0) LOOP
            begin
              SELECT table_name
                INTO v_name_94
                FROM t#op_query_deal_data_tmp_name
               WHERE TO_NUMBER(num) = v_n_94
                 AND recd_type = '94';
            EXCEPTION
              when others then
                v_name_94 := null;
            end;
            if (v_name_94 is not null) then
              v_sql := ' insert into t#op_query_deal_data_tmp1  ' ||
                       'select /*+index(' || v_name_94 ||
                       ') */ ''11π´Ωªœ˚∑—'' ' ||


',card_logical_id,deal_datetime,line_id,station_id,deal_fee,deal_balance_fee,device_id,dev_type_id,card_main_id,card_sub_id,operator_id,' ||
                       ' ''0000'',0,0,0 ,card_expired_flag ' ||
                       'from acc_st_his.' || v_name_94 || '    where ';
              v_sql_1 := ' card_logical_id = ''' || in_logi_id ||
                         ''' and  (deal_datetime between to_date(''' ||
                         in_start_time ||
                         ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                         in_end_time ||''',''yyyy_mm_dd hh24:mi:ss'') )  ';
              EXECUTE IMMEDIATE v_sql || v_sql_1;
            end if;
            v_i    := v_i - 1;
            v_n_94 := v_n_94 - 1;
          END LOOP;
        END;
      END IF;

      DBMS_OUTPUT.PUT_LINE('11≤È—Øπ´Ωªœ˚∑—-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
     end;
    end if;

    --------------------------------
    -------------------6 ∆±ø®—”∆⁄
    IF (in_deal_type = '%' OR in_deal_type = '55') THEN

      BEGIN
        --≤È—Øst_his_delay
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_his_delay) */
           '01∆±ø®—”∆⁄',
           card_logical_id,
           operate_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_his_delay
           WHERE operate_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
        --     st_que_delay
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_que_delay) */
           '01∆±ø®—”∆⁄',
           card_logical_id,
           operate_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_que_delay
           WHERE operate_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
      END;

      DBMS_OUTPUT.PUT_LINE('55≤È—Ø∆±ø®—”∆⁄-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------7 ∆±ø®∏¸–¬
    IF (in_deal_type = '%' OR in_deal_type = '56') THEN
      --≤È—Øst_his_update
      insert into t#op_query_deal_data_tmp1
        select /*+index(st_his_update) */
         '01∆±ø®∏¸–¬',
         card_logical_id,
         update_datetime,
         line_id,
         station_id,
         penalty_fee,
         0,
         device_id,
         dev_type_id,
         card_main_id,
         card_sub_id,
         operator_id,
         '0000',
         0,
         0,
         0,
         card_expired_flag
          from st_his_update
         where update_datetime between
               to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
               to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
           and card_logical_id = in_logi_id;

      --≤È—Øst_que_update
      insert into t#op_query_deal_data_tmp1
        select /*+index(st_que_update) */
         '01∆±ø®∏¸–¬',
         card_logical_id,
         update_datetime,
         line_id,
         station_id,
         penalty_fee,
         0,
         device_id,
         dev_type_id,
         card_main_id,
         card_sub_id,
         operator_id,
         '0000',
         0,
         0,
         0,
         card_expired_flag
          from st_que_update
         where update_datetime between
               to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
               to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
           and card_logical_id = in_logi_id;

      SELECT COUNT(*)
        INTO v_i
        FROM t#op_query_deal_data_tmp_name
       WHERE recd_type = '56';
      begin
        SELECT table_name, TO_NUMBER(num)
          INTO v_name_56, v_n_56
          FROM t#op_query_deal_data_tmp_name
         WHERE num = (SELECT MAX(num)
                        FROM t#op_query_deal_data_tmp_name
                       WHERE recd_type = '56')
           AND recd_type = '56';
      EXCEPTION
        when others then
          v_name_56 := null;
          v_n_56    := null;
      end;
      IF (v_name_56 IS NOT NULL) THEN
        BEGIN

          WHILE (v_i > 0) LOOP

            begin
              SELECT table_name
                INTO v_name_56
                FROM t#op_query_deal_data_tmp_name
               WHERE TO_NUMBER(num) = v_n_56
                 AND recd_type = '56';
            EXCEPTION
              when others then
                v_name_56 := null;
            end;
            if (v_name_56 is not null) then
              v_sql := '  insert into t#op_query_deal_data_tmp1' ||
                       ' select /*+index(' || v_name_56 ||
                       ') */ ''01∆±ø®∏¸–¬'',card_logical_id,update_datetime,line_id,station_id,penalty_fee,0,device_id,dev_type_id,card_main_id,card_sub_id,operator_id,' ||
                       ' ''0000'',0,0,0 ,card_expired_flag ' ||
                       ' from acc_st_his.' || v_name_56 || '
                    where  update_datetime between to_date(''' ||
                       in_start_time ||
                       ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                       in_end_time ||
                       ''',''yyyy_mm_dd hh24:mi:ss'')
                            and card_logical_id = ''' ||
                       in_logi_id || '''';

              EXECUTE IMMEDIATE v_sql;
            end if;
            v_i    := v_i - 1;
            v_n_56 := v_n_56 - 1;
          END LOOP;
        END;
      END IF;

      DBMS_OUTPUT.PUT_LINE('56≤È—Ø∆±ø®∏¸–¬-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    end if;
    -------------------
    -------------------8 ÕÀø®º«¬º
    IF (in_deal_type = '%' OR in_deal_type = '57') THEN
      BEGIN
        --≤È—Øst_his_return
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_his_return) */
           '01ÕÀø®º«¬º',
           card_logical_id,
           return_datetime,
           line_id,
           station_id,
           return_balance_fee + return_deposit_fee,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_his_return
           WHERE return_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
        --≤È—Øst_buf_return
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_buf_return) */
           '01ÕÀø®º«¬º',
           card_logical_id,
           return_datetime,
           line_id,
           station_id,
           return_balance_fee + return_deposit_fee,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_buf_return
           WHERE return_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;

        --≤È—Øacc_st_his.st_mb_his_return
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(acc_st_his.st_mb_his_return) */
           '01ÕÀø®º«¬º',
           card_logical_id,
           return_datetime,
           line_id,
           station_id,
           return_balance_fee + return_deposit_fee,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM acc_st_his.st_mb_his_return
           WHERE return_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;

        --≤È—Øacc_st.st_mb_que_return
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(acc_st.st_mb_que_return) */
           '01ÕÀø®º«¬º',
           card_logical_id,
           return_datetime,
           line_id,
           station_id,
           return_balance_fee + return_deposit_fee,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM acc_st.st_mb_que_return
           WHERE return_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;

      END;

      DBMS_OUTPUT.PUT_LINE('57≤È—ØÕÀø®º«¬º-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------9 ∑«º¥ ±ÕÀø®…Í«Îº«¬º
    IF (in_deal_type = '%' OR in_deal_type = '58') THEN
      BEGIN
        --≤È—Øst_his_non_rtn_app
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_his_non_rtn_app) */
           '01∑«º¥ ±ÕÀø®…Í«Î',
           card_logical_id,
           apply_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_his_non_rtn_app
           WHERE apply_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
        --≤È—Øst_que_non_rtn_app
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_que_non_rtn_app) */
           '01∑«º¥ ±ÕÀø®…Í«Î',
           card_logical_id,
           apply_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_que_non_rtn_app
           WHERE apply_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
      END;

      DBMS_OUTPUT.PUT_LINE('58∑«º¥ ±ÕÀø®-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------10 º”/Ω‚À¯
    IF (in_deal_type = '%' OR in_deal_type = '59') THEN
      BEGIN
        --≤È—Øst_his_lock
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_his_lock) */
           '01º”/Ω‚À¯',
           card_logical_id,
           lock_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_his_lock
           WHERE lock_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
        --≤È—Øst_que_lock
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(st_que_lock) */
           '01º”/Ω‚À¯',
           card_logical_id,
           lock_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM st_que_lock
           WHERE lock_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;

        --≤È—Øacc_st_his.st_mb_his_lock
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(acc_st_his.st_mb_his_lock) */
           '01º”/Ω‚À¯',
           card_logical_id,
           lock_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM acc_st_his.st_mb_his_lock
           WHERE lock_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;

        --≤È—Øacc_st.st_mb_que_lock
        INSERT INTO t#op_query_deal_data_tmp1
          SELECT /*+index(acc_st.st_mb_que_lock) */
           '01º”/Ω‚À¯',
           card_logical_id,
           lock_datetime,
           line_id,
           station_id,
           0,
           0,
           device_id,
           dev_type_id,
           card_main_id,
           card_sub_id,
           operator_id,
           '0000',
           0,
           0,
           0,
           ''
            FROM acc_st.st_mb_que_lock
           WHERE lock_datetime BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss')
             AND card_logical_id = in_logi_id;
      END;

      DBMS_OUTPUT.PUT_LINE('59≤È—Øº”Ω‚À¯-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------11 ø®±ªæ‹æ¯
    -- ¥À“µŒÒ“—…æ≥˝

    -------------------
    -------------------12 ≥µ∆±≥ı ºªØ
    IF (in_deal_type = '%' OR in_deal_type = '62') THEN
      BEGIN

      --20170401 add by mqf
      --≤È—Øacc_tk.IC_ES_INITI_INFO
        insert into t#op_query_deal_data_tmp2
          select /*+index(acc_tk.IC_ES_INITI_INFO) */
           '01≥µ∆±≥ı ºªØ',
       a.logical_id,
       a.hdl_time,
       null,
       null,
       a.card_money,
       0,
       null,
       null,
       a.card_main_type,
       a.card_sub_type,
       null,
       a.order_no,
       null
            from acc_tk.IC_ES_INITI_INFO a
           where a.logical_id = in_logi_id
             and a.hdl_time between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss');


        --≤È—Øacc_tk.IC_MB_INITI_INFO
        insert into t#op_query_deal_data_tmp2
          select /*+index(acc_tk.IC_MB_INITI_INFO) */
           '01≥µ∆±≥ı ºªØ',
           a.logical_id,
           a.hdl_time,
           null,
           null,
           a.card_money,
           0,
           null,
           null,
           a.card_main_type,
           a.card_sub_type,
           null,
           a.order_no,
           null
            from acc_tk.IC_MB_INITI_INFO a
           where a.logical_id = in_logi_id
             and a.hdl_time between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss');

        DECLARE
          CURSOR csr IS
            SELECT table_name FROM acc_st.t#op_query_deal_data_tbl_es
        where origin_table_name in ('ic_es_initi_info','ic_mb_initi_info');
        BEGIN
          FOR my_cur IN csr LOOP
            BEGIN
              v_tableName := 'acc_tk.' || my_cur.table_name;
              v_sql       := 'insert into t#op_query_deal_data_tmp2 ' ||
                             'select /*+index(' || v_tableName ||
                             ') */ ''01≥µ∆±≥ı ºªØ'',a.logical_id,a.hdl_time,null,null,a.card_money,0,null,null,a.card_main_type,a.card_sub_type,null,a.order_no,null  ' ||
                             'from ' || v_tableName ||
                             ' a where a.logical_id = ''' || in_logi_id ||
                             ''' and a.hdl_time between to_date(''' ||
                             in_start_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                             in_end_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') ';
              EXECUTE IMMEDIATE v_sql;
            END;
          END LOOP;
        END;
      END;

      DBMS_OUTPUT.PUT_LINE('62≥µ∆±≥ı ºªØ-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------13 ≥µ∆±‘§∏≥÷µ
    IF (in_deal_type = '%' OR in_deal_type = '63') THEN
      BEGIN
      --20170401 add by mqf
      --≤È—Øacc_tk.IC_ES_HUNCH_INFO
        insert into t#op_query_deal_data_tmp2
          select /*+index(acc_tk.IC_ES_HUNCH_INFO) */
            '01≥µ∆±‘§∏≥÷µ',
      a.logical_id,
      a.hdl_time,
      null,
      null,
      a.card_money/100,
      0,
      null,
      null,
      a.card_main_type,
      a.card_sub_type,
      null,
      a.order_no,
      null
            from acc_tk.IC_ES_HUNCH_INFO a
           where a.logical_id = in_logi_id
             and a.hdl_time between
                 to_date(in_start_time, 'yyyy_mm_dd hh24:mi:ss') and
                 to_date(in_end_time, 'yyyy_mm_dd hh24:mi:ss');

        DECLARE
          CURSOR csr IS
            SELECT table_name FROM acc_st.t#op_query_deal_data_tbl_es
        where origin_table_name= 'ic_es_hunch_info';
        BEGIN
          FOR my_cur IN csr LOOP
            BEGIN
              v_tableName := 'acc_tk.' || my_cur.table_name;
              v_sql       := 'insert into t#op_query_deal_data_tmp2  ' ||
                             '  select /*+index(' || v_tableName ||
                             ') */ ''01≥µ∆±‘§∏≥÷µ'',a.logical_id,a.hdl_time,null,null,a.card_money/100,0,' ||
                             'null,null,a.card_main_type,a.card_sub_type,null,a.order_no,null ' ||
                             'from ' || v_tableName ||
                             ' a where
                                            a.logical_id = ''' ||
                             in_logi_id ||
                             '''  and  a.hdl_time between to_date(''' ||
                             in_start_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                             in_end_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') ';
              EXECUTE IMMEDIATE v_sql;
            END;
          END LOOP;
        END;
      END;

      DBMS_OUTPUT.PUT_LINE('63≥µ∆±‘§∏∂÷µ-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------14 ≥µ∆±÷ÿ±‡¬Î
    IF (in_deal_type = '%' OR in_deal_type = '64') THEN
      BEGIN

        INSERT INTO t#op_query_deal_data_tmp2
          SELECT /*+index(acc_tk.ic_es_again_info) */
           '01≥µ∆±÷ÿ±‡¬Î',
           a.logical_id,
           a.hdl_time,
           NULL,
           NULL,
           a.card_money,
           0,
           NULL,
           NULL,
           a.card_main_type,
           a.card_sub_type,
           NULL,
           a.order_no,
           NULL
            FROM acc_tk.ic_es_again_info a
           WHERE a.logical_id = in_logi_id
             AND a.hdl_time BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss');

    --20170411 add by mqf ≤È—ØES¥¢÷µ∆±÷ÿ±‡¬Îº«¬º±Ìic_es_again_info_svt
    INSERT INTO t#op_query_deal_data_tmp2
          SELECT /*+index(acc_tk.ic_es_again_info_svt) */
           '01≥µ∆±÷ÿ±‡¬Î',
           a.logical_id,
           a.hdl_time,
           NULL,
           NULL,
           a.card_money,
           0,
           NULL,
           NULL,
           a.card_main_type,
           a.card_sub_type,
           NULL,
           a.order_no,
           NULL
            FROM acc_tk.ic_es_again_info_svt a
           WHERE a.logical_id = in_logi_id
             AND a.hdl_time BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss');


    --20170401 add by mqf ic_es_again_info_svt√ª”–∑÷±Ì
      DECLARE
          CURSOR csr IS
            SELECT table_name FROM acc_st.t#op_query_deal_data_tbl_es
        where origin_table_name= 'ic_es_again_info';
        BEGIN
          FOR my_cur IN csr LOOP
            BEGIN
              v_tableName := 'acc_tk.' || my_cur.table_name;
              v_sql       := 'insert into t#op_query_deal_data_tmp2  ' ||
                             '  select /*+index(' || v_tableName ||
                             ') */ ''01≥µ∆±÷ÿ±‡¬Î'',a.logical_id,a.hdl_time,null,null,a.card_money,0,' ||
                             'null,null,a.card_main_type,a.card_sub_type,null,a.order_no,null ' ||
                             'from ' || v_tableName ||
                             ' a where
                                            a.logical_id = ''' ||
                             in_logi_id ||
                             '''  and  a.hdl_time between to_date(''' ||
                             in_start_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                             in_end_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') ';
              EXECUTE IMMEDIATE v_sql;
            END;
          END LOOP;
        END;

      END;



      DBMS_OUTPUT.PUT_LINE('64≥µ∆±÷ÿ±‡¬Î-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    -------------------15 ≥µ∆±◊¢œ˙
    IF (in_deal_type = '%' OR in_deal_type = '65') THEN
      BEGIN

        INSERT INTO t#op_query_deal_data_tmp2
          SELECT /*+index(acc_tk.ic_es_logout_info) */
           '01≥µ∆±◊¢œ˙',
           a.logical_id,
           a.hdl_time,
           NULL,
           NULL,
           a.card_money,
           0,
           NULL,
           NULL,
           a.card_main_type,
           a.card_sub_type,
           NULL,
           a.order_no,
           NULL
            FROM acc_tk.ic_es_logout_info a
           WHERE a.logical_id = in_logi_id
             AND a.hdl_time BETWEEN
                 TO_DATE(in_start_time, 'yyyy_mm_dd hh24:mi:ss') AND
                 TO_DATE(in_end_time, 'yyyy_mm_dd hh24:mi:ss');

    --20170401 add by mqf
      DECLARE
          CURSOR csr IS
            SELECT table_name FROM acc_st.t#op_query_deal_data_tbl_es
        where origin_table_name= 'ic_es_logout_info';
        BEGIN
          FOR my_cur IN csr LOOP
            BEGIN
              v_tableName := 'acc_tk.' || my_cur.table_name;
              v_sql       := 'insert into t#op_query_deal_data_tmp2  ' ||
                             '  select /*+index(' || v_tableName ||
                             ') */ ''01≥µ∆±◊¢œ˙'',a.logical_id,a.hdl_time,null,null,a.card_money,0,' ||
                             'null,null,a.card_main_type,a.card_sub_type,null,a.order_no,null ' ||
                             'from ' || v_tableName ||
                             ' a where
                                            a.logical_id = ''' ||
                             in_logi_id ||
                             '''  and  a.hdl_time between to_date(''' ||
                             in_start_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') and to_date(''' ||
                             in_end_time ||
                             ''',''yyyy_mm_dd hh24:mi:ss'') ';
              EXECUTE IMMEDIATE v_sql;
            END;
          END LOOP;
        END;

      END;

      DBMS_OUTPUT.PUT_LINE('65≤È—Ø≥µ∆±◊¢œ˙-' || 'µ±«∞ ±º‰£∫' ||
                           to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                           'œ˚∫ƒ ±º‰£∫' ||
                           (sysdate - v_proBeginTime) * 24 * 60 * 60);
      v_proBeginTime := sysdate;
    END IF;
    -------------------
    ------- ############################# ---------------

    ------- ############################# ---------------

    ------- ############################# ---------------
    --»Á¥Ê‘⁄≥ı ºªØ°¢‘§∏≥÷µ°¢÷ÿ±‡¬Î°¢◊¢œ˙º«¬º∏¸–¬≤Ÿ◊˜‘±°¢œﬂ¬∑°¢≥µ’æ°¢…Ë±∏ID°¢…Ë±∏¿‡–Õ
    SELECT COUNT(*) INTO v_table_count FROM t#op_query_deal_data_tmp2;
    IF (v_table_count > 0) THEN
      BEGIN
        UPDATE t#op_query_deal_data_tmp2 a
           SET (a.operator_id, a.es_samno) =
               (SELECT b.oper_id, b.es_samno
                  FROM acc_tk.ic_pdu_order_form b
                 WHERE a.order_no = b.order_no);
        UPDATE t#op_query_deal_data_tmp2 a
           SET (a.line_id, a.station_id, a.device_id, a.dev_type_id) =
               (SELECT b.line_id, b.station_id, b.device_id, b.dev_type_id
                  FROM t#op_query_deal_data_tmp2 a, op_prm_sam_list b
                 WHERE b.record_flag = '0'
                   AND a.es_samno = b.sam_logical_id);
        --Ω·π˚≤Â»Îtmp1±Ì
        INSERT INTO t#op_query_deal_data_tmp1
          (deal_type,
           logi_id,
           deal_time,
           line_id,
           station_id,
           deal_amount,
           balance,
           device_id,
           dev_type_id,
           card_main_code,
           card_sub_code,
           operator_id,
           limit_month,
           bus_counter,
           metro_counter,
           union_counter)
          SELECT deal_type,
                 logi_id,
                 deal_time,
                 NVL(line_id, ''),
                 NVL(station_id, ''),
                 deal_amount,
                 balance,
                 NVL(device_id, ''),
                 NVL(dev_type_id, ''),
                 card_main_code,
                 card_sub_code,
                 operator_id,
                 '0000',
                 0,
                 0,
                 0
            FROM t#op_query_deal_data_tmp2;
      END;
    END IF;

  --20170401 ∆’Õ®¥¢÷µ∆±÷ÿ”√,…æ≥˝÷ÿ”√µƒ∆’Õ®¥¢∆±µƒæ… ˝æ›
  --¥¢÷µ∆±÷ÿ±‡¬Î ±º‰º«¬º±Ìst_act_svt_again
  delete from acc_st.t#op_query_deal_data_tmp1 a
    where exists (select 1 from acc_st.st_act_svt_again b
              where a.logi_id= b.card_logical_id and a.deal_time < b.again_time);

    ------- ############################# ---------------
    --»Á¥Ê‘⁄≥ˆ’æ∆±∑¢ €º«¬º£¨≈–∂œ «√‚∑—ªπ «∏∂∑—
    begin
      SELECT COUNT(*)
        INTO v_table_count
        FROM t#op_query_deal_data_tmp1
       WHERE deal_type = '01≥ˆ’æ∆±∑¢ €';
    EXCEPTION
      WHEN OTHERS THEN
        v_table_count := 0;
    end;
    IF (v_table_count > 0) THEN
      BEGIN
        UPDATE t#op_query_deal_data_tmp1 a
           SET a.deal_type =
               (SELECT '01√‚∑—≥ˆ’æ∆±∑¢ €'
                  FROM st_his_admin b
                 WHERE a.operator_id = b.operator_id
                   AND a.deal_type = '01≥ˆ’æ∆±∑¢ €'
                   AND a.deal_time = b.admin_datetime
                   AND b.admin_way_id = '02');
        UPDATE t#op_query_deal_data_tmp1 a
           SET a.deal_type =
               (SELECT '01∏∂∑—≥ˆ’æ∆±∑¢ €'
                  FROM st_his_admin b
                 WHERE a.operator_id = b.operator_id
                   AND a.deal_type = '01≥ˆ’æ∆±∑¢ €'
                   AND a.deal_time = b.admin_datetime
                   AND b.admin_way_id = '03');
        UPDATE t#op_query_deal_data_tmp1 a
           SET a.deal_type =
               (SELECT '01√‚∑—≥ˆ’æ∆±∑¢ €'
                  FROM st_que_admin b
                 WHERE a.operator_id = b.operator_id
                   AND a.deal_type = '01≥ˆ’æ∆±∑¢ €'
                   AND a.deal_time = b.admin_datetime
                   AND b.admin_way_id = '02');
        UPDATE t#op_query_deal_data_tmp1 a
           SET a.deal_type =
               (SELECT '01∏∂∑—≥ˆ’æ∆±∑¢ €'
                  FROM st_que_admin b
                 WHERE a.operator_id = b.operator_id
                   AND a.deal_type = '01≥ˆ’æ∆±∑¢ €'
                   AND a.deal_time = b.admin_datetime
                   AND b.admin_way_id = '03');
      END;
    END IF;
    ------- ############################# ---------------
    --∏¸–¬œ‡πÿ◊÷∂Œ
    UPDATE t#op_query_deal_data_tmp1 a
       SET a.card_sub_code =
           (SELECT b.card_sub_name
              FROM op_prm_card_sub b
             WHERE a.card_main_code = b.card_main_id
               AND a.card_sub_code = b.card_sub_id
               AND record_flag = '0');
    UPDATE t#op_query_deal_data_tmp1 a
       SET a.card_main_code =
           (SELECT b.card_main_name
              FROM op_prm_card_main b
             WHERE a.card_main_code = b.card_main_id
               AND record_flag = '0');
    UPDATE t#op_query_deal_data_tmp1 a
       SET a.station_id =
           (SELECT b.chinese_name
              FROM op_prm_station b
             WHERE a.line_id = b.line_id
               AND a.station_id = b.station_id
               AND record_flag = '0');

    UPDATE t#op_query_deal_data_tmp1 a
       SET a.line_id =
           (SELECT b.line_name
              FROM op_prm_line b
             WHERE a.line_id = b.line_id
               AND record_flag = '0');
    UPDATE t#op_query_deal_data_tmp1 a
       SET a.dev_type_id =
           (SELECT b.dev_type_name
              FROM op_prm_dev_type b
             WHERE a.dev_type_id = b.dev_type_id
               AND record_flag = '0');
    --∏¸–¬”≈ª›∆± «∑Òπ˝∆⁄√˚≥∆
    UPDATE t#op_query_deal_data_tmp1
       SET expired_tk = CASE
                          WHEN expired_tk = '0' THEN
                           'Œ¥π˝∆⁄'
                          WHEN expired_tk = '1' THEN
                           '“—π˝∆⁄'
                          ELSE
                           ''
                        END;

    DBMS_OUTPUT.PUT_LINE('%% ˝æ›’˚¿Ì-' || 'µ±«∞ ±º‰£∫' ||
                         to_char(sysdate, 'yyyy_mm_dd hh24:mi:ss') ||
                         'œ˚∫ƒ ±º‰£∫' ||
                         (sysdate - v_proBeginTime) * 24 * 60 * 60);
    v_proBeginTime := sysdate;
    -- final return results
    --SUBSTR(deal_type, LENGTH(deal_type) - 14, LENGTH(deal_type)) AS deal_type
    OPEN out_cur_arg FOR
      SELECT deal_type,
             logi_id,
             deal_time,
             line_id,
             station_id,
             deal_amount,
             balance,
             device_id,
             dev_type_id,
             operator_id,
             card_main_code,
             card_sub_code,
             limit_month,
             bus_counter,
             metro_counter,
             union_counter,
             expired_tk
        FROM t#op_query_deal_data_tmp1
       ORDER BY deal_time, deal_type;
    commit;
    ------- ############################# ---------------
  END;

  --end substr(in_logi_id,4,2)<>'07'
EXCEPTION
  when others then
    begin
      rollback;
      dbms_output.put_line('SQL CODE:' || sqlcode || chr(10) || sqlerrm ||
                           chr(10) ||
                           dbms_utility.format_error_backtrace());
    end;
END;
/
grant execute on ACC_ST.UP_OP_QUERY_DEAL_DATA to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_QUERY_DEAL_DATA to ACC_ST_RPT;


prompt
prompt Creating procedure UP_OP_QUERY_DEV_STATUS
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_OP_QUERY_DEV_STATUS
(in_lineId in varchar,                                                                                                                                                                  
in_stationId in varchar,                                                                                                                                                               
in_devTypeId in varchar,                                                                                                                                                               
in_devId in varchar,                                                                                                                                                                   
in_statusId in varchar,                                                                                                                                                                
in_statusValue in varchar,                                                                                                                                                             
in_iccsStatusValue in varchar,                                                                                                                                                         
in_startTime in varchar,                                                                                                                                                              
in_endTime   in varchar ,
out_cur_arg  out sys_refcursor)

---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_OP_QUERY_DEV_STATUS
  --π¶ƒ‹√Ë ˆ£∫‘À”™÷––ƒ≤È—ØœµÕ≥--…Ë±∏◊¥Ã¨≤È—Ø
  -- ‰≥ˆ≤Œ ˝  : Œﬁ
  --¥¥Ω®’ﬂ£∫ ≈∑—ÙŒ¬‹ﬂ
  --¥¥Ω®»’∆⁄£∫20130802
  --–ﬁ∏ƒ 2014-05-04
  --cm_dev_error_status±Ì‘ˆº””√ªß«∞◊∫acc_commu.cm_dev_error_status
  -------------------------------------------------------------------------------
  
is
v_sql varchar(500)  ;                                                                                                                                                          
v_where varchar(500)  ;                                                                                                                                                        
v_order varchar(500);    

begin

    v_where :=' where A.status_id=B.status_id and A.status_value=B.status_value 
    and A.status_datetime>=to_date('||                                                                       
                   ''''||in_startTime||' 00:00:00'||''''||','||''''||'yyyy_mm_dd hh24:mi:ss'||''''||')'||
                   ' and  A.status_datetime<=to_date('||''''||in_endTime||' 23:59:59'||''''||','||''''||'yyyy_mm_dd hh24:mi:ss' ||''''||')'|| ' and ';                                                               
    
    if(in_lineId is not null ) then
    	v_where:=v_where||' A.line_id='||''''||in_lineId||''''||' and ' ;
    end if;
                                                                               
    if(in_stationId is not null ) then
    	v_where:=v_where||' A.station_id='||''''||in_stationId||''''||' and ' ;
    end if;
                                                                   
    if(in_devTypeId is not null ) then 
    	v_where:=v_where||' A.dev_type_id='||''''||in_devTypeId||''''||' and '  ;
    end if;
                                                                 
    if(in_devId is not null )then 
    	v_where:=v_where||' A.device_id='||''''||in_devId||''''||' and '   ;
    end if;
                                                                              
    if(in_statusId is not null ) then
    	v_where:=v_where||' A.status_id='||''''||in_statusId||''''||' and '   ;
    end if;
                                                                     
    if(in_statusValue is not null ) then 
    	v_where:=v_where||' A.status_value='||''''||in_statusValue||''''||' and '   ;
    end if;
                                                         
    if(in_iccsStatusValue is not null ) then
    	v_where:=v_where||' B.acc_status_value='||''''||in_iccsStatusValue||''''||' and '  ;
    end if;                                     
                                                                                                                                                                                     
    v_where :=substr(v_where,1,length(v_where)-5)  ;                                                                                                                       
                                                                                                                                                                                     
                                                                                                                                                                                     
    v_sql:='select A.line_id,A.station_id,A.dev_type_id,A.device_id,A.status_id,A.status_value, A.status_datetime,B.acc_status_value,B.status_name '                           
                       ||'from acc_commu.cm_dev_error_status A,op_cod_com_status_mapping B '      ;                                                                                                    
    v_sql :=v_sql || v_where ;                                                                                                                                                        
                                                                                                                                                                                     
    --select 'sql:'+@sql                                                                                                                                                             
                                                                                                                                                                                     
    open out_cur_arg for
    v_sql;
    
end;
/
grant execute on ACC_ST.UP_OP_QUERY_DEV_STATUS to ACC_ST_APP;
grant execute on ACC_ST.UP_OP_QUERY_DEV_STATUS to ACC_ST_RPT;


prompt
prompt Creating procedure UP_RP_GET_BAL_WATER_NO
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_rp_get_bal_water_no
(
poRetCode out int,
poRetMsg out varchar2,
poRs      out sys_refcursor
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_rp_get_bal_water_no
--π¶ƒ‹√Ë ˆ£∫ªÒ»°–Ë…˙≥…±®±Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--
-- ‰≥ˆ poRs£∫–Ú¡–µƒΩ·π˚ºØ;poRetCode£∫0£∫≥…π¶£ª poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20131128
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄:
--–ﬁ∏ƒ’ﬂ:
-------------------------------------------------------------------------------
as
num int;
begin
   poRetCode :=0;
   poRetMsg :='≤Ÿ◊˜≥…π¶';
   --≈–∂œµ±«∞«ÂÀ„¡˜ÀÆ±Ì «∑Ò”–«ÂÀ„ÕÍ≥…º«¬º£¨»Á”–£¨‘⁄±®±Ì¡˜ÀÆ÷–≤ª¥Ê‘⁄£¨≤Â»Î“ªÃıº«¬ºµΩ±®±Ì¡˜ÀÆ÷–
   select count(*) into num from st_sys_flow_current
                            where finish_flag='1' and step='69';
   if(num =1 ) then
   begin
      select count(*) into num from st_sys_flow_report A ,st_sys_flow_current B
                               where A.balance_water_no=B.BALANCE_WATER_NO and
                       B.finish_flag='1' and B.step='69';
    if(num =0 ) then
      begin
         insert into ST_SYS_FLOW_REPORT(BALANCE_WATER_NO,FINISH_FLAG,START_DATETIME)
             select distinct BALANCE_WATER_NO,'0',sysdate() from st_sys_flow_current ;
      end;
    end if;
   end;
   end if;
   -----------------------------------------------------------------------
  --»°±®±Ì¡˜ÀÆµƒ◊Ó–°¡˜ÀÆ∫≈
   open poRs for select min(BALANCE_WATER_NO) BALANCE_WATER_NO from st_sys_flow_report
                                                               where finish_flag='0';
   commit;
   exception
     when others then
   begin
    poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
   end;
end;
/
grant execute on ACC_ST.UP_RP_GET_BAL_WATER_NO to ACC_ST_APP;


prompt
prompt Creating procedure UP_RP_GET_PERIOD
prompt ===================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_rp_get_period
(
piBalanceWaterNo in varchar2,
piperiod_detail_type in varchar2,
--piGenerateDay in varchar2,
poRetCode out int,
poRetMsg out varchar2,
poRs      out sys_refcursor
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_rp_get_period
--π¶ƒ‹√Ë ˆ£∫ªÒ»°–Ë…˙≥…±®±ÌµƒÕ≥º∆÷‹∆⁄
-- ‰»Î£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈£ªpiperiod_detail_type£∫±®±Ì◊”÷‹∆⁄ 1£∫πÃ∂® ±º‰∂Œ 2£∫∑«πÃ∂® ±º‰∂Œ
--      piGenerateDay:±®±Ìµƒ…˙≥… ±º‰µ„
-- ‰≥ˆ poRs£∫÷‹∆⁄¿‡–Õ£¨ø™ º°¢Ω· ¯»’∆⁄Ω·π˚ºØ;poRetCode£∫0£∫≥…π¶£ª poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20170303
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄:
--–ﬁ∏ƒ’ﬂ:
-------------------------------------------------------------------------------
as
bYear varchar2(4);--±®±ÌÕ≥º∆ø™ ºƒÍ
bMonth varchar2(2);--±®±ÌÕ≥º∆ø™ º‘¬
bDay   varchar2(2);--±®±ÌÕ≥º∆ø™ º»’
eYear varchar2(4);--±®±ÌÕ≥º∆Ω· ¯ƒÍ
eMonth varchar2(2);--±®±ÌÕ≥º∆Ω· ¯‘¬
eDay   varchar2(2);--±®±ÌÕ≥º∆Ω· ¯»’
dayBal  varchar2(2);--«ÂÀ„»’
dateBal date;--«ÂÀ„ƒÍ‘¬
dateOtherMonth date;--¡Ì“ª∏ˆ‘¬
reportBeginDay varchar2(2);--±®±Ìø™ º»’
reportEndDay varchar2(2);--±®±ÌΩ· ¯»’
monthBeginDay varchar2(2);--◊‘»ª‘¬ø™ º»’
monthEndDay varchar2(2);--◊‘»ª‘¬Ω· ¯»’
begin
  poRetCode :=0;
  poRetMsg :='≤Ÿ◊˜≥…π¶';
  dayBal :=substr(piBalanceWaterNo,7,2);
  reportBeginDay :='26';
  reportEndDay :='25';
  monthBeginDay :='01';

  dbms_output.put_line(dayBal);
--÷‹∆⁄¿‡–Õ1£∫25»’…˙≥…ªÚ√øÃÏ£∫«ÂÀ„»’£∫<=25 …œ‘¬26-±æ‘¬+«ÂÀ„»’  ; «ÂÀ„»’£∫>25 ±æ‘¬26-œ¬‘¬+±æ«ÂÀ„»’
   delete from acc_st.op_report_period;
   if(piperiod_detail_type = '1' or piperiod_detail_type = '*' ) then
   begin
      select to_date(substr(piBalanceWaterNo,1,8),'yyyymmdd') into dateBal from dual;
      select add_months(dateBal,-1) into dateOtherMonth from dual;
      select to_char(dateOtherMonth,'yyyy'),to_char(dateOtherMonth,'mm'),reportBeginDay into bYear,bMonth,bDay from dual;
      select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),reportEndDay into  eYear,eMonth,eDay from dual;

       --dbms_output.put_line(bYear||','||bMonth||','||bDay);
      insert into acc_st.op_report_period(period_detail_type,begin_date,end_date)
                           values('1',bYear||bMonth||bDay,eYear||eMonth||eDay);
   end;
   end if;
 --÷‹∆⁄¿‡–Õ2£∫√øÃÏ…˙≥…£∫«ÂÀ„»’£∫>=26 ±æ‘¬26-±æ‘¬«ÂÀ„»’  ; <26 …œ‘¬26-±æ‘¬«ÂÀ„»’
   if(piperiod_detail_type = '2' or piperiod_detail_type = '*') then
   begin
      select to_date(substr(piBalanceWaterNo,1,8),'yyyymmdd') into dateBal from dual;

      if(dayBal < reportBeginDay) then
         select add_months(dateBal,-1) into dateOtherMonth from dual;
         select to_char(dateOtherMonth,'yyyy'),to_char(dateOtherMonth,'mm'),reportBeginDay into bYear,bMonth,bDay from dual;
         select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),dayBal into  eYear,eMonth,eDay from dual;
         --dbms_output.put_line(to_char(dateOtherMonth,'yyyymmdd'));
      else
         select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),reportBeginDay into  bYear,bMonth,bDay from dual;         select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),dayBal into eYear,eMonth,eDay from dual;
      end if;
      insert into acc_st.op_report_period(period_detail_type,begin_date,end_date)
                           values('2',bYear||bMonth||bDay,eYear||eMonth||eDay);
   end;
   end if;

   --÷‹∆⁄¿‡–Õ3£∫‘¬ƒ©…˙≥…£∫±®±Ì÷‹∆⁄£∫±æ◊‘»ª‘¬1»’-   ±æ◊‘»ª‘¬◊Ó∫Û“ªÃÏ
   if(piperiod_detail_type = '3' or piperiod_detail_type = '*') then
   begin
      select to_date(substr(piBalanceWaterNo,1,8),'yyyymmdd') into dateBal from dual;

      if(dayBal < reportBeginDay) then
         select add_months(dateBal,-1) into dateOtherMonth from dual;
         select to_char(dateOtherMonth,'yyyy'),to_char(dateOtherMonth,'mm'),reportBeginDay into bYear,bMonth,bDay from dual;
         select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),dayBal into  eYear,eMonth,eDay from dual;
         --dbms_output.put_line(to_char(dateOtherMonth,'yyyymmdd'));
      else
         select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),monthBeginDay into  bYear,bMonth,bDay from dual;         select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),dayBal into eYear,eMonth,eDay from dual;
      end if;

      select to_date(substr(piBalanceWaterNo,1,6)||'01','yyyymmdd') into dateBal from dual;
      select add_months(dateBal,1) into dateOtherMonth from dual;

      select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),monthBeginDay into  bYear,bMonth,bDay from dual;
      --◊‘»ª‘¬µƒ‘¬ƒ©=œ¬‘¬µƒ1∫≈-1µƒ»’∆⁄
      select substr(piBalanceWaterNo,1,4),substr(piBalanceWaterNo,5,2),to_char(dateOtherMonth-1,'dd') into eYear,eMonth,
             eDay from dual;

      insert into acc_st.op_report_period(period_detail_type,begin_date,end_date)
                           values('3',bYear||bMonth||bDay,eYear||eMonth||eDay);
   end;
   end if;



   open poRs for select period_detail_type,begin_date,end_date from acc_st.op_report_period;

   commit;
   exception
   when others then
   begin
     poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
     rollback;
   end;
end;
/
grant execute on ACC_ST.UP_RP_GET_PERIOD to ACC_ST_APP;
grant execute on ACC_ST.UP_RP_GET_PERIOD to ACC_ST_RPT;


prompt
prompt Creating procedure UP_SETTLE_CLRALL_TEST
prompt ========================================
prompt
create or replace procedure acc_st.UP_Settle_clrAll_Test
is
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚:    UP_Settle_clrAll_Test
  --π¶ƒ‹:      «Â∑÷œµÕ≥«Â¿Ì»´≤ø ˝æ›£®Ω˜…˜ π”√£©
  --¥¥Ω®’ﬂ£∫   fengzhiguang
  --¥¥Ω®»’∆⁄£∫ 20140309
  -- ‰≥ˆ:      Œﬁ
  --≤‚ ‘∞Ê
  -------------------------------------------------------------------------------
begin
  --«Â≥˝«Â∑÷œµÕ≥µƒ»´≤ø ˝æ›
  --µ•≥Ã∆±∑¢ €
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_sale_sjt';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_sale_sjt';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_sale_sjt';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_sale_sjt';
--∑«µ•≥Ã∆±∑¢ €
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_sale';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_sale';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_sale';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_sale';
--Ω¯’æ
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_entry';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_entry';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_entry';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_entry';
--«Æ∞¸Ωª“◊
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_deal';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_deal';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_deal';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_deal';
--∏¸–¬
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_update';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_update';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_update';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_update';
--—”∆⁄
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_delay';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_delay';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_delay';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_delay';
--ÕÀøÓ
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_return';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_return';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_return';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_return';
--À¯ø®
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_lock';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_lock';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_lock';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_lock';
--º«√˚ø®…Í«Î
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_sign_card_apply';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_sign_card_apply';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_sign_card_apply';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_sign_card';
--∑«º¥ ±ÕÀøÓ…Í«Î
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_buf_non_rtn_app';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_non_rtn_app';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_non_rtn_app';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_non_rtn_app';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_non_rtn';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_non_return_tk_hist';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_non_return_tk_trans_hist';


--––’˛¥¶¿Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_buf_admin';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_que_admin';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_err_admin';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_admin';

--BOM∞‡¥Œ ˝æ›
--ª∫¥Ê±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_buf_bom_shift_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_SALE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_CHARGE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_UPDATE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_ADMIN';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_DELAY';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_RETURN';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_RTN_NON';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_RTN_APP';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_CHG_UPD';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_BUF_BOM_SHIFT_UNLOCK';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_que_bom_shift_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_SALE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_CHARGE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_UPDATE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_ADMIN';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_DELAY';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_RETURN';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_RTN_NON';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_RTN_APP';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_CHG_UPD';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_BOM_SHIFT_UNLOCK';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_err_bom_shift_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_SALE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_CHARGE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_UPDATE';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_ADMIN';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_DELAY';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_RETURN';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_RTN_NON';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_RTN_APP';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_CHG_UPD';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_BOM_SHIFT_UNLOCK';
--¿˙ ∑±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_sale';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_charge';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_update';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_admin';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_delay';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_return';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_rtn_non';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_rtn_app';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_chg_upd';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_his_bom_shift_unlock';

-----------------------------------------------------------

--TVM”≤±“œ‰ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_coin_data';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_coin_data';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_coin_data';

---------------------------------------------------------------
--TVM÷Ω±“±“œ‰ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_note_data';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_note_data';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_note_data';
-----------------------------------------------------------------------------
--TVM”≤±“¥Ê»Î ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_coin_put';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_coin_put';


--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_coin_put';
-------------------------------------------------------------------------------------------
--TVM”≤±“«Âø’ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_coin_clear';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_coin_clear';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_coin_clear';



-----------------------------------------------------------------------------------------------
--TVM∆±ø®¥Ê»Î ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_card_put';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_card_put';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_card_put';



-----------------------------------------------------------------------------------------------------
--TVM∆±ø®«Âø’ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_card_clear';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_card_clear';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_card_clear';
-----------------------------------------------------------------------------------------
--TVM∑œ∆±œ‰ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_tvm_waste_card_data';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_waste_card_data';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_tvm_waste_card_data';

--TVM¿˙ ∑±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_tvm_note_data';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_coin_data';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_coin_put';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_coin_clear';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_card_put';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_card_clear';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_waste_card_data';

---------------------------------------------------------------------------------------
--AGM∆±œ‰ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_buf_agm_card_data';
--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_agm_card_data';
--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_agm_card_data';
--¿˙ ∑±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_agm_card_data';



--------------------------------------------------------------------------------------
--ºƒ¥Ê∆˜ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_BUF_REG_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_BUF_REG_dtl';

--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_REG_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_REG_dtl';

--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_REG_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_REG_dtl';

--¿˙ ∑±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_his_reg_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_his_reg_dtl';
---------------------------------------------------------------------------

--AGM…Ûº∆ ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_BUF_agm_cutoff_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_BUF_agm_cutoff_dtl';

--∂”¡–±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_agm_cutoff_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_agm_cutoff_dtl';

--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_agm_cutoff_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_agm_cutoff_dtl';

--¿˙ ∑±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_his_agm_cutoff_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_his_agm_cutoff_dtl';
------------------------------------------------------------------------------------------------

--TVM…Ûº∆ ˝æ›

EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_BUF_TVM_CUTOFF_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_BUF_TVM_CUTOFF_DTL';

--∂”¡–±Ì

EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_TVM_CUTOFF_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_TVM_CUTOFF_DTL';


--¥ÌŒÛ±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_TVM_CUTOFF_TOTAL';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_TVM_CUTOFF_DTL';

--¿˙ ∑±Ì
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_his_tvm_cutoff_total';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_his_tvm_cutoff_dtl';


------lcc∂‘’À ˝æ›
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_buf_lcc';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_que_lcc';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE ST_err_lcc';


--------------------------------------Œƒº˛---------------------------------------
--Ω” ’µƒΩª“◊ ’“ÊŒƒº˛
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_log_ftp_put_file';

--Ω” ’µƒOCTΩª“◊ ’“ÊŒƒº˛
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_log_ftp_put_file_OCT';

--–£—ÈÕÍ≥…µƒµƒΩª“◊ ’“ÊŒƒº˛
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_log_file_passed';

--–£—ÈÕÍ≥…µƒµƒOCTΩª“◊ ’“ÊŒƒº˛
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_log_file_passed_oct';
--–£—È“Ï≥£Œƒº˛
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_data_file';
--–£—È“Ï≥£Œƒº˛OCT
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_data_file_oct';


--lili°Øs TABLE£ª
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_log_balance';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_balance_waiting';

 ----------------------------Õ≥º∆÷–º‰±Ì---------
  --ƒ⁄≤ø«ÂÀ„
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_balance_line';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_income_contc_card';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_dispart_contc';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_dispart_line';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_contc_trd';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_line_trd';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_contc_inc';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_line_inc';

  --Õ‚≤ø«ÂÀ„
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_diff_analysis';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_ext_oct_audit_balance';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_ext_oct_err_trade';

  --øÕ¡˜
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_change';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_change_income';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_station';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_line_card';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_line_pass';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_average_distance';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_change';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_od_card';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_od_line';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_od_card_zone';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_realflow_section';

  -- ’“Ê
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_sale';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_fare';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_balance';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_update';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_return';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_consume';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_charge';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_station';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_balance_expired';

  --lcc∂‘’À
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_acc';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_lcc_acc';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_buf_lcc';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_que_lcc';
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  ST_err_lcc';

  --…Ûº∆°¢“Ï≥£Õ≥º∆
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_collect_status';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_except_balance';

  --”‡∂Ó∆Ω∫‚
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_act_svt';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_balance_cal';

  --sam∂œ∫≈÷ÿ∫≈∑÷Œˆ
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_sam_water';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_sam_water';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_act_sam';

  --ºƒ¥Ê∆˜ ˝æ›
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_reg_gate';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_reg_tvm';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_reg_bom';

  ---√˚µ•π‹¿Ì”Î«ÂÀ„∫Û–¯
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_prm_black_list_mtr';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_prm_black_list_mtr_sec';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_non_return_tk_hist';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_non_return_tk_trans_hist';

--∏¸–¬µƒ¿˙ ∑±Ì
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_his_black_list_mtr';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_his_black_list_mtr_sec';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_act_svt';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_act_sam';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_non_rtn';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_trx_history';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_rpt_history';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_card_check_result';

--------------------------------------Œƒº˛---------------------------------------
--Ω” ’µƒΩª“◊ ’“ÊŒƒº˛
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE   st_log_ftp_put_file';
--Ω” ’µƒOCTΩª“◊ ’“ÊŒƒº˛
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_log_ftp_put_file_OCT';

--–£—ÈÕÍ≥…µƒµƒΩª“◊ ’“ÊŒƒº˛
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_log_file_passed';

--–£—ÈÕÍ≥…µƒµƒOCTΩª“◊ ’“ÊŒƒº˛
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_log_file_passed_oct';
--–£—È“Ï≥£Œƒº˛
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_err_data_file';
--–£—È“Ï≥£Œƒº˛OCT
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE  st_err_data_file_oct';




-------------------------------------¡˜≥Ã---------------------------------------
--EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sys_flow_current;

update st_sys_flow_current set finish_flag='0' ;
update st_sys_flow_current set error_code='00' , finish_flag='0',begin_time=null,end_time=null where to_number(step)>=30;
commit;


  dbms_output.PUT_LINE('Success Del The Settle''''s Date');
end;
/
grant execute on ACC_ST.UP_SETTLE_CLRALL_TEST to ACC_ST_APP;


prompt
prompt Creating procedure UP_SETTLE_CLR_TEST
prompt =====================================
prompt
create or replace procedure acc_st.UP_Settle_clr_Test
is
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚:    UP_Settle_clr_Test
  --π¶ƒ‹:      «Â∑÷œµÕ≥«Â¿Ì«Â∑÷ ˝æ›£®Ω˜…˜ π”√£©
  --¥¥Ω®’ﬂ£∫   fengzhiguang
  --¥¥Ω®»’∆⁄£∫ 20140309
  -- ‰≥ˆ:      Œﬁ
  --≤‚ ‘∞Ê
  -------------------------------------------------------------------------------
begin
  --«Â≥˝«Â∑÷œµÕ≥µƒ»´≤ø ˝æ›

 EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_log_balance';
 EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_balance_waiting';
 update st_sys_flow_current set error_code='00' , finish_flag='0',begin_time=null,end_time=null where to_number(step)>=30;


  --«Æ∞¸Ωª“◊
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_deal';

  --Ω¯’æº«¬º
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_entry';
  --∏¸–¬
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_update';

  --µ•≥Ã∆± €∆±
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_sale_sjt';
  -- €∆±
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_sale';

  --ÕÀø®
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_return';

  --∑«º¥ ±ÕÀøÓ…Í«Î
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_non_rtn_app';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_non_rtn';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_non_return_tk_hist';

  --∆±ø®—”∆⁄
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_delay';

  --À¯ø®
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_lock';
  --––’˛¥¶¿Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_admin';

  --º«√˚ø®

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_sign_card';

  --π´Ωªicø®«Æ∞¸Ωª“◊∂”¡–±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_deal_oct';

  --π´Ωª €ø®Ωª“◊

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_sale_oct';

  --“¯¡™ø®«Æ∞¸Ωª“◊∂”¡–±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_deal_bank';

  ----------------- ’“Ê ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_total';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑¢ €£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_sale';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰÷µ£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_charge';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®∏¸–¬£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_update';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®––’˛¥¶¿Ì£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_admin';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®—”∆⁄£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_delay';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_return';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_rtn_non';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ…Í«Î£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_rtn_app';
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰’˝£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_chg_upd';

  --bom∞‡¥Œ ˝æ›√˜œ∏£®Ω‚À¯£©ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_bom_shift_unlock';

  --tvm÷Ω±“œ‰ ˝æ›ª∫¥Ê±Ì

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_note_data';

  --tvm”≤±“œ‰ ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_coin_data';

  --tvm”≤±“œ‰¥Ê»Î ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_coin_put';

  --tvm”≤±“œ‰«Âø’ ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_coin_clear';

  --tvm∆±œ‰¥Ê»Î ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_card_put';

  --tvm∆±œ‰«Âø’ ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_card_clear';

  --tvm∑œ∆±œ‰ ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_tvm_waste_card_data';

  --agm∆±œ‰ ˝æ›

  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_agm_card_data';

  ----------------------------Õ≥º∆÷–º‰±Ì---------
  --ƒ⁄≤ø«ÂÀ„
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_balance_line';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_income_contc_card';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_dispart_contc';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_dispart_line';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_contc_trd';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_line_trd';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_contc_inc';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_balance_line_inc';

  --Õ‚≤ø«ÂÀ„
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_diff_analysis';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_ext_oct_audit_balance';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_ext_oct_err_trade';

  --øÕ¡˜
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_change';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_change_income';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_station';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_line_card';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_line_pass';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_average_distance';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_flw_change';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_od_card';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_od_line';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_od_card_zone';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_realflow_section';

  -- ’“Ê
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_sale';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_fare';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_balance';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_update';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_return';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_consume';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_charge';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_station';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_inc_balance_expired';

  --lcc∂‘’À
EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_acc';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_lcc_acc';

  --…Ûº∆°¢“Ï≥£Õ≥º∆
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_collect_status';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_except_balance';

  --”‡∂Ó∆Ω∫‚
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_act_svt';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_balance_cal';

  --sam∂œ∫≈÷ÿ∫≈∑÷Œˆ
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_err_sam_water';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_list_sam_water';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_act_sam';

  --ºƒ¥Ê∆˜ ˝æ›
  --EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_reg_data';
  --EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_que_reg_data_add';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_reg_gate';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_reg_tvm';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_sts_reg_bom';

  ---√˚µ•π‹¿Ì”Î«ÂÀ„∫Û–¯
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_prm_black_list_mtr';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_prm_black_list_mtr_sec';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_non_return_tk_hist';

--∏¸–¬µƒ¿˙ ∑±Ì
  --EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_prm_black_his_mtr';
  --EXECUTE   IMMEDIATE   'TRUNCATE   TABLE op_prm_black_his_mtr_sec';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_act_svt';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE st_his_non_rtn';
  EXECUTE   IMMEDIATE   'TRUNCATE   TABLE OP_NON_RETURN_TK_TRANS_HIST';
commit;


  dbms_output.PUT_LINE('Success Del The Settle''''s Date');
end;
/
grant execute on ACC_ST.UP_SETTLE_CLR_TEST to ACC_ST_APP;


prompt
prompt Creating procedure UP_SR_GET_OD_PROPORTION
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_SR_GET_OD_PROPORTION(P_RESULT              OUT INTEGER,
                                                    P_ERRMSG              out varchar2)

---------------------------------------------------------------------------------
--π˝≥Ã√˚:  UP_SR_GET_OD_PROPORTION
--œµÕ≥£∫«Â∑÷πÊ‘ÚœµÕ≥
--π¶ƒ‹: ”…OD¬∑æ∂±Ì ˝æ›…˙≥…ODœﬂ¬∑»®÷ÿ±Ì ˝æ›
--∑µªÿΩ·π˚¥˙¬Î£∫P_RESULT
-------------------------------------------------------------------------------

AS
  V_PROPORTION_PERCENT     INTEGER; --¡Ÿ ± ±»¿˝∑ß÷µ
  TMP_VERSION              VARCHAR(12);

BEGIN

  -- «Â¿Ì¡Ÿ ±±Ì
  delete T#SR_MIN_AVG_DISTANCE;

  select to_char(sysdate,'yyyyMMddhh24mi') into TMP_VERSION from dual;

  -- ±»¿˝∑ß÷µ
  select t.distance_thres into V_PROPORTION_PERCENT from sr_params_threshold t where t.record_flag='0' and rownum=1;

  -- ≤Â»Î∑÷◊È ˝æ›∫Õ◊Ó∂Ã¿Ô≥Ã¬∑æ∂µΩ¡Ÿ ±±Ì
  INSERT INTO T#SR_MIN_AVG_DISTANCE (o_line_id, o_station_id, e_line_id, e_station_id,min_distance)
  select o_line_id, o_station_id, e_line_id, e_station_id,min(distance)
    from sr_distance_od
    where nvl(distance,0) <> 0 and record_flag='0' --∑« ªª≥À’æµΩµΩªª≥À’æ
    group by o_line_id, o_station_id, e_line_id, e_station_id;


  -- ∏¸–¬∆Ωæ˘¬∑æ∂¿Ô≥ÃµΩ¡Ÿ ±±Ì
  INSERT INTO T#SR_MIN_AVG_DISTANCE (o_line_id, o_station_id, e_line_id, e_station_id, min_distance, avg_distance)
  select a.o_line_id, a.o_station_id, a.e_line_id, a.e_station_id, b.min_distance, avg(a.distance)
    from sr_distance_od a,T#SR_MIN_AVG_DISTANCE b
    where  nvl(a.distance,0) <> 0 and a.record_flag='0' --∑« ªª≥À’æµΩµΩªª≥À’æ
      and a.o_line_id=b.o_line_id(+) and a.o_station_id = b.o_station_id(+)
      and a.e_line_id = b.e_line_id(+) and a.e_station_id = b.e_station_id(+)
      and (a.distance - b.min_distance)/b.min_distance <= V_PROPORTION_PERCENT
    group by a.o_line_id, a.o_station_id, a.e_line_id, a.e_station_id, b.min_distance;

  -- …æ≥˝◊Ó–°¬∑æ∂¡Ÿ ± ˝æ›
  delete T#SR_MIN_AVG_DISTANCE where avg_distance is null or avg_distance = '';

  -- ∑÷ÃØª˘ ˝
  update sr_distance_od a set a.distance_base = (
    select a.distance + 2 * (b.avg_distance - a.distance)
      from T#SR_MIN_AVG_DISTANCE b
      where a.o_line_id=b.o_line_id(+) and a.o_station_id = b.o_station_id(+)
        and a.e_line_id = b.e_line_id(+) and a.e_station_id = b.e_station_id(+)
        and a.record_flag='0'
        and (a.distance - b.min_distance)/b.min_distance <= V_PROPORTION_PERCENT
   );

  -- ∑÷ÃØ±»¿˝
  begin
    update sr_distance_od a set a.distance_percent = (a.distance_base * a.distance_base * a.distance_base)/(
      select sum(b.distance_base * b.distance_base * b.distance_base)
        from sr_distance_od b
        where b.record_flag='0' and a.id = b.id
        group by b.o_line_id, b.o_station_id, b.e_line_id, b.e_station_id
     );
   EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      P_RESULT := -1;
      DBMS_OUTPUT.PUT_LINE('sqlerrm : ' || SQLERRM);
      P_ERRMSG := SQLCODE || ':' || SQLERRM;
      RETURN;
  end;


  -- œﬂ¬∑»®÷ÿ ≤Â»ÎOD≤ªÕ¨“ªœﬂ¬∑
  update sr_proportion set record_flag = '2' where record_flag = '0'; -- ∏¸–¬‘≠¿¥ ˝æ›Œ™¿˙ ∑∞Ê±æ

  insert into sr_proportion
    (o_line_id, o_station_id, d_line_id, d_station_id, dispart_line_id, in_percent,
     version, record_flag, create_time, create_operator)
  select e.o_line_id, e.o_station_id, e.e_line_id, e.e_station_id, f.pass_line_out, sum(e.distance_percent * f.pass_percent),
         TMP_VERSION, '0', sysdate, 'system'
  from sr_distance_od e, (
     select c.pass_distance/d.sum_distance pass_percent,c.* from sr_distance_change c,(
       select a.od_id,sum(a.pass_distance) sum_distance from sr_distance_change a,sr_distance_od b
       where a.od_id = b.id
       and b.record_flag = '0'
       and b.distance_percent > 0
       and b.o_line_id <> b.e_line_id --OD≤ªÕ¨“ªœﬂ¬∑
       group by a.od_id
       ) d
     where c.od_id = d.od_id) f
   where f.od_id = e.id
  group by e.o_line_id, e.o_station_id, e.e_line_id, e.e_station_id, f.pass_line_out;


  -- ≤Â»ÎODÕ¨“ªœﬂ¬∑ or ªª≥À’æµΩªª≥À’æ (e.o_line_id = e.e_line_id or e.distance = 0)
  insert into sr_proportion
    (o_line_id, o_station_id, d_line_id, d_station_id, dispart_line_id, in_percent,
     version, record_flag, create_time, create_operator)
  select distinct e.o_line_id, e.o_station_id, e.e_line_id, e.e_station_id, e.o_line_id, 1,
         TMP_VERSION, '0', sysdate, 'system'
  from sr_distance_od e
  where e.o_line_id = e.e_line_id or e.distance = 0;

  -- ªª≥À’æµΩªª≥À’æ (e.o_line_id <> e.e_line_id and e.distance = 0)
  insert into sr_proportion
    (o_line_id, o_station_id, d_line_id, d_station_id, dispart_line_id, in_percent,
     version, record_flag, create_time, create_operator)
  select distinct e.o_line_id, e.o_station_id, e.e_line_id, e.e_station_id, e.e_line_id, 0,
         TMP_VERSION, '0', sysdate, 'system'
  from sr_distance_od e
  where e.o_line_id <> e.e_line_id and e.distance = 0;


  -- «Â¿Ì¡Ÿ ±±Ì
  delete T#SR_MIN_AVG_DISTANCE;
  commit;

  select count(1) into P_RESULT from sr_distance_od where record_flag = 0;
  --P_RESULT := 0;
  P_ERRMSG := '…˙≥…œﬂ¬∑»®÷ÿ ˝æ›' || P_RESULT || 'Ãıº«¬º£°';

END UP_SR_GET_OD_PROPORTION;
/
grant execute on ACC_ST.UP_SR_GET_OD_PROPORTION to ACC_ST_APP;


prompt
prompt Creating procedure UP_SR_GET_OD_PROPORTION_CUR
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_SR_GET_OD_PROPORTION_CUR(V_O_LINE_ID           IN  VARCHAR2,--ø™ ºœﬂ¬∑
                                                        V_O_STATION_ID        IN  VARCHAR2,--ø™ º’æµ„
                                                        V_D_LINE_ID           IN  VARCHAR2,--Ω· ¯œﬂ¬∑
                                                        V_D_STATION_ID        IN  VARCHAR2,--Ω· ¯’æµ„
                                                        P_RESULTS             OUT SYS_REFCURSOR,--Ω·π˚ºØ
                                                        P_CODE                OUT INTEGER,--Ω·π˚¥˙¬Î
                                                        P_ERRMSG              out varchar2)--Ω·π˚–≈œ¢

---------------------------------------------------------------------------------
--π˝≥Ã√˚:  UP_SR_GET_OD_PROPORTION_CUR
--œµÕ≥£∫«Â∑÷πÊ‘ÚœµÕ≥
--π¶ƒ‹: ”…OD¬∑æ∂Ãıº˛ µ ±∑µªÿODœﬂ¬∑»®÷ÿ ˝æ›
--∑µªÿΩ·π˚¥˙¬Î£∫P_CODE
-------------------------------------------------------------------------------

AS
  TMP_PROPORTION_PERCENT     INTEGER; --¡Ÿ ± ±»¿˝∑ß÷µ
  TMP_O_LINE_ID              VARCHAR2(2);
  TMP_O_STATION_ID           VARCHAR2(2);
  TMP_D_LINE_ID              VARCHAR2(2);
  TMP_D_STATION_ID           VARCHAR2(2);

BEGIN

  --≥ı ºªØ»Î≤Œ
  if V_O_LINE_ID IS NULL then
     TMP_O_LINE_ID := '';
  ELSE
     TMP_O_LINE_ID := V_O_LINE_ID;
  end if;

  if V_O_STATION_ID IS NULL then
     TMP_O_STATION_ID := '';
  ELSE
     TMP_O_STATION_ID := V_O_STATION_ID;
  end if;

  if V_D_LINE_ID IS NULL then
     TMP_D_LINE_ID := '';
  ELSE
     TMP_D_LINE_ID := V_D_LINE_ID;
  end if;

  if V_D_STATION_ID IS NULL then
     TMP_D_STATION_ID := '';
  ELSE
     TMP_D_STATION_ID := V_D_STATION_ID;
  end if;

  -- «Â¿Ì¡Ÿ ±±Ì
  delete T#SR_MIN_AVG_DISTANCE;

  -- ±»¿˝∑ß÷µ
  select t.distance_thres into TMP_PROPORTION_PERCENT from sr_params_threshold t where t.record_flag='0' and rownum=1;

  -- ≤Â»Î∑÷◊È ˝æ›∫Õ◊Ó∂Ã¿Ô≥Ã¬∑æ∂µΩ¡Ÿ ±±Ì
  INSERT INTO T#SR_MIN_AVG_DISTANCE (o_line_id, o_station_id, e_line_id, e_station_id,min_distance)
  select o_line_id, o_station_id, e_line_id, e_station_id,min(distance)
    from sr_distance_od
    where nvl(distance,0) <> 0 and record_flag='0' --∑« ªª≥À’æµΩµΩªª≥À’æ
          and o_line_id = nvl(TMP_O_LINE_ID,o_line_id)
          and o_station_id = nvl(TMP_O_STATION_ID,o_station_id)
          and e_line_id = nvl(TMP_D_LINE_ID,e_line_id)
          and e_station_id = nvl(TMP_D_STATION_ID,e_station_id)
    group by o_line_id, o_station_id, e_line_id, e_station_id;


  -- ∏¸–¬∆Ωæ˘¬∑æ∂¿Ô≥ÃµΩ¡Ÿ ±±Ì
  INSERT INTO T#SR_MIN_AVG_DISTANCE (o_line_id, o_station_id, e_line_id, e_station_id, min_distance, avg_distance)
  select a.o_line_id, a.o_station_id, a.e_line_id, a.e_station_id, b.min_distance, avg(a.distance)
    from sr_distance_od a,T#SR_MIN_AVG_DISTANCE b
    where  nvl(a.distance,0) <> 0 and a.record_flag='0' --∑« ªª≥À’æµΩµΩªª≥À’æ
      and a.o_line_id=b.o_line_id(+) and a.o_station_id = b.o_station_id(+)
      and a.e_line_id = b.e_line_id(+) and a.e_station_id = b.e_station_id(+)
      and (a.distance - b.min_distance)/b.min_distance <= TMP_PROPORTION_PERCENT
      and a.o_line_id = nvl(TMP_O_LINE_ID,a.o_line_id)
      and a.o_station_id = nvl(TMP_O_STATION_ID,a.o_station_id)
      and a.e_line_id = nvl(TMP_D_LINE_ID,a.e_line_id)
      and a.e_station_id = nvl(TMP_D_STATION_ID,a.e_station_id)
    group by a.o_line_id, a.o_station_id, a.e_line_id, a.e_station_id, b.min_distance;

  -- …æ≥˝◊Ó–°¬∑æ∂¡Ÿ ± ˝æ›
  delete T#SR_MIN_AVG_DISTANCE where avg_distance is null or avg_distance = '';

  -- ∑÷ÃØª˘ ˝
  update sr_distance_od a set a.distance_base = (
    select a.distance + 2 * (b.avg_distance - a.distance)
      from T#SR_MIN_AVG_DISTANCE b
      where a.o_line_id=b.o_line_id(+) and a.o_station_id = b.o_station_id(+)
        and a.e_line_id = b.e_line_id(+) and a.e_station_id = b.e_station_id(+)
        and a.record_flag='0'
        and (a.distance - b.min_distance)/b.min_distance <= TMP_PROPORTION_PERCENT
   );

  -- ∑÷ÃØ±»¿˝
  begin
    update sr_distance_od a set a.distance_percent = (a.distance_base * a.distance_base * a.distance_base)/(
      select sum(b.distance_base * b.distance_base * b.distance_base)
        from sr_distance_od b
        where b.record_flag='0' and a.id = b.id
            and b.o_line_id = nvl(TMP_O_LINE_ID,b.o_line_id)
            and b.o_station_id = nvl(TMP_O_STATION_ID,b.o_station_id)
            and b.e_line_id = nvl(TMP_D_LINE_ID,b.e_line_id)
            and b.e_station_id = nvl(TMP_D_STATION_ID,b.e_station_id)
        group by b.o_line_id, b.o_station_id, b.e_line_id, b.e_station_id
     );
   EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      P_CODE := -1;
      DBMS_OUTPUT.PUT_LINE('sqlerrm : ' || SQLERRM);
      P_ERRMSG := SQLCODE || ':' || SQLERRM;
      RETURN;
  end;

  --Ω´Ω·π˚ºØ∑≈»Î”Œ±Í
  BEGIN
      open P_RESULTS for
          select e.o_line_id, e.o_station_id, e.e_line_id d_line_id, e.e_station_id d_station_id,
                 f.pass_line_out dispart_line_id, round(sum(e.distance_percent * f.pass_percent),5) in_percent
          from sr_distance_od e, (
             select c.pass_distance/d.sum_distance pass_percent,c.* from sr_distance_change c,(
               select a.od_id,sum(a.pass_distance) sum_distance from sr_distance_change a,sr_distance_od b
               where a.od_id = b.id
               and b.record_flag = '0'
               and b.distance_percent > 0
               and b.o_line_id <> b.e_line_id --OD≤ªÕ¨“ªœﬂ¬∑
                and b.o_line_id = nvl(TMP_O_LINE_ID,b.o_line_id)
                and b.o_station_id = nvl(TMP_O_STATION_ID,b.o_station_id)
                and b.e_line_id = nvl(TMP_D_LINE_ID,b.e_line_id)
                and b.e_station_id = nvl(TMP_D_STATION_ID,b.e_station_id)
               group by a.od_id
               ) d
             where c.od_id = d.od_id) f
           where f.od_id = e.id
                  and e.o_line_id = nvl(TMP_O_LINE_ID,e.o_line_id)
                  and e.o_station_id = nvl(TMP_O_STATION_ID,e.o_station_id)
                  and e.e_line_id = nvl(TMP_D_LINE_ID,e.e_line_id)
                  and e.e_station_id = nvl(TMP_D_STATION_ID,e.e_station_id)
          group by e.o_line_id, e.o_station_id, e.e_line_id, e.e_station_id, f.pass_line_out

          union

          -- ≤Â»ÎODÕ¨“ªœﬂ¬∑ or ªª≥À’æµΩªª≥À’æ (e.o_line_id = e.e_line_id or e.distance = 0)
          select distinct e.o_line_id, e.o_station_id, e.e_line_id d_line_id, e.e_station_id d_station_id,
                 e.o_line_id dispart_line_id, 1 in_percent
          from sr_distance_od e
          where (e.o_line_id = e.e_line_id or e.distance = 0)
              and e.o_line_id = nvl(TMP_O_LINE_ID,e.o_line_id)
              and e.o_station_id = nvl(TMP_O_STATION_ID,e.o_station_id)
              and e.e_line_id = nvl(TMP_D_LINE_ID,e.e_line_id)
              and e.e_station_id = nvl(TMP_D_STATION_ID,e.e_station_id)

          union

          -- ªª≥À’æµΩªª≥À’æ (e.o_line_id <> e.e_line_id and e.distance = 0)
          select distinct e.o_line_id, e.o_station_id, e.e_line_id d_line_id, e.e_station_id d_station_id,
                 e.e_line_id dispart_line_id, 0 in_percent
          from sr_distance_od e
          where e.distance = 0 and e.o_line_id <> e.e_line_id
              and e.o_line_id = nvl(TMP_O_LINE_ID,e.o_line_id)
              and e.o_station_id = nvl(TMP_O_STATION_ID,e.o_station_id)
              and e.e_line_id = nvl(TMP_D_LINE_ID,e.e_line_id)
              and e.e_station_id = nvl(TMP_D_STATION_ID,e.e_station_id);
  end;

  -- «Â¿Ì¡Ÿ ±±Ì
  delete T#SR_MIN_AVG_DISTANCE;
  commit;

  P_CODE := 0;
  P_ERRMSG := '≤È—ØµΩœﬂ¬∑»®÷ÿ ˝æ›£°';

END UP_SR_GET_OD_PROPORTION_CUR;
/
grant execute on ACC_ST.UP_SR_GET_OD_PROPORTION_CUR to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_CFG_GETRECORDSEQS
prompt ==========================================
prompt
create or replace procedure acc_st.up_st_cfg_getRecordSeqs
(
pitradTypeId in varchar2 ,
piNum     in int ,
poRs      out sys_refcursor,
poRetCode out int,
poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_cfg_getRecordSeqs
--π¶ƒ‹√Ë ˆ£∫‘§»°ª∫¥Ê±Ìµƒ–Ú¡–∫≈
-- ‰»Î piseqName£∫–Ú¡–±Ì√˚≥∆ piNum£∫‘§»°–Ú¡–µƒ ˝¡ø
-- ‰≥ˆ poRs£∫–Ú¡–µƒΩ·π˚ºØ;poRetCode£∫0£∫≥…π¶£ª poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫2013723
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
sqlStr varchar(100);
n int;
seq number;
seqName varchar(50) ;
begin
   poRetCode :=0;
   poRetMsg :='≤Ÿ◊˜≥…π¶';
   
   select seq_name into seqName from st_cfg_trd_seq where trd_type_id=pitradTypeId;
   
   sqlStr :='select '||seqName||'.nextval from dual';
   --sqlStr :='select :1.nextval from dual';
   dbms_output.put_line(sqlStr);
   n :=0;
   
   --»°µ√–Ú¡–∫≈
   while( n<piNum)
   loop
      --execute immediate sqlStr   into seq using seqName;
	  execute immediate sqlStr  into  seq;
	  
      dbms_output.put_line(seq);
	  
      insert into t#st_cfg_record_seq(seq) values(seq);
     
      n :=n+1;
   end loop;
   --∑µªÿΩ·π˚ºØ
   open poRs for select seq from t#st_cfg_record_seq;
   commit;
--“Ï≥£¥¶¿Ì	  
  exception
     when others then
	 begin		
		poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
	 end;
end;
/
grant execute on ACC_ST.UP_ST_CFG_GETRECORDSEQS to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_DWN_BLACKLIST_SUB_INFO
prompt ===============================================
prompt
create or replace procedure acc_st.up_st_dwn_blacklist_sub_info
(
piParamTypeId in varchar2,
piOperatorId in varchar2,
piVersionNo   in varchar2,
piWaterNo     in int,
poRetCode out int,
poRetMsg  out varchar2
)
is
recordFlag varchar2(1);
handleFlag varchar2(1);
begin
-----------------------------------------≥ı ºªØ
poRetCode :=0;
poRetMsg  :=':≥…π¶≤Œ ˝Õ®÷™';
recordFlag :='0';
handleFlag :='0';
---------------------------------------------------------------------------------------------------------
--…˙≥…≤Œ ˝œ¬∑¢Õ®÷™
--‘ˆº”œ¬∑¢µƒª˘±æ–≈œ¢
insert into op_prm_para_gen_dtl(water_no,version_no,parm_type_id,version_type,gen_result ) 
                    values(piWaterNo,piVersionNo,piParamTypeId,recordFlag,handleFlag);
--‘ˆº”œ¬∑¢µƒœﬂ¬∑–≈œ¢
insert into op_prm_para_inform_dtl(water_no,station_id,line_id,inform_result ) 
                     select piWaterNo,'00',lcc_line_id,handleFlag from ST_COD_LCC_LINE;
--º«¬º≤Œ ˝…˙≥…»’÷æ
--“Ï≥£¥¶¿Ì
-------------------------------------------------------------------------------------------------
  -- commit;
   exception 
   when others then
   begin
      poRetCode :=-1;
	  poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||'£∫¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
   --   rollback;
   end;
end;
/
grant execute on ACC_ST.UP_ST_DWN_BLACKLIST_SUB_INFO to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_DWN_BLACKLIST_SUB_VERS
prompt ===============================================
prompt
create or replace procedure acc_st.up_st_dwn_blacklist_sub_vers
(
piParamTypeId in varchar2,
poVersionNo out varchar,
poRetCode out int,
poRetMsg  out varchar2
)
is
curDate varchar(8);
rowCount int;
seq     varchar(2);
--versionNo varchar(10);
begin
--≥ı ºªØ
poRetCode :=0;
poRetMsg  :=piParamTypeId||':≥…π¶ªÒ»°∞Ê±æ∫≈';
-------------------------------------------------------------------------------------------------
--…˙≥…◊Ó–¬µƒ∫⁄√˚µ•≤Œ ˝∞Ê±æ∫≈
curDate :=to_char(sysdate,'yyyymmdd');
select count(*) into rowCount from OP_PRM_PARA_VER where record_flag='0' and parm_type_id=piParamTypeId and substr(version_no,1,8)=curDate;
if(rowCount=0) then
   begin
      seq :='01';
   end;
else
   begin
      select max(to_number(substr(VERSION_NO,9,2))) into seq from OP_PRM_PARA_VER where record_flag='0' and parm_type_id=piParamTypeId and substr(version_no,1,8)=curDate;
	  seq :=to_number(seq)+1;
	  if(length(seq)=1) then
	  begin
	    seq :='0'||seq;
	  end;
	  end if;
   end;
end if;
poVersionNo :=curDate || seq;
dbms_output.put_line('∞Ê±æ∫≈£∫'||poVersionNo);
---------------------------------------------------------------------------------------------------------------------------------
  -- commit;
   exception 
   when others then
   begin
      poRetCode :=-1;
	  poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||'£∫¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
	  dbms_output.put_line(poRetMsg);
   --   rollback;
   end;
end;
/
grant execute on ACC_ST.UP_ST_DWN_BLACKLIST_SUB_VERS to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_DWN_BLACKLIST
prompt ======================================
prompt
create or replace procedure acc_st.up_st_dwn_blacklist
(
piBalanceWaterNo in varchar,
poRetCode out int,
poRetMsg  out varchar2
)
is
versionNo varchar(10);--≤Œ ˝∞Ê±æ∫≈
paramTypeId varchar(4);--≤Œ ˝¿‡–Õ
recordFlagCur varchar(1);--≤Œ ˝±Í ∂
recordFlagHis varchar(1);--≤Œ ˝±Í ∂
beginTime   date;--≤Œ ˝…˙–ßµƒø™ º ±º‰
endTime     date;--≤Œ ˝…˙–ßµƒΩ· ¯ ±º‰
versionDate date;--∞Ê±æ…˙≥… ±º‰
operatorId  varchar(8);--≤Ÿ◊˜‘±
waterNo int;--≤Œ ˝Õ®÷™¡˜ÀÆ∫≈
distributeTime int;
handleFlag varchar2(1);
remark varchar2(100);
begin
-----------------------------------------≥ı ºªØ
poRetCode :=0;
poRetMsg  :=':≤Œ ˝≥…π¶…˙≥…º∞Õ®÷™';
recordFlagCur :='0';
recordFlagHis :='2';
beginTime :=sysdate;
endTime := beginTime;
versionDate :=beginTime;
operatorId :='system';
distributeTime :=0;
handleFlag :='0';
remark :='«ÂÀ„≥Ã–Ú…˙≥…';
--ªÒ»°œ¬∑¢µƒ¡˜ÀÆ∫≈
update st_water_no set water_no=water_no+1 where water_no_key='param';
select water_no into waterNo from st_water_no where water_no_key='param';
------------------µÿÃ˙∫⁄√˚µ•≤Œ ˝ ˝æ›¥¶¿Ì--------------------------------------------------------
--œ¬∑¢◊‹±Ì
insert into op_prm_para_distribute_dtl(water_no,distribute_datetime,operator_id,distribute_result,DISTRIBUTE_MEMO) 
                           values(waterNo,sysdate,operatorId,handleFlag,remark);
for i in 1..4 loop
  paramTypeId :='060'||i;
  --…˙≥…◊Ó–¬µƒ∫⁄√˚µ•≤Œ ˝∞Ê±æ∫≈
  up_st_dwn_blacklist_sub_vers(paramTypeId,versionNo,poRetCode,poRetMsg);
  dbms_output.put_line(paramTypeId||'∞Ê±æ∫≈£∫'||versionNo);
  --µ«º«œ¬∑¢≤Œ ˝º∞æ…µƒµ±«∞∞Ê±æ±‰∏¸Œ™¿˙ ∑
  update OP_PRM_PARA_VER set RECORD_FLAG=recordFlagHis where PARM_TYPE_ID=paramTypeId and RECORD_FLAG=recordFlagCur;
  insert into OP_PRM_PARA_VER(PARM_TYPE_ID,distribute_times,VERSION_NO,RECORD_FLAG,VERSION_DATE,BEGIN_TIME,END_TIME,OPERATOR_ID)
                     values(paramTypeId,distributeTime,versionNo,recordFlagCur,versionDate,beginTime,endTime,operatorId);
					 
------------------µ±«∞∞Ê±æµº¿˙ ∑±Ì--------------------------------------------
  --µÿÃ˙∫⁄√˚µ•
  if(paramTypeId='0601') then
     insert into OP_PRM_BLACK_LIST_MTR_HIS(CARD_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,
                                         OPERATOR_ID,IS_SET,GEN_DATETIME,CREATE_DATETIME,
									     VERSION_NO,RECORD_FLAG,BALANCE_WATER_NO,OP_TIME)
                            select       CARD_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,
                                         OPERATOR_ID,IS_SET,GEN_DATETIME,CREATE_DATETIME,
									     versionNo,recordFlagCur,piBalanceWaterNo,sysdate
		                                 from OP_PRM_BLACK_LIST_MTR;
  end if;
  --µÿÃ˙∫⁄√˚µ•∂Œ
  if(paramTypeId='0602') then
     insert into OP_PRM_BLACK_LIST_MTR_SEC_HIS(BEGIN_LOGICAL_ID,END_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,
                                         OPERATOR_ID,IS_SET,GEN_DATETIME,CREATE_DATETIME,
									     VERSION_NO,RECORD_FLAG,BALANCE_WATER_NO,OP_TIME)
                            select       BEGIN_LOGICAL_ID,END_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,
                                         OPERATOR_ID,IS_SET,GEN_DATETIME,CREATE_DATETIME,
									     versionNo,recordFlagCur,piBalanceWaterNo,sysdate
		                                 from OP_PRM_BLACK_LIST_MTR_SEC;
  end if;
  --π´Ωª∫⁄√˚µ•
  if(paramTypeId='0603') then
     insert into OP_PRM_BLACK_LIST_OCT_HIS(CARD_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,
                                         OPERATOR_ID,IS_SET,GEN_DATETIME,CREATE_DATETIME,
									     VERSION_NO,RECORD_FLAG,BALANCE_WATER_NO,OP_TIME)
                            select       CARD_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,
                                         OPERATOR_ID,IS_SET,GEN_DATETIME,CREATE_DATETIME,
									     versionNo,recordFlagCur,piBalanceWaterNo,sysdate
		                                 from OP_PRM_BLACK_LIST_OCT;
  end if;
  --π´Ωª∫⁄√˚µ•∂Œ
  if(paramTypeId='0604') then
     insert into OP_PRM_BLACK_LIST_OCT_SEC_HIS(BEGIN_LOGICAL_ID,END_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,CREATE_DATETIME,
                                      GEN_DATETIME,OPERATOR_ID,IS_SET,
                                      VERSION_NO,RECORD_FLAG,BALANCE_WATER_NO,OP_TIME)
                            select    BEGIN_LOGICAL_ID,END_LOGICAL_ID,BLACK_TYPE,ACTION_TYPE,CREATE_DATETIME,
                                      GEN_DATETIME,OPERATOR_ID,IS_SET,
									   versionNo,recordFlagCur,piBalanceWaterNo,sysdate
		                                 from OP_PRM_BLACK_LIST_OCT_SEC;
  end if;
  
  
--…˙≥…≤Œ ˝Õ®÷™°¢≤Œ ˝œ¬∑¢¿‡–Õ
  
  up_st_dwn_blacklist_sub_info(paramTypeId,operatorId,versionNo,waterNo,poRetCode,poRetMsg);
  
end loop;
--º«¬º≤Œ ˝…˙≥…»’÷æ
--“Ï≥£¥¶¿Ì
-------------------------------------------------------------------------------------------------
   commit;
   
   exception 
   when others then
   begin
      poRetCode :=-1;
	  poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||'£∫¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
	  dbms_output.put_line(poRetMsg);
      rollback;
   end;
end;
/
grant execute on ACC_ST.UP_ST_DWN_BLACKLIST to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_EXP_AUS
prompt ================================
prompt
create or replace procedure acc_st.up_st_exp_aus
(
piBalanceWaterNo in varchar,
poRetCode out int,
poRetMsg  out varchar2 ,
poRs      out sys_refcursor
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_exp_aus
--π¶ƒ‹√Ë ˆ£∫±»Ωœ…Ûº∆Œƒº˛”Î≤…ºØ◊¥Ã¨µƒº«¬º ˝º∞Ω∂Ó£¨»∑∂®Œƒº˛µƒ≤…ºØ◊¥Ã¨£¨∑µªÿŒƒº˛µƒ≤…ºØ◊¥Ã¨
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20140424
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄:
--–ﬁ∏ƒ’ﬂ:
-------------------------------------------------------------------------------
is
begin
-----------------------------------------≥ı ºªØ
poRetCode :=0;
poRetMsg :='≤Ÿ◊˜≥…π¶';
----------------------------------------------------
insert into T#ST_UP_ST_EXP_AUS(FILE_STATUS,TOTAL_RECORD_NUM_AUS,TOTAL_RECORD_FEE_AUS,TOTAL_RECORD_NUM_AUF,TOTAL_RECORD_FEE_AUF,
                               BALANCE_WATER_NO,FILE_NAME)
                        select  b.FILE_STATUS,b.TOTAL_RECORD_NUM,b.TOTAL_RECORD_FEE,a.TOTAL_RECORD_NUM,a.TOTAL_RECORD_FEE,
                                b.BALANCE_WATER_NO, b.FILE_NAME_ACC
                        from  st_ext_mtr_audit_file_trx a,st_ext_mtr_audit_status b
                        where a.BALANCE_WATER_NO=b.BALANCE_WATER_NO and a.FILE_NAME_AUDITED=b.FILE_NAME_ACC;

--00£∫Œƒº˛’˝≥£
update T#ST_UP_ST_EXP_AUS set FILE_STATUS='00'
                          where TOTAL_RECORD_NUM_AUS=TOTAL_RECORD_NUM_AUF AND TOTAL_RECORD_FEE_AUS=TOTAL_RECORD_FEE_AUF;
--02£∫Œƒº˛º«¬º ˝≤ª’˝»∑
update T#ST_UP_ST_EXP_AUS set FILE_STATUS='02'
                          where TOTAL_RECORD_NUM_AUS != TOTAL_RECORD_NUM_AUF ;
--03£∫Œƒº˛Ω∂Ó≤ª’˝»∑
update T#ST_UP_ST_EXP_AUS set FILE_STATUS='03'
                          where TOTAL_RECORD_FEE_AUS != TOTAL_RECORD_FEE_AUF;
--04£∫Œƒº˛º«¬º ˝º∞Ω∂Ó≤ª’˝»∑
update T#ST_UP_ST_EXP_AUS set FILE_STATUS='00'
                          where TOTAL_RECORD_NUM_AUS != TOTAL_RECORD_NUM_AUF AND TOTAL_RECORD_FEE_AUS != TOTAL_RECORD_FEE_AUF;

update st_ext_mtr_audit_status a set a.file_status =( select b.file_status from T#ST_UP_ST_EXP_AUS b
                                                            where a.BALANCE_WATER_NO =b.BALANCE_WATER_NO and
                                                                  a.FILE_NAME_ACC =b.file_name
                                                      )
                                  where exists(select b.file_status from T#ST_UP_ST_EXP_AUS b
                                                            where a.BALANCE_WATER_NO =b.BALANCE_WATER_NO and
                                                                  a.FILE_NAME_ACC =b.file_name
                                               );



open poRs for select file_name_acc,file_status from  st_ext_mtr_audit_status;
--“Ï≥£¥¶¿Ì
-------------------------------------------------------------------------------------------------
   commit;

   exception
   when others then
   begin
      poRetCode :=-1;
    poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||'£∫¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
    dbms_output.put_line(poRetMsg);
      rollback;
   end;
end;
/
grant execute on ACC_ST.UP_ST_EXP_AUS to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_EXT_BLACKLIST_TOTAL
prompt ============================================
prompt
create or replace procedure acc_st.up_st_ext_blacklist_total
(
piBalanceWaterNo in varchar2 ,
poRetCode        out int       ,
poRetMsg         out varchar2        
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ext_blacklist_total
--π¶ƒ‹√Ë ˆ£∫ª„◊‹ÀÕ≥ˆ∏¯π´Ωªµƒ∫⁄√˚µ•
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160203
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ√Ë ˆ£∫
--–ﬁ∏ƒ’ﬂ:
------------------------------------------------------------------------------
is
begin
   poRetCode :=0;
   poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo;
   --—°‘Ò≤ª‘⁄∫⁄√˚µ•ª„◊‹±Ìµƒº«¬º≤Â»Îª„◊‹±Ì
   insert into acc_st.ST_EXT_MTR_BLACKLIST_TOTAL(CARD_LOGICAL_ID_START,CARD_LOGICAL_ID_END,SECT_FLAG,
                                                 CARD_STATUS,send_datetime)
                                          select  A.CARD_LOGICAL_ID_START,A.CARD_LOGICAL_ID_END,A.SECT_FLAG,
                                                 A.CARD_STATUS,sysdate
                                                 from acc_st.ST_EXT_MTR_BLACKLIST A
                                                 where A.BALANCE_WATER_NO=piBalanceWaterNo and
                                                       CARD_LOGICAL_ID_START|| CARD_LOGICAL_ID_END||SECT_FLAG
                                                       NOT IN(
                                                              SELECT CARD_LOGICAL_ID_START|| CARD_LOGICAL_ID_END||SECT_FLAG
                                                                     FROM ST_EXT_MTR_BLACKLIST_TOTAL
 
                                                            );
 --◊Ûπÿ¡™   
/*                                                       
   insert into acc_st.ST_EXT_MTR_BLACKLIST_TOTAL(CARD_LOGICAL_ID_START,CARD_LOGICAL_ID_END,SECT_FLAG,
                                                 CARD_STATUS,send_datetime)
                                         select  A.CARD_LOGICAL_ID_START,A.CARD_LOGICAL_ID_END,A.SECT_FLAG,
                                                 A.CARD_STATUS,sysdate
                                                 from acc_st.ST_EXT_MTR_BLACKLIST A,acc_st.ST_EXT_MTR_BLACKLIST_TOTAL B
                                                 where A.BALANCE_WATER_NO=piBalanceWaterNo and
                                                       A.CARD_LOGICAL_ID_START = B.CARD_LOGICAL_ID_START                                                       (+) AND
                                                       A.CARD_LOGICAL_ID_END = B.CARD_LOGICAL_ID_END(+) AND
                                                       A.SECT_FLAG = B.SECT_FLAG(+) and
                                                       not exists 
                                                       (
                                                         select 1 from acc_st.ST_EXT_MTR_BLACKLIST_TOTAL
                                                                  where A.CARD_LOGICAL_ID_START = B.CARD_LOGICAL_ID_START                                                                         AND
                                                                        A.CARD_LOGICAL_ID_END = B.CARD_LOGICAL_ID_END AND
                                                                        A.SECT_FLAG = B.SECT_FLAG
                                                        );
                                                        
   */
   COMMIT;
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
   
end;
/
grant execute on ACC_ST.UP_ST_EXT_BLACKLIST_TOTAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_ID_NON_RETURN
prompt ======================================
prompt
create or replace procedure acc_st.up_st_id_non_return(o_id out int) --ª·ª∞id
  -------------------------------------------------------------------------------
  --π˝≥Ã√˚    up_st_id_non_return
  --π¶ƒ‹√Ë ˆ£∫∑«º¥ ±ÕÀøÓ¡¨Ω”¥¶¿Ì±Í ∂
  -- ‰»Î≤Œ ˝£∫

  --∑µªÿ÷µ£∫±Í ∂

  --¥¥Ω®’ﬂ£∫  ∫ŒΩ®æ¸
  --¥¥Ω®»’∆⁄£∫20110620
  --–ﬁ∏ƒ»’∆⁄£∫

  -------------------------------------------------------------------------------

 as
  v_temp_counts int;
begin
  select count(id) into v_temp_counts from st_id_non_rtn;
  if v_temp_counts = 0 then
    insert into st_id_non_rtn (id) values (1);
  end if;

  select id into o_id from st_id_non_rtn;
  update st_id_non_rtn set id = id + 1;

end up_st_id_non_return;
/
grant execute on ACC_ST.UP_ST_ID_NON_RETURN to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_GEN_NON_RETURN_LIST
prompt ================================================
prompt
create or replace procedure acc_st.up_st_ist_gen_non_return_list(out_retresult out integer, --∑µªÿΩ·π˚
                                                          out_msg       out varchar2, --∑µªÿ–≈œ¢
                                                          in_logical_id varchar2,
                                                          in_balance_water_no varchar2)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_st_ist_gen_non_return_list
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫≤˙…˙∑«º¥ ±ÕÀøÓΩª“◊º«¬º
  -- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_logical_id “™≤˙…˙Ωª“◊º«¬ºµƒø®∫≈
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --deal_typeΩª“◊¿‡–ÕÀµ√˜
  --1£∫≥ˆ’æ
  --2£∫Ω¯’æ
  --3£∫ €∆±
  --4£∫∏¸–¬
  --5£∫ÕÀøÓ
  --6: ≥‰÷µ
  --7: ‘§∏≥÷µ
  --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
  --–ﬁ∏ƒ£∫--ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
         --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
         --ver1.41 ‘ˆº”π´Ωª∑÷±Ì≤È—Ø on 20170310 by lindaquan
         --ver1.42 ¥¢÷µ∆±÷ÿ”√π˝¬Àæ…ø®–≈œ¢ on 20170407 by lindaquan
  -------------------------------------------------------------------------------
 as
  v_msg varchar(200);
  v_his_name       varchar(80); --µ±«∞¿˙ ∑±Ì√˚
  v_que_name       varchar(80); --∂”¡–±Ì√˚
  v_sql            varchar(2000); --º«¬º ˝
  v_sql_his        varchar(2000); --¥”¿˙ ∑±Ì≤Â»Î”Ôæ‰
  v_sql_err        varchar(2000); --¥”¥ÌŒÛ±Ì≤Â»Î”Ôæ‰
  v_sql_oct_err    varchar(2000); --¥”π´Ωª¥ÌŒÛ±Ì≤Â»Î”Ôæ‰
  v_count          number(18);
  v_num            number(1);
  v_recd_type      char(2);
  v_again_time     date;--¥¢÷µ∆±÷ÿ”√◊Ó¥Û…˙–ß ±º‰
begin
  select count(*) into v_count from op_non_return_tk_hist where card_logical_id = in_logical_id;
  if v_count>0 then
   return;
  end if;
 --‘ˆº”2014-3-7 «Âø’¡Ÿ ±±Ì
  delete   t#ist_gen_non_return_list_his;
  delete   t#ist_non_return_list_tab;
  delete   t#ist_gen_non_return_list_ret;
  -----¿˙ ∑À˜“˝±Ì÷–’“≥ˆdata_type='trx' and recd_type='54'\'53'\'56' µƒÀ˘”–º«¬ºµΩ¡Ÿ ±±Ì÷–
   v_recd_type:='54';
   v_num:=1;
--—≠ª∑≤Â»Î«Æ∞¸Ωª“◊°¢Ω¯’æ°¢∏¸–¬°¢es‘§∏≥÷µµƒº«¬º
  while v_num<=4 loop
     delete t#ist_non_return_list_tab;
     --≤È—ØΩª“◊º«¬ºµƒsql”Ôæ‰
    if v_num = 1 then   --≥ˆ’æ
       v_recd_type := '54';v_his_name:='acc_st_his.st_his_deal';v_que_name:='st_que_deal';
       v_sql_his:='select card_physical_id,card_logical_id,device_id,deal_datetime,pay_mode_id,deal_fee , receipt_id ,tac,line_id ,station_id  ,
                   deal_balance_fee ,balance_water_no ,entry_datetime ,''1'',''0'',card_main_id , card_sub_id ,sysdate ,
                   case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end   from
                   cur_table where card_logical_id='''||in_logical_id||'''
                   and  exists (select * from cur_table where card_logical_id='''||in_logical_id ||''')';
       v_sql_err:='select card_physical_id,card_logical_id,device_id,deal_datetime,pay_mode_id,deal_fee, receipt_id ,tac,line_id ,station_id  ,
                   deal_balance_fee  ,balance_water_no ,entry_datetime, ''1'',''3'',card_main_id , card_sub_id ,sysdate ,
                   case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end
                   from  st_err_deal_unique where  card_logical_id='''||in_logical_id||'''';
       v_sql_oct_err:='select card_physical_id,card_logical_id,device_id,to_date(deal_datetime,''yyyy-mm-dd HH24:mi:ss''),pay_mode_id,deal_fee, receipt_id ,tac,line_id ,station_id  ,
                   deal_balance_fee  ,balance_water_no ,to_date(entry_datetime,''yyyy-mm-dd HH24:mi:ss''), ''1'',''3'',card_main_id , card_sub_id ,sysdate ,
                   case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end
                   from  st_ext_mtr_err_deal where  card_logical_id='''||in_logical_id||'''';
      elsif v_num = 2 then  --Ω¯’æ
        v_recd_type := '53';v_his_name:='acc_st_his.st_his_entry';v_que_name:='st_que_entry';
        v_sql_his:='select card_physical_id,card_logical_id,device_id,entry_datetime,card_status_id,0, null ,null,line_id ,station_id  ,
                   balance_fee ,balance_water_no ,  entry_datetime , ''2'',''0'' , card_main_id , card_sub_id ,sysdate  ,
                  case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end from
                  cur_table where card_logical_id=''' ||in_logical_id || '''
                  and  exists (select * from cur_table where card_logical_id='''||in_logical_id ||''')';
       v_sql_err:='select card_physical_id,card_logical_id,device_id,entry_datetime,card_status_id,0,null,null,line_id ,station_id  ,
                  balance_fee ,balance_water_no ,entry_datetime,''2'',''3'',card_main_id , card_sub_id ,sysdate ,
                case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end from
                  st_err_entry_unique  where card_logical_id=''' ||in_logical_id || '''';
      elsif v_num=3 then  --∏¸–¬
         v_recd_type:='56';v_his_name:='acc_st_his.st_his_update';v_que_name:='st_que_update';
         v_sql_his:='select card_physical_id,card_logical_id,device_id,update_datetime,card_status_id,penalty_fee, null ,null,line_id ,station_id  ,
                  balance_fee ,balance_water_no ,  update_datetime , ''4'',''0'' ,card_main_id , card_sub_id ,sysdate ,
                  case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end   from
                 cur_table where  card_logical_id = '''||in_logical_id||'''
                 and  exists (select * from cur_table where card_logical_id='''||in_logical_id ||''')';
        v_sql_err:='select card_physical_id,card_logical_id,device_id,update_datetime,card_status_id,penalty_fee, null ,null,line_id ,station_id  ,
                balance_fee,balance_water_no ,update_datetime,''4'',''3'' , card_main_id , card_sub_id ,sysdate ,
                case when card_main_id = ''03'' then tct_valid_days else null end,case when card_main_id = ''03'' then tct_activate_datetime else null end  from
                st_err_update_unique where card_logical_id = '''||in_logical_id|| '''';
      elsif v_num=4 then  --es‘§∏∂÷µ
         v_recd_type:='99';
         v_his_name:='acc_tk.ic_es_hunch_info';
         v_sql_his:='select phy_id,logical_id,''0000'',manu_time,''04'',card_money/100,null ,null,line_code ,station_code  ,
              card_money/100,'''',manu_time,''7'',''0'',card_main_type,card_sub_type ,sysdate,nvl(to_number(card_ava_days),null),null from
              cur_table  where  logical_id = '''||in_logical_id||'''';
     end if;
     insert into t#ist_non_return_list_tab values(v_his_name);
      if v_num=4 then
        v_msg := '≤Â»Î±Ìt#ist_non_return_list_tab±ÌES‘§∏∂÷µ±Ì√˚';
        insert into t#ist_non_return_list_tab select 'acc_tk.'||his_table from acc_tk.ic_idx_history
           where substr(his_table, 1, 16) = 'ic_es_hunch_info';
     else
        v_msg := '≤Â»Î±Ìt#ist_non_return_list_tab∂”¡–±Ì√˚';
        insert into t#ist_non_return_list_tab values(v_que_name);
        v_msg := '≤Â»Î±Ìt#ist_non_return_list_tab¿˙ ∑±Ì√˚';
        insert into t#ist_non_return_list_tab select 'acc_st_his.'||table_name from  st_idx_trx_history
               where data_type = 'trx' and recd_type = v_recd_type ;
        if v_num=1 then --ø€÷µº”…œπ´Ωªœ˚∑—±Ì2014-6-16
           insert into t#ist_non_return_list_tab values('st_ext_mtr_que_deal');
           insert into t#ist_non_return_list_tab values('acc_st_his.st_ext_mtr_his_deal');
           --≤È—Øπ´Ωªœ˚∑—∑÷±Ì ver1.41 20170310 by lindaquan
           insert into t#ist_non_return_list_tab select 'acc_st_his.'||table_name from  st_idx_trx_history
                  where data_type = 'trx' and recd_type = '94' ;
        end if;
     end if;
     v_sql_his := 'insert into t#ist_gen_non_return_list_his '||v_sql_his;
     declare cursor cu_table is select table_name from  t#ist_non_return_list_tab ;
     begin
       for my_cur in cu_table loop
           v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒ'||my_cur.table_name||'Ωª“◊ ˝æ›';
           v_sql_his:=replace(v_sql_his,'cur_table',my_cur.table_name);
           execute immediate v_sql_his;
           v_sql_his:=replace(v_sql_his,my_cur.table_name,'cur_table');
        end loop;
     end;
    if v_num<>4 then
       v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒ'||v_recd_type||'¥ÌŒÛΩª“◊ ˝æ›';
       v_sql_err := 'insert into t#ist_gen_non_return_list_his ' ||v_sql_err ;
       execute immediate v_sql_err;
       if v_num=1 then --ø€÷µº”…œπ´Ωª¥ÌŒÛœ˚∑—
           v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒ'||v_recd_type||'Õ‚≤ø¥ÌŒÛΩª“◊ ˝æ›';
           v_sql_err := 'insert into t#ist_gen_non_return_list_his ' ||v_sql_oct_err ;
           execute immediate v_sql_err;
       end if;
     end if;
     v_num:=v_num+1;
  end loop;
  --51 €∆±º«¬º
  v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒ∑¢ €¿˙ ∑ ˝æ›';
  insert into t#ist_gen_non_return_list_his
  select card_physical_id,card_logical_id,device_id,sale_datetime,'04',deposit_fee, null,null,line_id ,station_id  ,
         0 ,balance_water_no ,sale_datetime , '3','0' ,card_main_id , card_sub_id ,sysdate ,null,null
   from acc_st_his.st_his_sale where card_logical_id=in_logical_id ;
  v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒ∑¢ €∂”¡– ˝æ›';
  insert into t#ist_gen_non_return_list_his
  select card_physical_id,card_logical_id,device_id,sale_datetime,'04',deposit_fee, null,null,line_id ,station_id  ,
         0 ,balance_water_no ,sale_datetime , '3','0' ,card_main_id , card_sub_id ,sysdate ,null,null
   from st_que_sale where card_logical_id=in_logical_id ;

  v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒ∑¢ €¥ÌŒÛ ˝æ›';
  insert into t#ist_gen_non_return_list_his
  select card_physical_id, card_logical_id, device_id,sale_datetime,'04',deposit_fee, null,null,
   line_id, station_id,0, balance_water_no,sale_datetime,'3','3',card_main_id,card_sub_id,sysdate,null, null
  from st_err_sale where card_logical_id=in_logical_id and err_code !='42';

   --57ÕÀø®º«¬º
  v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒÕÀøÓ¿˙ ∑ ˝æ›';
  insert into t#ist_gen_non_return_list_his
  select card_physical_id,card_logical_id,device_id,return_datetime,card_status_id,return_balance_fee, null,null,line_id ,station_id  ,
         0 ,balance_water_no ,return_datetime , '5','0' ,card_main_id , card_sub_id ,sysdate ,null,null
   from acc_st_his.st_his_return where card_logical_id=in_logical_id;
  v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒÕÀøÓ∂”¡– ˝æ›';
  insert into t#ist_gen_non_return_list_his
  select card_physical_id,card_logical_id,device_id,return_datetime,card_status_id,return_balance_fee, null,null,line_id ,station_id  ,
         0 ,balance_water_no ,return_datetime , '5','0' ,card_main_id , card_sub_id ,sysdate ,null,null
   from st_que_return where card_logical_id=in_logical_id ;

   v_msg := '≤Â»Î±Ìt#ist_gen_non_return_list_hisµƒÕÀøÓ¥ÌŒÛ ˝æ›';
   insert into t#ist_gen_non_return_list_his
   select card_physical_id,card_logical_id,device_id,return_datetime,card_status_id,return_balance_fee, null,null,line_id ,station_id  ,
         0 ,balance_water_no ,return_datetime , '5','3' ,card_main_id , card_sub_id ,sysdate,null,null
   from st_err_return where card_logical_id=in_logical_id and err_code !='42';
  --≥‰÷µ
   update t#ist_gen_non_return_list_his  set deal_type='6' where pay_mode_id='14';
   --∏¸–¬
   update t#ist_gen_non_return_list_his  set deal_type='4' where pay_mode_id ='1A' ;
   update t#ist_gen_non_return_list_his  set deal_type='4' where pay_mode_id ='1B';
   --Ω¯’æ
   update t#ist_gen_non_return_list_his  set deal_type='2' where pay_mode_id ='11' ;
   update t#ist_gen_non_return_list_his  set deal_type='1' where pay_mode_id ='1C' ;
  --∆±ø®µƒº«¬º≤È—ØÕÍ±œ£¨Ω´º«¬º±£¥ÊµΩ±Ìop_non_return_tk_trans_hist÷–£¨“‘±„∫Û≤È
    delete from op_non_return_tk_trans_hist where card_logical_id=in_logical_id;
   v_msg := ' ˝æ›≤Â»Î±Ìop_non_return_tk_trans_hist';
   --ver1.42 ¥¢÷µ∆±÷ÿ”√π˝¬Àæ…ø®–≈œ¢
   select max(again_time) into v_again_time from acc_st.st_act_svt_again where card_logical_id=in_logical_id;
   if v_again_time is not null then
      insert into op_non_return_tk_trans_hist
        select card_physical_id ,  card_logical_id ,device_id,deal_datetime,substr(pay_mode_id,1,2) ,deal_fee ,receipt_id ,tac ,
          line_id ,station_id ,deal_balance ,balance_water_no,entry_datetime ,deal_type ,red_flag ,card_main_id ,
          card_sub_id ,gen_time ,tct_valid_days ,tct_activate_time ,in_balance_water_no
        from t#ist_gen_non_return_list_his
          where deal_datetime>v_again_time
          order by deal_datetime desc;
   else
      insert into op_non_return_tk_trans_hist
        select card_physical_id ,  card_logical_id ,device_id,deal_datetime,substr(pay_mode_id,1,2) ,deal_fee ,receipt_id ,tac ,
          line_id ,station_id ,deal_balance ,balance_water_no,entry_datetime ,deal_type ,red_flag ,card_main_id ,
          card_sub_id ,gen_time ,tct_valid_days ,tct_activate_time ,in_balance_water_no
        from t#ist_gen_non_return_list_his order by deal_datetime desc;
   end if;
  --∆±ø®µƒº«¬º…æ≥˝÷˜º¸÷ÿ∏¥ ˝æ›£¨±£¥ÊµΩop_non_return_tk_hist÷–
   v_msg := ' ˝æ›≤Â»Î±Ìt#ist_gen_non_return_list_ret';
   if v_again_time is not null then
      insert into t#ist_gen_non_return_list_ret
      select seq_t#ist_gen_non_retlist_ret.nextval,card_physical_id,card_logical_id,device_id,deal_datetime,pay_mode_id,deal_fee,
        receipt_id,tac,line_id,station_id,deal_balance,balance_water_no,entry_datetime,
        deal_type,red_flag,card_main_id,card_sub_id,gen_time,tct_valid_days,tct_activate_time
      from t#ist_gen_non_return_list_his where deal_datetime>v_again_time;
    else
      insert into t#ist_gen_non_return_list_ret
      select seq_t#ist_gen_non_retlist_ret.nextval,card_physical_id,card_logical_id,device_id,deal_datetime,pay_mode_id,deal_fee,
        receipt_id,tac,line_id,station_id,deal_balance,balance_water_no,entry_datetime,
        deal_type,red_flag,card_main_id,card_sub_id,gen_time,tct_valid_days,tct_activate_time
      from t#ist_gen_non_return_list_his;
    end if;
   --Ω¯’æ
   v_msg := '∏¸–¬◊Ó∫Û“ªÃıΩ¯’æ—’…´';
  update t#ist_gen_non_return_list_ret a set a.red_flag='1'
  where  a.deal_type='2' and a.deal_datetime=
  (select max(deal_datetime) from t#ist_gen_non_return_list_ret b where b.deal_type='2' and b.red_flag<>'3'
   and b.card_logical_id=a.card_logical_id)
   and exists (select 1 from t#ist_gen_non_return_list_ret b where b.deal_type='2' and b.red_flag<>'3'
   and b.card_logical_id=a.card_logical_id);
 --∏¸–¬ÕÀøÓº«¬º
   v_msg := '∏¸–¬◊Ó∫Û“ªÃıÕÀøÓ—’…´';
  update t#ist_gen_non_return_list_ret a set red_flag='2'
  where a.deal_type='5' and a.deal_datetime=
  (select max(deal_datetime) from t#ist_gen_non_return_list_ret b where b.deal_type='5' and b.red_flag<>'3'
  and  b.card_logical_id=a.card_logical_id)
  and exists (select 1 from t#ist_gen_non_return_list_ret b where b.deal_type='5' and b.red_flag<>'3'
  and  b.card_logical_id=a.card_logical_id);

    delete from op_non_return_tk_hist where card_logical_id=in_logical_id;
   v_msg := ' ˝æ›≤Â»Î±Ìop_non_return_tk_hist';
   insert into op_non_return_tk_hist
   select card_physical_id,card_logical_id ,device_id,deal_datetime,substr(pay_mode_id,1,2) ,deal_fee ,receipt_id ,tac ,
   line_id ,station_id ,deal_balance ,balance_water_no,entry_datetime ,deal_type ,red_flag ,card_main_id ,
   card_sub_id ,gen_time ,tct_valid_days ,tct_activate_time ,in_balance_water_no
   from t#ist_gen_non_return_list_ret
   where water_no in (select   min(water_no) from t#ist_gen_non_return_list_ret
                    group by deal_datetime,deal_type,deal_balance,card_logical_id );
  commit;
  out_msg       := 'success';
  out_retresult := 0;
  exception
  when others then
    begin
      rollback;
      out_msg:= 'ø®∫≈'||in_logical_id||v_msg ||'¥ÌŒÛ£∫µ⁄['||dbms_utility.format_error_backtrace()||']––'||sqlerrm;
      out_retresult := sqlcode;
      return;
    end;
end;
/
grant execute on ACC_ST.UP_ST_IST_GEN_NON_RETURN_LIST to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_REPORT_LOSS
prompt ========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_report_loss
 (out_retResult OUT INTEGER, --∑µªÿΩ·π˚
  out_msg OUT VARCHAR2, --∑µªÿ–≈œ¢
  in_balance_water_no in VARCHAR2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_report_loss
--π¶ƒ‹√Ë ˆ£∫«ÂÀ„∫Û–¯¥¶¿Ì-œ¬∑¢π“ ß/Ω‚≥˝Ω‚π“º«√˚ø®∫⁄√˚µ•£¨º«√˚ø®π“ ß¥¶¿Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  lindaquan 20150728

--–ﬁ∏ƒ£∫∏¸–¬º«√˚ø®«ÂÀ„¬ﬂº≠ version 1.35 by lindaquan in 20160603
--–ﬁ∏ƒ£∫π˝¬À÷ÿ∏¥…Í«Î≤πø®,∑«º¥ ±ÕÀøÓ∆¡±Œ0203¿œ»Àø® ver1.37 by lindaquan in 20160803
-------------------------------------------------------------------------------
AS
   v_count int;
   tmpsql            varchar2(1024);--¡Ÿ ±SQL”Ôæ‰
   tmpTable          varchar2(1024);--¡Ÿ ±±Ì√˚
   v_no_return_day  int :=0;
   v_lock           char(1) :='1'; --π“ ß
   v_unlock         char(1) :='2'; --Ω‚π“
BEGIN

  out_retresult:=0;
  select cfg_value into v_no_return_day from acc_st.ST_CFG_SYS_BASE where cfg_key='sys.non_return_day' and record_flag='0';

  --π“ ßº«¬º∑≈µΩ¡Ÿ ±±Ìt#st_list_report_loss,≤¢∏¸–¬¬ﬂº≠ø®∫≈ (»•÷ÿ∏¥)
  select count(*) into v_count from acc_st.st_que_report_loss where balance_water_no=in_balance_water_no;
  if v_count>0 then
      out_msg := 'π“ ßº«¬º∑≈µΩ¡Ÿ ±±Ìt#st_list_report_loss,≤¢∏¸–¬¬ﬂº≠ø®∫≈';
      insert into acc_st.t#st_list_report_loss
            (water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identify_type, identity_id,
            expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, card_main_id, card_sub_id,
            create_time, busniss_type, apply_bill, card_logical_id, card_physical_id, card_print_id, balance_water_no)
      select t.water_no, t.line_id, t.station_id, t.dev_type_id, t.device_id, t.apply_name, t.apply_sex, t.identity_type, t.identity_id,
            t.expired_date, t.tel_no, t.fax, t.address, t.operator_id, t.apply_datetime, t.shift_id, t.card_app_flag, t.card_main_id, t.card_sub_id,
            sysdate, t.apply_business_type, t.receipt_id, null, null, null, t.balance_water_no from acc_st.st_que_report_loss t
            where t.water_no=(
               select min(s.water_no) from acc_st.st_que_report_loss s
               where s.identity_type||s.identity_id = t.identity_type||t.identity_id and s.balance_water_no=in_balance_water_no
                     and s.apply_business_type=t.apply_business_type
            ) and balance_water_no=in_balance_water_no;

      MERGE INTO acc_st.t#st_list_report_loss x
      USING (
        select c.*,b.phy_id,b.print_id,b.logical_id
        from acc_st.st_list_sign_card a,acc_tk.ic_es_initi_info b,acc_st.t#st_list_report_loss c
        where a.req_no=b.req_no
              and a.order_no=b.order_no
              and nvl(a.card_app_flag,0)=nvl(c.card_app_flag,0)
              and a.identity_type=c.identify_type
              and upper(trim(a.identity_id))= upper(trim(c.identity_id))
      ) y
      ON (nvl(x.card_app_flag,0)=nvl(y.card_app_flag,0)
              and x.identify_type=y.identify_type
              and upper(trim(x.identity_id))= upper(trim(y.identity_id)))
      WHEN MATCHED THEN
      UPDATE
      SET x.card_physical_id = y.phy_id,
          x.card_print_id = y.print_id,
          x.card_logical_id = y.logical_id;

      begin
          --∂®“Â∑÷±Ìic_es_initi_info”Œ±Í
          DECLARE CURSOR hisTableCus IS select his_table from acc_tk.ic_idx_history where origin_table_name='ic_es_initi_info';
          c_row hisTableCus%rowtype;
          --—≠ª∑”Œ±Í
          begin
            open hisTableCus;
                 loop
                   fetch hisTableCus into c_row;
                   --”Œ±Í»°≤ªµΩ ˝æ›‘ÚÕÀ≥ˆ
                   exit when hisTableCus%NOTFOUND;
                   tmpsql := 'MERGE INTO acc_st.t#st_list_report_loss x'||
                              ' USING ( select c.*,b.phy_id,b.print_id,b.logical_id'||
                                ' from acc_st.st_list_sign_card a,acc_tk.'||c_row.his_table||' b,acc_st.t#st_list_report_loss c'||
                                ' where a.req_no=b.req_no and a.order_no=b.order_no and nvl(a.card_app_flag,0)=nvl(c.card_app_flag,0)'||
                                      ' and a.identity_type=c.identify_type and upper(trim(a.identity_id))= upper(trim(c.identity_id))'||
                              ') y'||
                              ' ON (nvl(x.card_app_flag,0)=nvl(y.card_app_flag,0) and x.identify_type=y.identify_type'||
                                      ' and upper(trim(x.identity_id))= upper(trim(y.identity_id)))'||
                              ' WHEN MATCHED THEN'||
                              ' UPDATE'||
                              ' SET x.card_physical_id = y.phy_id,'||
                                  'x.card_print_id = y.print_id,'||
                                  'x.card_logical_id = y.logical_id';
                   EXECUTE IMMEDIATE tmpsql;
                 end loop;
            close hisTableCus;
          end;
      end;
  end if;

  --“Ï≥£º«¬º¥¶¿Ì£∫Ω´Œ¥∏¸–¬µΩ¬ﬂº≠ø®∫≈µƒº«¬º“∆≥˝µΩ¥ÌŒÛ±Ì£®‘§¥¶¿ÌΩ‚æˆ£©
  --»•≥˝¬ﬂº≠ø®∫≈Œ™ø’µƒº«¬º
  delete from acc_st.t#st_list_report_loss where card_logical_id is null;

  --Ω‚π“º«¬º≤Â»Î¥˝¥¶¿Ì±Ì
  out_msg := 'Ω‚π“º«¬º≤Â»Î¥˝¥¶¿Ì±Ì';
  insert into acc_st.st_list_report_loss_pend
    (water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
    device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
    card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no)
  select water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
    device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
    card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no
  from acc_st.t#st_list_report_loss where busniss_type=v_unlock;
  --…æ≥˝¡Ÿ ±±ÌΩ‚π“º«¬º
  delete acc_st.t#st_list_report_loss where busniss_type=v_unlock;

  --∞—π“ ßº«√˚ø®◊™“∆µΩ∫⁄√˚µ•±Ì
  select count(*) into v_count from acc_st.t#st_list_report_loss;
  if v_count>0 then
    out_msg := '∞—π“ ßº«√˚ø®◊™“∆µΩ∫⁄√˚µ•±Ì';
    insert into acc_st.op_prm_black_list_mtr
      select sysdate,c.card_logical_id,'10','º«√˚ø®π“ ß('||c.apply_name||')', '000',c.apply_datetime,c.operator_id,null
      from acc_st.t#st_list_report_loss c where c.busniss_type=v_lock
      and not exists(select card_logical_id from acc_st.op_prm_black_list_mtr a where a.card_logical_id = c.card_logical_id);
  end if;

  out_msg := 'π“ ßº«¬º≤Â»Îπ“ ß◊¥Ã¨±Ì';
  --…æ≥˝‘≠”–‘Ÿ≤Â»Î
  delete acc_st.st_list_report_loss a where exists
  (select 1 from acc_st.t#st_list_report_loss b where a.identify_type=b.identify_type and a.identity_id=b.identity_id
          and busniss_type=v_lock);
  --π“ ß–¬‘ˆ(π“ ßº«¬º≤Â»Îπ“ ß◊¥Ã¨±Ìst_list_report_loss)
  insert into acc_st.st_list_report_loss
    (water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
    device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
    card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no)
  select water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
    device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
    card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no
  from acc_st.t#st_list_report_loss where busniss_type=v_lock;

  --≤Â»Îº«¬ºµΩ∑«º¥ ±ÕÀøÓ÷–º‰±Ì
  out_msg := 'π“ ßÕÀøÓ…Í«Î≤Â»Î∑«º¥ÕÀ¥˝¥¶¿Ì±Ì';
  insert into acc_st.st_list_non_rtn
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id,
         card_logical_id, card_physical_id, card_print_id,
         apply_datetime, receipt_id, operator_id, apply_name, tel_no, identity_type, identity_id,
         is_broken, shift_id, card_app_flag, balance_water_no, hdl_flag,
         deposit_fee, card_balance_fee, system_balance_fee, penalty_fee, return_bala,
         remark, return_line_id, return_station_id, return_dev_type_id, return_device_id, actual_return_bala,
         audit_flag, penalty_reason, return_type)
  select acc_st.seq_st_list_non_rtn.nextval,a.line_id,a.station_id,a.dev_type_id,a.device_id,a.card_main_id,a.card_sub_id,
         card_logical_id, card_physical_id, card_print_id,
         a.apply_datetime,a.apply_bill,a.operator_id,a.apply_name,a.tel_no,a.identify_type,a.identity_id,
         null,a.shift_id,a.card_app_flag,a.balance_water_no,'2',--¥¶¿Ì±Í÷æ 1:“—∞Ï¿ÌÕÀøÓ;2:≥µ∆±Œ¥¥¶¿Ì;3:≥µ∆±“—”–ÕÀøÓΩ·π˚;4:∫⁄√˚µ•≥µ∆±,≤ªƒ‹ÕÀøÓ;5:∆æ÷§∫≈ªÚø®∫≈ ‰»Î¥ÌŒÛ;6:ÕÀøÓ…Í«Î“—≥∑œ˚;7:ÕÀøÓ…Í«Îµ√µΩ–Ìø…;8:ø®∫≈∑«∑®';
         null,null,null,null,null,
         null,null,null,null,null,null,
         null,null,'4'
  from acc_st.t#st_list_report_loss a
  where not exists (select 1 from acc_st.st_list_non_rtn b
             where a.card_logical_id=b.card_logical_id and nvl(a.card_app_flag,0)=nvl(b.card_app_flag,0))
             and a.CARD_MAIN_ID||a.CARD_SUB_ID<>'0203';--ver1.37 ∑«º¥ ±ÕÀøÓ∆¡±Œ0203¿œ»Àø®

  --≤Â»Î≤πø®…Í«Î¥˝¥¶¿Ì±Ì
  out_msg := '≤Â»Î≤πø®…Í«Î¥˝¥¶¿Ì±Ì';
  insert into acc_st.st_list_sign_card_pend
    (water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id,
    expired_date,tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no,
    file_name, check_flag, card_main_id, card_sub_id, app_business_type)
  select t.water_no,t.line_id,t.station_id,t.dev_type_id,t.device_id,t.apply_name,t.apply_sex,t.identity_type,t.identity_id,
    t.expired_date,t.tel_no,t.fax,t.address,t.operator_id, t.apply_datetime,t.shift_id,t.card_app_flag,t.balance_water_no,
    t.file_name,t.check_flag,t.card_main_id,t.card_sub_id,app_business_type
  from acc_st.st_que_sign_card_apply t where t.water_no=(
         select min(s.water_no) from acc_st.st_que_sign_card_apply s
         where s.identity_type||s.identity_id = t.identity_type||t.identity_id and s.balance_water_no=in_balance_water_no
         and s.app_business_type='2'
   ) and not exists( --ver1.37 π˝¬À÷ÿ∏¥…Í«Î≤πø® lindaquan 20160803
     select 1 from acc_st.st_list_sign_card_pend a where a.identity_type||a.identity_id = t.identity_type||t.identity_id
   );

   --≤Â»Îø…Ω‚π“º«¬ºµΩ¡Ÿ ±±Ì
   --ø…Ω‚π“£∫¥Ê‘⁄π“ ß ±º‰±»Ω‚π“ ±º‰≤ª≥¨π˝“ª∏ˆ∑«º¥ÕÀµ»¥˝»’µƒΩ‚π“º«¬º
   insert into acc_st.t#st_list_report_loss
    (water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
    device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
    card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no)
   select a.water_no, a.apply_bill, a.create_time, a.busniss_type, a.identify_type, a.identity_id, a.line_id, a.station_id, a.dev_type_id,
    a.device_id, a.apply_name, a.apply_sex, a.expired_date, a.tel_no, a.fax, a.address, a.operator_id, a.apply_datetime, a.shift_id,
    a.card_app_flag, a.card_main_id, a.card_sub_id, a.card_logical_id, a.card_physical_id, a.card_print_id, a.balance_water_no
   from acc_st.st_list_report_loss_pend a where exists (
        select 1 from acc_st.st_list_report_loss b where a.busniss_type=v_unlock and b.busniss_type=v_lock
               and a.card_logical_id=b.card_logical_id and trunc(b.apply_datetime)+v_no_return_day > trunc(a.apply_datetime)
               and a.apply_datetime>b.apply_datetime --Ω‚π“ ±º‰±»π“ ß ±º‰≥Ÿ
        );


   --…æ≥˝ø…Ω‚π“∂‘”¶µƒΩ‚π“∫⁄√˚µ•
   select count(*) into v_count from acc_st.t#st_list_report_loss where busniss_type=v_unlock;
   if v_count>0 then
      out_msg := 'À¯ø®ø®∫≈¥”∫⁄√˚µ•±ÌΩ¯»Î∫⁄√˚µ•π˝∆⁄±Ì';
      insert into op_prm_black_old_mtr(gen_datetime,cutoff_datetime,card_logical_id,black_type,remark,
      action_type,create_datetime,operator_id,is_set,balance_water_no,delete_datetime,delete_operator_id,delete_remark)
      select distinct gen_datetime,create_datetime,a.card_logical_id,black_type,remark,action_type,create_datetime,
      a.operator_id,is_set,in_balance_water_no,sysdate,user ,'“—À¯ø®'
      from  op_prm_black_list_mtr a,acc_st.t#st_list_report_loss b
      WHERE  a.card_logical_id = b.card_logical_id and busniss_type=v_unlock;
      out_msg := '∞—Ω‚π“º«√˚ø®…æ≥˝∫⁄√˚µ•±Ì ';
      delete acc_st.op_prm_black_list_mtr where CARD_LOGICAL_ID in(
        select card_logical_id from acc_st.t#st_list_report_loss where busniss_type=v_unlock
      );

      --¥”¥˝¥¶¿Ì±Ì…æ≥˝“—æ≠¥¶¿Ìµƒ ˝æ› (Ω‚π“)
      delete acc_st.st_list_report_loss_pend a where a.card_logical_id in (
            select card_logical_id from acc_st.t#st_list_report_loss where busniss_type=v_unlock
      ) and a.busniss_type=v_unlock;

      out_msg := 'Ω‚π“º«¬º≤Â»Îπ“ ß◊¥Ã¨±Ì';
      --…æ≥˝‘≠”–‘Ÿ≤Â»Î
      delete acc_st.st_list_report_loss a where exists
      (select 1 from acc_st.t#st_list_report_loss b where a.identify_type=b.identify_type and a.identity_id=b.identity_id
              and busniss_type=v_unlock);
      --Ω‚π“–¬‘ˆ(Ω‚π“º«¬º≤Â»Îπ“ ß◊¥Ã¨±Ìst_list_report_loss)
      insert into acc_st.st_list_report_loss
        (water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
        device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
        card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no)
      select water_no, apply_bill, create_time, busniss_type, identify_type, identity_id, line_id, station_id, dev_type_id,
        device_id, apply_name, apply_sex, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id,
        card_app_flag, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_print_id, balance_water_no
      from acc_st.t#st_list_report_loss where busniss_type=v_unlock;
    end if;

   --Ω‚π“»°œ˚∑«º¥ ±ÕÀøÓ…Í«Î
   out_msg := 'Ω‚π“»°œ˚∑«º¥ÕÀ…Í«Î';
   --¥¶¿Ì±Í÷æ 1:“—∞Ï¿ÌÕÀøÓ;2:≥µ∆±Œ¥¥¶¿Ì;3:≥µ∆±“—”–ÕÀøÓΩ·π˚;4:∫⁄√˚µ•≥µ∆±,≤ªƒ‹ÕÀøÓ;5:∆æ÷§∫≈ªÚø®∫≈ ‰»Î¥ÌŒÛ;6:ÕÀøÓ…Í«Î“—≥∑œ˚;7:ÕÀøÓ…Í«Îµ√µΩ–Ìø…;8:ø®∫≈∑«∑®';
   --audit_flag='1' ÷√Œ™“—…Û∫À
   update acc_st.st_list_non_rtn set hdl_flag='6',audit_flag='1' where card_logical_id in (
          select card_logical_id from acc_st.t#st_list_report_loss where busniss_type=v_unlock
   ) and return_type='4';


   --Ω‚π“»°œ˚≤πø®…Í«Î£®≤πø®¥˝¥¶¿Ì±Ì£©
   out_msg := 'Ω‚π“»°œ˚≤πø®…Í«Î';
   delete acc_st.st_list_sign_card_pend where identity_type||identity_id in (
          select identify_type||identity_id from acc_st.t#st_list_report_loss where busniss_type=v_unlock
   ) and app_business_type='2'; --2Œ™≤πø®…Í«Î


    --º«√˚ø®÷ÿ◊ˆ…Í«Î¥¶¿Ì
    out_msg := 'º«√˚ø®÷ÿ◊ˆ¥¶¿Ì';
    --Ω´÷ÿ◊ˆæ…º«√˚ø®–≈œ¢∑≈µΩ…æ≥˝±Ì
    insert into acc_st.st_list_sign_card_del
      (req_no, water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no, file_name, check_flag, hdl_time, hdl_flag, order_no, card_sub_id, card_main_id, app_business_type)
    select req_no, water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no, file_name, check_flag, hdl_time, hdl_flag, order_no, card_sub_id, card_main_id, app_business_type
    from acc_st.st_list_sign_card
    where identity_type||upper(trim(identity_id)) in(
          select identity_type||upper(trim(identity_id)) from acc_st.st_list_sign_card_pend
          where trunc(apply_datetime)+v_no_return_day+1 < trunc(sysdate) and app_business_type='2' --2Œ™≤πø®…Í«Î
    );
    --…æ≥˝÷ÿ◊ˆº«√˚ø®“—”–…Í«Îº«¬º
    delete from acc_st.st_list_sign_card
    where identity_type||upper(trim(identity_id)) in(
          select identity_type||upper(trim(identity_id)) from acc_st.st_list_sign_card_pend
          where trunc(apply_datetime)+v_no_return_day+1 < trunc(sysdate) and app_business_type='2' --2Œ™≤πø®…Í«Î
    );
    -- ≤Â»Îº«√˚ø®÷ÿ◊ˆº«¬º
    insert into acc_st.st_list_sign_card_remake (WATER_NO, IDENTITY_TYPE, IDENTITY_ID, APPLY_NAME, CARD_MAIN_ID, CARD_SUB_ID, APPLY_DATETIME_REMAKE, APPLY_NAME_REMAKE, REASON_ID, REMARK)
    select acc_st.seq_st_list_sign_card_remake.nextval,IDENTITY_TYPE, IDENTITY_ID, APPLY_NAME, CARD_MAIN_ID, CARD_SUB_ID,sysdate,operator_id,'08','π“ ß∏¸–¬' from acc_st.st_list_sign_card_pend
          where trunc(apply_datetime)+v_no_return_day+1 < trunc(sysdate) and app_business_type='2'; --2Œ™≤πø®…Í«Î;

   --≤πø®≤Â»Îº«¬ºµΩ…Í«Î±Ì
   --º«√˚ø®…Í«ÎΩ®¿˙ ∑±Ì±∏∑›£¨÷ÿ∏¥…Í«Î ±»° ±º‰◊Ó‘Áµƒº«¬º by lindaquan 20151221
   --»°÷ÿ∏¥…Í«Î÷–◊Ó‘Á…Í«Îµƒº«¬º
   insert into acc_st.st_list_sign_card(
     req_no,water_no,line_id,station_id,dev_type_id,device_id,
     apply_name,apply_sex,identity_type,identity_id,expired_date,tel_no,fax,address,operator_id,
     apply_datetime,shift_id,card_app_flag,balance_water_no,file_name,check_flag,hdl_time,hdl_flag,order_no,
     card_main_id,card_sub_id,app_business_type)
   select lpad(to_char(acc_st.seq_st_list_sign_card.nextval),10,'0'),t.water_no,t.line_id,t.station_id,t.dev_type_id,t.device_id,
   t.apply_name,t.apply_sex,t.identity_type,t.identity_id,t.expired_date,t.tel_no,t.fax,t.address,t.operator_id,
   t.apply_datetime,t.shift_id,t.card_app_flag,t.balance_water_no,t.file_name,t.check_flag,null, '0', null,
   t.card_main_id,t.card_sub_id,t.app_business_type
   from acc_st.st_list_sign_card_pend t
   where trunc(apply_datetime)+v_no_return_day+1 < trunc(sysdate) and app_business_type='2';

   --…æ≥˝“—æ≠…Í«Îº«¬º
   delete acc_st.st_list_sign_card_pend where trunc(apply_datetime)+v_no_return_day+1 < trunc(sysdate) and app_business_type='2';

END;
/
grant execute on ACC_ST.UP_ST_IST_REPORT_LOSS to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_AUDIT_MB
prompt ============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_audit_mb(
       out_retresult out integer, --∑µªÿΩ·π˚
       out_msg out varchar2, --∑µªÿ–≈œ¢
       in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_audit_mb
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫“Ï≥£Õ≥º∆°¢≤…ºØ…Ûº∆( ÷ª˙÷ß∏∂≤ø∑÷)
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  lindaquan
--¥¥Ω® ±º‰£∫ 2016-01-15 ver1.30
-------------------------------------------------------------------------------
as
   v_count int;
   v_msg varchar(100);
begin
    select count(*) into v_count from acc_st.st_mb_sts_collect_status where balance_water_no=in_balance_water_no;
    if v_count > 0 then
        out_msg := 'st_mb_sts_collect_status“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
        out_retresult := - 1;
        return;
     end if;
    select count(*) into v_count from acc_st.st_mb_sts_except_balance where balance_water_no=in_balance_water_no;
    if v_count > 0 then
        out_msg := 'st_mb_sts_except_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
        out_retresult := - 1;
        return;
     end if;

    ----------------------------“Ï≥£±®±Ì--------------------------
    delete t#st_ist_settle_audit_err;

    --ø’÷–≥‰÷µ¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îø’÷–≥‰÷µ ˝æ›';
    insert into t#st_ist_settle_audit_err
    select a.balance_water_no,line_id,station_id,'54',err_code,card_main_id,count(*)
      from acc_st.st_mb_err_deal a
      where a.balance_water_no = in_balance_water_no
      group by a.balance_water_no,line_id,station_id ,err_code,card_main_id;

    --ø’÷–∑¢ €¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îø’÷–∑¢ € ˝æ›';
    insert into t#st_ist_settle_audit_err
    select a.balance_water_no,line_id,station_id,'51',err_code,card_main_id,count(*)
      from acc_st.st_mb_err_sale a
      where a.balance_water_no = in_balance_water_no
      group by a.balance_water_no,line_id,station_id ,err_code,card_main_id;

    --ø’÷–ÕÀøÓ¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îø’÷–ÕÀøÓ ˝æ›';
    insert into t#st_ist_settle_audit_err
    select a.balance_water_no,line_id,station_id,'57',err_code,card_main_id,count(*)
      from acc_st.st_mb_err_return a
      where a.balance_water_no = in_balance_water_no
      group by a.balance_water_no,line_id,station_id ,err_code,card_main_id;

    --ø’÷–º”Ω‚À¯¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îø’÷–º”Ω‚À¯ ˝æ›';
    insert into t#st_ist_settle_audit_err
    select a.balance_water_no,line_id,station_id,'54',err_code,card_main_id,count(*)
      from acc_st.st_mb_err_lock a
      where a.balance_water_no = in_balance_water_no
      group by a.balance_water_no,line_id,station_id ,err_code,card_main_id;

    --“Ï≥£±®±Ì
    v_msg := 'œÚst_mb_sts_except_balance±Ì≤Â»Î“Ï≥£ ˝æ›';
    insert into acc_st.st_mb_sts_except_balance (water_no,balance_water_no,line_id,station_id,tr_type_id,error_id,deal_num,sys_type )
    select acc_st.seq_st_mb_sts_except_balance.nextval,balance_water_no,line_id,station_id,tr_type_id,
           error_id,deal_num,sys_type from acc_st.t#st_ist_settle_audit_err;


    ---------------------------≤…ºØ…Ûº∆-----------------------------
    delete t#st_ist_settle_audit_collect;

    --ø’÷–≥‰÷µ
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îø’÷–≥‰÷µ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no,file_name,line_id,station_id,'54',count(*) from acc_st.st_mb_que_deal
    where balance_water_no = in_balance_water_no
    group by balance_water_no,file_name,line_id,station_id;

    --ø’÷–∑¢ €
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îø’÷–∑¢ € ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no,file_name,line_id,station_id,'51',count(*) from acc_st.st_mb_que_sale
    where balance_water_no = in_balance_water_no
    group by balance_water_no,file_name,line_id,station_id;

    --ø’÷–ÕÀøÓ
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îø’÷–ÕÀøÓ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no,file_name,line_id,station_id,'57',count(*) from acc_st.st_mb_que_return
    where balance_water_no = in_balance_water_no
    group by balance_water_no,file_name,line_id,station_id;

    --ø’÷–º”Ω‚À¯
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îø’÷–º”Ω‚À¯ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no,file_name,line_id,station_id,'54',count(*) from acc_st.st_mb_que_lock
    where balance_water_no = in_balance_water_no
    group by balance_water_no,file_name,line_id,station_id;

    ----≤…ºØ…Ûº∆±®±Ì
    v_msg := 'œÚst_mb_sts_collect_status±Ì≤Â»Î≤…ºØ…Ûº∆ª„◊‹ ˝æ›';
    insert into acc_st.st_mb_sts_collect_status
    select acc_st.seq_st_mb_sts_collect_status.nextval,balance_water_no,file_name ,line_id,station_id ,file_type,record_num
    from acc_st.t#st_ist_settle_audit_collect

    commit;

    out_msg :='success';
    out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_AUDIT_MB to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_AUDIT_NP
prompt ============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_audit_np(
       out_retresult out integer, --∑µªÿΩ·π˚
       out_msg out varchar2, --∑µªÿ–≈œ¢
       in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_audit_np
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫“Ï≥£Õ≥º∆°¢≤…ºØ…Ûº∆(ª•¡™Õ¯÷ß∏∂≤ø∑÷)
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  lindaquan
--¥¥Ω® ±º‰£∫ 2016-11-30 ver1.38
-------------------------------------------------------------------------------
as
   v_count int;
   v_msg varchar(100);
begin
    select count(*) into v_count from acc_st.st_np_sts_collect_status where balance_water_no=in_balance_water_no;
    if v_count > 0 then
        out_msg := 'st_np_sts_collect_status“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
        out_retresult := - 1;
        return;
     end if;
    select count(*) into v_count from acc_st.st_np_sts_except_balance where balance_water_no=in_balance_water_no;
    if v_count > 0 then
        out_msg := 'st_np_sts_except_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
        out_retresult := - 1;
        return;
     end if;

    ----------------------------“Ï≥£±®±Ì--------------------------
    delete acc_st.t#st_ist_settle_audit_err;

    --ª•¡™Õ¯÷ß∏∂≥‰÷µ¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îª•¡™Õ¯≥‰÷µ ˝æ›';
    insert into acc_st.t#st_ist_settle_audit_err
      (balance_water_no, line_id, station_id, tr_type_id, error_id, sys_type, deal_num)
    select balance_water_no, line_id, station_id, '50', err_code, card_main_id, count(1)
    from acc_st.st_np_err_deal
    where balance_water_no = in_balance_water_no
      group by balance_water_no,line_id,station_id ,err_code,card_main_id;

    --ª•¡™Õ¯÷ß∏∂∑¢ €¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îª•¡™Õ¯∑¢ € ˝æ›';
    insert into acc_st.t#st_ist_settle_audit_err
      (balance_water_no, line_id, station_id, tr_type_id, error_id, sys_type, deal_num)
    select balance_water_no, line_id, station_id, '54', err_code, card_main_id, count(1)
    from acc_st.st_np_err_sale
    where balance_water_no = in_balance_water_no
      group by balance_water_no,line_id,station_id ,err_code,card_main_id;

    --“Ï≥£±®±Ì
    v_msg := 'œÚst_np_sts_except_balance±Ì≤Â»Î“Ï≥£ ˝æ›';
    insert into acc_st.st_np_sts_except_balance (water_no,balance_water_no,line_id,station_id,tr_type_id,error_id,deal_num,sys_type )
    select acc_st.seq_st_np_sts_except_balance.nextval,balance_water_no,line_id,station_id,tr_type_id,
           error_id,deal_num,sys_type from acc_st.t#st_ist_settle_audit_err;


    ---------------------------≤…ºØ…Ûº∆-----------------------------
    delete acc_st.t#st_ist_settle_audit_collect;


    --ª•¡™Õ¯÷ß∏∂≥‰÷µ
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îª•¡™Õ¯≥‰÷µ ˝æ›';
    insert into acc_st.t#st_ist_settle_audit_collect
      (balance_water_no, file_name, line_id, station_id, file_type, record_num)
    select balance_water_no,file_name,line_id,station_id,'50',count(*) from acc_st.st_np_que_deal
    where balance_water_no = in_balance_water_no
    group by balance_water_no,file_name,line_id,station_id;

    --ª•¡™Õ¯÷ß∏∂∑¢ €
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îª•¡™Õ¯∑¢ € ˝æ›';
    insert into acc_st.t#st_ist_settle_audit_collect
      (balance_water_no, file_name, line_id, station_id, file_type, record_num)
    select balance_water_no,file_name,line_id,station_id,'54',count(*) from acc_st.st_np_que_sale
    where balance_water_no = in_balance_water_no
    group by balance_water_no,file_name,line_id,station_id;

    ----≤…ºØ…Ûº∆±®±Ì
    v_msg := 'œÚst_mb_sts_collect_status±Ì≤Â»Î≤…ºØ…Ûº∆ª„◊‹ ˝æ›';
    insert into acc_st.st_np_sts_collect_status
    select acc_st.seq_st_np_sts_collect_status.nextval,balance_water_no,file_name ,line_id,station_id ,file_type,record_num
    from acc_st.t#st_ist_settle_audit_collect;

    commit;

    out_msg :='success';
    out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_AUDIT
prompt =========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_audit(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_audit
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫“Ï≥£Õ≥º∆°¢≤…ºØ…Ûº∆
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú 20140111
--–ﬁ∏ƒ£∫   --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
           --ver1.02 st_sts_except_balance‘ˆº”µÿÃ˙ø®‘⁄π´Ωªµƒ¥ÌŒÛÕ≥º∆ 2014-6-19
           --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
           --ver1.26 º«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«Î¥ÌŒÛ ∏¸–¬»’∆⁄2015-07-27
           --ver1.30 ÃÌº” ÷ª˙÷ß∏∂≤ø∑÷“Ï≥£Õ≥º∆°¢…Ûº∆ in 20160115 by lindaquan
           --ver1.38 ‘ˆº”ª•¡™Õ¯÷ß∏∂≤ø∑÷“Ï≥£Õ≥º∆°¢…Ûº∆ (up_st_ist_settle_audit_np) 20161130 by lindaquan
-------------------------------------------------------------------------------
as
   v_count int;
   v_msg varchar(100);
begin
  select count(*) into v_count from st_sts_collect_status  where  balance_water_no=in_balance_water_no;
  if v_count > 0  then
      out_msg := 'st_sts_collect_status“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
      out_retresult := - 1;
      return;
   end if;
  select count(*) into v_count from st_sts_except_balance  where balance_water_no=in_balance_water_no;
  if v_count > 0  then
      out_msg := 'st_sts_except_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
      out_retresult := - 1;
      return;
   end if;
    ----------------------------“Ï≥£±®±Ì
    --«Æ∞¸Ωª“◊¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Î«Æ∞¸Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'54',err_code,card_main_id,count(*)
    from st_err_deal a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,station_id ,err_code,card_main_id;
    --µ•≥Ã∆±¥ÌŒÛ
     v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îµ•≥Ã∆±Ωª“◊ ˝æ›';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'50',err_code,card_main_id,count(*)
    from st_err_sale_sjt a
    where a.balance_water_no = in_balance_water_no
   group by  a.balance_water_no,line_id,  station_id ,err_code,card_main_id;
   --∑«µ•≥Ã∆±¥ÌŒÛ
     v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Î∑«µ•≥Ã∆±¥ÌŒÛ ˝æ›';
      insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'51',err_code,card_main_id,count(*)
    from st_err_sale a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code  ,card_main_id;
    --∏¸–¬¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Î∏¸–¬¥ÌŒÛ ˝æ›';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'56',err_code,card_main_id,count(*)
    from st_err_update a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code,card_main_id;
    --ÕÀø®¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»ÎÕÀø®¥ÌŒÛ ˝æ›';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id, '57', err_code,card_main_id,count(*)
    from st_err_return a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code,card_main_id;
    --∑«º¥ ±ÕÀø®…Í«Î¥ÌŒÛ
     v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Î∑«º¥ ±ÕÀø®…Í«Î¥ÌŒÛ';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id, station_id, '58', err_code,card_main_id,count(*)
    from st_err_non_rtn_app  a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code   ,card_main_id;
    --º”À¯¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îº”À¯¥ÌŒÛ ˝æ›';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'59',err_code,card_main_id,count(*)
    from st_err_lock a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code   ,card_main_id;
    --Ω¯’æº«¬º¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»ÎΩ¯’æº«¬º¥ÌŒÛ ˝æ›';
   insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'53', err_code,card_main_id,count(*)
    from st_err_entry a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code ,card_main_id;
    --∆±ø®—”∆⁄¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Î—”∆⁄¥ÌŒÛ ˝æ›';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id,station_id,'55',err_code,card_main_id,count(*)
    from st_err_delay a
    where a.balance_water_no = in_balance_water_no
  group by  a.balance_water_no,line_id,  station_id ,err_code ,card_main_id;
   --––’˛¥¶¿Ì¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Î––’˛¥¶¿Ì¥ÌŒÛ ˝æ›';
       insert into t#st_ist_settle_audit_err
        select a.balance_water_no,line_id, station_id,'61',err_code,card_main_id, count(*)
    from st_err_admin a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id, station_id ,err_code,card_main_id;
   --º«√˚ø®…Í«Î¥ÌŒÛ
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îº«√˚ø®…Í«Î¥ÌŒÛ ˝æ›';
     insert into t#st_ist_settle_audit_err
        select a.balance_water_no, line_id,station_id,'52',err_code,card_main_id, count(*)
        from st_err_sign_card_apply a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code,card_main_id;

    --º«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«Î¥ÌŒÛ 2015-07-27‘ˆº”
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»Îº«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«Î¥ÌŒÛ ˝æ›';
    insert into acc_st.t#st_ist_settle_audit_err
        select a.balance_water_no, line_id,station_id,'62',err_code,card_main_id, count(*)
        from acc_st.st_err_report_loss a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,  station_id ,err_code,card_main_id;

   --µÿÃ˙ø®‘⁄π´Ωªµƒ¥ÌŒÛ  2014-6-19‘ˆº”
    v_msg := 'œÚt#st_ist_settle_audit_err±Ì≤Â»ÎµÿÃ˙ø®‘⁄π´Ωªµƒ¥ÌŒÛ ˝æ›';
     insert into t#st_ist_settle_audit_err
        select a.balance_water_no, '00','00','54',err_code,card_main_id, count(*)
        from st_ext_mtr_err_deal a
    where a.balance_water_no = in_balance_water_no
    group by  a.balance_water_no,err_code,card_main_id;

    --“Ï≥£±®±Ì
    v_msg := 'œÚst_sts_except_balance±Ì≤Â»Î“Ï≥£ ˝æ›';
     insert into st_sts_except_balance (water_no,balance_water_no,line_id,station_id,tr_type_id  ,error_id,deal_num,sys_type )
        select seq_st_sts_except_balance.nextval,balance_water_no,line_id,station_id,tr_type_id  ,
              error_id,deal_num  ,sys_type from t#st_ist_settle_audit_err;

    ---------------------------≤…ºØ…Ûº∆
    --«Æ∞¸Ωª“◊
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Î«Æ∞¸Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'54',count(*)
    from st_que_deal
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    -- €ø®Ωª“◊
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Î €ø®Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'51',count(*)
    from st_que_sale
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --µ•≥Ã∆± €ø®
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îµ•≥Ã∆± €ø®Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'50',count(*)
    from st_que_sale_sjt
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --º«√˚ø®…Í«Î
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îº«√˚ø®…Í«ÎΩª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'52',count(*)
    from st_que_sign_card_apply
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --º«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«Î
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îº«√˚ø®…Í«Î/π“ ß/Ω‚π“/≤πø®Ωª“◊ ˝æ›';
    insert into acc_st.t#st_ist_settle_audit_collect
    select balance_water_no,file_name ,line_id ,station_id  ,'62',count(*)
    from acc_st.st_que_report_loss
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --Ω¯’æº«¬º
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»ÎΩ¯’æΩª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'53',count(*)
    from st_que_entry
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --∆±ø®—”∆⁄
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Î∆±ø®—”∆⁄Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'55',count(*)
    from st_que_delay
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --∆±ø®∏¸–¬
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Î∆±ø®∏¸–¬Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'56',count(*)
    from st_que_update
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    ---ÕÀø®º«¬º
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»ÎÕÀø®º«¬ºΩª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'57',count(*)
    from st_que_return
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --∑«º¥ ±ÕÀøÓ…Í«Î
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Î∑«º¥ ±ÕÀøÓ…Í«ÎΩª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'58',count(*)
    from st_que_non_rtn_app
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --º”À¯
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Îº”À¯Ωª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'59',count(*)
    from st_que_lock
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    --––’˛¥¶¿Ì
    v_msg := 'œÚt#st_ist_settle_audit_collect±Ì≤Â»Î––’˛¥¶¿ÌΩª“◊ ˝æ›';
    insert into t#st_ist_settle_audit_collect
    select balance_water_no    ,file_name ,line_id ,station_id  ,'61',count(*)
    from st_que_admin
    where balance_water_no = in_balance_water_no
    group by  balance_water_no,file_name,line_id,  station_id;
    ----≤…ºØ…Ûº∆±®±Ì
    v_msg := 'œÚst_sts_collect_status±Ì≤Â»Î≤…ºØ…Ûº∆ª„◊‹ ˝æ›';
    insert into st_sts_collect_status
    select seq_st_sts_collect_status.nextval,balance_water_no,file_name ,line_id,station_id ,file_type,record_num
    from  t#st_ist_settle_audit_collect;

    -- ver1.30 ÃÌº” ÷ª˙÷ß∏∂≤ø∑÷“Ï≥£Õ≥º∆°¢…Ûº∆ in 20160115 by lindaquan
    v_msg := '“Ï≥£Õ≥º∆°¢≤…ºØ…Ûº∆( ÷ª˙÷ß∏∂≤ø∑÷)';
    select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.mobile.control' and cfg_value='1';
    if v_count>0 then
        acc_st.up_st_ist_settle_audit_mb(out_retresult,out_msg,in_balance_water_no);
    end if;

    -- ver1.38 ÃÌº”ª•¡™Õ¯÷ß∏∂≤ø∑÷“Ï≥£Õ≥º∆°¢…Ûº∆ in 20161130 by lindaquan
    v_msg := '“Ï≥£Õ≥º∆°¢≤…ºØ…Ûº∆(ª•¡™Õ¯÷ß∏∂≤ø∑÷)';
    select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.np.control' and cfg_value='1';
    if v_count>0 then
        acc_st.up_st_ist_settle_audit_np(out_retresult,out_msg,in_balance_water_no);
    end if;

    commit;
    out_msg :='success';
    out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg := v_msg||'¥ÌŒÛ£∫'||sqlerrm;
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_AUDIT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA
prompt ========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_data(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
as
---------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_st_ist_settle_data
   --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-µº»Î«ÂÀ„÷–º‰±Ì
   -- ‰≥ˆ≤Œ ˝£∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
   --∑µªÿ÷µ  £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
   --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú 20130801
   --–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
           --ver1.02  »•µÙº”»Î∑«∏∂∑—«¯∏¸–¬ 2014-6-22
           --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
           --ver1.38 ‘À”™…ÃΩª“◊»’±®‘ˆº”∆±ø®¿‡–Õπ§±æ∑— ∏¸–¬»’∆⁄2016-11-28
  -------------------------------------------------------------------------------
   v_msg varchar(50);
   v_count int;
   v_sql varchar(200);
   v_squad varchar(4);

begin
   -----------»°µ√‘À”™ ±º‰
   select cfg_value into v_squad  from st_cfg_sys_base where cfg_key='sys.squadday' and record_flag='0';
   ---Ω®¡¢À˜“˝
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_CONTC'  and index_name = 'IDX_BALANCE_END';
   if v_count <= 0  then
      v_msg := '±Ìst_list_balance_contcΩ®¡¢À˜“˝';
      v_sql :='create  index IDX_BALANCE_END on ST_LIST_BALANCE_CONTC(e_line_id,e_station_id)
       TABLESPACE TBS_ST_IDX';
      execute immediate v_sql;
   end if;
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_LINE'  and index_name = 'IDX_BALANCE_END_LINE';
   if v_count <= 0  then
      v_msg := '±Ìst_list_balance_lineΩ®¡¢À˜“˝';
      v_sql :='create  index IDX_BALANCE_END_LINE on ST_LIST_BALANCE_LINE(e_line_id,e_station_id)
       TABLESPACE TBS_ST_IDX';
      execute immediate v_sql;
   end if;
   --------------------ºÏ≤È «∑Ò“—«ÂÀ„π˝-----------------------
   select count(*) into v_count  from st_sts_balance_contc_trd where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_contc_trd“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_balance_line_trd where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_line_trd“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_income_contc_card where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_income_contc_card“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_balance_contc_inc where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_contc_inc“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_balance_line_inc where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_line_inc“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_dispart_contc where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_dispart_contc“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_dispart_line where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_dispart_line“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   -----------------------------»°µ√≥µ’æ–≈œ¢
   v_msg := '≤Â»Î±Ì#st_ist_settle_data_station';
   insert into t#st_ist_settle_data_station(line_id,station_id,belong_line_id,contc_id)
    select line_id,station_id,belong_line_id,contc_id
   from op_prm_station where record_flag = '0';

   ---------------  ‘À”™…Ã ’»Î¡Ÿ ±±Ì
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_income';
   insert into t#st_ist_settle_data_income
   select a.contc_id,  --∑÷’À‘À”™…Ã
      b.belong_line_id, --’æµ„πÈ Ùµƒœﬂ¬∑
      b.contc_id,      --’æµ„πÈ Ùµƒ‘À”™…Ã
      a.squad_day, a.balance_water_no,a.card_main_id,a.card_sub_id,
      a.tr_type_id,a.pay_mode_id,sum(a.deal_num),sum(a.deal_fee)
   from st_list_balance_contc a, t#st_ist_settle_data_station b
   where a.e_line_id = b.line_id  and a.e_station_id = b.station_id
   group by a.contc_id, b.belong_line_id,b.contc_id, a.squad_day,
   a.balance_water_no,a.card_main_id, a.card_sub_id, a.tr_type_id, a.pay_mode_id;

   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_end_contc';
   insert into t#st_ist_settle_data_end_contc
   (contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,tr_type_id,pay_mode_id,deal_num,deal_fee)
   select contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,
      tr_type_id, pay_mode_id,sum(deal_num),sum(nvl(deal_fee, 0))
    from t#st_ist_settle_data_income
   group by contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,tr_type_id,pay_mode_id;

    v_msg := '≤Â»Î±Ìt#st_ist_settle_data_end_line';
   insert into t#st_ist_settle_data_end_line
   (line_id_dispart,belong_line_id,belong_contc_id,squad_day,balance_water_no,tr_type_id,pay_mode_id,deal_num,deal_fee)
   select a.line_id_dispart,b.belong_line_id,b.contc_id,a.squad_day,a.balance_water_no,
      a.tr_type_id,a.pay_mode_id,sum(a.deal_num),sum(a.deal_fee)
   from st_list_balance_line a, t#st_ist_settle_data_station b
   where a.e_line_id = b.line_id
   and a.e_station_id = b.station_id
   group by a.line_id_dispart, b.belong_line_id,b.contc_id, a.squad_day, a.balance_water_no,a.tr_type_id, a.pay_mode_id;

 -------------- ≤˙…˙‘À”™…Ã ’»ÎÕ≥º∆±Ìst_sts_income_contc_card
   v_msg := '≤Â»Î±Ìst_sts_income_contc_card';
   insert into st_sts_income_contc_card
   (  water_no,contc_id,squad_day,balance_water_no,card_main_id,card_sub_id,deal_num,deal_fee)
   select seq_st_sts_income_contc_card.nextval,contc_id,squad_day,balance_water_no,
      card_main_id,card_sub_id,deal_num,deal_fee
    from (
      select contc_id,squad_day,balance_water_no,card_main_id,card_sub_id,sum(deal_num) deal_num,sum(deal_fee) deal_fee
      from t#st_ist_settle_data_income
      group by contc_id, squad_day, balance_water_no, card_main_id,card_sub_id);

   --------- ≤˙…˙‘À”™…Ã(œﬂ¬∑)«Â∑÷Ω·π˚Õ≥º∆±Ìst_sts_dispart_contc/line
   v_msg := '≤Â»Î±Ìst_sts_dispart_contc';
   insert into st_sts_dispart_contc
   ( water_no,balance_water_no,squad_day,contc_id,line_id,deal_num,deal_fee)
   select seq_st_sts_dispart_contc.nextval,balance_water_no,squad_day,contc_id,belong_line_id,deal_num,deal_fee
   from (
    select balance_water_no,squad_day,contc_id,belong_line_id,sum(deal_num) deal_num,sum(deal_fee) deal_fee
    from t#st_ist_settle_data_end_contc
    group by balance_water_no,squad_day,contc_id,belong_line_id);

   v_msg := '≤Â»Î±Ìst_sts_dispart_line';
   insert into st_sts_dispart_line
   ( water_no,balance_water_no,squad_day,line_id_dispart,line_id,deal_num,deal_fee)
   select seq_st_sts_dispart_contc.nextval,balance_water_no,squad_day,line_id_dispart,belong_line_id,
      deal_num,deal_fee
   from (
    select balance_water_no,squad_day,line_id_dispart,belong_line_id,sum(deal_num) deal_num,sum(deal_fee) deal_fee
    from t#st_ist_settle_data_end_line
    group by  balance_water_no,squad_day,line_id_dispart,belong_line_id);
   -------------------------------∆‰À˚«Æ∞¸Ωª“◊ª„◊‹£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   v_msg := '≤Â»Î∆‰À˚«Æ∞¸Ωª“◊ª„◊‹contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
     case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then to_char(a.deal_datetime, 'yyyymmdd')
      else to_char(a.deal_datetime - 1, 'yyyymmdd')   end,
      a.balance_water_no,'54',a.pay_mode_id,count(*),sum(nvl(a.deal_fee, 0))
   from st_que_deal a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no
   and a.pay_mode_id not in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0')
   and a.pay_mode_id not in ('1A','4A')  --2014-6-22‘ˆº”  ver1.02
   and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id, b.belong_line_id, b.contc_id,
   case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then  to_char(a.deal_datetime, 'yyyymmdd')
   else to_char(a.deal_datetime - 1, 'yyyymmdd')  end,a.balance_water_no, a.pay_mode_id;

   v_msg := '≤Â»Î∆‰À˚«Æ∞¸Ωª“◊ª„◊‹line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
     case when to_char(a.deal_datetime, 'hh24mi') >= v_squad  then to_char(a.deal_datetime, 'yyyymmdd')
      else to_char(a.deal_datetime - 1, 'yyyymmdd') end,
      a.balance_water_no,'54',a.pay_mode_id,count(*),sum(nvl(a.deal_fee, 0))
   from st_que_deal a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no
   and a.pay_mode_id not in (select pay_mode_id from  op_prm_paymode_type_valid  where record_flag = '0')
   and a.pay_mode_id not in ('1A','4A')  --2014-6-22‘ˆº”  ver1.02
   and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id, b.contc_id,
   case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then  to_char(a.deal_datetime, 'yyyymmdd')
   else to_char(a.deal_datetime - 1, 'yyyymmdd')  end, a.balance_water_no, a.pay_mode_id;
   -----------------------------Õ≥º∆µ•≥Ã∆± €∆±--------
   v_msg:='≤Â»Îµ•≥Ã∆± €∆±';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
       '50', null,count(*),sum(nvl(a.deposit_fee+a.sale_fee, 0))
    from st_que_sale_sjt a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no
    and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id,b.belong_line_id,b.contc_id,case when to_char(a.sale_datetime, 'hh24mi') >= v_squad
   then to_char(a.sale_datetime, 'yyyymmdd') else to_char(a.sale_datetime - 1, 'yyyymmdd') end,a.balance_water_no;

   v_msg:='≤Â»Îµ•≥Ã∆± €∆±line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad   then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
       '50',null,count(*),sum(nvl(a.deposit_fee+a.sale_fee, 0))
    from st_que_sale_sjt a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no  and  (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id,b.contc_id,
   case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
   else   to_char(a.sale_datetime - 1, 'yyyymmdd') end, a.balance_water_no;

  -----------------------------Õ≥º∆∑«µ•≥Ã∆± €∆±----------------------------------
   v_msg:='≤Â»Î∑«µ•≥Ã∆± €∆±contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,
      a.balance_water_no,'51',null, count(*), sum(nvl(a.deposit_fee, 0))
   from st_que_sale a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id,b.belong_line_id,b.contc_id, case when to_char(a.sale_datetime, 'hh24mi') >= v_squad
   then   to_char(a.sale_datetime, 'yyyymmdd') else   to_char(a.sale_datetime - 1, 'yyyymmdd')   end,
   a.balance_water_no;

  v_msg:='≤Â»Î∑«µ•≥Ã∆± €∆±line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,
      a.balance_water_no,'51', null,count(*),sum(nvl(a.deposit_fee, 0))
   from st_que_sale a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id,b.contc_id, case
   when to_char(a.sale_datetime, 'hh24mi') >= v_squad  then   to_char(a.sale_datetime, 'yyyymmdd')
   else   to_char(a.sale_datetime - 1, 'yyyymmdd')   end, a.balance_water_no;
  -----------------------------Õ≥º∆ÕÀø®Ωª“◊
   v_msg := '≤Â»ÎÕÀø®Ωª“◊contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.return_datetime, 'hh24mi') >= v_squad  then to_char(a.return_datetime, 'yyyymmdd')
      else to_char(a.return_datetime - 1, 'yyyymmdd') end,a.balance_water_no,'57', return_type,
      count(*),sum(nvl(a.return_deposit_fee+return_balance_fee+penalty_fee, 0))
      from st_que_return a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id, b.belong_line_id,b.contc_id, case
   when to_char(a.return_datetime, 'hh24mi') >= v_squad then to_char(a.return_datetime, 'yyyymmdd')
   else to_char(a.return_datetime - 1, 'yyyymmdd') end, a.balance_water_no, return_type;

   v_msg := '≤Â»ÎÕÀø®Ωª“◊line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.return_datetime, 'hh24mi') >= v_squad then to_char(a.return_datetime, 'yyyymmdd')
      else to_char(a.return_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
      '57',return_type,count(*),sum(nvl(a.return_deposit_fee+return_balance_fee+penalty_fee, 0))
      from st_que_return a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and  (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id,b.contc_id,
   case when to_char(a.return_datetime, 'hh24mi') >= v_squad  then to_char(a.return_datetime, 'yyyymmdd')
   else to_char(a.return_datetime - 1, 'yyyymmdd')  end, a.balance_water_no, return_type;

   -----------------------------Õ≥º∆––’˛¥¶¿ÌΩª“◊
   v_msg := '≤Â»Î––’˛¥¶¿ÌΩª“◊contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
      else to_char(a.admin_datetime - 1, 'yyyymmdd') end, a.balance_water_no,
       '61', null,count(*),sum(nvl(a.penalty_fee-a.return_fee, 0))
    from st_que_admin a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id, b.belong_line_id, b.contc_id,
   case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
   else to_char(a.admin_datetime - 1, 'yyyymmdd') end, a.balance_water_no;

  v_msg := '≤Â»Î––’˛¥¶¿ÌΩª“◊line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
      else to_char(a.admin_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
      '61',null,count(*),sum(nvl(a.penalty_fee-a.return_fee, 0))
    from st_que_admin a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id, b.contc_id,
   case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
   else to_char(a.admin_datetime - 1, 'yyyymmdd')  end, a.balance_water_no;

   ----------≤˙…˙Ωª“◊ ˝æ›Ω·À„‘À”™…Ã(œﬂ¬∑)Õ≥º∆±Ìst_sts_balance_contc(line)_trd
   v_msg := '≤Â»Î±Ìst_sts_balance_contc_trd';
   insert into st_sts_balance_contc_trd
   select seq_st_sts_balance_contc_trd.nextval,contc_id,squad_day,balance_water_no,
      tr_type_id,pay_mode_id,deal_num,deal_fee
   from t#st_ist_settle_data_end_contc;

    v_msg := '≤Â»Î±Ìst_sts_balance_line_trd';
   insert into st_sts_balance_line_trd
   select seq_st_sts_balance_line_trd.nextval,balance_water_no,squad_day,line_id_dispart,
      tr_type_id,pay_mode_id,deal_num,deal_fee
   from t#st_ist_settle_data_end_line;

   -------------- ≤˙…˙‘À”™…Ã(œﬂ¬∑)Ω·À„Õ≥º∆±Ìst_sts_balance_contc_inc/st_sts_balance_line_inc
   v_msg := '≤Â»Î±Ìst_sts_balance_contc_inc ';
   insert into st_sts_balance_contc_inc
   select seq_st_sts_balance_contc_inc.nextval,balance_water_no,squad_day,contc_id,
      tr_type_id,pay_mode_id,deal_num,deal_fee,balance_ser_fee
    from (
      select balance_water_no,squad_day,a.contc_id,tr_type_id,pay_mode_id,
         sum(deal_num) deal_num,sum(deal_fee) deal_fee,
         round(sum(a.deal_fee * b.service_rate), 2 )  balance_ser_fee
      from t#st_ist_settle_data_end_contc a,op_prm_contc_service_rate b
      where  ((tr_type_id = '54' and pay_mode_id
              in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0'))--≥ˆ’¢
             or (tr_type_id='54' and a.pay_mode_id in ('1A','4A'))--∑«œ÷Ω∏¸–¬
             or	tr_type_id = '61' or tr_type_id='56') --œ÷Ω∏¸–¬
             and  a.contc_id = b.contc_id and b.record_flag = '0'
      group by balance_water_no,squad_day,a.contc_id,tr_type_id,pay_mode_id);

   v_msg := '≤Â»Î±Ìst_sts_balance_line_inc ';
   insert into st_sts_balance_line_inc
   select seq_st_sts_balance_line_inc.nextval,balance_water_no,squad_day,line_id_dispart,
      tr_type_id,pay_mode_id,deal_num,deal_fee,balance_ser_fee
    from (
      select balance_water_no,squad_day,line_id_dispart,tr_type_id,pay_mode_id,
         sum(deal_num) deal_num,sum(deal_fee) deal_fee,
         round(sum(a.deal_fee * b.service_rate), 2 )  balance_ser_fee
      from t#st_ist_settle_data_end_line a,op_prm_line_service_rate b
      where ((tr_type_id = '54' and pay_mode_id
            in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0')) --≥ˆ’¢
             or (tr_type_id='54' and a.pay_mode_id in ('1A','4A'))--∑«œ÷Ω∏¸–¬
             or tr_type_id = '61' or tr_type_id = '56' )  --œ÷Ω∏¸–¬
             and a.line_id_dispart=b.line_id and b.record_flag = '0'
      group by balance_water_no,squad_day,line_id_dispart,tr_type_id,pay_mode_id);

   --‘À”™…ÃΩª“◊»’±®‘ˆº”∆±ø®¿‡–Õπ§±æ∑— version v1.38
   --≤Â»Î∑«µ•≥Ã∆±∑¢ € ˝æ›
    insert into acc_st.t#st_ist_settle_data_inc_mode
      (contc_id, belong_line_id, belong_contc_id, squad_day, balance_water_no, card_main_id, card_sub_id, tr_type_id, pay_mode_id, deal_num, deal_fee, deposit_type)
     select b.contc_id,b.belong_line_id,b.contc_id,
        case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
        else to_char(a.sale_datetime - 1, 'yyyymmdd') end,
        a.balance_water_no,a.card_main_id,a.card_sub_id,'51',null,count(*), sum(nvl(a.deposit_fee, 0)),nvl(t.is_deposit_refund,'0')
     from acc_st.st_que_sale a, acc_st.t#st_ist_settle_data_station b, acc_st.op_prm_card_para t
     where a.balance_water_no=in_balance_water_no and (b.station_id = a.station_id and b.line_id = a.line_id)
     and a.card_main_id = t.card_main_id and a.card_sub_id = t.card_sub_id and t.record_flag = '0'
     group by a.card_main_id, a.card_sub_id,a.deposit_type, b.contc_id,b.belong_line_id,b.contc_id,nvl(t.is_deposit_refund,'0'),
     case when to_char(a.sale_datetime, 'hh24mi') >= v_squad
     then to_char(a.sale_datetime, 'yyyymmdd')
       else to_char(a.sale_datetime - 1, 'yyyymmdd') end, a.balance_water_no;
   --≤Â»Îœ˚∑— ˝æ›
   insert into acc_st.t#st_ist_settle_data_inc_mode
      (contc_id, belong_line_id, belong_contc_id, squad_day, balance_water_no, card_main_id, card_sub_id, tr_type_id, pay_mode_id, deal_num, deal_fee, deposit_type)
   select contc_id, belong_line_id, belong_contc_id, squad_day, balance_water_no, card_main_id, card_sub_id, tr_type_id, pay_mode_id, deal_num, deal_fee, null
   from acc_st.t#st_ist_settle_data_income;
   --≤Â»ÎÕ≥º∆±Ì
   insert into acc_st.st_sts_income_contc_card_mode
      (water_no, contc_id, belong_line_id, belong_contc_id, squad_day, balance_water_no, card_main_id, card_sub_id,
      tr_type_id, pay_mode_id, deal_num, deal_fee, deposit_type)
    select SEQ_ST_STS_INC_CONTC_CARD_MODE.NEXTVAL, a.contc_id, a.belong_line_id, a.belong_contc_id, a.squad_day, a.balance_water_no, a.card_main_id, a.card_sub_id,
      a.tr_type_id, a.pay_mode_id, a.deal_num, a.deal_fee, a.deposit_type
    from acc_st.t#st_ist_settle_data_inc_mode a;
   --º∆À„∑˛ŒÒ∑—
   /*
   insert into acc_st.st_sts_income_contc_card_mode
      (water_no, contc_id, belong_line_id, belong_contc_id, squad_day, balance_water_no, card_main_id, card_sub_id,
      tr_type_id, pay_mode_id, deal_num, deal_fee, deposit_type)
    select SEQ_ST_STS_INC_CONTC_CARD_MODE.NEXTVAL, a.contc_id, a.belong_line_id, a.belong_contc_id, a.squad_day, a.balance_water_no, a.card_main_id, a.card_sub_id,
      a.tr_type_id, a.pay_mode_id, a.deal_num, round((a.deal_fee* b.service_rate),2) balance_ser_fee,null
    from acc_st.t#st_ist_settle_data_inc_mode a,acc_st.op_prm_contc_service_rate b
    where  ((a.tr_type_id = '54' and a.pay_mode_id
                  in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0'))--≥ˆ’¢
                 or (a.tr_type_id='54' and a.pay_mode_id in ('1A','4A'))--∑«œ÷Ω∏¸–¬
                 or  a.tr_type_id in ('61','56')) --œ÷Ω∏¸–¬
                 and a.contc_id = b.contc_id and b.record_flag = '0';
                 */

   commit;
   out_msg := 'success';
   out_retresult := 0;
   exception
   when others
   then
      begin
         rollback;
          out_msg:=v_msg||'¥ÌŒÛ£∫' || sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
          out_retresult := sqlcode;
         return;
      end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_DATA to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA1
prompt =========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_data1(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
as
---------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_st_ist_settle_data
   --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-µº»Î«ÂÀ„÷–º‰±Ì
   -- ‰≥ˆ≤Œ ˝£∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
   --∑µªÿ÷µ  £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
   --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú 20130801
   --–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
           --ver1.02  »•µÙº”»Î∑«∏∂∑—«¯∏¸–¬ 2014-6-22
           --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
   -------------------------------------------------------------------------------
   v_msg varchar(50);
   v_count int;
   v_sql varchar(200);
   v_squad varchar(4);

begin
   -----------»°µ√‘À”™ ±º‰
   select cfg_value into v_squad  from st_cfg_sys_base where cfg_key='sys.squadday' and record_flag='0';
   ---Ω®¡¢À˜“˝
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_CONTC'  and index_name = 'IDX_BALANCE_END';
   if v_count <= 0  then
      v_msg := '±Ìst_list_balance_contcΩ®¡¢À˜“˝';
      v_sql :='create  index IDX_BALANCE_END on ST_LIST_BALANCE_CONTC(e_line_id,e_station_id)
       TABLESPACE TBS_ST_IDX';
      execute immediate v_sql;
   end if;
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_LINE'  and index_name = 'IDX_BALANCE_END_LINE';
   if v_count <= 0  then
      v_msg := '±Ìst_list_balance_lineΩ®¡¢À˜“˝';
      v_sql :='create  index IDX_BALANCE_END_LINE on ST_LIST_BALANCE_LINE(e_line_id,e_station_id)
       TABLESPACE TBS_ST_IDX';
      execute immediate v_sql;
   end if;
   --------------------ºÏ≤È «∑Ò“—«ÂÀ„π˝-----------------------
   select count(*) into v_count  from st_sts_balance_contc_trd where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_contc_trd“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_balance_line_trd where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_line_trd“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_income_contc_card where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_income_contc_card“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_balance_contc_inc where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_contc_inc“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_balance_line_inc where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_balance_line_inc“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_dispart_contc where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_dispart_contc“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_dispart_line where balance_water_no = in_balance_water_no;
   if v_count > 0    then
      out_msg := 'st_sts_dispart_line“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   -----------------------------»°µ√≥µ’æ–≈œ¢
   v_msg := '≤Â»Î±Ì#st_ist_settle_data_station';
   insert into t#st_ist_settle_data_station(line_id,station_id,belong_line_id,contc_id)
    select line_id,station_id,belong_line_id,contc_id
   from op_prm_station where record_flag = '0';
   
   ---------------  ‘À”™…Ã ’»Î¡Ÿ ±±Ì
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_income';
   insert into t#st_ist_settle_data_income
   select a.contc_id,  --∑÷’À‘À”™…Ã
      b.belong_line_id, --’æµ„πÈ Ùµƒœﬂ¬∑
      b.contc_id,      --’æµ„πÈ Ùµƒ‘À”™…Ã
      a.squad_day, a.balance_water_no,a.card_main_id,a.card_sub_id,
      a.tr_type_id,a.pay_mode_id,sum(a.deal_num),sum(a.deal_fee)
   from st_list_balance_contc a, t#st_ist_settle_data_station b
   where a.e_line_id = b.line_id  and a.e_station_id = b.station_id
   group by a.contc_id, b.belong_line_id,b.contc_id, a.squad_day,
   a.balance_water_no,a.card_main_id, a.card_sub_id, a.tr_type_id, a.pay_mode_id;
 
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_end_contc';
   insert into t#st_ist_settle_data_end_contc
   (contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,tr_type_id,pay_mode_id,deal_num,deal_fee)
   select contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,
      tr_type_id, pay_mode_id,sum(deal_num),sum(nvl(deal_fee, 0))
    from t#st_ist_settle_data_income
   group by contc_id,belong_line_id,belong_contc_id,squad_day,balance_water_no,tr_type_id,pay_mode_id;

    v_msg := '≤Â»Î±Ìt#st_ist_settle_data_end_line';
   insert into t#st_ist_settle_data_end_line
   (line_id_dispart,belong_line_id,belong_contc_id,squad_day,balance_water_no,tr_type_id,pay_mode_id,deal_num,deal_fee)
   select a.line_id_dispart,b.belong_line_id,b.contc_id,a.squad_day,a.balance_water_no,
      a.tr_type_id,a.pay_mode_id,sum(a.deal_num),sum(a.deal_fee)
   from st_list_balance_line a, t#st_ist_settle_data_station b
   where a.e_line_id = b.line_id
   and a.e_station_id = b.station_id
   group by a.line_id_dispart, b.belong_line_id,b.contc_id, a.squad_day, a.balance_water_no,a.tr_type_id, a.pay_mode_id;

 -------------- ≤˙…˙‘À”™…Ã ’»ÎÕ≥º∆±Ìst_sts_income_contc_card
   v_msg := '≤Â»Î±Ìst_sts_income_contc_card';
   insert into st_sts_income_contc_card
   (  water_no,contc_id,squad_day,balance_water_no,card_main_id,card_sub_id,deal_num,deal_fee)
   select seq_st_sts_income_contc_card.nextval,contc_id,squad_day,balance_water_no,
      card_main_id,card_sub_id,deal_num,deal_fee
    from (
      select contc_id,squad_day,balance_water_no,card_main_id,card_sub_id,sum(deal_num) deal_num,sum(deal_fee) deal_fee
      from t#st_ist_settle_data_income
      group by contc_id, squad_day, balance_water_no, card_main_id,card_sub_id);

   --------- ≤˙…˙‘À”™…Ã(œﬂ¬∑)«Â∑÷Ω·π˚Õ≥º∆±Ìst_sts_dispart_contc/line
   v_msg := '≤Â»Î±Ìst_sts_dispart_contc';
   insert into st_sts_dispart_contc
   ( water_no,balance_water_no,squad_day,contc_id,line_id,deal_num,deal_fee)
   select seq_st_sts_dispart_contc.nextval,balance_water_no,squad_day,contc_id,belong_line_id,deal_num,deal_fee
   from (
    select balance_water_no,squad_day,contc_id,belong_line_id,sum(deal_num) deal_num,sum(deal_fee) deal_fee
    from t#st_ist_settle_data_end_contc
    group by balance_water_no,squad_day,contc_id,belong_line_id);

   v_msg := '≤Â»Î±Ìst_sts_dispart_line';
   insert into st_sts_dispart_line
   ( water_no,balance_water_no,squad_day,line_id_dispart,line_id,deal_num,deal_fee)
   select seq_st_sts_dispart_contc.nextval,balance_water_no,squad_day,line_id_dispart,belong_line_id,
      deal_num,deal_fee
   from (
    select balance_water_no,squad_day,line_id_dispart,belong_line_id,sum(deal_num) deal_num,sum(deal_fee) deal_fee
    from t#st_ist_settle_data_end_line
    group by  balance_water_no,squad_day,line_id_dispart,belong_line_id);
   -------------------------------∆‰À˚«Æ∞¸Ωª“◊ª„◊‹£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   v_msg := '≤Â»Î∆‰À˚«Æ∞¸Ωª“◊ª„◊‹contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
     case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then to_char(a.deal_datetime, 'yyyymmdd')
      else to_char(a.deal_datetime - 1, 'yyyymmdd')   end,
      a.balance_water_no,'54',a.pay_mode_id,count(*),sum(nvl(a.deal_fee, 0))
   from  acc_st_his.st_his_deal a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no 
   and a.pay_mode_id not in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0')
   and a.pay_mode_id not in ('1A','4A')  --2014-6-22‘ˆº” 
   and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id, b.belong_line_id, b.contc_id,
   case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then  to_char(a.deal_datetime, 'yyyymmdd')
   else to_char(a.deal_datetime - 1, 'yyyymmdd')  end,a.balance_water_no, a.pay_mode_id;

   v_msg := '≤Â»Î∆‰À˚«Æ∞¸Ωª“◊ª„◊‹line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
     case when to_char(a.deal_datetime, 'hh24mi') >= v_squad  then to_char(a.deal_datetime, 'yyyymmdd')
      else to_char(a.deal_datetime - 1, 'yyyymmdd') end,
      a.balance_water_no,'54',a.pay_mode_id,count(*),sum(nvl(a.deal_fee, 0))
   from acc_st_his.st_his_deal a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no 
   and a.pay_mode_id not in (select pay_mode_id from  op_prm_paymode_type_valid  where record_flag = '0')
   and a.pay_mode_id not in ('1A','4A')  --2014-6-22‘ˆº” 
   and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id, b.contc_id,
   case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then  to_char(a.deal_datetime, 'yyyymmdd')
   else to_char(a.deal_datetime - 1, 'yyyymmdd')  end, a.balance_water_no, a.pay_mode_id;
   -----------------------------Õ≥º∆µ•≥Ã∆± €∆±--------
   v_msg:='≤Â»Îµ•≥Ã∆± €∆±';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
       '50', null,count(*),sum(nvl(a.deposit_fee+a.sale_fee, 0))
    from acc_st_his.st_his_sale_sjt a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no 
    and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id,b.belong_line_id,b.contc_id,case when to_char(a.sale_datetime, 'hh24mi') >= v_squad
   then to_char(a.sale_datetime, 'yyyymmdd') else to_char(a.sale_datetime - 1, 'yyyymmdd') end,a.balance_water_no;

   v_msg:='≤Â»Îµ•≥Ã∆± €∆±line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad   then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
       '50',null,count(*),sum(nvl(a.deposit_fee+a.sale_fee, 0))
    from acc_st_his.st_his_sale_sjt a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no  and  (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id,b.contc_id,
   case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
   else   to_char(a.sale_datetime - 1, 'yyyymmdd') end, a.balance_water_no;

  -----------------------------Õ≥º∆∑«µ•≥Ã∆± €∆±----------------------------------
   v_msg:='≤Â»Î∑«µ•≥Ã∆± €∆±contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,
      a.balance_water_no,'51',null, count(*), sum(nvl(a.deposit_fee, 0))
   from acc_st_his.st_his_sale a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id,b.belong_line_id,b.contc_id, case when to_char(a.sale_datetime, 'hh24mi') >= v_squad
   then   to_char(a.sale_datetime, 'yyyymmdd') else   to_char(a.sale_datetime - 1, 'yyyymmdd')   end,
   a.balance_water_no;

  v_msg:='≤Â»Î∑«µ•≥Ã∆± €∆±line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.sale_datetime, 'hh24mi') >= v_squad then to_char(a.sale_datetime, 'yyyymmdd')
      else to_char(a.sale_datetime - 1, 'yyyymmdd') end,
      a.balance_water_no,'51', null,count(*),sum(nvl(a.deposit_fee, 0))
   from acc_st_his.st_his_sale a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id,b.contc_id, case
   when to_char(a.sale_datetime, 'hh24mi') >= v_squad  then   to_char(a.sale_datetime, 'yyyymmdd')
   else   to_char(a.sale_datetime - 1, 'yyyymmdd')   end, a.balance_water_no;
  -----------------------------Õ≥º∆ÕÀø®Ωª“◊
   v_msg := '≤Â»ÎÕÀø®Ωª“◊contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.return_datetime, 'hh24mi') >= v_squad  then to_char(a.return_datetime, 'yyyymmdd')
      else to_char(a.return_datetime - 1, 'yyyymmdd') end,a.balance_water_no,'57', return_type,
      count(*),sum(nvl(a.return_deposit_fee+return_balance_fee+penalty_fee, 0))
      from acc_st_his.st_his_return a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id, b.belong_line_id,b.contc_id, case
   when to_char(a.return_datetime, 'hh24mi') >= v_squad then to_char(a.return_datetime, 'yyyymmdd')
   else to_char(a.return_datetime - 1, 'yyyymmdd') end, a.balance_water_no, return_type;

   v_msg := '≤Â»ÎÕÀø®Ωª“◊line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.return_datetime, 'hh24mi') >= v_squad then to_char(a.return_datetime, 'yyyymmdd')
      else to_char(a.return_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
      '57',return_type,count(*),sum(nvl(a.return_deposit_fee+return_balance_fee+penalty_fee, 0))
      from acc_st_his.st_his_return a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and  (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id,b.contc_id,
   case when to_char(a.return_datetime, 'hh24mi') >= v_squad  then to_char(a.return_datetime, 'yyyymmdd')
   else to_char(a.return_datetime - 1, 'yyyymmdd')  end, a.balance_water_no, return_type;

   -----------------------------Õ≥º∆––’˛¥¶¿ÌΩª“◊
   v_msg := '≤Â»Î––’˛¥¶¿ÌΩª“◊contc';
   insert into t#st_ist_settle_data_end_contc
   select b.contc_id,b.belong_line_id,b.contc_id,
      case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
      else to_char(a.admin_datetime - 1, 'yyyymmdd') end, a.balance_water_no,
       '61', null,count(*),sum(nvl(a.penalty_fee-a.return_fee, 0))
    from acc_st_his.st_his_admin a, t#st_ist_settle_data_station b
   where  a.balance_water_no=in_balance_water_no  and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.contc_id, b.belong_line_id, b.contc_id,
   case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
   else to_char(a.admin_datetime - 1, 'yyyymmdd') end, a.balance_water_no;

  v_msg := '≤Â»Î––’˛¥¶¿ÌΩª“◊line';
   insert into t#st_ist_settle_data_end_line
   select b.belong_line_id,b.belong_line_id,b.contc_id,
      case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
      else to_char(a.admin_datetime - 1, 'yyyymmdd') end,a.balance_water_no,
      '61',null,count(*),sum(nvl(a.penalty_fee-a.return_fee, 0))
    from acc_st_his.st_his_admin a, t#st_ist_settle_data_station b
   where a.balance_water_no=in_balance_water_no and (b.station_id = a.station_id and b.line_id = a.line_id)
   group by b.belong_line_id, b.belong_line_id, b.contc_id,
   case when to_char(a.admin_datetime, 'hh24mi') >= v_squad then to_char(a.admin_datetime, 'yyyymmdd')
   else to_char(a.admin_datetime - 1, 'yyyymmdd')  end, a.balance_water_no;

   ----------≤˙…˙Ωª“◊ ˝æ›Ω·À„‘À”™…Ã(œﬂ¬∑)Õ≥º∆±Ìst_sts_balance_contc(line)_trd
   v_msg := '≤Â»Î±Ìst_sts_balance_contc_trd';
   insert into st_sts_balance_contc_trd
   select seq_st_sts_balance_contc_trd.nextval,contc_id,squad_day,balance_water_no,
      tr_type_id,pay_mode_id,deal_num,deal_fee
   from t#st_ist_settle_data_end_contc;

    v_msg := '≤Â»Î±Ìst_sts_balance_line_trd';
   insert into st_sts_balance_line_trd
   select seq_st_sts_balance_line_trd.nextval,balance_water_no,squad_day,line_id_dispart,
      tr_type_id,pay_mode_id,deal_num,deal_fee
   from t#st_ist_settle_data_end_line;

   -------------- ≤˙…˙‘À”™…Ã(œﬂ¬∑)Ω·À„Õ≥º∆±Ìst_sts_balance_contc_inc/st_sts_balance_line_inc
   v_msg := '≤Â»Î±Ìst_sts_balance_contc_inc ';
   insert into st_sts_balance_contc_inc
   select seq_st_sts_balance_contc_inc.nextval,balance_water_no,squad_day,contc_id,
      tr_type_id,pay_mode_id,deal_num,deal_fee,balance_ser_fee
    from (
      select balance_water_no,squad_day,a.contc_id,tr_type_id,pay_mode_id,
         sum(deal_num) deal_num,sum(deal_fee) deal_fee,
         round(sum(a.deal_fee * b.service_rate), 2 )  balance_ser_fee
      from t#st_ist_settle_data_end_contc a,op_prm_contc_service_rate b
      where  ((tr_type_id = '54' and pay_mode_id 
              in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0'))--≥ˆ’¢ 
             or (tr_type_id='54' and a.pay_mode_id in ('1A','4A'))--∑«œ÷Ω∏¸–¬
             or	tr_type_id = '61' or tr_type_id='56') --œ÷Ω∏¸–¬
             and  a.contc_id = b.contc_id and b.record_flag = '0'
      group by balance_water_no,squad_day,a.contc_id,tr_type_id,pay_mode_id);
 
   v_msg := '≤Â»Î±Ìst_sts_balance_line_inc ';
   insert into st_sts_balance_line_inc
   select seq_st_sts_balance_line_inc.nextval,balance_water_no,squad_day,line_id_dispart,
      tr_type_id,pay_mode_id,deal_num,deal_fee,balance_ser_fee
    from (
      select balance_water_no,squad_day,line_id_dispart,tr_type_id,pay_mode_id,
         sum(deal_num) deal_num,sum(deal_fee) deal_fee,
         round(sum(a.deal_fee * b.service_rate), 2 )  balance_ser_fee
      from t#st_ist_settle_data_end_line a,op_prm_line_service_rate b
      where ((tr_type_id = '54' and pay_mode_id 
            in (select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0')) --≥ˆ’¢ 
             or (tr_type_id='54' and a.pay_mode_id in ('1A','4A'))--∑«œ÷Ω∏¸–¬
             or tr_type_id = '61' or tr_type_id = '56' )  --œ÷Ω∏¸–¬
             and a.line_id_dispart=b.line_id and b.record_flag = '0'
      group by balance_water_no,squad_day,line_id_dispart,tr_type_id,pay_mode_id);
   commit;
   out_msg := 'success';
   out_retresult := 0;
   exception
   when others
   then
      begin
         rollback;
          out_msg:=v_msg||'¥ÌŒÛ£∫' || sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
          out_retresult := sqlcode;
         return;
      end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA_MAX
prompt ============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_data_max(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2
)
 as
-----------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_data_max
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫∑÷’À‘À”™…Ã(◊Ó¥Û‘À”™…Ã)
--¥¥Ω®»À  £∫lili 2013-07-31
--–ﬁ∏ƒ£∫   --ver1.01 2014-6-9
           --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
   ---------------------------------------------------------------------------
   v_msg varchar(50);
   v_count int;
   v_sql varchar(200);
begin
   --ºÏ≤Èª„◊‹±Ìst_list_balance_contc «∑ÒΩ®¡¢À˜“˝
   select count(*)   into v_count  from user_indexes where table_name = 'ST_LIST_BALANCE_CONTC'
   and index_name = 'IDX_ST_LIST_BALANCE_CONTC';
   if v_count <= 0  then
      v_sql :='create  index IDX_ST_LIST_BALANCE_CONTC on
        ST_LIST_BALANCE_CONTC(b_line_id,b_station_id,e_line_id,e_station_id,version_no)
         TABLESPACE TBS_ST_IDX';
      execute immediate v_sql;
   end if;
    --ºÏ≤Èª„◊‹±Ìst_list_balance_line «∑ÒΩ®¡¢À˜“˝
    select count(*)   into v_count  from user_indexes where table_name = 'ST_LIST_BALANCE_LINE'
   and index_name = 'IDX_ST_LIST_BALANCE_LINE';
   if v_count <= 0  then
      v_sql :='create  index IDX_ST_LIST_BALANCE_LINE on
        ST_LIST_BALANCE_LINE(b_line_id,b_station_id,e_line_id,e_station_id,version_no)
         TABLESPACE TBS_ST_IDX';
      execute immediate v_sql;
   end if;
   -------------------------«ÂÀ„ ¬ŒÒø™ º£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   --------------∑÷’ –≈œ¢Õ≥º∆£®‘À”™…Ã£©
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_max_num';
   insert into t#st_ist_settle_data_max_num
   select /*+ index(a deal_assign_contc_idx) */
      a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,
      a.version_no,count(*),max(a.contc_id)
   from op_prm_deal_assign_contc a, op_prm_para_ver_now b
   where a.version_no = b.version_no and b.parm_type_id ='9004'
   group by b_line_id, b_station_id, e_line_id, e_station_id, a.version_no;
   -------------≤Â»Î◊Ó¥Û‘À”™…ÃµƒΩ∂Ó
   select count(*) into v_count from t#st_ist_settle_data_max_num where contc_line_num > 1 ;
   if v_count > 0  then
      v_msg := '≤Â»Î±Ìst_list_balance_contc';
      insert into st_list_balance_contc
      select c.max_contc_line,b.b_line_id,b.b_station_id,b.e_line_id,
         b.e_station_id,b.squad_day,b.balance_water_no,b.card_main_id,
         b.card_sub_id,b.tr_type_id,b.pay_mode_id,
         a.deal_num - nvl(sum(b.deal_num), 0),a.deal_fee - nvl(sum(b.deal_fee), 0),a.version_no_9004
      from st_list_balance_trx a, st_list_balance_contc b,t#st_ist_settle_data_max_num c
      where a.b_line_id = b.b_line_id and a.b_station_id = b.b_station_id
      and a.e_line_id = b.e_line_id and a.e_station_id = b.e_station_id and a.squad_day = b.squad_day
      and a.balance_water_no = b.balance_water_no and a.card_main_id = b.card_main_id
      and a.card_sub_id = b.card_sub_id and a.tr_type_id = b.tr_type_id
      and (a.pay_mode_id = b.pay_mode_id or (a.pay_mode_id is null  and b.pay_mode_id is null))
      and a.b_line_id = c.b_line_id and a.b_station_id = c.b_station_id
      and a.e_line_id = c.e_line_id and a.e_station_id = c.e_station_id
      and a.version_no_9004 = c.version_no and a.version_no_9004 = b.version_no and c.contc_line_num > 1
      group by c.max_contc_line, b.b_line_id, b.b_station_id, b.e_line_id,b.e_station_id,
      b.squad_day, b.balance_water_no, b.card_main_id, b.card_sub_id, b.tr_type_id, b.pay_mode_id,
      a.deal_num, a.deal_fee, a.version_no_9004;
   end if;
   --------------∑÷’ –≈œ¢Õ≥º∆£®œﬂ¬∑£©
   delete t#st_ist_settle_data_max_num;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_max_numœﬂ¬∑';
   insert into t#st_ist_settle_data_max_num
   select /*+ index (a deal_assign_para_line_idx) */
      a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.version_no,count(*),max(a.line_id_dispart)
   from op_prm_deal_assign_line a, op_prm_para_ver_now b
   where a.version_no = b.version_no and b.parm_type_id='9003'
   group by b_line_id, b_station_id, e_line_id, e_station_id, a.version_no;
   -------------≤Â»Î◊Ó¥Ûœﬂ¬∑µƒΩ∂Ó
   select count(*) into v_count from t#st_ist_settle_data_max_num where contc_line_num > 1 ;
   if v_count > 0  then
      v_msg := '≤Â»Î±Ìst_list_balance_line';
      insert into st_list_balance_line
      select c.max_contc_line,b.b_line_id,b.b_station_id,b.e_line_id,b.e_station_id,b.squad_day,
         b.balance_water_no,b.card_main_id,b.card_sub_id,b.tr_type_id,b.pay_mode_id,
         a.deal_num - nvl(sum(b.deal_num), 0),a.deal_fee - nvl(sum(b.deal_fee),0), a.version_no_9003
      from st_list_balance_trx a, st_list_balance_line b,t#st_ist_settle_data_max_num c
      where a.b_line_id = b.b_line_id  and a.b_station_id = b.b_station_id
      and a.e_line_id = b.e_line_id    and a.e_station_id = b.e_station_id
      and a.squad_day = b.squad_day    and a.balance_water_no = b.balance_water_no
      and a.card_main_id = b.card_main_id  and a.card_sub_id = b.card_sub_id
      and a.tr_type_id = b.tr_type_id
      and (a.pay_mode_id = b.pay_mode_id or (a.pay_mode_id is null and b.pay_mode_id is null))
      and a.b_line_id = c.b_line_id and a.b_station_id = c.b_station_id and a.e_line_id = c.e_line_id
      and a.e_station_id = c.e_station_id and a.version_no_9003 = c.version_no
      and a.version_no_9003 = b.version_no and c.contc_line_num > 1
      group by c.max_contc_line, b.b_line_id, b.b_station_id, b.e_line_id,   b.e_station_id,b.squad_day,
       b.balance_water_no, b.card_main_id, b.card_sub_id, b.tr_type_id, b.pay_mode_id, a.deal_num,
       a.deal_fee, a.version_no_9003;
   end if;
   commit;
   out_msg := 'success';
   out_retresult := 0;
   exception
   when others
   then
      begin
         rollback;
         out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
         out_retresult := sqlcode;
         return;
      end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_DATA_MAX to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA_MID
prompt ============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_data_mid(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2
)
 as
---------------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_st_ist_settle_data_mid
   --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„-∑÷’À‘À”™…Ã(∑«◊Ó¥Û‘À”™…Ã)
   --¥¥Ω®»À  £∫lili 2013-07-31
   --–ﬁ∏ƒ£∫--ver1.01  2014-6-9
          --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
   ---------------------------------------------------------------------------
   v_msg varchar(50);
begin
   delete st_list_balance_contc ;
   delete st_list_balance_line ;
  --------------∑÷’ –≈œ¢Õ≥º∆(‘À”™…Ã)
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_mid_num';
   insert into t#st_ist_settle_data_mid_num
   select /*+ index ( a deal_assign_contc_idx) */
      a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.version_no,count(*),max(a.contc_id)
   from op_prm_deal_assign_contc a, op_prm_para_ver_now b
   where a.version_no = b.version_no and b.parm_type_id='9004'
   group by b_line_id,b_station_id,e_line_id,e_station_id,a.version_no;

   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_mid_now';
   insert into t#st_ist_settle_data_mid_now
   select a.version_no,a.b_line_id,a.b_station_id,a.contc_id,a.e_line_id,a.e_station_id,a.in_percent
   from op_prm_deal_assign_contc a, t#st_ist_settle_data_mid_num b
   where a.version_no = b.version_no  and a.b_line_id = b.begin_line_id and a.b_station_id = b.begin_station_id
   and a.e_line_id = b.end_line_id and a.e_station_id = b.end_station_id
   and (a.contc_id != b.max_contc_line or b.contc_line_num = 1);

   v_msg := '≤Â»Î±Ìst_list_balance_contc(ODÕÍ’˚)';
   insert into st_list_balance_contc
   select b.contc_line_id,a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.squad_day,
      a.balance_water_no,a.card_main_id,a.card_sub_id,a.tr_type_id,pay_mode_id,
      round(sum(a.deal_num * b.in_percent), 2),round(sum(a.deal_fee * b.in_percent), 2),a.version_no_9004
   from st_list_balance_trx a, t#st_ist_settle_data_mid_now b
   where a.b_line_id = b.b_line_id  and a.b_station_id = b.b_station_id  and a.e_line_id = b.e_line_id
   and a.e_station_id = b.e_station_id  and a.version_no_9004 = b.version_no
   group by b.contc_line_id, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id
   ,a.squad_day,a.balance_water_no,a.card_main_id,a.card_sub_id, a.tr_type_id,
   a.pay_mode_id,a.version_no_9004 ;

   v_msg := '≤Â»Î±Ìst_list_balance_contc(Ω¯’æ¬Î≤ª’˝»∑)'; --2014-4-30‘ˆº” 
   insert into st_list_balance_contc
   select b.contc_id,a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.squad_day,
      a.balance_water_no,a.card_main_id,a.card_sub_id,a.tr_type_id,pay_mode_id,
      round(sum(a.deal_num ), 2),round(sum(a.deal_fee ), 2),a.version_no_9004
   from st_list_balance_trx a,op_prm_station b 
  where  a.b_line_id||a.b_station_id not in 
        (select b_line_id||b_station_id from op_prm_deal_assign_contc where record_flag='0') 
        and a.e_line_id = b.line_id  and a.e_station_id = b.station_id and a.version_no_9004 = b.version_no
   group by b.contc_id, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id
   ,a.squad_day,a.balance_water_no,a.card_main_id,a.card_sub_id, a.tr_type_id,
   a.pay_mode_id,a.version_no_9004 ;
   
     --------------∑÷’ –≈œ¢Õ≥º∆(œﬂ¬∑)
   delete t#st_ist_settle_data_mid_num;
   delete t#st_ist_settle_data_mid_now;

   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_mid_num';
   insert into t#st_ist_settle_data_mid_num
   select /*+ index (a DEAL_ASSIGN_PARA_LINE_IDX) */
      a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.version_no,
      count(*),max(a.line_id_dispart)
   from op_prm_deal_assign_line a, op_prm_para_ver_now b
   where a.version_no = b.version_no and b.parm_type_id='9003'
   group by b_line_id,b_station_id,e_line_id,e_station_id,a.version_no;
 
   v_msg := '≤Â»Î±Ìt#st_ist_settle_data_mid_now';
   insert into t#st_ist_settle_data_mid_now
   select a.version_no,a.b_line_id,a.b_station_id,a.line_id_dispart,a.e_line_id,a.e_station_id,a.in_percent
   from op_prm_deal_assign_line a, t#st_ist_settle_data_mid_num b
   where a.version_no = b.version_no and a.b_line_id = b.begin_line_id and a.b_station_id = b.begin_station_id and a.e_line_id = b.end_line_id
   and a.e_station_id = b.end_station_id and (a.line_id_dispart != b.max_contc_line or b.contc_line_num = 1);

   v_msg := '≤Â»Î±Ìst_list_balance_line(ODÕÍ’˚)';
   insert into st_list_balance_line
   select b.contc_line_id,a.b_line_id,a.b_station_id,a.e_line_id, a.e_station_id,a.squad_day,
      a.balance_water_no,a.card_main_id,a.card_sub_id,a.tr_type_id, pay_mode_id,
      round(sum(a.deal_num * b.in_percent), 2),round(sum(a.deal_fee * b.in_percent), 2),
      a.version_no_9003
   from st_list_balance_trx a, t#st_ist_settle_data_mid_now b
   where a.b_line_id = b.b_line_id and a.b_station_id = b.b_station_id  and a.e_line_id = b.e_line_id
   and a.e_station_id = b.e_station_id  and a.version_no_9003 = b.version_no
   group by b.contc_line_id, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id,
   a.squad_day, a.balance_water_no, a.card_main_id, a.card_sub_id, a.tr_type_id, a.pay_mode_id,
    a.version_no_9003 ;
 
   v_msg := '≤Â»Î±Ìst_list_balance_contc(Ω¯’æ¬Î≤ª’˝»∑)'; --2014-4-30‘ˆº” 
   insert into st_list_balance_line
   select b.contc_id,a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.squad_day,
      a.balance_water_no,a.card_main_id,a.card_sub_id,a.tr_type_id,pay_mode_id,
      round(sum(a.deal_num ), 2),round(sum(a.deal_fee ), 2),a.version_no_9003
   from st_list_balance_trx a,op_prm_station b 
   where a.b_line_id||a.b_station_id not in 
         (select b_line_id||b_station_id from  op_prm_deal_assign_line  where record_flag='0')
         and  a.e_line_id = b.line_id  and a.e_station_id = b.station_id and a.version_no_9003 = b.version_no
   group by b.contc_id, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id
   ,a.squad_day,a.balance_water_no,a.card_main_id,a.card_sub_id, a.tr_type_id,
   a.pay_mode_id,a.version_no_9003 ;

  commit;
   out_msg := 'success';
   out_retresult := 0;
   exception
   when others
   then
      begin
         rollback;
         out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
         out_retresult := sqlcode;
         return;
      end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_DATA_MID to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA_QUEUE
prompt ==============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_data_queue(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
 as
---------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_st_ist_settle_contc_queue
   --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì--Ωª“◊ª„◊‹
   -- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
   --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
   --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
   --–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
           --ver1.02  –ﬁ∏ƒ»°∏¸–¬∑Ω Ω£∫£®∑«œ÷Ω£©∏¸–¬¥”deal»°£¨œ÷Ω∏¸–¬¥”update»° 2014-6-22
           --ver1.03  ∑«œ÷Ω∏¸–¬º”…œupdate±Ì∑£ΩŒ™0µƒ 2014-7-16
           --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
   ---------------------------------------------------------------------------
   v_msg varchar(50);
   v_count int;
   v_count1 int;
   v_count2 int;
   v_count3 int;
   v_sql varchar(200);
   v_max_9003 numeric(8, 0); --◊Ó¥Û«Â∑÷∞Ê±æ(œﬂ¬∑)
   v_max_9004 numeric(8, 0); --◊Ó¥Û«Â∑÷∞Ê±æ(‘À”™…Ã)
   v_squad varchar(4);
begin
   -----------»°µ√‘À”™ ±º‰
   select cfg_value into v_squad  from st_cfg_sys_base
    where cfg_key='sys.squadday'  and record_flag='0';
   
  --------------------------ºÏ≤ÈΩª“◊∑÷≈‰±»¿˝µƒ∞Ê±æ
   select count(*) into v_count  from op_prm_deal_assign_contc where record_flag= '0';
   select count(*) into v_count1 from op_prm_deal_assign_line where record_flag= '0';
   select count(*) into v_count2 from op_prm_para_ver where parm_type_id ='9003' and record_flag = '0' ;
   select count(*) into v_count3 from op_prm_para_ver where parm_type_id ='9004' and record_flag = '0';
   if (v_count <= 0 or v_count1 <= 0 or v_count2 <= 0 or v_count3 <= 0) then
      out_msg := '≤Œ ˝∞Ê±æº«¬º±Ì÷–√ª”–œﬂ¬∑«Â∑÷πÊ‘Úµ±«∞∞Ê±æ£¨Œﬁ∑®«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   
   --œ»…æ≥˝÷–º‰ª„◊‹±Ìst_list_balance_contc(line)µƒÀ˜“˝£¨∑Ω±„œ¬√Êµƒ ˝æ›≤Â»Î
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_CONTC' and index_name = 'IDX_ST_LIST_BALANCE_CONTC';
   if v_count > 0 then
      v_sql:='drop index IDX_ST_LIST_BALANCE_CONTC';
      execute immediate v_sql;
   end if;
   select count(*)into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_CONTC' and index_name = 'IDX_BALANCE_END';
   if v_count > 0 then
      v_sql := 'drop index IDX_BALANCE_END';
      execute immediate v_sql;
   end if;
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_LINE'  and index_name = 'IDX_ST_LIST_BALANCE_LINE';
   if v_count > 0 then
      v_sql:='drop index IDX_ST_LIST_BALANCE_LINE';
      execute immediate v_sql;
   end if;
   select count(*)into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_LINE' and index_name = 'IDX_BALANCE_END_LINE';
   if v_count > 0 then
      v_sql := 'drop index IDX_BALANCE_END_LINE';
      execute immediate v_sql;
   end if;
   ----------------------------’˚¿Ì«Â∑÷πÊ‘Ú°¢’æµ„–≈œ¢µƒ∞Ê±æ
   delete from op_prm_para_ver_now;
   --»°µ±«∞°¢¿˙ ∑«Â∑÷πÊ‘Ú≤Œ ˝
   v_msg := '≤Â»Îop_prm_para_ver_now≤Œ ˝9003';
   insert into op_prm_para_ver_now
   select acc_st.seq_op_prm_para_ver_now.nextval,t.*
   from (
      select version_no,to_char(begin_time, 'yyyymmdd') as begin_time,
         to_char(end_time, 'yyyymmdd') as end_time,record_flag,parm_type_id
      from op_prm_para_ver  where parm_type_id ='9003'
      and record_flag in ('0', '2')  order by begin_time) t ;
   v_msg := '≤Â»Îop_prm_para_ver_now≤Œ ˝9004';
   insert into op_prm_para_ver_now
   select acc_st.seq_op_prm_para_ver_now.nextval,t.*
   from (
      select version_no,to_char(begin_time, 'yyyymmdd') as begin_time,
         to_char(end_time, 'yyyymmdd') as end_time,record_flag,parm_type_id
      from op_prm_para_ver  where parm_type_id ='9004'
      and record_flag in ('0', '2')  order by begin_time) t ;
   select max(list_no) into v_max_9003 from op_prm_para_ver_now where parm_type_id = '9003';
   select max(list_no) into v_max_9004 from op_prm_para_ver_now where parm_type_id = '9004';

   v_msg := '∏¸–¬op_prm_para_ver_now≤Œ ˝9003';
   update op_prm_para_ver_now a set a.end_time =
   (select to_char(to_date(b.begin_time,'yyyymmdd') - 1, 'yyyymmdd')
   from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9003')
   where a.list_no <> v_max_9003 and a.parm_type_id ='9003'
   and exists (select 1 from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9003');

   v_msg := '∏¸–¬op_prm_para_ver_now≤Œ ˝9004';
   update op_prm_para_ver_now a set a.end_time =
   (select to_char(to_date(b.begin_time,'yyyymmdd') - 1, 'yyyymmdd')
   from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9004')
   where a.list_no <> v_max_9004 and a.parm_type_id ='9004'
   and exists (select 1 from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9004');

   ---«ÂÀ„ ¬ŒÒø™ º£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   delete from st_list_balance_trx;
   -----£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠«Æ∞¸Ωª“◊∑÷’ £≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   v_msg := '≤Â»Îst_list_balance_trx«Æ∞¸Ωª“◊';
   insert into st_list_balance_trx
    select entry_line_id,entry_station_id,line_id,station_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad
      then to_char(deal_datetime, 'yyyymmdd')
      else to_char(deal_datetime - 1, 'yyyymmdd') end ,
      balance_water_no,card_main_id,card_sub_id,'54',pay_mode_id,count(*),sum(nvl(deal_fee, 0)),'',''
      from  st_que_deal
      where balance_water_no=in_balance_water_no and  
            (pay_mode_id in (select  pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
             or pay_mode_id in ('1A','4A')) --∑«œ÷Ω∏¸–¬¥”deal»° 2014-6-22 ver1.02
    group by  entry_line_id, entry_station_id, line_id, station_id,
    case when to_char(deal_datetime, 'hh24mi') >= v_squad
      then to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd') end,
      balance_water_no, card_main_id, card_sub_id, pay_mode_id;
      
   v_msg := '≤Â»Îst_list_balance_trx∑«œ÷Ω∏¸–¬¡„÷µ'; --∑«∏¸–¬º”…œupdate±Ì∑£ΩŒ™0µƒ 2014-7-16 ver1.03
   insert into st_list_balance_trx
   select entry_line_id,entry_station_id,line_id,station_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
      balance_water_no,card_main_id,card_sub_id,'54','1A',count(*),sum(nvl(penalty_fee,0)),'',''
   from st_que_update 
   where balance_water_no=in_balance_water_no and pay_type='02' and penalty_fee=0
   group by entry_line_id, entry_station_id, line_id, station_id,
   case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
     balance_water_no, card_main_id, card_sub_id,update_reason_id;
     
   ---------------------------(œ÷Ω)∏¸–¬Ωª“◊ª„◊‹
   v_msg := '≤Â»Îst_list_balance_trx∏¸–¬Ωª“◊£®œ÷Ω£©'; --œ÷Ω∏¸–¬¥”update»° 2014-6-22 ver1.02
   insert into st_list_balance_trx
   select entry_line_id,entry_station_id,line_id,station_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
      balance_water_no,card_main_id,card_sub_id,'56',update_reason_id,count(*),sum(nvl(penalty_fee,0)),'',''
   from st_que_update 
   where balance_water_no=in_balance_water_no and pay_type='01'
   group by entry_line_id, entry_station_id, line_id, station_id,
   case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
     balance_water_no, card_main_id, card_sub_id,update_reason_id;


   v_msg := '∏¸–¬st_list_balance_trx∞Ê±æ9003';
   update st_list_balance_trx a set a.version_no_9003 = (
   select b.version_no  from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9003')
   where exists (select 1 from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9003'£©;

   v_msg := '∏¸–¬st_list_balance_trx∞Ê±æ9004';
   update st_list_balance_trx a set a.version_no_9004 = (
   select b.version_no  from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9004')
   where exists (select 1 from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9004');
   commit;
   out_msg := 'success';
   out_retresult := 0;
   exception
   when others
   then
      begin
         rollback;
         out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
         out_retresult := sqlcode;
         return;
      end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_DATA_QUEUE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA_QUEUE1
prompt ===============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_data_queue1(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
 as
---------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_st_ist_settle_contc_queue1
   --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì--Ωª“◊ª„◊‹
   -- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
   --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
   --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
   --–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
           --ver1.02  –ﬁ∏ƒ»°∏¸–¬∑Ω Ω£∫£®∑«œ÷Ω£©∏¸–¬¥”deal»°£¨œ÷Ω∏¸–¬¥”update»° 2014-6-22
           --ver1.03  ∑«œ÷Ω∏¸–¬º”…œupdate±Ì∑£ΩŒ™0µƒ 2014-7-16
           --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
  ---------------------------------------------------------------------------
   v_msg varchar(50);
   v_count int;
   v_count1 int;
   v_count2 int;
   v_count3 int;
   v_sql varchar(200);
   v_max_9003 numeric(8, 0); --◊Ó¥Û«Â∑÷∞Ê±æ(œﬂ¬∑)
   v_max_9004 numeric(8, 0); --◊Ó¥Û«Â∑÷∞Ê±æ(‘À”™…Ã)
   v_squad varchar(4);
begin
   -----------»°µ√‘À”™ ±º‰
   select cfg_value into v_squad  from st_cfg_sys_base
    where cfg_key='sys.squadday'  and record_flag='0';
   
   --------------------------ºÏ≤ÈΩª“◊∑÷≈‰±»¿˝µƒ∞Ê±æ
   select count(*) into v_count  from op_prm_deal_assign_contc where record_flag= '0';
   select count(*) into v_count1 from op_prm_deal_assign_line where record_flag= '0';
   select count(*) into v_count2 from op_prm_para_ver where parm_type_id ='9003' and record_flag = '0' ;
   select count(*) into v_count3 from op_prm_para_ver where parm_type_id ='9004' and record_flag = '0';
   if (v_count <= 0 or v_count1 <= 0 or v_count2 <= 0 or v_count3 <= 0) then
      out_msg := '≤Œ ˝∞Ê±æº«¬º±Ì÷–√ª”–œﬂ¬∑«Â∑÷πÊ‘Úµ±«∞∞Ê±æ£¨Œﬁ∑®«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   
   --œ»…æ≥˝÷–º‰ª„◊‹±Ìst_list_balance_contc(line)µƒÀ˜“˝£¨∑Ω±„œ¬√Êµƒ ˝æ›≤Â»Î
   --µ˜ ‘≥ˆ¥Ì£¨¥˝Ω‚æˆ
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_CONTC' and index_name = 'IDX_ST_LIST_BALANCE_CONTC';
   if v_count > 0 then
      v_sql:='drop index IDX_ST_LIST_BALANCE_CONTC';
      execute immediate v_sql;
   end if;
   select count(*)into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_CONTC' and index_name = 'IDX_BALANCE_END';
   if v_count > 0 then
      v_sql := 'drop index IDX_BALANCE_END';
      execute immediate v_sql;
   end if;
   select count(*) into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_LINE'  and index_name = 'IDX_ST_LIST_BALANCE_LINE';
   if v_count > 0 then
      v_sql:='drop index IDX_ST_LIST_BALANCE_LINE';
      execute immediate v_sql;
   end if;
   select count(*)into v_count from user_indexes
   where table_name = 'ST_LIST_BALANCE_LINE' and index_name = 'IDX_BALANCE_END_LINE';
   if v_count > 0 then
      v_sql := 'drop index IDX_BALANCE_END_LINE';
      execute immediate v_sql;
   end if;
   ----------------------------’˚¿Ì«Â∑÷πÊ‘Ú°¢’æµ„–≈œ¢µƒ∞Ê±æ
   delete from op_prm_para_ver_now;
   --»°µ±«∞°¢¿˙ ∑«Â∑÷πÊ‘Ú≤Œ ˝
   v_msg := '≤Â»Îop_prm_para_ver_now≤Œ ˝9003';
   insert into op_prm_para_ver_now
   select acc_st.seq_op_prm_para_ver_now.nextval,t.*
   from (
      select version_no,to_char(begin_time, 'yyyymmdd') as begin_time,
         to_char(end_time, 'yyyymmdd') as end_time,record_flag,parm_type_id
      from op_prm_para_ver  where parm_type_id ='9003'
      and record_flag in ('0', '2')  order by begin_time) t ;
   v_msg := '≤Â»Îop_prm_para_ver_now≤Œ ˝9004';
   insert into op_prm_para_ver_now
   select acc_st.seq_op_prm_para_ver_now.nextval,t.*
   from (
      select version_no,to_char(begin_time, 'yyyymmdd') as begin_time,
         to_char(end_time, 'yyyymmdd') as end_time,record_flag,parm_type_id
      from op_prm_para_ver  where parm_type_id ='9004'
      and record_flag in ('0', '2')  order by begin_time) t ;
   select max(list_no) into v_max_9003 from op_prm_para_ver_now where parm_type_id = '9003';
   select max(list_no) into v_max_9004 from op_prm_para_ver_now where parm_type_id = '9004';

   v_msg := '∏¸–¬op_prm_para_ver_now≤Œ ˝9003';
   update op_prm_para_ver_now a set a.end_time =
   (select to_char(to_date(b.begin_time,'yyyymmdd') - 1, 'yyyymmdd')
   from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9003')
   where a.list_no <> v_max_9003 and a.parm_type_id ='9003'
   and exists (select 1 from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9003');

   v_msg := '∏¸–¬op_prm_para_ver_now≤Œ ˝9004';
   update op_prm_para_ver_now a set a.end_time =
   (select to_char(to_date(b.begin_time,'yyyymmdd') - 1, 'yyyymmdd')
   from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9004')
   where a.list_no <> v_max_9004 and a.parm_type_id ='9004'
   and exists (select 1 from op_prm_para_ver_now b
   where b.list_no = a.list_no + 1 and  b.parm_type_id ='9004');

   ---«ÂÀ„ ¬ŒÒø™ º£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   delete from st_list_balance_trx;
   -----£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠«Æ∞¸Ωª“◊∑÷’ £≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
   v_msg := '≤Â»Îst_list_balance_trx«Æ∞¸Ωª“◊';
   insert into st_list_balance_trx
    select entry_line_id,entry_station_id,line_id,station_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad
      then to_char(deal_datetime, 'yyyymmdd')
      else to_char(deal_datetime - 1, 'yyyymmdd') end ,
      balance_water_no,card_main_id,card_sub_id,'54',pay_mode_id,count(*),sum(nvl(deal_fee, 0)),'',''
      from  acc_st_his.st_his_deal
      where balance_water_no=in_balance_water_no and  
            (pay_mode_id in (select  pay_mode_id from op_prm_paymode_type_valid where record_flag='0')
             or pay_mode_id in ('1A','4A')) --∑«œ÷Ω∏¸–¬¥”deal»° 2014-6-22
    group by  entry_line_id, entry_station_id, line_id, station_id,
    case when to_char(deal_datetime, 'hh24mi') >= v_squad
      then to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd') end,
      balance_water_no, card_main_id, card_sub_id, pay_mode_id;

  v_msg := '≤Â»Îst_list_balance_trx∑«œ÷Ω∏¸–¬¡„÷µ'; --∑«œ÷Ω∏¸–¬º”…œupdate±Ì∑£ΩŒ™0µƒ 2014-7-16 ver1.03
   insert into st_list_balance_trx
   select entry_line_id,entry_station_id,line_id,station_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
      balance_water_no,card_main_id,card_sub_id,'54','1A',count(*),sum(nvl(penalty_fee,0)),'',''
   from acc_st_his.st_his_update
   where balance_water_no=in_balance_water_no and pay_type='02' and penalty_fee=0
   group by entry_line_id, entry_station_id, line_id, station_id,
   case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
     balance_water_no, card_main_id, card_sub_id,update_reason_id;

   ---------------------------(œ÷Ω)∏¸–¬Ωª“◊ª„◊‹
   v_msg := '≤Â»Îst_list_balance_trx∏¸–¬Ωª“◊£®œ÷Ω£©'; --œ÷Ω∏¸–¬¥”update»° 2014-6-22
   insert into st_list_balance_trx
   select entry_line_id,entry_station_id,line_id,station_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
      balance_water_no,card_main_id,card_sub_id,'56',update_reason_id,count(*),sum(nvl(penalty_fee,0)),'',''
   from  acc_st_his.st_his_update 
   where balance_water_no=in_balance_water_no and pay_type='01'
   group by entry_line_id, entry_station_id, line_id, station_id,
   case when to_char(update_datetime, 'hh24mi') >= v_squad
      then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
     balance_water_no, card_main_id, card_sub_id,update_reason_id;


   v_msg := '∏¸–¬st_list_balance_trx∞Ê±æ9003';
   update st_list_balance_trx a set a.version_no_9003 = (
   select b.version_no  from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9003')
   where exists (select 1 from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9003'£©;

   v_msg := '∏¸–¬st_list_balance_trx∞Ê±æ9004';
   update st_list_balance_trx a set a.version_no_9004 = (
   select b.version_no  from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9004')
   where exists (select 1 from op_prm_para_ver_now b
   where a.squad_day <= b.end_time  and a.squad_day >= b.begin_time and b.parm_type_id='9004');
   commit;
   out_msg := 'success';
   out_retresult := 0;
   exception
   when others
   then
      begin
         rollback;
         out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
         out_retresult := sqlcode;
         return;
      end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_DATA_SECTION
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_ST_IST_SETTLE_DATA_SECTION(
  in_squad_time CHAR,
   out_retResult OUT INTEGER, --∑µªÿΩ·π˚
   out_msg OUT VARCHAR2 --∑µªÿ–≈œ¢
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_DATA_SECTION
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫‘À”™…Ã ’“Ê«¯∂ŒÕ≥º∆±®±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú
--¥¥Ω®»’∆⁄£∫20140111
--–ﬁ∏ƒ£∫
-------------------------------------------------------------------------------
AS
   v_msg VARCHAR(50);
   v_count int;
    v_squad VARCHAR(4);
BEGIN
 -----------»°µ√‘À”™ ±º‰
   select cfg_value into v_squad  from ST_CFG_SYS_BASE
    where cfg_key='sys.squadday'  and record_flag='0';
   SELECT COUNT(*) INTO v_count
   FROM st_sts_income_contc_section a, st_list_balance_waiting b
   WHERE a.balance_water_no = b.balance_water_no;
   IF v_count > 0
   THEN
      out_msg := 'st_sts_contc_income“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      RETURN;
   END IF;
  delete T#ST_IST_SETTLE_DATA_SECTION;
  ------------------------------------≥‰÷µ
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION≥‰÷µ14';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
      CASE WHEN TO_CHAR(a.deal_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.deal_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.deal_datetime - 1, 'yyyymmdd') END,
      c.TIME_section_ID ,
      SUM(a.deal_fee)
   FROM st_que_deal a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (pay_mode_id = '14' )
   AND (TO_CHAR(a.deal_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.deal_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   GROUP BY b.contc_id, balance_water_no,
      CASE WHEN TO_CHAR(a.deal_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.deal_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.deal_datetime - 1, 'yyyymmdd') END,c.TIME_section_ID;
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION≥‰÷µ18';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
     CASE WHEN TO_CHAR(a.deal_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.deal_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.deal_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,
      SUM(a.deal_fee) * ( - 1)
   FROM st_que_deal a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (pay_mode_id = '18' )
   AND (TO_CHAR(a.deal_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.deal_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   GROUP BY b.contc_id, balance_water_no,
      CASE WHEN TO_CHAR(a.deal_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.deal_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.deal_datetime - 1, 'yyyymmdd') END, c.time_section_id;
  ----------------------------------------- —∫Ω
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION∑¢ €';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
      CASE WHEN TO_CHAR(a.sale_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.sale_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.sale_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,
      SUM(deposit_fee)
   FROM st_que_sale a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.sale_datetime, 'hh24miss') <= TO_CHAR(c.end_time, 'hh24miss')
   AND TO_CHAR(a.sale_datetime, 'hh24miss') >= TO_CHAR(c.begin_time, 'hh24miss'
   ) )
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.sale_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.sale_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.sale_datetime - 1, 'yyyymmdd') END, c.time_section_id;
   -------------------
   -----------------------------------------∏¸–¬
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION∏¸–¬';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
     CASE WHEN TO_CHAR(a.update_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.update_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.update_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,SUM(penalty_fee)
     FROM st_que_update a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.update_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.update_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.update_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.update_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.update_datetime - 1, 'yyyymmdd') END, c.time_section_id;
  -----------------------------------------––’˛¥¶¿Ì
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION––’˛¥¶¿Ì03';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
     CASE WHEN TO_CHAR(a.admin_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.admin_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.admin_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,SUM(penalty_fee)
   FROM st_que_admin a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.admin_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.admin_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   AND admin_reason_id = '03'
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.admin_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.admin_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.admin_datetime - 1, 'yyyymmdd') END, c.time_section_id;
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION––’˛¥¶¿Ì02';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
     CASE WHEN TO_CHAR(a.admin_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.admin_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.admin_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,SUM(penalty_fee)
   FROM st_que_admin a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.admin_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.admin_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   AND admin_reason_id = '02'
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.admin_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.admin_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.admin_datetime - 1, 'yyyymmdd') END, c.time_section_id;
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTION––’˛¥¶¿Ì01';
  INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
     CASE WHEN TO_CHAR(a.admin_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.admin_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.admin_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,SUM(return_fee)*-1
   FROM st_que_admin a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.admin_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.admin_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   AND admin_reason_id = '01'
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.admin_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.admin_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.admin_datetime - 1, 'yyyymmdd') END, c.time_section_id;
   -----------------------------------------ÕÀøÓ
   v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTIONÕÀ—∫Ω';
   INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
      CASE WHEN TO_CHAR(a.return_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.return_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.return_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,SUM(return_deposit_fee)*-1
   FROM st_que_return a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.return_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.return_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   AND card_main_id = '02'
   GROUP BY b.contc_id, balance_water_no,
      CASE WHEN TO_CHAR(a.return_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.return_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.return_datetime - 1, 'yyyymmdd') END, c.time_section_id;
    v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTIONÕÀ”‡∂Ó';
    INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
    SELECT b.contc_id,
      balance_water_no,
     CASE WHEN TO_CHAR(a.return_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.return_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.return_datetime - 1, 'yyyymmdd') END,c.time_section_id,
      SUM(return_balance_fee)*-1
   FROM st_que_return a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.return_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.return_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   AND card_main_id = '02'
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.return_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.return_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.return_datetime - 1, 'yyyymmdd') END, c.time_section_id;
    v_msg:='≤Â»Î±ÌT#ST_IST_SETTLE_DATA_SECTIONÕÀ∆‰À˚Ω∂Ó';
    INSERT INTO T#ST_IST_SETTLE_DATA_SECTION
   SELECT b.contc_id,
      balance_water_no,
      CASE WHEN TO_CHAR(a.return_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.return_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.return_datetime - 1, 'yyyymmdd') END,
      c.time_section_id,sUM(return_deposit_fee)*-1
   FROM st_que_return a, op_prm_station b, op_cod_time_section c
   WHERE (a.station_id = b.station_id
   AND b.record_flag = '0'
   AND a.line_id = b.line_id)
   AND (TO_CHAR(a.return_datetime, 'hh24miss') <= TO_CHAR(c.end_time,
   'hh24miss')
   AND TO_CHAR(a.return_datetime, 'hh24miss') >= TO_CHAR(c.begin_time,
   'hh24miss') )
   AND card_main_id = '01'
   GROUP BY b.contc_id, balance_water_no,
     CASE WHEN TO_CHAR(a.return_datetime, 'hh24mi') >= in_squad_time
      THEN TO_CHAR(a.return_datetime, 'yyyymmdd')
      ELSE TO_CHAR(a.return_datetime - 1, 'yyyymmdd') END, c.time_section_id;
   v_msg:='≤Â»Î±Ìst_sts_income_contc_section';
   INSERT INTO st_sts_income_contc_section(
      water_no,
      contc_id,
      squad_day,
      balance_water_no,
      time_section_id,
      deal_fee
   )
   SELECT SEQ_ST_STS_INCOM_CONTC_SECTION.nextval,contc_id,
    squad_day,balance_water_no,time_section_id,deal_fee from
   (select contc_id,squad_day,balance_water_no,time_section_id,SUM(deal_fee)
   deal_fee  FROM T#ST_IST_SETTLE_DATA_SECTION
   GROUP BY contc_id, squad_day, balance_water_no, time_section_id);
   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when OTHERS THEN
     begin
       ROLLBACK;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
END;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_DATA_SECTION to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_FLUX
prompt ========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_flux(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_FLUX
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫øÕ¡˜°¢od∑÷Œˆ
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20130814
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014ƒÍ6‘¬9»’
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
        --ver1.32 –ﬁ∏ƒ∂œ√ÊøÕ¡˜Õ≥º∆Œ Ã‚
        --ver1.36 ÃÌº”ŒÂ“ªπ„≥°Ω¯≥ˆ’æ ˝æ›¥¶¿Ì 20160712 lindaquan ŒÂ“ªπ„≥°÷ª”–2∫≈œﬂ…Ë±∏£¨≥ˆ»Î’æ∏˘æ›œﬂ¬∑æˆ∂®
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_squad varchar(4);
   v_station_wy char(2) := '07';--ŒÂ“ªπ„≥°2∫≈œﬂ’æµ„¥˙¬Î ver1.36
   v_line_wy char(2) := '02';
begin
   -----------»°µ√‘À”™ ±º‰
   select cfg_value into v_squad  from st_cfg_sys_base where cfg_key='sys.squadday' and record_flag='0';
   select count(*) into v_count from st_sts_flw_station where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_flw_station“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count  from st_sts_flw_line_card  where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_flw_line_card“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from st_sts_od_card where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_od_card“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_od_line where balance_water_no = in_balance_water_no;
   if v_count > 0  then
      out_msg := 'st_sts_od_line“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_od_card_zone  where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_od_card_zone“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_flw_average_distance where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_flw_average_distance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_change_income where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_change_income“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_custom_distance  where balance_water_no = in_balance_water_no;
   if v_count > 0  then
      out_msg := 'st_sts_custom_distance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_flw_change  where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_flw_change“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_flw_line_pass  where balance_water_no = in_balance_water_no;
   if v_count > 0 then
      out_msg := 'st_sts_flw_line_pass“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   ------------------------…æ≥˝st_sts_change
   delete from st_sts_change;
   -----------------------------
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_station';
   insert into t#st_ist_settle_flux_station( line_id,station_id,belong_line_id   )
   select line_id,station_id,belong_line_id
   from op_prm_station where record_flag = '0';
   -----------------------ª„◊‹øÕ¡˜ ˝æ›
   v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_FLUX_DEAL';
   insert into acc_st.t#st_ist_settle_flux_deal
     (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id, card_main_id,
     card_sub_id, squad_day, person_num, time_section_id, deal_fee)
   select balance_water_no,entry_line_id,entry_station_id,line_id,station_id,card_main_id,
      card_sub_id,case when to_char(a.deal_datetime, 'hh24mi') >= v_squad
      then to_char(a.deal_datetime, 'yyyymmdd')else to_char(a.deal_datetime - 1, 'yyyymmdd') end,
      count(*),b.time_section_id,sum(nvl(deal_fee, 0))
   from acc_st.st_que_deal a, acc_st.op_cod_time_section b
   where a.balance_water_no = in_balance_water_no
   and pay_mode_id in (select pay_mode_id from acc_st.op_prm_paymode_type_valid where record_flag = '0')
   and (to_char(a.deal_datetime, 'hh24miss') <= to_char(b.end_time, 'hh24miss')
   and to_char(a.deal_datetime, 'hh24miss') >= to_char(b.begin_time, 'hh24miss'))
   group by balance_water_no, entry_line_id, entry_station_id, line_id,station_id,card_main_id,card_sub_id,
      case when to_char(a.deal_datetime, 'hh24mi') >= v_squad then to_char(a.deal_datetime, 'yyyymmdd')
      else to_char(a.deal_datetime - 1, 'yyyymmdd') end,b.time_section_id;
   -------------------------ver1.36 ŒÂ“ªπ„≥°÷ª”–2∫≈œﬂ…Ë±∏£¨≥ˆ»Î’æ∏˘æ›œﬂ¬∑æˆ∂®-------------
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_person';
   --Ω¯’æ «ŒÂ“ªπ„≥°&ªª≥Àµƒ
   insert into acc_st.t#st_ist_settle_flux_person
     (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id,
       card_main_id, card_sub_id, squad_day, person_num, time_section_id, deal_fee)
   select a.balance_water_no, b.transfer_line_id,b.transfer_station_id,
         a.e_line_id, a.e_station_id,a.card_main_id, a.card_sub_id, a.squad_day, a.person_num, a.time_section_id, a.deal_fee
    from acc_st.t#st_ist_settle_flux_deal a,acc_st.op_prm_transfer_station b
    where a.b_line_id=b.line_id(+) and a.b_station_id=b.station_id(+)
    and a.b_line_id<>a.e_line_id --ªª≥Àµƒ
    and a.b_line_id=v_line_wy and a.b_station_id=v_station_wy and b.record_flag='0';--Ω¯’æ «ŒÂ“ªπ„≥°
   --≥ˆ’æ «ŒÂ“ªπ„≥°&ªª≥Àµƒ
   insert into acc_st.t#st_ist_settle_flux_person
     (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id,
       card_main_id, card_sub_id, squad_day, person_num, time_section_id, deal_fee)
   select a.balance_water_no, a.b_line_id, a.b_station_id,
          b.transfer_line_id, b.transfer_station_id,
         a.card_main_id, a.card_sub_id, a.squad_day, a.person_num, a.time_section_id, a.deal_fee
    from acc_st.t#st_ist_settle_flux_deal a,acc_st.op_prm_transfer_station b
    where a.e_line_id=b.line_id(+) and a.e_station_id=b.station_id(+)
    and a.b_line_id<>a.e_line_id --ªª≥Àµƒ
    and a.e_line_id=v_line_wy and a.e_station_id=v_station_wy and b.record_flag='0';--≥ˆ’æ «ŒÂ“ªπ„≥°
   --ªª≥Àµƒ&≤ª «ŒÂ“ªπ„≥°µƒ
   insert into acc_st.t#st_ist_settle_flux_person
     (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id,
       card_main_id, card_sub_id, squad_day, person_num, time_section_id, deal_fee)
   select a.balance_water_no, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id,
          a.card_main_id, a.card_sub_id, a.squad_day, a.person_num, a.time_section_id, a.deal_fee
    from acc_st.t#st_ist_settle_flux_deal a
    where a.b_line_id<>a.e_line_id --ªª≥Àµƒ
    and a.e_line_id||a.e_station_id<>v_line_wy||v_station_wy
    and a.b_line_id||a.b_station_id<>v_line_wy||v_station_wy;
   --≤ªªª≥Àµƒ
   insert into acc_st.t#st_ist_settle_flux_person
     (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id,
       card_main_id, card_sub_id, squad_day, person_num, time_section_id, deal_fee)
   select a.balance_water_no, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id,
          a.card_main_id, a.card_sub_id, a.squad_day, a.person_num, a.time_section_id, a.deal_fee
    from acc_st.t#st_ist_settle_flux_deal a
    where a.b_line_id=a.e_line_id;
   -------------------------
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_out';
   insert into acc_st.t#st_ist_settle_flux_out
     (balance_water_no, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, time_section_id, person_num)
   select balance_water_no, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, time_section_id, sum(person_num)
   from acc_st.t#st_ist_settle_flux_person
   group by balance_water_no, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, time_section_id;
   ------ver1.36-----------------
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_in';
   insert into acc_st.t#st_ist_settle_flux_in
     (balance_water_no, b_line_id, b_station_id, card_main_id, card_sub_id, squad_day, time_section_id, person_num)
   select balance_water_no,line_id,station_id,card_main_id,card_sub_id,
      case when to_char(a.entry_datetime, 'hh24mi') >= v_squad then to_char(a.entry_datetime, 'yyyymmdd')
      else to_char(a.entry_datetime - 1, 'yyyymmdd') end,b.time_section_id,count(*)
   from acc_st.st_que_entry a, acc_st.op_cod_time_section b
   where a.balance_water_no = in_balance_water_no
   and to_char(a.entry_datetime, 'hh24miss') <= to_char(b.end_time,
   'hh24miss')and to_char(a.entry_datetime, 'hh24miss') >= to_char(b.begin_time,'hh24miss')
   and a.line_id||a.station_id<> v_line_wy||v_station_wy--≈≈≥˝ŒÂ“ªπ„≥°ver1.36
   group by balance_water_no, line_id, station_id, card_main_id, card_sub_id,
   case when to_char(a.entry_datetime, 'hh24mi') >= v_squad then to_char(a.entry_datetime, 'yyyymmdd')
   else to_char(a.entry_datetime - 1, 'yyyymmdd') end,b.time_section_id;
   ------¥¶¿ÌŒÂ“ªπ„≥°Ω¯’æ ˝æ›ver1.36-----
   --1.…∏—°deal±ÌΩ¯’æ «ŒÂ“ªπ„≥° ˝æ›
   insert into acc_st.t#st_ist_settle_flux_qdeal
     (water_no, line_id, station_id, card_main_id, card_sub_id, card_logical_id, sam_logical_id, sam_trade_seq, deal_datetime, deal_fee, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, balance_water_no, card_app_flag)
   select water_no, line_id, station_id, card_main_id, card_sub_id, card_logical_id, sam_logical_id, sam_trade_seq, deal_datetime, deal_fee, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, balance_water_no, card_app_flag
   from acc_st.st_que_deal
   where balance_water_no=in_balance_water_no and entry_line_id=v_line_wy and entry_station_id=v_station_wy
   and pay_mode_id in (select pay_mode_id from acc_st.op_prm_paymode_type_valid where record_flag = '0');
   --2.…∏—°entry±ÌŒÂ“ªπ„≥° ˝æ›
   insert into acc_st.t#st_ist_settle_flux_qentry
     (water_no, line_id, station_id, sam_logical_id, sam_trade_seq, card_main_id, card_sub_id, card_logical_id, entry_datetime, balance_fee, pay_mode_id, balance_water_no, card_app_flag)
   select water_no, line_id, station_id, sam_logical_id, sam_trade_seq, card_main_id, card_sub_id, card_logical_id, entry_datetime, balance_fee, pay_mode_id, balance_water_no, card_app_flag
   from acc_st.st_que_entry
   where balance_water_no=in_balance_water_no and line_id=v_line_wy and station_id=v_station_wy;
   --3.¥”deal±ÌÕÍ…∆entry±Ì≥ˆ’æ ˝æ›≤ø∑÷
   insert into t#st_ist_settle_flux_entry
          (balance_water_no,b_line_id,b_station_id,e_line_id,e_station_id,card_main_id,card_sub_id,
          squad_day,time_section_id,person_num)
   select a.balance_water_no,a.line_id,a.station_id,nvl(b.line_id,a.line_id),nvl(b.station_id,a.station_id),a.card_main_id,a.card_sub_id,
      case when to_char(a.entry_datetime, 'hh24mi') >= v_squad then to_char(a.entry_datetime, 'yyyymmdd')
      else to_char(a.entry_datetime - 1, 'yyyymmdd') end,c.time_section_id,count(*)
   from acc_st.t#st_ist_settle_flux_qentry a, acc_st.t#st_ist_settle_flux_qdeal b, acc_st.op_cod_time_section c
   where to_char(a.entry_datetime, 'hh24miss') <= to_char(c.end_time,'hh24miss')
     and to_char(a.entry_datetime, 'hh24miss') >= to_char(c.begin_time,'hh24miss')
     and a.card_logical_id=b.card_logical_id(+) and a.entry_datetime=b.entry_datetime(+)
     and a.line_id=b.entry_line_id(+) and a.station_id=b.entry_station_id(+)
     and a.card_app_flag=b.card_app_flag(+)
   group by a.balance_water_no, a.line_id, a.station_id, b.line_id,b.station_id, a.card_main_id, a.card_sub_id,
   case when to_char(a.entry_datetime, 'hh24mi') >= v_squad then to_char(a.entry_datetime, 'yyyymmdd')
   else to_char(a.entry_datetime - 1, 'yyyymmdd') end,c.time_section_id;
   --4.«¯∑÷entry±ÌÀ˘ Ùœﬂ¬∑ ˝æ›
   -----------------------------
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_in';
   --Ω¯’æªª≥Àµƒ
   insert into t#st_ist_settle_flux_in
     (balance_water_no, b_line_id, b_station_id, card_main_id, card_sub_id, squad_day, time_section_id, person_num)
   select a.balance_water_no, b.transfer_line_id, b.transfer_station_id,
         a.card_main_id, a.card_sub_id, a.squad_day, a.time_section_id, a.person_num
    from acc_st.t#st_ist_settle_flux_entry a,acc_st.op_prm_transfer_station b
    where a.b_line_id=b.line_id(+) and a.b_station_id=b.station_id(+)
    and a.b_line_id<>a.e_line_id and b.record_flag='0';
   --≤ªªª≥Àµƒ
   insert into t#st_ist_settle_flux_in
     (balance_water_no, b_line_id, b_station_id, card_main_id, card_sub_id, squad_day, time_section_id, person_num)
   select a.balance_water_no, a.b_line_id, a.b_station_id, a.card_main_id, a.card_sub_id,
          a.squad_day, a.time_section_id, a.person_num
    from acc_st.t#st_ist_settle_flux_entry a
    where a.b_line_id=a.e_line_id;

   --ªÒ»°Ωª“◊ ˝æ›µƒªª≥À–≈œ¢
   v_msg := '≤Â»Î±Ìst_sts_change';
   insert into st_sts_change(balance_water_no,b_line_id,b_station_id, e_line_id,
      e_station_id,change_line,change_station,change_line_out,change_line_in,card_main_id,
      card_sub_id,squad_day,time_section_id,deal_fee,change_line_out_dir,change_line_in_dir )
   select a.balance_water_no,a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,b.change_line,
      b.change_station,b.change_line_out,b.change_line_in,a.card_main_id,a.card_sub_id,
      a.squad_day,a.time_section_id,sum(a.deal_fee),b.change_line_out_dir,b.change_line_in_dir
   from t#st_ist_settle_flux_person a, op_prm_change_detail b
   where a.b_line_id = b.b_line_id and a.b_station_id = b.b_station_id and a.e_line_id = b.e_line_id
   and a.e_station_id = b.e_station_id and b.record_flag = '0'
   group by a.balance_water_no, a.b_line_id, a.b_station_id, a.e_line_id, a.e_station_id,b.change_line, b.change_station, b.change_line_out, b.change_line_in, a.card_main_id,a.card_sub_id, a.squad_day, a.time_section_id, b.change_line_out_dir, b.change_line_in_dir;
   --◊È∫œ‘À”™…Ãœﬂ¬∑±Ì
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_l_contc';
   insert into t#st_ist_settle_flux_l_contc
   select line_id,contc_id from op_prm_station where record_flag = '0'
   group by line_id, contc_id;
   --◊º±∏œﬂ¬∑∑÷’À±»¿˝±Ì  ≤¢«“Ω´‘À”™…Ã∫œ≤¢Œ™œﬂ¬∑
    v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_assign';
   insert into t#st_ist_settle_flux_assign
   select a.version_no,a.b_line_id,a.b_station_id,b.line_id,e_line_id,e_station_id,sum(in_percent)
   from op_prm_deal_assign_contc a, t#st_ist_settle_flux_l_contc b
   where a.contc_id = b.contc_id and a.record_flag = '0'
   group by a.version_no, a.b_line_id, a.b_station_id, b.line_id, e_line_id,e_station_id;
    v_msg := '≤Â»Î±Ìst_sts_change_income';
   insert into st_sts_change_income(balance_water_no,b_line_id,b_station_id,e_line_id,e_station_id,
      change_line,change_station,change_line_out,change_line_in,card_main_id,
      card_sub_id,squad_day,time_section_id,deal_fee,change_line_out_dir,change_line_in_dir)
   select /*+ index (a sts_change_idx) */
      a.balance_water_no,a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id,a.change_line,a.change_station,a.change_line_out,a.change_line_in,
      a.card_main_id,a.card_sub_id,a.squad_day,a.time_section_id,
      round(sum(nvl((a.deal_fee * b.in_percent), 0)), 2),a.change_line_out_dir,a.change_line_in_dir
   from st_sts_change a, t#st_ist_settle_flux_assign b
   where a.b_line_id = b.b_line_id and a.b_station_id = b.b_station_id
   and a.e_line_id = b.e_line_id and a.e_station_id = b.e_station_id  and a.change_line_in = b.line_id
   group by a.balance_water_no,a.b_line_id,a.b_station_id,a.e_line_id,a.e_station_id, a.change_line, a.change_station, a.change_line_out, a.change_line_in, a.card_main_id, a.card_sub_id, a.squad_day, a.time_section_id, a.change_line_out_dir, a.change_line_in_dir;
   ---------------------∑÷»Î∫Õ≥ˆÕ≥º∆
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_resultΩ¯’æ';
   insert into t#st_ist_settle_flux_result
   select balance_water_no,b_line_id,b_station_id,card_main_id,card_sub_id,squad_day,
      time_section_id,sum(person_num),0
   from t#st_ist_settle_flux_in
   group by balance_water_no, b_line_id, b_station_id, card_main_id,
   card_sub_id, squad_day, time_section_id;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_result≥ˆ’æ';
   insert  into t#st_ist_settle_flux_result
   select balance_water_no,e_line_id,e_station_id,card_main_id,
      card_sub_id,squad_day, time_section_id,0,sum(person_num)
   from t#st_ist_settle_flux_out
   group by balance_water_no,e_line_id,e_station_id,card_main_id,card_sub_id, squad_day, time_section_id;
  ------------…˙≥…≥µ’æΩ¯≥ˆ’æµ„∑÷Œˆ±®±Ì£®st_sts_flw_station)
   v_msg := '≤Â»Î±Ìst_sts_flw_station';
   insert into st_sts_flw_station
   select seq_st_sts_flw_station.nextval,balance_water_no,line_id,station_id,squad_day,card_main_id,
          card_sub_id,entry_num,export_num,time_section_id
   from (
      select balance_water_no,line_id,station_id,squad_day,card_main_id,
         card_sub_id,sum(entry_num) entry_num,sum(export_num) export_num,time_section_id
      from t#st_ist_settle_flux_result
      group by balance_water_no, line_id, station_id, card_main_id, card_sub_id, squad_day, time_section_id );
   ---------------------…˙≥…œﬂ¬∑∆±÷÷øÕ¡˜∑÷ŒˆÕ≥º∆±Ì£®st_sts_flw_line_card£©
   v_msg := '≤Â»Î±Ìst_sts_flw_line_card ';
   insert into st_sts_flw_line_card
   select seq_st_sts_flw_line_card.nextval,balance_water_no, line_id,
      card_main_id,card_sub_id,squad_day,entry_num,export_num,
      station_id --2013-11-07–ﬁ∏ƒ£¨≤¢»•µÙtime_section◊÷∂Œ
    from (
      select balance_water_no,line_id,card_main_id,card_sub_id,
         squad_day,sum(entry_num) entry_num,sum(export_num) export_num ,station_id
      from t#st_ist_settle_flux_result
      group by balance_water_no, line_id, card_main_id, card_sub_id, squad_day,station_id);
  --------------------------…˙≥…Õææ∂œﬂ¬∑∆±÷÷±®±Ìst_sts_flw_line_pass
    v_msg := '≤Â»Î±Ìst_sts_flw_line_pass';
   insert into st_sts_flw_line_pass(
      balance_water_no,b_line_id,p_line_id,num,squad_day,card_main_id,
      card_sub_id,time_section_id)
   select /*+ index ( b IDX_ST_CFG_PASS_DETAIL) */
      balance_water_no,c.belong_line_id, b.p_line_id,
      sum(person_num * b.proportion),squad_day,card_main_id,card_sub_id,a.time_section_id
   from t#st_ist_settle_flux_person a, op_prm_pass_detail b,
   t#st_ist_settle_flux_station c
   where a.b_line_id = b.b_line_id  and a.b_station_id = b.b_station_id
   and a.e_line_id = b.e_line_id   and a.e_station_id = b.e_station_id
   and a.b_line_id = c.line_id    and a.b_station_id = c.station_id    and b.record_flag='0'
   group by balance_water_no, c.belong_line_id, b.p_line_id, squad_day,
    card_main_id, card_sub_id,a.time_section_id;
   ----------------------…˙≥…∆Ωæ˘≥Àæ‡Õ≥º∆±®±Ì(st_sts_flw_average_distance)
    v_msg := '≤Â»Î±Ìst_sts_flw_average_distance';
  insert into st_sts_flw_average_distance
   select /*+ index ( b OD_DISTANCE_IDX) */
      seq_st_sts_flw_ave_distance.nextval,balance_water_no,card_main_id,
      card_sub_id,squad_day,person_num,total_distance,
      pass_line,b1,b2
    from (
      select balance_water_no,card_main_id,card_sub_id, squad_day,
         sum(nvl(person_num,0)) person_num,
         to_number(sum(nvl(b.pass_length,0)*person_num)) total_distance,
         b.pass_line,c.belong_line_id b1,d.belong_line_id b2
      from t#st_ist_settle_flux_person a, st_prm_od_distance b,
           t#st_ist_settle_flux_station c,t#st_ist_settle_flux_station d
     where (a.b_line_id=b.b_line_id
        and a.b_station_id=b.b_station_id
        and a.e_line_id=b.e_line_id
        and a.e_station_id=b.e_station_id)
        and b.record_flag='0'
        and a.b_line_id=c.line_id
        and a.b_station_id=c.station_id
        and a.e_line_id=d.line_id
        and a.e_station_id=d.station_id
      group by balance_water_no, card_main_id, card_sub_id, squad_day,b.pass_line,c.belong_line_id,d.belong_line_id);

   ------------------…˙≥…ªª≥À±®±Ìst_sts_flw_change
    v_msg := '≤Â»Î±Ìst_sts_flw_change';
    insert into st_sts_flw_change(balance_water_no,squad_day,card_main_id,card_sub_id,
        change_line,change_station,change_line_out,change_line_out_dir,change_line_in,
        change_line_in_dir,num )
   select /*+ index ( b CHANGE_DETAIL_IDX) */
      balance_water_no,squad_day, card_main_id,card_sub_id,b.change_line, b.change_station,
      b.change_line_out,b.change_line_out_dir,b.change_line_in,b.change_line_in_dir,
      sum(person_num*b.proportion)
   from t#st_ist_settle_flux_person a, op_prm_change_detail b,t#st_ist_settle_flux_station c
   where a.b_line_id = b.b_line_id and a.b_station_id = b.b_station_id
   and a.e_line_id = b.e_line_id  and a.e_station_id = b.e_station_id
   and a.b_line_id = c.line_id   and a.b_station_id = c.station_id  and b.record_flag = '0'
   group by balance_water_no,squad_day,card_main_id,card_sub_id,b.change_line,b.change_station,
   b.change_line_out,b.change_line_out_dir,b.change_line_in,b.change_line_in_dir,
      a.time_section_id,b.change_line_out_dir,b.change_line_in_dir;
   ---------------------…˙≥…odøÕ¡˜Õ≥º∆±Ì£®st_sts_od_card£©£©
   v_msg := '≤Â»Î±Ìst_sts_od_card';
   insert into st_sts_od_card
   select seq_st_sts_od_card.nextval,balance_water_no,b_line_id, b_station_id,squad_day,
          card_main_id,card_sub_id,e_line_id,e_station_id,person_num,time_section_id
   from (
      select balance_water_no,b_line_id,b_station_id,squad_day,card_main_id,card_sub_id,
      e_line_id,e_station_id,sum(person_num) person_num,time_section_id
      from t#st_ist_settle_flux_person
      group by balance_water_no, b_line_id, b_station_id, squad_day,
      card_main_id, card_sub_id, e_line_id, e_station_id, time_section_id);
   -----------------------------…˙≥…œﬂ¬∑od∑÷Œˆ±®±Ì£®st_sts_od_line£©
    v_msg := '≤Â»Î±Ìst_sts_od_line';
   insert into st_sts_od_line
   select seq_st_sts_od_line.nextval,balance_water_no,
      squad_day,belong_line_id,belong_line_id1,person_num
    from (
      select a.balance_water_no,a.squad_day,b.belong_line_id,
         c.belong_line_id belong_line_id1,sum(a.person_num) person_num
      from t#st_ist_settle_flux_person a, t#st_ist_settle_flux_station b,t#st_ist_settle_flux_station c
      where a.b_line_id = b.line_id and a.b_station_id = b.station_id
      and a.e_line_id = c.line_id   and a.e_station_id = c.station_id
      group by a.balance_water_no, a.squad_day, b.belong_line_id, c.belong_line_id);
   -------------------- …˙≥…∆±÷÷«¯∂ŒøÕ¡˜Õ≥º∆±®±Ì(st_sts_od_card_zone)
   v_msg := '≤Â»Î±Ì st_sts_od_card_zone';
   insert into st_sts_od_card_zone
   select /*+ index (b FARE_ZONE_IDX) */
      seq_st_sts_od_card_zone.nextval,balance_water_no,squad_day,card_main_id,card_sub_id,
      fare_zone,person_num,line_id
   from (
      select balance_water_no,squad_day,card_main_id,card_sub_id,
         b.fare_zone,sum(person_num) person_num,a.b_line_id line_id
      from t#st_ist_settle_flux_person a, op_prm_fare_zone b
      where ( a.b_line_id = b.b_line_id  and a.b_station_id = b.b_station_id
      and a.e_line_id = b.e_line_id  and a.e_station_id = b.e_station_id)
      and b.record_flag = '0'
      group by balance_water_no, squad_day,a.b_line_id,card_main_id, card_sub_id, b.fare_zone);

  ------…˙≥…∂œ√ÊøÕ¡˜Õ≥º∆±Ìst_sts_realflow_section(Õ¨“ªÃıœﬂœ‡¡⁄¡Ω∏ˆ’æŒ™“ª∏ˆ∂œ√Ê)
  --”–ªª≥Àœﬂ¬∑≤∑÷
  v_msg := '≤Â»Î±Ìt#st_ist_settle_flux_person1';
  insert into acc_st.t#st_ist_settle_flux_person1
    (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, person_num, time_section_id)
  select a.balance_water_no, a.b_line_id, a.b_station_id, b.line_id, b.station_id, card_main_id, card_sub_id, squad_day, person_num, time_section_id
  from acc_st.t#st_ist_settle_flux_person a,acc_st.op_prm_transfer_station b
  where a.b_line_id=b.line_id and a.e_line_id=b.transfer_line_id and a.b_line_id<>a.e_line_id and b.record_flag='0';
  insert into acc_st.t#st_ist_settle_flux_person1
    (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, person_num, time_section_id)
  select a.balance_water_no, b.transfer_line_id, b.transfer_station_id, a.e_line_id, a.e_station_id, card_main_id, card_sub_id, squad_day, person_num, time_section_id
  from acc_st.t#st_ist_settle_flux_person a,acc_st.op_prm_transfer_station b
  where a.b_line_id=b.line_id and a.e_line_id=b.transfer_line_id and a.b_line_id<>a.e_line_id and b.record_flag='0';

  insert into acc_st.t#st_ist_settle_flux_person1
    (balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, person_num, time_section_id)
  select balance_water_no, b_line_id, b_station_id, e_line_id, e_station_id, card_main_id, card_sub_id, squad_day, person_num, time_section_id
  from acc_st.t#st_ist_settle_flux_person
  where b_line_id=e_line_id;

  --“—∫œ≤¢Œ™Õ¨“ªœﬂ¬∑£∫t#st_ist_settle_flux_person1
  v_msg := '‘ˆº”…œœ¬––◊÷∂Œ ˝æ›';
  insert into acc_st.t#st_ist_flux_realflow
       (time_section, change_line_out_dir, b_station_id, e_station_id, num, line_id, balance_water_no, squad_day)
     select a.time_section_id,b.direction_flag,a.b_station_id,a.e_station_id, a.person_num,a.e_line_id,a.balance_water_no,a.squad_day
     from acc_st.t#st_ist_settle_flux_person1 a,acc_st.op_prm_realflow_detail b
     where a.b_line_id=b.b_line_id and a.e_line_id=b.e_line_id
           and a.b_station_id = b.b_station_id and a.e_station_id=b.e_station_id
           and b.record_flag='0';

  v_msg := '≤Â»Ît#st_ist_flux_realflow';
  --»•≥˝æ≠π˝øÕ¡˜change_line_out_dir, b_station_id, e_station_id≤ªÕ¨œÚµƒ ˝æ›
  insert into acc_st.t#st_ist_flux_realflow1
       (time_section, change_line_out_dir, b_station_id, e_station_id, num, line_id, balance_water_no, squad_day)
  select a.time_section, a.change_line_out_dir, a.b_station_id, b.e_station_id, a.num, a.line_id, a.balance_water_no, a.squad_day
     from acc_st.t#st_ist_flux_realflow a,acc_st.op_prm_realflow_detail b
     where a.line_id=b.b_line_id and a.line_id=b.e_line_id
           and a.e_station_id = b.b_station_id and b.direction_flag<>a.change_line_out_dir
           and b.record_flag='0';
  --»•≥˝æ≠π˝øÕ¡˜change_line_out_dir, b_station_id, e_station_id≤ªÕ¨œÚµƒ ˝æ›£¨≤Â»Ît#st_ist_flux_realflow±Ì
  insert into acc_st.t#st_ist_flux_realflow
       (time_section, change_line_out_dir, b_station_id, e_station_id, num, line_id, balance_water_no, squad_day)
  select a.time_section, a.change_line_out_dir, a.b_station_id, a.e_station_id, a.num, a.line_id, a.balance_water_no, a.squad_day
     from acc_st.t#st_ist_flux_realflow1 a,acc_st.op_prm_realflow_detail b
     where a.line_id=b.b_line_id and a.line_id=b.e_line_id
           and a.b_station_id = b.b_station_id and a.e_station_id=b.e_station_id
           and b.direction_flag=a.change_line_out_dir and b.record_flag='0';
  v_msg := '≤Â»Î±Ìst_sts_realflow_section';
  insert into acc_st.st_sts_realflow_section
  select a.time_section,a.change_line_out_dir,b.b_station_id,a.e_station_id,sum(a.num),a.line_id,a.balance_water_no,a.squad_day
  from acc_st.t#st_ist_flux_realflow a,acc_st.op_prm_realflow_detail b
       where a.line_id=b.e_line_id and a.line_id=b.b_line_id
       and a.e_station_id=b.e_station_id and a.change_line_out_dir = b.direction_flag
       and b.is_border='1' and b.record_flag='0'
  group by a.time_section,a.change_line_out_dir,b.b_station_id,a.e_station_id,a.line_id,a.balance_water_no,a.squad_day;

   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_FLUX to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_HIS
prompt =======================================
prompt
create or replace procedure acc_st.up_st_ist_settle_his(
 out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_his
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫∂”¡–±Ì ˝æ›µπ¿˙ ∑±Ì£¨≤¢…æ≥˝∂”¡–±Ì ˝æ›
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
        --ver1.02 ‘ˆº”…æ≥˝st_sts_deal_svt»˝∏ˆ‘¬«∞µƒº«¬º 2014-8-10
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
        --ver1.24 º«√˚ø®…Í«ÎΩ®¿˙ ∑±Ì±∏∑›£¨÷ÿ∏¥…Í«Î ±»° ±º‰◊Ó‘Áµƒº«¬º by lindaquan 20151221
        --ver1.26 ÃÌº”º«√˚ø®π“ ßπ¶ƒ‹,º«√˚ø®÷ÿ◊ˆ°¢≤πø®¡˜≥Ã
	--ver1.30  ÷ª˙÷ß∏∂π¶ƒ‹£¨±∏∑›∂”¡–±ÌµΩ¿˙ ∑±Ì by lindaquan 20160112
  --ver1.35 º«√˚ø®÷ÿ◊ˆ°¢≤πø®°¢…Í«Î¡˜≥Ã“∆∂ØµΩup_st_ist_settle_other
         -- ‘ˆº”TVMΩ·’À ˝æ›°¢◊‘∂ØΩ·¥Ê°¢÷Ω±“ªÿ ’œ‰°¢’“¡„œ‰¥Ê»Î°¢’“¡„œ‰»°≥ˆ µº»Î¿˙ ∑±Ì by lindaquan 20160622
  --ver1.38  ª•¡™Õ¯÷ß∏∂¿˙ ∑ ˝æ›±∏∑› modify by lindauqan 20161130
  --ver1.40  ”≈ªØ”‡∂Ó∆Ω∫‚£¨∏¸ªª”‡∂Ó∆Ω∫‚÷–º‰±Ì«Â¿Ì  modify by lindauqan 20170227
  --bata ¥Ê¥¢π˝≥Ã÷¥–– ±º‰¡Ÿ ±º«¬º±Ì
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_balance_water_no7 char(10);

   v_s_time date := sysdate;--ø™ º ±º‰
   v_e_time date := sysdate;--Ω· ¯ ±º‰
begin
  select count(*)  into v_count  from acc_st_his.st_his_deal where balance_water_no= in_balance_water_no ;
   if v_count > 0  then
      out_msg := 'acc_st_his.st_his_deal“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
  select count(*)  into v_count from acc_st_his.st_his_update where balance_water_no= in_balance_water_no ;
   if v_count > 0  then
      out_msg := 'acc_st_his.st_his_update“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
  select count(*)  into v_count from acc_st_his.st_his_sale_sjt where balance_water_no= in_balance_water_no ;
   if v_count > 0  then
      out_msg := 'acc_st_his.st_his_sale_sjt“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
  select count(*)  into v_count from acc_st_his.st_his_entry where balance_water_no= in_balance_water_no ;
   if v_count > 0  then
      out_msg := 'acc_st_his.st_his_entry“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_sale  where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_sale“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_sign_card_apply  where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_his_sign_card_apply“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_return  where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_return“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_admin where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_admin“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_lock where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_lock“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_delay where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_delay“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_non_rtn_app  where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_non_rtn_app“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_deal_oct where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_deal_oct“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_his_deal_bank  where balance_water_no= in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_his_deal_bank“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*)  into v_count from acc_st_his.st_ext_mtr_his_deal where balance_water_no= in_balance_water_no  ;
   if v_count > 0 then
      out_msg := 'acc_st_his.st_ext_mtr_his_deal“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;

   v_e_time := sysdate;
   insert into tmp_procedure_flow values ('up_st_ist_settle_his','count',v_s_time,v_e_time,in_balance_water_no);

   --«Æ∞¸Ωª“◊
   v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_deal';
insert into acc_st_his.st_his_deal  (water_no ,line_id ,station_id, dev_type_id ,
device_id ,sam_logical_id , sam_trade_seq , deal_datetime , card_main_id, card_sub_id ,
 card_logical_id ,card_physical_id , card_status_id , deal_fee , deal_balance_fee , card_charge_seq ,
 card_consume_seq , pay_mode_id , receipt_id , tac, entry_line_id , entry_station_id, entry_sam_logical_id ,
  entry_datetime, operator_id,shift_id , last_sam_logical_id , last_deal_datetime ,deal_no_discount_fee ,
  union_year_month ,union_bus_num ,union_metro_num ,union_total_num , trade_sort , card_area_code,card_area_type
   , overdraft_fee , card_cpu_flag , card_expired_flag, tct_valid_days, tct_activate_datetime,limit_mode,
   limit_entry_station, limit_exit_station , card_app_flag , balance_water_no , file_name , check_flag
   ,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode)
 select  water_no ,line_id ,station_id, dev_type_id ,
device_id ,sam_logical_id , sam_trade_seq , deal_datetime , card_main_id, card_sub_id ,
 card_logical_id ,card_physical_id , card_status_id , deal_fee , deal_balance_fee , card_charge_seq ,
 card_consume_seq , pay_mode_id , receipt_id , tac, entry_line_id , entry_station_id, entry_sam_logical_id ,
  entry_datetime, operator_id,shift_id , last_sam_logical_id , last_deal_datetime ,deal_no_discount_fee ,
  union_year_month ,union_bus_num ,union_metro_num ,union_total_num , trade_sort , card_area_code,card_area_type
   , overdraft_fee , card_cpu_flag , card_expired_flag, tct_valid_days, tct_activate_datetime,limit_mode,
   limit_entry_station, limit_exit_station , card_app_flag , balance_water_no , file_name , check_flag
   ,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode
from st_que_deal  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_deal',v_s_time,v_e_time,in_balance_water_no);
 --Ω¯’æº«¬º
v_msg := '≤Â»Î±Ìacc_st_his.st_his_entry';
 insert into acc_st_his.st_his_entry  (water_no,line_id ,station_id,dev_type_id ,device_id ,sam_logical_id,sam_trade_seq ,
 card_main_id,card_sub_id ,card_logical_id,card_physical_id,entry_datetime,card_status_id,balance_fee ,
 union_year_month,union_total_num ,union_bus_num ,union_metro_num,card_charge_seq ,card_consume_seq,
 tac,pay_mode_id ,last_sam_logical_id,last_datetime ,trade_sort,card_area_code,card_area_type,
 overdraft_limit_fee,card_physical_type,card_expired_flag,tct_valid_days,tct_activate_datetime ,
 limit_mode,limit_entry_station,limit_exit_station,balance_water_no,card_app_flag ,file_name ,
 check_flag,work_mode,card_app_mode )
 select  water_no,line_id ,station_id,dev_type_id ,device_id ,sam_logical_id,sam_trade_seq ,
 card_main_id,card_sub_id ,card_logical_id,card_physical_id,entry_datetime,card_status_id,balance_fee ,
 union_year_month,union_total_num ,union_bus_num ,union_metro_num,card_charge_seq ,card_consume_seq,
 tac,pay_mode_id ,last_sam_logical_id,last_datetime ,trade_sort,card_area_code,card_area_type,
 overdraft_limit_fee,card_physical_type,card_expired_flag,tct_valid_days,tct_activate_datetime ,
 limit_mode,limit_entry_station,limit_exit_station,balance_water_no,card_app_flag ,file_name ,
 check_flag,work_mode,card_app_mode
from st_que_entry  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_entry',v_s_time,v_e_time,in_balance_water_no);
--∏¸–¬
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_update';
 insert into acc_st_his.st_his_update  (water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,
  sam_trade_seq,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_consume_seq,card_status_id,
  update_area,update_reason_id,update_datetime,pay_type,penalty_fee,receipt_id,operator_id,entry_line_id,
  entry_station_id,shift_id,union_year_month,union_bus_num,union_metro_num,union_total_num,balance_fee,
  deal_no_discount_fee,card_charge_seq,tac,pay_mode_id,entry_sam_logical_id,entry_time,last_sam_logical_id,
  last_datetime,trade_sort,card_area_code,card_area_type,overdraft_limit_fee,card_physical_type,
  card_expired_flag,tct_valid_days,tct_activate_datetime,card_app_flag,limit_mode,limit_entry_station,
  limit_exit_station,balance_water_no,file_name,check_flag,card_app_mode )
 select  water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,
  sam_trade_seq,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_consume_seq,card_status_id,
  update_area,update_reason_id,update_datetime,pay_type,penalty_fee,receipt_id,operator_id,entry_line_id,
  entry_station_id,shift_id,union_year_month,union_bus_num,union_metro_num,union_total_num,balance_fee,
  deal_no_discount_fee,card_charge_seq,tac,pay_mode_id,entry_sam_logical_id,entry_time,last_sam_logical_id,
  last_datetime,trade_sort,card_area_code,card_area_type,overdraft_limit_fee,card_physical_type,
  card_expired_flag,tct_valid_days,tct_activate_datetime,card_app_flag,limit_mode,limit_entry_station,
  limit_exit_station,balance_water_no,file_name,check_flag,card_app_mode
from st_que_update  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_update',v_s_time,v_e_time,in_balance_water_no);
--µ•≥Ã∆± €∆±
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_sale_sjt';
 insert into acc_st_his.st_his_sale_sjt  (water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,
 sale_datetime,pay_type,card_logical_id_pay,card_trade_seq,card_logical_id,card_physical_id,sale_fee,
 card_main_id,card_sub_id,zone_id,tac,deposit_type,deposit_fee,operator_id,shift_id,balance_water_no,
 file_name,check_flag,card_status_id,auxi_fee,card_count_used,card_app_flag,tac_deal_type,tac_dev_id )
 select  water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,
 sale_datetime,pay_type,card_logical_id_pay,card_trade_seq,card_logical_id,card_physical_id,sale_fee,
 card_main_id,card_sub_id,zone_id,tac,deposit_type,deposit_fee,operator_id,shift_id,balance_water_no,
 file_name,check_flag,card_status_id,auxi_fee,card_count_used,card_app_flag,tac_deal_type,tac_dev_id
from st_que_sale_sjt  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_sale_sjt',v_s_time,v_e_time,in_balance_water_no);
 -- €∆±
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_sale';
 insert into acc_st_his.st_his_sale  (water_no,line_id,station_id ,dev_type_id ,device_id,card_main_id,card_sub_id ,
    card_logical_id,card_physical_id ,card_status_id ,water_no_business,sam_logical_id,sam_trade_seq ,
    deposit_type,deposit_fee ,sale_datetime ,receipt_id ,operator_id ,shift_id , auxi_fee,card_app_flag
    ,balance_water_no,file_name,check_flag)
 select  water_no,line_id,station_id ,dev_type_id ,device_id, card_main_id,card_sub_id,card_logical_id,
         card_physical_id ,card_status_id ,water_no_business,sam_logical_id,sam_trade_seq ,deposit_type,
         deposit_fee ,sale_datetime ,receipt_id ,operator_id ,shift_id , auxi_fee,card_app_flag ,
         balance_water_no,file_name,check_flag
from st_que_sale  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_sale',v_s_time,v_e_time,in_balance_water_no);
--ÕÀø®
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_return';
 insert into acc_st_his.st_his_return  (water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,
 card_main_id,card_sub_id,card_logical_id,card_physical_id,card_status_id,return_balance_fee,return_deposit_fee,
 penalty_fee,penalty_reason_id,card_consume_seq, return_type,return_datetime,receipt_id,apply_datetime,tac,
 operator_id,shift_id,auxi_fee,card_app_flag,balance_water_no,file_name,check_flag,tac_deal_type,tac_dev_id)
 select  water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,
 card_logical_id,card_physical_id,card_status_id,return_balance_fee,return_deposit_fee,penalty_fee,penalty_reason_id,
 card_consume_seq, return_type,return_datetime,receipt_id,apply_datetime,tac,operator_id,shift_id,auxi_fee,card_app_flag,
 balance_water_no,file_name,check_flag,tac_deal_type,tac_dev_id
from st_que_return  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_return',v_s_time,v_e_time,in_balance_water_no);
--∑«º¥ ±ÕÀøÓ…Í«Î
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_non_rtn_app';
 insert into acc_st_his.st_his_non_rtn_app(water_no,line_id,station_id,dev_type_id,device_id,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_print_id,apply_datetime,receipt_id,operator_id,apply_name,tel_no,identity_type,identity_id,is_broken,shift_id,card_app_flag,balance_water_no,file_name,check_flag
)select  water_no,line_id,station_id,dev_type_id,device_id,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_print_id,apply_datetime,receipt_id,operator_id,apply_name,tel_no,identity_type,identity_id,is_broken,shift_id,card_app_flag,balance_water_no,file_name,check_flag
from st_que_non_rtn_app  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_non_rtn_app',v_s_time,v_e_time,in_balance_water_no);

--º«√˚ø®π“ ß/Ω‚π“…Í«Î
		 v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_report_loss';
insert into acc_st_his.st_his_report_loss
      (water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, card_main_id, card_sub_id, apply_business_type, receipt_id, balance_water_no, file_name, check_flag)
select water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, card_main_id, card_sub_id, apply_business_type, receipt_id, balance_water_no, file_name, check_flag
from acc_st.st_que_report_loss where balance_water_no=in_balance_water_no;
		 v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_report_loss',v_s_time,v_e_time,in_balance_water_no);
--∆±ø®—”∆⁄
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_delay';
 insert into acc_st_his.st_his_delay (water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_status_id,old_expire_datetime,new_expire_datetime,operate_datetime,operator_id,shift_id,card_app_flag,balance_water_no,file_name,check_flag)
 select  water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_status_id,old_expire_datetime,new_expire_datetime,operate_datetime,operator_id,shift_id,card_app_flag,balance_water_no,file_name,check_flag
from st_que_delay  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_delay',v_s_time,v_e_time,in_balance_water_no);
--À¯ø®
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_lock';
 insert into acc_st_his.st_his_lock (water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_status_id,lock_flag,lock_datetime,operator_id,shift_id,card_app_flag,balance_water_no,file_name,check_flag,card_app_mode)
 select  water_no,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_status_id,lock_flag,lock_datetime,operator_id,shift_id,card_app_flag,balance_water_no,file_name,check_flag,card_app_mode
from st_que_lock  where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_lock',v_s_time,v_e_time,in_balance_water_no);
--––’˛¥¶¿Ì
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_admin';
 insert into acc_st_his.st_his_admin (water_no,line_id,station_id,dev_type_id,device_id,admin_datetime,admin_way_id,card_main_id,card_sub_id,return_fee,penalty_fee,admin_reason_id,describe,passenger_name,operator_id,shift_id,balance_water_no,file_name,check_flag)
 select  water_no,line_id,station_id,dev_type_id,device_id,admin_datetime,admin_way_id,card_main_id,card_sub_id,return_fee,penalty_fee,admin_reason_id,describe,passenger_name,operator_id,shift_id,balance_water_no,file_name,check_flag
 from st_que_admin where balance_water_no=in_balance_water_no;
      v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_admin',v_s_time,v_e_time,in_balance_water_no);

  --º«√˚ø®
  v_s_time := sysdate;
  v_msg := '≤Â»Î±Ìst_his_sign_card_apply';
  --≤Â»Î¿˙ ∑±Ì,º«√˚ø®…Í«ÎΩ®¿˙ ∑±Ì±∏∑›
  insert into acc_st_his.st_his_sign_card_apply
  (water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no, file_name, check_flag, card_main_id, card_sub_id, app_business_type, backup_date)
  select water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date, tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no, file_name, check_flag, card_main_id, card_sub_id, app_business_type, sysdate
  from acc_st.st_que_sign_card_apply;

      v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_sign_card_apply',v_s_time,v_e_time,in_balance_water_no);
 --Ω” ’µƒπ´Ωª¥¢÷µø®«Æ∞¸Ωª“◊∂”¡–±Ì 2014-4-22‘ˆº”
     v_s_time := sysdate;
insert into acc_st_his.st_ext_mtr_his_deal(water_no,line_id ,station_id ,dev_type_id,device_id ,sam_logical_id, sam_trade_seq , deal_datetime , card_main_id , card_sub_id , card_logical_id ,
  card_physical_id , card_status_id , deal_fee , deal_balance_fee , card_charge_seq ,card_consume_seq , pay_mode_id , receipt_id ,
  tac , entry_line_id , entry_station_id ,entry_sam_logical_id ,  entry_datetime , operator_id , shift_id , last_sam_logical_id ,
  last_deal_datetime , deal_no_discount_fee ,union_year_month ,union_bus_num , union_metro_num ,
  union_total_num ,trade_sort ,card_area_code ,card_area_type ,overdraft_fee ,  card_cpu_flag ,
  card_expired_flag , tct_valid_days ,tct_activate_datetime , limit_mode ,limit_entry_station ,
  limit_exit_station , card_app_flag , balance_water_no , file_name , check_flag , city_code ,
  business_code , tac_deal_type , tac_dev_id  , work_mode , card_app_mode )
select seq_st_ext_mtr_his_deal.nextval, line_id ,station_id ,dev_type_id,device_id ,sam_logical_id, sam_trade_seq , deal_datetime , card_main_id , card_sub_id , card_logical_id ,
  card_physical_id , card_status_id , deal_fee , deal_balance_fee , card_charge_seq ,card_consume_seq , pay_mode_id , receipt_id ,
  tac , entry_line_id , entry_station_id ,entry_sam_logical_id ,  entry_datetime , operator_id , shift_id , last_sam_logical_id ,
  last_deal_datetime , deal_no_discount_fee ,union_year_month ,union_bus_num , union_metro_num ,
  union_total_num ,trade_sort ,card_area_code ,card_area_type ,overdraft_fee ,  card_cpu_flag ,
  card_expired_flag , tct_valid_days ,tct_activate_datetime , limit_mode ,limit_entry_station ,
  limit_exit_station , card_app_flag , balance_water_no , file_name , check_flag , city_code ,
  business_code , tac_deal_type , tac_dev_id  , work_mode , card_app_mode
from   st_ext_mtr_que_deal where balance_water_no=in_balance_water_no;
       v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_ext_mtr_his_deal',v_s_time,v_e_time,in_balance_water_no);
--π´Ωªicø®«Æ∞¸Ωª“◊∂”¡–±Ì
       v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_deal_oct';
insert into acc_st_his.st_his_deal_oct (water_no,line_id ,station_id,dev_type_id,device_id ,sam_logical_id ,sam_trade_seq ,deal_datetime,
card_main_id,card_sub_id ,card_logical_id,card_physical_id,card_status_id,deal_fee,deal_balance_fee, card_charge_seq ,card_consume_seq ,
pay_mode_id ,receipt_id,tac,entry_line_id ,entry_station_id ,entry_sam_logical_id  ,entry_datetime ,operator_id,shift_id,
last_sam_logical_id,last_deal_datetime,deal_no_discount_fee  ,union_year_month  ,union_bus_num ,union_metro_num,union_total_num ,
trade_sort,card_area_code,card_area_type,overdraft_fee,card_cpu_flag,card_expired_flag,tct_valid_days,tct_activate_datetime ,limit_mode,
limit_entry_station,limit_exit_station,card_app_flag ,balance_water_no,file_name,check_flag,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode)
select  water_no,line_id ,station_id,dev_type_id,device_id ,sam_logical_id ,sam_trade_seq ,deal_datetime,card_main_id,card_sub_id ,
        card_logical_id,card_physical_id,card_status_id,deal_fee,deal_balance_fee,card_charge_seq ,card_consume_seq ,pay_mode_id ,
        receipt_id,tac,entry_line_id ,entry_station_id ,entry_sam_logical_id ,entry_datetime ,operator_id,shift_id,
        last_sam_logical_id,last_deal_datetime,deal_no_discount_fee  ,union_year_month  ,union_bus_num ,union_metro_num,union_total_num
        ,trade_sort,card_area_code,card_area_type,overdraft_fee,card_cpu_flag,card_expired_flag,tct_valid_days,
    tct_activate_datetime ,limit_mode,limit_entry_station,limit_exit_station,card_app_flag ,balance_water_no,file_name,check_flag
    ,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode
 from st_que_deal_oct where balance_water_no=in_balance_water_no;
      v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_deal_oct',v_s_time,v_e_time,in_balance_water_no);
--π´Ωª €ø®Ωª“◊
      v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_sale_oct';
 insert into acc_st_his.st_his_sale_oct (water_no,line_id,station_id ,dev_type_id ,device_id,
    card_main_id  ,card_sub_id ,card_logical_id,card_physical_id ,
    card_status_id ,water_no_business,sam_logical_id,sam_trade_seq ,
    deposit_type,deposit_fee ,sale_datetime ,receipt_id ,operator_id ,
    shift_id , auxi_fee,card_app_flag ,balance_water_no,file_name,check_flag)
 select  water_no,line_id,station_id ,dev_type_id ,device_id,
    card_main_id  ,card_sub_id ,card_logical_id,card_physical_id ,
    card_status_id ,water_no_business,sam_logical_id,sam_trade_seq ,
    deposit_type,deposit_fee ,sale_datetime ,receipt_id ,operator_id ,
    shift_id , auxi_fee,card_app_flag ,balance_water_no,file_name,check_flag
 from st_que_sale_oct where balance_water_no=in_balance_water_no;
      v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_sale_oct',v_s_time,v_e_time,in_balance_water_no);
--“¯¡™ø®«Æ∞¸Ωª“◊∂”¡–±Ì
      v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_deal_bank';
insert into acc_st_his.st_his_deal_bank(water_no,line_id ,station_id,dev_type_id,device_id ,
sam_logical_id ,sam_trade_seq ,deal_datetime,card_main_id,card_sub_id ,card_logical_id,
card_physical_id,card_status_id,deal_fee,deal_balance_fee,card_charge_seq ,card_consume_seq ,
pay_mode_id ,receipt_id,tac,entry_line_id ,entry_station_id ,entry_sam_logical_id  ,entry_datetime ,
operator_id,shift_id,last_sam_logical_id,last_deal_datetime,deal_no_discount_fee ,union_year_month ,
union_bus_num ,union_metro_num,union_total_num ,trade_sort,card_area_code,card_area_type,overdraft_fee,
card_cpu_flag,card_expired_flag,tct_valid_days,tct_activate_datetime ,limit_mode,limit_entry_station,limit_exit_station,
card_app_flag ,balance_water_no,file_name,check_flag,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode)
 select  water_no,line_id ,station_id,dev_type_id,device_id ,sam_logical_id ,sam_trade_seq ,deal_datetime,
 card_main_id,card_sub_id ,card_logical_id,card_physical_id,card_status_id,deal_fee,deal_balance_fee,card_charge_seq ,
 card_consume_seq ,pay_mode_id ,receipt_id,tac,entry_line_id ,entry_station_id ,entry_sam_logical_id  ,entry_datetime ,operator_id,shift_id,last_sam_logical_id,last_deal_datetime,
deal_no_discount_fee  ,union_year_month  ,union_bus_num ,union_metro_num,union_total_num ,trade_sort,
card_area_code,card_area_type,overdraft_fee,card_cpu_flag,card_expired_flag,tct_valid_days,tct_activate_datetime ,
limit_mode,limit_entry_station,limit_exit_station,card_app_flag ,balance_water_no,file_name,check_flag,city_code,
business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode
 from st_que_deal_bank where balance_water_no=in_balance_water_no;
      v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_deal_bank',v_s_time,v_e_time,in_balance_water_no);
----------------- ’“Ê ˝æ›2013-11-1‘ˆº”
--bom∞‡¥Œ ˝æ›÷˜
      v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_total';
insert into acc_st_his.st_his_bom_shift_total(water_no ,line_id , station_id,dev_type_id,device_id,operator_id,shift_id ,start_time,end_time,sale_total_num ,
  sale_total_fee ,charge_total_num ,charge_total_fee ,update_total_num ,update_total_fee ,update_total_fee_cash ,admin_total_num ,
  admin_total_fee_return ,admin_total_fee_income ,delay_total_num ,return_total_num ,return_total_fee ,return_non_total_num ,
  return_non_total_fee , return_non_app_total_num ,charge_update_total_num ,charge_update_total_fee ,unlock_total_num ,
  total_fee_nocash ,total_fee_cash ,balance_water_no,file_name,check_flag )
select water_no ,line_id , station_id,dev_type_id,device_id,operator_id,shift_id ,start_time,end_time,sale_total_num ,
  sale_total_fee ,charge_total_num ,charge_total_fee ,update_total_num ,update_total_fee ,update_total_fee_cash ,admin_total_num ,
  admin_total_fee_return ,admin_total_fee_income ,delay_total_num ,return_total_num ,return_total_fee ,return_non_total_num ,
  return_non_total_fee , return_non_app_total_num ,charge_update_total_num ,charge_update_total_fee ,unlock_total_num ,
  total_fee_nocash ,total_fee_cash ,balance_water_no,file_name,check_flag
from st_que_bom_shift_total where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_total',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®∑¢ €£©
       v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_sale';
insert into acc_st_his.st_his_bom_shift_sale(water_no,card_main_id,card_sub_id,num,fee,balance_water_no,file_name,check_flag )
select water_no,card_main_id,card_sub_id,num,fee,balance_water_no,file_name,check_flag
from st_que_bom_shift_sale where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_sale',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰÷µ£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_charge';
insert into acc_st_his.st_his_bom_shift_charge(water_no,card_main_id,card_sub_id,num,fee,balance_water_no,file_name,check_flag )
select water_no,card_main_id,card_sub_id,num,fee,balance_water_no,file_name,check_flag
from st_que_bom_shift_charge where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_charge',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®∏¸–¬£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_update';
insert into acc_st_his.st_his_bom_shift_update(water_no,card_main_id,card_sub_id,update_reason,pay_type,num,fee,balance_water_no,file_name,check_flag)
select water_no,card_main_id,card_sub_id,update_reason,pay_type,num,fee,balance_water_no,file_name,check_flag
from st_que_bom_shift_update where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_update',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®––’˛¥¶¿Ì£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_admin';
insert into acc_st_his.st_his_bom_shift_admin(water_no,admin_way_id,admin_reason_id,num ,fee,balance_water_no,file_name,check_flag)
select water_no,admin_way_id,admin_reason_id,num ,fee,balance_water_no,file_name,check_flag
from st_que_bom_shift_admin where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_admin',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®—”∆⁄£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_delay';
insert into acc_st_his.st_his_bom_shift_delay(water_no,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag)
select water_no,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag
from st_que_bom_shift_delay where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_delay',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®º¥ ±ÕÀøÓ£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_return';
insert into acc_st_his.st_his_bom_shift_return(water_no,card_main_id,card_sub_id,num,return_balance_fee,return_deposit_fee,
  return_type,is_broken,penalty_fee,penalty_reason,balance_water_no,file_name,check_flag)
select water_no,card_main_id,card_sub_id,num,return_balance_fee,return_deposit_fee,
  return_type,is_broken,penalty_fee,penalty_reason,balance_water_no,file_name,check_flag
from st_que_bom_shift_return where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_return',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_rtn_non';
insert into acc_st_his.st_his_bom_shift_rtn_non(water_no,card_main_id,card_sub_id,num,return_balance_fee,return_deposit_fee,return_type,
  is_broken,penalty_fee,penalty_reason,balance_water_no,file_name,check_flag )
select water_no,card_main_id,card_sub_id,num,return_balance_fee,return_deposit_fee,return_type,
  is_broken,penalty_fee,penalty_reason,balance_water_no,file_name,check_flag
from st_que_bom_shift_rtn_non where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_rtn_non',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ…Í«Î£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_rtn_app';
insert into acc_st_his.st_his_bom_shift_rtn_app(water_no,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag)
select water_no,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag
from st_que_bom_shift_rtn_app where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_rtn_app',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰’˝£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_chg_upd';
insert into acc_st_his.st_his_bom_shift_chg_upd(water_no,card_main_id,card_sub_id,num,fee,balance_water_no,file_name,check_flag)
select water_no,card_main_id,card_sub_id,num,fee,balance_water_no,file_name,check_flag
from st_que_bom_shift_chg_upd where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_chg_upd',v_s_time,v_e_time,in_balance_water_no);
--bom∞‡¥Œ ˝æ›√˜œ∏£®Ω‚À¯£©
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_bom_shift_unlock';
insert into acc_st_his.st_his_bom_shift_unlock(water_no,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag )
select water_no,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag
from st_que_bom_shift_unlock where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_bom_shift_unlock',v_s_time,v_e_time,in_balance_water_no);
--tvm÷Ω±“œ‰ ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_note_data';
insert into acc_st_his.st_his_tvm_note_data(water_no,line_id,station_id,dev_type_id,device_id,note_box_id,operator_id,put_datetime,pop_datetime,water_no_op,
  note_fee_1,note_fee_2,note_fee_3,note_fee_4,note_fee_5,note_fee_6,note_fee_7,note_fee_8,note_fee_9,note_fee_10,note_fee_11,
  note_fee_12,note_fee_13,note_num_1,note_num_2,note_num_3,note_num_4,note_num_5,note_num_6,note_num_7,note_num_8,note_num_9,
  note_num_10,note_num_11,note_num_12,note_num_13,note_fee_total,balance_water_no,file_name,check_flag )
select water_no,line_id,station_id,dev_type_id,device_id,note_box_id,operator_id,put_datetime,pop_datetime,water_no_op,
  note_fee_1,note_fee_2,note_fee_3,note_fee_4,note_fee_5,note_fee_6,note_fee_7,note_fee_8,note_fee_9,note_fee_10,note_fee_11,
  note_fee_12,note_fee_13,note_num_1,note_num_2,note_num_3,note_num_4,note_num_5,note_num_6,note_num_7,note_num_8,note_num_9,
  note_num_10,note_num_11,note_num_12,note_num_13,note_fee_total,balance_water_no,file_name,check_flag
from st_que_tvm_note_data where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_note_data',v_s_time,v_e_time,in_balance_water_no);
--tvm”≤±“œ‰ ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_coin_data';
insert into acc_st_his.st_his_tvm_coin_data(water_no,line_id,station_id,dev_type_id,device_id,coin_box_id ,operator_id,
  put_datetime,pop_datetime,water_no_op,coin_fee_1,coin_fee_2,coin_fee_3,coin_fee_4,coin_fee_5,
  coin_fee_6,coin_fee_7,coin_fee_8,coin_num_1,coin_num_2,coin_num_3,coin_num_4,coin_num_5,coin_num_6,
  coin_num_7,coin_num_8,coin_fee_total,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,coin_box_id ,operator_id,
  put_datetime,pop_datetime,water_no_op,coin_fee_1,coin_fee_2,coin_fee_3,coin_fee_4,coin_fee_5,
  coin_fee_6,coin_fee_7,coin_fee_8,coin_num_1,coin_num_2,coin_num_3,coin_num_4,coin_num_5,coin_num_6,
  coin_num_7,coin_num_8,coin_fee_total,balance_water_no,file_name,check_flag
from st_que_tvm_coin_data where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_coin_data',v_s_time,v_e_time,in_balance_water_no);
--tvm”≤±“œ‰¥Ê»Î ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_coin_put';
insert into acc_st_his.st_his_tvm_coin_put(water_no,line_id,station_id,dev_type_id,device_id,hopper_id,operator_id,put_datetime,water_no_op,
 coin_unit_fee,coin_num ,coin_fee_total,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,hopper_id,operator_id,put_datetime,water_no_op,
 coin_unit_fee,coin_num ,coin_fee_total,balance_water_no,file_name,check_flag
from st_que_tvm_coin_put where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_coin_put',v_s_time,v_e_time,in_balance_water_no);
--tvm”≤±“œ‰«Âø’ ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_coin_clear';
insert into acc_st_his.st_his_tvm_coin_clear(water_no ,line_id,station_id,dev_type_id,device_id,coin_box_id,operator_id,clear_datetime,water_no_op,
  hopper_1_unit_fee,hopper_1_unit_num,hopper_2_unit_fee,hopper_2_unit_num,coin_fee_1,coin_fee_2,coin_fee_3,
  coin_fee_4,coin_fee_5,coin_fee_6,coin_fee_7,coin_fee_8,coin_num_1,coin_num_2,coin_num_3,coin_num_4,
  coin_num_5,coin_num_6,coin_num_7,coin_num_8,coin_fee_total,balance_water_no,file_name,check_flag)
select water_no ,line_id,station_id,dev_type_id,device_id,coin_box_id,operator_id,clear_datetime,water_no_op,
  hopper_1_unit_fee,hopper_1_unit_num,hopper_2_unit_fee,hopper_2_unit_num,coin_fee_1,coin_fee_2,coin_fee_3,
  coin_fee_4,coin_fee_5,coin_fee_6,coin_fee_7,coin_fee_8,coin_num_1,coin_num_2,coin_num_3,coin_num_4,
  coin_num_5,coin_num_6,coin_num_7,coin_num_8,coin_fee_total,balance_water_no,file_name,check_flag
from st_que_tvm_coin_clear where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_coin_clear',v_s_time,v_e_time,in_balance_water_no);
--tvm∆±œ‰¥Ê»Î ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_card_put';
insert into acc_st_his.st_his_tvm_card_put(water_no,line_id,station_id,dev_type_id,device_id,operator_id,put_datetime,water_no_op,
  box_id,hopper_id,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,operator_id,put_datetime,water_no_op,
  box_id,hopper_id,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag
from st_que_tvm_card_put where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_card_put',v_s_time,v_e_time,in_balance_water_no);
--tvm∆±œ‰«Âø’ ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_card_clear';
insert into acc_st_his.st_his_tvm_card_clear(water_no,line_id,station_id,dev_type_id,device_id ,operator_id,clear_datetime,water_no_op,card_main_id_hopper_1,card_sub_id_hopper_1,
   card_main_id_hopper_2,card_sub_id_hopper_2,hopper_1_num,hopper_2_num,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id ,operator_id,clear_datetime,water_no_op,card_main_id_hopper_1,card_sub_id_hopper_1,
   card_main_id_hopper_2,card_sub_id_hopper_2,hopper_1_num,hopper_2_num,balance_water_no,file_name,check_flag
from st_que_tvm_card_clear where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_card_clear',v_s_time,v_e_time,in_balance_water_no);
--tvm∑œ∆±œ‰ ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_waste_card_data';
insert into acc_st_his.st_his_tvm_waste_card_data(water_no,line_id,station_id,dev_type_id,device_id,operator_id,pop_datetime,water_no_op,
  sjt_num,sjt_discount_num,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,operator_id,pop_datetime,water_no_op,
  sjt_num,sjt_discount_num,balance_water_no,file_name,check_flag
from st_que_tvm_waste_card_data where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_waste_card_data',v_s_time,v_e_time,in_balance_water_no);
--‘ˆº”TVMΩ·’À ˝æ›°¢◊‘∂ØΩ·¥Ê°¢÷Ω±“ªÿ ’œ‰°¢’“¡„œ‰¥Ê»Î°¢’“¡„œ‰»°≥ˆ µº»Î¿˙ ∑±Ì by lindaquan 20160622
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_bal';
insert into acc_st_his.st_his_tvm_bal
  (water_no, line_id, station_id, dev_type_id, device_id, auto_bal_datetime_begin, auto_bal_datetime_end, sjt_sale_fee_total_1, sjt_sale_fee_total_2, charge_fee_total, note_recv_fee_total, coin_recv_fee_total, note_recv_fee_rep_total, coin_recv_fee_rep_total, coin_bal_fee_total, note_bal_fee_total, note_chg_fee_put_total_1, note_chg_fee_put_total_2, coin_chg_fee_put_total_1, coin_chg_fee_put_total_2, coin_chg_fee_total_1, coin_chg_fee_pop_total_2, note_chg_fee_total_1, note_chg_fee_total_2, coin_chg_fee_bal_total_1, coin_chg_fee_bal_total_2, note_chg_fee_bal_total_1, note_chg_fee_bal_total_2, coin_chg_fee_clear_total_1, coin_chg_fee_clear_total_2, coin_chg_fee_bal_sum_total_1, coin_chg_fee_bal_sum_total_2, note_recaim_chg_num, note_recaim_bal_num, sjt_num_put_total_1, sjt_num_put_total_2, sjt_num_sale_total_1, sjt_num_sale_total_2, sjt_num_clear_total_1, sjt_num_clear_total_2, sjt_num_bal_total_1, sjt_num_bal_total_2, sjt_num_waste_total, tvm_bal_fee_total, balance_water_no, file_name, check_flag)
select water_no, line_id, station_id, dev_type_id, device_id, auto_bal_datetime_begin, auto_bal_datetime_end, sjt_sale_fee_total_1, sjt_sale_fee_total_2, charge_fee_total, note_recv_fee_total, coin_recv_fee_total, note_recv_fee_rep_total, coin_recv_fee_rep_total, coin_bal_fee_total, note_bal_fee_total, note_chg_fee_put_total_1, note_chg_fee_put_total_2, coin_chg_fee_put_total_1, coin_chg_fee_put_total_2, coin_chg_fee_total_1, coin_chg_fee_pop_total_2, note_chg_fee_total_1, note_chg_fee_total_2, coin_chg_fee_bal_total_1, coin_chg_fee_bal_total_2, note_chg_fee_bal_total_1, note_chg_fee_bal_total_2, coin_chg_fee_clear_total_1, coin_chg_fee_clear_total_2, coin_chg_fee_bal_sum_total_1, coin_chg_fee_bal_sum_total_2, note_recaim_chg_num, note_recaim_bal_num, sjt_num_put_total_1, sjt_num_put_total_2, sjt_num_sale_total_1, sjt_num_sale_total_2, sjt_num_clear_total_1, sjt_num_clear_total_2, sjt_num_bal_total_1, sjt_num_bal_total_2, sjt_num_waste_total, tvm_bal_fee_total, balance_water_no, file_name, check_flag
from acc_st.st_que_tvm_bal where balance_water_no=in_balance_water_no;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_auto_bal';
insert into acc_st_his.st_his_tvm_auto_bal
  (water_no, line_id, station_id, dev_type_id, device_id, auto_bal_datetime_begin, auto_bal_datetime_end, sjt_sale_fee_total_1, sjt_sale_fee_total_2, charge_fee_total, note_recv_fee_total, coin_recv_fee_total, note_recv_fee_rep_total, coin_recv_fee_rep_total, coin_bal_fee_total, note_bal_fee_total, note_chg_fee_put_total_1, note_chg_fee_put_total_2, coin_chg_fee_put_total_1, coin_chg_fee_put_total_2, coin_chg_fee_total_1, coin_chg_fee_pop_total_2, note_chg_fee_total_1, note_chg_fee_total_2, coin_chg_fee_bal_total_1, coin_chg_fee_bal_total_2, note_chg_fee_bal_total_1, note_chg_fee_bal_total_2, coin_chg_fee_clear_total_1, coin_chg_fee_clear_total_2, coin_chg_fee_bal_sum_total_1, coin_chg_fee_bal_sum_total_2, note_recaim_chg_num, note_recaim_bal_num, sjt_num_put_total_1, sjt_num_put_total_2, sjt_num_sale_total_1, sjt_num_sale_total_2, sjt_num_clear_total_1, sjt_num_clear_total_2, sjt_num_bal_total_1, sjt_num_bal_total_2, sjt_num_waste_total, tvm_bal_fee_total, balance_water_no, file_name, check_flag)
select water_no, line_id, station_id, dev_type_id, device_id, auto_bal_datetime_begin, auto_bal_datetime_end, sjt_sale_fee_total_1, sjt_sale_fee_total_2, charge_fee_total, note_recv_fee_total, coin_recv_fee_total, note_recv_fee_rep_total, coin_recv_fee_rep_total, coin_bal_fee_total, note_bal_fee_total, note_chg_fee_put_total_1, note_chg_fee_put_total_2, coin_chg_fee_put_total_1, coin_chg_fee_put_total_2, coin_chg_fee_total_1, coin_chg_fee_pop_total_2, note_chg_fee_total_1, note_chg_fee_total_2, coin_chg_fee_bal_total_1, coin_chg_fee_bal_total_2, note_chg_fee_bal_total_1, note_chg_fee_bal_total_2, coin_chg_fee_clear_total_1, coin_chg_fee_clear_total_2, coin_chg_fee_bal_sum_total_1, coin_chg_fee_bal_sum_total_2, note_recaim_chg_num, note_recaim_bal_num, sjt_num_put_total_1, sjt_num_put_total_2, sjt_num_sale_total_1, sjt_num_sale_total_2, sjt_num_clear_total_1, sjt_num_clear_total_2, sjt_num_bal_total_1, sjt_num_bal_total_2, sjt_num_waste_total, tvm_bal_fee_total, balance_water_no, file_name, check_flag
from acc_st.st_que_tvm_auto_bal where balance_water_no=in_balance_water_no;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_note_chg_pop';
insert into acc_st_his.st_his_tvm_note_chg_pop
  (water_no, line_id, station_id, dev_type_id, device_id, note_box_type, note_box_id, operator_id, put_datetime, pop_datetime, water_no_op, note_fee, note_num_put, note_num_chg, note_num_bal, note_fee_total_put, note_fee_total_chg, note_fee_total_bal, balance_water_no, file_name, check_flag)
select water_no, line_id, station_id, dev_type_id, device_id, note_box_type, note_box_id, operator_id, put_datetime, pop_datetime, water_no_op, note_fee, note_num_put, note_num_chg, note_num_bal, note_fee_total_put, note_fee_total_chg, note_fee_total_bal, balance_water_no, file_name, check_flag
from acc_st.st_que_tvm_note_chg_pop where balance_water_no=in_balance_water_no;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_note_chg_put';
insert into acc_st_his.st_his_tvm_note_chg_put
  (water_no, line_id, station_id, dev_type_id, device_id, note_box_type, note_box_id, operator_id, put_datetime, water_no_op, note_fee, note_num, note_fee_total, balance_water_no, file_name, check_flag)
select water_no, line_id, station_id, dev_type_id, device_id, note_box_type, note_box_id, operator_id, put_datetime, water_no_op, note_fee, note_num, note_fee_total, balance_water_no, file_name, check_flag
from acc_st.st_que_tvm_note_chg_put where balance_water_no=in_balance_water_no;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_tvm_note_reclaim';
insert into acc_st_his.st_his_tvm_note_reclaim
  (water_no, line_id, station_id, dev_type_id, device_id, note_box_id, operator_id, pop_datetime, water_no_op, note_fee_1, note_num_reclaim_1, note_fee_2, note_num_reclaim_2, note_fee_3, note_num_reclaim_3, note_fee_4, note_num_reclaim_4, balance_water_no, file_name, check_flag)
select water_no, line_id, station_id, dev_type_id, device_id, note_box_id, operator_id, pop_datetime, water_no_op, note_fee_1, note_num_reclaim_1, note_fee_2, note_num_reclaim_2, note_fee_3, note_num_reclaim_3, note_fee_4, note_num_reclaim_4, balance_water_no, file_name, check_flag
from acc_st.st_que_tvm_note_reclaim where balance_water_no=in_balance_water_no;

--agm∆±œ‰ ˝æ›
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_agm_card_data';
insert into acc_st_his.st_his_agm_card_data(water_no ,line_id,station_id,dev_type_id,device_id,operator_id,pop_datetime,box_id,
   water_no_op,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag)
select water_no ,line_id,station_id,dev_type_id,device_id,operator_id,pop_datetime,box_id,
   water_no_op,card_main_id,card_sub_id,num,balance_water_no,file_name,check_flag
from st_que_agm_card_data where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_agm_card_data',v_s_time,v_e_time,in_balance_water_no);
-------------------…Ûº∆ ˝æ›µº¿˙ ∑±Ì  2013-11-26‘ˆº”
---AGM…Ûº∆ ˝æ›
     v_s_time := sysdate;
insert into acc_st_his.st_his_agm_cutoff_total(water_no,line_id,station_id,dev_type_id,device_id,op_date,cur_datetime,box_pop_num,
total_num,total_fee,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,op_date,cur_datetime,box_pop_num,total_num,total_fee,
balance_water_no,file_name,check_flag
from st_que_agm_cutoff_total  where balance_water_no=in_balance_water_no;
insert into acc_st_his.st_his_agm_cutoff_dtl(water_no,trade_type_id,pay_mode_id,card_main_id,card_sub_id,deal_num,
deal_fee,balance_water_no,file_name,check_flag)
select water_no,trade_type_id,pay_mode_id,card_main_id,card_sub_id,deal_num,
deal_fee,balance_water_no,file_name,check_flag
from st_que_agm_cutoff_dtl where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_agm_cutoff_total',v_s_time,v_e_time,in_balance_water_no);
--TVM…Ûº∆ ˝æ›
     v_s_time := sysdate;
insert into acc_st_his.st_his_tvm_cutoff_dtl(water_no,trade_type_id,pay_mode_id,card_main_id,card_sub_id,deal_num,deal_fee,balance_water_no,file_name,check_flag)
select water_no,trade_type_id,pay_mode_id,card_main_id,card_sub_id,deal_num,deal_fee,balance_water_no,file_name,check_flag
from st_que_tvm_cutoff_dtl  where balance_water_no=in_balance_water_no;
insert into acc_st_his.st_his_tvm_cutoff_total(water_no,line_id,station_id,dev_type_id,device_id,op_date,cur_datetime,card_put_num,card_clear_num,coin_put_num,
  coin_put_fee,coin_clear_num,coin_clear_fee,coin_reclaim_num,coin_reclaim_fee,note_reclaim_num,note_reclaim_fee,
  balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,op_date,cur_datetime,card_put_num,card_clear_num,coin_put_num,
  coin_put_fee,coin_clear_num,coin_clear_fee,coin_reclaim_num,coin_reclaim_fee,note_reclaim_num,note_reclaim_fee,
  balance_water_no,file_name,check_flag
from st_que_tvm_cutoff_total where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_tvm_cutoff_dtl',v_s_time,v_e_time,in_balance_water_no);
------------------ºƒ¥Ê∆˜ ˝æ›µπ¿˙ ∑±Ì 2013-11-28–ﬁ∏ƒ
     v_s_time := sysdate;
insert into acc_st_his.st_his_reg_total(water_no,line_id,station_id,dev_type_id,device_id,commu_datetime,gen_datetime,total_num,balance_water_no,file_name,check_flag)
select water_no,line_id,station_id,dev_type_id,device_id,commu_datetime,gen_datetime,total_num,balance_water_no,file_name,check_flag
from st_que_reg_total  where balance_water_no=in_balance_water_no;
insert into acc_st_his.st_his_reg_dtl(water_no,data_code,data_value,balance_water_no,file_name,check_flag)
select water_no,data_code,data_value,balance_water_no,file_name,check_flag
from st_que_reg_dtl where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_reg_total',v_s_time,v_e_time,in_balance_water_no);
-------------------------------Lcc∂”¡– ˝æ›µº¿˙ ∑±Ì
     v_s_time := sysdate;
insert into acc_st_his.st_his_lcc(water_no,balance_water_no,line_id,station_id,bom_sale_sjt_num,bom_sale_sjt_fee,tvm_sale_sjt_num,
tvm_sale_sjt_fee,bom_sale_num,bom_sale_deposit_fee,bom_charge_fee,tvm_charge_num,tvm_charge_fee,
return_num,return_fee,non_return_num,non_ret_deposit_fee,non_ret_actual_ret_bala,negative_charge_num,
negative_charge_fee,deal_num,deal_fee,update_cash_num,update_cash_fee,update_noncash_num,
update_noncash_fee,admin_num,admin_return_fee,admin_penalty_fee,file_name,check_flag)
select water_no,balance_water_no,line_id,station_id,bom_sale_sjt_num,bom_sale_sjt_fee,tvm_sale_sjt_num,
tvm_sale_sjt_fee,bom_sale_num,bom_sale_deposit_fee,bom_charge_fee,tvm_charge_num,tvm_charge_fee,
return_num,return_fee,non_return_num,non_ret_deposit_fee,non_ret_actual_ret_bala,negative_charge_num,
negative_charge_fee,deal_num,deal_fee,update_cash_num,update_cash_fee,update_noncash_num,
update_noncash_fee,admin_num,admin_return_fee,admin_penalty_fee,file_name,check_flag
from st_que_lcc where balance_water_no=in_balance_water_no;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_lcc',v_s_time,v_e_time,in_balance_water_no);
--±∏∑›”–∏¸∏ƒµƒ±Ì£®±∏∑›±Ì÷ª±£¡Ù◊ÓΩ¸5ÃÏµƒ ˝æ›£©
--∫⁄√˚µ•±Ìop_prm_black_list_mtr
--»°µ±«∞ ±º‰«∞5ÃÏµƒ»’∆⁄
     v_s_time := sysdate;
 v_balance_water_no7:=to_char((to_date(substr(in_balance_water_no,1,8),'yyyymmdd')-5),'yyyymmdd')||'01';
v_msg := '≤Â»Î±Ìop_his_black_list_mtr';
delete op_his_black_list_mtr where balance_water_no<v_balance_water_no7;
insert into op_his_black_list_mtr(gen_datetime,card_logical_id ,black_type ,remark ,action_type,create_datetime,operator_id,
  is_set,  balance_water_no)
select gen_datetime,card_logical_id ,black_type ,remark ,action_type,create_datetime,operator_id,
  is_set,  in_balance_water_no from op_prm_black_list_mtr;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','op_his_black_list_mtr',v_s_time,v_e_time,in_balance_water_no);
--∫⁄√˚µ•∂Œ±Ìop_prm_black_list_mtr_sec
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìop_his_black_list_mtr_sec';
delete op_his_black_list_mtr_sec where balance_water_no<v_balance_water_no7;
insert into op_his_black_list_mtr_sec(gen_datetime,begin_logical_id,end_logical_id,black_type,remark,action_type,create_datetime,
       operator_id,is_set,balance_water_no)
select gen_datetime,begin_logical_id,end_logical_id,black_type,remark,action_type,create_datetime,
       operator_id,is_set,in_balance_water_no
from op_prm_black_list_mtr_sec;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','op_his_black_list_mtr_sec',v_s_time,v_e_time,in_balance_water_no);
--¥¢÷µø®’Àªß±Ì st_act_svt
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_act_svt';
delete acc_st_his.st_his_act_svt where balance_water_no<v_balance_water_no7;
insert into acc_st_his.st_his_act_svt(card_main_id,card_sub_id,card_logical_id,card_physical_id,total_charge_num,total_consume_num,
total_charge_fee,total_consume_fee,system_balance_fee,card_balance_fee,old_expire_datetime,new_expire_datetime,
balance_water_no,card_charge_seq,card_consume_seq,deposit_fee,card_money,curr_balance_water)
 select card_main_id,card_sub_id,card_logical_id,card_physical_id,total_charge_num,total_consume_num,total_charge_fee,
 total_consume_fee,system_balance_fee,card_balance_fee,old_expire_datetime,new_expire_datetime,
 balance_water_no,card_charge_seq,card_consume_seq,deposit_fee,card_money,in_balance_water_no
from st_act_svt;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_act_svt',v_s_time,v_e_time,in_balance_water_no);
--∑«º¥ ±ÕÀøÓΩ·π˚±Ìst_list_non_rtn
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_non_rtn';
delete acc_st_his.st_his_non_rtn where balance_water_no<v_balance_water_no7;
insert into acc_st_his.st_his_non_rtn£®water_no,device_id,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_print_id,apply_datetime,receipt_id,
  operator_id,apply_name,tel_no,identity_type,identity_id,is_broken,shift_id,card_app_flag,balance_water_no ,
  hdl_flag,deposit_fee,card_balance_fee,system_balance_fee,penalty_fee,return_bala,remark,return_line_id,
  return_station_id,return_dev_type_id,return_device_id,actual_return_bala,audit_flag,penalty_reason,curr_balance_water£©
select seq_st_his_non_rtn.nextval,device_id,card_main_id,card_sub_id,card_logical_id,card_physical_id,card_print_id,apply_datetime,receipt_id,
  operator_id,apply_name,tel_no,identity_type,identity_id,is_broken,shift_id,card_app_flag,balance_water_no ,
  hdl_flag,deposit_fee,card_balance_fee,system_balance_fee,penalty_fee,return_bala,remark,return_line_id,
  return_station_id,return_dev_type_id,return_device_id,actual_return_bala,audit_flag,penalty_reason,in_balance_water_no
from st_list_non_rtn;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_non_rtn',v_s_time,v_e_time,in_balance_water_no);
--samø®’Àªß±Ìst_act_sam
     v_s_time := sysdate;
v_msg := '≤Â»Î±Ìacc_st_his.st_his_act_sam';
delete acc_st_his.st_his_act_sam where balance_water_no<v_balance_water_no7;
insert into acc_st_his.st_his_act_sam£®line_id,station_id,dev_type_id,device_id,tk_app_mode,sam_logical_id,
sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no£©
select line_id,station_id,dev_type_id,device_id,tk_app_mode,sam_logical_id,
sam_trade_seq_start,sam_trade_seq_end,total_deal_num,in_balance_water_no
from st_act_sam;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_his_act_sam',v_s_time,v_e_time,in_balance_water_no);
--”‡∂Ó∆Ω∫‚÷–º‰±Ì
/*
     v_s_time := sysdate;
v_msg := '…æ≥˝±Ìacc_st_his.st_sts_deal_svt ˝æ›';
v_balance_water_no7:=to_char((to_date(substr(in_balance_water_no,1,8),'yyyymmdd')-90),'yyyymmdd')||'01';
delete st_sts_deal_svt where balance_water_no<v_balance_water_no7;
     v_e_time := sysdate;
     insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_sts_deal_svt',v_s_time,v_e_time,in_balance_water_no);
*/
--”‡∂Ó∆Ω∫‚÷–º‰±Ì modify by lindauqan 20170217 ver1.40
   v_s_time := sysdate;
   v_msg := '…æ≥˝±Ìst_sts_settle_svt_deal ˝æ›';
   v_balance_water_no7:=to_char((to_date(substr(in_balance_water_no,1,8),'yyyymmdd')-90),'yyyymmdd')||'01';
   delete acc_st.st_sts_settle_svt_deal where balance_water_no<v_balance_water_no7;
   v_e_time := sysdate;
   insert into tmp_procedure_flow values ('up_st_ist_settle_his','st_sts_settle_svt_deal',v_s_time,v_e_time,in_balance_water_no);


--  ÷ª˙÷ß∏∂¿˙ ∑ ˝æ›±∏∑› modify by lindauqan 20160112
v_msg := ' ÷ª˙÷ß∏∂¿˙ ∑ ˝æ›±∏∑›£¨…æ≥˝∂”¡–±Ì';
select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.mobile.control' and cfg_value='1';
if v_count>0 then
    -- ≤Â»Î¿˙ ∑±Ì
    insert into acc_st_his.st_mb_his_lock
           (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, lock_flag, lock_datetime, operator_id, shift_id, card_app_flag, balance_water_no, file_name, check_flag, card_app_mode, mobile_no)
    select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, lock_flag, lock_datetime, operator_id, shift_id, card_app_flag, balance_water_no, file_name, check_flag, card_app_mode, mobile_no
    from acc_st.st_mb_que_lock where balance_water_no=in_balance_water_no;

    insert into acc_st_his.st_mb_his_deal
           (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, receipt_id, tac, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, operator_id, shift_id, last_sam_logical_id, last_deal_datetime, deal_no_discount_fee, union_year_month, union_bus_num, union_metro_num, union_total_num, trade_sort, card_area_code, card_area_type, overdraft_fee, card_cpu_flag, card_expired_flag, tct_valid_days, tct_activate_datetime, limit_mode, limit_entry_station, limit_exit_station, card_app_flag, balance_water_no, file_name, check_flag, city_code, business_code, tac_deal_type, tac_dev_id, work_mode, card_app_mode, paid_channel_type, paid_channel_code, mobile_no)
    select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, receipt_id, tac, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, operator_id, shift_id, last_sam_logical_id, last_deal_datetime, deal_no_discount_fee, union_year_month, union_bus_num, union_metro_num, union_total_num, trade_sort, card_area_code, card_area_type, overdraft_fee, card_cpu_flag, card_expired_flag, tct_valid_days, tct_activate_datetime, limit_mode, limit_entry_station, limit_exit_station, card_app_flag, balance_water_no, file_name, check_flag, city_code, business_code, tac_deal_type, tac_dev_id, work_mode, card_app_mode, paid_channel_type, paid_channel_code, mobile_no
    from acc_st.st_mb_que_deal where balance_water_no=in_balance_water_no;

    insert into acc_st_his.st_mb_his_return
           (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, return_balance_fee, return_deposit_fee, penalty_fee, penalty_reason_id, card_consume_seq, return_type, return_datetime, receipt_id, apply_datetime, tac, operator_id, shift_id, auxi_fee, card_app_flag, balance_water_no, file_name, check_flag, tac_deal_type, tac_dev_id, paid_channel_type, paid_channel_code, mobile_no)
    select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, return_balance_fee, return_deposit_fee, penalty_fee, penalty_reason_id, card_consume_seq, return_type, return_datetime, receipt_id, apply_datetime, tac, operator_id, shift_id, auxi_fee, card_app_flag, balance_water_no, file_name, check_flag, tac_deal_type, tac_dev_id, paid_channel_type, paid_channel_code, mobile_no
    from acc_st.st_mb_que_return where balance_water_no=in_balance_water_no;

    insert into acc_st_his.st_mb_his_sale
           (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, water_no_business, sam_logical_id, sam_trade_seq, deposit_type, deposit_fee, sale_datetime, receipt_id, operator_id, shift_id, auxi_fee, card_app_flag, balance_water_no, file_name, check_flag, mobile_no)
    select water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, water_no_business, sam_logical_id, sam_trade_seq, deposit_type, deposit_fee, sale_datetime, receipt_id, operator_id, shift_id, auxi_fee, card_app_flag, balance_water_no, file_name, check_flag, mobile_no
    from acc_st.st_mb_que_sale where balance_water_no=in_balance_water_no;

    insert into acc_st_his.st_mb_his_lcc
           (water_no, balance_water_no, line_id, station_id, charge_num, charge_fee, return_num, return_fee, file_name, check_flag, sale_num, sale_fee, lock_num, unlock_num)
    select water_no, balance_water_no, line_id, station_id, charge_num, charge_fee, return_num, return_fee, file_name, check_flag, sale_num, sale_fee, lock_num, unlock_num
    from acc_st.st_mb_que_lcc where balance_water_no=in_balance_water_no;


    --…æ≥˝∂”¡–±Ì
    delete acc_st.st_mb_que_deal where balance_water_no=in_balance_water_no;
    delete acc_st.st_mb_que_lock where balance_water_no=in_balance_water_no;
    delete acc_st.st_mb_que_return where balance_water_no=in_balance_water_no;
    delete acc_st.st_mb_que_sale where balance_water_no=in_balance_water_no;
    delete acc_st.st_mb_que_lcc where balance_water_no=in_balance_water_no;
end if;

-- ª•¡™Õ¯÷ß∏∂¿˙ ∑ ˝æ›±∏∑› v1.38 modify by lindauqan 20161130
v_msg := 'ª•¡™Õ¯÷ß∏∂¿˙ ∑ ˝æ›±∏∑›£¨…æ≥˝∂”¡–±Ì';
select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.np.control' and cfg_value='1';
if v_count>0 then
    -- ≤Â»Î¿˙ ∑±Ì
    insert into acc_st_his.st_np_his_deal
      (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, receipt_id, tac, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, operator_id, shift_id, last_sam_logical_id, last_deal_datetime, deal_no_discount_fee, union_year_month, union_bus_num, union_metro_num, union_total_num, trade_sort, card_area_code, card_area_type, overdraft_fee, card_cpu_flag, card_expired_flag, tct_valid_days, tct_activate_datetime, limit_mode, limit_entry_station, limit_exit_station, card_app_flag, balance_water_no, file_name, check_flag, city_code, business_code, tac_deal_type, tac_dev_id, work_mode, card_app_mode, order_no)
    select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_status_id, deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, receipt_id, tac, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, operator_id, shift_id, last_sam_logical_id, last_deal_datetime, deal_no_discount_fee, union_year_month, union_bus_num, union_metro_num, union_total_num, trade_sort, card_area_code, card_area_type, overdraft_fee, card_cpu_flag, card_expired_flag, tct_valid_days, tct_activate_datetime, limit_mode, limit_entry_station, limit_exit_station, card_app_flag, balance_water_no, file_name, check_flag, city_code, business_code, tac_deal_type, tac_dev_id, work_mode, card_app_mode, order_no
    from acc_st.st_np_que_deal where balance_water_no=in_balance_water_no;
    insert into acc_st_his.st_np_his_lcc
      (water_no, balance_water_no, line_id, station_id, charge_fee, charge_num, sale_fee, sale_num, file_name, check_flag)
    select water_no, balance_water_no, line_id, station_id, charge_fee, charge_num, sale_fee, sale_num, file_name, check_flag
    from acc_st.st_np_que_lcc where balance_water_no=in_balance_water_no;
    insert into acc_st_his.st_np_his_order
      (water_no, order_no, order_type, status, generate_datetime, paid_datetime, card_main_id, card_sub_id, line_id_start, station_id_start, line_id_end, station_id_end, deal_unit_fee, deal_num, deal_fee, order_type_buy, paid_channel_type, paid_channel_code, mobile_no, balance_water_no, file_name, check_flag)
    select water_no, order_no, order_type, status, generate_datetime, paid_datetime, card_main_id, card_sub_id, line_id_start, station_id_start, line_id_end, station_id_end, deal_unit_fee, deal_num, deal_fee, order_type_buy, paid_channel_type, paid_channel_code, mobile_no, balance_water_no, file_name, check_flag
    from acc_st.st_np_que_order where balance_water_no=in_balance_water_no;
    insert into acc_st_his.st_np_his_order_imp
      (water_no, order_no, order_type, finish_datetime, line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id, deal_num, deal_num_not, deal_fee, refund_fee, auxi_fee, balance_water_no, file_name, check_flag)
    select water_no, order_no, order_type, finish_datetime, line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id, deal_num, deal_num_not, deal_fee, refund_fee, auxi_fee, balance_water_no, file_name, check_flag
    from acc_st.st_np_que_order_imp where balance_water_no=in_balance_water_no;
    insert into acc_st_his.st_np_his_sale
      (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, sale_datetime, pay_type, card_logical_id_pay, card_trade_seq, card_logical_id, card_physical_id, sale_fee, card_main_id, card_sub_id, zone_id, tac, deposit_type, deposit_fee, operator_id, shift_id, balance_water_no, file_name, check_flag, card_status_id, auxi_fee, card_count_used, card_app_flag, tac_deal_type, tac_dev_id, order_no)
    select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, sale_datetime, pay_type, card_logical_id_pay, card_trade_seq, card_logical_id, card_physical_id, sale_fee, card_main_id, card_sub_id, zone_id, tac, deposit_type, deposit_fee, operator_id, shift_id, balance_water_no, file_name, check_flag, card_status_id, auxi_fee, card_count_used, card_app_flag, tac_deal_type, tac_dev_id, order_no
    from acc_st.st_np_que_sale where balance_water_no=in_balance_water_no;

    --…æ≥˝∂”¡–±Ì
    delete acc_st.st_np_que_deal where balance_water_no=in_balance_water_no;
    delete acc_st.st_np_que_lcc where balance_water_no=in_balance_water_no;
    delete acc_st.st_np_que_order where balance_water_no=in_balance_water_no;
    delete acc_st.st_np_que_order_imp where balance_water_no=in_balance_water_no;
    delete acc_st.st_np_que_sale where balance_water_no=in_balance_water_no;


end if;

------------------…æ≥˝∂”¡–±Ì
     v_s_time := sysdate;
delete st_que_deal where balance_water_no=in_balance_water_no;
delete st_que_update where balance_water_no=in_balance_water_no;
delete st_que_entry where balance_water_no=in_balance_water_no;
delete st_que_sale_sjt where balance_water_no=in_balance_water_no;
delete st_que_lock where balance_water_no=in_balance_water_no;
delete st_que_admin where balance_water_no=in_balance_water_no;
delete st_que_delay where balance_water_no=in_balance_water_no;
delete st_que_sale where balance_water_no=in_balance_water_no;
delete acc_st.st_que_non_rtn_app where balance_water_no=in_balance_water_no;
delete acc_st.st_que_sign_card_apply where balance_water_no=in_balance_water_no;
delete acc_st.st_que_report_loss where balance_water_no=in_balance_water_no;
delete st_que_return where balance_water_no=in_balance_water_no;
delete st_ext_mtr_que_deal where balance_water_no=in_balance_water_no;
delete st_que_deal_oct where balance_water_no=in_balance_water_no;
delete st_que_sale_oct where balance_water_no=in_balance_water_no;
delete st_que_deal_bank where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_total where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_sale where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_charge where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_update where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_admin where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_delay where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_return where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_rtn_non where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_rtn_app where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_chg_upd where balance_water_no=in_balance_water_no;
delete st_que_bom_shift_unlock where balance_water_no=in_balance_water_no;
delete st_que_tvm_note_data where balance_water_no=in_balance_water_no;
delete st_que_tvm_coin_data where balance_water_no=in_balance_water_no;
delete st_que_tvm_coin_put where balance_water_no=in_balance_water_no;
delete st_que_tvm_coin_clear where balance_water_no=in_balance_water_no;
delete st_que_tvm_card_put where balance_water_no=in_balance_water_no;
delete st_que_tvm_card_clear where balance_water_no=in_balance_water_no;
delete st_que_tvm_waste_card_data where balance_water_no=in_balance_water_no;
delete st_que_agm_card_data where balance_water_no=in_balance_water_no;
delete st_que_agm_cutoff_dtl where balance_water_no=in_balance_water_no;
delete st_que_agm_cutoff_total where balance_water_no=in_balance_water_no;
delete st_que_tvm_cutoff_dtl where balance_water_no=in_balance_water_no;
delete st_que_tvm_cutoff_total where balance_water_no=in_balance_water_no;
--‘ˆº”TVMΩ·’À ˝æ›°¢◊‘∂ØΩ·¥Ê°¢÷Ω±“ªÿ ’œ‰°¢’“¡„œ‰¥Ê»Î°¢’“¡„œ‰»°≥ˆ …æ≥˝∂”¡–±Ì by lindaquan 20160622
delete acc_st.st_que_tvm_bal where balance_water_no=in_balance_water_no;
delete acc_st.st_que_tvm_auto_bal where balance_water_no=in_balance_water_no;
delete acc_st.st_que_tvm_note_chg_pop where balance_water_no=in_balance_water_no;
delete acc_st.st_que_tvm_note_chg_put where balance_water_no=in_balance_water_no;
delete acc_st.st_que_tvm_note_reclaim where balance_water_no=in_balance_water_no;

   v_e_time := sysdate;
   insert into tmp_procedure_flow values ('up_st_ist_settle_his','delete',v_s_time,v_e_time,in_balance_water_no);

   v_s_time := sysdate;
delete st_que_reg_total  where balance_water_no=in_balance_water_no;
delete st_que_reg_dtl where balance_water_no=in_balance_water_no;
delete st_que_lcc where balance_water_no=in_balance_water_no;
delete st_list_balance_trx;
delete st_list_balance_contc;
delete st_list_balance_line;
   v_e_time := sysdate;
   insert into tmp_procedure_flow values ('up_st_ist_settle_his','delete-reg',v_s_time,v_e_time,in_balance_water_no);

   v_s_time := sysdate;
   commit;
   v_e_time := sysdate;
   insert into tmp_procedure_flow values ('up_st_ist_settle_his','commit',v_s_time,v_e_time,in_balance_water_no);
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_HIS to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_HIS_CREATE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_settle_his_create(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                    out_msg       OUT VARCHAR2, --∑µªÿ–≈œ¢
                                                    in_que        in varchar2) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_HIS_MORE
  --π¶ƒ‹√Ë ˆ£∫Ω®¡¢÷–—Î«ÂÀ„£∫µ•≥Ã∆±∑¢ €°¢«Æ∞¸Ωª“◊°¢Ω¯’æ°¢∏¸–¬ ˝æ›¿˙ ∑±Ìµƒ¿˙ ∑∑÷±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫201301021
  --–ﬁ∏ƒ£∫
  -------------------------------------------------------------------------------
 AS

  v_msg VARCHAR(50);
  --v_sql              varchar(5000);
  --v_new_begin date; --–¬µƒø™ º ±º‰
  --v_new_end          date; --–¬µƒΩ· ¯ ±º‰
  v_min_time date; --buf±Ì÷–µƒ◊Ó–°Ωª“◊ ±º‰
  v_max_time date; --buf±Ì÷–µƒ◊Ó¥ÛΩª“◊ ±º‰
  v_new_date varchar2(20); --
  --v_begin_time date; --¿˙ ∑À˜“˝÷–µƒø™ º ±º‰
  --v_end_time   date; --¿˙ ∑À˜“˝÷–µƒΩ· ¯ ±º‰
  --v_min_table        char(30); --◊Ó–°Ωª“◊ ±º‰∂‘”¶µƒ◊Ó–°µƒ¿˙ ∑±Ì√˚
  v_max_table    varchar2(30); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count        number(18);
  v_count2       number(18);
  v_flag         number(1); --¥¥Ω®001µƒ±Í÷æ£¨0£∫¥¥Ω®
  v_deal_type    char(2); --Ωª“◊¿‡–Õ  50, 53, 54,56
  v_time         varchar2(20);
  v_balance_time varchar2(20);
  --v_ss               varchar(2000);
  --v_tmp1             varchar(256);
  --v_c_begin          char(20); --µ±«∞±Ì∂‘”¶µƒø™ º ±º‰
  v_temp_sql    varchar2(8000); --¡Ÿ ±sql”Ôæ‰
  v_table_sql   varchar2(5000); --Ω®±Ì¡Ÿ ±sql”Ôæ‰               
  v_temp_num    varchar2(3); --∑÷±Ì–Ú¡–∫≈
  v_limit_count number(18); --∏˜Ωª“◊¿‡–Õ∑÷±Ìœﬁ÷∆ ˝¡ø
  --v_balance_water_no char(10); --«ÂÀ„¡˜ÀÆ∫≈
  v_begin_index number(3); --∑÷±Ì±Ì√˚÷––Ú¡–∫≈µƒ∆ ºœ¬±Í,¿˝»Ást_his_deal_001,‘Úv_begin_index=11
BEGIN

  if in_que = 'st_his_deal' or in_que = 'oct_deal' then
    v_time := 'deal_datetime';
  end if;

  if in_que = 'st_his_entry' or in_que = 'oct_entry' then
    v_time := 'entry_datetime';
  end if;
  if in_que = 'st_his_sale_sjt' or in_que = 'oct_singl_sale' then
    v_time := 'sale_datetime';
  end if;
  if in_que = 'st_his_update' or in_que = 'oct_update' then
    v_time := 'update_datetime';
  end if;

  v_limit_count := 8000000; --∑÷±Ì≥¨π˝800ÕÚæÕ¥¥Ω®–¬∑÷±Ì
  --◊ÚÃÏ«ÂÀ„µƒ»’∆⁄
  --select to_char(sysdate - 1, 'yyyymmdd') into v_time from dual;
  --
  select '20130816' into v_balance_time from dual;
  --«Æ∞¸Ωª“◊st_his_deal
  if (in_que = 'st_his_deal' or in_que = 'oct_his') then
    v_deal_type   := '54';
    v_begin_index := 13;
    v_table_sql   := '(WATER_NO  NUMBER(18),  LINE_ID               CHAR(2),  STATION_ID            CHAR(2),
                      DEV_TYPE_ID           CHAR(2),  DEVICE_ID             CHAR(3),  SAM_LOGICAL_ID        CHAR(20),  SAM_TRADE_SEQ         NUMBER(18),
                      DEAL_DATETIME         DATE,  CARD_MAIN_ID          CHAR(2),  CARD_SUB_ID           CHAR(2),  CARD_LOGICAL_ID       CHAR(20),
                      CARD_PHYSICAL_ID      CHAR(20),  CARD_STATUS_ID        CHAR(3),  DEAL_FEE              NUMBER(18,2),  DEAL_BALANCE_FEE      NUMBER(18,2),
                      CARD_CHARGE_SEQ       NUMBER(18),  CARD_CONSUME_SEQ      NUMBER(18),  PAY_MODE_ID           CHAR(2),  RECEIPT_ID            CHAR(4),
                      TAC                   CHAR(10),  ENTRY_LINE_ID         CHAR(2),  ENTRY_STATION_ID      CHAR(2),  ENTRY_SAM_LOGICAL_ID  CHAR(20),
                      ENTRY_DATETIME        DATE,  OPERATOR_ID           CHAR(6),  SHIFT_ID              CHAR(2),  LAST_SAM_LOGICAL_ID   CHAR(20),
                      LAST_DEAL_DATETIME    DATE,  DEAL_NO_DISCOUNT_FEE  NUMBER(18,2),  UNION_YEAR_MONTH      CHAR(4),  UNION_BUS_NUM         NUMBER(18),
                      UNION_METRO_NUM       NUMBER(18),  UNION_TOTAL_NUM       NUMBER(18),  TRADE_SORT            CHAR(2),  CARD_AREA_CODE        CHAR(4),
                      CARD_AREA_TYPE        CHAR(4),  OVERDRAFT_FEE         NUMBER(18,2),  CARD_CPU_FLAG         CHAR(1),  CARD_EXPIRED_FLAG     CHAR(1),
                      TCT_VALID_DAYS        NUMBER,  TCT_ACTIVATE_DATETIME DATE,  LIMIT_MODE            CHAR(3),  LIMIT_ENTRY_STATION   CHAR(4),
                      LIMIT_EXIT_STATION    CHAR(4),  CARD_APP_FLAG         CHAR(1),  BALANCE_WATER_NO      CHAR(10),  FILE_NAME             VARCHAR2(30),
                      CHECK_FLAG            CHAR(1))
                    tablespace TBS_ST_DATA
                      pctfree 10
                      initrans 1
                      maxtrans 255
                      storage
                      (
                        initial 64
                        next 1
                        minextents 1
                        maxextents unlimited
                      )';
  
  end if;

  --Ω¯’æΩª“◊ st_his_entry
  if in_que = 'st_his_entry' or in_que = 'oct_entry' then
    v_deal_type   := '53';
    v_begin_index := 14;
    v_table_sql   := '(WATER_NO              NUMBER(18),  LINE_ID               CHAR(2),  STATION_ID            CHAR(2),  DEV_TYPE_ID           CHAR(2),  DEVICE_ID             CHAR(3),  SAM_LOGICAL_ID        CHAR(20),
                      SAM_TRADE_SEQ         NUMBER(18),  CARD_MAIN_ID          CHAR(2),  CARD_SUB_ID           CHAR(2),  CARD_LOGICAL_ID       CHAR(20),
                      CARD_PHYSICAL_ID      CHAR(20),  ENTRY_DATETIME        DATE,  CARD_STATUS_ID        CHAR(3),  BALANCE_FEE           NUMBER(18,2),  UNION_YEAR_MONTH      CHAR(4),
                      UNION_TOTAL_NUM       NUMBER(18),  UNION_BUS_NUM         NUMBER(18),  UNION_METRO_NUM       NUMBER(18),  CARD_CHARGE_SEQ       NUMBER(18),  CARD_CONSUME_SEQ      NUMBER(18),
                      TAC                   CHAR(10),  PAY_MODE_ID           CHAR(2),  LAST_SAM_LOGICAL_ID   CHAR(20),  LAST_DATETIME         DATE,  TRADE_SORT            CHAR(2),
                      CARD_AREA_CODE        CHAR(4),  CARD_AREA_TYPE        CHAR(4),  OVERDRAFT_LIMIT_FEE   NUMBER(18,2),  CARD_PHYSICAL_TYPE    CHAR(1),  CARD_EXPIRED_FLAG     CHAR(1),
                      TCT_VALID_DAYS        NUMBER(18),  TCT_ACTIVATE_DATETIME DATE,  LIMIT_MODE            CHAR(3),
                      LIMIT_ENTRY_STATION   CHAR(4),  LIMIT_EXIT_STATION    CHAR(4),  BALANCE_WATER_NO      CHAR(10),  CARD_APP_FLAG         CHAR(1),  FILE_NAME             VARCHAR2(30),  CHECK_FLAG            CHAR(1)
                    )
                    tablespace TBS_ST_DATA
                      pctfree 10
                      initrans 1
                      maxtrans 255
                      storage
                      (
                        initial 64
                        next 1
                        minextents 1
                        maxextents unlimited
                      )';
  end if;

  --µ•≥Ã∆±∑¢ € st_buf_sale_sjt
  if in_que = 'st_his_sale_sjt' or in_que = 'oct_singl_sale' then
    v_deal_type   := '50';
    v_begin_index := 17;
    v_table_sql   := '(  WATER_NO            NUMBER(18),  LINE_ID             CHAR(2),  STATION_ID          CHAR(2),  DEV_TYPE_ID         CHAR(2),  DEVICE_ID           CHAR(3),
                      SAM_LOGICAL_ID      CHAR(20),  SAM_TRADE_SEQ       NUMBER(18),  SALE_DATETIME       DATE,  PAY_TYPE            CHAR(2),  CARD_LOGICAL_ID_PAY CHAR(20),
                      CARD_TRADE_SEQ      NUMBER(18),  CARD_LOGICAL_ID     CHAR(20),  CARD_PHYSICAL_ID    CHAR(20),  SALE_FEE            NUMBER(18,2),  CARD_MAIN_ID        CHAR(2),  CARD_SUB_ID         CHAR(2),
                      ZONE_ID             CHAR(2),  TAC                 CHAR(10),  DEPOSIT_TYPE        CHAR(2),  DEPOSIT_FEE         NUMBER(18,2),  OPERATOR_ID         CHAR(6),
                      SHIFT_ID            CHAR(2),  BALANCE_WATER_NO    CHAR(10),  FILE_NAME           CHAR(25),  CHECK_FLAG          CHAR(1),
                      CARD_STATUS_ID      NUMBER(18),  AUXI_FEE            NUMBER(18,2),  CARD_COUNT_USED     NUMBER(18),  CARD_APP_FLAG       CHAR(1)
                    )
                    tablespace TBS_ST_DATA
                      pctfree 10
                      initrans 1
                      maxtrans 255
                      storage
                      (
                        initial 64
                        next 1
                        minextents 1
                        maxextents unlimited
                      )';
  end if;

  --∏¸–¬Ωª“◊st_buf update
  if in_que = 'st_his_update' or in_que = 'oct_update' then
    v_deal_type   := '56';
    v_begin_index := 15;
    v_table_sql   := '(
                        WATER_NO             NUMBER(18),  LINE_ID              CHAR(2),  STATION_ID           CHAR(2),  DEV_TYPE_ID          CHAR(2),  DEVICE_ID            CHAR(3),  SAM_LOGICAL_ID       CHAR(20),
                        SAM_TRADE_SEQ        NUMBER(18),  CARD_MAIN_ID         CHAR(2),  CARD_SUB_ID          CHAR(2),  CARD_LOGICAL_ID      CHAR(20),  CARD_PHYSICAL_ID     CHAR(20),  CARD_CONSUME_SEQ     NUMBER,  CARD_STATUS_ID       CHAR(3),  UPDATE_AREA          CHAR(1),
                        UPDATE_REASON_ID     CHAR(2),  UPDATE_DATETIME      DATE,  PAY_TYPE             CHAR(2),  PENALTY_FEE          NUMBER(18,2),
                        RECEIPT_ID           CHAR(4),  OPERATOR_ID          CHAR(6),  ENTRY_LINE_ID        CHAR(2),  ENTRY_STATION_ID     CHAR(2),
                        SHIFT_ID             CHAR(2),  UNION_YEAR_MONTH     CHAR(4),  UNION_BUS_NUM        NUMBER(18),  UNION_METRO_NUM      NUMBER(18),  UNION_TOTAL_NUM      NUMBER(18),  BALANCE_FEE          NUMBER(18,2),  DEAL_NO_DISCOUNT_FEE NUMBER(18,2),
                        CARD_CHARGE_SEQ      NUMBER(18),  TAC                  CHAR(10),  PAY_MODE_ID          CHAR(2),  ENTRY_SAM_LOGICAL_ID CHAR(20),  ENTRY_TIME           DATE,  LAST_SAM_LOGICAL_ID  CHAR(20),  LAST_DATETIME        DATE,  TRADE_SORT           CHAR(2),
                        CARD_AREA_CODE       CHAR(4),  CARD_AREA_TYPE       CHAR(4),  OVERDRAFT_LIMIT_FEE  NUMBER(18),  CARD_PHYSICAL_TYPE   CHAR(1),  CARD_EXPIRED_FLAG    CHAR(1),  TCT_VALID_DAYS       NUMBER(18),  TCT_ACTIVATE_TIME    DATE,  CARD_APP_FLAG        CHAR(1),
                        LIMIT_MODE           CHAR(3),  LIMIT_ENTRY_STATION  CHAR(4),  LIMIT_EXIT_STATION   CHAR(4),  BALANCE_WATER_NO     CHAR(10),  FILE_NAME            VARCHAR2(30),  CHECK_FLAG           CHAR(1)
                      )
                      tablespace TBS_ST_DATA
                        pctfree 10
                        initrans 1
                        maxtrans 255
                        storage
                        (
                          initial 64
                          next 1
                          minextents 1
                          maxextents unlimited
                        )';
  
  end if;
  /**
  
   select count(*)
    into v_count
    from user_indexes
   WHERE table_name like in_que || '_%'
     and table_name not in (select table_name from st_idx_trx_history);
     
  **/
  begin
    begin
      select count(*)
        into v_count
        from st_idx_trx_history
       where table_name like in_que || '_%';
    end;
    begin
      v_temp_sql := 'select count(*) from user_objects where object_name = upper (''' ||
                    in_que || '_001'')';
      execute immediate v_temp_sql
        into v_count2;
    end;
  end;
  if v_count = 0 then
    --st_idx_trx_history√ª”–Ωª“◊∑÷±Ìµƒº«¬º
    if v_count2 > 0 then
      --∑÷±ÌµƒŒÔ¿Ì±Ì¥Ê‘⁄
      v_temp_sql := 'drop table ' || in_que || '_001';
      execute immediate v_temp_sql; --…æ≥˝001∑÷±Ì±Ì
    
    end if;
    v_flag := 0;
  
  else
    ----st_idx_trx_history”–Ωª“◊∑÷±Ìµƒº«¬º
    if v_count2 = 0 then
      --∑÷±ÌµƒŒÔ¿Ì±Ì≤ª¥Ê‘⁄
      v_flag := 0;
    end if;
  end if;

  begin
    if v_flag = 0 then
      begin
        v_temp_sql := 'create table ' || in_que || '_001' || v_table_sql;
        execute immediate v_temp_sql; --¥¥Ω®001∑÷±Ì±Ì
      end;
      begin
        begin
          --µ⁄“ª¥Œ‘À––£¨»°÷Æ«∞µƒÀ˘”–µƒ«ÂÀ„ ˝æ›¥Ê∑≈µΩµ⁄“ª’≈±Ì
          v_temp_sql := 'select min(' || v_time || '),max(' || v_time ||
                        ') from ' || in_que ||
                        ' where substr(balance_water_no,0,8)<= ''' ||
                        v_balance_time || '''';
          execute immediate v_temp_sql
            into v_min_time, v_max_time;
        end;
        begin
          v_time     := to_char(v_min_time, 'yyyy-mm-dd');
          v_min_time := to_date(v_time || ' 00:00:00',
                                'yyyy-mm-dd hh24:mi:ss');
        end;
        begin
          v_time     := to_char(v_max_time, 'yyyy-mm-dd');
          v_max_time := to_date(v_time || ' 23:59:59',
                                'yyyy-mm-dd hh24:mi:ss');
        end;
        -- ≥ı ºªØÀ˜“˝±Ì÷–µƒ001±Ì 
        begin
          insert into st_idx_trx_history
          values
            (in_que || '_001',
             'trx',
             v_deal_type,
             v_min_time,
             v_max_time,
             0);
          commit;
        end;
      end;
    end if;
  end;
  begin
    --»°◊Ó¥Ûµƒ¿˙ ∑±Ì
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = v_deal_type;
  end;
  begin
    select substr(v_max_table, v_begin_index, 3),
           recd_count,
           to_char(end_date + 1, 'yyyy-mm-dd')
      into v_temp_num, v_count, v_new_date
      from st_idx_trx_history
     where table_name = v_max_table;
    /**
    in
          (select MAX(table_name)
             from st_idx_trx_history
             where substr(table_name, 0, 8) = in_que);**/
    begin
      --œ¬“ª∑÷±Ìµƒ–Ú¡–∫≈
      v_temp_num := up_st_ist_settle_his_num(v_temp_num);
    end;
  end;

  begin
    if (v_count > v_limit_count) then
      v_temp_sql := 'create table ' || in_que || v_temp_num || v_table_sql;
      execute immediate v_temp_sql; --¥¥Ω®00X∑÷±Ì
    
      v_min_time := to_date(v_new_date || ' 00:00:00',
                            'yyyy-mm-dd hh24:mi:ss');
      v_max_time := to_date(v_new_date || ' 23:59:59',
                            'yyyy-mm-dd hh24:mi:ss');
      v_temp_sql := ' insert into st_idx_trx_history values (''' || in_que ||
                    v_temp_num || '''trx'',''' || v_deal_type || ''',''' ||
                    v_min_time || ''',''' || v_max_time || ''',0 )';
      execute immediate v_temp_sql; --‘ˆº”“ªÃıº«¬ºµΩ¿˙ ∑∑÷±Ì÷–    
    
    end if;
  
  end;

  begin
    --»°◊Ó¥Ûµƒ¿˙ ∑±Ì£¨◊˜Œ™Ω·π˚∑µªÿ
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = v_deal_type;
  end;
  commit;
  out_msg       := v_max_table;
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm;
      out_retresult := sqlcode;
      return;
    end;
  
END up_st_ist_settle_his_create;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_HIS_CREATE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_HIS_MORE
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_ST_IST_SETTLE_HIS_MORE(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                      out_msg       OUT VARCHAR2, --∑µªÿ–≈œ¢ 
                                                      in_que        in varchar2) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_HIS_MORE
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫µ•≥Ã∆±∑¢ €°¢«Æ∞¸Ωª“◊°¢Ω¯’æ°¢∏¸–¬ ˝æ›µπ¿˙ ∑±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú
  --¥¥Ω®»’∆⁄£∫201300911
  --–ﬁ∏ƒ£∫
  -------------------------------------------------------------------------------
 AS

  v_msg       VARCHAR(50);
  v_sql       varchar(5000);
  v_new_end   date; --–¬µƒΩ· ¯ ±º‰ 
  v_min_time  date; --buf±Ì÷–µƒ◊Ó–°Ωª“◊ ±º‰ 
  v_max_time  date; --buf±Ì÷–µƒ◊Ó¥ÛΩª“◊ ±º‰ 
  v_min_table char(30); --◊Ó–°Ωª“◊ ±º‰∂‘”¶µƒ◊Ó–°µƒ¿˙ ∑±Ì√˚ 
  v_max_table char(30); --◊Ó¥Ûµƒ¿˙ ∑±Ì 
  v_count     number(18);
  v_deal_type char(2); --Ωª“◊¿‡–Õ  50, 53, 54,56 
  v_time      varchar(20);
  v_ss        varchar(2000);
  v_tmp1      varchar(256);
  v_c_begin   char(20); --µ±«∞±Ì∂‘”¶µƒø™ º ±º‰ 

BEGIN

  if in_que = 'st_buf_deal' or in_que = 'oct_deal' then
    v_time := 'deal_datetime';
  end if;

  if in_que = 'st_buf_entry' or in_que = 'oct_entry' then
    v_time := 'entry_datetime';
  end if;
  if in_que = 'st_buf_sale_sjt' or in_que = 'oct_singl_sale' then
    v_time := 'sale_datetime';
  end if;
  if in_que = 'st_buf_update' or in_que = 'oct_update' then
    v_time := 'update_datetime';
  end if;

  --»°Ωª“◊ ˝æ›÷–◊Ó–°µƒΩª“◊ ±º‰
  v_tmp1 := 'insert into t#st_ist_settle_his_more_min select min(' ||
            v_time || ') from ' || in_que;
  execute immediate v_tmp1;

  select min_time into v_min_time from t#st_ist_settle_his_more_min;

  --»°Ωª“◊ ˝æ›÷–◊Ó–°µƒΩª“◊ ±º‰
  v_tmp1 := 'insert into t#st_ist_settle_his_more_max select max(' ||
            v_time || ') from ' || in_que;
  execute immediate v_tmp1;

  select max_time into v_max_time from t#st_ist_settle_his_more_max;

  --«Æ∞¸Ωª“◊st_buf_deal 
  if (in_que = 'st_buf_deal' or in_que = 'oct_deal') then
    v_deal_type := '54';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_deal_%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := '«Æ∞¸Ωª“◊¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
    --»°◊Ó–°µƒΩª“◊»’∆⁄À˘‘⁄µƒ¿˙ ∑±Ì◊˜Œ™±æ¥Œ“™≤Â»Îµƒ◊Ó–°µƒ¿˙ ∑±Ì
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '54'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
  
    --»°◊Ó¥Ûµƒ¿˙ ∑±Ì
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '54';
  
    v_ss := 'WATER_NO,LINE_ID ,STATION_ID,DEV_TYPE_ID,DEVICE_ID ,SAM_LOGICAL_ID ,SAM_TRADE_SEQ ,DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID 
       ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ ,CARD_CONSUME_SEQ ,PAY_MODE_ID ,RECEIPT_ID,TAC,ENTRY_LINE_ID ,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,DEAL_NO_DISCOUNT_FEE 
       ,UNION_YEAR_MONTH  ,UNION_BUS_NUM ,UNION_METRO_NUM,UNION_TOTAL_NUM ,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,liMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG ,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG';
  end if;

  --Ω¯’æΩª“◊ st_buf_entry 
  if in_que = 'st_buf_entry' or in_que = 'oct_entry' then
    v_deal_type := '53';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_entry_%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := 'Ω¯’æΩª“◊¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '53'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '53';
    v_ss := 'WATER_NO,LINE_ID ,STATION_ID,DEV_TYPE_ID ,DEVICE_ID ,SAM_LOGICAL_ID,SAM_TRADE_SEQ ,CARD_MAIN_ID,CARD_SUB_ID ,CARD_LOGICAL_ID 
       ,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE ,UNION_YEAR_MONTH,UNION_TOTAL_NUM ,UNION_BUS_NUM ,UNION_METRO_NUM 
       ,CARD_CHARGE_SEQ ,CARD_CONSUME_SEQ,TAC ,PAY_MODE_ID ,LAST_SAM_LOGICAL_ID
       ,LAST_DATETIME ,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_LIMIT_FEE,CARD_PHYSICAL_TYPE,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME ,LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG ,FILE_NAME ,CHECK_FLAG';
  end if;

  --µ•≥Ã∆±∑¢ € st_buf_sale_sjt 
  if in_que = 'st_buf_sale_sjt' or in_que = 'oct_singl_sale' then
    v_deal_type := '50';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_sale_sjt%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := 'µ•≥Ã∆±∑¢ €¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
  
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '50'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
  
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '50';
  
    v_ss := 'WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE,CARD_LOGICAL_ID_PAY,CARD_TRADE_SEQ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,SALE_FEE,CARD_MAIN_ID,CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_STATUS_ID,AUXI_FEE,CARD_COUNT_USED,CARD_APP_FLAG';
  end if;

  --∏¸–¬Ωª“◊st_buf update
  if in_que = 'st_buf_update' or in_que = 'oct_update' then
    v_deal_type := '56';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_update_%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := '∏¸–¬Ωª“◊¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '56'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
  
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'TRX'
       and recd_type = '56';
  
    v_ss := 'WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,
       sAM_TRADE_SEQ,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
       CARD_CONSUME_SEQ,CARD_STATUS_ID,UPDATE_AREA,UPDATE_REASON_ID,
       UPDATE_DATETIME,PAY_TYPE,PENALTY_FEE,RECEIPT_ID,OPERATOR_ID,ENTRY_LINE_ID,
       ENTRY_STATION_ID,SHIFT_ID,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM
       ,UNION_TOTAL_NUM,BALANCE_FEE,DEAL_NO_DISCOUNT_FEE,CARD_CHARGE_SEQ,
       TAC,PAY_MODE_ID,ENTRY_SAM_LOGICAL_ID,ENTRY_TIME,LAST_SAM_LOGICAL_ID,
      LAST_DATETIME,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_LIMIT_FEE,
        CARD_PHYSICAL_TYPE,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_TIME,
        CARD_APP_FLAG,LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,
        BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG';
  end if;

  --≈–∂œ «∑Ò“—æ≠Ω¯––«ÂÀ„ 
  --20130228 luojun µº¿˙ ∑±Ì“∆÷¡√ø¥Œ¥¶¿Ì“ª≈˙œﬂ¬∑Œƒº˛∫Û√Ê,≤ª≈–∂œ «∑Ò“—æ≠Ω¯––«ÂÀ„ 
  /** 
  select v_sql = ' insert into #tmp_count select count(*) from ' || v_max_table || ' where balance_water_no = ' || ''' || v_center_balance_no ||''' 
  exec(v_sql) 
  select v_cc = cnt from #tmp_count 
  delete from #tmp_count 
  if v_cc > 0 
     begin 
       rollback tran 
       select v_return_num = -100 
       select v_memo ='“—æ≠Ω¯––π˝µ±»’«ÂÀ„ ' 
       insert balance_log  values(v_center_balance_no,'up_balance_his_more','1',v_memo,v_oper_no,    getdate()) 
       return 
     end 
  **/
  --∂®“Â»°≥ˆÀ˘”––Ë“™µº»Î ˝æ›µƒHis±Ìµƒ”Œ±Í
  --(◊Ó¥Ûµƒ¿˙ ∑±Ì–Ë“™Ãÿ ‚¥¶¿Ì,∏¸∏ƒst_idx_trx_history±Ì÷–∂‘”¶µƒΩ· ¯ ±º‰) 
  declare
    cursor cu_table is
      select table_name,
             to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss') begin_date,
             to_char(end_date, 'yyyy-mm-dd hh24:mi:ss') end_date
        from st_idx_trx_history
       where data_type = 'TRX'
         and recd_type = v_deal_type
         and table_name >= v_min_table
         and table_name <> v_max_table;
  begin
    for my_cur in cu_table loop
      v_tmp1 := 'lock table ' || my_cur.table_name ||
                ' in  exclusive mode nowait';
      execute immediate v_tmp1;
      --∞— ˝æ›∞¥Ωª“◊ ±º‰≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
      v_sql := 'insert into ' || my_cur.table_name || ' select ' || v_ss ||
               ' from ' || in_que || ' where ' || v_time || ' <= to_date(' || '''' ||
               my_cur.end_date || ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
               v_time || ' >= to_date(' || '''' || my_cur.begin_date ||
               ''',''yyyy-mm-dd hh24:mi:ss'')';
      execute immediate v_sql;
      delete t#st_ist_settle_his_more_col;
    
      --∏¸–¬st_idx_trx_history±Ì–≈œ¢ 
      v_sql := 'insert into t#st_ist_settle_his_more_count select count(*) from ' ||
               in_que || ' where ' || v_time || ' <= to_date(' || '''' ||
               my_cur.end_date || ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
               v_time || ' >= to_date(' || '''' || my_cur.begin_date ||
               ''',''yyyy-mm-dd hh24:mi:ss'')';
      execute immediate v_sql;
    
      select cnt into v_count from t#st_ist_settle_his_more_count;
      delete t#st_ist_settle_his_more_count;
      update st_idx_trx_history
         set recd_count = recd_count + v_count
       where table_name = my_cur.table_name;
    end loop;
  end;

  --∂‘◊Ó¥Ûµƒ¿˙ ∑±Ìµº»Î ˝æ› 
  v_tmp1 := 'lock table ' || v_max_table || ' in exclusive mode';
  execute immediate v_tmp1;

  select to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss')
    into v_c_begin
    from st_idx_trx_history
   where table_name = v_max_table;

  v_sql := ' insert into ' || v_max_table || ' select ' || v_ss || ' from ' ||
           in_que || ' where  ' || v_time || ' >=to_date(' || '''' ||
           v_c_begin || ''',''yyyy-mm-dd hh24:mi:ss'')';

  execute immediate v_sql;

  --∏¸–¬st_idx_trx_history±Ì–≈œ¢ 
  v_sql := 'insert into t#st_ist_settle_his_more_count select count(*) from ' ||
           in_que || ' where ' || v_time || ' >=to_date(' || '''' ||
           v_c_begin || ''',''yyyy-mm-dd hh24:mi:ss'')';
  execute immediate v_sql;

  select cnt into v_count from t#st_ist_settle_his_more_count;
  delete from t#st_ist_settle_his_more_count;

  if (v_max_time is null) then
    v_max_time := sysdate;
  end if;

  v_new_end := to_date(to_char(v_max_time, 'yyyy-mm-dd') || ' 23:59:59',
                       'yyyy-mm-dd hh24:mi:ss');
  update st_idx_trx_history
     set recd_count = recd_count + v_count
   where table_name = v_max_table;
  update st_idx_trx_history
     set end_date = v_new_end
   where table_name = v_max_table
     and end_date < v_new_end;

  commit;
  out_msg       := 'success';
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm;
      out_retresult := sqlcode;
      return;
    end;
  
END;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_HIS_MORE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_HIS_MV
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_ST_IST_SETTLE_HIS_MV(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                    out_msg       OUT VARCHAR2, --∑µªÿ–≈œ¢ 
                                                    in_que        in varchar2) -- ‰»Îµƒ∂”¡–±Ì√˚
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_HIS_MORE
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫µ•≥Ã∆±∑¢ €°¢«Æ∞¸Ωª“◊°¢Ω¯’æ°¢∏¸–¬ ˝æ›µπ¿˙ ∑±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131020
  --–ﬁ∏ƒ£∫
  -------------------------------------------------------------------------------
 AS

  v_msg          VARCHAR2(50);
  v_sql          varchar2(5000);
  v_new_end      date; --–¬µƒΩ· ¯ ±º‰ 
  v_min_time     date; --buf±Ì÷–µƒ◊Ó–°Ωª“◊ ±º‰ 
  v_max_time     date; --buf±Ì÷–µƒ◊Ó¥ÛΩª“◊ ±º‰ 
  v_min_table    VARCHAR2(30); --◊Ó–°Ωª“◊ ±º‰∂‘”¶µƒ◊Ó–°µƒ¿˙ ∑±Ì√˚ 
  v_max_table    VARCHAR2(30); --◊Ó¥Ûµƒ¿˙ ∑±Ì 
  v_count        number(18);
  v_deal_type    char(2); --Ωª“◊¿‡–Õ  50, 53, 54,56 
  v_time         VARCHAR2(20);
  v_ss           VARCHAR2(2000);
  v_tmp1         VARCHAR2(256);
  v_c_begin      VARCHAR2(20); --µ±«∞±Ì∂‘”¶µƒø™ º ±º‰ 
  v_cost_seconds number;
  begin_time     date; --«®“∆ø™ º ±º‰
  keep_days      int; --¿˙ ∑±Ì ˝æ›±£¥ÊÃÏ ˝
BEGIN
  begin_time := sysdate;

  if in_que = 'st_his_deal' or in_que = 'oct_deal' then
    v_time := 'deal_datetime';
  end if;

  if in_que = 'st_his_entry' or in_que = 'oct_entry' then
    v_time := 'entry_datetime';
  end if;
  if in_que = 'st_his_sale_sjt' or in_que = 'oct_singl_sale' then
    v_time := 'sale_datetime';
  end if;
  if in_que = 'st_his_update' or in_que = 'oct_update' then
    v_time := 'update_datetime';
  end if;

  --»°Ωª“◊ ˝æ›÷–◊Ó–°µƒΩª“◊ ±º‰
  v_tmp1 := 'insert into t#st_ist_settle_his_more_min select min(' ||
            v_time || ') from ' || in_que;
  execute immediate v_tmp1;

  select min_time into v_min_time from t#st_ist_settle_his_more_min;

  --»°Ωª“◊ ˝æ›÷–◊Ó¥ÛµƒΩª“◊ ±º‰
  v_tmp1 := 'insert into t#st_ist_settle_his_more_max select max(' ||
            v_time || ') from ' || in_que;
  execute immediate v_tmp1;

  select max_time into v_max_time from t#st_ist_settle_his_more_max;

  --«Æ∞¸Ωª“◊st_buf_deal 
  if (in_que = 'st_his_deal' or in_que = 'oct_deal') then
    v_deal_type := '54';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_deal_%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := '«Æ∞¸Ωª“◊¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
    --»°◊Ó–°µƒΩª“◊»’∆⁄À˘‘⁄µƒ¿˙ ∑±Ì◊˜Œ™±æ¥Œ“™≤Â»Îµƒ◊Ó–°µƒ¿˙ ∑±Ì
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '54'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
  
    --»°◊Ó¥Ûµƒ¿˙ ∑±Ì
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '54';
  
    v_ss := 'WATER_NO,LINE_ID ,STATION_ID,DEV_TYPE_ID,DEVICE_ID ,SAM_LOGICAL_ID ,SAM_TRADE_SEQ ,DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID 
       ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ ,CARD_CONSUME_SEQ ,PAY_MODE_ID ,RECEIPT_ID,TAC,ENTRY_LINE_ID ,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,DEAL_NO_DISCOUNT_FEE 
       ,UNION_YEAR_MONTH  ,UNION_BUS_NUM ,UNION_METRO_NUM,UNION_TOTAL_NUM ,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,liMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG ,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG';
  end if;

  --Ω¯’æΩª“◊ st_buf_entry 
  if in_que = 'st_his_entry' or in_que = 'oct_entry' then
    v_deal_type := '53';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_entry_%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := 'Ω¯’æΩª“◊¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '53'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '53';
    v_ss := 'WATER_NO,LINE_ID ,STATION_ID,DEV_TYPE_ID ,DEVICE_ID ,SAM_LOGICAL_ID,SAM_TRADE_SEQ ,CARD_MAIN_ID,CARD_SUB_ID ,CARD_LOGICAL_ID 
       ,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE ,UNION_YEAR_MONTH,UNION_TOTAL_NUM ,UNION_BUS_NUM ,UNION_METRO_NUM 
       ,CARD_CHARGE_SEQ ,CARD_CONSUME_SEQ,TAC ,PAY_MODE_ID ,LAST_SAM_LOGICAL_ID
       ,LAST_DATETIME ,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_LIMIT_FEE,CARD_PHYSICAL_TYPE,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME ,LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG ,FILE_NAME ,CHECK_FLAG';
  end if;

  --µ•≥Ã∆±∑¢ € st_buf_sale_sjt 
  if in_que = 'st_his_sale_sjt' or in_que = 'oct_singl_sale' then
    v_deal_type := '50';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_sale_sjt%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := 'µ•≥Ã∆±∑¢ €¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
  
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '50'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
  
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '50';
  
    v_ss := 'WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE,CARD_LOGICAL_ID_PAY,CARD_TRADE_SEQ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,SALE_FEE,CARD_MAIN_ID,CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_STATUS_ID,AUXI_FEE,CARD_COUNT_USED,CARD_APP_FLAG';
  end if;

  --∏¸–¬Ωª“◊st_buf update
  if in_que = 'st_his_update' or in_que = 'oct_update' then
    v_deal_type := '56';
    select count(*)
      into v_count
      from user_indexes
     WHERE table_name like 'st_his_update_%'
       and table_name not in (select table_name from st_idx_trx_history);
    if v_count > 0 then
      ROLLBACK;
      out_msg       := '∏¸–¬Ωª“◊¿˙ ∑±Ì”ÎÀ˜“˝±Ì÷–µƒº«¬º≤ª∑˚,«Î ÷π§…æ≥˝∂‡”‡µƒ¿˙ ∑±Ì';
      out_retresult := sqlcode;
      return;
    end if;
  
    select table_name
      into v_min_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '56'
       and begin_date <= v_min_time
       and end_date >= v_min_time;
  
    select max(table_name)
      into v_max_table
      from st_idx_trx_history
     where data_type = 'trx'
       and recd_type = '56';
  
    v_ss := 'WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,
       sAM_TRADE_SEQ,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
       CARD_CONSUME_SEQ,CARD_STATUS_ID,UPDATE_AREA,UPDATE_REASON_ID,
       UPDATE_DATETIME,PAY_TYPE,PENALTY_FEE,RECEIPT_ID,OPERATOR_ID,ENTRY_LINE_ID,
       ENTRY_STATION_ID,SHIFT_ID,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM
       ,UNION_TOTAL_NUM,BALANCE_FEE,DEAL_NO_DISCOUNT_FEE,CARD_CHARGE_SEQ,
       TAC,PAY_MODE_ID,ENTRY_SAM_LOGICAL_ID,ENTRY_TIME,LAST_SAM_LOGICAL_ID,
      LAST_DATETIME,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_LIMIT_FEE,
        CARD_PHYSICAL_TYPE,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,
        CARD_APP_FLAG,LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,
        BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG';
  end if;

  --≈–∂œ «∑Ò“—æ≠Ω¯––«ÂÀ„ 
  --20130228 luojun µº¿˙ ∑±Ì“∆÷¡√ø¥Œ¥¶¿Ì“ª≈˙œﬂ¬∑Œƒº˛∫Û√Ê,≤ª≈–∂œ «∑Ò“—æ≠Ω¯––«ÂÀ„ 
  /** 
  select v_sql = ' insert into #tmp_count select count(*) from ' || v_max_table || ' where balance_water_no = ' || ''' || v_center_balance_no ||''' 
  exec(v_sql) 
  select v_cc = cnt from #tmp_count 
  delete from #tmp_count 
  if v_cc > 0 
     begin 
       rollback tran 
       select v_return_num = -100 
       select v_memo ='“—æ≠Ω¯––π˝µ±»’«ÂÀ„ ' 
       insert balance_log  values(v_center_balance_no,'up_balance_his_more','1',v_memo,v_oper_no,    getdate()) 
       return 
     end 
  **/
  --∂®“Â»°≥ˆÀ˘”––Ë“™µº»Î ˝æ›µƒHis±Ìµƒ”Œ±Í
  --(◊Ó¥Ûµƒ¿˙ ∑±Ì–Ë“™Ãÿ ‚¥¶¿Ì,∏¸∏ƒst_idx_trx_history±Ì÷–∂‘”¶µƒΩ· ¯ ±º‰) 
  declare
    cursor cu_table is
      select table_name,
             to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss') begin_date,
             to_char(end_date, 'yyyy-mm-dd hh24:mi:ss') end_date
        from st_idx_trx_history
       where data_type = 'trx'
         and recd_type = v_deal_type
         and table_name >= v_min_table
         and table_name <> v_max_table;
  begin
    for my_cur in cu_table loop
      v_tmp1 := 'lock table ' || my_cur.table_name ||
                ' in  exclusive mode nowait';
      execute immediate v_tmp1;
      --∞— ˝æ›∞¥Ωª“◊ ±º‰≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
      v_sql := 'insert into ' || my_cur.table_name || ' select ' || v_ss ||
               ' from ' || in_que || ' where ' || v_time || ' <= to_date(' || '''' ||
               my_cur.end_date || ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
               v_time || ' >= to_date(' || '''' || my_cur.begin_date ||
               ''',''yyyy-mm-dd hh24:mi:ss'')';
      execute immediate v_sql;
      delete t#st_ist_settle_his_more_col;
    
      --∏¸–¬st_idx_trx_history±Ì–≈œ¢ 
      v_sql := 'insert into t#st_ist_settle_his_more_count select count(*) from ' ||
               in_que || ' where ' || v_time || ' <= to_date(' || '''' ||
               my_cur.end_date || ''',''yyyy-mm-dd hh24:mi:ss'') and ' ||
               v_time || ' >= to_date(' || '''' || my_cur.begin_date ||
               ''',''yyyy-mm-dd hh24:mi:ss'')';
      execute immediate v_sql;
    
      select cnt into v_count from t#st_ist_settle_his_more_count;
      delete t#st_ist_settle_his_more_count;
      update st_idx_trx_history
         set recd_count = recd_count + v_count
       where table_name = my_cur.table_name;
    end loop;
  end;

  --∂‘◊Ó¥Ûµƒ¿˙ ∑±Ìµº»Î ˝æ› 
  v_tmp1 := 'lock table ' || v_max_table || ' in exclusive mode';
  execute immediate v_tmp1;

  select to_char(begin_date, 'yyyy-mm-dd hh24:mi:ss')
    into v_c_begin
    from st_idx_trx_history
   where table_name = v_max_table;

  v_sql := ' insert into ' || v_max_table || ' select ' || v_ss || ' from ' ||
           in_que || ' where  ' || v_time || ' >=to_date(' || '''' ||
           v_c_begin || ''',''yyyy-mm-dd hh24:mi:ss'')';

  execute immediate v_sql;

  --∏¸–¬st_idx_trx_history±Ì–≈œ¢ 
  v_sql := 'insert into t#st_ist_settle_his_more_count select count(*) from ' ||
           in_que || ' where ' || v_time || ' >=to_date(' || '''' ||
           v_c_begin || ''',''yyyy-mm-dd hh24:mi:ss'')';
  execute immediate v_sql;

  select cnt into v_count from t#st_ist_settle_his_more_count;
  v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
  up_st_ist_settle_log_add(in_que,
                           v_max_table,
                           '0000000000',
                           begin_time,
                           sysdate,
                           v_cost_seconds,
                           v_count,
                           out_msg,
                           v_sql);

  delete from t#st_ist_settle_his_more_count;

  if (v_max_time is null) then
    v_max_time := sysdate;
  end if;

  v_new_end := to_date(to_char(v_max_time, 'yyyy-mm-dd') || ' 23:59:59',
                       'yyyy-mm-dd hh24:mi:ss');

  update st_idx_trx_history
     set recd_count = recd_count + v_count
   where table_name = v_max_table;
  update st_idx_trx_history
     set end_date = v_new_end
   where table_name = v_max_table
     and end_date < v_new_end;

  ---------…æ≥˝¿˙ ∑ ˝æ›ø™ º--------------------------------------------
  begin_time := sysdate;
  --≤È—Ø±£¥ÊÃÏ ˝
  select to_number(t.cfg_value)
    into keep_days
    from st_cfg_sys_base t
   where t.cfg_key = 'sys.settle.his.keydays';

  --≤È—Ø“™…æ≥˝µƒ◊‹º«¬º ˝
  v_sql := 'select count(*) table ' || in_que || ' where ' || v_time || ' <' ||
           sysdate - keep_days;
  execute immediate v_sql
    into v_count;

  --…æ≥˝≤Ÿ◊˜
  v_sql := 'drop table ' || in_que || ' where ' || v_time || ' <''' ||
           sysdate - keep_days || '''';
  execute immediate v_sql;
  --º«¬º»’÷æ
  out_msg        := '¥”' || in_que || '…æ≥˝' || v_count || 'Ãı ˝æ›';
  v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
  up_st_ist_settle_log_add(in_que,
                           '0',
                           '0000000000',
                           begin_time,
                           sysdate,
                           v_cost_seconds,
                           v_count,
                           out_msg,
                           v_sql);
  ---------…æ≥˝¿˙ ∑ ˝æ›Ω· ¯--------------------------------------------
  commit;
  out_msg       := 'success';
  out_retresult := 0;

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retresult := sqlcode;
      return;
    end;
  
END UP_ST_IST_SETTLE_HIS_MV;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_HIS_MV to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_INCOME
prompt ==========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_income(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_income
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫ ’“Êª„◊‹Õ≥º∆
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
         --ver1.02 ≥µ’æ ’»Îst_sts_inc_station‘ˆº”ø€÷µ£¨∑«œ÷Ω∏¸–¬ 2014-6-22
         --ver1.03  ∑«œ÷Ω∏¸–¬º”…œupdate±Ì∑£ΩŒ™0µƒ 2014-7-16
         --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
------------------------------------------------------------------------------
as
   v_squad varchar(4);
   v_msg varchar(300);
   v_count int;

begin
    select cfg_value into v_squad  from st_cfg_sys_base where cfg_key='sys.squadday'  and record_flag='0';
   select count(*)  into v_count  from st_sts_inc_sale where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_sale“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count  from st_sts_inc_fare  where balance_water_no = in_balance_water_no ;
   if v_count > 0  then
      out_msg := 'st_sts_inc_fare“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_update where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_update“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_return where balance_water_no = in_balance_water_no ;
   if v_count > 0  then
      out_msg := 'st_sts_inc_return“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_consume where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_consume“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_charge  where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_charge“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_station  where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_station_income“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_balance_expired where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_balance_expired“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_rpt∑¢ €';
   insert into t#st_ist_settle_income_rpt
   select balance_water_no,line_id,station_id,
      case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
      else to_char(sale_datetime - 1, 'yyyymmdd') end,
      dev_type_id,'01',card_main_id,card_sub_id,0,count(*),sum(deposit_fee),0
   from st_que_sale
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id,
   case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
   else to_char(sale_datetime - 1, 'yyyymmdd')  end, dev_type_id, card_main_id, card_sub_id ;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_rptµ•≥Ã∆± €∆±';
   insert into t#st_ist_settle_income_rpt
   select balance_water_no,line_id,station_id,
      case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
      else to_char(sale_datetime - 1, 'yyyymmdd') end,
      dev_type_id,pay_type,card_main_id,card_sub_id,sale_fee,count(*),sum(deposit_fee),sum(sale_fee)
   from st_que_sale_sjt
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id, case
   when to_char(sale_datetime, 'hh24mi') >= v_squad  then to_char(sale_datetime, 'yyyymmdd')
   else to_char(sale_datetime - 1, 'yyyymmdd') end,dev_type_id, pay_type, card_main_id, card_sub_id,sale_fee ;
    ----------…˙≥…≥µ∆±∑¢ €Õ≥º∆±Ìst_sts_inc_sale
   v_msg := '≤Â»Î±Ìst_sts_inc_sale';
   insert into st_sts_inc_sale
   select seq_st_sts_inc_sale.nextval,balance_water_no,squad_day,line_id,station_id,
      dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,deal_fee
   from (
      select balance_water_no,squad_day,line_id,station_id,dev_type_id,pay_type,card_main_id,
         card_sub_id,sum(sale_num) sale_num,sum(deposit_fee) deposit_fee,sum(deal_fee) deal_fee
      from t#st_ist_settle_income_rpt
      group by balance_water_no, line_id, station_id,squad_day,dev_type_id,pay_type,card_main_id,card_sub_id );
   ------------…˙≥…tvm∑¢ €µ•≥Ã∆± ˝¡øÕ≥º∆±Ìst_sts_inc_fare
   v_msg := '≤Â»Î±Ìst_sts_inc_fare';
   insert into st_sts_inc_fare
   select seq_st_sts_inc_fare.nextval,balance_water_no,squad_day,line_id,station_id,dev_type_id,
      pay_type,card_main_id,card_sub_id,sale_fee,sale_num,deposit_fee,deal_fee
   from (
      select balance_water_no,squad_day,line_id,station_id,dev_type_id,pay_type,
         card_main_id,card_sub_id,sale_fee,sum(sale_num) sale_num,sum(deposit_fee) deposit_fee,
         sum(deal_fee) deal_fee
      from t#st_ist_settle_income_rpt where dev_type_id='02'
      group by balance_water_no, line_id, station_id, squad_day, dev_type_id,
      pay_type, card_main_id, card_sub_id,sale_fee );
    -------------…˙≥…≥µ∆±∏¸–¬Õ≥º∆±Ì st_sts_inc_update
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_updateœ÷Ω∏¸–¬or¡„÷µ∑«œ÷Ω'; 
   insert into t#st_ist_settle_income_update
   select balance_water_no,line_id,station_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad  then
      to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
      pay_type,card_main_id,card_sub_id,count(*),sum(penalty_fee)
   from st_que_update  
   where balance_water_no = in_balance_water_no 
         and (pay_type='01' or (pay_type='02' and penalty_fee=0)) --2014-7-21‘ˆº”∑«œ÷Ω∏¸–¬¥”update»°¡„÷µµƒ ver1.03
   group by balance_water_no, line_id, station_id, pay_type, card_main_id,
   card_sub_id, case when to_char(update_datetime, 'hh24mi') >= v_squad
   then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end;
    
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_update∑«œ÷Ω∏¸–¬'; --2014-6-22‘ˆº”∑«œ÷Ω∏¸–¬¥”deal»° ver1.02
   insert into t#st_ist_settle_income_update
   select balance_water_no,line_id,station_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad  then
      to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd') end,
      '02',card_main_id,card_sub_id,count(*),sum(deal_fee)
   from st_que_deal
   where balance_water_no = in_balance_water_no and pay_mode_id in ('1A','4A')
   group by balance_water_no, line_id, station_id, card_main_id,card_sub_id, 
         case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd') 
         else to_char(deal_datetime - 1, 'yyyymmdd') end;

   v_msg := '≤Â»Î±Ìst_sts_inc_update';
   insert   into st_sts_inc_update
   select seq_st_sts_inc_update.nextval,balance_water_no,line_id,station_id,
      squad_day,pay_type,card_main_id,card_sub_id,update_num,penalty_fee
   from t#st_ist_settle_income_update  ;

   ----------------…˙≥…≥µ∆±ÕÀøÓÕ≥º∆±Ìst_sts_inc_return
   --  1°¢’˝≥£ÕÀø®     £∫ÕÀ—∫Ω
   --  2°¢bom∑«’˝≥£ÕÀø®£∫ø®√Êªµ≤ªÕÀ—∫Ω
   -------------------
   --1°¢Õ≥º∆’˝≥£ÕÀø®
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_return';
   insert into t#st_ist_settle_income_return
   select balance_water_no,line_id,station_id,return_type,card_main_id,card_sub_id,
      case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
      else to_char(return_datetime - 1, 'yyyymmdd') end,count(*),
      sum(return_deposit_fee), 0,sum(return_balance_fee),sum(penalty_fee)
   from st_que_return
   where balance_water_no = in_balance_water_no
   and (return_deposit_fee <> 0 or card_main_id in ('01','03'))
   group by balance_water_no, line_id, station_id, return_type, card_main_id,
   card_sub_id, case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
   else to_char(return_datetime - 1, 'yyyymmdd') end;
   --2°¢Õ≥º∆ªµø®
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_return';
   insert into t#st_ist_settle_income_return
   select balance_water_no,line_id,station_id,return_type,card_main_id,card_sub_id,
      case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
      else to_char(return_datetime - 1, 'yyyymmdd') end,count(*),0,count(*),sum(return_balance_fee),sum(penalty_fee)
   from st_que_return
   where balance_water_no = in_balance_water_no
   and card_main_id not in ('01','03') and return_deposit_fee = 0 --∑«≥À¥Œ∆±°¢µ•≥Ã∆±≤¢«“√ª”–ÕÀ—∫ΩÀ„ªµø®
   group by balance_water_no, line_id, station_id, return_type, card_main_id,
   card_sub_id, case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
   else to_char(return_datetime - 1, 'yyyymmdd') end;
   v_msg := '≤Â»Î±Ìst_sts_inc_return';
   insert into st_sts_inc_return(water_no,balance_water_no,line_id,station_id,return_type,card_main_id,
      card_sub_id,squad_day,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
   select seq_st_sts_inc_return.nextval,balance_water_no,line_id,station_id,return_type,card_main_id,
   card_sub_id,squad_day,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
    from (select balance_water_no,line_id,station_id,return_type,card_main_id,card_sub_id,
      squad_day,sum(return_num) return_num,sum(return_deposit_fee) return_deposit_fee,
      sum(bad_num) bad_num,sum(return_balance_fee) return_balance_fee,sum(penalty_fee) penalty_fee
   from t#st_ist_settle_income_return
   group by balance_water_no, line_id, station_id, return_type, card_main_id,
   card_sub_id, squad_day) ;
  ------------…˙≥…≥À≥µø€øÓÕ≥º∆±Ì(øÕ‘À ’»ÎÕ≥º∆±Ì)st_sts_inc_consume°¢≥‰÷µÕ≥º∆±Ìst_sts_inc_charge
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_dealø€∑—°¢≥‰÷µ';
   insert into t#st_ist_settle_income_deal --2014-6-22ø€∑—º”…œ1A/4A ver1.02
   (  balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,squad_day,
      pay_mode_id,deal_num,deal_fee,deal_no_discount_fee)
   select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
      else to_char(deal_datetime - 1, 'yyyymmdd') end, pay_mode_id,  --ø€∑—°¢≥‰÷µ
      count(*),sum(nvl(deal_fee,0)),sum(nvl(deal_no_discount_fee,0))
   from st_que_deal a
   where balance_water_no = in_balance_water_no
   and ((pay_mode_id in ( select pay_mode_id from op_prm_paymode_type_valid
   where record_flag = '0')  ) or pay_mode_id in ('14','1A','4A'))
   group by balance_water_no, line_id, station_id, dev_type_id,card_main_id,card_sub_id,
   case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
   else to_char(deal_datetime - 1, 'yyyymmdd') end,pay_mode_id;
 
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_deal∑«œ÷Ω∏¸–¬¡„÷µ';
   insert into t#st_ist_settle_income_deal --2014-7-21ø€∑—º”…œ∑«œ÷Ω∏¸–¬¡„÷µ ver1.03
   (  balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,squad_day,
      pay_mode_id,deal_num,deal_fee,deal_no_discount_fee)
   select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad then to_char(update_datetime, 'yyyymmdd')
      else to_char(update_datetime - 1, 'yyyymmdd') end, '1A',count(*),0,0
   from st_que_update a
   where balance_water_no = in_balance_water_no and pay_type='02' and penalty_fee=0
   group by balance_water_no, line_id, station_id, dev_type_id,card_main_id,card_sub_id,
   case when to_char(update_datetime, 'hh24mi') >= v_squad then to_char(update_datetime, 'yyyymmdd')
      else to_char(update_datetime - 1, 'yyyymmdd') end;

  
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_deal≥Â’˝';
   insert into t#st_ist_settle_income_deal
   (  balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      squad_day,pay_mode_id,deal_num,deal_fee,deal_no_discount_fee)
   select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
      else to_char(deal_datetime - 1, 'yyyymmdd') end, pay_mode_id,  --≥Â’˝
      count(*)*-1,sum(nvl(deal_fee,0))*-1,sum(nvl(deal_no_discount_fee,0))*-1
   from st_que_deal  
   where balance_water_no = in_balance_water_no  and pay_mode_id in ('18', '98')
   group by balance_water_no, line_id, station_id, dev_type_id,card_main_id,card_sub_id,
   case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
   else  to_char(deal_datetime - 1, 'yyyymmdd') end,pay_mode_id;

   v_msg := '≤Â»Î±Ìst_sts_inc_consume';
   insert into st_sts_inc_consume
   select seq_st_sts_inc_consume.nextval,balance_water_no,line_id,station_id,
      card_main_id,card_sub_id,squad_day,deal_num,deal_fee,deal_no_discount_fee
   from ( select balance_water_no,line_id,station_id,card_main_id,card_sub_id,squad_day,
      sum(deal_num) as deal_num,sum(deal_fee) as deal_fee,sum(deal_no_discount_fee) as deal_no_discount_fee
   from t#st_ist_settle_income_deal
   where  balance_water_no = in_balance_water_no 
   and pay_mode_id in ( select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0') 
       or pay_mode_id in £®'1A','4A'£©--2014-6-22ø€∑—º”…œ1A/4A ver1.02
   group by balance_water_no,squad_day,line_id,station_id,card_main_id,card_sub_id);
   
   v_msg := '≤Â»Î±Ìst_sts_inc_charge';
   insert into st_sts_inc_charge
   select seq_st_sts_inc_charge.nextval,balance_water_no,line_id,station_id,dev_type_id,card_main_id,
      card_sub_id,squad_day,deal_num,deal_fee
   from ( select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
        squad_day,sum(deal_num) as deal_num,sum(deal_fee) as deal_fee
   from t#st_ist_settle_income_deal
   where  balance_water_no = in_balance_water_no and pay_mode_id  in ('14', '18')
   group by balance_water_no,squad_day,line_id,station_id,dev_type_id,card_main_id, card_sub_id);
 
   -----…˙≥…st_sts_inc_station(”√”⁄≥µ’æ°¢bom ’“Êª„◊‹°¢œﬂÕ¯≥µ∆±œ˙ €Õ≥º∆ƒÍ±®)
   ---  -∑¢ €
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_get∑¢ €';
   insert into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,
      card_main_id,card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,
      case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
      else to_char(sale_datetime - 1, 'yyyymmdd')  end,'51','','',operator_id,card_main_id,card_sub_id,
      dev_type_id,sum(deposit_fee),0,count(*),shift_id,device_id ,sum(deposit_fee)
   from st_que_sale
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id, case
   when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
   else to_char(sale_datetime - 1, 'yyyymmdd') end,operator_id,card_main_id,card_sub_id,dev_type_id,
    shift_id,device_id ;

   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_getµ•≥Ã∆± €∆±';
   insert into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,
      do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,
      return_bala,deal_num,shift_id,device_id,penalty_fee )
   select balance_water_no,line_id,station_id, case when to_char(sale_datetime, 'hh24mi') >= v_squad then
     to_char(sale_datetime, 'yyyymmdd') else to_char(sale_datetime - 1, 'yyyymmdd')end squad_day,'50',pay_type,''
     ,operator_id,card_main_id,card_sub_id,dev_type_id,sum(sale_fee),0,count(*),shift_id,device_id,sum(deposit_fee)
   from st_que_sale_sjt
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id, case when to_char(sale_datetime, 'hh24mi') >= v_squad
   then to_char(sale_datetime, 'yyyymmdd') else to_char(sale_datetime - 1, 'yyyymmdd')
   end, pay_type, operator_id, card_main_id, card_sub_id, dev_type_id, shift_id, device_id;

   ---≥‰÷µ≥Â’˝°¢∑«œ÷Ω∏¸–¬∑«¡„÷µ
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_get≥‰÷µ≥Â’˝°¢∑«œ÷Ω∏¸–¬∑«¡„÷µ';--2014-7-21∏ƒ v1.03
   insert  into t#st_ist_settle_income_bom_get
   (balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,
   card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id, penalty_fee)
   select balance_water_no,line_id,station_id,case when to_char(deal_datetime, 'hh24mi') >= v_squad
    then  to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd') end,
    '54',pay_mode_id,'',operator_id,card_main_id,card_sub_id,dev_type_id,sum(deal_fee),0,count(*),shift_id,device_id,0
   from st_que_deal 
   where balance_water_no = in_balance_water_no and pay_mode_id in ('14', '18','1A','4A') 
   group by balance_water_no, line_id, station_id, case  when to_char(deal_datetime, 'hh24mi') >= v_squad
   then to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd')
   end, pay_mode_id, operator_id, card_main_id, card_sub_id, dev_type_id,shift_id, device_id ;
   ---œ÷Ω∏¸–¬°¢∑«œ÷Ω∏¸–¬¡„÷µ
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_getœ÷Ω∏¸–¬°¢∑«œ÷Ω∏¸–¬¡„÷µ';--2014-7-21∏ƒ v1.03
   insert into t#st_ist_settle_income_bom_get(
   balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,
   card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,case when to_char(update_datetime, 'hh24mi') >= v_squad
   then   to_char(update_datetime, 'yyyymmdd') else   to_char(update_datetime - 1, 'yyyymmdd') end,'56',pay_type,
   update_reason_id,operator_id,card_main_id,card_sub_id,dev_type_id,0,0,count(*),shift_id,device_id,sum(penalty_fee)
   from st_que_update
   where balance_water_no = in_balance_water_no and£®pay_type='01' or (pay_type='02' and penalty_fee=0))
   group by balance_water_no, line_id, station_id, case  when to_char(update_datetime, 'hh24mi') >= v_squad
   then to_char(update_datetime, 'yyyymmdd')  else   to_char(update_datetime - 1, 'yyyymmdd')  end,
   pay_type,update_reason_id,operator_id,card_main_id,card_sub_id,dev_type_id,shift_id,device_id ;
   ----––’˛¥¶¿Ì
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_get––’˛¥¶¿Ì';
   insert  into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,
      card_main_id,card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,case when to_char(admin_datetime, 'hh24mi') >= v_squad
      then to_char(admin_datetime, 'yyyymmdd') else to_char(admin_datetime - 1, 'yyyymmdd')  end,
      '61','',admin_way_id,operator_id,card_main_id,card_sub_id,dev_type_id,0,
      sum(return_fee),count(*),shift_id,device_id,sum(penalty_fee)
   from st_que_admin
   where balance_water_no = in_balance_water_no 
   group by balance_water_no, line_id, station_id, case
   when to_char(admin_datetime, 'hh24mi') >= v_squad   then   to_char(admin_datetime, 'yyyymmdd')
   else  to_char(admin_datetime - 1, 'yyyymmdd')  end, admin_way_id, operator_id,
   card_main_id, card_sub_id, dev_type_id,shift_id, device_id ;
   ------------------ÕÀøÓ
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_getÕÀøÓ';
   insert into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,
      card_main_id,card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,  case when to_char(return_datetime, 'hh24mi') >= v_squad
      then to_char(return_datetime, 'yyyymmdd') else to_char(return_datetime - 1, 'yyyymmdd')   end,
      '57','','',operator_id,card_main_id,card_sub_id,dev_type_id,sum(return_deposit_fee),sum(return_balance_fee),
      count(*),shift_id,device_id,sum(penalty_fee)
   from st_que_return
   where balance_water_no = in_balance_water_no 
   group by balance_water_no, line_id, station_id, case  when to_char(return_datetime, 'hh24mi') >= v_squad
   then to_char(return_datetime, 'yyyymmdd')  else to_char(return_datetime - 1, 'yyyymmdd')  end,
   operator_id, card_main_id, card_sub_id, dev_type_id, shift_id,device_id ;
   
   v_msg := '≤Â»Î±Ìst_sts_inc_station';
   insert into st_sts_inc_station(
      water_no,balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,
      do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,
      deal_num,shift_id,device_id,penalty_fee )
   select seq_st_sts_bom_get.nextval,balance_water_no,line_id,station_id, squad_day,
      tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,
      deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee
   from t#st_ist_settle_income_bom_get;
   ----------‘¬ƒ©: …˙≥…π˝∆⁄∆±”‡∂ÓÕ≥º∆»’±®(st_sts_inc_balance_expired)
   if to_char(sysdate,'yyyymmdd')=to_char(last_day(sysdate),'yyyymmdd') then
      v_msg := '≤Â»Î±Ìst_sts_inc_balance_expired¿˙ ∑';
      insert  into st_sts_inc_balance_expired
       select seq_st_sts_inc_balance_expired.nextval,balance_water_no,card_main_id,card_sub_id,total_num
           ,total_bal_fee,total_deposit_fee,squad_day from
              (select in_balance_water_no balance_water_no,a.card_main_id,a.card_sub_id,count(*) total_num,
            sum(nvl(a.system_balance_fee, 0)) total_bal_fee,sum(nvl(b.deposit_fee, 0)) total_deposit_fee,
            to_char(sysdate,'yyyymmdd'£©squad_day   from st_act_svt a,acc_st_his.st_his_sale b
            where a.card_logical_id = b.card_logical_id and   a.card_main_id = b.card_main_id
                  and a.card_sub_id = b.card_sub_id and a.new_expire_datetime <sysdate
           group by a.card_main_id, a.card_sub_id,to_char(sysdate,'yyyymmdd'));
       v_msg := '≤Â»Î±Ìst_sts_inc_balance_expiredµ±«∞';
      insert  into st_sts_inc_balance_expired
        select seq_st_sts_inc_balance_expired.nextval ,balance_water_no,card_main_id,card_sub_id,total_num
           ,total_bal_fee,total_deposit_fee,squad_day from
              (select in_balance_water_no balance_water_no,a.card_main_id,a.card_sub_id,count(*) total_num,
               sum(nvl(a.system_balance_fee, 0)) total_bal_fee,sum(nvl(b.deposit_fee, 0)) total_deposit_fee,
                 to_char(sysdate,'yyyymmdd'£©squad_day from st_act_svt a, st_que_sale b
                  where b.balance_water_no = in_balance_water_no 
                  and a.card_logical_id = b.card_logical_id and a.card_main_id = b.card_main_id
                  and a.card_sub_id = b.card_sub_id and a.new_expire_datetime < sysdate
                  group by a.card_main_id, a.card_sub_id,to_char(sysdate,'yyyymmdd'));
   end if;
   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg := v_msg||'¥ÌŒÛ£∫'||sqlerrm;
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_INCOME to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_INCOME1
prompt ===========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_income1(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_income
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫ ’“Êª„◊‹Õ≥º∆
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
         --ver1.02 ≥µ’æ ’»Îst_sts_inc_station‘ˆº”ø€÷µ£¨∑«œ÷Ω∏¸–¬ 2014-6-22
         --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
------------------------------------------------------------------------------
as
   v_squad varchar(4);
   v_msg varchar(100);
   v_count int;

begin
    select cfg_value into v_squad  from st_cfg_sys_base where cfg_key='sys.squadday'  and record_flag='0';
   select count(*) into v_count from st_sts_inc_update where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_update“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_consume where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_consume“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_charge  where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_charge“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   select count(*) into v_count from st_sts_inc_station  where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_station_income“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
/*   select count(*) into v_count from st_sts_inc_balance_expired where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_balance_expired“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_rpt∑¢ €';
   insert into t#st_ist_settle_income_rpt
   select balance_water_no,line_id,station_id,
      case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
      else to_char(sale_datetime - 1, 'yyyymmdd') end,
      dev_type_id,'01',card_main_id,card_sub_id,0,count(*),sum(deposit_fee),0
   from st_his_sale
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id,
   case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
   else to_char(sale_datetime - 1, 'yyyymmdd')  end, dev_type_id, card_main_id, card_sub_id ;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_rptµ•≥Ã∆± €∆±';
   insert into t#st_ist_settle_income_rpt
   select balance_water_no,line_id,station_id,
      case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
      else to_char(sale_datetime - 1, 'yyyymmdd') end,
      dev_type_id,pay_type,card_main_id,card_sub_id,sale_fee,count(*),sum(deposit_fee),sum(sale_fee)
   from st_his_sale_sjt
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id, case
   when to_char(sale_datetime, 'hh24mi') >= v_squad  then to_char(sale_datetime, 'yyyymmdd')
   else to_char(sale_datetime - 1, 'yyyymmdd') end,dev_type_id, pay_type, card_main_id, card_sub_id,sale_fee ;
    ----------…˙≥…≥µ∆±∑¢ €Õ≥º∆±Ìst_sts_inc_sale
   v_msg := '≤Â»Î±Ìst_sts_inc_sale';
   insert into st_sts_inc_sale
   select seq_st_sts_inc_sale.nextval,balance_water_no,squad_day,line_id,station_id,
      dev_type_id,pay_type,card_main_id,card_sub_id,sale_num,deposit_fee,deal_fee
   from (
      select balance_water_no,squad_day,line_id,station_id,dev_type_id,pay_type,card_main_id,
         card_sub_id,sum(sale_num) sale_num,sum(deposit_fee) deposit_fee,sum(deal_fee) deal_fee
      from t#st_ist_settle_income_rpt
      group by balance_water_no, line_id, station_id,squad_day,dev_type_id,pay_type,card_main_id,card_sub_id );
   ------------…˙≥…tvm∑¢ €µ•≥Ã∆± ˝¡øÕ≥º∆±Ìst_sts_inc_fare
   v_msg := '≤Â»Î±Ìst_sts_inc_fare';
   insert into st_sts_inc_fare
   select seq_st_sts_inc_fare.nextval,balance_water_no,squad_day,line_id,station_id,dev_type_id,
      pay_type,card_main_id,card_sub_id,sale_fee,sale_num,deposit_fee,deal_fee
   from (
      select balance_water_no,squad_day,line_id,station_id,dev_type_id,pay_type,
         card_main_id,card_sub_id,sale_fee,sum(sale_num) sale_num,sum(deposit_fee) deposit_fee,
         sum(deal_fee) deal_fee
      from t#st_ist_settle_income_rpt where dev_type_id='02'
      group by balance_water_no, line_id, station_id, squad_day, dev_type_id,
      pay_type, card_main_id, card_sub_id,sale_fee );
*/    -------------…˙≥…≥µ∆±∏¸–¬Õ≥º∆±Ì st_sts_inc_update
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_updateœ÷Ω∏¸–¬or¡„÷µ∑«œ÷Ω'; 
   insert into t#st_ist_settle_income_update
   select balance_water_no,line_id,station_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad  then
      to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end,
      pay_type,card_main_id,card_sub_id,count(*),sum(penalty_fee)
   from acc_st_his.st_his_update  
   where balance_water_no = in_balance_water_no 
         and (pay_type='01' or (pay_type='02' and penalty_fee=0)) --2014-7-21‘ˆº”∑«œ÷Ω∏¸–¬¥”update»°¡„÷µµƒ ver1.03
   group by balance_water_no, line_id, station_id, pay_type, card_main_id,
   card_sub_id, case when to_char(update_datetime, 'hh24mi') >= v_squad
   then to_char(update_datetime, 'yyyymmdd') else to_char(update_datetime - 1, 'yyyymmdd') end;
    
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_update∑«œ÷Ω∏¸–¬'; --2014-6-22‘ˆº”∑«œ÷Ω∏¸–¬¥”deal»° ver1.02
   insert into t#st_ist_settle_income_update
   select balance_water_no,line_id,station_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad  then
      to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd') end,
      '02',card_main_id,card_sub_id,count(*),sum(deal_fee)
   from acc_st_his.st_his_deal
   where balance_water_no = in_balance_water_no and pay_mode_id in ('1A','4A')
   group by balance_water_no, line_id, station_id, card_main_id,card_sub_id, 
         case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd') 
         else to_char(deal_datetime - 1, 'yyyymmdd') end;

   v_msg := '≤Â»Î±Ìst_sts_inc_update';
   insert   into st_sts_inc_update
   select seq_st_sts_inc_update.nextval,balance_water_no,line_id,station_id,
      squad_day,pay_type,card_main_id,card_sub_id,update_num,penalty_fee
   from t#st_ist_settle_income_update  ;

/*   ----------------…˙≥…≥µ∆±ÕÀøÓÕ≥º∆±Ìst_sts_inc_return
   --  1°¢’˝≥£ÕÀø®     £∫ÕÀ—∫Ω
   --  2°¢bom∑«’˝≥£ÕÀø®£∫ø®√Êªµ≤ªÕÀ—∫Ω
   -------------------
   --1°¢Õ≥º∆’˝≥£ÕÀø®
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_return';
   insert into t#st_ist_settle_income_return
   select balance_water_no,line_id,station_id,return_type,card_main_id,card_sub_id,
      case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
      else to_char(return_datetime - 1, 'yyyymmdd') end,count(*),
      sum(return_deposit_fee), 0,sum(return_balance_fee),sum(penalty_fee)
   from st_his_return
   where balance_water_no = in_balance_water_no
   and (return_deposit_fee <> 0 or card_main_id in ('01','03'))
   group by balance_water_no, line_id, station_id, return_type, card_main_id,
   card_sub_id, case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
   else to_char(return_datetime - 1, 'yyyymmdd') end;
   --2°¢Õ≥º∆ªµø®
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_return';
   insert into t#st_ist_settle_income_return
   select balance_water_no,line_id,station_id,return_type,card_main_id,card_sub_id,
      case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
      else to_char(return_datetime - 1, 'yyyymmdd') end,count(*),0,count(*),sum(return_balance_fee),sum(penalty_fee)
   from st_his_return
   where balance_water_no = in_balance_water_no
   and card_main_id not in ('01','03') and return_deposit_fee = 0 --∑«≥À¥Œ∆±°¢µ•≥Ã∆±≤¢«“√ª”–ÕÀ—∫ΩÀ„ªµø®
   group by balance_water_no, line_id, station_id, return_type, card_main_id,
   card_sub_id, case when to_char(return_datetime, 'hh24mi') >= v_squad then to_char(return_datetime, 'yyyymmdd')
   else to_char(return_datetime - 1, 'yyyymmdd') end;
   v_msg := '≤Â»Î±Ìst_sts_inc_return';
   insert into st_sts_inc_return(water_no,balance_water_no,line_id,station_id,return_type,card_main_id,
      card_sub_id,squad_day,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee)
   select seq_st_sts_inc_return.nextval,balance_water_no,line_id,station_id,return_type,card_main_id,
   card_sub_id,squad_day,return_num,return_deposit_fee,bad_num,return_balance_fee,penalty_fee
    from (select balance_water_no,line_id,station_id,return_type,card_main_id,card_sub_id,
      squad_day,sum(return_num) return_num,sum(return_deposit_fee) return_deposit_fee,
      sum(bad_num) bad_num,sum(return_balance_fee) return_balance_fee,sum(penalty_fee) penalty_fee
   from t#st_ist_settle_income_return
   group by balance_water_no, line_id, station_id, return_type, card_main_id,
   card_sub_id, squad_day) ;
*/  ------------…˙≥…≥À≥µø€øÓÕ≥º∆±Ìst_sts_inc_consume°¢≥‰÷µÕ≥º∆±Ìst_sts_inc_charge
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_dealø€∑—°¢≥‰÷µ';
   insert into t#st_ist_settle_income_deal --2014-6-22ø€∑—º”…œ1A/4A ver1.02
   (  balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,squad_day,
      pay_mode_id,deal_num,deal_fee,deal_no_discount_fee)
   select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
      else to_char(deal_datetime - 1, 'yyyymmdd') end, pay_mode_id,  --ø€∑—°¢≥‰÷µ
      count(*),sum(nvl(deal_fee,0)),sum(nvl(deal_no_discount_fee,0))
   from acc_st_his.st_his_deal a
   where balance_water_no = in_balance_water_no
   and ((pay_mode_id in ( select pay_mode_id from op_prm_paymode_type_valid
   where record_flag = '0')  ) or pay_mode_id in ('14','1A','4A'))
   group by balance_water_no, line_id, station_id, dev_type_id,card_main_id,card_sub_id,
   case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
   else to_char(deal_datetime - 1, 'yyyymmdd') end,pay_mode_id;
 
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_deal∑«œ÷Ω∏¸–¬¡„÷µ';
   insert into t#st_ist_settle_income_deal --2014-7-21ø€∑—º”…œ∑«œ÷Ω∏¸–¬¡„÷µ ver1.03
   (  balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,squad_day,
      pay_mode_id,deal_num,deal_fee,deal_no_discount_fee)
   select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      case when to_char(update_datetime, 'hh24mi') >= v_squad then to_char(update_datetime, 'yyyymmdd')
      else to_char(update_datetime - 1, 'yyyymmdd') end, '1A',count(*),0,0
   from acc_st_his.st_his_update a
   where balance_water_no = in_balance_water_no and pay_type='02' and penalty_fee=0
   group by balance_water_no, line_id, station_id, dev_type_id,card_main_id,card_sub_id,
   case when to_char(update_datetime, 'hh24mi') >= v_squad then to_char(update_datetime, 'yyyymmdd')
      else to_char(update_datetime - 1, 'yyyymmdd') end;

  
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_deal≥Â’˝';
   insert into t#st_ist_settle_income_deal
   (  balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      squad_day,pay_mode_id,deal_num,deal_fee,deal_no_discount_fee)
   select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
      case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
      else to_char(deal_datetime - 1, 'yyyymmdd') end, pay_mode_id,  --≥Â’˝
      count(*)*-1,sum(nvl(deal_fee,0))*-1,sum(nvl(deal_no_discount_fee,0))*-1
   from acc_st_his.st_his_deal  
   where balance_water_no = in_balance_water_no  and pay_mode_id in ('18', '98')
   group by balance_water_no, line_id, station_id, dev_type_id,card_main_id,card_sub_id,
   case when to_char(deal_datetime, 'hh24mi') >= v_squad then to_char(deal_datetime, 'yyyymmdd')
   else  to_char(deal_datetime - 1, 'yyyymmdd') end,pay_mode_id;

   v_msg := '≤Â»Î±Ìst_sts_inc_consume';
   insert into st_sts_inc_consume
   select seq_st_sts_inc_consume.nextval,balance_water_no,line_id,station_id,
      card_main_id,card_sub_id,squad_day,deal_num,deal_fee,deal_no_discount_fee
   from ( select balance_water_no,line_id,station_id,card_main_id,card_sub_id,squad_day,
      sum(deal_num) as deal_num,sum(deal_fee) as deal_fee,sum(deal_no_discount_fee) as deal_no_discount_fee
   from t#st_ist_settle_income_deal
   where  balance_water_no = in_balance_water_no 
   and pay_mode_id in ( select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0') 
       or pay_mode_id in £®'1A','4A'£©--2014-6-22ø€∑—º”…œ1A/4A ver1.02
   group by balance_water_no,squad_day,line_id,station_id,card_main_id,card_sub_id);
   
   v_msg := '≤Â»Î±Ìst_sts_inc_charge';
   insert into st_sts_inc_charge
   select seq_st_sts_inc_charge.nextval,balance_water_no,line_id,station_id,dev_type_id,card_main_id,
      card_sub_id,squad_day,deal_num,deal_fee
   from ( select balance_water_no,line_id,station_id,dev_type_id,card_main_id,card_sub_id,
        squad_day,sum(deal_num) as deal_num,sum(deal_fee) as deal_fee
   from t#st_ist_settle_income_deal
   where  balance_water_no = in_balance_water_no and pay_mode_id  in ('14', '18')
   group by balance_water_no,squad_day,line_id,station_id,dev_type_id,card_main_id, card_sub_id);
 
   -----…˙≥…st_sts_inc_station(”√”⁄≥µ’æ°¢bom ’“Êª„◊‹°¢œﬂÕ¯≥µ∆±œ˙ €Õ≥º∆ƒÍ±®)
   ---  -∑¢ €
  v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_get∑¢ €';
   insert into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,
      card_main_id,card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,
      case when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
      else to_char(sale_datetime - 1, 'yyyymmdd')  end,'51','','',operator_id,card_main_id,card_sub_id,
      dev_type_id,sum(deposit_fee),0,count(*),shift_id,device_id ,sum(deposit_fee)
   from acc_st_his.st_his_sale
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id, case
   when to_char(sale_datetime, 'hh24mi') >= v_squad then to_char(sale_datetime, 'yyyymmdd')
   else to_char(sale_datetime - 1, 'yyyymmdd') end,operator_id,card_main_id,card_sub_id,dev_type_id,
    shift_id,device_id ;

   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_getµ•≥Ã∆± €∆±';
   insert into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,
      do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,
      return_bala,deal_num,shift_id,device_id,penalty_fee )
   select balance_water_no,line_id,station_id, case when to_char(sale_datetime, 'hh24mi') >= v_squad then
     to_char(sale_datetime, 'yyyymmdd') else to_char(sale_datetime - 1, 'yyyymmdd')end squad_day,'50',pay_type,''
     ,operator_id,card_main_id,card_sub_id,dev_type_id,sum(sale_fee),0,count(*),shift_id,device_id,sum(deposit_fee)
   from acc_st_his.st_his_sale_sjt
   where balance_water_no = in_balance_water_no
   group by balance_water_no, line_id, station_id, case when to_char(sale_datetime, 'hh24mi') >= v_squad
   then to_char(sale_datetime, 'yyyymmdd') else to_char(sale_datetime - 1, 'yyyymmdd')
   end, pay_type, operator_id, card_main_id, card_sub_id, dev_type_id, shift_id, device_id;

   ---≥‰÷µ≥Â’˝°¢∑«œ÷Ω∏¸–¬∑«¡„÷µ
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_get≥‰÷µ≥Â’˝°¢∑«œ÷Ω∏¸–¬∑«¡„÷µ';--2014-7-21∏ƒ v1.03
   insert  into t#st_ist_settle_income_bom_get
   (balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,
   card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id, penalty_fee)
   select balance_water_no,line_id,station_id,case when to_char(deal_datetime, 'hh24mi') >= v_squad
    then  to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd') end,
    '54',pay_mode_id,'',operator_id,card_main_id,card_sub_id,dev_type_id,sum(deal_fee),0,count(*),shift_id,device_id,0
   from acc_st_his.st_his_deal 
   where balance_water_no = in_balance_water_no and pay_mode_id in ('14', '18','1A','4A') 
   group by balance_water_no, line_id, station_id, case  when to_char(deal_datetime, 'hh24mi') >= v_squad
   then to_char(deal_datetime, 'yyyymmdd') else to_char(deal_datetime - 1, 'yyyymmdd')
   end, pay_mode_id, operator_id, card_main_id, card_sub_id, dev_type_id,shift_id, device_id ;
   ---œ÷Ω∏¸–¬°¢∑«œ÷Ω∏¸–¬¡„÷µ
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_getœ÷Ω∏¸–¬°¢∑«œ÷Ω∏¸–¬¡„÷µ';--2014-7-21∏ƒ v1.03
   insert into t#st_ist_settle_income_bom_get(
   balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,
   card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,case when to_char(update_datetime, 'hh24mi') >= v_squad
   then   to_char(update_datetime, 'yyyymmdd') else   to_char(update_datetime - 1, 'yyyymmdd') end,'56',pay_type,
   update_reason_id,operator_id,card_main_id,card_sub_id,dev_type_id,0,0,count(*),shift_id,device_id,sum(penalty_fee)
   from acc_st_his.st_his_update
   where balance_water_no = in_balance_water_no and£®pay_type='01' or (pay_type='02' and penalty_fee=0))
   group by balance_water_no, line_id, station_id, case  when to_char(update_datetime, 'hh24mi') >= v_squad
   then to_char(update_datetime, 'yyyymmdd')  else   to_char(update_datetime - 1, 'yyyymmdd')  end,
   pay_type,update_reason_id,operator_id,card_main_id,card_sub_id,dev_type_id,shift_id,device_id ;
   ----––’˛¥¶¿Ì
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_get––’˛¥¶¿Ì';
   insert  into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,
      card_main_id,card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,case when to_char(admin_datetime, 'hh24mi') >= v_squad
      then to_char(admin_datetime, 'yyyymmdd') else to_char(admin_datetime - 1, 'yyyymmdd')  end,
      '61','',admin_way_id,operator_id,card_main_id,card_sub_id,dev_type_id,0,
      sum(return_fee),count(*),shift_id,device_id,sum(penalty_fee)
   from acc_st_his.st_his_admin
   where balance_water_no = in_balance_water_no 
   group by balance_water_no, line_id, station_id, case
   when to_char(admin_datetime, 'hh24mi') >= v_squad   then   to_char(admin_datetime, 'yyyymmdd')
   else  to_char(admin_datetime - 1, 'yyyymmdd')  end, admin_way_id, operator_id,
   card_main_id, card_sub_id, dev_type_id,shift_id, device_id ;
   ------------------ÕÀøÓ
   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_bom_getÕÀøÓ';
   insert into t#st_ist_settle_income_bom_get(
      balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,do_type,operator_id,
      card_main_id,card_sub_id,dev_type_id,deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee)
   select balance_water_no,line_id,station_id,  case when to_char(return_datetime, 'hh24mi') >= v_squad
      then to_char(return_datetime, 'yyyymmdd') else to_char(return_datetime - 1, 'yyyymmdd')   end,
      '57','','',substr(operator_id,1,6),card_main_id,card_sub_id,dev_type_id,sum(return_deposit_fee),sum(return_balance_fee),
      count(*),shift_id,device_id,sum(penalty_fee)
   from acc_st_his.st_his_return
   where balance_water_no = in_balance_water_no 
   group by balance_water_no, line_id, station_id, case  when to_char(return_datetime, 'hh24mi') >= v_squad
   then to_char(return_datetime, 'yyyymmdd')  else to_char(return_datetime - 1, 'yyyymmdd')  end,
   substr(operator_id,1,6), card_main_id, card_sub_id, dev_type_id, shift_id,device_id ;
   
   v_msg := '≤Â»Î±Ìst_sts_inc_station';
   insert into st_sts_inc_station(
      water_no,balance_water_no,line_id,station_id,squad_day,tr_type_id,pay_mode_id,
      do_type,operator_id,card_main_id,card_sub_id,dev_type_id,deal_fee,return_balance,
      deal_num,shift_id,device_id,penalty_fee )
   select seq_st_sts_bom_get.nextval,balance_water_no,line_id,station_id, squad_day,
      tr_type_id,pay_mode_id,do_type,operator_id,card_main_id,card_sub_id,dev_type_id,
      deal_fee,return_bala,deal_num,shift_id,device_id,penalty_fee
   from t#st_ist_settle_income_bom_get;
   ----------‘¬ƒ©: …˙≥…π˝∆⁄∆±”‡∂ÓÕ≥º∆»’±®(st_sts_inc_balance_expired)
 /*  if to_char(sysdate,'yyyymmdd')=to_char(last_day(sysdate),'yyyymmdd') then
      v_msg := '≤Â»Î±Ìst_sts_inc_balance_expired¿˙ ∑';
      insert  into st_sts_inc_balance_expired
       select seq_st_sts_inc_balance_expired.nextval,balance_water_no,card_main_id,card_sub_id,total_num
           ,total_bal_fee,total_deposit_fee,squad_day from
              (select in_balance_water_no balance_water_no,a.card_main_id,a.card_sub_id,count(*) total_num,
            sum(nvl(a.system_balance_fee, 0)) total_bal_fee,sum(nvl(b.deposit_fee, 0)) total_deposit_fee,
            to_char(sysdate,'yyyymmdd'£©squad_day   from st_act_svt a,acc_st_his.st_his_sale b
            where a.card_logical_id = b.card_logical_id and   a.card_main_id = b.card_main_id
                  and a.card_sub_id = b.card_sub_id and a.new_expire_datetime <sysdate
           group by a.card_main_id, a.card_sub_id,to_char(sysdate,'yyyymmdd'));
       v_msg := '≤Â»Î±Ìst_sts_inc_balance_expiredµ±«∞';
      insert  into st_sts_inc_balance_expired
        select seq_st_sts_inc_balance_expired.nextval ,balance_water_no,card_main_id,card_sub_id,total_num
           ,total_bal_fee,total_deposit_fee,squad_day from
              (select in_balance_water_no balance_water_no,a.card_main_id,a.card_sub_id,count(*) total_num,
               sum(nvl(a.system_balance_fee, 0)) total_bal_fee,sum(nvl(b.deposit_fee, 0)) total_deposit_fee,
                 to_char(sysdate,'yyyymmdd'£©squad_day from st_act_svt a, st_que_sale b
                  where b.balance_water_no = in_balance_water_no 
                  and a.card_logical_id = b.card_logical_id and a.card_main_id = b.card_main_id
                  and a.card_sub_id = b.card_sub_id and a.new_expire_datetime < sysdate
                  group by a.card_main_id, a.card_sub_id,to_char(sysdate,'yyyymmdd'));
   end if;*/
   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg := v_msg||'¥ÌŒÛ£∫'||sqlerrm;
       out_retresult := sqlcode;
       return;
     end;
end ;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_LCC
prompt =======================================
prompt
create or replace procedure acc_st.up_st_ist_settle_lcc(
 out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_lcc
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫lcc∂‘’À
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫--ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
        --ver1.02 ∑«œ÷Ω∏¸–¬∏ƒŒ™¥”dealÕ≥º∆ 2014-6-22
        --ver1.03 ∑«œ÷Ω∏¸–¬‘ˆº”¥”updateÕ≥º∆¡„÷µ 2014-7-22
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
        --ver1.11 ‘ˆº”∂‘’À»’∆⁄£¨∏ƒŒ™∏˘æ›∂‘’À»’∆⁄∂‘’À ∏¸–¬»’∆⁄2015-4-8
-------------------------------------------------------------------------------
as
   v_count int;
   v_msg varchar(100);
begin

  --ver1.11 ‘ˆº”¡Ÿ ±±Ì£¨º«¬º∂‘’À»’∆⁄ ∏¸–¬»’∆⁄2015-4-8
  insert into t#st_que_lcc( water_no ,balance_water_no ,line_id ,station_id ,bom_sale_sjt_num,bom_sale_sjt_fee ,tvm_sale_sjt_num ,tvm_sale_sjt_fee ,
         bom_sale_num ,bom_sale_deposit_fee ,bom_charge_fee ,tvm_charge_num ,tvm_charge_fee ,return_num ,
         return_fee ,non_return_num ,non_ret_deposit_fee , non_ret_actual_ret_bala ,
         negative_charge_num ,negative_charge_fee , deal_num , deal_fee , update_cash_num , update_cash_fee , update_noncash_num ,
         update_noncash_fee , admin_num , admin_return_fee , admin_penalty_fee , file_name , check_flag,account_date)
  select  water_no ,balance_water_no ,line_id ,station_id ,bom_sale_sjt_num,bom_sale_sjt_fee ,tvm_sale_sjt_num ,tvm_sale_sjt_fee ,
          bom_sale_num ,bom_sale_deposit_fee ,bom_charge_fee ,tvm_charge_num ,tvm_charge_fee ,return_num ,
          return_fee ,non_return_num ,non_ret_deposit_fee , non_ret_actual_ret_bala ,
          negative_charge_num ,negative_charge_fee , deal_num , deal_fee , update_cash_num , update_cash_fee , update_noncash_num ,
          update_noncash_fee , admin_num , admin_return_fee , admin_penalty_fee , file_name , check_flag,substr(file_name,7,8)
  from st_que_lcc where balance_water_no = in_balance_water_no;


    ----------------------------acc∂‘’À±Ì£®st_sts_acc£©
    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îbomµ•≥Ã∆±∑¢ €◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,count(*),sum(sale_fee)
        ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from st_que_sale_sjt a
    where balance_water_no = in_balance_water_no and dev_type_id='03'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îtvmµ•≥Ã∆±∑¢ €◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,count(*),sum(sale_fee)
        ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from st_que_sale_sjt a
    where balance_water_no = in_balance_water_no and dev_type_id='02'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îbom¥¢÷µ¿‡∆±ø®∑¢ €◊‹ ˝¡ø°¢—∫Ω◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,count(*),sum(deposit_fee)
        ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from st_que_sale a
    where balance_water_no = in_balance_water_no and dev_type_id='03'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îbom≥‰÷µ◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,sum(deal_fee)
        ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from st_que_deal a
    where balance_water_no = in_balance_water_no and dev_type_id='03' and  pay_mode_id='14'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îtvm≥‰÷µ◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,count(*),sum(deal_fee)
        ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from st_que_deal a
    where balance_water_no = in_balance_water_no and dev_type_id='02' and  pay_mode_id='14'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îº¥ ±ÕÀøÓ◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,count(*),sum(return_deposit_fee+return_balance_fee)
        ,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    from st_que_return a
    where balance_water_no = in_balance_water_no and return_type in ('0','2','3')
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Î∑«º¥ ±ÕÀøÓ◊‹ ˝¡ø°¢◊‹—∫Ω°¢◊‹ÕÀªπ”‡∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(return_deposit_fee£©,sum(return_balance_fee)
        ,0,0,0,0,0,0,0,0,0,0,0
    from st_que_return a
    where balance_water_no = in_balance_water_no and return_type='1'
   group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Î≥Â’˝◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(deal_fee)
        ,0,0,0,0,0,0,0,0,0
    from st_que_deal a
    where balance_water_no = in_balance_water_no and pay_mode_id='18'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Î≥ˆ’¢ø€∑—◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(deal_fee)
        ,0,0,0,0,0,0,0
    from st_que_deal a
    where balance_water_no = in_balance_water_no
          and pay_mode_id in ( select pay_mode_id from op_prm_paymode_type_valid where record_flag = '0')
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Îœ÷Ω∏¸–¬◊‹ ˝¡ø°¢◊‹Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(penalty_fee)
        ,0,0,0,0,0
    from st_que_update a
    where balance_water_no = in_balance_water_no and  pay_type='01'
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Î∑«œ÷Ω∏¸–¬◊‹ ˝¡ø°¢◊‹Ω∂Ódeal'; --2014-6-23 ∏ƒŒ™¥”deal±ÌÕ≥º∆ ver1.02
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(deal_fee)
        ,0,0,0
    from st_que_deal a
    where balance_water_no = in_balance_water_no and pay_mode_id in ('1A','4A')
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Î∑«œ÷Ω∏¸–¬◊‹ ˝¡ø°¢◊‹Ω∂Óupdate'; --2014-7-22 ‘ˆº”¥”updateÕ≥º∆¡„÷µ ver1.03
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(penalty_fee)
        ,0,0,0
    from st_que_update a
    where balance_water_no = in_balance_water_no and pay_type='02' and penalty_fee=0
    group by  a.balance_water_no,line_id,station_id;



    v_msg := 'œÚt#st_ist_settle_lcc_tmp±Ì≤Â»Î––’˛¥¶¿Ì◊‹ ˝¡ø°¢◊‹÷ß≥ˆΩ∂Ó°¢◊‹ ’»°Ω∂Ó';
    insert into t#st_ist_settle_lcc_tmp
        select a.balance_water_no,line_id,station_id,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,count(*),sum(return_fee)
        ,sum(penalty_fee)
    from  st_que_admin a
    where balance_water_no = in_balance_water_no
    group by  a.balance_water_no,line_id,station_id;

    v_msg := 'œÚt#st_ist_settle_lcc_result±Ì≤Â»Îª„◊‹';
    insert into t#st_ist_settle_lcc_result
    select balance_water_no ,line_id, station_id ,sum(bom_sale_sjt_num) ,sum(bom_sale_sjt_fee) ,
  sum(tvm_sale_sjt_num) ,sum(tvm_sale_sjt_fee),sum(bom_sale_num) ,sum(bom_sale_deposit_fee) ,
  sum(bom_charge_fee) ,sum(tvm_charge_num) ,sum(tvm_charge_fee) ,sum(return_num) ,sum(return_fee),
  sum(non_return_num) ,sum(non_ret_deposit_fee) ,sum(non_ret_actual_ret_bala) ,sum(negative_charge_num),
  sum(negative_charge_fee),sum(deal_num) ,sum(deal_fee) ,sum(update_cash_num) ,sum(update_cash_fee ),
  sum(update_noncash_num) ,sum(update_noncash_fee) ,sum(admin_num) ,sum(admin_return_fee),sum(admin_penalty_fee)
  from  t#st_ist_settle_lcc_tmp
  group by balance_water_no ,line_id, station_id;

  ----------…˙≥…acc∂‘’ÀΩ·π˚±Ì£®st_sts_acc£©
  delete st_sts_acc where  balance_water_no = in_balance_water_no;
  v_msg := 'œÚst_sts_acc±Ì≤Â»Î ˝æ›';
  insert into st_sts_acc( water_no , balance_water_no ,line_id, station_id ,bom_sale_sjt_num , bom_sale_sjt_fee ,
    tvm_sale_sjt_num , tvm_sale_sjt_fee, bom_sale_num , bom_sale_deposit_fee ,
    bom_charge_fee , tvm_charge_num , tvm_charge_fee , return_num ,return_fee,
    non_return_num ,non_ret_deposit_fee ,non_ret_actual_ret_bala ,negative_charge_num ,
    negative_charge_fee, deal_num ,deal_fee , update_cash_num ,update_cash_fee ,
    update_noncash_num , update_noncash_fee ,admin_num , admin_return_fee,admin_penalty_fee)
  select seq_st_sts_acc.nextval, balance_water_no ,line_id, station_id ,bom_sale_sjt_num , bom_sale_sjt_fee ,
    tvm_sale_sjt_num , tvm_sale_sjt_fee, bom_sale_num , bom_sale_deposit_fee ,
    bom_charge_fee , tvm_charge_num , tvm_charge_fee , return_num ,return_fee,
    non_return_num ,non_ret_deposit_fee ,non_ret_actual_ret_bala ,negative_charge_num ,
    negative_charge_fee, deal_num ,deal_fee , update_cash_num ,update_cash_fee ,
    update_noncash_num , update_noncash_fee ,admin_num , admin_return_fee,admin_penalty_fee
  from   t#st_ist_settle_lcc_result;

   --LCC…œ¥´»Áπ˚”–÷Õ¡Ù ˝æ›£¨Ω´st_sts_acc∂‘”¶«ÂÀ„»’µƒ ˝æ›º”»Î¡Ÿ ±±Ì◊ˆ±»Ωœ ver1.11 ‘ˆº” 2015-4-8
  select count(*) into v_count from t#st_que_lcc where account_date!=substr(in_balance_water_no,1,8);
  if v_count>0 then
     insert into t#st_ist_settle_lcc_result( balance_water_no ,line_id, station_id ,bom_sale_sjt_num , bom_sale_sjt_fee ,
         tvm_sale_sjt_num , tvm_sale_sjt_fee, bom_sale_num , bom_sale_deposit_fee ,
          bom_charge_fee , tvm_charge_num , tvm_charge_fee , return_num ,return_fee,
          non_return_num ,non_ret_deposit_fee ,non_ret_actual_ret_bala ,negative_charge_num ,
          negative_charge_fee, deal_num ,deal_fee , update_cash_num ,update_cash_fee ,
          update_noncash_num , update_noncash_fee ,admin_num , admin_return_fee,admin_penalty_fee)
      select  balance_water_no ,line_id, station_id ,bom_sale_sjt_num , bom_sale_sjt_fee ,
         tvm_sale_sjt_num , tvm_sale_sjt_fee, bom_sale_num , bom_sale_deposit_fee ,
          bom_charge_fee , tvm_charge_num , tvm_charge_fee , return_num ,return_fee,
          non_return_num ,non_ret_deposit_fee ,non_ret_actual_ret_bala ,negative_charge_num ,
          negative_charge_fee, deal_num ,deal_fee , update_cash_num ,update_cash_fee ,
          update_noncash_num , update_noncash_fee ,admin_num , admin_return_fee,admin_penalty_fee
  from   st_sts_acc where substr(balance_water_no,1,8)||line_id||station_id in
      (select distinct account_date||line_id||station_id from t#st_que_lcc where account_date!=substr(in_balance_water_no,1,8));
  end if;

 ---------------------------lcc_acc∂‘’ÀΩ·π˚±Ì£®st_sts_lcc_acc£©
  delete st_sts_lcc_acc where  balance_water_no = in_balance_water_no;

  v_msg := 'œÚst_sts_lcc_acc±Ì≤Â»Î∂‘’À»’Œ™«ÂÀ„»’µƒ ˝æ›';
  insert into st_sts_lcc_acc(water_no , balance_water_no ,line_id, station_id ,diff_bom_sale_sjt_num , diff_bom_sale_sjt_fee ,
  diff_tvm_sale_sjt_num , diff_tvm_sale_sjt_fee, diff_bom_sale_num , diff_bom_sale_deposit_fee ,
  diff_bom_charge_fee , diff_tvm_charge_num , diff_tvm_charge_fee , diff_return_num ,diff_return_fee,
  diff_non_return_num ,diff_non_ret_deposit_fee ,diff_non_ret_actual_ret_bala ,diff_negative_charge_num ,
  diff_negative_charge_fee, diff_deal_num ,diff_deal_fee , diff_update_cash_num ,diff_update_cash_fee ,
  diff_update_noncash_num , diff_update_noncash_fee ,diff_admin_num , diff_admin_return_fee,diff_admin_penalty_fee,account_date
   )
 select  seq_st_sts_lcc_acc.nextval,a.balance_water_no ,a.line_id, a.station_id ,
  a.bom_sale_sjt_num-b.bom_sale_sjt_num ,a.bom_sale_sjt_fee-b.bom_sale_sjt_fee,
  a.tvm_sale_sjt_num-b.tvm_sale_sjt_num,a.tvm_sale_sjt_fee-b.tvm_sale_sjt_fee,
  a.bom_sale_num-b.bom_sale_num, a.bom_sale_deposit_fee-b.bom_sale_deposit_fee,
  a.bom_charge_fee-b.bom_charge_fee,a.tvm_charge_num-b.tvm_charge_num,
  a.tvm_charge_fee-b.tvm_charge_fee, a.return_num-b.return_num,
  a.return_fee-b.return_fee, a.non_return_num-b.non_return_num,
  a.non_ret_deposit_fee-b.non_ret_deposit_fee, a.non_ret_actual_ret_bala-b.non_ret_actual_ret_bala,
  a.negative_charge_num-b.negative_charge_num, a.negative_charge_fee-b.negative_charge_fee,
  a.deal_num -b.deal_num , a.deal_fee -b.deal_fee , a.update_cash_num-b.update_cash_num,
  a.update_cash_fee-b.update_cash_fee, a.update_noncash_num-b.update_noncash_num,
  a.update_noncash_fee-b.update_noncash_fee,a.admin_num-b.admin_num,
  a.admin_return_fee-b.admin_return_fee, a.admin_penalty_fee-b.admin_penalty_fee,a.account_date
 from t#st_que_lcc a,t#st_ist_settle_lcc_result b
 where a.account_date=substr(b.balance_water_no,1,8) and a.line_id=b.line_id and a.station_id=b.station_id;

 -- µ±lcc∂‘’À ˝æ›’“≤ªµΩACC∂‘”¶ ˝æ› ±
 insert into st_sts_lcc_acc(water_no , balance_water_no ,line_id, station_id ,diff_bom_sale_sjt_num , diff_bom_sale_sjt_fee ,
  diff_tvm_sale_sjt_num , diff_tvm_sale_sjt_fee, diff_bom_sale_num , diff_bom_sale_deposit_fee ,
  diff_bom_charge_fee , diff_tvm_charge_num , diff_tvm_charge_fee , diff_return_num ,diff_return_fee,
  diff_non_return_num ,diff_non_ret_deposit_fee ,diff_non_ret_actual_ret_bala ,diff_negative_charge_num ,
  diff_negative_charge_fee, diff_deal_num ,diff_deal_fee , diff_update_cash_num ,diff_update_cash_fee ,
  diff_update_noncash_num , diff_update_noncash_fee ,diff_admin_num , diff_admin_return_fee,diff_admin_penalty_fee,account_date
   )
 select  seq_st_sts_lcc_acc.nextval,a.balance_water_no ,a.line_id, a.station_id ,
  a.bom_sale_sjt_num-0 ,a.bom_sale_sjt_fee-0,
  a.tvm_sale_sjt_num-0,a.tvm_sale_sjt_fee-0,
  a.bom_sale_num-0, a.bom_sale_deposit_fee-0,
  a.bom_charge_fee-0,a.tvm_charge_num-0,
  a.tvm_charge_fee-0, a.return_num-0,
  a.return_fee-0, a.non_return_num-0,
  a.non_ret_deposit_fee-0, a.non_ret_actual_ret_bala-0,
  a.negative_charge_num-0, a.negative_charge_fee-0,
  a.deal_num -0, a.deal_fee -0, a.update_cash_num-0,
  a.update_cash_fee-0, a.update_noncash_num-0,
  a.update_noncash_fee-0,a.admin_num-0,
  a.admin_return_fee-0, a.admin_penalty_fee-0,a.account_date
 from t#st_que_lcc a
 where a.account_date||a.line_id||a.station_id not in (select distinct(substr(b.balance_water_no,1,8)||b.line_id||b.station_id) from t#st_ist_settle_lcc_result b)
 and a.account_date!=substr(in_balance_water_no,1,8);

   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_LCC to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_MOBILE
prompt ==========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_mobile(
       out_retresult out integer, --∑µªÿΩ·π˚
       out_msg       out varchar2, --∑µªÿ–≈œ¢
       in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_mobile
--π¶ƒ‹√Ë ˆ£∫ ÷ª˙÷ß∏∂“µŒÒÕ≥º∆°¢∂‘’À
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  lindaquan 20160111 ver1.30
--–ﬁ∏ƒ£∫   ‘ˆº” ÷ª˙÷ß∏∂«ÂÀ„ lindaquan 20160421 ver1.33
--–ﬁ∏ƒ£∫   ≤Â»ÎLcc÷Õ¡Ù≤ø∑÷∂‘”¶µƒAcc ˝æ› lindaquan 20160620 ver1.35
--–ﬁ∏ƒ£∫   »•≥˝ACC‘À”™»’Õ≥º∆ lindaquan 20160708         ver1.36
-------------------------------------------------------------------------------
as
   v_count int := 0;
   v_msg varchar(100) := '';
begin


   -- ø’÷–≥‰÷µÕ≥º∆ --
   v_msg := 'ø’÷–≥‰÷µÕ≥º∆≤Â»Îst_mb_sts_deal±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_deal where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       -- ¡Ÿ ±±Ì
       insert into acc_st.t#st_mb_sts_deal
         (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id,
                    deal_num, deal_fee, paid_channel_type, squad_day, balance_water_no)
       select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id,
                    count(1), sum(nvl(deal_fee,0)), paid_channel_type, to_char(deal_datetime,'yyyymmdd'), balance_water_no
       from acc_st.st_mb_que_deal
       where balance_water_no = in_balance_water_no
       group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id,
                paid_channel_type, to_char(deal_datetime,'yyyymmdd'), balance_water_no;
       -- Õ≥º∆±Ì
       insert into acc_st.st_mb_sts_deal
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deal_num, deal_fee, paid_channel_type, squad_day, operator_id, shift_id, balance_water_no)
       select acc_st.seq_st_mb_sts_deal.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deal_num, deal_fee, paid_channel_type, squad_day, operator_id, shift_id, balance_water_no
       from acc_st.t#st_mb_sts_deal;
   end if;


   -- ø’÷–ÕÀøÓÕ≥º∆ --
   v_msg := 'ø’÷–ÕÀøÓÕ≥º∆≤Â»Îst_mb_sts_return±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_return where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       -- ¡Ÿ ±±Ì
       insert into acc_st.t#st_mb_sts_return
         (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id, return_type,
                    return_num, return_balance_fee, return_deposit_fee, penalty_fee, auxi_fee,
                    paid_channel_type, squad_day, balance_water_no)
       select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id, return_type,
              count(1), sum(nvl(return_balance_fee,0)), sum(nvl(return_deposit_fee,0)), sum(nvl(penalty_fee,0)), sum(nvl(auxi_fee,0)),
              paid_channel_type, to_char(return_datetime,'yyyymmdd'), balance_water_no
       from acc_st.st_mb_que_return
       where balance_water_no = in_balance_water_no
       group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id, return_type,
                paid_channel_type, to_char(return_datetime,'yyyymmdd'), balance_water_no;
       -- Õ≥º∆±Ì
       insert into acc_st.st_mb_sts_return
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, return_num, return_balance_fee, return_deposit_fee, penalty_fee, return_type, auxi_fee, paid_channel_type, squad_day, operator_id, shift_id, balance_water_no)
       select acc_st.seq_st_mb_sts_return.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, return_num, return_balance_fee, return_deposit_fee, penalty_fee, return_type, auxi_fee, paid_channel_type, squad_day, operator_id, shift_id, balance_water_no
       from acc_st.t#st_mb_sts_return;
   end if;


   -- ø’÷–∑¢ €Õ≥º∆ --
   v_msg := 'ø’÷–∑¢ €Õ≥º∆≤Â»Îst_mb_sts_sale±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_sale where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       -- ¡Ÿ ±±Ì
       insert into acc_st.t#st_mb_sts_sale
         (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deposit_type, operator_id, shift_id,
         sale_num, deposit_fee, auxi_fee, squad_day, balance_water_no)
       select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deposit_type, operator_id, shift_id,
              count(1), sum(nvl(deposit_fee,0)), sum(nvl(auxi_fee,0)), to_char(sale_datetime,'yyyymmdd'), balance_water_no
       from acc_st.st_mb_que_sale
       where balance_water_no = in_balance_water_no
       group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id, deposit_type,
                to_char(sale_datetime,'yyyymmdd'), balance_water_no;
       -- Õ≥º∆±Ì
       insert into acc_st.st_mb_sts_sale
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deposit_type, deposit_fee, sale_num, squad_day, operator_id, shift_id, auxi_fee, balance_water_no)
       select acc_st.seq_st_mb_sts_sale.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deposit_type, deposit_fee, sale_num, squad_day, operator_id, shift_id, auxi_fee, balance_water_no
       from acc_st.t#st_mb_sts_sale;
   end if;


   -- º”Ω‚À¯Õ≥º∆ --
   v_msg := 'º”Ω‚À¯Õ≥º∆≤Â»Îst_mb_sts_lock±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_lock where balance_water_no = in_balance_water_no;

   if(v_count = 0) then -- ≈–∂œ «∑ÒÕ≥º∆π˝
       -- ¡Ÿ ±±Ì
       insert into acc_st.t#st_mb_sts_lock
         (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id,
         lock_num, squad_day, lock_flag, balance_water_no)
       select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id,
              count(1), to_char(lock_datetime,'yyyymmdd'), lock_flag, balance_water_no
       from acc_st.st_mb_que_lock
       where balance_water_no = in_balance_water_no
       group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, operator_id, shift_id, lock_flag,
                to_char(lock_datetime,'yyyymmdd'), balance_water_no;
       -- Õ≥º∆±Ì
       insert into acc_st.st_mb_sts_lock
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, lock_num, squad_day, operator_id, shift_id, lock_flag, balance_water_no)
       select acc_st.seq_st_mb_sts_lock.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, lock_num, squad_day, operator_id, shift_id, lock_flag, balance_water_no
       from acc_st.t#st_mb_sts_lock;
   end if;


   -- ACCÕ≥º∆ --
   v_msg := '≤Â»ÎACCÕ≥º∆±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_acc where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       -- º”À¯ ≤Â»Î¡Ÿ ±±Ì
       insert into acc_st.t#st_mb_sts_acc
         (line_id, station_id, deal_num, deal_fee, sale_num, sale_fee, return_num, return_fee, lock_num, unlock_num, balance_water_no)
       select line_id, station_id, 0, 0, 0, 0, 0, 0, sum(nvl(lock_num,0)), 0, balance_water_no
       from acc_st.t#st_mb_sts_lock
       where lock_flag = '1'
       group by line_id, station_id, balance_water_no;

       -- Ω‚À¯ ≤Â»Î¡Ÿ ±±Ì –ﬁ∏ƒlock_flag = '2' lindaquan-- 20160421
       MERGE INTO acc_st.t#st_mb_sts_acc a
       USING (select sum(nvl(lock_num,0)) as lock_num, line_id, station_id, balance_water_no
             from acc_st.t#st_mb_sts_lock
             where lock_flag = '2'
             group by line_id, station_id, balance_water_no) b
       ON (a.line_id=b.line_id and a.station_id=b.station_id and a.balance_water_no=b.balance_water_no)
       WHEN MATCHED THEN
       UPDATE
       SET a.unlock_num =b.lock_num
       WHEN NOT MATCHED THEN
       INSERT (a.line_id, a.station_id, a.deal_num, a.deal_fee, a.sale_num, a.sale_fee, a.return_num, a.return_fee, a.lock_num, a.unlock_num, a.balance_water_no)
       VALUES (b.line_id, b.station_id, 0, 0, 0, 0, 0, 0, 0, b.lock_num, b.balance_water_no);

       -- ∑¢ € ≤Â»Î¡Ÿ ±±Ì
       MERGE INTO acc_st.t#st_mb_sts_acc a
       USING (select sum(nvl(deposit_fee,0)-nvl(auxi_fee,0)) as sale_fee, sum(nvl(sale_num,0)) as sale_num, line_id, station_id, balance_water_no
             from acc_st.t#st_mb_sts_sale
             group by line_id, station_id, balance_water_no) b
       ON (a.line_id=b.line_id and a.station_id=b.station_id and a.balance_water_no=b.balance_water_no)
       WHEN MATCHED THEN
       UPDATE
       SET a.sale_fee =b.sale_fee,
           a.sale_num = b.sale_num
       WHEN NOT MATCHED THEN
       INSERT (a.line_id, a.station_id, a.deal_num, a.deal_fee, a.sale_num, a.sale_fee, a.return_num, a.return_fee, a.lock_num, a.unlock_num, a.balance_water_no)
       VALUES (b.line_id, b.station_id, 0, 0, b.sale_num, b.sale_fee, 0, 0, 0, 0, b.balance_water_no);

       -- ÕÀøÓ ≤Â»Î¡Ÿ ±±Ì
       MERGE INTO acc_st.t#st_mb_sts_acc a
       USING (select sum(nvl(return_balance_fee,0)+nvl(return_deposit_fee ,0)-nvl(penalty_fee ,0)-nvl(auxi_fee ,0)) as return_fee,
             sum(nvl(return_num,0)) as return_num, line_id, station_id, balance_water_no
             from acc_st.t#st_mb_sts_return
             group by line_id, station_id, balance_water_no) b
       ON (a.line_id=b.line_id and a.station_id=b.station_id and a.balance_water_no=b.balance_water_no)
       WHEN MATCHED THEN
       UPDATE
       SET a.return_fee =b.return_fee,
           a.return_num = b.return_num
       WHEN NOT MATCHED THEN
       INSERT (a.line_id, a.station_id, a.deal_num, a.deal_fee, a.sale_num, a.sale_fee, a.return_num, a.return_fee, a.lock_num, a.unlock_num, a.balance_water_no)
       VALUES (b.line_id, b.station_id, 0, 0, 0, 0, b.return_num, b.return_fee, 0, 0, b.balance_water_no);

       -- ≥‰÷µ ≤Â»Î¡Ÿ ±±Ì
       MERGE INTO acc_st.t#st_mb_sts_acc a
       USING (select sum(nvl(deal_fee,0)) as deal_fee,
             sum(nvl(deal_num,0)) as deal_num, line_id, station_id, balance_water_no
             from acc_st.t#st_mb_sts_deal
             group by line_id, station_id, balance_water_no) b
       ON (a.line_id=b.line_id and a.station_id=b.station_id and a.balance_water_no=b.balance_water_no)
       WHEN MATCHED THEN
       UPDATE
       SET a.deal_fee =b.deal_fee,
           a.deal_num = b.deal_num
       WHEN NOT MATCHED THEN
       INSERT (a.line_id, a.station_id, a.deal_num, a.deal_fee, a.sale_num, a.sale_fee, a.return_num, a.return_fee, a.lock_num, a.unlock_num, a.balance_water_no)
       VALUES (b.line_id, b.station_id, b.deal_num, b.deal_fee, 0, 0, 0, 0, 0, 0, b.balance_water_no);

       -- ACC¡Ÿ ±±Ì≤Â»ÎÕ≥º∆±Ì
       insert into acc_st.st_mb_sts_acc
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, return_num, return_fee, lock_num, unlock_num, balance_water_no)
       select acc_st.seq_st_mb_sts_acc.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, return_num, return_fee, lock_num, unlock_num, balance_water_no
       from acc_st.t#st_mb_sts_acc;
   end if;


   -- LCCÕ≥º∆ --
   v_msg := 'LCCÕ≥º∆Õ≥º∆≤Â»Îst_mb_sts_lcc±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_lcc where balance_water_no = in_balance_water_no;

   if(v_count = 0) then -- ≈–∂œ «∑ÒÕ≥º∆π˝

       -- ¡Ÿ ±±Ì
       insert into acc_st.t#st_mb_sts_lcc
         (line_id, station_id, deal_num, deal_fee, return_num, return_fee, sale_num, sale_fee, lock_num, unlock_num, balance_water_no, squad_day)
       select line_id, station_id, charge_num, charge_fee, return_num, return_fee, sale_num, sale_fee, lock_num, unlock_num, balance_water_no, substr(file_name,7,8)
       from acc_st.st_mb_que_lcc
       where balance_water_no = in_balance_water_no;

       -- Õ≥º∆±Ì
       insert into acc_st.st_mb_sts_lcc
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, return_num, return_fee, lock_num, unlock_num, balance_water_no)
       select acc_st.seq_st_mb_sts_lcc.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, return_num, return_fee, lock_num, unlock_num, balance_water_no
       from acc_st.t#st_mb_sts_lcc;
   end if;

   -- ≤Â»ÎLcc÷Õ¡Ù≤ø∑÷∂‘”¶µƒAcc ˝æ›
   insert into acc_st.t#st_mb_sts_acc
     (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day, deal_num, deal_fee, sale_num,
               sale_fee, return_num, return_fee, lock_num, unlock_num, balance_water_no)
   select a.line_id, a.station_id, a.dev_type_id, a.device_id, a.card_main_id, a.card_sub_id, a.squad_day, a.deal_num,
          a.deal_fee, a.sale_num, a.sale_fee, a.return_num, a.return_fee, a.lock_num, a.unlock_num, a.balance_water_no
   from acc_st.st_mb_sts_acc a
   where substr(balance_water_no,1,8) in
      (select distinct squad_day from acc_st.t#st_mb_sts_lcc where squad_day!=substr(in_balance_water_no,1,8));

   --
   insert into acc_st.t#st_mb_sts_acc_result
     (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, deal_num, deal_fee, sale_num, sale_fee,
     return_num, return_fee, lock_num, unlock_num, balance_water_no)
   select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, sum(deal_num), sum(deal_fee), sum(sale_num), sum(sale_fee),
          sum(return_num), sum(return_fee), sum(lock_num), sum(unlock_num), balance_water_no
          from acc_st.t#st_mb_sts_acc
          group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, balance_water_no;

   -- LCC_ACCÕ≥º∆ --
   v_msg := 'LCC_ACCÕ≥º∆≤Â»Îst_mb_sts_lcc_acc±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_mb_sts_lcc_acc where balance_water_no = in_balance_water_no;

   if(v_count = 0) then -- ≈–∂œ «∑ÒÕ≥º∆π˝
       -- ¡Ÿ ±±Ì  π”√full join–ﬁ∏¥acc/lcc»± ˝æ› ±Œ¥ƒ‹πÿ¡™≤È—ØŒ Ã‚ 20161222
       insert into acc_st.st_mb_sts_lcc_acc
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day, balance_water_no,
         diff_deal_num, diff_deal_fee, diff_sale_num, diff_sale_fee, diff_return_num, diff_return_fee, diff_lock_num, diff_unlock_num)
       select acc_st.seq_st_mb_sts_lcc_acc.nextval,
            a.line_id, a.station_id, a.dev_type_id,
            a.device_id, a.card_main_id, a.card_sub_id,
            a.squad_day, a.balance_water_no,
            nvl(a.deal_num,0)-nvl(b.deal_num,0) diff_deal_num,
            nvl(a.deal_fee,0)-nvl(b.deal_fee,0) diff_deal_fee,
            nvl(a.sale_num,0)-nvl(b.sale_num,0) diff_sale_num,
            nvl(a.sale_fee,0)-nvl(b.sale_fee,0) diff_sale_fee,
            nvl(a.return_num,0)-nvl(b.return_num,0) diff_return_num,
            nvl(a.return_fee,0)-nvl(b.return_fee,0) diff_return_fee,
            nvl(a.lock_num,0)-nvl(b.lock_num,0) diff_lock_num,
            nvl(a.unlock_num,0)-nvl(b.unlock_num,0) diff_unlock_num
            from acc_st.t#st_mb_sts_lcc a full join acc_st.t#st_mb_sts_acc_result b
                  on a.line_id=b.line_id
                  and a.station_id=b.station_id
                  and a.squad_day=substr(b.balance_water_no,1,8);
   end if;

   --  ÷ª˙÷ß∏∂œ˚∑—Õ≥º∆ v1.33 --
   insert into st_mb_ext_sts_deal_bus
     (water_no, line_id, station_id, deal_num, deal_fee, squad_day, balance_water_no)
   select acc_st.seq_st_mb_ext_sts_deal_bus.nextval, line_id, station_id, deal_num, deal_fee, squad_day, in_balance_water_no
   from(
     select line_id, station_id, count(1) deal_num, sum(nvl(deal_fee,0)) deal_fee, to_char(deal_datetime,'yyyymmdd') squad_day
     from st_mb_ext_que_deal_bus where balance_water_no=in_balance_water_no
     group by line_id, station_id,to_char(deal_datetime,'yyyymmdd'));

   insert into st_mb_ext_sts_deal_line
     (water_no, line_id, station_id, deal_num, deal_fee, squad_day, balance_water_no)
   select acc_st.seq_st_mb_ext_sts_deal_bus.nextval, line_id, station_id, deal_num, deal_fee, squad_day, in_balance_water_no
   from(
     select line_id, station_id, count(1) deal_num, sum(nvl(deal_fee,0)) deal_fee, to_char(deal_datetime,'yyyymmdd') squad_day
     from st_mb_ext_que_deal_line where balance_water_no=in_balance_water_no
     group by line_id, station_id,to_char(deal_datetime,'yyyymmdd'));


   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_MOBILE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_NP
prompt ======================================
prompt
create or replace procedure acc_st.up_st_ist_settle_np(
       out_retresult out integer, --∑µªÿΩ·π˚
       out_msg       out varchar2, --∑µªÿ–≈œ¢
       in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_np
--π¶ƒ‹√Ë ˆ£∫ª•¡™Õ¯÷ß∏∂“µŒÒÕ≥º∆°¢∂‘’À
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  lindaquan 20161129 ver1.38
-------------------------------------------------------------------------------
as
   v_count int := 0;
   v_msg varchar(100) := '';
begin

   -- »°∆±≥‰÷µª˙∑¢ €µ•≥Ã∆±Õ≥º∆ --
   v_msg := '∑¢ €Õ≥º∆≤Â»Îst_np_sts_sale±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_sale where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       --¡Ÿ ±±Ì
       insert into acc_st.t#st_np_sts_sale
         (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day,
         deposit_type, deposit_fee, auxi_fee, sale_num, sale_fee, balance_water_no, card_app_flag)
       select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, to_char(sale_datetime,'yyyymmdd'),
                deposit_type, sum(nvl(deposit_fee,0)), sum(nvl(auxi_fee,0)), count(1), sum(nvl(sale_fee,0)), balance_water_no, card_app_flag
         from acc_st.st_np_que_sale
         where balance_water_no = in_balance_water_no
         group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, to_char(sale_datetime,'yyyymmdd'),
                deposit_type, balance_water_no, card_app_flag;
       --Õ≥º∆±Ì
       insert into acc_st.st_np_sts_sale
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day,
         deposit_type, deposit_fee, auxi_fee, sale_num, sale_fee, balance_water_no, card_app_flag)
       select acc_st.seq_st_np_sts_sale.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day,
              deposit_type, deposit_fee, auxi_fee, sale_num, sale_fee, balance_water_no, card_app_flag from acc_st.t#st_np_sts_sale;
   end if;

   -- »°∆±≥‰÷µª˙∏¯¥¢÷µø®≥‰÷µÕ≥º∆ --
   v_msg := '≥‰÷µÕ≥º∆≤Â»Îst_np_sts_deal±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_deal where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       --¡Ÿ ±±Ì
       insert into acc_st.t#st_np_sts_deal
         (line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day,
         deal_num, deal_fee, pay_mode_id, card_app_flag, balance_water_no)
       select line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, to_char(deal_datetime,'yyyymmdd'),
                count(1), sum(nvl(deal_fee,0)), pay_mode_id, card_app_flag, balance_water_no
         from acc_st.st_np_que_deal
         where balance_water_no = in_balance_water_no
         group by line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, to_char(deal_datetime,'yyyymmdd'),
                pay_mode_id, balance_water_no, card_app_flag;
       --Õ≥º∆±Ì
       insert into acc_st.st_np_sts_deal
         (water_no, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day,
         deal_num, deal_fee, pay_mode_id, card_app_flag, balance_water_no)
       select acc_st.seq_st_np_sts_deal.nextval, line_id, station_id, dev_type_id, device_id, card_main_id, card_sub_id, squad_day,
              deal_num, deal_fee, pay_mode_id, card_app_flag, balance_water_no from t#st_np_sts_deal;
   end if;

   -- ∂©µ• ˝æ›Õ≥º∆ --
   v_msg := '∂©µ•Õ≥º∆≤Â»Îst_np_sts_order±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_order where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
     --¡Ÿ ±±Ì
     insert into acc_st.t#st_np_sts_order
       (order_type, status, squad_day, card_main_id, card_sub_id, order_num, deal_num, deal_fee,
       order_type_buy, paid_channel_type, paid_channel_code, balance_water_no)
     select order_type, status, to_char(paid_datetime,'yyyymmdd'), card_main_id, card_sub_id, count(1), sum(nvl(deal_num,0)), sum(nvl(deal_fee,0)),
       order_type_buy, paid_channel_type, paid_channel_code, balance_water_no
       from acc_st.st_np_que_order
       where balance_water_no = in_balance_water_no
           group by order_type, status, to_char(paid_datetime,'yyyymmdd'), card_main_id, card_sub_id,
           order_type_buy, paid_channel_type, paid_channel_code, balance_water_no;
     --Õ≥º∆±Ì
     insert into acc_st.st_np_sts_order
       (water_no, order_type, status, squad_day, card_main_id, card_sub_id, order_num, deal_num, deal_fee,
       order_type_buy, paid_channel_type, paid_channel_code, balance_water_no)
     select acc_st.seq_st_np_sts_deal.nextval, order_type, status, squad_day, card_main_id, card_sub_id, order_num, deal_num, deal_fee,
            order_type_buy, paid_channel_type, paid_channel_code, balance_water_no from acc_st.t#st_np_sts_order;
   end if;

   -- ∂©µ•Ω·π˚Õ≥º∆ --
   v_msg := 'Ω·π˚Õ≥º∆≤Â»Îst_np_sts_order_imp±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_order_imp where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
     --¡Ÿ ±±Ì
     insert into acc_st.t#st_np_sts_order_imp
       (order_type, squad_day, line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id,
       order_num, deal_num, deal_num_not, deal_fee, refund_fee, auxi_fee, balance_water_no)
     select order_type, to_char(finish_datetime,'yyyymmdd'), line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id,
            count(1), sum(nvl(deal_num,0)), sum(nvl(deal_num_not,0)), sum(nvl(deal_fee,0)), sum(nvl(refund_fee,0)), sum(nvl(auxi_fee,0)), balance_water_no
          from acc_st.st_np_que_order_imp
          where balance_water_no = in_balance_water_no
          group by order_type, to_char(finish_datetime,'yyyymmdd'), line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id, balance_water_no;
     --Õ≥º∆±Ì
     insert into acc_st.st_np_sts_order_imp
       (water_no, order_type, squad_day, line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id,
       order_num, deal_num, deal_num_not, deal_fee, refund_fee, auxi_fee, balance_water_no)
     select acc_st.seq_st_np_buf_order_imp.nextval, order_type, squad_day, line_id, station_id, dev_type_id, dev_code, status, card_main_id, card_sub_id,
     order_num, deal_num, deal_num_not, deal_fee, refund_fee, auxi_fee, balance_water_no from acc_st.t#st_np_sts_order_imp;
   end if;


   -- ACCÕ≥º∆ --
   v_msg := 'np≤Â»ÎACCÕ≥º∆±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_acc where balance_water_no = in_balance_water_no;

   if(v_count = 0) then --≈–∂œ «∑ÒÕ≥º∆π˝
       -- ∑¢ € ≤Â»Î¡Ÿ ±±Ì
       insert into acc_st.t#st_np_sts_acc
         (line_id, station_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, balance_water_no)
       select line_id, station_id, squad_day, 0, 0, sum(nvl(sale_num,0)), sum(nvl(sale_fee,0)), balance_water_no from acc_st.t#st_np_sts_sale
       group by line_id, station_id, squad_day, balance_water_no;

       -- ≥‰÷µ ≤Â»Î¡Ÿ ±±Ì
       MERGE INTO acc_st.t#st_np_sts_acc a
       USING (select line_id, station_id, squad_day, sum(nvl(deal_num,0)) as deal_num, sum(nvl(deal_fee,0)) as deal_fee, balance_water_no
                     from acc_st.t#st_np_sts_deal
                     group by line_id, station_id, squad_day, balance_water_no) b
       ON (a.line_id=b.line_id and a.station_id=b.station_id and a.balance_water_no=b.balance_water_no and a.squad_day=b.squad_day)
       WHEN MATCHED THEN
       UPDATE
       SET a.deal_num =b.deal_num,
           a.deal_fee =b.deal_fee
       WHEN NOT MATCHED THEN
       INSERT (a.line_id, a.station_id, a.squad_day, a.deal_num, a.deal_fee, a.sale_num, a.sale_fee, a.balance_water_no)
       VALUES (b.line_id, b.station_id, b.squad_day, b.deal_num, b.deal_fee, 0, 0, b.balance_water_no);


       -- ACC¡Ÿ ±±Ì≤Â»ÎÕ≥º∆±Ì
       insert into st_np_sts_acc
         (water_no, line_id, station_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, balance_water_no)
       select acc_st.seq_st_np_sts_acc.nextval, line_id, station_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, balance_water_no from t#st_np_sts_acc;
   end if;


   -- LCCÕ≥º∆ --
   v_msg := 'LCCÕ≥º∆Õ≥º∆≤Â»Îst_np_sts_lcc±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_lcc where balance_water_no = in_balance_water_no;

   if(v_count = 0) then -- ≈–∂œ «∑ÒÕ≥º∆π˝

       -- ¡Ÿ ±±Ì
       insert into acc_st.t#st_np_sts_lcc
         (balance_water_no, squad_day, line_id, station_id, charge_fee, charge_num, sale_fee, sale_num)
       select balance_water_no, substr(file_name,7,8), line_id, station_id, charge_fee, charge_num, sale_fee, sale_num from acc_st.st_np_que_lcc
       where balance_water_no = in_balance_water_no;
       -- Õ≥º∆±Ì
       insert into acc_st.st_np_sts_lcc
         (water_no, balance_water_no, squad_day, line_id, station_id, charge_fee, charge_num, sale_fee, sale_num)
       select acc_st.seq_st_np_sts_lcc.nextval, balance_water_no, squad_day, line_id, station_id, charge_fee, charge_num, sale_fee, sale_num from acc_st.t#st_np_sts_lcc;
   end if;

   -- ≤Â»ÎLcc÷Õ¡Ù≤ø∑÷∂‘”¶µƒAcc ˝æ›
   insert into acc_st.t#st_np_sts_acc
         (line_id, station_id, squad_day, deal_num, deal_fee, sale_num, sale_fee, balance_water_no)
   select a.line_id, a.station_id, a.squad_day, a.deal_num, a.deal_fee, a.sale_num, a.sale_fee, a.balance_water_no
   from acc_st.st_np_sts_acc a
   where substr(balance_water_no,1,8) in
      (select distinct squad_day from acc_st.t#st_np_sts_lcc where squad_day!=substr(in_balance_water_no,1,8));

   -- ∞¥«ÂÀ„¡˜ÀÆ∫≈Õ≥º∆
   insert into acc_st.t#st_np_sts_acc_result
    (line_id, station_id, deal_num, deal_fee, sale_num, sale_fee, balance_water_no)
    select line_id, station_id, sum(deal_num), sum(deal_fee), sum(sale_num), sum(sale_fee), balance_water_no from acc_st.t#st_np_sts_acc
    group by line_id, station_id, balance_water_no;

   -- LCC_ACCÕ≥º∆ --
   v_msg := 'LCC_ACCÕ≥º∆≤Â»Îst_np_sts_lcc_acc±Ì';
   v_count := 0;
   select count(1) into v_count from acc_st.st_np_sts_lcc_acc where balance_water_no = in_balance_water_no;

   if(v_count = 0) then -- ≈–∂œ «∑ÒÕ≥º∆π˝
       -- Õ≥º∆±Ì  π”√full join–ﬁ∏¥acc/lcc»± ˝æ› ±Œ¥ƒ‹πÿ¡™≤È—ØŒ Ã‚ 20161222
       insert into acc_st.st_np_sts_lcc_acc
         (water_no, line_id, station_id, squad_day, balance_water_no, diff_deal_num, diff_deal_fee, diff_sale_num, diff_sale_fee)
       select acc_st.seq_st_np_sts_lcc_acc.nextval,
            a.line_id, a.station_id,a.squad_day, a.balance_water_no,
            nvl(a.charge_num,0)-nvl(b.deal_num,0) diff_deal_num,
            nvl(a.charge_fee,0)-nvl(b.deal_fee,0) diff_deal_fee,
            nvl(a.sale_num,0)-nvl(b.sale_num,0) diff_sale_num,
            nvl(a.sale_fee,0)-nvl(b.sale_fee,0) diff_sale_fee
            from acc_st.t#st_np_sts_lcc a full join acc_st.t#st_np_sts_acc_result b
                  on a.line_id=b.line_id
                  and a.station_id=b.station_id
                  and a.squad_day=substr(b.balance_water_no,1,8);
   end if;

   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_OTHER
prompt =========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_settle_other
 (out_retResult OUT INTEGER, --∑µªÿΩ·π˚
  out_msg OUT VARCHAR2, --∑µªÿ–≈œ¢
  in_balance_water_no in VARCHAR2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_OTHER
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫«ÂÀ„∫Û–¯¥¶¿Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫--ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
        --ver1.02  ‘ˆº”µÿÃ˙∫⁄√˚µ•œ¬∑¢π´Ωª 2014-6-12
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
        --ver1.11‘ˆº”“Ï–‘ø®∫Õ ÷ª˙ø®
				--ver1.26 ÃÌº”π“ ßº«√˚ø®µΩ∫⁄√˚µ•±Ì
        --ver1.35 ’˚∫œº«√˚ø®…Í«Î¡˜≥Ã
        --ver1.42 ¥¢÷µø®÷ÿ”√ ±£¨…Í«Î ±º‰–°”⁄÷ÿ”√÷ÿ±‡¬Î…˙–ß ±º‰µƒ ˝æ›∏¸–¬Œ™æ…’Àªß ˝æ› by lindaquan 20170330
-------------------------------------------------------------------------------
AS
   v_msg VARCHAR(200);
   v_count int;
   v_begin_next VARCHAR(20);--∆ ºø®∫≈µƒœ¬“ª∏ˆø®∫≈
   v_end_last VARCHAR(20);  --÷’÷πø®∫≈µƒ…œ“ª∏ˆø®∫≈
   v_lock_last VARCHAR(20); --À¯ø®ø®∫≈µƒ…œ“ª∏ˆø®∫≈
   v_lock_next VARCHAR(20); --À¯ø®ø®∫≈µƒœ¬“ª∏ˆø®∫≈
   v_no_return_day  int;
   v_operator_id varchar2(20); --modify by hejj
BEGIN
  select count(*) into v_count from st_sts_inc_balance where balance_water_no = in_balance_water_no ;
   if v_count > 0 then
      out_msg := 'st_sts_inc_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;

------------À¯ø®µƒø®∫≈¥”∫⁄√˚µ•…æ≥˝-----------------
select user into v_operator_id from dual;
delete op_prm_black_old_mtr where  balance_water_no=in_balance_water_no ;
v_msg := '»°∫⁄√˚µ•±Ì¥Ê‘⁄µƒÀ¯ø®ø®∫≈';
delete   t#lock_card;
insert into t#lock_card  select a.card_logical_id
from st_que_lock a,op_prm_black_list_mtr b   WHERE a.balance_water_no=in_balance_water_no and
 a.lock_flag='1' and  card_main_id!='06' and a.card_logical_id= b.card_logical_id ;
 SELECT COUNT(*) INTO v_count   FROM t#lock_card;
 IF v_count > 0 THEN  ---∫⁄√˚µ•±Ì¥Ê‘⁄À¯ø®ø®∫≈
     v_msg := 'À¯ø®ø®∫≈¥”∫⁄√˚µ•±ÌΩ¯»Î∫⁄√˚µ•π˝∆⁄±Ì';
     insert into op_prm_black_old_mtr(gen_datetime,cutoff_datetime,card_logical_id,black_type,remark,
     action_type,create_datetime,operator_id,is_set,balance_water_no,delete_datetime,delete_operator_id,delete_remark)
     select distinct gen_datetime,create_datetime,a.card_logical_id,black_type,remark,action_type,create_datetime,
     a.operator_id,is_set,in_balance_water_no,sysdate,v_operator_id ,'“—À¯ø®'
     from  op_prm_black_list_mtr a,t#lock_card b
    WHERE  a.card_logical_id = b.card_logical_id ;
     v_msg := '∫⁄√˚µ•±Ì…æ≥˝À¯ø®ø®∫≈';
     delete from op_prm_black_list_mtr
    where card_logical_id in (select card_logical_id from t#lock_card ) ;
   END IF;
 delete   t#lock_card;
 v_msg := '»°∫⁄√˚µ•∂Œ±Ì¥Ê‘⁄µƒÀ¯ø®ø®∫≈';
 insert into t#lock_card  select a.card_logical_id
 FROM st_que_lock a,op_prm_black_list_mtr_sec b  WHERE a.balance_water_no=in_balance_water_no and
 a.lock_flag='1' and card_main_id!='06' and a.card_logical_id between b.begin_logical_id and b.end_logical_id ;
 select count(*) into v_count from t#lock_card;
  IF v_count > 0   THEN  ---∫⁄√˚µ•∂Œ±Ì¥Ê‘⁄À¯ø®ø®∫≈
      v_msg := 'À¯ø®ø®∫≈¥”∫⁄√˚µ•∂Œ±ÌΩ¯»Î∫⁄√˚µ•π˝∆⁄±Ì';
     insert into op_prm_black_old_mtr(gen_datetime,cutoff_datetime,card_logical_id,black_type,remark,
     action_type,create_datetime,operator_id,is_set,balance_water_no,delete_datetime,delete_operator_id,delete_remark)
     select distinct gen_datetime,create_datetime,a.card_logical_id,black_type,remark,action_type,create_datetime,
     b.operator_id,is_set,in_balance_water_no,sysdate,v_operator_id  ,'“—À¯ø®'
     FROM t#lock_card a,op_prm_black_list_mtr_sec b
     where a.card_logical_id between b.begin_logical_id and b.end_logical_id ;

   declare  cursor cur_card is      --∂®“Â”Œ±Í»°À¯ø®ø®∫≈
        select distinct a.card_logical_id,b.begin_logical_id,b.end_logical_id  FROM
        t#lock_card a,op_prm_black_list_mtr_sec b
        WHERE a.card_logical_id between b.begin_logical_id and b.end_logical_id;

   begin    --–ﬁ∏ƒ∫⁄√˚µ•∂Œ±Ì£¨»•≥˝À¯ø®∫≈
     for my_cur in cur_card loop
        v_begin_next:=LPAD(to_char(to_number(my_cur.begin_logical_id)+1),
        length(my_cur.begin_logical_id),'0');
        v_end_last:=LPAD(to_char(to_number(my_cur.end_logical_id)-1),length(
                    my_cur.end_logical_id),'0');
        v_lock_next:=LPAD(to_char(to_number(my_cur.card_logical_id)+1),length(
                    my_cur.card_logical_id),'0');
        v_lock_last:=LPAD(to_char(to_number(my_cur.card_logical_id)-1),length(
                    my_cur.card_logical_id),'0');
       if my_cur.card_logical_id=my_cur.begin_logical_id then
         --À¯ø®∫≈µ»”⁄∆ ºø®∫≈
         v_msg := 'À¯ø®∫≈µ»”⁄∆ ºø®∫≈–ﬁ∏ƒ';
         update op_prm_black_list_mtr_sec set begin_logical_id=v_begin_next
         where begin_logical_id=my_cur.begin_logical_id;
       elsif my_cur.card_logical_id=my_cur.end_logical_id then
         --À¯ø®∫≈µ»”⁄Ω· ¯ø®∫≈
         v_msg := 'À¯ø®∫≈µ»”⁄Ω· ¯ø®∫≈–ﬁ∏ƒ';
         update op_prm_black_list_mtr_sec set end_logical_id=v_end_last
          where end_logical_id=my_cur.end_logical_id;
       else  --À¯ø®∫≈‘⁄∆ ºΩ· ¯÷Æº‰
          v_msg := 'À¯ø®∫≈‘⁄∆ ºΩ· ¯÷Æº‰–ﬁ∏ƒ';
          update op_prm_black_list_mtr_sec set end_logical_id=v_lock_last
          where end_logical_id=my_cur.end_logical_id;
          insert into  op_prm_black_list_mtr_sec select
            sysdate,v_lock_next,my_cur.end_logical_id,black_type,remark,
            action_type,create_datetime,operator_id,is_set from
            op_prm_black_list_mtr_sec
            where begin_logical_id=my_cur.begin_logical_id ;
       end if;
      end loop;
    end;
   END IF;
--∞—∫⁄√˚µ•∂Œ÷–µ•’≈ø®◊™“∆µΩ∫⁄√˚µ•±Ì
select count(*) into v_count from op_prm_black_list_mtr_sec where begin_logical_id=end_logical_id;
if v_count>0 then
    v_msg := '∞—∫⁄√˚µ•∂Œ÷–µ•’≈ø®◊™“∆µΩ∫⁄√˚µ•±Ì ';
    insert into  op_prm_black_list_mtr
    select  sysdate,begin_logical_id,black_type,remark,
     action_type,create_datetime,operator_id,is_set from op_prm_black_list_mtr_sec
     where begin_logical_id=end_logical_id
     and begin_logical_id not in (select card_logical_id from op_prm_black_list_mtr );
    delete op_prm_black_list_mtr_sec where begin_logical_id=end_logical_id;
end if;

--º«√˚ø®π“ ß/Ω‚π“…Í«Î¥¶¿Ì
acc_st.up_st_ist_report_loss(out_retresult,out_msg,in_balance_water_no);

--º«√˚ø®…Í«Î
--¥”up_st_ist_settle_his¥Ê¥¢π˝≥Ã“∆∂ØµΩ∏√¥¶ ver1.35 by lindaquan 20160622
--»°÷ÿ∏¥…Í«Î÷–◊Ó‘Á…Í«Îµƒº«¬º
insert into acc_st.st_list_sign_card(req_no,water_no,line_id,station_id,dev_type_id,device_id,apply_name,apply_sex,identity_type,identity_id,expired_date,tel_no,fax,address,operator_id,apply_datetime,shift_id,card_app_flag,balance_water_no,file_name,check_flag,hdl_time,hdl_flag,order_no,card_main_id,card_sub_id)
select lpad(to_char(acc_st.seq_st_list_sign_card.nextval),10,'0'),t.water_no,t.line_id,t.station_id,t.dev_type_id,t.device_id,
 t.apply_name,t.apply_sex,t.identity_type,t.identity_id,t.expired_date,t.tel_no,t.fax,t.address,t.operator_id,
 t.apply_datetime,t.shift_id,t.card_app_flag,t.balance_water_no,t.file_name,t.check_flag,null, '0', null,
 t.card_main_id,t.card_sub_id
from acc_st.st_que_sign_card_apply t where t.water_no=(
     select min(s.water_no) from acc_st.st_que_sign_card_apply s
     where s.identity_type||s.identity_id = t.identity_type||t.identity_id and s.balance_water_no=in_balance_water_no
) and t.app_business_type='1';

--∫⁄√˚µ•œ¬∑¢π´Ωª
insert into st_ext_mtr_blacklist(water_no,card_logical_id_start,card_logical_id_end,
  sect_flag,card_status,balance_water_no,file_name,check_flag)
 select seq_st_ext_mtr_blacklist.nextval,card_logical_id,'00000000000000000000','0',
 b.card_status_ext,in_balance_water_no,'','0'
from op_prm_black_list_mtr a,st_cfg_black_type_acc_ext b
where a.black_type=b.black_type_acc and b.ext_type='01' ;

insert into st_ext_mtr_blacklist(water_no,card_logical_id_start,card_logical_id_end,
  sect_flag,card_status,balance_water_no,file_name,check_flag)
 select seq_st_ext_mtr_blacklist.nextval,card_logical_id,'00000000000000000000','0',
 '99',in_balance_water_no,'','0'
from op_prm_black_list_mtr
where black_type not in (select black_type_acc from st_cfg_black_type_acc_ext where ext_type='01') ;

insert into st_ext_mtr_blacklist(water_no,card_logical_id_start,card_logical_id_end,
  sect_flag,card_status,balance_water_no,file_name,check_flag)
 select seq_st_ext_mtr_blacklist.nextval,begin_logical_id,end_logical_id,'1',b.card_status_ext,
        in_balance_water_no,'','0'
from op_prm_black_list_mtr_sec a,st_cfg_black_type_acc_ext b
where a.black_type=b.black_type_acc and b.ext_type='01';

insert into st_ext_mtr_blacklist(water_no,card_logical_id_start,card_logical_id_end,
  sect_flag,card_status,balance_water_no,file_name,check_flag)
 select seq_st_ext_mtr_blacklist.nextval,begin_logical_id,end_logical_id,'1','99',in_balance_water_no,'','0'
from op_prm_black_list_mtr_sec
where black_type not in (select black_type_acc from st_cfg_black_type_acc_ext where ext_type='01') ;
--------------∆±ø®—”∆⁄–ﬁ∏ƒ’Àªß±Ì
 v_msg := '∆±ø®—”∆⁄–ﬁ∏ƒ’Àªß±Ì';
 update st_act_svt a set (old_expire_datetime,new_expire_datetime)
   =(select old_expire_datetime,new_expire_datetime
 from st_que_delay b where b.balance_water_no=in_balance_water_no
                           and a.card_logical_id = b.card_logical_id and rownum=1)
 where exists (select 1 from st_que_delay b where b.balance_water_no=in_balance_water_no
                                                  and a.card_logical_id = b.card_logical_id);

 ---ÕÀø®–ﬁ∏ƒ’Àªß±Ì◊¥Ã¨
 v_msg := 'ÕÀø®–ﬁ∏ƒ’Àªß±Ì◊¥Ã¨';
 update st_act_svt a set a.card_status_id='114' where exists (select 1 from st_que_return b
 where b.balance_water_no=in_balance_water_no and  a.card_logical_id=b.card_logical_id );

------…˙≥…Ω¯’æ°¢≥ˆ’æ°¢∏¸–¬¥ÌŒÛ∑«÷ÿ∏¥ ˝æ›
insert into st_err_deal_unique(water_no ,line_id ,station_id ,  dev_type_id ,  device_id,  sam_logical_id,  sam_trade_seq ,deal_datetime,
  card_main_id ,card_sub_id ,  card_logical_id ,card_physical_id ,  card_status_id ,deal_fee,  deal_balance_fee ,card_charge_seq ,
  card_consume_seq ,pay_mode_id ,  receipt_id ,tac ,  entry_line_id ,entry_station_id ,  entry_sam_logical_id ,entry_datetime ,
  operator_id ,shift_id ,last_sam_logical_id,  last_deal_datetime,deal_no_discount_fee ,
  union_year_month,union_bus_num ,  union_metro_num ,union_total_num ,  trade_sort , card_area_code ,  card_area_type ,overdraft_fee ,
  card_cpu_flag ,card_expired_flag ,  tct_valid_days ,tct_activate_datetime,   limit_mode , limit_entry_station ,  limit_exit_station, card_app_flag ,
  balance_water_no , file_name ,check_flag,err_code,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode)
 select water_no ,line_id ,station_id ,  dev_type_id ,  device_id,  sam_logical_id,  sam_trade_seq ,deal_datetime,
  card_main_id ,card_sub_id ,  card_logical_id ,card_physical_id ,  card_status_id ,deal_fee,  deal_balance_fee ,card_charge_seq ,
  card_consume_seq ,pay_mode_id ,  receipt_id ,tac ,  entry_line_id ,entry_station_id ,  entry_sam_logical_id ,entry_datetime ,
  operator_id ,shift_id ,last_sam_logical_id,  last_deal_datetime,deal_no_discount_fee ,
  union_year_month,union_bus_num ,  union_metro_num ,union_total_num ,  trade_sort , card_area_code ,  card_area_type ,overdraft_fee ,
  card_cpu_flag ,card_expired_flag ,  tct_valid_days ,tct_activate_datetime,   limit_mode , limit_entry_station ,  limit_exit_station, card_app_flag ,
  balance_water_no , file_name ,check_flag,err_code,city_code,business_code,tac_deal_type,tac_dev_id,work_mode,card_app_mode
 from st_err_deal
 where balance_water_no =in_balance_water_no  and err_code !='42';

insert into st_err_entry_unique(water_no,line_id,station_id ,dev_type_id,  device_id ,sam_logical_id ,sam_trade_seq , card_main_id ,
  card_sub_id,card_logical_id,card_physical_id, entry_datetime,  card_status_id ,balance_fee ,
  union_year_month,union_total_num ,union_bus_num ,union_metro_num,card_charge_seq ,card_consume_seq ,
  tac ,pay_mode_id ,last_sam_logical_id ,  last_datetime ,trade_sort ,card_area_code ,card_area_type,
  overdraft_limit_fee ,  card_physical_type ,  card_expired_flag ,tct_valid_days ,
  tct_activate_datetime ,limit_mode,limit_entry_station,limit_exit_station ,
  balance_water_no,card_app_flag,file_name ,check_flag ,   err_code,work_mode,card_app_mode)
  select  water_no,line_id,station_id ,dev_type_id,  device_id ,sam_logical_id ,sam_trade_seq , card_main_id ,
  card_sub_id,card_logical_id,card_physical_id, entry_datetime,  card_status_id ,balance_fee ,
  union_year_month,union_total_num ,union_bus_num ,union_metro_num,card_charge_seq ,card_consume_seq ,
  tac ,pay_mode_id ,last_sam_logical_id ,  last_datetime ,trade_sort ,card_area_code ,card_area_type,
  overdraft_limit_fee ,  card_physical_type ,  card_expired_flag ,tct_valid_days ,
  tct_activate_datetime ,limit_mode,limit_entry_station,limit_exit_station ,
  balance_water_no,card_app_flag,file_name ,check_flag ,   err_code,work_mode,card_app_mode
  from st_err_entry
  where balance_water_no =in_balance_water_no  and err_code !='42';

insert into st_err_update_unique ( water_no ,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,card_logical_id,
  card_physical_id,card_consume_seq,card_status_id ,update_area , update_reason_id , update_datetime ,
  pay_type,penalty_fee,receipt_id,operator_id,entry_line_id,entry_station_id,shift_id ,union_year_month , union_bus_num , union_metro_num ,
  union_total_num ,balance_fee ,deal_no_dicount_fee ,card_charge_seq ,tac ,pay_mode_id ,entry_sam_logical_id ,entry_time ,
  last_sam_logical_id ,last_datetime ,trade_sort ,card_area_code ,card_area_type ,overdraft_limit_fee ,card_physical_type ,
  card_expired_flag ,tct_valid_days ,tct_activate_datetime , card_app_flag ,limit_mode , limit_entry_station , limit_exit_station ,
  balance_water_no , file_name , check_flag , err_code,card_app_mode)
select
  water_no ,line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,card_main_id,card_sub_id,card_logical_id,
  card_physical_id,card_consume_seq,card_status_id ,update_area , update_reason_id , update_datetime ,
  pay_type,penalty_fee,receipt_id,operator_id,entry_line_id,entry_station_id,shift_id ,union_year_month , union_bus_num , union_metro_num ,
  union_total_num ,balance_fee ,deal_no_dicount_fee ,card_charge_seq ,tac ,pay_mode_id ,entry_sam_logical_id ,entry_time ,
  last_sam_logical_id ,last_datetime ,trade_sort ,card_area_code ,card_area_type ,overdraft_limit_fee ,card_physical_type ,
  card_expired_flag ,tct_valid_days ,tct_activate_datetime , card_app_flag ,limit_mode , limit_entry_station , limit_exit_station ,
  balance_water_no , file_name , check_flag , err_code,card_app_mode
  from st_err_update
  where balance_water_no =in_balance_water_no  and err_code !='42';

  ------…˙≥…≥¡µÌ◊ ΩÕ≥º∆±Ì
    v_msg := '≤Â»Î±Ìt#st_ist_settle_income_balance¿€º∆”‡∂Ó°¢—∫Ω';
    insert into t#st_ist_settle_income_balance
   select in_balance_water_no,card_main_id,card_sub_id,count(*),sum(a.card_balance_fee),sum(deposit_fee)
   from st_act_svt a where card_main_id in (select card_main_id from op_prm_svt_type)  --ver1.13‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
   group by  card_main_id ,card_sub_id;

    v_msg := '≤Â»Î±Ìt#st_ist_settle_income_balance∂”¡–±ÌÕÀø®”‡∂Ó°¢—∫Ω';
    insert into t#st_ist_settle_income_balance
   select in_balance_water_no,card_main_id,card_sub_id,count(*)*-1,sum(return_balance_fee)*-1,sum(return_deposit_fee)*-1
   from st_que_return where balance_water_no =in_balance_water_no
   and card_main_id in (select card_main_id from op_prm_svt_type)  --ver1.13‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
    group by card_main_id ,card_sub_id;

   v_msg := '≤Â»Î±Ìt#st_ist_settle_income_balance¿˙ ∑±ÌÕÀø®”‡∂Ó°¢—∫Ω';
    insert into t#st_ist_settle_income_balance
   select in_balance_water_no,card_main_id,card_sub_id,count(*)*-1,sum(return_balance_fee)*-1,sum(return_deposit_fee)*-1
   from acc_st_his.st_his_return where card_main_id in (select card_main_id from op_prm_svt_type)  --ver1.13‘ˆº”“Ï–Œø®∫Õ ÷ª˙ø®
    group by card_main_id ,card_sub_id;

    v_msg := '≤Â»Î≥¡µÌ◊ ΩÕ≥º∆±Ìst_sts_inc_balance';
    insert into st_sts_inc_balance
    select  seq_st_sts_inc_balance.nextval,balance_water_no ,card_main_id, card_sub_id,total_num,total_bal_fee,total_deposit_fee
  from
    (select in_balance_water_no as balance_water_no,card_main_id,card_sub_id,
    sum(total_num) as total_num,sum(total_bal_fee) as total_bal_fee , sum(total_deposit_fee) as  total_deposit_fee
   from t#st_ist_settle_income_balance
   group by card_main_id ,card_sub_id);

  -----------∑«º¥ ±ÕÀøÓ…Í«Î¥¶¿Ì
   v_msg := '»°∑«º¥ ±ÕÀøÓ…Í«Îµ»¥˝∆⁄';
   select cfg_value into v_no_return_day  from ST_CFG_SYS_BASE where cfg_key='sys.non_return_day' and record_flag='0';
  v_msg := '∑«º¥ ±ÕÀøÓ…Í«Î≤Â»Î∑«º¥ ±ÕÀøÓ¥˝¥¶¿Ì±Ì';
    insert into  st_list_non_rtn
  select seq_st_list_non_rtn.nextval,line_id,station_id,dev_type_id,device_id,card_main_id,card_sub_id,card_logical_id,
  card_physical_id,card_print_id,apply_datetime,receipt_id,operator_id,apply_name,tel_no,identity_type,identity_id,is_broken,
  shift_id,card_app_flag,balance_water_no,'2',null,null,null,null,null,null,null,null,null,null,null,null,null,'1'
  from st_que_non_rtn_app a where  a.balance_water_no =in_balance_water_no
                          and  not exists  (select 1 from st_list_non_rtn b
                             where a.card_logical_id=b.card_logical_id and a.apply_datetime=b.apply_datetime);

  --∏¸–¬Ω∂ÓµΩ∑«º¥ ±ÕÀøÓ¥¶¿Ì±Ì
  MERGE INTO acc_st.st_list_non_rtn x
  USING acc_st.st_act_svt y
  ON (x.hdl_flag='2'
      and x.card_logical_id=y.card_logical_id)
  WHEN MATCHED THEN
  UPDATE
  SET x.deposit_fee = y.deposit_fee,
      x.card_balance_fee = y.card_balance_fee,
      x.system_balance_fee = y.system_balance_fee;
  --¥¢÷µø®÷ÿ”√ ±£¨…Í«Î ±º‰–°”⁄÷ÿ”√÷ÿ±‡¬Î…˙–ß ±º‰µƒ ˝æ›∏¸–¬Œ™æ…’Àªß ˝æ› ver1.42
  MERGE INTO acc_st.st_list_non_rtn x
  USING (select a.*,b.again_time from(
           select ROW_NUMBER() OVER(PARTITION BY card_logical_id ORDER BY max_deal_time DESC) rn,
           card_logical_id,deposit_fee,card_balance_fee,system_balance_fee
           from acc_st.st_act_svt_old) a,
           (select card_logical_id, max(again_time) again_time from acc_st.st_act_svt_again group by card_logical_id) b
         where a.rn=1 and a.card_logical_id=b.card_logical_id
        )y
  ON (x.hdl_flag='2' and x.apply_datetime<y.again_time
      and x.card_logical_id=y.card_logical_id)
  WHEN MATCHED THEN
  UPDATE
  SET x.deposit_fee = y.deposit_fee,
      x.card_balance_fee = y.card_balance_fee,
      x.system_balance_fee = y.system_balance_fee;

  --≤˙…˙∑«º¥ ±ÕÀøÓΩª“◊º«¬º
  v_msg:='∑«º¥ ±ÕÀøÓ';
  declare  cursor cur_1 is --∂®“Â”Œ±Í»°ø®∫≈
        select card_logical_id from st_list_non_rtn where hdl_flag='2' and
        Round(sysdate)-Round(apply_datetime) >=v_no_return_day
        and card_logical_id not in (select card_logical_id from op_non_return_tk_hist);
  begin
     for my_cur1 in cur_1 loop
            --∆±ø®¬ﬂº≠ø®∫≈≤ª‘⁄st_act_svt±Ì ±£¨∏¸–¬¥¶¿Ì±Í÷æ∏ƒŒ™'8'£®–¬‘ˆ8£∫ø®∫≈∑«∑®:’Àªß≤ª¥Ê‘⁄º∞√ª”–∑¢––°¢Ωª“◊º«¬º£© add in 20150911 by lindaquan
            update acc_st.st_list_non_rtn b set b.hdl_flag='8', b.audit_flag='1' where not exists (
                  select a.card_logical_id from st_act_svt a where a.card_logical_id = my_cur1.card_logical_id
            ) and b.hdl_flag='2' and b.card_logical_id = my_cur1.card_logical_id;
            up_st_ist_gen_non_return_list(out_retresult,out_msg,my_cur1.card_logical_id,in_balance_water_no);
     end loop;
  end;
 commit;
 out_msg :='success';
 out_retresult:=0;
    exception
    when OTHERS THEN
     begin
       ROLLBACK;
       if v_msg!='∑«º¥ ±ÕÀøÓ' then
         out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
         out_retresult := sqlcode;
       end if;
       return;
     end;
   END;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_OTHER to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_OUT
prompt =======================================
prompt
create or replace procedure acc_st.up_st_ist_settle_out
(  out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_out
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-≤˙…˙Õ‚≤ø∂‘’À÷–º‰±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
        --ver1.13 Õ‚≤øœµÕ≥∑µªÿΩ·π˚∏ƒŒ™»°…œ“ª¥Œµƒ¡˜ÀÆ∫≈ ∏¸–¬»’∆⁄2014-8-23
        --ver1.14 »°…œ“ª¥Œµƒ¡˜ÀÆ∫≈ ±÷∏∂®–°”⁄±æ¥Œ¡˜ÀÆ∫≈ ∏¸–¬»’∆⁄2015-3-31
        --ver1.15 ‘⁄≤Â»Îst_sts_diff_analysis«∞œ»«Â≥˝   ∏¸–¬»’∆⁄2015-4-1
        --ver1.36 ¥Ê‘⁄»∑»œ ˝æ› ±£¨∏¸–¬»∑»œ ˝æ›Œ™0 20160713 by lindaquan
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_operator_id varchar2(20);
   v_last_balance char(10); --…œ“ª¥Œ∫⁄√˚¡˜ÀÆ∫≈
   v_last_balance_audit char(10);--…œ“ª¥ŒÕ‚≤øœµÕ≥∑µªÿ¡˜ÀÆ∫≈ ver1.13 2014-8-23
begin
select count(*) into v_count from st_ext_mtr_audit_balance where balance_water_no=in_balance_water_no;
  if v_count > 0 then
      out_msg := 'st_ext_mtr_audit_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
select count(*) into v_count from st_sts_mtr_audit_balance  where balance_water_no=in_balance_water_no;
  if v_count > 0 then
      out_msg := 'st_sts_mtr_audit_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;

select count(*) into v_count from st_ext_mtr_err_trade where balance_water_no=in_balance_water_no;
  if v_count > 0 then
      out_msg := 'st_sts_mtr_audit_balance“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„£°';
      out_retresult := - 1;
      return;
   end if;
 select max(balance_water_no) into v_last_balance from st_ext_oct_blacklist;
---------------------------------------accÀÕ≥ˆ÷¡Õ‚≤øœµÕ≥-------------------------------------------
-----accÀÕ≥ˆ∑¢ €
   v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎaccÀÕ≥ˆ∑¢ €';
   insert into t#st_ist_settle_out_rpt(
           balance_water_no, out_deal_type, acc_send_num, acc_send_fee,
           out_affirm_num, out_affirm_fee, error_id, error_num, error_fee,sys_type)
    select balance_water_no, 'a',count(*),sum(nvl(deposit_fee,0)),0,0,'',0,0, '01'
    from st_que_sale_oct
    where balance_water_no = in_balance_water_no
    group by  balance_water_no;
------accÀÕ≥ˆœ˚∑—°¢≥‰÷µ
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎaccÀÕ≥ˆœ˚∑—°¢≥‰÷µ';
    insert into  t#st_ist_settle_out_rpt(
           balance_water_no, out_deal_type,acc_send_num, acc_send_fee,
           out_affirm_num, out_affirm_fee, error_id, error_num, error_fee,sys_type)
        select balance_water_no,pay_mode_id,count(*),sum(nvl(deal_fee,0)),0,0,'',0,0,'01'
        from st_que_deal_oct
        where balance_water_no = in_balance_water_no
        group by  balance_water_no,pay_mode_id;
 ---------------------------------------------------------Õ‚≤øœµÕ≥∑µªÿ’˝»∑--------------------------------
    select max(balance_water_no) into v_last_balance_audit from st_ext_oct_audit_balance
    where balance_water_no<in_balance_water_no;--ver1.14 »°…œ“ª¥Œµƒ¡˜ÀÆ∫≈ ±÷∏∂®–°”⁄±æ¥Œ¡˜ÀÆ∫≈
    update st_ext_oct_audit_balance set in_flag='0' where balance_water_no=v_last_balance_audit;--ver1.13–ﬁ∏ƒŒ™…œ“ª¥Œ¡˜ÀÆ∫≈
    update st_ext_oct_err_trade set in_flag='0' where balance_water_no=v_last_balance_audit;--ver1.13–ﬁ∏ƒŒ™…œ“ª¥Œ¡˜ÀÆ∫≈

    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ’˝»∑';
   insert into  t#st_ist_settle_out_rpt --ver1.13 Õ‚≤øœµÕ≥∑µªÿΩ·π˚∏ƒŒ™»°…œ“ª¥Œµƒ¡˜ÀÆ∫≈
    select balance_water_no,pay_mode_id ,0,0,sum(nvl(to_number(total_deal_num),0)), sum(nvl(to_number(total_deal_fee),0)),'',0,0,'01'
    from st_ext_oct_audit_balance
    where balance_water_no = v_last_balance_audit and in_flag='0'
    group by  balance_water_no,pay_mode_id;
  -------------------------------------------Õ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ--------------------------------
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ';
   insert into  t#st_ist_settle_out_rpt --ver1.13 Õ‚≤øœµÕ≥∑µªÿΩ·π˚∏ƒŒ™»°…œ“ª¥Œµƒ¡˜ÀÆ∫≈
    select balance_water_no,'42',0,0,0,0,err_code,count(*),sum(nvl(deal_fee,0)),'01'
    from st_ext_oct_err_trade
    where balance_water_no = v_last_balance_audit and in_flag='0'
    group by  balance_water_no,err_code;
     --------------------------------------…˙≥…st_sts_diff_analysis
     --…æ≥˝st_sts_diff_analysisµƒaccÀÕ≥ˆ  v1.15‘ˆº” 2015-4-1
    delete st_sts_diff_analysis where balance_water_no=in_balance_water_no and acc_send_num!=0 ;
     --…æ≥˝st_sts_diff_analysisµƒoct»∑»œ£®«∞“ª»’£© v1.15‘ˆº” 2015-4-1
    delete st_sts_diff_analysis where balance_water_no=v_last_balance_audit  and acc_send_num=0 ;
     --¥Ê‘⁄»∑»œ ˝æ› ±£¨∏¸–¬»∑»œ ˝æ›Œ™0 ver1.36
    update st_sts_diff_analysis set OUT_AFFIRM_NUM=0,OUT_AFFIRM_FEE=0
           where balance_water_no=v_last_balance_audit;

    v_msg := 'œÚ st_sts_diff_analysis±Ì≤Â»Îª„◊‹ ˝æ›';
   insert into  st_sts_diff_analysis
   select seq_sts_diff_analysis.nextval,balance_water_no,out_deal_type ,acc_send_num,acc_send_fee ,out_affirm_num ,
        out_affirm_fee,error_id,error_num ,error_fee,sys_type
   from
   (select   balance_water_no,out_deal_type, sum(acc_send_num ) acc_send_num,sum(acc_send_fee ) acc_send_fee,
   sum(out_affirm_num) out_affirm_num,sum(out_affirm_fee) out_affirm_fee,error_id ,sum(error_num) error_num,
   sum(error_fee) error_fee,sys_type
   from t#st_ist_settle_out_rpt
   group by balance_water_no,out_deal_type,error_id , sys_type );
------------–ﬁ∏ƒÕ‚≤øœµÕ≥∑µªÿ±Ì»Îø‚±Í÷æ
v_msg := '–ﬁ∏ƒst_ext_oct_audit_balance±Ì»Îø‚±Í÷æ'; --ver1.13 Õ‚≤øœµÕ≥∑µªÿΩ·π˚∏ƒŒ™»°…œ“ª¥Œµƒ¡˜ÀÆ∫≈
update st_ext_oct_audit_balance set in_flag='1' where balance_water_no = v_last_balance_audit and  in_flag='0';
v_msg := '–ﬁ∏ƒst_ext_oct_err_trade±Ì»Îø‚±Í÷æ';
update st_ext_oct_err_trade set in_flag='1' where balance_water_no = v_last_balance_audit and  in_flag='0';

---≤˙…˙Õ‚≤øœµÕ≥∫⁄√˚µ•
select user into v_operator_id from dual;

delete op_prm_black_list_oct;
delete op_prm_black_list_oct_sec;

v_msg := '≤Â»Îop_prm_black_list_oct±Ì';
insert into  op_prm_black_list_oct
(gen_datetime,card_logical_id ,black_type ,remark ,action_type ,create_datetime,operator_id,is_set)
select distinct sysdate,card_logical_id_start,card_status,null,'000',sysdate,v_operator_id,'0'
from st_ext_oct_blacklist where sect_flag='0' and balance_water_no=v_last_balance;

v_msg := '≤Â»Îop_prm_black_list_oct_sec±Ì';
insert into  op_prm_black_list_oct_sec
(gen_datetime,begin_logical_id,end_logical_id,black_type ,remark ,action_type ,create_datetime,operator_id,is_set)
select  distinct  sysdate,card_logical_id_start ,card_logical_id_end,card_status,null,'000',sysdate,v_operator_id,'0'
from st_ext_oct_blacklist where sect_flag='1' and balance_water_no=v_last_balance;

delete st_ext_oct_blacklist where  balance_water_no=v_last_balance;

------------µÿÃ˙ø®‘⁄π´Ωªµƒœ˚∑—¥¶¿Ì----------------------------------------------
  ---…˙≥…µÿÃ˙ÀÕ≥ˆµƒΩª“◊«ÂÀ„Ω·π˚
  v_msg := 'œÚst_ext_mtr_audit_balance±Ì≤Â»Îª„◊‹ ˝æ›';

  delete st_ext_mtr_audit_balance;

  insert into  st_ext_mtr_audit_balance select seq_st_ext_mtr_audit_balance.nextval,
  sam_logical_id,pay_mode_id,total_deal_num,total_deal_fee,balance_water_no, file_name,   check_flag
  from (select sam_logical_id,   pay_mode_id,count(*) as total_deal_num,sum(nvl(deal_fee,0)) as total_deal_fee,
  balance_water_no, file_name,   check_flag
  from st_ext_mtr_que_deal where balance_water_no = in_balance_water_no
  group by sam_logical_id,pay_mode_id,balance_water_no,file_name,check_flag);

  v_msg := 'œÚst_sts_mtr_audit_balance±Ì≤Â»Îª„◊‹ ˝æ›';
  insert into  st_sts_mtr_audit_balance select seq_st_sts_mtr_audit_balance.nextval,
  sam_logical_id,pay_mode_id,total_deal_num,total_deal_fee,   balance_water_no,
  file_name,check_flag from st_ext_mtr_audit_balance ;

  v_msg := 'œÚst_ext_mtr_err_trade±Ì≤Â»Î ˝æ›';
  delete st_ext_mtr_err_trade;
  insert into  st_ext_mtr_err_trade select seq_st_ext_mtr_err_trade.nextval,
   sam_logical_id,  sam_trade_seq, card_logical_id,card_physical_id ,
  deal_datetime, b.err_code_ext ,balance_water_no, file_name, check_flag , deal_fee,pay_mode_id
  from st_ext_mtr_err_deal a£¨st_cfg_err_acc_ext b
  where a.balance_water_no = in_balance_water_no
        and a.err_code=b.err_code_acc and b.ext_type='01'; --'01'π´Ωª

 commit;
 out_msg :='success';
 out_retresult:=0;
 exception
 when others then
 begin
    rollback;
    out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
    out_retresult := sqlcode;
    return;
 end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_OUT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_OUT_TMP
prompt ===========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_out_tmp
(  out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2 --∑µªÿ–≈œ¢
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_out
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-≤˙…˙Õ‚≤ø∂‘’À÷–º‰±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
begin


 ---------------------------------------------------------Õ‚≤øœµÕ≥∑µªÿ’˝»∑--------------------------------
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ’˝»∑';
   insert into  t#st_ist_settle_out_rpt
    select a.balance_water_no,a.pay_mode_id ,0,0,count(*), sum(nvl(to_number(total_deal_fee),0)),'',0,0,'01'
    from st_ext_oct_audit_balance a
    where in_flag='0'
    group by  a.balance_water_no,a.pay_mode_id;
  -------------------------------------------Õ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ--------------------------------
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ';
   insert into  t#st_ist_settle_out_rpt
    select a.balance_water_no,b.pay_mode_id,0,0,0,0,a.err_code,count(*),sum(nvl(b.deal_fee,0)),'01'
    from st_ext_oct_err_trade a,acc_st_his.st_his_deal_oct b
    where a.in_flag='0' and a.balance_water_no=b.balance_water_no
    and a.sam_logical_id=b.sam_logical_id and a.sam_trade_seq=b.sam_trade_seq
    group by  a.balance_water_no,b.pay_mode_id,a.err_code;
     --------------------------------------…˙≥…st_sts_diff_analysis
    v_msg := 'œÚ st_sts_diff_analysis±Ì≤Â»Îª„◊‹ ˝æ›';
   insert into  st_sts_diff_analysis
   select seq_sts_diff_analysis.nextval,balance_water_no,out_deal_type ,acc_send_num,acc_send_fee ,out_affirm_num ,
        out_affirm_fee,error_id,error_num ,error_fee,sys_type
   from
   (select   balance_water_no,out_deal_type, sum(acc_send_num ) acc_send_num,sum(acc_send_fee ) acc_send_fee,
   sum(out_affirm_num) out_affirm_num,sum(out_affirm_fee) out_affirm_fee,error_id ,sum(error_num) error_num,
   sum(error_fee) error_fee,sys_type from t#st_ist_settle_out_rpt
   group by balance_water_no,out_deal_type,error_id , sys_type );
------------–ﬁ∏ƒÕ‚≤øœµÕ≥∑µªÿ±Ì»Îø‚±Í÷æ
v_msg := '–ﬁ∏ƒst_ext_oct_audit_balance±Ì»Îø‚±Í÷æ';
update st_ext_oct_audit_balance set in_flag='1' where in_flag='0';
v_msg := '–ﬁ∏ƒst_ext_oct_err_trade±Ì»Îø‚±Í÷æ';
update st_ext_oct_err_trade set in_flag='1' where in_flag='0';


  
 commit;
 out_msg :='success';
 out_retresult:=0;
 exception
 when others then
 begin
    rollback;
    out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
    out_retresult := sqlcode;
    return;
 end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_OUT_TMP_1
prompt =============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_out_tmp_1
(  out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2 --∑µªÿ–≈œ¢
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_out
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-≤˙…˙Õ‚≤ø∂‘’À÷–º‰±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_operator_id varchar2(20);
begin
---------------------------------------accÀÕ≥ˆ÷¡Õ‚≤øœµÕ≥-------------------------------------------
-----accÀÕ≥ˆ∑¢ €
   v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎaccÀÕ≥ˆ∑¢ €';
   insert into t#st_ist_settle_out_rpt(
           balance_water_no, out_deal_type, acc_send_num, acc_send_fee,
           out_affirm_num, out_affirm_fee, error_id, error_num, error_fee,sys_type)
    select a.balance_water_no, 'a',count(*),sum(nvl(deposit_fee,0)),0,0,'',0,0, '01'
    from st_que_sale_oct a
    group by  a.balance_water_no;
------accÀÕ≥ˆœ˚∑—°¢≥‰÷µ
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎaccÀÕ≥ˆœ˚∑—°¢≥‰÷µ';
    insert into  t#st_ist_settle_out_rpt(
           balance_water_no, out_deal_type,acc_send_num, acc_send_fee,
           out_affirm_num, out_affirm_fee, error_id, error_num, error_fee,sys_type)
        select a.balance_water_no,a.pay_mode_id,count(*),sum(nvl(deal_fee,0)),0,0,'',0,0,'01'
        from st_que_deal_oct  a
        group by  a.balance_water_no,pay_mode_id;
---------------------------------------------------------Õ‚≤øœµÕ≥∑µªÿ’˝»∑--------------------------------
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ’˝»∑';
   insert into  t#st_ist_settle_out_rpt
    select a.balance_water_no,a.pay_mode_id ,0,0,sum(nvl(to_number(total_deal_num),0)), sum(nvl(to_number(total_deal_fee),0)),'',0,0,'01'
    from st_ext_oct_audit_balance a
    where in_flag='0'
    group by  a.balance_water_no,a.pay_mode_id;
  -------------------------------------------Õ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ--------------------------------
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ';
   insert into  t#st_ist_settle_out_rpt
    select balance_water_no,'42',0,0,0,0,err_code,count(*),sum(nvl(deal_fee,0)),'01'
    from st_ext_oct_err_trade 
    where in_flag='0' 
    group by  balance_water_no,err_code;
     --------------------------------------…˙≥…st_sts_diff_analysis
    v_msg := 'œÚ st_sts_diff_analysis±Ì≤Â»Îª„◊‹ ˝æ›';
   insert into  st_sts_diff_analysis
   select seq_sts_diff_analysis.nextval,balance_water_no,out_deal_type ,acc_send_num,acc_send_fee ,out_affirm_num ,
        out_affirm_fee,error_id,error_num ,error_fee,sys_type
   from
   (select   balance_water_no,out_deal_type, sum(acc_send_num ) acc_send_num,sum(acc_send_fee ) acc_send_fee,
   sum(out_affirm_num) out_affirm_num,sum(out_affirm_fee) out_affirm_fee,error_id ,sum(error_num) error_num,
   sum(error_fee) error_fee,sys_type from t#st_ist_settle_out_rpt
   group by balance_water_no,out_deal_type,error_id , sys_type );
------------–ﬁ∏ƒÕ‚≤øœµÕ≥∑µªÿ±Ì»Îø‚±Í÷æ
v_msg := '–ﬁ∏ƒst_ext_oct_audit_balance±Ì»Îø‚±Í÷æ';
update st_ext_oct_audit_balance set in_flag='1' where in_flag='0';
v_msg := '–ﬁ∏ƒst_ext_oct_err_trade±Ì»Îø‚±Í÷æ';
update st_ext_oct_err_trade set in_flag='1' where in_flag='0';

---≤˙…˙Õ‚≤øœµÕ≥∫⁄√˚µ•
/*
select user into v_operator_id from dual;
delete op_prm_black_list_oct;
delete op_prm_black_list_oct_sec;

insert into  op_prm_black_list_oct
(gen_datetime,card_logical_id ,black_type ,remark ,action_type ,create_datetime,operator_id,is_set)
select sysdate,card_logical_id_start,card_status,null,'000',sysdate,v_operator_id,'0' 
from st_ext_oct_blacklist where sect_flag='0';

insert into  op_prm_black_list_oct_sec
(gen_datetime,begin_logical_id,end_logical_id,black_type ,remark ,action_type ,create_datetime,operator_id,is_set)
select sysdate,card_logical_id_start ,card_logical_id_end,card_status,null,'000',sysdate,v_operator_id,'0' 
from st_ext_oct_blacklist where sect_flag='1'; 
*/
  
 commit;
 out_msg :='success';
 out_retresult:=0;
 exception
 when others then
 begin
    rollback;
    out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
    out_retresult := sqlcode;
    return;
 end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_OUT_TMP_2
prompt =============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_out_tmp_2
(  out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2 ,--∑µªÿ–≈œ¢
   in_balance_water_no in varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_out
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-≤˙…˙Õ‚≤ø∂‘’À÷–º‰±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_operator_id varchar2(20);
begin
------------µÿÃ˙ø®‘⁄π´Ωªµƒœ˚∑—¥¶¿Ì----------------------------------------------
 ---…˙≥…µÿÃ˙ÀÕ≥ˆµƒΩª“◊«ÂÀ„Ω·π˚
  v_msg := 'œÚst_ext_mtr_audit_balance±Ì≤Â»Îª„◊‹ ˝æ›';
  --ªÿπˆΩ·À„Ω·π˚
  delete st_ext_mtr_audit_balance where balance_water_no=in_balance_water_no;
  
  insert into	st_ext_mtr_audit_balance 
             select seq_st_ext_mtr_audit_balance.nextval,
                    sam_logical_id,pay_mode_id,total_deal_num,total_deal_fee,balance_water_no, file_name, 	check_flag                  
             from (select sam_logical_id, 	pay_mode_id,count(*) as total_deal_num,sum(nvl(deal_fee,0)) as total_deal_fee,
                   balance_water_no, file_name, 	check_flag 
                   from st_ext_mtr_que_deal  
                   where balance_water_no=in_balance_water_no
                    group by sam_logical_id,pay_mode_id,balance_water_no,file_name,check_flag);
  
  v_msg := 'œÚst_sts_mtr_audit_balance±Ì≤Â»Îª„◊‹ ˝æ›';
  insert into	st_sts_mtr_audit_balance 
              select seq_st_sts_mtr_audit_balance.nextval,
                     sam_logical_id,pay_mode_id,total_deal_num,total_deal_fee, 	balance_water_no, 
	                   file_name,check_flag 
                       from st_ext_mtr_audit_balance 
                       where balance_water_no=in_balance_water_no;
 
  v_msg := 'œÚst_ext_mtr_err_trade±Ì≤Â»Î ˝æ›';
  --ªÿπˆ¥ÌŒÛº«¬º
  delete st_ext_mtr_err_trade where balance_water_no=in_balance_water_no;
  
  
  insert into	st_ext_mtr_err_trade 
               select seq_st_ext_mtr_err_trade.nextval,
                      sam_logical_id,	sam_trade_seq, card_logical_id,card_physical_id , 
	                    deal_datetime, b.err_code_ext ,balance_water_no, file_name, check_flag , deal_fee,pay_mode_id
               from st_ext_mtr_err_deal a£¨st_cfg_err_acc_ext b 
               where a.err_code=b.err_code_acc and b.ext_type='01' --'01'π´Ωª 
                    and a.balance_water_no=in_balance_water_no;
  
 commit;
 out_msg :='success';
 out_retresult:=0;
 exception
 when others then
 begin
    rollback;
    out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
    out_retresult := sqlcode;
    return;
 end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_OUT_TMP_3
prompt =============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_out_tmp_3
(  out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2 ,--∑µªÿ–≈œ¢
   in_balance_water_no in varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_out
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-≤˙…˙Õ‚≤ø∂‘’À÷–º‰±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_operator_id varchar2(20);
begin

insert into acc_st_his.st_ext_mtr_his_deal(water_no,line_id ,station_id ,dev_type_id,device_id ,sam_logical_id,	sam_trade_seq , deal_datetime , card_main_id , card_sub_id , card_logical_id , 
	card_physical_id , card_status_id , deal_fee , deal_balance_fee ,	card_charge_seq ,card_consume_seq , pay_mode_id , receipt_id , 
	tac , entry_line_id , entry_station_id ,entry_sam_logical_id , 	entry_datetime , operator_id , shift_id , last_sam_logical_id , 
	last_deal_datetime , deal_no_discount_fee ,union_year_month ,union_bus_num , union_metro_num , 
	union_total_num ,trade_sort ,card_area_code ,card_area_type ,overdraft_fee ,	card_cpu_flag , 
	card_expired_flag ,	tct_valid_days ,tct_activate_datetime , limit_mode ,limit_entry_station , 
	limit_exit_station , card_app_flag , balance_water_no ,	file_name , check_flag , city_code , 
	business_code ,	tac_deal_type , tac_dev_id  , work_mode , card_app_mode )
select seq_st_ext_mtr_his_deal.nextval, line_id ,station_id ,dev_type_id,device_id ,sam_logical_id,	sam_trade_seq , deal_datetime , card_main_id , card_sub_id , card_logical_id , 
	card_physical_id , card_status_id , deal_fee , deal_balance_fee ,	card_charge_seq ,card_consume_seq , pay_mode_id , receipt_id , 
	tac , entry_line_id , entry_station_id ,entry_sam_logical_id , 	entry_datetime , operator_id , shift_id , last_sam_logical_id , 
	last_deal_datetime , deal_no_discount_fee ,union_year_month ,union_bus_num , union_metro_num , 
	union_total_num ,trade_sort ,card_area_code ,card_area_type ,overdraft_fee ,	card_cpu_flag , 
	card_expired_flag ,	tct_valid_days ,tct_activate_datetime , limit_mode ,limit_entry_station , 
	limit_exit_station , card_app_flag , balance_water_no ,	file_name , check_flag , city_code , 
	business_code ,	tac_deal_type , tac_dev_id  , work_mode , card_app_mode
from   st_ext_mtr_que_deal where balance_water_no=in_balance_water_no;

delete st_ext_mtr_que_deal where balance_water_no=in_balance_water_no;

  
 commit;
 out_msg :='success';
 out_retresult:=0;
 exception
 when others then
 begin
    rollback;
    out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
    out_retresult := sqlcode;
    return;
 end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_OUT_TMP_4
prompt =============================================
prompt
create or replace procedure acc_st.up_st_ist_settle_out_tmp_4
(  out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2 ,--∑µªÿ–≈œ¢
   in_balance_water_no varchar2 --«ÂÀ„¡˜ÀÆ∫≈
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_out
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-≤˙…˙Õ‚≤ø∂‘’À÷–º‰±Ì
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫hejj 2014060201
--–ﬁ∏ƒƒ⁄»›£∫∏ƒŒ™µ•«ÂÀ„¡˜ÀÆ∫≈°¢÷±Ω”»°¿˙ ∑±Ì
-------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_operator_id varchar2(20);
begin
---------------------------------------accÀÕ≥ˆ÷¡Õ‚≤øœµÕ≥-------------------------------------------
-----accÀÕ≥ˆ∑¢ €
   v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎaccÀÕ≥ˆ∑¢ €';
   insert into t#st_ist_settle_out_rpt(
           balance_water_no, out_deal_type, acc_send_num, acc_send_fee,
           out_affirm_num, out_affirm_fee, error_id, error_num, error_fee,sys_type)
    select a.balance_water_no, 'a',count(*),sum(nvl(deposit_fee,0)),0,0,'',0,0, '01'
    from acc_st_his.st_his_sale_oct a
    where balance_water_no =in_balance_water_no
    group by  a.balance_water_no;
    
    
------accÀÕ≥ˆœ˚∑—°¢≥‰÷µ
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎaccÀÕ≥ˆœ˚∑—°¢≥‰÷µ';
    insert into  t#st_ist_settle_out_rpt(
           balance_water_no, out_deal_type,acc_send_num, acc_send_fee,
           out_affirm_num, out_affirm_fee, error_id, error_num, error_fee,sys_type)
        select a.balance_water_no,a.pay_mode_id,count(*),sum(nvl(deal_fee,0)),0,0,'',0,0,'01'
        from acc_st_his.st_his_deal_oct  a
        where balance_water_no =in_balance_water_no
        group by  a.balance_water_no,pay_mode_id;
        
        
---------------------------------------------------------Õ‚≤øœµÕ≥∑µªÿ’˝»∑--------------------------------
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ’˝»∑';
   insert into  t#st_ist_settle_out_rpt
              select a.balance_water_no,a.pay_mode_id ,0,0,sum(nvl(to_number(total_deal_num),0)), sum(nvl(to_number(total_deal_fee),0)),'',                     0,0,'01'
              from st_ext_oct_audit_balance a
              where in_flag='0' and balance_water_no =in_balance_water_no
              group by  a.balance_water_no,a.pay_mode_id;
  -------------------------------------------Õ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ--------------------------------
  
    v_msg := 'œÚt#st_ist_settle_out_rpt±Ì≤Â»ÎÕ‚≤øœµÕ≥∑µªÿ¥ÌŒÛ';
   insert into  t#st_ist_settle_out_rpt
                select balance_water_no,'42',0,0,0,0,err_code,count(*),sum(nvl(deal_fee,0)),'01'
                       from st_ext_oct_err_trade 
                       where in_flag='0' and balance_water_no =in_balance_water_no
                       group by  balance_water_no,err_code;
    
     --------------------------------------…˙≥…st_sts_diff_analysis
    v_msg := 'œÚ st_sts_diff_analysis±Ì≤Â»Îª„◊‹ ˝æ›';
   insert into  st_sts_diff_analysis
           select seq_sts_diff_analysis.nextval,balance_water_no,out_deal_type ,acc_send_num,acc_send_fee ,out_affirm_num ,
                  out_affirm_fee,error_id,error_num ,error_fee,sys_type
           from
               (select   balance_water_no,out_deal_type, sum(acc_send_num ) acc_send_num,sum(acc_send_fee ) acc_send_fee,
                sum(out_affirm_num) out_affirm_num,sum(out_affirm_fee) out_affirm_fee,error_id ,sum(error_num) error_num,
                sum(error_fee) error_fee,sys_type 
                from t#st_ist_settle_out_rpt
                group by balance_water_no,out_deal_type,error_id , sys_type );
                
                
------------–ﬁ∏ƒÕ‚≤øœµÕ≥∑µªÿ±Ì»Îø‚±Í÷æ
v_msg := '–ﬁ∏ƒst_ext_oct_audit_balance±Ì»Îø‚±Í÷æ';
update st_ext_oct_audit_balance set in_flag='1' 
                               where in_flag='0' and balance_water_no =in_balance_water_no;
                               
                               
v_msg := '–ﬁ∏ƒst_ext_oct_err_trade±Ì»Îø‚±Í÷æ';
update st_ext_oct_err_trade set in_flag='1' 
                            where in_flag='0' and balance_water_no =in_balance_water_no;

 
 commit;
 out_msg :='success';
 out_retresult:=0;
 exception
 when others then
 begin
    rollback;
    out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
    out_retresult := sqlcode;
    return;
 end;
end;
/

prompt
prompt Creating procedure UP_ST_IST_SETTLE_REG
prompt =======================================
prompt
create or replace procedure acc_st.up_st_ist_settle_reg(
 out_retresult out integer, --∑µªÿΩ·π˚
 out_msg out varchar2, --∑µªÿ–≈œ¢
 in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_reg
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫“Ï≥£Õ≥º∆°¢≤…ºØ…Ûº∆
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
        --ver1.02  ’¢ª˙‘ˆº”05,06 2014-7-3
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
-------------------------------------------------------------------------------
as
   v_count int;
   v_msg varchar(50);
   v_squad varchar(4);
begin
  -----------»°µ√‘À”™ ±º‰
  select cfg_value into v_squad  from st_cfg_sys_base where cfg_key='sys.squadday'  and record_flag='0';
  select count(*) into v_count from st_sts_reg_gate  where balance_water_no =in_balance_water_no;
  if v_count > 0   then
      out_msg := 'st_sts_reg_gate±Ì“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
      out_retresult := - 1;
      return;
   end if;
  select count(*) into v_count from st_sts_reg_tvm   where balance_water_no =in_balance_water_no;
  if v_count > 0  then
      out_msg := 'st_sts_except_balance±Ì“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
      out_retresult := - 1;
      return;
   end if;
 select count(*) into v_count from st_sts_reg_bom  where balance_water_no =in_balance_water_no;
  if v_count > 0   then
      out_msg := 'st_sts_reg_bom±Ì“—æ≠Ω¯––π˝±æ¥Œ«ÂÀ„';
      out_retresult := - 1;
      return;
   end if;
--ºƒ¥Ê∆˜±®±Ì÷˜“™∑÷Œ™»˝÷÷£¨tvm 02,bom 03,gate 04
--ºƒ¥Ê∆˜’¢ª˙±®±Ìst_sts_reg_gate
--ºƒ¥Ê∆˜tvm±®±Ì st_sts_reg_tvm
--ºƒ¥Ê∆˜bom±®±Ì st_sts_reg_bom
------------------------------Ω´À˘”– ˝æ›µº»Î¡Ÿ ±±Ì÷–
v_msg := 'œÚt#st_ist_settle_reg±Ì≤Â»Î ˝æ›';
insert into t#st_ist_settle_reg(balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value)
        select a.balance_water_no,a.line_id,a.station_id,
      case when to_char(a.gen_datetime, 'hh24mi') >= v_squad
      then to_char(a.gen_datetime, 'yyyymmdd') else to_char(a.gen_datetime - 1, 'yyyymmdd') end,
        a.dev_type_id,a.device_id,b.data_code,max(b.data_value)
    from st_que_reg_total a,st_que_reg_dtl b
    where a.balance_water_no =in_balance_water_no and b.balance_water_no =in_balance_water_no and a.water_no = b.water_no
    group by a.balance_water_no,a.line_id,a.station_id,
    case when to_char(a.gen_datetime, 'hh24mi') >= v_squad
      then to_char(a.gen_datetime, 'yyyymmdd') else to_char(a.gen_datetime - 1, 'yyyymmdd') end,dev_type_id,device_id,data_code;
------------------------------ºƒ¥Ê∆˜’¢ª˙±®±Ìst_sts_reg_gate
v_msg := 'œÚst_sts_reg_gate±Ì≤Â»Î ˝æ›';
    insert into st_sts_reg_gate(balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value)
        select balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value
    from t#st_ist_settle_reg  where dev_type_id in ('04','05','06');--ver1.02 ‘ˆº”05,06 2014-7-3
------------------------------ºƒ¥Ê∆˜tvm±®±Ìst_sts_reg_tvm
v_msg := 'œÚst_sts_reg_tvm±Ì≤Â»Î ˝æ›';
   insert into st_sts_reg_tvm(balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value)
        select balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value
    from t#st_ist_settle_reg  where dev_type_id = '02';
------------------------------ºƒ¥Ê∆˜bom±®±Ì st_sts_reg_bom
  v_msg := 'œÚst_sts_reg_bom±Ì≤Â»Î ˝æ›';
  insert into st_sts_reg_bom(balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value)
        select balance_water_no,line_id,station_id,squad_day,dev_type_id,device_id,data_code,deal_value
    from t#st_ist_settle_reg  where dev_type_id = '03';
   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_REG to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_ROLLBACK
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_settle_rollback
(  out_retResult OUT INTEGER, --∑µªÿΩ·π˚
   out_msg OUT VARCHAR2 --∑µªÿ–≈œ¢
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_ROLLBACK
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„ªÿπˆ
-- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫
-------------------------------------------------------------------------------
aS
    v_balance_water_no        char(10)  ;       --±æ¥Œ¡˜ÀÆ∫≈
    v_balance_water_before    char(10)  ;       --…œ¥Œ«ÂÀ„¡˜ÀÆ∫≈
  
    v_msg varchar(50);
BEGIN
  select max(balance_water_no) into v_balance_water_no from st_sys_flow_current;
  delete st_list_balance_waiting;
  -------------------------«Â≥˝Ωª“◊¿˙ ∑±Ì
  --«Æ∞¸Ωª“◊
  delete acc_st_his.st_his_deal where balance_water_no=v_balance_water_no ;
  delete st_err_deal where balance_water_no=v_balance_water_no ;
  --Ω¯’æº«¬º
  delete acc_st_his.st_his_entry where balance_water_no=v_balance_water_no;
  delete st_err_entry where balance_water_no=v_balance_water_no;
  --∏¸–¬
  delete acc_st_his.st_his_update where balance_water_no=v_balance_water_no;
  delete st_err_update where balance_water_no=v_balance_water_no;
  --µ•≥Ã∆± €∆±
  delete acc_st_his.st_his_sale_sjt where balance_water_no=v_balance_water_no;
  delete st_err_sale_sjt where balance_water_no=v_balance_water_no;
  -- €∆±
  delete acc_st_his.st_his_sale where balance_water_no=v_balance_water_no;
  delete st_err_sale where balance_water_no=v_balance_water_no;
  --ÕÀø®
  delete acc_st_his.st_his_return where balance_water_no=v_balance_water_no;
  delete st_err_return where balance_water_no=v_balance_water_no;
  --∑«º¥ ±ÕÀøÓ…Í«Î
  delete acc_st_his.st_his_non_rtn_app where balance_water_no=v_balance_water_no;
  delete st_err_non_rtn_app where balance_water_no=v_balance_water_no;
    --∆±ø®—”∆⁄
  delete acc_st_his.st_his_delay where balance_water_no=v_balance_water_no;
  delete st_err_delay where balance_water_no=v_balance_water_no;
  --À¯ø®
  delete acc_st_his.st_his_lock where balance_water_no=v_balance_water_no;
  delete st_err_lock where balance_water_no=v_balance_water_no;
  --––’˛¥¶¿Ì
  delete acc_st_his.st_his_admin where balance_water_no=v_balance_water_no;
  delete st_err_admin where balance_water_no=v_balance_water_no;
  --º«√˚ø®
  delete st_list_sign_card where balance_water_no=v_balance_water_no;
  delete st_err_sign_card_apply where balance_water_no=v_balance_water_no;
  --µÿÃ˙ø®‘⁄π´ΩªµƒΩª“◊±Ì
  delete acc_st_his.st_ext_mtr_his_deal where balance_water_no=v_balance_water_no;
  delete st_ext_mtr_err_trade where balance_water_no=v_balance_water_no;
  --π´Ωªicø®«Æ∞¸Ωª“◊±Ì
  delete acc_st_his.st_his_deal_oct where balance_water_no=v_balance_water_no;
   --π´Ωª €ø®Ωª“◊
  delete acc_st_his.st_his_sale_oct where balance_water_no=v_balance_water_no;
  --“¯¡™ø®«Æ∞¸Ωª“◊±Ì
  delete acc_st_his.st_his_deal_bank where balance_water_no=v_balance_water_no;
  ----------------- ’“Ê ˝æ›
  --bom∞‡¥Œ ˝æ›÷˜ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_total where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_total where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑¢ €£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_sale where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_sale where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰÷µ£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_charge where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_charge where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∏¸–¬£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_update where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_update where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®––’˛¥¶¿Ì£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_admin where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_admin where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®—”∆⁄£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_delay where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_delay where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_return where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_return where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_rtn_non where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_rtn_non where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ…Í«Î£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_rtn_app where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_rtn_app where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰’˝£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_chg_upd where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_chg_upd where balance_water_no=v_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®Ω‚À¯£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_unlock where balance_water_no=v_balance_water_no;
  delete st_err_bom_shift_unlock where balance_water_no=v_balance_water_no;
  --tvm÷Ω±“œ‰ ˝æ›ª∫¥Ê±Ì
  delete acc_st_his.st_his_tvm_note_data where balance_water_no=v_balance_water_no;
  delete st_err_tvm_note_data where balance_water_no=v_balance_water_no;
  --tvm”≤±“œ‰ ˝æ›
  delete acc_st_his.st_his_tvm_coin_data where balance_water_no=v_balance_water_no;
  delete st_err_tvm_coin_data where balance_water_no=v_balance_water_no;
  --tvm”≤±“œ‰¥Ê»Î ˝æ›
  delete acc_st_his.st_his_tvm_coin_put where balance_water_no=v_balance_water_no;
  delete st_err_tvm_coin_put where balance_water_no=v_balance_water_no;
  --tvm”≤±“œ‰«Âø’ ˝æ›
  delete acc_st_his.st_his_tvm_coin_clear where balance_water_no=v_balance_water_no;
  delete st_err_tvm_coin_clear where balance_water_no=v_balance_water_no;
  --tvm∆±œ‰¥Ê»Î ˝æ›
  delete acc_st_his.st_his_tvm_card_put where balance_water_no=v_balance_water_no;
  delete st_err_tvm_card_put where balance_water_no=v_balance_water_no;
  --tvm∆±œ‰«Âø’ ˝æ›
  delete acc_st_his.st_his_tvm_card_clear where balance_water_no=v_balance_water_no;
  delete st_err_tvm_card_clear where balance_water_no=v_balance_water_no;
  --tvm∑œ∆±œ‰ ˝æ›
  delete acc_st_his.st_his_tvm_waste_card_data where balance_water_no=v_balance_water_no;
  delete st_err_tvm_waste_card_data where balance_water_no=v_balance_water_no;
  --agm∆±œ‰ ˝æ›
  delete acc_st_his.st_his_agm_card_data where balance_water_no=v_balance_water_no;
  delete st_err_agm_card_data where balance_water_no=v_balance_water_no;
  --------------------------ºƒ¥Ê∆˜ ˝æ›
  delete acc_st_his.st_his_reg_total where balance_water_no=v_balance_water_no;
  delete acc_st_his.st_his_reg_dtl where balance_water_no=v_balance_water_no;
  delete st_err_reg_total where balance_water_no=v_balance_water_no;
  delete st_err_reg_dtl where balance_water_no=v_balance_water_no;
  --------------------------…Ûº∆ ˝æ›
  delete acc_st_his.st_his_agm_cutoff_total where balance_water_no=v_balance_water_no;
  delete acc_st_his.st_his_agm_cutoff_dtl where balance_water_no=v_balance_water_no;
  delete acc_st_his.st_his_tvm_cutoff_total where balance_water_no=v_balance_water_no;
  delete acc_st_his.st_his_tvm_cutoff_dtl where balance_water_no=v_balance_water_no;
  delete st_err_agm_cutoff_total where balance_water_no=v_balance_water_no;
  delete st_err_agm_cutoff_dtl where balance_water_no=v_balance_water_no;
  delete st_err_tvm_cutoff_total where balance_water_no=v_balance_water_no;
  delete st_err_tvm_cutoff_dtl where balance_water_no=v_balance_water_no;
    ----------------------------Õ≥º∆÷–º‰±Ì---------
    --ƒ⁄≤ø«ÂÀ„
  delete st_list_balance_line where balance_water_no=v_balance_water_no;
  delete st_sts_income_contc_card where balance_water_no=v_balance_water_no;
  delete st_sts_dispart_contc where balance_water_no=v_balance_water_no;
  delete st_sts_dispart_line where balance_water_no=v_balance_water_no;
  delete st_sts_balance_contc_trd where balance_water_no=v_balance_water_no;
  delete st_sts_balance_line_trd where balance_water_no=v_balance_water_no;
  delete st_sts_balance_contc_inc where balance_water_no=v_balance_water_no;
  delete st_sts_balance_line_inc where balance_water_no=v_balance_water_no;
    --Õ‚≤ø«ÂÀ„
  delete st_sts_diff_analysis where  balance_water_no=v_balance_water_no;
  update st_ext_oct_audit_balance set in_flag='0' where balance_water_no=v_balance_water_no;
  update st_ext_oct_err_trade set in_flag='0' where balance_water_no=v_balance_water_no;
  delete st_sts_mtr_audit_balance where  balance_water_no=v_balance_water_no;
    --øÕ¡˜
  delete st_sts_change where balance_water_no=v_balance_water_no;
  delete st_sts_change_income where balance_water_no=v_balance_water_no;
  delete st_sts_flw_station where balance_water_no=v_balance_water_no;
  delete st_sts_flw_line_card where balance_water_no=v_balance_water_no;
  delete st_sts_flw_line_pass where balance_water_no=v_balance_water_no;
  delete st_sts_flw_average_distance where balance_water_no=v_balance_water_no;
  delete st_sts_flw_change where balance_water_no=v_balance_water_no;
  delete st_sts_od_card where balance_water_no=v_balance_water_no;
  delete st_sts_od_line where balance_water_no=v_balance_water_no;
  delete st_sts_od_card_zone where balance_water_no=v_balance_water_no;
  delete st_sts_realflow_section where balance_water_no=v_balance_water_no;
  -- ’“Ê
  delete st_sts_inc_sale where balance_water_no=v_balance_water_no;
  delete st_sts_inc_fare where balance_water_no=v_balance_water_no;
  delete st_sts_inc_update where balance_water_no=v_balance_water_no;
  delete st_sts_inc_return where balance_water_no=v_balance_water_no;
  delete st_sts_inc_consume where balance_water_no=v_balance_water_no;
  delete st_sts_inc_charge where balance_water_no=v_balance_water_no;
  delete st_sts_inc_station where balance_water_no=v_balance_water_no;
  delete st_sts_inc_balance_expired where balance_water_no=v_balance_water_no;
    --lcc∂‘’À
  delete acc_st_his.st_his_lcc where balance_water_no=v_balance_water_no;
  delete st_sts_acc where balance_water_no=v_balance_water_no;
  delete st_sts_lcc_acc where balance_water_no=v_balance_water_no;
    --…Ûº∆°¢“Ï≥£Õ≥º∆
  delete st_sts_collect_status where balance_water_no=v_balance_water_no;
  delete st_sts_except_balance where balance_water_no=v_balance_water_no;
    --”‡∂Ó∆Ω∫‚
  delete st_list_balance_cal where balance_water_no=v_balance_water_no;
    --sam∂œ∫≈÷ÿ∫≈∑÷Œˆ
  delete st_err_sam_water where balance_water_no=v_balance_water_no;
  delete st_list_sam_water where balance_water_no=v_balance_water_no;
    --ºƒ¥Ê∆˜ ˝æ›
  delete st_sts_reg_gate where balance_water_no=v_balance_water_no;
  delete st_sts_reg_tvm where balance_water_no=v_balance_water_no;
  delete st_sts_reg_bom where balance_water_no=v_balance_water_no;
    ---√˚µ•π‹¿Ì”Î«ÂÀ„∫Û–¯
  delete op_prm_black_old_mtr where balance_water_no=v_balance_water_no;
  delete st_err_deal_unique  where balance_water_no=v_balance_water_no;
  delete st_err_entry_unique  where balance_water_no=v_balance_water_no;
  delete st_err_update_unique  where balance_water_no=v_balance_water_no;
  delete st_sts_inc_balance where balance_water_no=v_balance_water_no;
  --∑«º∞ ±ÕÀøÓΩª“◊º«¬º
  delete op_non_return_tk_hist where current_balance_water=v_balance_water_no;
  delete op_non_return_tk_trans_hist where current_balance_water=v_balance_water_no;

  --”–∏¸–¬µƒ±Ì¥”¿˙ ∑±Ìªÿπˆ£®…æ≥˝◊ÓΩ¸¡˜ÀÆ∫≈µƒ ˝æ›£¨µº»Î…œ“ª¥Œµƒ¡˜ÀÆ∫≈£©
  delete acc_st_his.st_his_act_svt where curr_balance_water=v_balance_water_no;
  delete acc_st_his.st_his_non_rtn where curr_balance_water=v_balance_water_no;
  delete acc_st_his.st_his_act_sam where balance_water_no=v_balance_water_no;
  delete op_his_black_list_mtr where balance_water_no=v_balance_water_no;
  delete op_his_black_list_mtr_sec where balance_water_no=v_balance_water_no;
  --st_act_svt
  v_msg := 'ªÿπˆst_act_svt';
   delete st_act_svt;
  select max(curr_balance_water) into v_balance_water_before from acc_st_his.st_his_act_svt;
  insert into st_act_svt
  select card_main_id,card_sub_id,card_logical_id,card_physical_id,total_charge_num,total_consume_num,
    total_charge_fee ,total_consume_fee,system_balance_fee ,card_balance_fee,old_expire_datetime,
    new_expire_datetime ,card_charge_seq,card_consume_seq,balance_water_no,card_status_id,deposit_fee,card_money
  from  acc_st_his.st_his_act_svt  where curr_balance_water=v_balance_water_before;
  --st_list_non_rtn
  v_msg := 'ªÿπˆst_list_non_rtn';
  delete st_list_non_rtn;
  select max(curr_balance_water) into v_balance_water_before from acc_st_his.st_his_non_rtn;
  insert into st_list_non_rtn
  select water_no,line_id,station_id,dev_type_id,device_id,card_main_id,card_sub_id,card_logical_id,
    card_physical_id,card_print_id,apply_datetime,receipt_id,operator_id,apply_name,tel_no
    ,identity_type,identity_id,is_broken,shift_id,card_app_flag,balance_water_no,hdl_flag ,deposit_fee,
    card_balance_fee,system_balance_fee,penalty_fee,return_bala,remark,return_line_id,return_station_id,
    return_dev_type_id,return_device_id,actual_return_bala,audit_flag,penalty_reason
  from acc_st_his.st_his_non_rtn where curr_balance_water=v_balance_water_before;
  --st_act_sam
  v_msg := 'ªÿπˆst_act_sam';
  delete st_act_sam;
  select max(balance_water_no) into v_balance_water_before from acc_st_his.st_his_act_sam;
  insert into st_act_sam
  select line_id,station_id,dev_type_id,device_id,card_main_id,card_sub_id,sam_logical_id,
         sam_trade_seq_start,sam_trade_seq_end,total_deal_num
  from acc_st_his.st_his_act_sam where balance_water_no=v_balance_water_before;
  --op_prm_black_list_mtr
  v_msg := 'ªÿπˆop_prm_black_list_mtr';
  delete op_prm_black_list_mtr;
  select max(balance_water_no) into v_balance_water_before from op_his_black_list_mtr;
  insert into op_prm_black_list_mtr
  select gen_datetime,card_logical_id,black_type,remark,action_type,create_datetime,operator_id,is_set
  from op_his_black_list_mtr where balance_water_no=v_balance_water_before;
  --op_prm_black_list_mtr_sec
  v_msg := 'ªÿπˆop_prm_black_list_mtr_sec';
  delete op_prm_black_list_mtr_sec;
  select max(balance_water_no) into v_balance_water_before from op_his_black_list_mtr_sec;
  insert into op_prm_black_list_mtr_sec
  select gen_datetime,begin_logical_id,end_logical_id,black_type,remark,action_type,create_datetime,operator_id,is_set
  from op_his_black_list_mtr_sec where balance_water_no=v_balance_water_before;

  v_msg := '–ﬁ∏ƒ«ÂÀ„±ÌÕÍ≥…±Í÷æ';
  update st_sys_flow_current set error_code='00' , finish_flag='0',begin_time=null,end_time=null
   where to_number(step) between 30 and 69;
  commit;
   out_msg :='success';
   out_retresult:=0;
   exception
   when OTHERS THEN
   begin
      ROLLBACK;
      out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
      out_retresult := sqlcode;
      return;
   end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_ROLLBACK to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_RPTSQUADAY_MV
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_settle_rptsquaday_mv(out_retresult     OUT INTEGER, --∑µªÿΩ·π˚
                                                           out_msg           OUT VARCHAR2, --∑µªÿ–≈œ¢
                                                           oper_no           in VARCHAR2, --≤Ÿ◊˜‘±–≈œ¢
                                                           center_balance_no in varchar2) -- ‰»Îµƒ«ÂÀ„¡˜ÀÆ∫≈
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_balance_his_mid
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--÷–º‰±Ì ˝æ›∏˘æ›‘À”™»’squad_dayµº»Î¿˙ ∑±Ì£¨∂ØÃ¨≤Â»Î
  -- ‰»Î≤Œ ˝: @origin_table_name  ÷–º‰±Ì√˚
  -- ‰≥ˆ≤Œ ˝  £∫return_num ƒ£øÈ∑µªÿ÷µ
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131029
  --¥¥Ω®√Ë ˆ£∫µ±ƒø«∞À˘ π”√µƒ±Ì÷–º«¬º±£¥Ê ±º‰≥¨π˝‘§œ»…Ë∂®µƒ±£¥ÊÃÏ ˝ ±£¨
  --          ‘ÚΩ´±æ±Ì÷–≥¨≥ˆ±£¥Ê ±º‰∑∂Œßµƒº«¬º÷µ≤Â»Î¿˙ ∑∑÷±Ì÷–Ω¯––±£¥Ê∫Û‘ŸΩ¯––…æ≥˝≤Ÿ◊˜£¨
  --          À˘”–≤Ÿ◊˜æ˘–Ë”–œ‡”¶»’÷æ±£¥Ê”⁄«Â¿Ì»’÷æ±Ìclear_table_log÷–
  -------------------------------------------------------------------------------
 AS
  --memo      varchar2(255); --◊¢ Õ
  --err       int; --¥ÌŒÛ–≈œ¢
  v_sql     varchar2(2048);
  max_table varchar2(40); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  min_table varchar2(40); --◊Ó–°µƒ¿˙ ∑±Ì
  v_count   integer; --
  --ss        varchar2(2048);

  begin_time date; --«Â¿Ìø™ º ±º‰
  minDate    varchar2(8); --◊Ó–°‘À”™»’
  --maxDate      varchar2(8); --◊Ó¥Û‘À”™»’
  --max_water_no varchar2(10); --µº»Î ˝æ›∫Ûµƒ¿˙ ∑±Ì◊Ó¥Û¡˜ÀÆ∫≈

  origin_table_name varchar2(30); --÷–º‰±Ì±Ì√˚
  keep_days         int; --÷–º‰±Ì±£¥ÊÃÏ ˝
  --clear_flag        int; -- «∑Ò«Â¿Ì±Í÷æ   1 «Â¿Ì£¨2£¨≤ª«Â¿Ì
  --is_squadDay       int; -- «∑Ò”–«ÂÀ„‘À”™»’◊÷∂Œ 1 ”–£¨0 √ª”–
  table_columns  varchar2(1000); --÷–º‰±Ì∏˜◊÷∂Œ
  v_cost_seconds int; --Õ≥º∆ ±º‰
  v_msg          varchar2(255); --◊¢ Õ
BEGIN

  -------------------------«®“∆ ˝æ›ø™ º---------------------------
  begin
    declare
      cursor scc_table is
        select t.origin_table_name tmp_origin_table,
               t.keep_days         tmp_keep_days,
               t.clear_flag        tmp_clear_flag,
               t.is_squadDay       tmp_is_squadDay,
               t.table_columns     tmp_table_columns
          from st_cfg_clear_table t
         where t.clear_flag = -1; --
    begin
    
      for i_cur in scc_table loop
      
        origin_table_name := trim(i_cur.tmp_origin_table);
        table_columns     := trim(i_cur.tmp_table_columns);
        begin_time        := sysdate;
        keep_days         := i_cur.tmp_keep_days;
        --≤È—Øµ±«∞±Ìµ±ÃÏ¡˜ÀÆ∫≈µƒ◊Ó–°‘À”™»’
        begin
          v_sql := ' select min(squad_day) from ' || origin_table_name ||
                   ' where balance_water_no = ''' || center_balance_no || '''';
          execute immediate v_sql
            into minDate;
        EXCEPTION
          when others then
            begin
              rollback;
              out_retresult  := SQLCODE;
              out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_day_min÷–≤Â»Î ˝æ›¥ÌŒÛ£∫¥ÌŒÛ¥˙¬Î£∫ ' ||
                                SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                dbms_utility.format_error_backtrace() || ']––';
              v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
              up_st_ist_settle_log_add(origin_table_name,
                                       '0',
                                       center_balance_no,
                                       begin_time,
                                       sysdate,
                                       v_cost_seconds,
                                       0,
                                       out_msg,
                                       v_sql);
              return;
            end;
        end;
        -- select min_squadDate into minDate from t#st_sts_inc_day_min;
        --delete from t#st_sts_inc_day_min;
      
        -- ◊œ»≤È—Ø“™µº»Îµƒ◊Ó¥Û¿˙ ∑±Ì√˚
        v_sql := ' select max(table_name)   from st_idx_rpt_history where origin_table_name =''' ||
                 origin_table_name || '''';
        execute immediate v_sql
          into max_table;
        --‘Ÿ∏¸–¬◊Ó¥Û¿˙ ∑±Ìµƒ◊Ó¥Û‘À”™»’∆⁄Œ™µ±ÃÏ
        update st_idx_rpt_history
           set max_squad_day = to_char(sysdate, 'yyyymmdd')
         where table_name = max_table;
      
        --≤È—Ø◊Ó–°¿˙ ∑±Ì
        v_sql := ' select  min(table_name) from st_idx_rpt_history where origin_table_name =''' ||
                 origin_table_name || '''and max_squad_day >=''' || minDate || '''';
        execute immediate v_sql
          into min_table;
      
        --—≠ª∑œÚ∑÷±Ì÷–≤Â»Î ˝æ›
        begin
          declare
            cursor index_table is
              select table_name    temp_table_name,
                     min_squad_day temp_min_squad_day,
                     max_squad_day temp_max_squad_day
                from st_idx_rpt_history t
               where origin_table_name = origin_table_name
                 and table_name >= min_table
                 and table_name <= max_table;
          
          begin
            for t_cur in index_table loop
              --»Áπ˚µ±«∞«ÂÀ„»’∆⁄“—æ≠«®“∆π˝ ˝æ›
              v_sql := 'select count(*) from ' || t_cur.temp_table_name ||
                       ' where balance_water_no=''' || center_balance_no || '''';
              execute immediate v_sql
                into v_count;
              if v_count > 0 then
                out_retresult := SQLCODE;
                out_msg       := '«ÂÀ„»’∆⁄[' || center_balance_no ||
                                 ']∂‘”¶µƒ ˝æ›“—æ≠«®“∆÷¬¿˙ ∑±Ì';
                return;
              end if;
              begin_time := sysdate;
              -- ∏˘æ›‘À”™»’≤Â»Î∂‘”¶µƒ¿˙ ∑±Ì
            
              begin
                v_sql := ' insert into ' || t_cur.temp_table_name ||
                         ' select ' || table_columns || ' from ' ||
                         origin_table_name || ' where squad_day >=''' ||
                         t_cur.temp_min_squad_day ||
                         ''' and squad_day <=''' ||
                         t_cur.temp_max_squad_day ||
                         ''' and balance_water_no =''' || center_balance_no || '''';
                execute immediate v_sql;
              EXCEPTION
                when others then
                  begin
                    rollback;
                    out_retresult  := SQLCODE;
                    out_msg        := origin_table_name || '≤Â»Î¿˙ ∑±Ì¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' ||
                                      SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                      dbms_utility.format_error_backtrace() || ']––';
                    v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                    up_st_ist_settle_log_add(origin_table_name,
                                             '0',
                                             center_balance_no,
                                             begin_time,
                                             sysdate,
                                             v_cost_seconds,
                                             0,
                                             out_msg,
                                             v_sql);
                    return;
                  end;
                
              end;
            
              begin
                v_sql := 'select count(*) from ' || origin_table_name ||
                         ' where squad_day >=''' || t_cur.temp_min_squad_day ||
                         ''' and squad_day <=''' ||
                         t_cur.temp_max_squad_day ||
                         ''' and balance_water_no =''' || center_balance_no || '''';
                execute immediate v_sql
                  into v_count;
              EXCEPTION
                when others then
                  begin
                    rollback;
                    out_retresult  := SQLCODE;
                    out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_count≤Â»Î ˝æ›¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' ||
                                      SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                      dbms_utility.format_error_backtrace() || ']––';
                    v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                    up_st_ist_settle_log_add(origin_table_name,
                                             '0',
                                             center_balance_no,
                                             begin_time,
                                             sysdate,
                                             v_cost_seconds,
                                             0,
                                             out_msg,
                                             v_sql);
                    return;
                  end;
              end;
              begin
                --select cnt into v_count from t#st_sts_inc_count;
                --delete from t#st_sts_inc_count;
              
                --∏¸–¬st_idx_rpt_history ¿˙ ∑º«¬º±Ì–≈œ¢
                update st_idx_rpt_history
                   set recd_count     = recd_count + v_count,
                       end_balance_no = center_balance_no
                 where table_name = t_cur.temp_table_name;
              
                v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                out_msg        := '¥”' || origin_table_name || '±Ì÷–µº»ÎµΩ' ||
                                  t_cur.temp_table_name || '¿˙ ∑±Ìµƒ ˝æ›≥…π¶';
                up_st_ist_settle_log_add(origin_table_name,
                                         t_cur.temp_table_name,
                                         center_balance_no,
                                         begin_time,
                                         sysdate,
                                         v_cost_seconds,
                                         0,
                                         out_msg,
                                         v_sql);
              
              end;
            
            end loop;
          end;
        end;
      
      end loop;
    end;
    -------------------------«®“∆ ˝æ›Ω· ¯---------------------------
    -------------------------…æ≥˝ ˝æ›ø™ º---------------------------
    begin
      --…æ≥˝≈‰÷√±Ì÷–¥À÷–º‰±Ì±£¥ÊÃÏ ˝«∞µƒ ˝æ›
      begin_time := sysdate;
      begin
        v_sql := ' select count(*) from ' || origin_table_name ||
                 'where balance_water_no <''' ||
                 to_char(sysdate - keep_days, 'yyyymmdd') || '01''';
        execute immediate v_sql
          into v_count;
      EXCEPTION
        when others then
          begin
            rollback;
            out_retresult  := SQLCODE;
            out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_count≤Â»Î ˝æ›¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' ||
                              SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                              dbms_utility.format_error_backtrace() || ']––';
            v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
            up_st_ist_settle_log_add(origin_table_name,
                                     '0',
                                     center_balance_no,
                                     begin_time,
                                     sysdate,
                                     v_cost_seconds,
                                     0,
                                     out_msg,
                                     v_sql);
            return;
          end;
      end;
      select cnt into v_count from t#st_sts_inc_count;
      delete from t#st_sts_inc_count;
      --…æ≥˝
      begin
        v_sql := 'delete from ' || origin_table_name ||
                 ' where balance_water_no <''' ||
                 to_char(sysdate - keep_days, 'yyyymmdd') || '01''';
        execute immediate v_sql;
      EXCEPTION
        when others then
          begin
            rollback;
            out_retresult  := SQLCODE;
            out_msg        := '…æ≥˝' || origin_table_name ||
                              '±Ì÷–µº»Î¿˙ ∑±Ìµƒ ˝æ›¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' || SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                              dbms_utility.format_error_backtrace() || ']––';
            v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
            up_st_ist_settle_log_add(origin_table_name,
                                     '0',
                                     center_balance_no,
                                     begin_time,
                                     sysdate,
                                     v_cost_seconds,
                                     0,
                                     out_msg,
                                     v_sql);
            return;
          end;
      end;
      --º«¬º»’÷æ
      out_msg        := '…æ≥˝' || origin_table_name || '±Ì÷–«Â¿ÌÃÏ ˝«∞µƒ ˝æ›≥…π¶';
      v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
      up_st_ist_settle_log_add(origin_table_name,
                               '0',
                               center_balance_no,
                               begin_time,
                               sysdate,
                               v_cost_seconds,
                               0,
                               out_msg,
                               v_sql);
    
    end;
    -------------------------…æ≥˝ ˝æ›Ω· ¯---------------------------
  
  end;
  out_retresult := SQLCODE;
  out_msg       := ' ˝æ›«®“∆≥…π¶';
  commit;
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retResult := sqlcode;
      return;
    end;
  
END up_st_ist_settle_rptsquaday_mv;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_RPTSQUADAY_MV to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_RPT_CREATE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_settle_rpt_create(out_retResult OUT INTEGER, --∑µªÿΩ·π˚
                                                        out_msg       OUT VARCHAR2 --∑µªÿ–≈œ¢
                                                        )
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_HIS_MORE
  --π¶ƒ‹√Ë ˆ£∫Ω®¡¢÷–—Î«ÂÀ„∏˜÷–º‰±Ìµƒ¿˙ ∑∑÷±Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ªout_retResultŒ™0 ±£¨out_msg∑µªÿ±Ì√˚
  --¥¥Ω®’ﬂ£∫  ’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫201301023
  --–ﬁ∏ƒ£∫
  -------------------------------------------------------------------------------
 AS

  v_msg VARCHAR(50);
  --v_sql              varchar(5000);
  --v_new_begin date; --–¬µƒø™ º ±º‰
  --v_new_end          date; --–¬µƒΩ· ¯ ±º‰
  v_min_time varchar2(10); --◊Ó–°‘À”™ ±º‰
  v_max_time varchar2(10); --◊Ó¥Û‘À”™ ±º‰

  v_min_balance_no varchar2(10); --◊Ó¥Û«ÂÀ„¡˜ÀÆ∫≈
  v_max_balance_no varchar2(10); -- ◊Ó–°«ÂÀ„¡˜ÀÆ
  v_max_table      varchar2(40); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  v_count          number(18); --¡Ÿ ±Õ≥º∆±‰¡ø
  v_count2         number(18); --¡Ÿ ±Õ≥º∆±‰¡ø
  v_flag           number(1); --¥¥Ω®001µƒ±Í÷æ£¨0£∫¥¥Ω®  
  v_time           varchar2(20);
  v_temp_sql       varchar2(4000); --¡Ÿ ±sql”Ôæ‰
  v_table_sql      varchar2(4000); --Ω®±Ì¡Ÿ ±sql”Ôæ‰
  v_temp_num       varchar2(3); --∑÷±Ì–Ú¡–∫≈
  new_table_name   varchar2(40); --∑÷±Ì±Ì√˚
BEGIN
  begin
    declare
      cursor scc_table is
        select t.origin_table_name tmp_origin_table,
               t.create_sql        tmp_create_sql,
               t.is_squadday       tmp_is_squadday,
               t.index_name        tmp_index_name,
               t.pk_name           tmp_pk_name
          from st_cfg_clear_table t;
    begin
      for i_cur in scc_table loop
        begin
          select count(*)
            into v_count
            from st_idx_rpt_history
           where table_name like i_cur.tmp_pk_name || '_%';
        end;
        begin
          --“ÚŒ™”––©‘≠±Ì√˚Ã´≥§£¨À˘“‘…˙≥…µƒ∑÷±Ì≤…”√◊‘∂®“Âµƒ±Ì√˚£¨øÿ÷∆¡À≥§∂»
          new_table_name := i_cur.tmp_pk_name || '_001';
        
          v_temp_sql := 'select count(*) from user_objects where object_name = upper (''' ||
                        new_table_name || ''')';
          execute immediate v_temp_sql
            into v_count2;
        end;
        begin
          if v_count = 0 then
            --st_idx_rpt_history√ª”–∂‘”¶∑÷±Ìµƒº«¬º
            if v_count2 > 0 then
              --∑÷±ÌµƒŒÔ¿Ì±Ì¥Ê‘⁄
              v_temp_sql := 'drop table ' || new_table_name;
              execute immediate v_temp_sql; --…æ≥˝001∑÷±Ì±Ì
            
            end if;
            v_flag := 0;
          
          else
            ----st_idx_rpt_history”–∂‘”¶∑÷±Ìµƒº«¬º
            if v_count2 = 0 then
              --∑÷±ÌµƒŒÔ¿Ì±Ì≤ª¥Ê‘⁄
              v_flag := 0;
            end if;
          end if;
        end;
        if v_flag = 0 then
          --œ»Ω®±Ì£¨‘Ÿ≥ı ºªØ
          begin
            --Ω®001±Ì
            begin
              --ªÒ»°Ω®±Ì”Ôæ‰
              --ÃÊªª±Ì√˚
              select REGEXP_REPLACE(i_cur.tmp_create_sql,
                                    '%s',
                                    new_table_name)
                into v_temp_sql
                from dual;
              --ÃÊªªÀ˜“˝
              select REGEXP_REPLACE(v_temp_sql,
                                    '%i',
                                    i_cur.tmp_index_name || '_001')
                into v_temp_sql
                from dual;
              --ÃÊªª÷˜º¸
              select REGEXP_REPLACE(v_temp_sql,
                                    '%p',
                                    i_cur.tmp_pk_name || '_001')
                into v_temp_sql
                from dual;
            
              --Ω´Ω®±Ì”Ôæ‰≤Â»ÎµΩ≤‚ ‘±Ì£¨µ˜ ‘”√
              insert into t_test
              values
                (to_char(systimestamp, 'yyyy-mm-dd hh24:mi:ss.ff'),
                 v_temp_sql);
              commit;
              --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
              declare
                cursor sql_cur is
                  select * from table(splitstr(v_temp_sql, ';'));
              begin
                for t_cur in sql_cur loop
                  v_table_sql := t_cur.column_value;
                  insert into t_test
                  values
                    (to_char(systimestamp, 'yyyy-mm-dd hh24:mi:ss.ff'),
                     v_table_sql);
                  commit;
                
                  if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                    execute immediate v_table_sql; --¥¥Ω®001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                  end if;
                end loop;
              end;
            end;
          
            select to_char(sysdate - 1, 'yyyymmdd') into v_time from dual;
          
            --º∆À„◊Ó–°°¢◊Ó¥Û¡˜ÀÆ∫≈°¢◊Ó–°‘À”™»’£¨◊Ó¥Û‘À”™»’
            if i_cur.tmp_is_squadday = 0 then
              v_temp_sql := 'select min(t.balance_water_no),max(t.balance_water_no) from ' ||
                            i_cur.tmp_origin_table ||
                            ' t where t.balance_water_no <''' || v_time ||
                            '01''';
              execute immediate v_temp_sql
                into v_min_balance_no, v_max_balance_no;
              v_min_time := '19790101';
              v_max_time := '19790101';
            else
              --º∆À„◊Ó–°°¢◊Ó¥Û¡˜ÀÆ∫≈°¢◊Ó–°‘À”™»’£¨◊Ó¥Û‘À”™»’
            
              v_temp_sql := 'select min(t.balance_water_no),max(t.balance_water_no),min(t.squad_day),max(t.squad_day)
                  from ' ||
                            i_cur.tmp_origin_table ||
                            ' t where t.balance_water_no <''' || v_time || '''';
              execute immediate v_temp_sql
                into v_min_balance_no, v_max_balance_no, v_min_time, v_max_time;
            
            end if;
            begin
              select replace(v_min_time, ' ', '')
                into v_min_time
                from dual;
              select replace(v_max_time, ' ', '')
                into v_max_time
                from dual;
              select replace(v_min_balance_no, ' ', '')
                into v_min_balance_no
                from dual;
              select replace(v_max_balance_no, ' ', '')
                into v_max_balance_no
                from dual;
            end;
          
            if v_min_balance_no is null or v_min_balance_no = '' then
              v_min_balance_no := v_time || '01';
            end if;
          
            if v_max_balance_no is null or v_max_balance_no = '' then
              v_max_balance_no := v_time || '01';
            end if;
          
            select count(*)
              into v_count
              from st_idx_rpt_history
             where table_name = new_table_name;
            if v_count = 0 then
              insert into st_idx_rpt_history
                (table_name,
                 origin_table_name,
                 begin_balance_no,
                 end_balance_no,
                 min_squad_day,
                 max_squad_day,
                 recd_count)
              values
                (new_table_name,
                 i_cur.tmp_origin_table,
                 v_min_balance_no,
                 v_max_balance_no,
                 v_min_time,
                 v_max_time,
                 0);
            end if;
          
          end;
        end if;
      end loop;
    
    end;
  
  end;

  ---------------“‘œ¬Œ™¥¥Ω®∑«001±Ì

  begin
    declare
      cursor cu_table is
        select regexp_substr(a.table_name, '.{1,3}$') tmp_i_list_no,
               a.recd_count tmp_recd_count,
               to_char(to_date(substr(a.end_balance_no, 0, 8), 'yyyymmdd') + 1,
                       'yyyymmdd') || '01' tmp_max_balance_no,
               to_char(to_date(a.max_squad_day, 'yyyymmdd') + 1, 'yyyymmdd') tmp_max_squad_day,
               a.origin_table_name tmp_origin_table,
               b.divide_recd_count tmp_divide_recd,
               b.create_sql tmp_create_sql,
               b.is_squadday tmp_is_squadDay,
               b.index_name tmp_index_name,
               b.pk_name tmp_pk_name
          from st_idx_rpt_history a, st_cfg_clear_table b
         where a.origin_table_name = b.origin_table_name
           and a.table_name in
               (select max(table_name)
                  from st_idx_rpt_history
                 group by origin_table_name);
    begin
      for my_cur in cu_table loop
        begin
          --»°◊Ó¥Û±Ì
          select max(table_name)
            into v_max_table
            from st_idx_rpt_history
           where origin_table_name = my_cur.tmp_origin_table
           group by origin_table_name;
          --ªÒ»°µ±«∞±Ì
          select regexp_substr(v_max_table, '.{1,3}$')
            into v_temp_num
            from dual;
        end;
      
        begin
          begin
            if my_cur.tmp_recd_count >= my_cur.tmp_divide_recd then
              --¥ÔµΩ≈‰÷√±Ì÷–µƒ◊Ó¥Ûº«¬º ˝£¨–Ë“™Ω®±Ì
              --œ¬“ª∑÷±Ìµƒ–Ú¡–∫≈
              v_temp_num     := up_st_ist_settle_his_num(my_cur.tmp_i_list_no);
              new_table_name := my_cur.tmp_pk_name || '_' || v_temp_num;
              --ªÒ»°Ω®±Ì”Ôæ‰              
              --ÃÊªª±Ì√˚
              select REGEXP_REPLACE(my_cur.tmp_create_sql,
                                    '%s',
                                    new_table_name)
                into v_table_sql
                from dual;
              --ÃÊªªÀ˜“˝
              select REGEXP_REPLACE(v_table_sql,
                                    '%i',
                                    my_cur.tmp_index_name || v_temp_num)
                into v_temp_sql
                from dual;
              --ÃÊªª÷˜º¸
              select REGEXP_REPLACE(v_temp_sql,
                                    '%p',
                                    my_cur.tmp_pk_name || v_temp_num)
                into v_temp_sql
                from dual;
            
              --Ω´Ω®±Ì”Ôæ‰≤Â»ÎµΩ≤‚ ‘±Ì£¨µ˜ ‘”√
              insert into t_test
              values
                (to_char(systimestamp, 'yyyy-mm-dd hh24:mi:ss.ff'),
                 v_temp_sql);
              commit;
              --√ø∏ˆΩ®±Ì”Ôæ‰÷–∫¨”–Ω®À˜“˝°¢÷˜º¸–≈œ¢£¨«““‘£ª∑÷∏Ó
              declare
                cursor sql_cur is
                  select * from table(splitstr(v_temp_sql, ';'));
              begin
                for t_cur in sql_cur loop
                  v_table_sql := t_cur.column_value;
                  insert into t_test
                  values
                    (to_char(systimestamp, 'yyyy-mm-dd hh24:mi:ss.ff'),
                     v_table_sql);
                  commit;
                  if trim(v_table_sql) is not null and v_table_sql <> ' ' then
                    execute immediate v_table_sql; --¥¥Ω®001∑÷±Ìœ‡πÿµƒ≤Ÿ◊˜
                  end if;
                end loop;
              end;
            
              begin
                if my_cur.tmp_is_squadDay = 1 then
                  v_min_time := my_cur.tmp_max_squad_day;
                  v_max_time := my_cur.tmp_max_squad_day;
                else
                  v_min_time := '19790101';
                  v_max_time := '19790101';
                end if;
                begin
                  select count(*)
                    into v_count
                    from st_idx_rpt_history
                   where table_name = new_table_name;
                
                  insert into st_idx_rpt_history
                    (table_name,
                     origin_table_name,
                     begin_balance_no,
                     end_balance_no,
                     min_squad_day,
                     max_squad_day,
                     recd_count)
                  values
                    (new_table_name,
                     my_cur.tmp_origin_table,
                     my_cur.tmp_max_balance_no,
                     my_cur.tmp_max_balance_no,
                     v_min_time,
                     v_max_time,
                     0);
                end;
              end; --if…œµƒbegin    
            
            end if;
          end;
        
        end; --loop÷–µƒµ⁄2∏ˆbegin
      end loop;
    end; -- for÷Æ«∞µƒbegin
    out_msg       := 'Ω®±Ì≥…π¶';
    out_retResult := sqlcode;
    commit;
  end; --declare«∞µƒbegin

exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retResult := sqlcode;
      return;
    end;
  
END up_st_ist_settle_rpt_create;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_RPT_CREATE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_RPT_MV
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.UP_ST_IST_SETTLE_RPT_MV(out_retresult     OUT INTEGER, --∑µªÿΩ·π˚
                                                    out_msg           OUT VARCHAR2, --∑µªÿ–≈œ¢                      
                                                    oper_no           in VARCHAR2, --≤Ÿ◊˜‘±–≈œ¢
                                                    center_balance_no in varchar2) -- ‰»Îµƒ¡˜ÀÆ∫≈
  ---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  UP_balance_his_mid
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„--÷–º‰±Ì ˝æ›µº»Î¿˙ ∑±Ì£¨∂ØÃ¨≤Â»Î , ∂ØÃ¨¥¥Ω®
  -- ‰»Î≤Œ ˝: @origin_table_name  ÷–º‰±Ì√˚ 
  -- ‰≥ˆ≤Œ ˝  £∫return_num ƒ£øÈ∑µªÿ÷µ
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫’≈Ω®ª™
  --¥¥Ω®»’∆⁄£∫20131028
  --¥¥Ω®√Ë ˆ£∫µ±ƒø«∞À˘ π”√µƒ±Ì÷–º«¬º±£¥Ê ±º‰≥¨π˝‘§œ»…Ë∂®µƒ±£¥ÊÃÏ ˝ ±£¨
  --          ‘ÚΩ´±æ±Ì÷–≥¨≥ˆ±£¥Ê ±º‰∑∂Œßµƒº«¬º÷µ≤Â»Î¿˙ ∑∑÷±Ì÷–Ω¯––±£¥Ê∫Û‘ŸΩ¯––…æ≥˝≤Ÿ◊˜£¨
  --          À˘”–≤Ÿ◊˜æ˘–Ë”–œ‡”¶»’÷æ±£¥Ê”⁄«Â¿Ì»’÷æ±Ìclear_table_log÷–
  -------------------------------------------------------------------------------
 AS
  --memo      varchar2(255); --◊¢ Õ
  --err       int; --¥ÌŒÛ–≈œ¢
  v_sql     varchar2(2048);
  v_sqldel  varchar2(2048);
  max_table varchar2(40); --◊Ó¥Ûµƒ¿˙ ∑±Ì
  c_begin   varchar2(10); --µ±«∞±Ì∂‘”¶µƒø™ º ±º‰
  -- c_end     char(10); --µ±«∞±Ì∂‘”¶µƒΩ· ¯ ±º‰
  v_count integer; --
  ss      varchar2(2048);

  begin_time   date; --«Â¿Ìø™ º ±º‰
  minDate      varchar2(8); --◊Ó–°‘À”™»’
  maxDate      varchar2(8); --◊Ó¥Û‘À”™»’
  max_water_no varchar2(10); --µº»Î ˝æ›∫Ûµƒ¿˙ ∑±Ì◊Ó¥Û¡˜ÀÆ∫≈

  origin_table_name varchar2(30); --÷–º‰±Ì±Ì√˚
  --keep_days         int; --÷–º‰±Ì±£¥ÊÃÏ ˝
  --clear_flag        int; -- «∑Ò«Â¿Ì±Í÷æ   1 «Â¿Ì£¨2£¨≤ª«Â¿Ì
  --is_squadDay       int; -- «∑Ò”–«ÂÀ„‘À”™»’◊÷∂Œ 1 ”–£¨0 √ª”–
  table_columns  varchar2(1000); --÷–º‰±Ì∏˜◊÷∂Œ
  v_cost_seconds int; --Õ≥º∆ ±º‰
  v_msg          varchar2(255); --◊¢ Õ
BEGIN
  begin
    declare
      cursor scc_table is
        select t.origin_table_name tmp_origin_table,
               t.keep_days         tmp_keep_days,
               t.clear_flag        tmp_clear_flag,
               t.is_squadDay       tmp_is_squadDay,
               t.table_columns     tmp_table_columns
          from st_cfg_clear_table t;
    begin
    
      for i_cur in scc_table loop
      
        origin_table_name := trim(i_cur.tmp_origin_table);
        table_columns     := trim(i_cur.tmp_table_columns);
        begin_time        := sysdate;
        --«Â¿Ì±Í÷æŒ™1 ±≤≈«Â¿Ì÷–º‰±Ì÷¡¿˙ ∑±Ì
        --µ•∂¿¥¶¿Ì÷–º‰station_entry_rpt£¨∏˘æ›‘À”™»’Ω¯–– ˝æ›µƒ¿˙ ∑±Ìµº»Î-º˚£∫UP_balance_his_mid_squadDay
        --‘⁄≈‰÷√±Ì÷– clear_table_config µƒstation_entry_rpt µƒ clear_flag …Ë÷√Œ™-1
        if i_cur.tmp_clear_flag = 1 then
          --◊Ó¥Û±Ì
          v_sql := 'select max(table_name) from st_idx_rpt_history where origin_table_name = ''' ||
                   origin_table_name || '''';
          execute immediate v_sql
            into max_table;
        
          ss    := table_columns;
          v_sql := ' insert into t#st_sts_inc_count select count(*) from ' ||
                   max_table || ' where balance_water_no =''' ||
                   center_balance_no || '''';
          execute immediate v_sql;
        
          select cnt into v_count from t#st_sts_inc_count;
          delete from t#st_sts_inc_count;
        
          if v_count > 0 then
            begin
              rollback;
              out_retresult  := -100;
              out_msg        := '“—æ≠Ω¯––π˝µ±»’«ÂÀ„ ';
              v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
              up_st_ist_settle_log_add(max_table,'t#st_sts_inc_count',center_balance_no,begin_time,sysdate,v_cost_seconds,0,out_msg,v_sql);
              return;
            end;
          end if;
          --∂‘◊Ó¥Ûµƒ¿˙ ∑±Ìµº»Î ˝æ›
          --begin_time:º∆ ±ø™ º ±º‰
          begin_time := sysdate;
        
          select begin_balance_no
            into c_begin
            from st_idx_rpt_history
           where table_name = max_table;
          begin
            v_sql := ' insert into ' || max_table || ' select ' || ss ||
                     ' from ' || origin_table_name ||
                     ' where balance_water_no <''' ||
                     to_char(sysdate - i_cur.tmp_keep_days, 'yyyymmdd') ||
                     '01'' and balance_water_no >=''' || c_begin || '''';
            execute immediate v_sql;
          EXCEPTION
            when others then
              begin
                rollback;
                out_retresult  := SQLCODE;
                out_msg        := origin_table_name || '≤Â»Î¿˙ ∑±Ì¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' ||
                                  SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                  dbms_utility.format_error_backtrace() || ']––';
                v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                up_st_ist_settle_log_add(origin_table_name,max_table,center_balance_no,begin_time,sysdate,v_cost_seconds,0,out_msg,v_sql);
                return;
              end;
          end;
          begin
            --∏¸–¬st_idx_rpt_history±Ì–≈œ¢
            v_sql := 'insert into t#st_sts_inc_count select count(*) from ' ||
                     origin_table_name || ' where balance_water_no <''' ||
                     to_char(sysdate - i_cur.tmp_keep_days, 'yyyymmdd') ||
                     '01'' and balance_water_no >=''' || c_begin || '''';
            execute immediate v_sql;
          EXCEPTION
            when others then
              begin
                rollback;
                out_retresult  := SQLCODE;
                out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_v_count≤Â»Î ˝æ›¥ÌŒÛ,¥ÌŒÛ¥˙¬Î:' ||
                                  SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                  dbms_utility.format_error_backtrace() || ']––';
                v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                up_st_ist_settle_log_add(origin_table_name,'0',center_balance_no,begin_time,sysdate,v_cost_seconds,0,out_msg,v_sql);
                return;
              end;
          end;
          select cnt into v_count from t#st_sts_inc_count;
          delete from t#st_sts_inc_count;
          --–¥»Î»’÷æº«¬º±Ìclear_table_log
          out_msg := '¥”' || origin_table_name || '±Ì÷–µº»Î' || max_table ||
                     '¿˙ ∑±Ìµƒ ˝æ›≥…π¶£¨º«¬º ˝£∫'||v_count;
          up_st_ist_settle_log_add(origin_table_name,max_table,center_balance_no,begin_time,sysdate,v_cost_seconds,v_count,out_msg,v_sql);                 
       
          --»Áπ˚µº»Îµƒ ˝æ›Œ™0£¨‘Ú≤ªΩ¯––“‘œ¬À˜“˝±Ìµƒ∏¸–¬ 
          if v_count > 0 then
            begin
              begin
                v_sql := 'insert into t#st_sts_inc_no_max select max(balance_water_no) from ' ||
                         max_table;
                execute immediate v_sql;
              EXCEPTION
                when others then
                  begin
                    rollback;
                    out_retresult  := SQLCODE;
                    out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_no_max÷–≤Â»Î ˝æ›¥ÌŒÛ£∫¥ÌŒÛ¥˙¬Î£∫' ||
                                      SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                      dbms_utility.format_error_backtrace() || ']––';
                    v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                    up_st_ist_settle_log_add(max_table,'t#st_sts_inc_no_max',center_balance_no,begin_time,sysdate,v_cost_seconds,0,out_msg,v_sql);                 
                    return;
                  end;
              end;
              select nvl(max_water_no, c_begin)
                into max_water_no
                from t#st_sts_inc_no_max;
            
              delete from t#st_sts_inc_no_max;
              --”–‘À”™»’–≈œ¢
              if i_cur.tmp_is_squadDay = 1 then
                begin
                  begin
                    v_sql := 'insert into t#st_sts_inc_day_max select max(squad_day) from ' ||
                             max_table;
                    execute immediate v_sql;
                  EXCEPTION
                    when others then
                      begin
                        rollback;
                        out_retresult  := SQLCODE;
                        out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_day_max÷–≤Â»Î ˝æ›¥ÌŒÛ£∫¥ÌŒÛ¥˙¬Î£∫ ' ||
                                          SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                          dbms_utility.format_error_backtrace() || ']––';
                        v_cost_seconds := ROUND(TO_NUMBER(sysdate -
                                                          begin_time) * 24 * 60 * 60);
                        up_st_ist_settle_log_add(max_table,'t#st_sts_inc_day_max',center_balance_no,begin_time,sysdate,v_cost_seconds,0,out_msg,v_sql);
                      
                        return;
                      end;
                  end;
                  begin
                    select max_squadDate
                      into maxDate
                      from t#st_sts_inc_day_max;
                  
                    delete from t#st_sts_inc_day_max;
                  
                  end;
                
                  begin
                    v_sql := 'insert into t#st_sts_inc_day_min select min(squad_day) from ' ||
                             max_table;
                    execute immediate v_sql;
                  EXCEPTION
                    when others then
                      begin
                        rollback;
                        out_retresult  := SQLCODE;
                        out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_day_min÷–≤Â»Î ˝æ›¥ÌŒÛ£∫¥ÌŒÛ¥˙¬Î£∫ ' ||
                                          SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                          dbms_utility.format_error_backtrace() || ']––';
                        v_cost_seconds := ROUND(TO_NUMBER(sysdate -
                                                          begin_time) * 24 * 60 * 60);
                        up_st_ist_settle_log_add(max_table,'t#st_sts_inc_day_min',center_balance_no,begin_time,sysdate,v_cost_seconds,0,out_msg,v_sql);
                        return;
                      end;
                    
                  end;
                
                  begin
                    select min_squadDate
                      into minDate
                      from t#st_sts_inc_day_min;
                  
                    delete from t#st_sts_inc_day_min;
                  
                    update st_idx_rpt_history
                       set recd_count     = recd_count + v_count,
                           min_squad_day  = minDate,
                           max_squad_day  = maxDate,
                           end_balance_no = max_water_no
                     where table_name = max_table;
                  
                  end;
                
                end;
              end if;
              --Œﬁ‘À”™»’–≈œ¢
              if i_cur.tmp_is_squadDay = 0 then
                begin
                  update st_idx_rpt_history
                     set recd_count     = recd_count + v_count,
                         end_balance_no = max_water_no
                   where table_name = max_table;
                
                end;
              end if;
            
            end;
            NULL;
          end if;
          --…æ≥˝“—æ≠µº»Î¿˙ ∑±Ìµƒ ˝æ›
          begin_time := sysdate;
          begin
            v_sqldel := ' delete from ' || origin_table_name ||
                        ' where balance_water_no <''' ||
                        to_char(sysdate - i_cur.tmp_keep_days, 'yyyymmdd') ||
                        '01'' and balance_water_no >=''' || c_begin || '''';
            execute immediate v_sqldel;
          EXCEPTION
            when others then
              begin
                rollback;
                out_retresult  := SQLCODE;
                out_msg        := 'œÚ¡Ÿ ±±Ìt#st_sts_inc_day_min÷–≤Â»Î ˝æ›¥ÌŒÛ£∫¥ÌŒÛ¥˙¬Î£∫ ' ||
                                  SQLERRM || ',∑¢…˙‘⁄µ⁄[' ||
                                  dbms_utility.format_error_backtrace() || ']––';
                v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
                up_st_ist_settle_log_add(origin_table_name,'0',center_balance_no,begin_time,sysdate,v_cost_seconds,v_count,out_msg,v_sql);
                return;
              end;
            
          end;
          out_msg        := '…æ≥˝' || origin_table_name || '±Ì÷–µº»Î' ||
                            max_table || '¿˙ ∑±Ìµƒ ˝æ›≥…π¶';
          v_cost_seconds := ROUND(TO_NUMBER(sysdate - begin_time) * 24 * 60 * 60);
          up_st_ist_settle_log_add(origin_table_name,max_table,center_balance_no,begin_time,sysdate,v_cost_seconds,v_count,out_msg,v_sql);
        end if;
      end loop;
    
    end;
    out_msg:='≥…π¶«®“∆ ˝æ›';
    out_retresult := sqlcode;
  end;
exception
  when OTHERS THEN
    begin
      ROLLBACK;
      out_msg       := v_msg || '¥ÌŒÛ£∫' || sqlerrm || ',∑¢…˙‘⁄µ⁄[' ||
                       dbms_utility.format_error_backtrace() || ']––';
      out_retResult := sqlcode;
      return;
    end;
  
END UP_ST_IST_SETTLE_RPT_MV;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_RPT_MV to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_SAM
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_ist_settle_sam(
 out_retResult OUT INTEGER, --∑µªÿΩ·π˚
   out_msg OUT VARCHAR2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2

)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  UP_ST_IST_SETTLE_SAM
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫SAMø®∂œ∫≈°¢÷ÿ∫≈∑÷Œˆ
-- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
         --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
         --ver1.11 ”≈ªØ–‘ƒ‹    ∏¸–¬»’∆⁄2015-1-8
         --ver1.12 “ÚŒ™÷ÿ–¬≤˙…˙¿˙ ∑Samø®–£—È ˝æ› ¡Ÿ ±∆¡±Œƒ⁄»› ∏¸–¬»’∆⁄2015-2-6
         --ver1.2 Ω¯“ª≤Ω”≈ªØ–‘ƒ‹ ≤¢÷ÿ–¬…˙≥… ˝æ›   ∏¸–¬»’∆⁄2015-3-2 ¿Ó¿Ú
         --ver1.31”≈ªØ¥Ê¥¢π˝≥Ã lindaquan 20160329
	       --ver1.32–ﬁ∏¥…œ“ª∞Ê±æ”≈ªØŒ Ã‚ lindaquan 20160408
-------------------------------------------------------------------------------
AS
   v_msg VARCHAR(80);
   v_count number(17);
   v_begin_time date;
   v_mod_name char(50);
   v_n number(10);
BEGIN

  delete st_act_sam_del where del_balance_no=in_balance_water_no;
  delete st_err_sam_water where balance_water_no=in_balance_water_no;

  v_mod_name:='up_st_ist_settle_sam';
  select  sysdate into v_begin_time from dual;

  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMPµ•≥Ã∆±∑¢ €';
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '50',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_sale_sjt where balance_water_no = in_balance_water_no;
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMP∑¢ €';
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '51',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_sale where balance_water_no = in_balance_water_no;
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMPΩ¯’æ';--–ﬁ∏ƒ2015-2-5£∫π´Ωªø®samø®¡˜ÀÆŒ™0 £¨≥˝Õ‚
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '53',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_entry where balance_water_no = in_balance_water_no and card_main_id!='06';
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMP«Æ∞¸Ωª“◊';--–ﬁ∏ƒ2015-2-5£∫π´Ωªø®samø®∫Õ≥‰÷µº«¬º¡˜ÀÆŒ™0 £¨≥˝Õ‚;
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '54',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_deal where balance_water_no = in_balance_water_no
       and card_main_id!='06' and (pay_mode_id!='14' or (pay_mode_id='14' and sam_trade_seq!=0 ));
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMP∏¸–¬';--–ﬁ∏ƒ2015-2-5£∫π´Ωªø®samø®¡˜ÀÆŒ™0 £¨≥˝Õ‚
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '56',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_update where balance_water_no = in_balance_water_no and card_main_id!='06';
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMPÕÀø®';
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '57',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_return where balance_water_no = in_balance_water_no;
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMPÀ¯ø®';
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '59',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_lock where balance_water_no = in_balance_water_no;
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMP—”∆⁄';
  INSERT INTO t#st_ist_settle_sam_tmp
  SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
         '55',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
  FROM st_que_delay where balance_water_no = in_balance_water_no;
  v_msg := '≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMP≤‚ ‘ ˝æ›';
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '50',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_sale_sjt where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '51',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_sale where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '53',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_entry where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '54',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_deal where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '56',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_update where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '57',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_return where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '59',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_lock where balance_water_no=in_balance_water_no;
  INSERT INTO t#st_ist_settle_sam_tmp
      SELECT seq_t#st_ist_settle_sam_tmp.nextval,line_id,station_id,dev_type_id,device_id,
             '55',sam_logical_id,sam_trade_seq,case card_main_id when '01' then '0' else '1' end
      FROM st_tst_delay where balance_water_no=in_balance_water_no;

  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,1,'≤Â»Î±ÌT#ST_IST_SETTLE_SAM_TMP∂”¡– ˝æ›');

  ---≤˙…˙samΩª“◊¡˜ÀÆ∫≈¥ÌŒÛº«¬º
  select  sysdate into v_begin_time from dual;
  v_msg := '◊‘…Ì÷ÿ∫≈µƒº«¬º≤Â»Î±Ìsamø®¡˜ÀÆ∫≈¥ÌŒÛ±Ìst_err_sam_water'; --2015-1-23”≈ªØ–‘ƒ‹£¨–ﬁ∏ƒ
  insert into st_err_sam_water
    (water_no, line_id, station_id, dev_type_id, device_id, tr_type_id,
    sam_logical_id, err_code, balance_water_no, tk_app_mode, sam_trade_seq_start, sam_trade_seq_end)
   select seq_st_err_sam_water.nextval,line_id,station_id,dev_type_id,device_id, tr_type_id,
          sam_logical_id,error_code,in_balance_water_no,tk_app_mode,sam_trade_seq,sam_trade_seq
    from (select line_id,station_id,dev_type_id,device_id,tr_type_id, sam_logical_id,sam_trade_seq,
                 '01' error_code,tk_app_mode
           from t#st_ist_settle_sam_tmp
           group by line_id,station_id,dev_type_id,device_id,tk_app_mode,tr_type_id,sam_logical_id,sam_trade_seq
           having count(*)>1);
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,2,v_msg);


  select  sysdate into v_begin_time from dual;
  v_msg := '∫≈¬Î∫œ≤¢≤Â»Î±ÌT#ST_IST_SETTLE_SAM_LIST';
  insert into t#st_ist_settle_sam_list
  SELECT b.line_id,b.station_id,b.dev_type_id,b.device_id,b.sam_logical_id,
         MIN(b.sam_trade_seq),MAX(b.sam_trade_seq),0,b.tk_app_mode,'0',''
   FROM (SELECT a.*, TO_NUMBER(a.sam_trade_seq - ROWNUM) cc
       FROM (SELECT distinct line_id,station_id,dev_type_id,device_id,sam_logical_id,sam_trade_seq,tk_app_mode
             FROM t#st_ist_settle_sam_tmp
             ORDER BY line_id,station_id,dev_type_id,device_id,tk_app_mode,sam_logical_id,sam_trade_seq) a
             ) b
   GROUP BY b.line_id,b.station_id,b.dev_type_id,b.device_id,tk_app_mode,b.sam_logical_id,b.cc;
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,3,v_msg);


  select  sysdate into v_begin_time from dual;
  v_msg := '”Îst_act_sam÷ÿ∫≈µƒº«¬º≤Â»Î¡Ÿ ±±Ì';
  -- Õ¨ ±Ω´÷ÿ∏¥º«¬º‘⁄st_act_samµƒ–Ú∫≈∂Œº«¬º£¨
  --list_sam_start:list±Ìø™ º–Ú∫≈;  list_sam_end:list±ÌΩ· ¯–Ú∫≈;
  --sam_trade_seq_start:÷ÿ∫≈ø™ º–Ú∫≈;  sam_trade_seq_end:÷ÿ∫≈Ω· ¯–Ú∫≈;
  --act_sam_start:sam’Àªß±Ìø™ º–Ú∫≈;  act_sam_end:sam’Àªß±ÌΩ· ¯–Ú∫≈;
  --act_sam_start_new:∫œ≤¢∫Ûø™ º–Ú∫≈;  act_sam_end_new:∫œ≤¢∫ÛΩ· ¯–Ú∫≈;
  -- flag£∫0£®st_act_sam–Ú∫≈∂Œ∏≤∏«»´≤ø£©£¨1£®–¬º«¬º–Ú∫≈∂Œ∏≤∏«st_act_sam≤ø∑÷–Ú∫≈∂Œ£©,2(–¬º«¬º–Ú∫≈∂Œ∏≤∏«st_act_sam»´≤ø–Ú∫≈∂Œ)
  -- b.s<a.s<b.e
  insert into t#st_ist_settle_sam_exist
    (line_id,station_id,dev_type_id,device_id,sam_logical_id,err_code,balance_water_no,tk_app_mode,
         sam_trade_seq_start,sam_trade_seq_end,act_sam_start,act_sam_end,flag,act_sam_start_new,act_sam_end_new,list_sam_start,list_sam_end)
  select a.line_id,a.station_id,a.dev_type_id,a.device_id,a.sam_logical_id,'02', b.balance_water_no, a.tk_app_mode,
         a.sam_trade_seq_start,case when a.sam_trade_seq_end>b.sam_trade_seq_end then b.sam_trade_seq_end else a.sam_trade_seq_end end,
         b.sam_trade_seq_start,b.sam_trade_seq_end,
         case when a.sam_trade_seq_end>b.sam_trade_seq_end then 1 else 0 end,
         b.sam_trade_seq_start,a.sam_trade_seq_end,a.sam_trade_seq_start,a.sam_trade_seq_end
         from acc_st.t#st_ist_settle_sam_list a, acc_st.st_act_sam b
         where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id and a.device_id=b.device_id
         and a.tk_app_mode=b.tk_app_mode and a.sam_logical_id=b.sam_logical_id
         and a.sam_trade_seq_start between b.sam_trade_seq_start and b.sam_trade_seq_end;
  -- b.s<a.s,b.s<a.e<b.e
  insert into t#st_ist_settle_sam_exist
    (line_id,station_id,dev_type_id,device_id,sam_logical_id,err_code,balance_water_no,tk_app_mode,
         sam_trade_seq_start,sam_trade_seq_end,act_sam_start,act_sam_end,flag,act_sam_start_new,act_sam_end_new,list_sam_start,list_sam_end)
  select a.line_id,a.station_id,a.dev_type_id,a.device_id,a.sam_logical_id,'02', b.balance_water_no, a.tk_app_mode,
         b.sam_trade_seq_start,a.sam_trade_seq_end,b.sam_trade_seq_start,b.sam_trade_seq_end,1,
         a.sam_trade_seq_start,b.sam_trade_seq_end,a.sam_trade_seq_start,a.sam_trade_seq_end
         from acc_st.t#st_ist_settle_sam_list a, acc_st.st_act_sam b
         where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id and a.device_id=b.device_id
         and a.tk_app_mode=b.tk_app_mode and a.sam_logical_id=b.sam_logical_id
         and a.sam_trade_seq_end between b.sam_trade_seq_start and b.sam_trade_seq_end
         and a.sam_trade_seq_start<b.sam_trade_seq_start;
  -- a.s<b.s,b.e<a.e
  insert into t#st_ist_settle_sam_exist
    (line_id,station_id,dev_type_id,device_id,sam_logical_id,err_code,balance_water_no,tk_app_mode,
         sam_trade_seq_start,sam_trade_seq_end,act_sam_start,act_sam_end,flag,act_sam_start_new,act_sam_end_new,list_sam_start,list_sam_end)
  select a.line_id,a.station_id,a.dev_type_id,a.device_id,a.sam_logical_id,'02',b.balance_water_no,a.tk_app_mode,
         b.sam_trade_seq_start,b.sam_trade_seq_end,b.sam_trade_seq_start,b.sam_trade_seq_end,2,
         a.sam_trade_seq_start,b.sam_trade_seq_end,a.sam_trade_seq_start,a.sam_trade_seq_end
         from acc_st.t#st_ist_settle_sam_list a, acc_st.st_act_sam b
         where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id and a.device_id=b.device_id
         and a.tk_app_mode=b.tk_app_mode and a.sam_logical_id=b.sam_logical_id
         and a.sam_trade_seq_end>b.sam_trade_seq_end and a.sam_trade_seq_start<b.sam_trade_seq_start;

  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,4,v_msg);


  select  sysdate into v_begin_time from dual;
  v_msg := '”Îst_act_sam÷ÿ∫≈µƒº«¬º¥”¡Ÿ ±±Ì≤Â»Îst_err_sam_water';
  insert into st_err_sam_water
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, err_code, balance_water_no,
    sam_trade_seq_start, sam_trade_seq_end, tk_app_mode)
  select seq_st_err_sam_water.nextval,line_id,station_id,dev_type_id,device_id, sam_logical_id,err_code,in_balance_water_no,
         sam_trade_seq_start,sam_trade_seq_end,tk_app_mode
   FROM (select distinct line_id,station_id,dev_type_id,device_id,
                sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,err_code,tk_app_mode
         from t#st_ist_settle_sam_exist);
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,5,v_msg);


  --≤Â»Î≤¢–ﬁ∏ƒsamø®’Àªß±Ì
  select  sysdate into v_begin_time from dual;
  v_msg := 'st_act_sam÷–”Î±æ¥Œ«ÂÀ„¡¨–¯1µƒ∫≈¬Î∂Œ≤Â»Î¡Ÿ ±±Ì';  --2015-1-8Œ™”≈ªØ–‘ƒ‹£¨∏ƒŒ™≤Â»Î¡Ÿ ±±Ì
  -- ”Îst_act_sam¡¨–¯–Ú∫≈µƒº«¬º∫œ≤¢≤Â»Î’Àªß¡Ÿ ±±Ì
  insert into t#st_ist_settle_sam_tmp1
  SELECT distinct  b.line_id,b.station_id,b.dev_type_id,b.device_id,b.sam_logical_id,
          b.sam_trade_seq_start,b.sam_trade_seq_end,b.total_deal_num,b.balance_water_no,b.tk_app_mode
   FROM t#st_ist_settle_sam_list a,st_act_sam b
   where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id and
  a.device_id=b.device_id and a.tk_app_mode=b.tk_app_mode
  and a.sam_logical_id=b.sam_logical_id
  and (a.sam_trade_seq_end+1=b.sam_trade_seq_start or b.sam_trade_seq_end+1=a.sam_trade_seq_start);
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,6,v_msg);


  select  sysdate into v_begin_time from dual;
  v_msg := 'Ω´st_act_sam÷–”Î±æ¥Œ«ÂÀ„∫œ≤¢µƒ∫≈¬Î∂Œ≤Â»Îst_act_sam_del';
  -- ¡¨–¯
  insert into st_act_sam_del(line_id ,station_id,dev_type_id,device_id,tk_app_mode,
    sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no,del_balance_no)
  select a.line_id ,a.station_id,a.dev_type_id,a.device_id,a.tk_app_mode,
    a.sam_logical_id,a.sam_trade_seq_start,a.sam_trade_seq_end,a.total_deal_num,a.balance_water_no,in_balance_water_no
  from t#st_ist_settle_sam_tmp1 a;
  -- ≤ª¡¨–¯
  insert into st_act_sam_del(line_id ,station_id,dev_type_id,device_id,tk_app_mode,
    sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no,del_balance_no)
  select a.line_id ,a.station_id,a.dev_type_id,a.device_id,a.tk_app_mode,
    a.sam_logical_id,a.act_sam_start,a.act_sam_end,a.act_sam_end-a.act_sam_start+1,a.balance_water_no,in_balance_water_no
  from t#st_ist_settle_sam_exist a where a.flag>0;
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,7,v_msg);

  select  sysdate into v_begin_time from dual;
  v_msg := '…æ≥˝st_act_sam÷–”Î±æ¥Œ«ÂÀ„∫œ≤¢µƒ∫≈¬Î∂Œ';
  -- ¡¨–¯
  delete from st_act_sam a
  where exists (select 1 from t#st_ist_settle_sam_tmp1  b
   where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id and
  a.device_id=b.device_id and a.tk_app_mode=b.tk_app_mode
  and a.sam_logical_id=b.sam_logical_id and a.sam_trade_seq_start=b.sam_trade_seq_start
  and a.sam_trade_seq_end=b.sam_trade_seq_end);
  -- ≤ª¡¨–¯
  delete from st_act_sam a
  where exists (select 1 from t#st_ist_settle_sam_exist b
        where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id
         and a.device_id=b.device_id and a.tk_app_mode=b.tk_app_mode
         and a.sam_logical_id=b.sam_logical_id and b.flag>0
         and a.sam_trade_seq_start=b.act_sam_start and a.sam_trade_seq_end=b.act_sam_end);
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,8,v_msg);


  -- ”Îst_act_sam÷ÿ∫≈µƒº«¬º∫œ≤¢≤Â»Î’Àªß¡Ÿ ±±Ì
  insert into t#st_ist_settle_sam_tmp1
  SELECT distinct  b.line_id,b.station_id,b.dev_type_id,b.device_id,b.sam_logical_id,
          b.act_sam_start_new,b.act_sam_end_new,b.act_sam_end_new-b.act_sam_start_new+1,b.balance_water_no,b.tk_app_mode
   FROM t#st_ist_settle_sam_exist b where flag>0;

  select  sysdate into v_begin_time from dual;
  v_msg := 'st_act_sam÷–”Î±æ¥Œ«ÂÀ„∫œ≤¢µƒ∫≈¬Î∂Œ≤Â»Ît#st_ist_settle_sam_list';
  -- …æ≥˝“—æ≠∫œ≤¢≤ø∑÷æ…µƒº«¬º
  delete t#st_ist_settle_sam_list a where exists(
         select 1 from t#st_ist_settle_sam_exist b
         where a.line_id=b.line_id and a.station_id=b.station_id
               and a.dev_type_id=b.dev_type_id and a.device_id=b.device_id
               and a.tk_app_mode=b.tk_app_mode and a.sam_logical_id=b.sam_logical_id
               and a.sam_trade_seq_start=b.list_sam_start and a.sam_trade_seq_end=b.list_sam_end
  );
  insert into t#st_ist_settle_sam_list
  SELECT  b.line_id,b.station_id,b.dev_type_id,b.device_id,b.sam_logical_id,
          b.sam_trade_seq_start,b.sam_trade_seq_end,b.total_deal_num,b.tk_app_mode,'0',''
   FROM t#st_ist_settle_sam_tmp1 b ;
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,9,v_msg);


  select  sysdate into v_begin_time from dual;
  v_msg := '¡Ÿ ±±Ì¡¨–¯∫≈¬Î∂Œ∫œ≤¢';
  v_count:=1;
  v_n:=0;
  -- »•÷ÿ∏¥
   delete acc_st.t#st_ist_settle_sam_list1;
   insert into acc_st.t#st_ist_settle_sam_list1
      (line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end, tk_app_mode)
   select line_id, station_id, dev_type_id, device_id, sam_logical_id, min(sam_trade_seq_start), sam_trade_seq_end, tk_app_mode
   from t#st_ist_settle_sam_list
   group by line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_end, tk_app_mode;
   delete acc_st.t#st_ist_settle_sam_list;
   insert into acc_st.t#st_ist_settle_sam_list
      (line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end, tk_app_mode)
   select line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, max(sam_trade_seq_end), tk_app_mode
   from t#st_ist_settle_sam_list1
   group by line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, tk_app_mode;

  delete acc_st.t#st_ist_settle_sam_list1;
  insert into acc_st.t#st_ist_settle_sam_list1
    (id, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end,
         tk_app_mode, flag)
  select rownum, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end,
         tk_app_mode, '0'
  from t#st_ist_settle_sam_list t order by t.sam_logical_id,t.tk_app_mode,t.sam_trade_seq_start;

  while v_count>0 and v_n<50 loop
     -- ∏¸–¬∆Ê≈ºø…∫œ≤¢°¢–Ú∫≈œ‡¡⁄µƒº«¬ºŒ™1
     merge into acc_st.t#st_ist_settle_sam_list1 a
     using acc_st.t#st_ist_settle_sam_list1 b
     on(
           a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id
           and a.device_id=b.device_id and a.tk_app_mode=b.tk_app_mode
           and a.sam_logical_id=b.sam_logical_id and a.sam_trade_seq_end+1=b.sam_trade_seq_start
           and a.id+1 = b.id
           and mod(a.id,2)=0 and mod(b.id,2)=1 -- ∆Ê≈º––±»Ωœ
     )when matched then
     update set a.flag='1';
     -- ≤Â»Îø…∫œ≤¢º«¬ºµΩlist¡Ÿ ±±Ì
     delete t#st_ist_settle_sam_list;
     insert into t#st_ist_settle_sam_list
       (id, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end,
            tk_app_mode, flag)
     select a.id, a.line_id,a.station_id,a.dev_type_id,a.device_id,a.sam_logical_id,
            a.sam_trade_seq_start,b.sam_trade_seq_end,a.tk_app_mode,'0'
     from acc_st.t#st_ist_settle_sam_list1 a, acc_st.t#st_ist_settle_sam_list1 b
     where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id
     and a.device_id=b.device_id and a.tk_app_mode=b.tk_app_mode
     and a.sam_logical_id=b.sam_logical_id and a.sam_trade_seq_end+1=b.sam_trade_seq_start
     and a.id+1 = b.id
     and mod(a.id,2)=0 and mod(b.id,2)=1; -- ∆Ê≈º––±»Ωœ
     -- ∏¸–¬±ª∫œ≤¢º«¬ºŒ™1
     merge into acc_st.t#st_ist_settle_sam_list1 a
      using acc_st.t#st_ist_settle_sam_list b
      on(
            a.id=b.id+ 1
      )when matched then
      update set a.flag='1';
     -- ≤Â»ÎŒ¥±ª∫œ≤¢º«¬ºµΩlist¡Ÿ ±±Ì
     insert into t#st_ist_settle_sam_list
       (id, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end,
            tk_app_mode, flag)
     select a.id, a.line_id,a.station_id,a.dev_type_id,a.device_id,a.sam_logical_id,
            a.sam_trade_seq_start,a.sam_trade_seq_end,a.tk_app_mode,'0'
     from acc_st.t#st_ist_settle_sam_list1 a
     where a.flag='0';

     -- ∏¸–¬ø…∫œ≤¢º«¬ºŒ™1
     merge into acc_st.t#st_ist_settle_sam_list a
     using acc_st.t#st_ist_settle_sam_list b
     on(
           a.line_id=b.line_id and a.station_id=b.station_id
           and a.dev_type_id=b.dev_type_id and a.device_id=b.device_id
           and a.tk_app_mode=b.tk_app_mode and a.sam_logical_id=b.sam_logical_id
           and a.sam_trade_seq_end+1=b.sam_trade_seq_start
     )when matched then
     update set a.flag='1';
     merge into acc_st.t#st_ist_settle_sam_list a
     using acc_st.t#st_ist_settle_sam_list b
     on(
           a.line_id=b.line_id and a.station_id=b.station_id
           and a.dev_type_id=b.dev_type_id and a.device_id=b.device_id
           and a.tk_app_mode=b.tk_app_mode and a.sam_logical_id=b.sam_logical_id
           and a.sam_trade_seq_start-1=b.sam_trade_seq_end
     )when matched then
     update set a.flag='1';
     -- ≈≈–Úflag='1'º«¬º≤Â»Îlist1¡Ÿ ±±Ì
     delete acc_st.t#st_ist_settle_sam_list1;
     insert into acc_st.t#st_ist_settle_sam_list1
        (id, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end,
             tk_app_mode, flag)
     select rownum, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq_start, sam_trade_seq_end,
             tk_app_mode, '0'
     from t#st_ist_settle_sam_list where flag='1'
     order by sam_logical_id,tk_app_mode,sam_trade_seq_start;
     -- flag='0' ≤ªø…∫œ≤¢º«¬º≤Â»Î
     insert into st_act_sam(line_id ,station_id,dev_type_id,device_id,tk_app_mode,
      sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no)
     SELECT distinct line_id,station_id,dev_type_id,device_id,tk_app_mode
            ,sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,sam_trade_seq_end-sam_trade_seq_start+1,in_balance_water_no
     FROM acc_st.t#st_ist_settle_sam_list where flag='0';

     v_n := v_n+1;
     -- Õ≥º∆ø…∫œ≤¢ ˝æ›
     select count(*) into v_count from acc_st.t#st_ist_settle_sam_list1 a, acc_st.t#st_ist_settle_sam_list1 b
     where a.line_id=b.line_id and a.station_id=b.station_id and a.dev_type_id=b.dev_type_id
     and a.device_id=b.device_id and a.tk_app_mode=b.tk_app_mode
     and a.sam_logical_id=b.sam_logical_id and a.sam_trade_seq_end+1=b.sam_trade_seq_start
     and a.id+1 = b.id
     and mod(a.id,2)=0 and mod(b.id,2)=1; -- ∆Ê≈º––±»Ωœ;

  end loop;
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,10,v_msg);

  select  sysdate into v_begin_time from dual;
   v_msg := '¡Ÿ ±±Ì ˝æ›µº»Îst_act_sam';
   insert into st_act_sam(line_id ,station_id,dev_type_id,device_id,tk_app_mode,
    sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no)
   SELECT distinct line_id,station_id,dev_type_id,device_id,tk_app_mode
          ,sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,sam_trade_seq_end-sam_trade_seq_start+1,in_balance_water_no
   FROM acc_st.t#st_ist_settle_sam_list1;
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,12,v_msg);

  commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when OTHERS THEN
     begin
       ROLLBACK;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
END ;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_SAM to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_SVT_MB
prompt ==========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_svt_mb(
       out_retresult out integer, --∑µªÿΩ·π˚
       out_msg out varchar2 , --∑µªÿ–≈œ¢
       in_balance_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_ist_settle_svt_mb
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫¥¢÷µø®’Àªß¥¶¿Ì( ÷ª˙÷ß∏∂≤ø∑÷)
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  2016-01-15 by lindaquan ver1.30
--–ﬁ∏ƒ£∫    Õ≥º∆’Àªß≤ø∑÷“∆∂ØµΩ…œ“ªº∂¥Ê¥¢π˝≥Ã 2017-02-17 by lindaquan ver1.40
 -------------------------------------------------------------------------------
as
   v_msg varchar(50);
   v_count int;
   v_begin_time date;
   v_mod_name char(50);
begin
    v_mod_name:='up_st_ist_settle_svt_mb';

    -- º”Ω‚À¯
    v_msg := ' ÷ª˙÷ß∏∂∫⁄√˚µ•';
    select sysdate into v_begin_time from dual;

    -- Ω¯»Î∫⁄√˚µ•π˝∆⁄±Ì
    insert into op_prm_black_old_mtr(gen_datetime,cutoff_datetime,card_logical_id,black_type,remark,
     action_type,create_datetime,operator_id,is_set,balance_water_no,delete_datetime,delete_operator_id,delete_remark)
     select distinct gen_datetime,create_datetime,a.card_logical_id,black_type,remark,action_type,create_datetime,
     a.operator_id,is_set,in_balance_water_no,sysdate,user ,'“—À¯ø®'
     from  op_prm_black_list_mtr a,acc_st.st_mb_que_lock b
    WHERE  a.card_logical_id = b.card_logical_id and balance_water_no=in_balance_water_no and lock_flag='2';
    -- Ω‚À¯…æ≥˝∫⁄√˚µ•±Ì
    delete acc_st.op_prm_black_list_mtr where CARD_LOGICAL_ID in(
      select card_logical_id from acc_st.st_mb_que_lock where balance_water_no=in_balance_water_no and lock_flag='2');
    -- º”À¯“∆µΩ∫⁄√˚µ•±Ì
    insert into acc_st.op_prm_black_list_mtr
      select sysdate,b.card_logical_id,'99',' ÷ª˙÷ß∏∂º”À¯('||b.mobile_no||')', '000',b.lock_datetime,b.operator_id,null
      from acc_st.st_mb_que_lock b where b.balance_water_no=in_balance_water_no and b.lock_flag='1';

    insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,1,v_msg);

    commit;

    out_msg :='success';
    out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_SVT_MB to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_SVT
prompt =======================================
prompt
create or replace procedure acc_st.up_st_ist_settle_svt(out_retresult       out integer, --∑µªÿΩ·π˚
                                                 out_msg             out varchar2, --∑µªÿ–≈œ¢
                                                 in_balance_water_no in varchar2)
---------------------------------------------------------------------------------
  --π˝≥Ã√˚£∫  up_st_ist_settle_svt
  --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫¥¢÷µø®’Àªß¥¶¿Ì
  -- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
  --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
  --¥¥Ω®’ﬂ£∫  lindauqan 20170216
  --ver1.40 ”≈ªØ¥¢÷µø®’Àªß¥¶¿Ì¥Ê¥¢π˝≥Ã modify by lindauqan 20170216
  --ver1.42 ÃÌº”¥¢÷µø®÷ÿ”√«Èøˆ¥¶¿Ì modify by lindauqan 20170330
  -------------------------------------------------------------------------------
 as
  v_msg               varchar(50);
  v_count             int;
  v_balance_water_no7 varchar(10);
  v_begin_time        date;
  v_mod_name          char(50);
begin

/*
0203:¿œ»Àø®
*/

--»°±æ¥Œ«ÂÀ„¡˜ÀÆ∫≈
  v_mod_name:='up_st_ist_settle_svt';
  v_balance_water_no7:=to_number(to_char((to_date(substr(in_balance_water_no,1,8),'yyyymmdd')-5),'yyyymmdd')||'01');
  delete acc_st.st_log_balnce_detail where balance_water_no<v_balance_water_no7;--…æ≥˝7ÃÏ«∞µƒ»’÷æ

  select sysdate into v_begin_time from dual;
  v_msg := 'Õ≥º∆∑¢ €‘§∏≥÷µ ˝æ›';
--Õ≥º∆∑¢ € ˝æ›--AFC
  insert into acc_st.t#st_ist_settle_svt_logic
    (card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee,
    system_balance_fee, card_balance_fee, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, hdl_time)
  select card_main_id,card_sub_id,card_logical_id,card_physical_id,0,0,0,0,
    0,0,0,0,in_balance_water_no,card_status_id,deposit_fee,0,sale_datetime
    from acc_st.st_que_sale
    where balance_water_no=in_balance_water_no
    and card_main_id in (select distinct card_main_id from acc_st.op_prm_svt_type) and card_sub_id!='03';

--Õ≥º∆∑¢ € ˝æ›-- ÷ª˙÷ß∏∂
  insert into acc_st.t#st_ist_settle_svt_logic
    (card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee,
    system_balance_fee, card_balance_fee, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, hdl_time)
  select card_main_id,card_sub_id,card_logical_id,card_physical_id,0,0,0,0,
    0,0,0,0,in_balance_water_no,card_status_id,deposit_fee,0,sale_datetime
    from acc_st.st_mb_que_sale
    where balance_water_no=in_balance_water_no
    and card_main_id in (select distinct card_main_id from acc_st.op_prm_svt_type) and card_sub_id!='03';

--Õ≥º∆‘§∏≥÷µ ˝æ›--ES
  insert into acc_st.t#st_ist_settle_svt_logic
    (card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee,
    system_balance_fee, card_balance_fee, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, hdl_time)
  select a.card_main_type,a.card_sub_type,a.logical_id,a.phy_id,0,0,0,0,
    0,0,0,0,in_balance_water_no,'101',b.burse_uplimit/100,a.card_money/100,a.hdl_time
    from acc_tk.ic_es_hunch_info a, acc_tk.ic_pdu_order_form b
    where to_char(a.insert_time,'yyyyMMdd')||'01'=in_balance_water_no
    and a.order_no=b.order_no(+)
    and a.card_main_type in (select distinct card_main_id from acc_st.op_prm_svt_type) and a.card_sub_type!='03';

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,1,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := 'Õ≥º∆÷ÿ∏¥∑¢ €‘§∏≥÷µ¬ﬂº≠ø®∫≈';

--≤Â»Î¿˙ ∑∑¢ €°¢‘§∏≥÷µ¬ﬂº≠ø®∫≈
  insert into acc_st.st_sts_sale_hunch
    (card_main_id, card_sub_id, card_logical_id, card_physical_id, deal_datetime, balance_water_no)
  select card_main_id, card_sub_id, card_logical_id, card_physical_id, hdl_time, balance_water_no
  from acc_st.t#st_ist_settle_svt_logic;
  insert into acc_st.t#st_sts_sale_hunch(card_logical_id, card_physical_id)
  select card_logical_id, rpad(trim(card_physical_id),14,'0') card_physical_id from acc_st.st_sts_sale_hunch group by card_logical_id, rpad(trim(card_physical_id),14,'0');

--÷ÿ∏¥∑¢ €°¢‘§∏≥÷µ¬ﬂº≠ø®∫≈≤Â»Î¡Ÿ ±±Ì
  insert into acc_st.t#st_ist_settle_svt_logicno(card_logical_id)
  select card_logical_id from acc_st.t#st_sts_sale_hunch group by card_logical_id having count(1)>1;

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,2,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := 'Ãﬁ≥˝±∏∑›÷ÿ∏¥∑¢ €‘§∏≥÷µ';
  --±∏∑›
  insert into acc_st.st_sts_sale_hunch_err
    (card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee, system_balance_fee, card_balance_fee,
    old_expire_datetime, new_expire_datetime, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, hdl_time)
  select card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee, system_balance_fee, card_balance_fee,
    old_expire_datetime, new_expire_datetime, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, hdl_time
    from acc_st.t#st_ist_settle_svt_logic
    where card_logical_id in(select card_logical_id from acc_st.t#st_ist_settle_svt_logicno);
  --Ãﬁ≥˝
  delete from acc_st.t#st_ist_settle_svt_logic
    where card_logical_id in(select card_logical_id from acc_st.t#st_ist_settle_svt_logicno);

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,3,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '…∏—°Ωª“◊ ˝æ›';
--…∏—°Ωª“◊ ˝æ›(µÿÃ˙°¢π´Ωª°¢ ÷ª˙÷ß∏∂°¢ª•¡™Õ¯»°∆±)
  --µÿÃ˙
  insert into acc_st.t#st_ist_settle_svt_deal
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no)
  select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no
    from acc_st.st_que_deal
    where balance_water_no=in_balance_water_no
    and card_main_id in (select distinct card_main_id from acc_st.op_prm_svt_type) and card_sub_id !='03';
  --π´Ωª
  insert into acc_st.t#st_ist_settle_svt_deal
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no)
  select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no
    from acc_st.st_ext_mtr_que_deal
    where balance_water_no=in_balance_water_no
    and card_main_id in (select distinct card_main_id from acc_st.op_prm_svt_type) and card_sub_id !='03';
  -- ÷ª˙÷ß∏∂
  insert into acc_st.t#st_ist_settle_svt_deal
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no)
  select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no
    from acc_st.st_mb_que_deal
    where balance_water_no=in_balance_water_no
    and card_main_id in (select distinct card_main_id from acc_st.op_prm_svt_type) and card_sub_id !='03';
  --ª•¡™Õ¯»°∆±
  insert into acc_st.t#st_ist_settle_svt_deal
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no)
  select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id,
    deal_fee, deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no
    from acc_st.st_np_que_deal
    where balance_water_no=in_balance_water_no
    and card_main_id in (select distinct card_main_id from acc_st.op_prm_svt_type) and card_sub_id !='03';

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,4,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := 'Ãﬁ≥˝±∏∑›÷ÿ∏¥¬ﬂº≠ø®∫≈Ωª“◊';
--Ãﬁ≥˝±∏∑›÷ÿ∏¥¬ﬂº≠ø®∫≈œ‡πÿΩª“◊º«¬º
  --±∏∑›
  insert into acc_st.st_sts_svt_deal_err
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, deal_fee,
    deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no)
  select water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, deal_fee,
    deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no
    from acc_st.t#st_ist_settle_svt_deal
    where card_logical_id in(select card_logical_id from acc_st.t#st_ist_settle_svt_logicno);
  --Ãﬁ≥˝
  delete from acc_st.t#st_ist_settle_svt_deal
    where card_logical_id in(select card_logical_id from acc_st.t#st_ist_settle_svt_logicno);

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,5,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '¥¢÷µ∆±÷ÿ”√÷ÿ±‡¬Î';
--÷ÿ±‡¬Î ±º‰≤Â»Î’˝ Ω±Ì ver1.42
  insert into acc_st.t#st_act_svt_again (card_logical_id,card_physical_id,again_time)
  select logical_id,rpad(trim(phy_id),14,'0') phy_id,max(hdl_time) hdl_time from acc_tk.IC_ES_AGAIN_INFO_SVT where to_char(insert_time,'yyyyMMdd')||'01'=in_balance_water_no
  group by logical_id,rpad(trim(phy_id),14,'0');
  merge into acc_st.st_act_svt_again a
  using acc_st.t#st_act_svt_again b
  on (a.card_logical_id=b.card_logical_id and trim(a.card_physical_id)=trim(b.card_physical_id))
  when matched then
    update set a.again_time  = b.again_time
  when not matched then
    insert (card_logical_id,card_physical_id,again_time)
    values (b.card_logical_id,b.card_physical_id,b.again_time);

  --Ãﬁ≥˝±∏∑›¬ﬂº≠ø®∫≈÷ÿ◊˜æ…ø®œ‡πÿΩª“◊º«¬º ver1.42
  --±∏∑›
  insert into acc_st.st_sts_svt_deal_old
    (water_no, line_id, station_id, dev_type_id, device_id, sam_logical_id, sam_trade_seq, deal_datetime, card_main_id, card_sub_id, card_logical_id, card_physical_id, deal_fee,
    deal_balance_fee, card_charge_seq, card_consume_seq, pay_mode_id, entry_line_id, entry_station_id, entry_sam_logical_id, entry_datetime, deal_no_discount_fee, balance_water_no)
  select a.water_no, a.line_id, a.station_id, a.dev_type_id, a.device_id, a.sam_logical_id, a.sam_trade_seq, a.deal_datetime, a.card_main_id, a.card_sub_id, a.card_logical_id,
         a.card_physical_id, a.deal_fee, a.deal_balance_fee, a.card_charge_seq, a.card_consume_seq, a.pay_mode_id, a.entry_line_id, a.entry_station_id,
         a.entry_sam_logical_id, a.entry_datetime, a.deal_no_discount_fee, a.balance_water_no
    from acc_st.t#st_ist_settle_svt_deal a
    where exists (select 1 from acc_st.st_act_svt_again b where b.card_logical_id=a.card_logical_id and b.again_time>a.deal_datetime);--–°”⁄÷ÿ±‡¬Î ±º‰∂®“ÂŒ™æ… ˝æ›
  --Ãﬁ≥˝
  delete from acc_st.t#st_ist_settle_svt_deal a
    where exists (select 1 from acc_st.st_act_svt_again b where b.card_logical_id=a.card_logical_id and b.again_time>a.deal_datetime);

--Ãﬁ≥˝±∏∑›’Àªß±Ìæ…ø®’Àªß–≈œ¢ ver1.42
  --±∏∑›
  insert into acc_st.st_act_svt_old
    (card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee, system_balance_fee, card_balance_fee,
    old_expire_datetime, new_expire_datetime, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, max_deal_time)
  select card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee, total_consume_fee, system_balance_fee, card_balance_fee,
    old_expire_datetime, new_expire_datetime, card_charge_seq, card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, max_deal_time
    from acc_st.st_act_svt
    where card_logical_id in(select card_logical_id from acc_st.t#st_act_svt_again);
  --…æ≥˝
  delete acc_st.st_act_svt
    where card_logical_id in(select card_logical_id from acc_st.t#st_act_svt_again);

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,6,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '∞¥¬ﬂº≠ø®∫≈Õ≥º∆Ωª“◊ ˝æ›';
--∞¥¬ﬂº≠ø®∫≈Õ≥º∆Ωª“◊ ˝æ›£¨≥‰÷µ£®≥‰÷µº∆ ˝£©°¢œ˚∑—£®œ˚∑—º∆ ˝£©°¢≥Â’˝£®≥Â’˝º∆ ˝£©£ª÷Õ¡Ù ˝æ›≤Â»Î(when not matched then)
  --≥‰÷µ
  merge into acc_st.t#st_ist_settle_svt_logic a
  using (select card_logical_id,count(1) deal_num,sum(deal_fee) deal_fee from acc_st.t#st_ist_settle_svt_deal
        where pay_mode_id='14' group by card_logical_id) b
  on (a.card_logical_id=b.card_logical_id)
  when matched then
    update set a.total_charge_num  = b.deal_num,
               a.total_charge_fee  = b.deal_fee
  when not matched then
    insert (card_logical_id, total_charge_num, total_charge_fee, balance_water_no)
    values (b.card_logical_id, b.deal_num, b.deal_fee, in_balance_water_no);
  --œ˚∑—
  merge into acc_st.t#st_ist_settle_svt_logic a
  using (select card_logical_id,count(1) deal_num,sum(deal_fee) deal_fee from acc_st.t#st_ist_settle_svt_deal
        where pay_mode_id in('11','12','1C','1A') group by card_logical_id) b
  on (a.card_logical_id=b.card_logical_id)
  when matched then
    update set a.total_consume_num  = b.deal_num,
               a.total_consume_fee  = b.deal_fee
  when not matched then
    insert (card_logical_id, total_consume_num, total_consume_fee, balance_water_no)
    values (b.card_logical_id, b.deal_num, b.deal_fee, in_balance_water_no);
  --≥Â’˝
  merge into acc_st.t#st_ist_settle_svt_logic a
  using (select card_logical_id,count(1) deal_num,sum(deal_fee) deal_fee from acc_st.t#st_ist_settle_svt_deal
        where pay_mode_id in('18') group by card_logical_id) b
  on (a.card_logical_id=b.card_logical_id)
  when matched then
    update set a.total_consume_num  = a.total_consume_num+b.deal_num,
               a.total_charge_fee  = a.total_charge_fee-b.deal_fee
  when not matched then
    insert (card_logical_id, total_consume_num, total_charge_fee, balance_water_no)
    values (b.card_logical_id, b.deal_num, -1*b.deal_fee, in_balance_water_no);

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,7,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '∆±ø®”‡∂Ó°¢◊Ó¥ÛΩª“◊ ±º‰';
--∆±ø®”‡∂Ó°¢◊Ó¥ÛΩª“◊ ±º‰
  merge into acc_st.t#st_ist_settle_svt_logic a
  using (
          select * from(
                 select row_number() over(partition by t.card_logical_id order by t.deal_datetime desc) rn, t.* from acc_st.t#st_ist_settle_svt_deal t
          ) where rn=1
        ) b
  on (a.card_logical_id=b.card_logical_id)
  when matched then
    update set a.card_charge_seq = b.card_charge_seq,
               a.card_consume_seq = b.card_consume_seq,
               a.card_balance_fee = b.deal_balance_fee,
               a.hdl_time = b.deal_datetime;
  --ø…∏¸–¬∆±ø®”‡∂Ó°¢◊Ó¥ÛΩª“◊ ±º‰º«¬º
  insert into acc_st.t#st_ist_settle_svt_result
    (balance_water_no, card_main_id, card_sub_id, card_logical_id, card_physical_id, card_balance_fee, card_charge_seq, card_consume_seq, max_deal_time)
  select a.balance_water_no, a.card_main_id, a.card_sub_id, a.card_logical_id, a.card_physical_id, a.card_balance_fee, a.card_charge_seq, a.card_consume_seq, a.hdl_time
  from acc_st.t#st_ist_settle_svt_logic a, acc_st.st_act_svt b
  where a.card_logical_id=b.card_logical_id and (a.hdl_time>b.max_deal_time or b.max_deal_time is null);
  --»’÷æ
  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,8,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '∏¸–¬’Àªß±Ì';
--∏¸–¬’Àªß±Ì
  --∏¸–¬’Àªßª˘±æ–≈œ¢£®∆±ø®¿‡–Õ°¢◊¥Ã¨°¢—∫Ω°¢∑¢ø®Ω∂Ó°¢ŒÔ¿Ìø®∫≈£©
  update acc_st.st_act_svt a
    set (a.card_main_id,
        a.card_sub_id,
        a.card_status_id,
        a.deposit_fee,
        a.card_money£¨a.card_physical_id) =
       (select b.card_main_id,
               b.card_sub_id,
               b.card_status_id,
               b.deposit_fee,
               b.card_money£¨b.card_physical_id
          from acc_st.t#st_ist_settle_svt_logic b
         where b.card_logical_id = a.card_logical_id
           and a.card_main_id is null)
  where exists (select 1
          from acc_st.t#st_ist_settle_svt_logic b
         where a.card_logical_id = b.card_logical_id
           and a.card_main_id is null);
  --∏¸–¬≥‰÷µ°¢œ˚∑—Õ≥º∆£¨’Àªß”‡∂Ó°¢«ÂÀ„¡˜ÀÆ∫≈
  merge into acc_st.st_act_svt a
  using (select * from(
                 select row_number() over(partition by t.card_logical_id,t.card_physical_id order by t.hdl_time desc) rn, t.* from acc_st.t#st_ist_settle_svt_logic t
          ) where rn=1)b
  on (a.card_logical_id=b.card_logical_id)
  when matched then
     update
        set a.total_consume_num  = a.total_consume_num + nvl(b.total_consume_num,0),
            a.total_consume_fee  = a.total_consume_fee + nvl(b.total_consume_fee,0),
            a.total_charge_num   = a.total_charge_num + nvl(b.total_charge_num,0),
            a.total_charge_fee   = a.total_charge_fee + nvl(b.total_charge_fee,0),
            a.balance_water_no   = in_balance_water_no,
            a.system_balance_fee = a.total_charge_fee + nvl(b.total_charge_fee,0) + a.card_money -
                                   a.total_consume_fee - nvl(b.total_consume_fee,0)
  when not matched then
    insert
      (card_main_id, card_sub_id, card_logical_id, card_physical_id, total_charge_num, total_consume_num, total_charge_fee,
      total_consume_fee, system_balance_fee, card_balance_fee, card_charge_seq,
      card_consume_seq, balance_water_no, card_status_id, deposit_fee, card_money, max_deal_time)
    values
      (b.card_main_id, b.card_sub_id, b.card_logical_id, nvl(b.card_physical_id,'0'), nvl(b.total_charge_num,0), nvl(b.total_consume_num,0), nvl(b.total_charge_fee,0),
      nvl(b.total_consume_fee,0), nvl(b.total_charge_fee,0)-nvl(b.total_consume_fee,0), b.card_balance_fee, b.card_charge_seq,
      b.card_consume_seq, b.balance_water_no, b.card_status_id, b.deposit_fee, b.card_money, b.hdl_time);
  --∏¸–¬◊Ó∫ÛΩª“◊–≈œ¢£®≥‰÷µ°¢œ˚∑—º∆ ˝°¢∆±ø®”‡∂Ó°¢Ωª“◊ ±º‰£©
  merge into acc_st.st_act_svt a
  using acc_st.t#st_ist_settle_svt_result b
  on (a.card_logical_id=b.card_logical_id)
  when matched then
   update
      set a.card_balance_fee  = b.card_balance_fee,
          a.card_charge_seq  = b.card_charge_seq,
          a.card_consume_seq = b.card_consume_seq£¨
          a.max_deal_time = b.max_deal_time;

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,9,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '¥¢÷µø®Ωª“◊º«¬º±∏∑›';
--¥¢÷µø®Ωª“◊º«¬º±£¥ÊµΩst_sts_deal_svt
  delete acc_st.st_sts_settle_svt_deal where balance_water_no=in_balance_water_no;
  insert into acc_st.st_sts_settle_svt_deal select * from acc_st.t#st_ist_settle_svt_logic;

  insert into acc_st.st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,10,v_msg);
  select sysdate into v_begin_time from dual;
  v_msg := '…˙≥…¥¢÷µø®–£—È“Ï≥£Õ≥º∆±Ì';
--…˙≥…¥¢÷µø®–£—È“Ï≥£Õ≥º∆±Ìst_card_check_result
  delete acc_st.st_card_check_result;
  insert into acc_st.st_card_check_result (card_main_id ,card_sub_id,card_logical_id ,card_physical_id,total_charge_num ,
     total_consume_num ,total_charge_fee,total_consume_fee,card_charge_seq ,card_consume_seq ,
     system_balance_fee ,card_balance_fee,diff_card_sys_fee ,diff_card_sys_num,balance_water_no,card_money)
  select card_main_id ,card_sub_id,card_logical_id ,card_physical_id,total_charge_num ,total_consume_num,
      total_charge_fee,total_consume_fee,card_charge_seq ,card_consume_seq ,system_balance_fee ,
      card_balance_fee,card_balance_fee-system_balance_fee,
      (card_charge_seq+card_consume_seq-total_charge_num-total_consume_num),in_balance_water_no,card_money
  from st_act_svt  where total_consume_num!=0 and card_balance_fee-system_balance_fee>0;
  insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,11,v_msg);

--  ÷ª˙÷ß∏∂Ωª“◊∏¸–¬ modify by lindauqan 20160113 ver1.30
  v_msg := ' ÷ª˙÷ß∏∂Ωª“◊∏¸–¬';
  select sysdate into v_begin_time from dual;
  select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.mobile.control' and cfg_value='1';
  if v_count>0 then
      acc_st.up_st_ist_settle_svt_mb(out_retresult,out_msg,in_balance_water_no);
      insert into st_log_balnce_detail values(in_balance_water_no,v_mod_name,v_begin_time,sysdate,12,v_msg);
  end if;

  commit;
  out_msg :='success';
  out_retresult:=0;
  exception
  when others then
   begin
     rollback;
     out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
     out_retresult := sqlcode;
     return;
   end;

end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_SVT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_IST_SETTLE_TOTAL
prompt =========================================
prompt
create or replace procedure acc_st.up_st_ist_settle_total(
   out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
   in_balance_water_no in varchar2
)
 as
---------------------------------------------------------------------------
   --π˝≥Ã√˚£∫  up_st_ist_settle_total
   --π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„±®±Ì-µº»Î«ÂÀ„÷–º‰±Ì
   -- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no «ÂÀ„¿¥¡˜ÀÆ∫≈
   --∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
   --¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
   --–ﬁ∏ƒ£∫  --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
             --ver1.02 ø™ º«ÂÀ„≤Ω÷Ë ±œﬁ∂®«ÂÀ„¡˜ÀÆ∫≈ 2014-7-25
             --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
             --ver1.23 ∆¡±Œ«ÂÀ„»Îø⁄ºÏ≤È«Æ∞¸Ωª“◊ ˝æ›2015-10-20
             --ver1.25 ∑«º¥ ±ÕÀøÓ∆±ø®¿‡–Õ–≈œ¢–ﬁ’˝ 20151224 by lindaquan
             --ver1.30 ‘ˆº” ÷ª˙÷ß∏∂œ‡πÿΩ·À„ 52(up_st_ist_settle_mobile) 20160111 by lindaquan
             --ver1.38 ‘ˆº”ª•¡™Õ¯÷ß∏∂œ‡πÿΩ·À„ 53(up_st_ist_settle_np) 20161129 by lindaquan
   -------------------------------------------------------------------------------
   v_msg varchar(200);
   v_begin_step char(2);
   v_current_step char(2);
   v_count int;
   v_begin_time date;
   v_operator_id varchar2(20);--modify by hejj 20140416
   v_remark varchar(50);
begin
---»°µ±«∞”√ªß
 select user into v_operator_id from dual;
 --«ÂÀ„¡˜ÀÆ∫≈ºÏ≤È
  select count(*) into v_count from st_sys_flow_current;
  if v_count <= 0 then
      out_msg := '«ÂÀ„±Ì÷–√ª”–ø…«ÂÀ„µƒ ˝æ›£¨≤ªƒ‹«ÂÀ„';
      out_retresult := - 1;
      return;
  end if;
----------------∂”¡–±Ì¡˜ÀÆ∫≈ºÏ≤È
--Ωª“◊
/*
--modify by lindaquan 20151020 ver1.23 ∆¡±Œ«ÂÀ„»Îø⁄ºÏ≤È«Æ∞¸Ωª“◊ ˝æ›
select count(*) into v_count from st_que_deal where balance_water_no=in_balance_water_no;
  if v_count = 0   then
      out_msg := 'st_que_deal±Ì÷–Œﬁ±æ¥Œ«ÂÀ„£¨«ÎºÏ≤È';
      out_retresult := - 1;
      return;
   end if;
   */
----------------------------------------------------------«ÂÀ„≤Œ ˝…Ë÷√-------------------------------------------
    ----------------ø™ º«ÂÀ„ ±º‰
    select  sysdate into v_begin_time from dual;
      --≤È—Øœ÷‘⁄÷¥––µΩµƒ≤Ω÷Ë
      --»Á«ÂÀ„µ⁄“ª¥Œ÷¥–– v_begin_step = 30 ,»Á”–¥ÌŒÛÕÀ≥ˆ ±’“◊Ó¥Ûµƒstep
      select min(step) into v_begin_step  from st_sys_flow_current where finish_flag='0' and step>='30'
             and balance_water_no=in_balance_water_no; --ver1.03 ø™ º«ÂÀ„≤Ω÷Ë ±œﬁ∂®«ÂÀ„¡˜ÀÆ∫≈
      select remark into v_remark  from st_sys_flow_current where step=v_begin_step;
    ------------------------------------------------------ ÷¥––«ÂÀ„ƒ£øÈ£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠£≠
       v_msg :='ø™ º÷–—Î«ÂÀ„:'||v_begin_step||v_remark||'£¨¡˜ÀÆ∫≈: ' ||in_balance_water_no;
       insert into st_log_balance values(seq_st_log_balance.nextval,in_balance_water_no,'up_st_ist_settle_total','0',
                  v_msg,v_operator_id,sysdate+numtodsinterval(-1,'second')) ; --º«¬ºÃ·«∞“ª√Î£¨”Î∆‰À˚–≈œ¢ ±º‰«¯∑÷
        commit;
        out_retresult := -99 ;

----------------------------- «ÂÀ„«∞ ˝æ›–ﬁ’˝ ------------------------------
     --∑«º¥ ±ÕÀøÓ∆±ø®¿‡–Õ–≈œ¢–ﬁ’˝20151224 by lindaquan version v1.25
     update st_que_return a set (a.card_main_id,a.card_sub_id)= (
            select distinct b.card_main_id,b.card_sub_id from st_list_non_rtn b
            where b.hdl_flag='2' and b.card_logical_id=a.card_logical_id --and b.receipt_id=a.receipt_id
     ) where a.return_type='1' and
     exists (
            select 1 from st_list_non_rtn b
            where b.hdl_flag='2' and b.card_logical_id=a.card_logical_id --and b.receipt_id=a.receipt_id
     );


----------------------------------Ω·À„ƒ£øÈ 30,33,36,39(up_st_ist_settle_data...)
     if v_begin_step<='30' then
            v_begin_time:=sysdate;
            v_msg :='Ω·À„ƒ£øÈ-∫œ≤¢∂”¡–±Ì';
            v_current_step:='30';
            up_st_ist_settle_data_queue(out_retresult,out_msg,in_balance_water_no)  ;
             if out_retresult=0 then
                update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
                where step=v_current_step;
                commit;
             else
                 out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
                 update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
                 insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
                 commit;
                 return;
             end if;
      end if;
      if v_begin_step<='33'  then
           v_current_step:='33';
           v_begin_time:=sysdate;
           v_msg :='Ω·À„ƒ£øÈ-∑÷’À‘À”™…Ã';
           up_st_ist_settle_data_mid(out_retresult,out_msg);
           if out_retresult=0 then
              update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
              where step=v_current_step;
              commit;
           else
               out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
               update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
               insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
               commit;
               return;
           end if;
       end if;
      if v_begin_step<='36'  then
          v_current_step:='36';
          v_begin_time:=sysdate;
          v_msg :='Ω·À„ƒ£øÈ-∑÷’À◊Ó¥Û‘À”™…Ã';
          up_st_ist_settle_data_max(out_retresult,out_msg);
           if out_retresult=0 then
              update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
              where step=v_current_step;
              commit;
           else
               out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
               update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
               insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
               commit;
               return;
           end if ;
       end if;
      if v_begin_step<='39'  then
            v_current_step:='39';
            v_begin_time:=sysdate;
            v_msg:='Ω·À„ƒ£øÈ-µº»Î÷–º‰±Ì';
            up_st_ist_settle_data(out_retresult,out_msg,in_balance_water_no);
             if out_retresult=0 then
                update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
                where step=v_current_step;
                commit;
             else
                 out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
                 update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
                 insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
                 commit;
                return;
             end if;
     end if;
   ----------------------------------∂‘’  42(up_st_ist_settle_out_diff)
    if v_begin_step<='42'  then
     v_current_step:='42';
     v_begin_time:=sysdate;
     v_msg:='∂‘’ ƒ£øÈ' ;
     up_st_ist_settle_out(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
   end if;
  ----------------------------------øÕ¡˜°¢≥Àæ‡∑÷Œˆ 45(up_st_ist_settle_flux)
  if v_begin_step<='45'  then
    v_current_step:='45';
    v_begin_time:=sysdate;
    v_msg :='≥Àæ‡∑÷Œˆƒ£øÈ' ;
    up_st_ist_settle_flux(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if ;
 end if;
 ---------------------------------- ’“ÊÕ≥º∆ 48(up_st_ist_settle_income)
  if v_begin_step<='48'  then
     v_current_step:='48';
     v_begin_time:=sysdate;
     v_msg :=' ’“ÊÕ≥º∆ƒ£øÈ' ;
     up_st_ist_settle_income(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
  end if;
---------------------------------lcc∂‘’À 51(up_st_ist_settle_lcc)
  if v_begin_step<='51'  then
     v_current_step:='51';
     v_begin_time:=sysdate;
     v_msg :='lcc∂‘’Àƒ£øÈ' ;
     up_st_ist_settle_lcc(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
  end if;
--------------------------------- ÷ª˙÷ß∏∂œ‡πÿΩ·À„ 52(up_st_ist_settle_mobile) ver1.30 in 20160111 by lindaquan
  select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.mobile.control' and cfg_value='1';
  if v_begin_step<='52' and v_count>0 then
     v_current_step:='52';
     v_begin_time:=sysdate;
     v_msg :=' ÷ª˙÷ß∏∂œ‡πÿΩ·À„' ;
     acc_st.up_st_ist_settle_mobile(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
  end if;
---------------------------------ª•¡™Õ¯÷ß∏∂œ‡πÿΩ·À„ 53(up_st_ist_settle_np) ver1.38 in 20161129 by lindaquan
  select count(1) into v_count from acc_st.st_cfg_sys_base where cfg_key='business.np.control' and cfg_value='1';
  if v_begin_step<='53' and v_count>0 then
     v_current_step:='53';
     v_begin_time:=sysdate;
     v_msg :='ª•¡™Õ¯÷ß∏∂œ‡πÿΩ·À„' ;
     acc_st.up_st_ist_settle_np(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
  end if;
---------------------------------…Ûº∆°¢“Ï≥£Õ≥º∆ 54(up_st_ist_settle_audit)
 if v_begin_step<='54'  then
    v_current_step:='54';
    v_begin_time:=sysdate;
    v_msg :='…Ûº∆°¢“Ï≥£Õ≥º∆ƒ£øÈ' ;
    up_st_ist_settle_audit(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
end if;
----------------------------------”‡∂Ó∆Ω∫‚57 (up_st_ist_settle_svt)
  if v_begin_step<='57'  then
     v_current_step:='57';
     v_begin_time:=sysdate;
     v_msg :='”‡∂Ó∆Ω∫‚ƒ£øÈ' ;
     up_st_ist_settle_svt(out_retresult,out_msg,in_balance_water_no);
   if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
  end if;
  ----------------------------------sam∂œ∫≈÷ÿ∫≈∑÷Œˆ60 (up_st_ist_settle_sam)
 if v_begin_step<='60'  then
     v_current_step:='60';
     v_begin_time:=sysdate;
     v_msg :='samø®–£—Èƒ£øÈ' ;
     up_st_ist_settle_sam(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
end if;
-----------------------------------…˙≥…ºƒ¥Ê∆˜ ˝æ›Õ≥º∆±®±Ì 63
 if v_begin_step<='63'  then
     v_current_step:='63';
     v_begin_time:=sysdate;
     v_msg :='ºƒ¥Ê∆˜ ˝æ›Õ≥º∆' ;
     up_st_ist_settle_reg(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
 end if;
 -----------------------------------√˚µ•π‹¿Ì”Î«ÂÀ„∫Û–¯¥¶¿Ì 66
 if v_begin_step<='66'  then
     v_current_step:='66';
     v_begin_time:=sysdate;
     v_msg :='√˚µ•π‹¿Ì”Î∆‰À˚' ;
     up_st_ist_settle_other(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
 end if;
 -----------------------------------∂”¡–±Ìµº¿˙ ∑±Ì 69
 if v_begin_step<='69'  then
     v_current_step:='69';
     v_begin_time:=sysdate;
     v_msg :='∂”¡–±Ìµº¿˙ ∑±Ì ' ;
     up_st_ist_settle_his(out_retresult,out_msg,in_balance_water_no);
     if out_retresult=0 then
        update st_sys_flow_current set finish_flag='1',error_code='00', begin_time=v_begin_time,end_time=sysdate
        where step=v_current_step;
        commit;
     else
         out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
         update st_sys_flow_current set  begin_time=v_begin_time,end_time=sysdate,error_code='-1' where step=v_current_step;
         insert into st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'','1',out_msg,v_operator_id,sysdate);
         commit;
        return;
     end if;
 end if;
--------------------------------------------------
v_msg :='÷–—Î«ÂÀ„ÕÍ≥…,¡˜ÀÆ∫≈: '||in_balance_water_no;
insert into  st_log_balance  values(seq_st_log_balance.nextval,in_balance_water_no,'up_st_ist_settle_total','0',v_msg,v_operator_id, sysdate);
commit;
end;
/
grant execute on ACC_ST.UP_ST_IST_SETTLE_TOTAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_MANU_HLD_ERR_EXP_TRX_AFT
prompt =================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_err_exp_trx_aft
(
piBalanceWaterNo varchar2,
piBalanceWaterNoAuto varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_exp_trx_aft
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      piBalanceWaterNoAuto:ª÷∏¥◊‘∂Ø¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫¥¶¿Ìµº≥ˆπ´Ωª ˝æ›≤ª’˝»∑
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20140820
--∞Ê±æ£∫v1.0
is

begin



  --1°¢…æ≥˝¡Ÿ ±µº»Î∂”¡–±Ìµƒ ˝æ›
  delete from acc_st.st_que_deal_oct where balance_water_no=piBalanceWaterNo;

  --2°¢«–ªª»Àπ§Œ™◊‘∂Ø
   update st_cfg_sys_base set cfg_value='0' where cfg_key='sys.flow.control.manu';
   update st_cfg_sys_base set cfg_value='/opt/communfs/ftp/receive' where cfg_key='path.trx';

  --3°¢◊‘∂Øª÷∏¥¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
   update st_sys_flow_current set finish_flag='0' , balance_water_no=piBalanceWaterNoAuto;

   commit;


  exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_ERR_EXP_TRX_PRE
prompt =================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_err_exp_trx_pre
(
piBalanceWaterNo varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_exp_trx_pre
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈  poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫¥¶¿Ìµº≥ˆπ´Ωª ˝æ›≤ª’˝»∑
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20170927
--∞Ê±æ£∫v1.0
is
recordNum int;

begin
   --1°¢ª∑æ≥◊º±∏
   --«–ªª◊‘∂ØŒ™»Àπ§
   update st_cfg_sys_base set cfg_value='1' where cfg_key='sys.flow.control.manu';
   update st_cfg_sys_base set cfg_value='/opt/communfs/ftp/receive_test' where cfg_key='path.trx';
   --÷ÿ◊ˆÕ‚≤ø ˝æ›µº≥ˆ£®20£©≤Ω÷Ë
   update st_sys_flow_current set balance_water_no=piBalanceWaterNo ,finish_flag='1';
   update st_sys_flow_current set finish_flag='0' where step='20' and balance_water_no=piBalanceWaterNo;

   --‘ˆº”ªÚ∏¸–¬»Àπ§¥˝¥¶¿Ì«ÂÀ„¡˜ÀÆ
   select count(*) into recordNum from st_sys_flow_manu where balance_water_no=piBalanceWaterNo;
   if( recordNum = 0 ) then
      insert into st_sys_flow_manu(balance_water_no,finish_flag) values(piBalanceWaterNo,'0');
   else
      update st_sys_flow_manu set finish_flag='0' where  balance_water_no=piBalanceWaterNo;

   end if;


   ---2°¢ªÿπˆ—πÀı∞¸∂‘”¶µº≥ˆµƒ ˝æ›
   --Œƒº˛…Ûº∆
   delete from ST_EXT_OCT_AUDIT_FILE_TRX where balance_water_no=piBalanceWaterNo;
   
   --3¥”¿˙ ∑±Ì÷ÿ–¬ªÒ»°π´Ωªœ˚∑— ˝æ›
   insert into acc_st.st_que_deal_oct (WATER_NO, LINE_ID, STATION_ID, DEV_TYPE_ID, DEVICE_ID, SAM_LOGICAL_ID, 
                                        SAM_TRADE_SEQ, DEAL_DATETIME, CARD_MAIN_ID, CARD_SUB_ID, CARD_LOGICAL_ID, 
                                        CARD_PHYSICAL_ID, CARD_STATUS_ID, DEAL_FEE, DEAL_BALANCE_FEE, 
                                        CARD_CHARGE_SEQ, CARD_CONSUME_SEQ, PAY_MODE_ID, RECEIPT_ID, 
                                        TAC, ENTRY_LINE_ID, ENTRY_STATION_ID, ENTRY_SAM_LOGICAL_ID, 
                                        ENTRY_DATETIME, OPERATOR_ID, SHIFT_ID, LAST_SAM_LOGICAL_ID,
                                         LAST_DEAL_DATETIME, DEAL_NO_DISCOUNT_FEE, UNION_YEAR_MONTH, 
                                         UNION_BUS_NUM, UNION_METRO_NUM, UNION_TOTAL_NUM, TRADE_SORT,
                                          CARD_AREA_CODE, CARD_AREA_TYPE, OVERDRAFT_FEE, CARD_CPU_FLAG,
                                           CARD_EXPIRED_FLAG, TCT_VALID_DAYS, TCT_ACTIVATE_DATETIME, 
                                           LIMIT_MODE, LIMIT_ENTRY_STATION, LIMIT_EXIT_STATION, CARD_APP_FLAG, 
                                           BALANCE_WATER_NO, FILE_NAME, CHECK_FLAG, CITY_CODE, BUSINESS_CODE,
                                            TAC_DEAL_TYPE, TAC_DEV_ID, WORK_MODE, CARD_APP_MODE)
                              select WATER_NO, LINE_ID, STATION_ID, DEV_TYPE_ID, DEVICE_ID, SAM_LOGICAL_ID, 
                                        SAM_TRADE_SEQ, DEAL_DATETIME, CARD_MAIN_ID, CARD_SUB_ID, CARD_LOGICAL_ID, 
                                        CARD_PHYSICAL_ID, CARD_STATUS_ID, DEAL_FEE, DEAL_BALANCE_FEE, 
                                        CARD_CHARGE_SEQ, CARD_CONSUME_SEQ, PAY_MODE_ID, RECEIPT_ID, 
                                        TAC, ENTRY_LINE_ID, ENTRY_STATION_ID, ENTRY_SAM_LOGICAL_ID, 
                                        ENTRY_DATETIME, OPERATOR_ID, SHIFT_ID, LAST_SAM_LOGICAL_ID,
                                         LAST_DEAL_DATETIME, DEAL_NO_DISCOUNT_FEE, UNION_YEAR_MONTH, 
                                         UNION_BUS_NUM, UNION_METRO_NUM, UNION_TOTAL_NUM, TRADE_SORT,
                                          CARD_AREA_CODE, CARD_AREA_TYPE, OVERDRAFT_FEE, CARD_CPU_FLAG,
                                           CARD_EXPIRED_FLAG, TCT_VALID_DAYS, TCT_ACTIVATE_DATETIME, 
                                           LIMIT_MODE, LIMIT_ENTRY_STATION, LIMIT_EXIT_STATION, CARD_APP_FLAG, 
                                           BALANCE_WATER_NO, FILE_NAME, CHECK_FLAG, CITY_CODE, BUSINESS_CODE,
                                            TAC_DEAL_TYPE, TAC_DEV_ID, WORK_MODE, CARD_APP_MODE
                              from acc_st_his.st_his_deal_oct
                              where balance_water_no=piBalanceWaterNo;


  --4°¢÷ÿ–¬∆Ù∂Ø«ÂÀ„‘§¥¶¿Ì
  --µº»Îπ´ΩªµƒΩ·À„Ω·π˚

   commit;


  exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_ERR_RTN_STL_1
prompt ===============================================
prompt
create or replace procedure acc_st.up_st_manu_hld_err_rtn_stl_1
(
piBalanceWaterNo varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_rtn_stl_aft
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      piBalanceWaterNoAuto:ª÷∏¥◊‘∂Ø¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫¥¶¿Ìπ´Ωª∑µªÿµƒΩ·À„Ω·π˚≤ª’˝»∑£¨÷ÿ–¬Ω·À„…˙≥…≤Ó“Ï÷–º‰±Ì/±®±Ì
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20150401
--∞Ê±æ£∫v1.0
is
begin
  --1°¢÷ÿ–¬…˙≥…≤Ó“Ï÷–º‰±Ì ˝æ›
   up_st_ist_settle_out_tmp_4(poRetCode,poRetMsg,piBalanceWaterNo);
  --2°¢…˙≥…±®±Ì
  update st_sys_flow_report set finish_flag='0' where balance_water_no=piBalanceWaterNo;
  
   commit;
  exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;
end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_ERR_RTN_STL_AFT
prompt =================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_err_rtn_stl_aft
(
piBalanceWaterNo varchar2,
piBalanceWaterNoAuto varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_rtn_stl_aft
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      piBalanceWaterNoAuto:ª÷∏¥◊‘∂Ø¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫¥¶¿Ìπ´Ωª∑µªÿµƒΩ·À„Ω·π˚≤ª’˝»∑£¨÷ÿ–¬Ω·À„…˙≥…≤Ó“Ï÷–º‰±Ì/±®±Ì
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20140820
--∞Ê±æ£∫v1.0
is

begin


  --1°¢÷ÿ–¬…˙≥…≤Ó“Ï÷–º‰±Ì ˝æ›
   up_st_ist_settle_out_tmp_4(poRetCode,poRetMsg,piBalanceWaterNo);

  --2°¢…˙≥…±®±Ì
  update st_sys_flow_report set finish_flag='0' where balance_water_no=piBalanceWaterNo;

  --3°¢«–ªª»Àπ§Œ™◊‘∂Ø
   update st_cfg_sys_base set cfg_value='0' where cfg_key='sys.flow.control.manu';
   update st_cfg_sys_base set cfg_value='/opt/communfs/ftp/receive' where cfg_key='path.trx';

  --4°¢◊‘∂Øª÷∏¥¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
   update st_sys_flow_current set finish_flag='0' , balance_water_no=piBalanceWaterNoAuto;

   commit;


  exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_ERR_RTN_STL_PRE
prompt =================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_err_rtn_stl_pre
(
piBalanceWaterNo varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_rtn_stl_pre
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈  poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫¥¶¿Ìπ´Ωª∑µªÿµƒΩ·À„Ω·π˚≤ª’˝»∑£¨ªÿπˆ‘§¥¶¿ÌΩ·π˚°¢Ω·À„Ω·π˚
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20140820
--∞Ê±æ£∫v1.0
is
recordNum int;

begin
   --1°¢ª∑æ≥◊º±∏
   --«–ªª◊‘∂ØŒ™»Àπ§
   update st_cfg_sys_base set cfg_value='1' where cfg_key='sys.flow.control.manu';
   update st_cfg_sys_base set cfg_value='/opt/communfs/ftp/receive_test' where cfg_key='path.trx';
   --÷ÿ◊ˆÕ‚≤ø ˝æ›µº»Î£®83£©≤Ω÷Ë
   update st_sys_flow_current set balance_water_no=piBalanceWaterNo ,finish_flag='1';
   update st_sys_flow_current set finish_flag='0' where step='83' and balance_water_no=piBalanceWaterNo;

   --‘ˆº”ªÚ∏¸–¬»Àπ§¥˝¥¶¿Ì«ÂÀ„¡˜ÀÆ
   select count(*) into recordNum from st_sys_flow_manu where balance_water_no=piBalanceWaterNo;
   if( recordNum = 0 ) then
      insert into st_sys_flow_manu(balance_water_no,finish_flag) values(piBalanceWaterNo,'0');
   else
      update st_sys_flow_manu set finish_flag='0' where  balance_water_no=piBalanceWaterNo;

   end if;


   ---2°¢ªÿπˆ—πÀı∞¸∂‘”¶µº»Îµƒ ˝æ›
   --Ω·À„Ω·π˚
   delete from ST_EXT_OCT_AUDIT_BALANCE where balance_water_no=piBalanceWaterNo;
   --¥ÌŒÛº«¬º
   delete from ST_EXT_OCT_ERR_TRADE where balance_water_no=piBalanceWaterNo;
   --√˚µ•
   delete from ST_EXT_OCT_BLACKLIST where balance_water_no=piBalanceWaterNo;

   --Œƒº˛…Ûº∆
   delete from ST_EXT_OCT_AUDIT_FILE_STL where balance_water_no=piBalanceWaterNo;
   --≤…ºØ◊¥Ã¨
   delete from ST_EXT_OCT_AUDIT_STATUS where balance_water_no=piBalanceWaterNo;
   --3°¢ªÿπˆ ˝æ›Ω·À„Ω·π˚
   --≤Ó“Ï÷–º‰±Ì ˝æ›

   delete st_sts_diff_analysis where balance_water_no in (piBalanceWaterNo);
   --∫⁄√˚µ•¿˙ ∑
   delete from op_prm_black_list_oct_his where balance_water_no=piBalanceWaterNo;


  --4°¢÷ÿ–¬∆Ù∂Ø«ÂÀ„‘§¥¶¿Ì
  --µº»Îπ´ΩªµƒΩ·À„Ω·π˚

   commit;


  exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_RTN_TRX_STEP_1
prompt ================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_rtn_trx_step_1
(
piBalanceWaterNo varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_rtn_trx_step_1
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈  poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫¥¶¿Ìπ´Ωª∑µªÿµƒÕ‚≤øµÿÃ˙ø®Ωª“◊ ˝æ›≤ª’˝»∑£¨ªÿπˆ‘§¥¶¿ÌΩ·π˚°¢Ω·À„Ω·π˚
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20150307
--∞Ê±æ£∫v1.0
is
recordNum int;

begin
   --1°¢ª∑æ≥◊º±∏
   --«–ªª◊‘∂ØŒ™»Àπ§
   update st_cfg_sys_base set cfg_value='1' where cfg_key='sys.flow.control.manu';
   update st_cfg_sys_base set cfg_value='/opt/communfs/ftp/receive_test' where cfg_key='path.trx';
   --÷ÿ◊ˆÕ‚≤øµÿÃ˙ø® ˝æ›µº»Î£®21£©≤Ω÷Ë
   update st_sys_flow_current set balance_water_no=piBalanceWaterNo ,finish_flag='1';
   update st_sys_flow_current set finish_flag='0' where step='21' and balance_water_no=piBalanceWaterNo;

   --‘ˆº”ªÚ∏¸–¬»Àπ§¥˝¥¶¿Ì«ÂÀ„¡˜ÀÆ
   select count(*) into recordNum from st_sys_flow_manu where balance_water_no=piBalanceWaterNo;
   if( recordNum = 0 ) then
      insert into st_sys_flow_manu(balance_water_no,finish_flag) values(piBalanceWaterNo,'0');
   else
      update st_sys_flow_manu set finish_flag='0' where  balance_water_no=piBalanceWaterNo;

   end if;

   --2°¢ªÿπˆÕ‚≤øπ´Ωªø®‘§¥¶¿Ì ˝æ›
  --Õ‚≤øµÿÃ˙ø®Ωª“◊
  --ª∫¥Ê±Ì
   delete from st_ext_mtr_buf_deal where balance_water_no=piBalanceWaterNo;
  --∂”¡–±Ì
   delete from st_ext_mtr_que_deal where balance_water_no=piBalanceWaterNo;
  --¥ÌŒÛ±Ì
   delete from st_ext_mtr_err_deal where balance_water_no=piBalanceWaterNo;
   --Õ‚≤øµÿÃ˙ø®…Ûº∆Œƒº˛
   delete from st_ext_mtr_audit_file_trx where balance_water_no=piBalanceWaterNo;

   --3°¢ªÿπˆÕ‚≤øπ´Ωªø®Ω·À„ ˝æ›
   --Õ‚≤øµÿÃ˙ø®Ω·À„Ω·π˚
   delete from st_ext_mtr_audit_balance where balance_water_no=piBalanceWaterNo;

   --Õ‚≤øµÿÃ˙ø®¥ÌŒÛΩª“◊
  delete from st_ext_mtr_err_trade where balance_water_no=piBalanceWaterNo;

   --Õ‚≤øµÿÃ˙ø®…Ûº∆Œƒº˛
   delete from st_ext_mtr_audit_file_stl where balance_water_no=piBalanceWaterNo;
   --Õ‚≤øµÿÃ˙ø®◊¥Ã¨Œƒº˛
   delete from st_ext_mtr_audit_status where balance_water_no=piBalanceWaterNo;

   --Õ‚≤øµÿÃ˙ø®∫⁄√˚µ•
   delete from st_ext_mtr_blacklist where balance_water_no=piBalanceWaterNo;

   --÷–º‰±Ì ˝æ›
   delete from st_sts_mtr_audit_balance where balance_water_no=piBalanceWaterNo;

   --4°¢ªÿπˆÕ‚≤øπ´Ωªø®Ωª“◊¿˙ ∑ ˝æ›
   delete from acc_st_his.st_ext_mtr_his_deal where balance_water_no=piBalanceWaterNo;


   commit;
   exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_RTN_TRX_STEP_2
prompt ================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_rtn_trx_step_2
(
piBalanceWaterNo varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_rtn_trx_step_2
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈  poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫÷ÿ–¬µº≥ˆÕ‚≤øµÿÃ˙ø®µƒΩ·À„Ω·π˚
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20150307
--∞Ê±æ£∫v1.0
is

begin

--÷ÿ◊ˆÕ‚≤øµÿÃ˙ø®Ω·À„Ω·π˚µº≥ˆ≤Ω÷Ë(81)
update st_sys_flow_current set finish_flag='1' ,balance_water_no=piBalanceWaterNo;

update st_sys_flow_current set finish_flag='0'
                           where balance_water_no=piBalanceWaterNo and
                                 step='81';
commit;

exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MANU_HLD_RTN_TRX_STEP_3
prompt ================================================
prompt
create or replace procedure acc_st.up_st_manu_hld_rtn_trx_step_3
(
piBalanceWaterNo varchar2,
piBalanceWaterNoAuto varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
--¥Ê¥¢π˝≥Ã£∫up_st_manu_hld_err_rtn_trx_step_3
--≤Œ ˝£∫piBalanceWaterNo£∫¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      piBalanceWaterNoAuto:ª÷∏¥◊‘∂Ø¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
--      poRetCode£∫¥¶¿Ì∑µªÿ¥˙¬Î 0£∫’˝≥£ -1£∫≤ª’˝≥£
--      poRetMsg :∑µªÿœ˚œ¢
--π¶ƒ‹£∫÷ÿ–¬…˙≥…±®±Ìº∞ª÷∏¥◊‘∂Ø¥¶¿Ì
--¥¥Ω®’ﬂ£∫hejj
--¥¥Ω®»’∆⁄:20150307
--∞Ê±æ£∫v1.0
is

begin



  --2°¢…˙≥…±®±Ì
  update st_sys_flow_report set finish_flag='0' where balance_water_no=piBalanceWaterNo;

  --3°¢«–ªª»Àπ§Œ™◊‘∂Ø
   update st_cfg_sys_base set cfg_value='0' where cfg_key='sys.flow.control.manu';
   update st_cfg_sys_base set cfg_value='/opt/communfs/ftp/receive' where cfg_key='path.trx';

  --4°¢◊‘∂Øª÷∏¥¥¶¿Ìµƒ«ÂÀ„¡˜ÀÆ∫≈
   update st_sys_flow_current set finish_flag='0' , balance_water_no=piBalanceWaterNoAuto;

   commit;


  exception
    when others then
    begin
       poRetCode :=-1;
       poRetMsg :='¥ÌŒÛ¥˙¬Î:' ||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'|| sqlerrm;
       rollback;
    end;


end;
/

prompt
prompt Creating procedure UP_ST_MB_TRF_BUF_QUEUE_DEAL
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_mb_trf_buf_queue_deal
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_mb_trf_buf_queue_deal
--π¶ƒ‹√Ë ˆ£∫–£—È ÷ª˙÷ß∏∂«Æ∞¸Ωª“◊ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160118
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160520
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--–ﬁ∏ƒ»’∆⁄: 20160608
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤È÷ÿ‘ˆº”¬ﬂº≠ø®∫≈
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
---
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from acc_st.st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='74';--Œ¥»∑∂®–¥÷µ
---
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
--ª∫¥ÊTAC–£—È≤ªÕ®π˝º«¬º
INSERT INTO ACC_ST.T#ST_MB_ERR_DEAL(CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,DEAL_DATETIME,FILE_NAME,      BALANCE_WATER_NO,ERR_CODE)
                   SELECT CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,DEAL_DATETIME,FILE_NAME,BALANCE_WATER_NO,ERR_CODE
           FROM ACC_ST.ST_MB_ERR_DEAL WHERE
           FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41';
/*
DELETE FROM ST_MB_BUF_DEAL
                         WHERE
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS') IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
               FROM ST_MB_ERR_DEAL WHERE
                    FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41'
               );
                           */
DELETE FROM ACC_ST.ST_MB_BUF_DEAL
                         WHERE
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS') IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
               FROM ACC_ST.T#ST_MB_ERR_DEAL WHERE
                    FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41'
               );
----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--”ÎŒƒº˛√˚≥∆–°µƒº«¬º±»Ωœ£¨’‚—˘Œƒº˛√˚≥∆–°µƒ÷ÿ∏¥º«¬º±£¡Ù£¨Œƒº˛√˚≥∆¥Ûµƒ÷ÿ∏¥º«¬º…æ≥˝
insert into ACC_ST.T#ST_MB_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
          FROM ACC_ST.ST_MB_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰°¢¬ﬂº≠ø®∫≈
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE )||CARD_LOGICAL_ID IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                                  ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE )||CARD_LOGICAL_ID
               FROM ACC_ST.ST_MB_BUF_DEAL WHERE FILE_NAME < piFileName AND BALANCE_WATER_NO=piBalanceWaterNo
               );
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_MB_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
          FROM ACC_ST.ST_MB_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE ) ||CARD_LOGICAL_ID IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                                  ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE )||CARD_LOGICAL_ID
               FROM ACC_ST.ST_MB_QUE_DEAL
               );
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
  insert into ACC_ST.T#ST_MB_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
          FROM ACC_ST.ST_MB_BUF_DEAL a
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          TO_CHAR(DEAL_DATETIME+7,'YYYYMMDD') < SUBSTR(piBalanceWaterNo,1,8)  AND   --ADD BY HEJJ 20140808
                /* modify by hejj 20150302
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE) IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                                   ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE)
               FROM ACC_ST_HIS.st_mb_his_deal
               )
               */
               exists(
                     select * from acc_st_his.st_mb_his_deal b
                              where a.card_main_id = b.card_main_id and a.card_sub_id = b.card_sub_id and
                                    a.sam_logical_id = b.sam_logical_id and a.sam_trade_seq = b.sam_trade_seq and
                                    a.deal_datetime = b.deal_datetime and a.deal_fee =b.deal_fee and
                                    a.deal_balance_fee = b.deal_balance_fee and a.CARD_LOGICAL_ID=b.CARD_LOGICAL_ID
               )
               ;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from acc_st.st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.ST_MB_BUF_DEAL
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           deal_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
dbms_output.put_line('isNeedCheckHisSub='||isNeedCheckHisSub);
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    insert into ACC_ST.T#ST_MB_BUF_DEAL_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
          FROM ACC_ST.ST_MB_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          deal_datetime <= dateMaxHis;
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_MB_BUF_DEAL_CHK a set a.table_name = (select trim(b.table_name) from acc_st.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date )
                                  where exists(select b.table_name from acc_st.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_MB_BUF_DEAL_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         dbms_output.put_line('tableName='||tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_MB_BUF_DEAL_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_MB_BUF_DEAL
         dbms_output.put_line('execute immediate begin');
         execute immediate
         'insert into ACC_ST.T#ST_MB_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
          FROM ACC_ST.T#ST_MB_BUF_DEAL_CHK
                    WHERE TABLE_NAME= :x AND
                          CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,''YYYYMMDDHH24MISS'')
                          ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE)||CARD_LOGICAL_ID IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,''YYYYMMDDHH24MISS'')
                                  ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE)||CARD_LOGICAL_ID
               FROM ACC_ST_HIS.'||tableName||
               ')'
         using tableName;
         dbms_output.put_line('execute immediate end');
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_MB_BUF_DEAL;
  dbms_output.put_line('T#ST_MB_BUF_DEAL count='||to_char(rowCount));
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_MB_ERR_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
          FROM ACC_ST.T#ST_MB_BUF_DEAL;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_MB_BUF_DEAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS') IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
               FROM ACC_ST.T#ST_MB_BUF_DEAL
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ìº∞Œƒº˛ƒ⁄≤È÷ÿ
        insert into ACC_ST.ST_MB_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                from ACC_ST.ST_MB_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_MB_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE)
    select    DISTINCT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                from ACC_ST.ST_MB_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into ACC_ST.ST_MB_TST_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE)
    select     DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                from ACC_ST.ST_MB_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------

 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_MB_BUF_DEAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_MB_TRF_BUF_QUEUE_DEAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_MB_TRF_BUF_QUEUE_LOCK
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_mb_trf_buf_queue_lock
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_mb_trf_buf_queue_lock
--π¶ƒ‹√Ë ˆ£∫–£—È ÷ª˙÷ß∏∂À¯ø®ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160119
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
--–ﬁ∏ƒ√Ë ˆ£∫
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from ACC_ST.st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='59';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_MB_BUF_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
					FROM ACC_ST.ST_MB_BUF_LOCK
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_MB_QUE_LOCK
						   );
  
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
--ACC_ST_HIS.
insert into ACC_ST.T#ST_MB_BUF_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
					FROM ACC_ST.ST_MB_BUF_LOCK
					WHERE ---FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_MB_HIS_LOCK
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.ST_MB_BUF_LOCK
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           lock_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£© 
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into ACC_ST.T#ST_MB_BUF_LOCK_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
					FROM ACC_ST.ST_MB_BUF_LOCK 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          lock_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_MB_BUF_LOCK_CHK a set a.table_name = (select trim(b.table_name) from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.lock_datetime >= b.begin_date and 
                                                                   a.lock_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.lock_datetime >= b.begin_date and 
                                                                   a.lock_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_MB_BUF_LOCK_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_MB_BUF_LOCK_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_MB_BUF_LOCK
         
         execute immediate
         'insert into ACC_ST.T#ST_MB_BUF_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
					
					FROM ACC_ST.T#ST_MB_BUF_LOCK_CHK
                    WHERE TABLE_NAME= :x AND
                          CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
                          
                           
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_MB_BUF_LOCK;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_MB_ERR_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,CARD_APP_MODE,MOBILE_NO
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',CARD_APP_MODE,MOBILE_NO
					FROM ACC_ST.T#ST_MB_BUF_LOCK;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_MB_BUF_LOCK
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_MB_BUF_LOCK
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_MB_QUE_LOCK(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
							  from ACC_ST.ST_MB_BUF_LOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_MB_QUE_LOCK(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO)
		select     DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
							  from ACC_ST.ST_MB_BUF_LOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ACC_ST.ST_MB_TST_LOCK(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE,MOBILE_NO
							  from ACC_ST.ST_MB_BUF_LOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
  
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_MB_BUF_LOCK where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_MB_TRF_BUF_QUEUE_LOCK to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_MB_TRF_BUF_QUEUE_RETURN
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_mb_trf_buf_queue_return
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_mb_trf_buf_queue_return
--π¶ƒ‹√Ë ˆ£∫–£—È ÷ª˙÷ß∏∂ÕÀøÓª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160119
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
--–ﬁ∏ƒ√Ë ˆ£∫
 
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from acc_st.st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='57';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
DELETE FROM ACC_ST.ST_MB_BUF_RETURN 
                         WHERE 
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_MB_ERR_RETURN WHERE 
						        FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41'
						   );
						   
----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_MB_BUF_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
					FROM ACC_ST.ST_MB_BUF_RETURN
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_MB_QUE_RETURN
						   );
                           
--µ±«∞¿˙ ∑±Ì≤È÷ÿ
--ACC_ST_HIS.
insert into ACC_ST.T#ST_MB_BUF_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
					FROM ACC_ST.ST_MB_BUF_RETURN
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_MB_HIS_RETURN
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.ST_MB_BUF_RETURN
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           return_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into ACC_ST.T#ST_MB_BUF_RETURN_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
					FROM ACC_ST.ST_MB_BUF_RETURN 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          return_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_MB_BUF_RETURN_CHK a set a.table_name = (select trim(b.table_name) from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.return_datetime >= b.begin_date and 
                                                                   a.return_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.return_datetime >= b.begin_date and 
                                                                   a.return_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_MB_BUF_RETURN_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_MB_BUF_RETURN_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_MB_BUF_RETURN
         
         execute immediate
         'insert into ACC_ST.T#ST_MB_BUF_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
					
					FROM ACC_ST.T#ST_MB_BUF_RETURN_CHK
                    WHERE TABLE_NAME= :x AND
                          CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
  
                           
                           
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
                           
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_MB_BUF_RETURN;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_MB_ERR_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
					FROM ACC_ST.T#ST_MB_BUF_RETURN;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_MB_BUF_RETURN
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_MB_BUF_RETURN
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_MB_QUE_RETURN(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
							  from ACC_ST.ST_MB_BUF_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_MB_QUE_RETURN(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
							  from ACC_ST.ST_MB_BUF_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ACC_ST.ST_MB_TST_RETURN(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,
                             MOBILE_NO,PAID_CHANNEL_TYPE,PAID_CHANNEL_CODE
							  from ACC_ST.ST_MB_BUF_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
  
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_MB_BUF_RETURN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_MB_TRF_BUF_QUEUE_RETURN to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_MB_TRF_BUF_QUEUE_SALE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_mb_trf_buf_queue_sale
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_mb_trf_buf_queue_sale
--π¶ƒ‹√Ë ˆ£∫–£—È ÷ª˙÷ß∏∂∑¢ €ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160119
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ√Ë ˆ£∫
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from acc_st.st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='71';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into acc_st.T#ST_MB_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG ,MOBILE_NO
                            )
					SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
					FROM ACC_ST.ST_MB_BUF_SALE 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_MB_QUE_SALE
						   );
--µ±«∞¿˙ ∑±Ì≤È÷ÿ
insert into ACC_ST.T#ST_MB_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG ,MOBILE_NO
                            )
					SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
					FROM ACC_ST.ST_MB_BUF_SALE 
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_MB_HIS_SALE
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from acc_st.st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from acc_st.ST_MB_BUF_SALE
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           sale_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£© 
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
       insert into ACC_ST.T#ST_MB_BUF_SALE_CHK(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG ,MOBILE_NO
                            )
					SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
					FROM ACC_ST.ST_MB_BUF_SALE 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          sale_datetime <= dateMaxHis;
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_MB_BUF_SALE_CHK a set a.table_name = (select trim(b.table_name) from acc_st.st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.sale_datetime >= b.begin_date and 
                                                                   a.sale_datetime <= b.end_date )
                                  where exists(select b.table_name from acc_st.st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.sale_datetime >= b.begin_date and 
                                                                   a.sale_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_MB_BUF_SALE_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_MB_BUF_SALE_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_MB_BUF_SALE
         
         execute immediate
         'insert into ACC_ST.T#ST_MB_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG ,MOBILE_NO
                            )
					SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
					FROM ACC_ST.T#ST_MB_BUF_SALE_CHK 
					WHERE TABLE_NAME= :x AND
					      
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         
         using tableName;
         
         
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
                          
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------                           
   
                        
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_MB_BUF_SALE;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_MB_ERR_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,ERR_CODE,MOBILE_NO
                            )
					SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,'42',MOBILE_NO
					FROM ACC_ST.T#ST_MB_BUF_SALE;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_MB_BUF_SALE
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_MB_BUF_SALE
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  --≤ª∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  
  if testControl = '0'  then
     begin
        --À˘”–µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_MB_QUE_SALE( WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO)
		 select    DISTINCT  WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
							  from ACC_ST.ST_MB_BUF_SALE
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
       --µº»Î∂”¡–±Ì
       insert into      ACC_ST.ST_MB_QUE_SALE( WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO)
		select      DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
							  from ACC_ST.ST_MB_BUF_SALE
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and
                                    CARD_APP_FLAG='0';
         --µº»Î≤‚ ‘±Ì                   
         insert into         ACC_ST.ST_MB_TST_SALE( WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO)
	   select       DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
							 DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
							 FILE_NAME,CHECK_FLAG,MOBILE_NO
							  from ACC_ST.ST_MB_BUF_SALE
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and
                                    CARD_APP_FLAG='1';
      end;
  end if;
  
                              
  ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_MB_BUF_SALE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_MB_TRF_BUF_QUEUE_SALE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_MB_TRF_BUF_QUEUE_STL
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_mb_trf_buf_queue_stl
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_mb_trf_buf_queue_stl
--π¶ƒ‹√Ë ˆ£∫–£—È ÷ª˙÷ß∏∂LCC∂‘’À ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160119
--–ﬁ∏ƒ’ﬂ:  hejj
--–ﬁ∏ƒ»’∆⁄: 20160127
--–ﬁ∏ƒ√Ë ˆ: ‘ˆº”∑¢ €°¢À¯ø®°¢Ω‚À¯◊÷∂Œ
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_MB_BUF_LCC(
                             WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,CHARGE_NUM,CHARGE_FEE,
                             RETURN_NUM,RETURN_FEE,SALE_NUM,SALE_FEE,LOCK_NUM,UNLOCK_NUM, FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,CHARGE_NUM,CHARGE_FEE,
                   RETURN_NUM,RETURN_FEE,SALE_NUM,SALE_FEE,LOCK_NUM,UNLOCK_NUM,  FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_MB_BUF_LCC
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸œﬂ¬∑°¢≥µ’æ°¢«ÂÀ„¡˜ÀÆ∫≈°¢Œƒº˛√˚≥∆
                LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME IN   --÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆20150410 by hejj
              (
                 SELECT LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME
               FROM ACC_ST.ST_MB_QUE_LCC
               );
               
               
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_MB_BUF_LCC;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_MB_ERR_LCC(
                             WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,CHARGE_NUM,CHARGE_FEE,
                             RETURN_NUM,RETURN_FEE,SALE_NUM,SALE_FEE,LOCK_NUM,UNLOCK_NUM,  FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
          SELECT   WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,CHARGE_NUM,CHARGE_FEE,
                   RETURN_NUM,RETURN_FEE,SALE_NUM,SALE_FEE,LOCK_NUM,UNLOCK_NUM,  FILE_NAME,CHECK_FLAG,'42'
          FROM ACC_ST.T#ST_MB_BUF_LCC;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_MB_BUF_LCC
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸œﬂ¬∑°¢≥µ’æ°¢«ÂÀ„¡˜ÀÆ∫≈°¢Œƒº˛√˚≥∆
                LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME IN  --÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆20150410 by hejj
              (
                 SELECT LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME
               FROM ACC_ST.T#ST_MB_BUF_LCC
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_MB_QUE_LCC( WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,CHARGE_NUM,CHARGE_FEE,
                                         RETURN_NUM,RETURN_FEE,SALE_NUM,SALE_FEE,LOCK_NUM,UNLOCK_NUM,  FILE_NAME,CHECK_FLAG)
    select               WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,CHARGE_NUM,CHARGE_FEE,
                         RETURN_NUM,RETURN_FEE,SALE_NUM,SALE_FEE,LOCK_NUM,UNLOCK_NUM,  FILE_NAME,CHECK_FLAG
                from ACC_ST.ST_MB_BUF_LCC
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_MB_BUF_LCC where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_MB_TRF_BUF_QUEUE_STL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_NP_TRF_BUF_QUEUE_DEAL
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_np_trf_buf_queue_deal
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_np_trf_buf_queue_deal
--π¶ƒ‹√Ë ˆ£∫–£—Èª•¡™Õ¯÷ß∏∂«Æ∞¸Ωª“◊ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20161125
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄:
--–ﬁ∏ƒ√Ë ˆ£∫
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
---
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from acc_st.st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='84';--Œ¥»∑∂®–¥÷µ
---
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
--ª∫¥ÊTAC–£—È≤ªÕ®π˝º«¬º
INSERT INTO ACC_ST.T#ST_NP_ERR_DEAL(CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,DEAL_DATETIME,
                                    FILE_NAME,BALANCE_WATER_NO,ERR_CODE)
                   SELECT CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,DEAL_DATETIME,
                          FILE_NAME,BALANCE_WATER_NO,ERR_CODE
                   FROM ACC_ST.ST_NP_ERR_DEAL WHERE
                        FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41';
DELETE FROM ACC_ST.ST_NP_BUF_DEAL A
                         WHERE
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(   SELECT 1 FROM ACC_ST.T#ST_NP_ERR_DEAL B
                                   WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                         A.SAM_LOGICAL_ID =B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ =B.SAM_TRADE_SEQ AND
                                         A.DEAL_DATETIME =B.DEAL_DATETIME
                );

----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--”ÎŒƒº˛√˚≥∆–°µƒº«¬º±»Ωœ£¨’‚—˘Œƒº˛√˚≥∆–°µƒ÷ÿ∏¥º«¬º±£¡Ù£¨Œƒº˛√˚≥∆¥Ûµƒ÷ÿ∏¥º«¬º…æ≥˝
insert into ACC_ST.T#ST_NP_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
          FROM ACC_ST.ST_NP_BUF_DEAL A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰°¢¬ﬂº≠ø®∫≈
                EXISTS(SELECT 1 FROM ACC_ST.ST_NP_BUF_DEAL B
                                WHERE B.FILE_NAME < piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND
                                A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                A.SAM_LOGICAL_ID =B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ =B.SAM_TRADE_SEQ AND
                                A.DEAL_DATETIME =B.DEAL_DATETIME AND A.DEAL_FEE =B.DEAL_FEE AND
                                A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE AND A.CARD_LOGICAL_ID =B.CARD_LOGICAL_ID
                );

--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_NP_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
          FROM ACC_ST.ST_NP_BUF_DEAL A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(SELECT 1 FROM ACC_ST.ST_NP_QUE_DEAL B
                                WHERE
                                A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                A.SAM_LOGICAL_ID =B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ =B.SAM_TRADE_SEQ AND
                                A.DEAL_DATETIME =B.DEAL_DATETIME AND A.DEAL_FEE =B.DEAL_FEE AND
                                A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE AND A.CARD_LOGICAL_ID =B.CARD_LOGICAL_ID
                );

  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
  insert into ACC_ST.T#ST_NP_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
          FROM ACC_ST.ST_NP_BUF_DEAL a
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          TO_CHAR(DEAL_DATETIME+7,'YYYYMMDD') < SUBSTR(piBalanceWaterNo,1,8)  AND   --ADD BY HEJJ 20140808
                /* modify by hejj 20150302
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE) IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
                                   ||TO_CHAR(DEAL_FEE)|| TO_CHAR(DEAL_BALANCE_FEE)
               FROM ACC_ST_HIS.ST_NP_HIS_DEAL
               )
               */
               exists(
                     select 1 from acc_st_his.ST_NP_HIS_DEAL b
                              where a.card_main_id = b.card_main_id and a.card_sub_id = b.card_sub_id and
                                    a.sam_logical_id = b.sam_logical_id and a.sam_trade_seq = b.sam_trade_seq and
                                    a.deal_datetime = b.deal_datetime and a.deal_fee =b.deal_fee and
                                    a.deal_balance_fee = b.deal_balance_fee and a.CARD_LOGICAL_ID=b.CARD_LOGICAL_ID
               )
               ;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from acc_st.st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.ST_NP_BUF_DEAL
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           deal_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
dbms_output.put_line('isNeedCheckHisSub='||isNeedCheckHisSub);
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    insert into ACC_ST.T#ST_NP_BUF_DEAL_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
          FROM ACC_ST.ST_NP_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          deal_datetime <= dateMaxHis;
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_NP_BUF_DEAL_CHK a set a.table_name = (select trim(b.table_name) from acc_st.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date )
                                  where exists(select b.table_name from acc_st.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_NP_BUF_DEAL_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         dbms_output.put_line('tableName='||tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_NP_BUF_DEAL_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_NP_BUF_DEAL
         dbms_output.put_line('execute immediate begin');


execute immediate
         'insert into ACC_ST.T#ST_NP_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
          FROM ACC_ST.T#ST_NP_BUF_DEAL_CHK
                    WHERE TABLE_NAME= :x AND
                    EXISTS(SELECT 1 FROM ACC_ST_HIS.'||tableName||' B
                                WHERE
                                A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                A.SAM_LOGICAL_ID =B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ =B.SAM_TRADE_SEQ AND
                                A.DEAL_DATETIME =B.DEAL_DATETIME AND A.DEAL_FEE =B.DEAL_FEE AND
                                A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE AND A.CARD_LOGICAL_ID =B.CARD_LOGICAL_ID
                );'

         using tableName;
         dbms_output.put_line('execute immediate end');
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_NP_BUF_DEAL;
  dbms_output.put_line('T#ST_NP_BUF_DEAL count='||to_char(rowCount));
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_NP_ERR_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
          FROM ACC_ST.T#ST_NP_BUF_DEAL;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_NP_BUF_DEAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS') IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
               FROM ACC_ST.T#ST_NP_BUF_DEAL
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ìº∞Œƒº˛ƒ⁄≤È÷ÿ
        insert into ACC_ST.ST_NP_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                from ACC_ST.ST_NP_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_NP_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO)
    select    DISTINCT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,
                             ORDER_NO
                from ACC_ST.ST_NP_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into ACC_ST.ST_NP_TST_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,                             ORDER_NO)
    select     DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             ORDER_NO
                from ACC_ST.ST_NP_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------

 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_NP_BUF_DEAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_NP_TRF_BUF_QUEUE_DEAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_NP_TRF_BUF_QUEUE_ORD
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_np_trf_buf_queue_ord
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_np_trf_buf_queue_ord
--π¶ƒ‹√Ë ˆ£∫–£—Èª•¡™Õ¯÷ß∏∂∂©µ• ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20161125
--–ﬁ∏ƒ’ﬂ:  20161219
--–ﬁ∏ƒ»’∆⁄: ‘ˆº”ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ/¿˙ ∑±Ì≤È÷ÿ
--–ﬁ∏ƒ√Ë ˆ:
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
insert into ACC_ST.T#ST_NP_BUF_ORDER(
                             WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_ORDER
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
                        FROM ACC_ST.ST_NP_BUF_ORDER A
                        WHERE A.FILE_NAME< piFileName AND A.BALANCE_WATER_NO =piBalanceWaterNo

               );
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
insert into ACC_ST.T#ST_NP_BUF_ORDER(
                             WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_ORDER
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST.ST_NP_QUE_ORDER
               );

 --–£—È
--÷ÿ∏¥–‘–£—È
--”Î¿˙ ∑±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
insert into ACC_ST.T#ST_NP_BUF_ORDER(
                             WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_ORDER
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST_HIS.ST_NP_HIS_ORDER
               );


  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_NP_BUF_ORDER;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_NP_ERR_ORDER(
                             WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
          FROM ACC_ST.T#ST_NP_BUF_ORDER;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_NP_BUF_ORDER
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST.T#ST_NP_BUF_ORDER
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_NP_QUE_ORDER( WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
    select               WATER_NO,ORDER_NO,ORDER_TYPE,STATUS,GENERATE_DATETIME,
                             PAID_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,LINE_ID_START,
                             STATION_ID_START,LINE_ID_END,STATION_ID_END,DEAL_UNIT_FEE,
                             DEAL_NUM,DEAL_FEE,ORDER_TYPE_BUY,PAID_CHANNEL_TYPE,
                             PAID_CHANNEL_CODE,MOBILE_NO,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                from ACC_ST.ST_NP_BUF_ORDER
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_NP_BUF_ORDER where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_NP_TRF_BUF_QUEUE_ORD to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_NP_TRF_BUF_QUEUE_ORI
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_np_trf_buf_queue_ori
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_np_trf_buf_queue_ori
--π¶ƒ‹√Ë ˆ£∫–£—Èª•¡™Õ¯÷ß∏∂∂©µ•÷¥–– ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20161125
--–ﬁ∏ƒ’ﬂ:  20161219
--–ﬁ∏ƒ»’∆⁄: ‘ˆº”ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ/¿˙ ∑±Ì≤È÷ÿ
--–ﬁ∏ƒ√Ë ˆ:
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
insert into ACC_ST.T#ST_NP_BUF_ORDER_IMP(
                             WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_ORDER_IMP
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST.ST_NP_BUF_ORDER_IMP A
               WHERE A.FILE_NAME <piFileName AND A.BALANCE_WATER_NO =piBalanceWaterNo
               );
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
insert into ACC_ST.T#ST_NP_BUF_ORDER_IMP(
                             WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_ORDER_IMP
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST.ST_NP_QUE_ORDER_IMP
               );

 --–£—È
--÷ÿ∏¥–‘–£—È
--”Î¿˙ ∑±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
insert into ACC_ST.T#ST_NP_BUF_ORDER_IMP(
                             WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_ORDER_IMP
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST_HIS.ST_NP_HIS_ORDER_IMP
               );


  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_NP_BUF_ORDER_IMP;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_NP_ERR_ORDER_IMP(
                             WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
          SELECT   WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG,'42'
          FROM ACC_ST.T#ST_NP_BUF_ORDER_IMP;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_NP_BUF_ORDER_IMP
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∂©µ•∫≈
                ORDER_NO IN
              (
                 SELECT ORDER_NO
               FROM ACC_ST.T#ST_NP_BUF_ORDER_IMP
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_NP_QUE_ORDER_IMP( WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG)
    select               WATER_NO,ORDER_NO,ORDER_TYPE,FINISH_DATETIME,LINE_ID,STATION_ID,
                             DEV_TYPE_ID,DEV_CODE,STATUS,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,
                             DEAL_NUM_NOT,DEAL_FEE,REFUND_FEE,AUXI_FEE,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
                from ACC_ST.ST_NP_BUF_ORDER_IMP
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_NP_BUF_ORDER_IMP where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_NP_TRF_BUF_QUEUE_ORI to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_NP_TRF_BUF_QUEUE_SALE
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_np_trf_buf_queue_sale
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_np_trf_buf_queue_sale
--π¶ƒ‹√Ë ˆ£∫–£—Èª•¡™Õ¯÷ß∏∂µ•≥Ã∆±∑¢ €ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20161125
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄:
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ√Ë ˆ£∫
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from ACC_ST.st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='70';
----------------------------------------------------------------------------------
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--ª∫¥ÊTAC¥ÌŒÛº«¬º
insert into ACC_ST.T#ST_NP_ERR_SALE(CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,SALE_DATETIME,FILE_NAME,
                             BALANCE_WATER_NO,ERR_CODE)
                select        CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,SALE_DATETIME,FILE_NAME,
                             BALANCE_WATER_NO,ERR_CODE
                       FROM ACC_ST.ST_NP_ERR_SALE
                       WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41';
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
DELETE FROM ACC_ST.ST_NP_BUF_SALE A
                         WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                               EXISTS(SELECT 1 FROM ACC_ST.T#ST_NP_ERR_SALE B
                                               WHERE B.FILE_NAME=piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo
                                               AND B.ERR_CODE='41' AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                                               A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                               A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                               A.SALE_DATETIME=B.SALE_DATETIME);


----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
insert into ACC_ST.T#ST_NP_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
          FROM ACC_ST.ST_NP_BUF_SALE A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                                 SELECT 1 FROM ACC_ST.ST_NP_BUF_SALE B WHERE
                                               B.BALANCE_WATER_NO= piBalanceWaterNo AND
                                               B.FILE_NAME< piFileName  AND
                                               A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                               A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                               A.SALE_DATETIME=B.SALE_DATETIME
                          );

--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_NP_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
          FROM ACC_ST.ST_NP_BUF_SALE A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                                 SELECT 1 FROM ACC_ST.ST_NP_QUE_SALE B WHERE
                                               A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                               A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                               A.SALE_DATETIME=B.SALE_DATETIME
                          );

  --µ±«∞¿˙ ∑±Ì≤È÷ÿ

insert into ACC_ST.T#ST_NP_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
          FROM ACC_ST.ST_NP_BUF_SALE A
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                                 SELECT 1 FROM ACC_ST_HIS.ST_NP_HIS_SALE B WHERE
                                               A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                               A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                               A.SALE_DATETIME=B.SALE_DATETIME
                          );



---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;

--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.ST_NP_BUF_SALE
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           sale_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©

    insert into ACC_ST.T#ST_NP_BUF_SALE_CHK(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
          FROM ACC_ST.ST_NP_BUF_SALE
                    WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          sale_datetime <= dateMaxHis;

       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_NP_BUF_SALE_CHK a set a.table_name = (select trim(b.table_name) from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date);

      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_NP_BUF_SALE_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);

         exit when csr%notfound;

         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_NP_BUF_SALE_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_NP_BUF_SALE

         execute immediate
         'insert into ACC_ST.T#ST_NP_BUF_SALE(
                              WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID ,ORDER_NO
                            )
                    SELECT    WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
          FROM ACC_ST.T#ST_NP_BUF_SALE_CHK A
                    WHERE TABLE_NAME= :x AND
                          EXISTS(
                                 SELECT 1 FROM ACC_ST_HIS.'||tableName||' B WHERE
                                               A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                               A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                               A.SALE_DATETIME=B.SALE_DATETIME
                          )'
                          using tableName;

      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;

---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------


  --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------


  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_NP_BUF_SALE;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_NP_ERR_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,ERR_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,'42',TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
          FROM ACC_ST.T#ST_NP_BUF_SALE;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_NP_BUF_SALE A
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                                 SELECT 1 FROM ACC_ST.T#ST_NP_BUF_SALE B WHERE
                                               A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                               A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                               A.SALE_DATETIME=B.SALE_DATETIME
                          );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------

--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_NP_QUE_SALE(WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO)
    select       DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,--SALE_DATETIME
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                from ACC_ST.ST_NP_BUF_SALE
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;

   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_NP_QUE_SALE(WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO)
    select        DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,--SALE_DATETIME
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                from ACC_ST.ST_NP_BUF_SALE
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
      insert into ACC_ST.ST_NP_TST_SALE(WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO)
    select    DISTINCT    WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,--SALE_DATETIME
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID,ORDER_NO
                from ACC_ST.ST_NP_BUF_SALE
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;

   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------

 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_NP_BUF_SALE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;




   COMMIT;


   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_NP_TRF_BUF_QUEUE_SALE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_NP_TRF_BUF_QUEUE_STL
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_np_trf_buf_queue_stl
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_np_trf_buf_queue_stl
--π¶ƒ‹√Ë ˆ£∫–£—Èª•¡™Õ¯÷ß∏∂LCC∂‘’À ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20161125
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄:
--–ﬁ∏ƒ√Ë ˆ:
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_NP_BUF_LCC(
                             WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,SALE_NUM,SALE_FEE,CHARGE_NUM,CHARGE_FEE,
                             FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,SALE_NUM,SALE_FEE,CHARGE_NUM,CHARGE_FEE,
                             FILE_NAME,CHECK_FLAG
          FROM ACC_ST.ST_NP_BUF_LCC
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸œﬂ¬∑°¢≥µ’æ°¢«ÂÀ„¡˜ÀÆ∫≈°¢Œƒº˛√˚≥∆
                LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME IN   --÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆20150410 by hejj
              (
                 SELECT LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME
               FROM ACC_ST.ST_NP_QUE_LCC
               );


  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_NP_BUF_LCC;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_NP_ERR_LCC(
                             WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,SALE_NUM,SALE_FEE,CHARGE_NUM,CHARGE_FEE,
                             FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
          SELECT   WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,SALE_NUM,SALE_FEE,CHARGE_NUM,CHARGE_FEE,
                             FILE_NAME,CHECK_FLAG,'42'
          FROM ACC_ST.T#ST_NP_BUF_LCC;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_NP_BUF_LCC
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸œﬂ¬∑°¢≥µ’æ°¢«ÂÀ„¡˜ÀÆ∫≈°¢Œƒº˛√˚≥∆
                LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME IN  --÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆20150410 by hejj
              (
                 SELECT LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME
               FROM ACC_ST.T#ST_NP_BUF_LCC
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_NP_QUE_LCC( WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,SALE_NUM,SALE_FEE,
                                         CHARGE_NUM,CHARGE_FEE,FILE_NAME,CHECK_FLAG)
    select               WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,SALE_NUM,SALE_FEE,
                                         CHARGE_NUM,CHARGE_FEE,FILE_NAME,CHECK_FLAG
                from ACC_ST.ST_NP_BUF_LCC
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_NP_BUF_LCC where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_NP_TRF_BUF_QUEUE_STL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_RBK_SETTLE_AFT
prompt =======================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_rbk_settle_aft
(  out_retResult OUT INTEGER, --∑µªÿΩ·π˚
   out_msg OUT VARCHAR2, --∑µªÿ–≈œ¢
   in_balance_water_no in VARCHAR2   --ªÿπˆµƒ«ÂÀ„¡˜ÀÆ∫≈
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_rbk_settle_aft
--π¶ƒ‹√Ë ˆ£∫÷–—Î«ÂÀ„£∫Ω·À„ªÿπˆ
-- ‰≥ˆ≤Œ ˝  £∫out_retResult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ in_balance_water_no ªÿπˆƒ≥ÃÏ«ÂÀ„¡˜ÀÆ∫≈
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú20140111
--–ﬁ∏ƒ£∫ --ver1.01 ‘ˆº”≤Œ ˝in_balance_water_no 2014-6-9
        --ver1.02 ‘ˆº”±»Ωœ◊Ó¥ÛΩª“◊ ±º‰ ,ªÿπˆø®”‡∂Ó 2014-6-25
        --ver1.10 Õ≥“ª∏¸–¬∞Ê±æ ∏¸–¬»’∆⁄2014-8-11
        --ver1.13 Õ‚≤øœµÕ≥∑µªÿΩ·π˚∏ƒŒ™»°…œ“ª¥Œµƒ¡˜ÀÆ∫≈ ∏¸–¬»’∆⁄2014-8-11
        --ver1.14 »°…œ“ª¥Œµƒ¡˜ÀÆ∫≈ ±÷∏∂®–°”⁄±æ¥Œ¡˜ÀÆ∫≈ ∏¸–¬»’∆⁄2015-3-31
        --ver1.32 º«√˚ø®°¢ ÷ª˙÷ß∏∂°¢∂œ√ÊøÕ¡˜°¢samø®∑÷Œˆ°¢”‡∂Ó∆Ω∫‚
        --ver1.33 ¿˙ ∑∑÷±Ì«Â≥˝
        --ver1.35  ÷ª˙÷ß∏∂∂‘’À by lindaquan in 20160615
        --ver1.38 ª•¡™Õ¯÷ß∏∂∂‘’À by lindaquan in 20161212
-------------------------------------------------------------------------------
aS
   v_msg varchar(50);
   v_count int;
   v_last_balance_audit char(10);--…œ“ª¥ŒÕ‚≤øœµÕ≥∑µªÿ¡˜ÀÆ∫≈ ver1.13 2014-8-23
   v_table_name CHAR(50); --SQL∆¥Ω”±Ì√˚
   v_sql     CHAR(1024); --∆¥Ω”SQL
BEGIN
  -- ¿˙ ∑∑÷±Ì«Â≥˝ -----
  DECLARE cursor table_cur is
          select table_name from acc_st.ST_IDX_TRX_HISTORY_BALANCE
          where balance_water_no=in_balance_water_no and data_type='trx' order by table_name;
  BEGIN
    open table_cur;
      LOOP
        fetch table_cur into v_table_name;
        exit when table_cur%notfound;
        v_sql := 'delete acc_st_his.'|| trim(v_table_name) ||' where balance_water_no='''||in_balance_water_no||'''';
        BEGIN
            EXECUTE immediate v_sql;
            DBMS_OUTPUT.PUT_LINE(v_sql);
              EXCEPTION
              WHEN others THEN
                Begin
                  DBMS_OUTPUT.PUT_LINE('sqlcode : ' || SQLCODE);
                  out_retResult:=SQLCODE;
                END;
        END;
        v_sql := 'delete acc_st.ST_IDX_TRX_HISTORY_BALANCE where balance_water_no='''||in_balance_water_no||''' and table_name='''||trim(v_table_name)||'''';
        BEGIN
            EXECUTE immediate v_sql;
            DBMS_OUTPUT.PUT_LINE(v_sql);
              EXCEPTION
              WHEN others THEN
                Begin
                  DBMS_OUTPUT.PUT_LINE('sqlcode : ' || SQLCODE);
                  out_retResult:=SQLCODE;
                END;
        END;
      END LOOP;
    close table_cur;
  END;
  -------------------------«Â≥˝Ωª“◊¿˙ ∑±Ì
  --«Æ∞¸Ωª“◊
  delete acc_st_his.st_his_deal where balance_water_no=in_balance_water_no ;
  delete st_err_deal where balance_water_no=in_balance_water_no ;
  --Ω¯’æº«¬º
  delete acc_st_his.st_his_entry where balance_water_no=in_balance_water_no;
  delete st_err_entry where balance_water_no=in_balance_water_no;
  --∏¸–¬
  delete acc_st_his.st_his_update where balance_water_no=in_balance_water_no;
  delete st_err_update where balance_water_no=in_balance_water_no;
  --µ•≥Ã∆± €∆±
  delete acc_st_his.st_his_sale_sjt where balance_water_no=in_balance_water_no;
  delete st_err_sale_sjt where balance_water_no=in_balance_water_no;
  -- €∆±
  delete acc_st_his.st_his_sale where balance_water_no=in_balance_water_no;
  delete st_err_sale where balance_water_no=in_balance_water_no;
  --ÕÀø®
  delete acc_st_his.st_his_return where balance_water_no=in_balance_water_no;
  delete st_err_return where balance_water_no=in_balance_water_no;
  --∑«º¥ ±ÕÀøÓ…Í«Î
  delete acc_st_his.st_his_non_rtn_app where balance_water_no=in_balance_water_no;
  delete st_err_non_rtn_app where balance_water_no=in_balance_water_no;
    --∆±ø®—”∆⁄
  delete acc_st_his.st_his_delay where balance_water_no=in_balance_water_no;
  delete st_err_delay where balance_water_no=in_balance_water_no;
  --À¯ø®
  delete acc_st_his.st_his_lock where balance_water_no=in_balance_water_no;
  delete st_err_lock where balance_water_no=in_balance_water_no;
  --––’˛¥¶¿Ì
  delete acc_st_his.st_his_admin where balance_water_no=in_balance_water_no;
  delete st_err_admin where balance_water_no=in_balance_water_no;
  --º«√˚ø®(¥”…æ≥˝st_list_sign_card–ﬁ∏ƒŒ™st_his_sign_card_apply)
  delete acc_st_his.st_his_sign_card_apply where balance_water_no=in_balance_water_no;
  delete st_err_sign_card_apply where balance_water_no=in_balance_water_no;
  --º«√˚ø®π“ ß/Ω‚π“/≤πø®…Í«Î ver1.32 by lindaquan in 20160616
  delete acc_st_his.st_his_report_loss where balance_water_no=in_balance_water_no;
  delete acc_st.st_err_report_loss where balance_water_no=in_balance_water_no;
  --µÿÃ˙ø®‘⁄π´ΩªµƒΩª“◊±Ì
  delete acc_st_his.st_ext_mtr_his_deal where balance_water_no=in_balance_water_no;
  delete st_ext_mtr_err_deal where balance_water_no=in_balance_water_no;
  delete st_ext_mtr_audit_balance where balance_water_no=in_balance_water_no;
  delete st_ext_mtr_err_trade where balance_water_no=in_balance_water_no;
  --π´Ωªicø®«Æ∞¸Ωª“◊±Ì
  delete acc_st_his.st_his_deal_oct where balance_water_no=in_balance_water_no;
   --π´Ωª €ø®Ωª“◊
  delete acc_st_his.st_his_sale_oct where balance_water_no=in_balance_water_no;
  --“¯¡™ø®«Æ∞¸Ωª“◊±Ì
  delete acc_st_his.st_his_deal_bank where balance_water_no=in_balance_water_no;
  ----------------- ’“Ê ˝æ›
  --bom∞‡¥Œ ˝æ›÷˜ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_total where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_total where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑¢ €£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_sale where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_sale where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰÷µ£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_charge where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_charge where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∏¸–¬£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_update where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_update where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®––’˛¥¶¿Ì£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_admin where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_admin where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®—”∆⁄£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_delay where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_delay where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_return where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_return where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_rtn_non where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_rtn_non where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ…Í«Î£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_rtn_app where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_rtn_app where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰’˝£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_chg_upd where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_chg_upd where balance_water_no=in_balance_water_no;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®Ω‚À¯£©ª∫¥Ê±Ì
  delete acc_st_his.st_his_bom_shift_unlock where balance_water_no=in_balance_water_no;
  delete st_err_bom_shift_unlock where balance_water_no=in_balance_water_no;
  --tvm÷Ω±“œ‰ ˝æ›ª∫¥Ê±Ì
  delete acc_st_his.st_his_tvm_note_data where balance_water_no=in_balance_water_no;
  delete st_err_tvm_note_data where balance_water_no=in_balance_water_no;
  --tvm”≤±“œ‰ ˝æ›
  delete acc_st_his.st_his_tvm_coin_data where balance_water_no=in_balance_water_no;
  delete st_err_tvm_coin_data where balance_water_no=in_balance_water_no;
  --tvm”≤±“œ‰¥Ê»Î ˝æ›
  delete acc_st_his.st_his_tvm_coin_put where balance_water_no=in_balance_water_no;
  delete st_err_tvm_coin_put where balance_water_no=in_balance_water_no;
  --tvm”≤±“œ‰«Âø’ ˝æ›
  delete acc_st_his.st_his_tvm_coin_clear where balance_water_no=in_balance_water_no;
  delete st_err_tvm_coin_clear where balance_water_no=in_balance_water_no;
  --tvm∆±œ‰¥Ê»Î ˝æ›
  delete acc_st_his.st_his_tvm_card_put where balance_water_no=in_balance_water_no;
  delete st_err_tvm_card_put where balance_water_no=in_balance_water_no;
  --tvm∆±œ‰«Âø’ ˝æ›
  delete acc_st_his.st_his_tvm_card_clear where balance_water_no=in_balance_water_no;
  delete st_err_tvm_card_clear where balance_water_no=in_balance_water_no;
  --tvm∑œ∆±œ‰ ˝æ›
  delete acc_st_his.st_his_tvm_waste_card_data where balance_water_no=in_balance_water_no;
  delete st_err_tvm_waste_card_data where balance_water_no=in_balance_water_no;
  --agm∆±œ‰ ˝æ›
  delete acc_st_his.st_his_agm_card_data where balance_water_no=in_balance_water_no;
  delete st_err_agm_card_data where balance_water_no=in_balance_water_no;
  --TVMΩ·’À ˝æ›°¢◊‘∂ØΩ·¥Ê°¢÷Ω±“ªÿ ’œ‰°¢’“¡„œ‰¥Ê»Î°¢’“¡„œ‰»°≥ˆ
  delete acc_st_his.st_his_tvm_bal where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_tvm_auto_bal where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_tvm_note_chg_pop where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_tvm_note_chg_put where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_tvm_note_reclaim where balance_water_no=in_balance_water_no;
  delete st_err_tvm_auto_bal where balance_water_no=in_balance_water_no;
  delete st_err_tvm_bal where balance_water_no=in_balance_water_no;
  delete st_err_tvm_note_chg_pop where balance_water_no=in_balance_water_no;
  delete st_err_tvm_note_chg_put where balance_water_no=in_balance_water_no;
  delete st_err_tvm_note_reclaim where balance_water_no=in_balance_water_no;
  --------------------------ºƒ¥Ê∆˜ ˝æ›
  delete acc_st_his.st_his_reg_total where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_reg_dtl where balance_water_no=in_balance_water_no;
  delete st_err_reg_total where balance_water_no=in_balance_water_no;
  delete st_err_reg_dtl where balance_water_no=in_balance_water_no;
  --------------------------…Ûº∆ ˝æ›
  delete acc_st_his.st_his_agm_cutoff_total where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_agm_cutoff_dtl where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_tvm_cutoff_total where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_his_tvm_cutoff_dtl where balance_water_no=in_balance_water_no;
  delete st_err_agm_cutoff_total where balance_water_no=in_balance_water_no;
  delete st_err_agm_cutoff_dtl where balance_water_no=in_balance_water_no;
  delete st_err_tvm_cutoff_total where balance_water_no=in_balance_water_no;
  delete st_err_tvm_cutoff_dtl where balance_water_no=in_balance_water_no;
    ----------------------------Õ≥º∆÷–º‰±Ì---------
    --ƒ⁄≤ø«ÂÀ„
  delete st_list_balance_trx ;
  delete st_sts_income_contc_card where balance_water_no=in_balance_water_no;
  delete st_sts_dispart_contc where balance_water_no=in_balance_water_no;
  delete st_sts_dispart_line where balance_water_no=in_balance_water_no;
  delete st_sts_balance_contc_trd where balance_water_no=in_balance_water_no;
  delete st_sts_balance_line_trd where balance_water_no=in_balance_water_no;
  delete st_sts_balance_contc_inc where balance_water_no=in_balance_water_no;
  delete st_sts_balance_line_inc where balance_water_no=in_balance_water_no;
  delete acc_st.ST_STS_INCOME_CONTC_CARD_MODE where balance_water_no=in_balance_water_no;
    --Õ‚≤ø«ÂÀ„
  select max(balance_water_no) into v_last_balance_audit from st_ext_oct_audit_balance
  where balance_water_no<in_balance_water_no;--ver1.14 »°…œ“ª¥Œµƒ¡˜ÀÆ∫≈ ±÷∏∂®–°”⁄±æ¥Œ¡˜ÀÆ∫≈
  update st_ext_oct_audit_balance set in_flag='0' where balance_water_no=v_last_balance_audit;--ver1.13–ﬁ∏ƒŒ™…œ“ª¥Œ¡˜ÀÆ∫≈
  update st_ext_oct_err_trade set in_flag='0' where balance_water_no=v_last_balance_audit;--ver1.13–ﬁ∏ƒŒ™…œ“ª¥Œ¡˜ÀÆ∫≈
  delete st_sts_mtr_audit_balance where  balance_water_no=in_balance_water_no;
    --øÕ¡˜
  delete st_sts_change where balance_water_no=in_balance_water_no;
  delete st_sts_change_income where balance_water_no=in_balance_water_no;
  delete st_sts_flw_station where balance_water_no=in_balance_water_no;
  delete st_sts_flw_line_card where balance_water_no=in_balance_water_no;
  delete st_sts_flw_line_pass where balance_water_no=in_balance_water_no;
  delete st_sts_flw_average_distance where balance_water_no=in_balance_water_no;
  delete st_sts_flw_change where balance_water_no=in_balance_water_no;
  delete st_sts_od_card where balance_water_no=in_balance_water_no;
  delete st_sts_od_line where balance_water_no=in_balance_water_no;
  delete st_sts_od_card_zone where balance_water_no=in_balance_water_no;
  delete st_sts_realflow_section where balance_water_no=in_balance_water_no;
  -- ’“Ê
  delete st_sts_inc_sale where balance_water_no=in_balance_water_no;
  delete st_sts_inc_fare where balance_water_no=in_balance_water_no;
  delete st_sts_inc_update where balance_water_no=in_balance_water_no;
  delete st_sts_inc_return where balance_water_no=in_balance_water_no;
  delete st_sts_inc_consume where balance_water_no=in_balance_water_no;
  delete st_sts_inc_charge where balance_water_no=in_balance_water_no;
  delete st_sts_inc_station where balance_water_no=in_balance_water_no;
  delete st_sts_inc_balance_expired where balance_water_no=in_balance_water_no;
    --lcc∂‘’À
  delete acc_st_his.st_his_lcc where balance_water_no=in_balance_water_no;
  delete st_sts_acc where balance_water_no=in_balance_water_no;
  delete st_sts_lcc_acc where balance_water_no=in_balance_water_no;
    -- ÷ª˙÷ß∏∂∂‘’À by lindaquan in 20160615 v1.35
    --¿˙ ∑±Ì
  delete acc_st_his.st_mb_his_lock  where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_mb_his_deal  where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_mb_his_return where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_mb_his_sale where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_mb_his_lcc where balance_water_no=in_balance_water_no;
    --÷–º‰±Ì
  delete st_mb_sts_acc where balance_water_no=in_balance_water_no;
  delete st_mb_sts_collect_status where balance_water_no=in_balance_water_no;
  delete st_mb_sts_deal where balance_water_no=in_balance_water_no;
  delete st_mb_sts_except_balance where balance_water_no=in_balance_water_no;
  delete st_mb_sts_lcc where balance_water_no=in_balance_water_no;
  delete st_mb_sts_lcc_acc where balance_water_no=in_balance_water_no;
  delete st_mb_sts_lock where balance_water_no=in_balance_water_no;
  delete st_mb_sts_return where balance_water_no=in_balance_water_no;
  delete st_mb_sts_sale where balance_water_no=in_balance_water_no;
    -- ÷ª˙÷ß∏∂¥ÌŒÛ±Ì
  delete st_mb_err_deal where balance_water_no=in_balance_water_no;
  delete st_mb_err_lcc where balance_water_no=in_balance_water_no;
  delete st_mb_err_lock where balance_water_no=in_balance_water_no;
  delete st_mb_err_return where balance_water_no=in_balance_water_no;
  delete st_mb_err_sale where balance_water_no=in_balance_water_no;
    -- ÷ª˙÷ß∏∂œ˚∑—÷–º‰±Ì£®π´Ωª£©
  delete st_mb_ext_sts_deal_bus where balance_water_no=in_balance_water_no;
    -- ÷ª˙÷ß∏∂œ˚∑—÷–º‰±Ì£®πÏµ¿£©
  delete st_mb_ext_sts_deal_line where balance_water_no=in_balance_water_no;

    --ª•¡™Õ¯÷ß∏∂∂‘’À by lindaquan in 20161212 v1.38
    --¿˙ ∑±Ì
  delete acc_st_his.st_np_his_deal  where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_np_his_lcc  where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_np_his_order where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_np_his_order_imp where balance_water_no=in_balance_water_no;
  delete acc_st_his.st_np_his_sale where balance_water_no=in_balance_water_no;
    --÷–º‰±Ì
  delete acc_st.st_np_sts_acc where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_collect_status where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_deal where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_except_balance where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_lcc where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_lcc_acc where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_order where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_order_imp where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_sts_sale where balance_water_no=in_balance_water_no;
    --ª•¡™Õ¯÷ß∏∂¥ÌŒÛ±Ì
  delete acc_st.st_np_err_deal where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_err_lcc where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_err_order where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_err_order_imp where balance_water_no=in_balance_water_no;
  delete acc_st.st_np_err_sale where balance_water_no=in_balance_water_no;

    --…Ûº∆°¢“Ï≥£Õ≥º∆
  delete st_sts_collect_status where balance_water_no=in_balance_water_no;
  delete st_sts_except_balance where balance_water_no=in_balance_water_no;
    --”‡∂Ó∆Ω∫‚
    --sam∂œ∫≈÷ÿ∫≈∑÷Œˆ
  delete st_err_sam_water where balance_water_no=in_balance_water_no;
  delete st_list_sam_water where balance_water_no=in_balance_water_no;
    --ºƒ¥Ê∆˜ ˝æ›
  delete st_sts_reg_gate where balance_water_no=in_balance_water_no;
  delete st_sts_reg_tvm where balance_water_no=in_balance_water_no;
  delete st_sts_reg_bom where balance_water_no=in_balance_water_no;
    ---√˚µ•π‹¿Ì”Î«ÂÀ„∫Û–¯
  --delete op_prm_black_list_mtr where balance_water_no=in_balance_water_no;
  --Ω‚π“º«¬º≤Â»Î¥˝¥¶¿Ì±Ì
  delete acc_st.st_list_report_loss_pend where balance_water_no=in_balance_water_no;
  --π“ ßº«¬º
  delete acc_st.st_list_report_loss where balance_water_no=in_balance_water_no;
  --≤Â»Î≤πø®…Í«Î¥˝¥¶¿Ì±Ì
  insert into st_list_sign_card_pend
    (water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date,
    tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no, file_name, check_flag, card_main_id, card_sub_id, app_business_type)
  select water_no, line_id, station_id, dev_type_id, device_id, apply_name, apply_sex, identity_type, identity_id, expired_date,
    tel_no, fax, address, operator_id, apply_datetime, shift_id, card_app_flag, balance_water_no, file_name, check_flag, card_sub_id, card_main_id, app_business_type
  from st_list_sign_card where balance_water_no=in_balance_water_no and HDL_FLAG='0';
  delete acc_st.st_list_sign_card_pend where balance_water_no=in_balance_water_no;
  delete acc_st.st_list_sign_card where balance_water_no=in_balance_water_no and HDL_FLAG='0';
  --Ω´÷ÿ◊ˆæ…º«√˚ø®–≈œ¢∑≈µΩ…æ≥˝±Ì
  delete acc_st.st_list_sign_card_del where balance_water_no=in_balance_water_no;
  -- ≤Â»Îº«√˚ø®÷ÿ◊ˆº«¬º
  --delete acc_st.st_list_sign_card_remake where balance_water_no=in_balance_water_no;
  --∫⁄√˚µ•œ¬∑¢π´Ωª
  delete st_ext_mtr_blacklist where balance_water_no=in_balance_water_no;
  delete st_err_deal_unique  where balance_water_no=in_balance_water_no;
  delete st_err_entry_unique  where balance_water_no=in_balance_water_no;
  delete st_err_update_unique  where balance_water_no=in_balance_water_no;
  delete st_sts_inc_balance where balance_water_no=in_balance_water_no;
  --∑«º∞ ±ÕÀøÓΩª“◊º«¬º
  delete op_non_return_tk_hist where current_balance_water=in_balance_water_no;
  delete op_non_return_tk_trans_hist where current_balance_water=in_balance_water_no;

  --”–∏¸–¬µƒ±Ìªÿπˆ£®…æ≥˝µ±¥Œ«ÂÀ„◊ˆµƒƒ⁄»›£©
   --st_act_svt ªÿπˆΩª“◊ ˝æ›≤˙…˙µƒΩ·π˚
 v_msg := 'ªÿπˆst_act_svt';
  insert into t#st_rbk_deal_svt select * from st_sts_deal_svt where balance_water_no=in_balance_water_no;
  update st_act_svt a  set
    (total_charge_num,total_consume_num,total_charge_fee,total_consume_fee,system_balance_fee)
    =(select a.total_charge_num-b.charge_num,a.total_consume_num-b.consume_num,
    a.total_charge_fee-b.charge_fee,a.total_consume_fee-b.consume_fee,
    a.system_balance_fee-b.charge_fee+b.consume_fee
  from t#st_rbk_deal_svt b where a.card_logical_id=b.card_logical_id and rownum=1)
  where exists (select 1 from t#st_rbk_deal_svt b  where a.card_logical_id=b.card_logical_id);
  --v1.02‘ˆº”±»Ωœ◊Ó¥ÛΩª“◊ ±º‰ ,ªÿπˆø®”‡∂Óµ»
  select count(*) into v_count from st_act_svt a,t#st_rbk_deal_svt b
  where a.card_logical_id=b.card_logical_id and b.max_deal_time>=a.max_deal_time;
  if v_count>0 then
    delete   t#lock_card;
    insert into t#lock_card select a.card_logical_id from st_act_svt a,t#st_rbk_deal_svt b
    where a.card_logical_id=b.card_logical_id and b.max_deal_time>=a.max_deal_time;
    delete st_sts_deal_svt where balance_water_no=in_balance_water_no;
    delete t#st_svt_logic3 ;
    insert into  t#st_svt_logic3 select card_logical_id,max(max_deal_time)
    from st_sts_deal_svt
     where card_logical_id in (select card_logical_id from t#lock_card) group by card_logical_id ;
    insert into t#st_rbk_max_svt
    select c.card_logical_id,c.card_balance_fee,c.card_charge_seq,
           c.card_consume_seq,c.balance_water_no,c.card_status_id,c.max_deal_time
    from  t#st_svt_logic3 a,st_sts_deal_svt c
    where a.card_logical_id=c.card_logical_id and a.max_datetime=c.max_deal_time;
    update st_act_svt a set
     (card_balance_fee,card_charge_seq,card_consume_seq,balance_water_no,card_status_id,max_deal_time)
      =(select card_balance_fee,card_charge_seq,card_consume_seq,balance_water_no,card_status_id,max_deal_time
    from t#st_rbk_max_svt b
    where a.card_logical_id=b.card_logical_id and rownum=1 £©
    where exists (select 1 from t#st_rbk_max_svt b  where a.card_logical_id=b.card_logical_id);
  end if;
 --st_list_non_rtn ÷ªªÿπˆªπ√ª¥¶¿Ìµƒ∑«º¥ ±ÕÀøÓ…Í«Î
  v_msg := 'ªÿπˆst_list_non_rtn';
  delete st_list_non_rtn a where balance_water_no=in_balance_water_no and hdl_flag='2';
  --st_act_sam
  v_msg := 'ªÿπˆst_act_sam';
  /*
  delete st_act_sam where balance_water_no=in_balance_water_no;
  insert into st_act_sam(line_id ,station_id,dev_type_id,device_id,card_main_id,card_sub_id,
         sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no)
  select line_id ,station_id,dev_type_id,device_id,card_main_id,card_sub_id,
         sam_logical_id,sam_trade_seq_start,sam_trade_seq_end,total_deal_num,balance_water_no
  from st_act_sam_del where del_balance_no=in_balance_water_no;
  delete st_act_sam_del where del_balance_no=in_balance_water_no;
  */
  --op_prm_black_list_mtr ¥”∫⁄√˚µ•π˝∆⁄±Ì÷–’“ªÿ≤Â»ÎµΩ∫⁄√˚µ•±Ì
  v_msg := 'ªÿπˆop_prm_black_list_mtr';
  insert into op_prm_black_list_mtr
  (gen_datetime,card_logical_id,black_type,remark,action_type,create_datetime ,operator_id,is_set)
  select distinct gen_datetime ,card_logical_id,black_type,remark,action_type,create_datetime ,operator_id,is_set
  from  op_prm_black_old_mtr a WHERE  balance_water_no=in_balance_water_no
  and card_logical_id not in (select card_logical_id from op_prm_black_list_mtr b );
  delete op_prm_black_old_mtr where  balance_water_no=in_balance_water_no ;
  v_msg := '–ﬁ∏ƒ«ÂÀ„±ÌÕÍ≥…±Í÷æ';
  update st_sys_flow_current set error_code='00' , finish_flag='0',begin_time=null,end_time=null
   where to_number(step) between 30 and 69;
  /*
  --ªÿπˆ±∏∑›”–∏¸∏ƒµƒ±Ì£®∫ƒ ±±»Ωœ≥§£¨‘›∆¡±Œ£©
  --∫⁄√˚µ•±Ì
  delete op_his_black_list_mtr where balance_water_no=in_balance_water_no;
  --∫⁄√˚µ•∂Œ±Ì
  delete acc_st.op_his_black_list_mtr_sec where balance_water_no=in_balance_water_no;
  --¥¢÷µø®’Àªß±Ì
  delete acc_st_his.st_his_act_svt where balance_water_no=in_balance_water_no;
  --∑«º¥ ±ÕÀøÓΩ·π˚±Ìst_list_non_rtn
  delete acc_st_his.st_his_non_rtn where balance_water_no=in_balance_water_no;
  --samø®’Àªß±Ìst_act_sam
  delete acc_st_his.st_his_act_sam where balance_water_no=in_balance_water_no;
  commit;
  */

  commit;
   out_msg :='success';
   out_retresult:=0;
   exception
   when OTHERS THEN
   begin
      ROLLBACK;
      out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
      out_retresult := sqlcode;
      return;
   end;
end;
/

prompt
prompt Creating procedure UP_ST_RBK_SETTLE_PRE
prompt =======================================
prompt
create or replace procedure acc_st.up_st_rbk_settle_pre
(
piBalanceWaterNo in varchar2,
poRetCode out int,
poRetMsg  out varchar2
)
-----------------------------------------------
--π˝≥Ã√˚£∫  up_st_rbk_settle_pre
--π¶ƒ‹√Ë ˆ£∫«ÂÀ„‘§¥¶¿Ìªÿπˆ
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20140520
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140806
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº” ’“Ê°¢…Ûº∆°¢ºƒ¥Ê∆˜ª∫¥Ê±Ì°¢∂”¡–±Ì«Â¿Ì
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160613
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº” ÷ª˙÷ß∏∂ª∫¥Ê±Ì°¢∂”¡–±Ì°¢¥ÌŒÛ±Ì°¢≤‚ ‘±Ì«Â¿Ì
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160628
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”TVMΩ·’À ˝æ›°¢TVM÷Ω±“¥Ê»Î ˝æ›°¢TVM÷Ω±“»°≥ˆ ˝æ›°¢TVM÷Ω±“ªÿ ’œ‰ ˝æ›«Â¿Ì

-----------------------------------------------
is
begin
--≥ı ºªØ
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶';
--------------------------------------------------
 -------------------«ÂÀ„±Ì»’÷æ±Ì--------------------
 delete from  st_log_balance where balance_water_no=piBalanceWaterNo;
 delete from  st_list_balance_waiting where balance_water_no=piBalanceWaterNo;
 delete from  st_log_balnce_detail where balance_water_no=piBalanceWaterNo;
 -------------------«ÂÀ„±Ì»’÷æ±Ì£®Ω· ¯£©--------------------

 ------------------»’÷æ£®«ÂÀ„‘§¥¶¿Ì£©--------------------
--lccŒƒº˛£®Ω” ’£©
delete from st_log_ftp_put_file where balance_water_no=piBalanceWaterNo;
--octŒƒº˛£®Ω” ’£©
delete from st_log_ftp_put_file_OCT where balance_water_no=piBalanceWaterNo;
--lccŒƒº˛£®–£—ÈÕ®π˝£©
delete from st_log_file_passed where balance_water_no=piBalanceWaterNo;
--octŒƒº˛£®–£—ÈÕ®π˝£©
delete from st_log_file_passed_oct where balance_water_no=piBalanceWaterNo;
--lccŒƒº˛(–£—È“Ï≥££©
delete from st_err_data_file where balance_water_no=piBalanceWaterNo;
--octŒƒº˛(–£—È“Ï≥££©
delete from st_err_data_file_oct where balance_water_no=piBalanceWaterNo;
--lccŒƒº˛(–£—È∏Ò Ω“Ï≥££©
delete from st_err_data_field where balance_water_no=piBalanceWaterNo;
------------------»’÷æ£®«ÂÀ„‘§¥¶¿Ì£©£®Ω· ¯£©--------------------
------------------Õ‚≤øµÿÃ˙ø® ˝æ›-----------------------------------
 ---µÿÃ˙ø®Ω·À„ ˝æ›
 delete from st_ext_mtr_audit_balance where balance_water_no=piBalanceWaterNo;
 ---µÿÃ˙ø®¥ÌŒÛ ˝æ›
 delete from st_ext_mtr_err_trade where balance_water_no=piBalanceWaterNo;

 ---µÿÃ˙ø®Ωª“◊ ˝æ›
 --∂”¡–±Ì
 delete from st_ext_mtr_que_deal where balance_water_no=piBalanceWaterNo;
 --¿˙ ∑±Ì
 delete from acc_st_his.st_ext_mtr_his_deal where balance_water_no=piBalanceWaterNo;
 ---µÿÃ˙ø®…Ûº∆Œƒº˛£®Ωª“◊£©
 delete from st_ext_mtr_audit_file_trx where balance_water_no=piBalanceWaterNo;
 ---µÿÃ˙ø®…Ûº∆Œƒº˛£®Ω·À„£©
 delete from st_ext_mtr_audit_file_stl where balance_water_no=piBalanceWaterNo;

 ---µÿÃ˙ø®Ωª“◊Ω” ’◊¥Ã¨
 delete from st_ext_mtr_audit_status where balance_water_no=piBalanceWaterNo;

------------------Õ‚≤øµÿÃ˙ø® ˝æ›£®Ω· ¯£©-----------------------------------
------------------π´Ωªø® ˝æ›-----------------------------------
 ---π´Ωªø® ˝æ›Ω·À„ ˝æ›
 delete from st_ext_oct_audit_balance where balance_water_no=piBalanceWaterNo;
 ---π´Ωªø®¥ÌŒÛ ˝æ›
 delete from st_ext_oct_err_trade where balance_water_no=piBalanceWaterNo;

 ---π´Ωªø®Ωª“◊ ˝æ›
 --∂”¡–±Ì
 delete from st_que_deal_oct where balance_water_no=piBalanceWaterNo;
 --¿˙ ∑±Ì
-- delete from acc_st_his.st_his_deal_oct where balance_water_no=piBalanceWaterNo;
 ---π´Ωªø®…Ûº∆Œƒº˛£®Ωª“◊£©
 delete from st_ext_oct_audit_file_trx where balance_water_no=piBalanceWaterNo;
 ---π´Ωªø®…Ûº∆Œƒº˛£®Ω·À„£©
 delete from st_ext_oct_audit_file_stl where balance_water_no=piBalanceWaterNo;

 ---π´Ωªø®Ωª“◊Ω” ’◊¥Ã¨
 delete from st_ext_oct_audit_status where balance_water_no=piBalanceWaterNo;

------------------π´Ωªø® ˝æ›£®Ω· ¯£©-----------------------------------
------------------≤‚ ‘ø® ˝æ›-----------------------------------
--∑¢ €£®µ•≥Ã∆±£©
delete from st_tst_sale_sjt where balance_water_no=piBalanceWaterNo;
--∑¢ €
delete from st_tst_sale where balance_water_no=piBalanceWaterNo;
--º«√˚ø®…Í«Î
delete from st_tst_sign_card_apply where balance_water_no=piBalanceWaterNo;
--Ω¯’æ
delete from st_tst_entry where balance_water_no=piBalanceWaterNo;
--«Æ∞¸Ωª“◊
delete from st_tst_deal where balance_water_no=piBalanceWaterNo;
--∏¸–¬
delete from st_tst_update where balance_water_no=piBalanceWaterNo;
--ÕÀøÓ
delete from st_tst_return where balance_water_no=piBalanceWaterNo;
--∑«º¥ ±ÕÀøÓ…Í«Î
delete from st_tst_non_rtn_app where balance_water_no=piBalanceWaterNo;
--À¯ø®
delete from st_tst_lock where balance_water_no=piBalanceWaterNo;
--––’˛¥¶¿Ì
--delete from st_tst_admin where balance_water_no=piBalanceWaterNo;

------------------≤‚ ‘ø® ˝æ›£®Ω· ¯£©-----------------------------------
------------------∂”¡–±Ì ˝æ›-----------------------------------
--∑¢ €£®µ•≥Ã∆±£©
delete from st_que_sale_sjt where balance_water_no=piBalanceWaterNo;
--∑¢ €
delete from st_que_sale where balance_water_no=piBalanceWaterNo;
--º«√˚ø®…Í«Î
delete from st_que_sign_card_apply where balance_water_no=piBalanceWaterNo;
--Ω¯’æ
delete from st_que_entry where balance_water_no=piBalanceWaterNo;
--«Æ∞¸Ωª“◊
delete from st_que_deal where balance_water_no=piBalanceWaterNo;
--∏¸–¬
delete from st_que_update where balance_water_no=piBalanceWaterNo;
--ÕÀøÓ
delete from st_que_return where balance_water_no=piBalanceWaterNo;
--∑«º¥ ±ÕÀøÓ…Í«Î
delete from st_que_non_rtn_app where balance_water_no=piBalanceWaterNo;
--À¯ø®
delete from st_que_lock where balance_water_no=piBalanceWaterNo;
--––’˛¥¶¿Ì
delete from st_que_admin where balance_water_no=piBalanceWaterNo;

------------------∂”¡–±Ì ˝æ›£®Ω· ¯£©-----------------------------------
------------------ª∫¥Ê±Ì ˝æ›-----------------------------------
--∑¢ €£®µ•≥Ã∆±£©
delete from st_buf_sale_sjt where balance_water_no=piBalanceWaterNo;
--∑¢ €
delete from st_buf_sale where balance_water_no=piBalanceWaterNo;
--º«√˚ø®…Í«Î
delete from st_buf_sign_card_apply where balance_water_no=piBalanceWaterNo;
--Ω¯’æ
delete from st_buf_entry where balance_water_no=piBalanceWaterNo;
--«Æ∞¸Ωª“◊
delete from st_buf_deal where balance_water_no=piBalanceWaterNo;
--∏¸–¬
delete from st_buf_update where balance_water_no=piBalanceWaterNo;
--ÕÀøÓ
delete from st_buf_return where balance_water_no=piBalanceWaterNo;
--∑«º¥ ±ÕÀøÓ…Í«Î
delete from st_buf_non_rtn_app where balance_water_no=piBalanceWaterNo;
--À¯ø®
delete from st_buf_lock where balance_water_no=piBalanceWaterNo;
--––’˛¥¶¿Ì
delete from st_buf_admin where balance_water_no=piBalanceWaterNo;

------------------∂”¡–±Ì ˝æ›£®Ω· ¯£©-----------------------------------
------------------¥ÌŒÛ±Ì ˝æ›-----------------------------------
--∑¢ €£®µ•≥Ã∆±£©
delete from st_err_sale_sjt where balance_water_no=piBalanceWaterNo;
--∑¢ €
delete from st_err_sale where balance_water_no=piBalanceWaterNo;
--º«√˚ø®…Í«Î
delete from st_err_sign_card_apply where balance_water_no=piBalanceWaterNo;
--Ω¯’æ
delete from st_err_entry where balance_water_no=piBalanceWaterNo;
--«Æ∞¸Ωª“◊
delete from st_err_deal where balance_water_no=piBalanceWaterNo;
--∏¸–¬
delete from st_err_update where balance_water_no=piBalanceWaterNo;
--ÕÀøÓ
delete from st_err_return where balance_water_no=piBalanceWaterNo;
--∑«º¥ ±ÕÀøÓ…Í«Î
delete from st_err_non_rtn_app where balance_water_no=piBalanceWaterNo;
--À¯ø®
delete from st_err_lock where balance_water_no=piBalanceWaterNo;
--––’˛¥¶¿Ì
delete from st_err_admin where balance_water_no=piBalanceWaterNo;

------------------¥ÌŒÛ±Ì ˝æ›£®Ω· ¯£©-----------------------------------
-----------------*************** ’“Ê ˝æ›************--------------------------------------------
  --bom∞‡¥Œ ˝æ›÷˜ª∫¥Ê±Ì
delete from  st_buf_bom_shift_total where balance_water_no=piBalanceWaterNo ;
delete from  st_que_bom_shift_total where balance_water_no=piBalanceWaterNo;
delete from  st_err_bom_shift_total where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑¢ €£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_sale where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_sale where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_sale where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰÷µ£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_charge where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_charge where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_charge where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∏¸–¬£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_update where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_update where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_update where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®––’˛¥¶¿Ì£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_admin where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_admin where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_admin where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®—”∆⁄£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_delay where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_delay where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_delay where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_return where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_return where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_return where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_rtn_non where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_rtn_non where balance_water_no=piBalanceWaterNo;
  delete from  st_err_bom_shift_rtn_non where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®∑«º¥ ±ÕÀøÓ…Í«Î£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_rtn_app where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_rtn_app where balance_water_no=piBalanceWaterNo;

  delete from  st_err_bom_shift_rtn_app where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®≥‰’˝£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_chg_upd where balance_water_no=piBalanceWaterNo;
 delete from  st_que_bom_shift_chg_upd where balance_water_no=piBalanceWaterNo;

  delete from  st_err_bom_shift_chg_upd where balance_water_no=piBalanceWaterNo;
  --bom∞‡¥Œ ˝æ›√˜œ∏£®Ω‚À¯£©ª∫¥Ê±Ì
  delete from  st_buf_bom_shift_unlock where balance_water_no=piBalanceWaterNo;
  delete from  st_que_bom_shift_unlock where balance_water_no=piBalanceWaterNo;

  delete from  st_err_bom_shift_unlock where balance_water_no=piBalanceWaterNo;
  --tvm÷Ω±“œ‰ ˝æ›ª∫¥Ê±Ì
  delete from  st_buf_tvm_note_data where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_note_data where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_note_data where balance_water_no=piBalanceWaterNo;
  --tvm”≤±“œ‰ ˝æ›
  delete from  st_buf_tvm_coin_data where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_coin_data where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_coin_data where balance_water_no=piBalanceWaterNo;
  --tvm”≤±“œ‰¥Ê»Î ˝æ›
  delete from  st_buf_tvm_coin_put where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_coin_put where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_coin_put where balance_water_no=piBalanceWaterNo;
  --tvm”≤±“œ‰«Âø’ ˝æ›
  delete from  st_buf_tvm_coin_clear where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_coin_clear where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_coin_clear where balance_water_no=piBalanceWaterNo;
  --tvm∆±œ‰¥Ê»Î ˝æ›
  delete from  st_buf_tvm_card_put where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_card_put where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_card_put where balance_water_no=piBalanceWaterNo;
  --tvm∆±œ‰«Âø’ ˝æ›
  delete from  st_buf_tvm_card_clear where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_card_clear where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_card_clear where balance_water_no=piBalanceWaterNo;
  --tvm∑œ∆±œ‰ ˝æ›
  delete from  st_buf_tvm_waste_card_data where balance_water_no=piBalanceWaterNo;
  delete from  st_que_tvm_waste_card_data where balance_water_no=piBalanceWaterNo;

  delete from  st_err_tvm_waste_card_data where balance_water_no=piBalanceWaterNo;
  --agm∆±œ‰ ˝æ›
 delete from  st_buf_agm_card_data where balance_water_no=piBalanceWaterNo;
 delete from  st_que_agm_card_data where balance_water_no=piBalanceWaterNo;

 delete from  st_err_agm_card_data where balance_water_no=piBalanceWaterNo;

   --TVM◊‘∂ØΩ·¥Ê ˝æ›
 delete from  ST_BUF_TVM_AUTO_BAL where balance_water_no=piBalanceWaterNo;
 delete from  ST_QUE_TVM_AUTO_BAL where balance_water_no=piBalanceWaterNo;

 delete from  ST_ERR_TVM_AUTO_BAL where balance_water_no=piBalanceWaterNo;

   --TVMΩ·’À ˝æ›
 delete from  ST_BUF_TVM_BAL where balance_water_no=piBalanceWaterNo;
 delete from  ST_QUE_TVM_BAL where balance_water_no=piBalanceWaterNo;

 delete from  ST_ERR_TVM_BAL where balance_water_no=piBalanceWaterNo;
    --TVM÷Ω±“¥Ê»Î ˝æ›
 delete from  ST_BUF_TVM_NOTE_CHG_PUT where balance_water_no=piBalanceWaterNo;
 delete from  ST_QUE_TVM_NOTE_CHG_PUT where balance_water_no=piBalanceWaterNo;

 delete from  ST_ERR_TVM_NOTE_CHG_PUT where balance_water_no=piBalanceWaterNo;
  --TVM÷Ω±“»°≥ˆ ˝æ›
 delete from  ST_BUF_TVM_NOTE_CHG_POP where balance_water_no=piBalanceWaterNo;
 delete from  ST_QUE_TVM_NOTE_CHG_POP where balance_water_no=piBalanceWaterNo;

 delete from  ST_ERR_TVM_NOTE_CHG_POP where balance_water_no=piBalanceWaterNo;
   --TVM÷Ω±“ªÿ ’œ‰ ˝æ›
 delete from  ST_BUF_TVM_NOTE_RECLAIM where balance_water_no=piBalanceWaterNo;
 delete from  ST_QUE_TVM_NOTE_RECLAIM where balance_water_no=piBalanceWaterNo;

 delete from  ST_ERR_TVM_NOTE_RECLAIM where balance_water_no=piBalanceWaterNo;


 -----------------*************** ’“Ê ˝æ›************--------------------------------------------

  ----------------**************ºƒ¥Ê∆˜ ˝æ›*********--------------------------------------------
  --ºƒ¥Ê∆˜ ˝æ›
 delete from   st_buf_reg_total where balance_water_no=piBalanceWaterNo;
 delete from   st_buf_reg_dtl where balance_water_no=piBalanceWaterNo;
--∂”¡–±Ì
delete from  st_que_reg_total where balance_water_no=piBalanceWaterNo;
delete from   st_que_reg_dtl where balance_water_no=piBalanceWaterNo;
--¥ÌŒÛ±Ì
delete from  st_err_reg_total where balance_water_no=piBalanceWaterNo;
delete from  st_err_reg_dtl where balance_water_no=piBalanceWaterNo;
 ----------------**************Ω· ¯ºƒ¥Ê∆˜ ˝æ›*********--------------------------------------------
---------------- **************…Ûº∆ ˝æ›**************-----------------------
--------------agm…Ûº∆ ˝æ›
delete from   st_buf_agm_cutoff_total where balance_water_no=piBalanceWaterNo;
delete from   st_buf_agm_cutoff_dtl where balance_water_no=piBalanceWaterNo;
--∂”¡–±Ì
delete from   st_que_agm_cutoff_total where balance_water_no=piBalanceWaterNo;
delete from   st_que_agm_cutoff_dtl where balance_water_no=piBalanceWaterNo;
--¥ÌŒÛ±Ì
delete from   st_err_agm_cutoff_total where balance_water_no=piBalanceWaterNo;
delete from   st_err_agm_cutoff_dtl where balance_water_no=piBalanceWaterNo;

--¿˙ ∑±Ì
-----------------------tvm…Ûº∆ ˝æ›
delete from   st_buf_tvm_cutoff_total where balance_water_no=piBalanceWaterNo;
delete from   st_buf_tvm_cutoff_dtl where balance_water_no=piBalanceWaterNo;
--∂”¡–±Ì
delete from   st_que_tvm_cutoff_total where balance_water_no=piBalanceWaterNo;
delete from   st_que_tvm_cutoff_dtl where balance_water_no=piBalanceWaterNo;
--¥ÌŒÛ±Ì
delete from   st_err_tvm_cutoff_total where balance_water_no=piBalanceWaterNo;
delete from   st_err_tvm_cutoff_dtl where balance_water_no=piBalanceWaterNo;

-------------------------lcc ˝æ›
delete from   st_buf_lcc where balance_water_no=piBalanceWaterNo;
delete from   st_que_lcc where balance_water_no=piBalanceWaterNo;
delete from   st_err_lcc where balance_water_no=piBalanceWaterNo;
---------------- **************Ω· ¯…Ûº∆ ˝æ›**************-----------------------
-------------- ÷ª˙÷ß∏∂ ˝æ›20160614
--ª∫¥Ê±Ì
----«Æ∞¸Ωª“◊
delete from   st_mb_buf_deal where balance_water_no=piBalanceWaterNo;
----ÕÀøÓΩª“◊
delete from   st_mb_buf_return where balance_water_no=piBalanceWaterNo;
----À¯ø®Ωª“◊
delete from   st_mb_buf_lock where balance_water_no=piBalanceWaterNo;
----∑¢ €Ωª“◊
delete from   st_mb_buf_sale where balance_water_no=piBalanceWaterNo;
--∂”¡–±Ì
delete from   st_mb_que_deal where balance_water_no=piBalanceWaterNo;
----ÕÀøÓΩª“◊
delete from   st_mb_que_return where balance_water_no=piBalanceWaterNo;
----À¯ø®Ωª“◊
delete from   st_mb_que_lock where balance_water_no=piBalanceWaterNo;
----∑¢ €Ωª“◊
delete from   st_mb_que_sale where balance_water_no=piBalanceWaterNo;
--¥ÌŒÛ±Ì
delete from   st_mb_err_deal where balance_water_no=piBalanceWaterNo;
----ÕÀøÓΩª“◊
delete from   st_mb_err_return where balance_water_no=piBalanceWaterNo;
----À¯ø®Ωª“◊
delete from   st_mb_err_lock where balance_water_no=piBalanceWaterNo;
----∑¢ €Ωª“◊
delete from   st_mb_err_sale where balance_water_no=piBalanceWaterNo;
--≤‚ ‘±Ì
delete from   st_mb_tst_deal where balance_water_no=piBalanceWaterNo;
----ÕÀøÓΩª“◊
delete from   st_mb_tst_return where balance_water_no=piBalanceWaterNo;
----À¯ø®Ωª“◊
delete from   st_mb_tst_lock where balance_water_no=piBalanceWaterNo;
----∑¢ €Ωª“◊
delete from   st_mb_tst_sale where balance_water_no=piBalanceWaterNo;
---------------- ************** ÷ª˙÷ß∏∂ ˝æ›**************-----------------------

commit;
exception
   when others then
   begin
     poRetCode :=-1;
     poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
     rollback;
   end;

end;
/

prompt
prompt Creating procedure UP_ST_SYS_GET_BAL_WATER
prompt ==========================================
prompt
create or replace procedure acc_st.up_st_sys_get_bal_water
(piOpId  in varchar2,
 poRetCode out int,
 poRetMsg out varchar2,
 poBalanceWateNo  out varchar2)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_sys_get_bal_water
--π¶ƒ‹√Ë ˆ£∫ªÒ»°«ÂÀ„¡˜ÀÆ∫≈
--≤Œ ˝£∫piOpId£∫≤Ÿ◊˜‘±¥˙¬Î poRetCode£∫0£∫≥…π¶…˙≥…¡˜ÀÆ -1£∫≤ª–Ë…˙≥…¡˜ÀÆ poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--      poBalanceWateNo:∑µªÿ«ÂÀ„¡˜ÀÆ∫≈
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130518
--–ﬁ∏ƒ’ﬂ:  hejj 
--–ﬁ∏ƒ»’∆⁄: 20140520
--–ﬁ∏ƒ’ﬂ: ‘ˆº”»Àπ§«ÂÀ„¡˜ÀÆ∫≈ªÒ»°π¶ƒ‹
-------------------------------------------------------------------------------
is
hmSquadDay varchar(4);--‘À”™»’µƒΩ· ¯ ±º‰µ„
hmCur      varchar(4);--µ±«∞µƒ ±º‰µ„
balWaterNo varchar(10);--«ÂÀ„¡˜ÀÆ∫≈
rowCount   int;
rowCountUnfinish   int;
---»Àπ§«ÂÀ„
manuFlag varchar(1);--»Àπ§«ÂÀ„±Í ∂
begin
--≥ı ºªØ÷µ
  poRetCode :=0;
  poRetMsg :='≤Ÿ◊˜≥…π¶';
  poBalanceWateNo :='-1';
  
--‘À”™»’ 
  select cfg_value into hmSquadDay from ST_CFG_SYS_BASE  where cfg_key='sys.squadday';
  hmCur :=to_char(sysdate,'hh24mi');
  
  dbms_output.put_line('hmSquadDay='||hmSquadDay||'hmCur='||hmCur);
  
---»Àπ§«ÂÀ„
--»Àπ§«ÂÀ„±Í ∂
  select cfg_value into manuFlag from ST_CFG_SYS_BASE  where cfg_key='sys.flow.control.manu';
  if manuFlag is null or manuFlag = '' then
     manuFlag := '0';
  end if;
----------------------------------------------------------------------------------- 
---≈–∂œ «∑Ò–Ë“™ªÒ»°«ÂÀ„¡˜ÀÆ∫≈
  select count(*) into rowCount from st_sys_flow_current ;
  select count(*) into rowCountUnfinish from st_sys_flow_current where finish_flag  ='0';
  if(rowCount !=0 and rowCountUnfinish !=0 ) then
     poRetCode :=0;
     poRetMsg :='¥Ê‘⁄Œ¥ÕÍ≥…≤Ω÷Ë£¨Œﬁ–Ë÷ÿ–¬…˙≥…¡˜ÀÆ∫≈';
	 select distinct balance_water_no into poBalanceWateNo from st_sys_flow_current;
     return;
  end if;
---------------------------------------------------------------------------------- 
  --»°µ√«ÂÀ„¡˜ÀÆ∫≈
  if(hmCur >= hmSquadDay ) then
      balWaterNo :=to_char(sysdate,'yyyymmdd')||'01'; 
  else
      balWaterNo :=to_char(sysdate-1,'yyyymmdd')||'01';  
  end if;
  
  ------------------¥¶¿Ì»Àπ§«ÂÀ„-------------------------
  if manuFlag = '1' then
     select min(balance_water_no) into balWaterNo from st_sys_flow_manu
                                             where finish_flag='0';
  end if;
  -------------------------------------------------------
  --¡˜ÀÆ±Ìº«¬º≤ª¥Ê‘⁄
  if(rowCount =0) then
     insert into st_sys_flow_current(balance_water_no,step,step_pre,finish_flag,begin_time,operator_id,remark)
	                             select balWaterNo,step,step_pre,'0',sysdate,piOpId,step_name
								        from st_cod_steps;
  else--¡˜ÀÆ±Ìº«¬º¥Ê‘⁄
     --µº¿˙ ∑
     insert into st_sys_flow_his(balance_water_no,step,step_pre,finish_flag,error_code,begin_time,end_time,operator_id,remark)
	                      select balance_water_no,step,step_pre,finish_flag,error_code,begin_time,end_time,operator_id,remark
						  from st_sys_flow_current;
	 --∏¸–¬Œ™–¬µƒ¡˜ÀÆ∫≈
     update st_sys_flow_current set balance_water_no=balWaterNo,finish_flag='0',begin_time=sysdate,end_time=null,operator_id=piOpId;
  
  end if;
  
  dbms_output.put_line('balWaterNo='||balWaterNo);
  
  poBalanceWateNo :=balWaterNo;
  /*
  --∑µªÿΩ·π˚ºØ
  open poRs for
      select balWaterNo "bal_water_no" from dual;
	  --select balance_water_no from st_sys_balance_water;
*/	  
 commit;
--“Ï≥£¥¶¿Ì	  
  exception
     when others then
	 begin
	    poRetCode :=-1;
		poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
	 end;
	 
  
  
  --select * from ST_CFG_SYS_BASE ;
 
end;
/
grant execute on ACC_ST.UP_ST_SYS_GET_BAL_WATER to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TMP_SVT
prompt ================================
prompt
create or replace procedure acc_st.up_st_tmp_svt(
 out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2 --∑µªÿ–≈œ¢
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_tmp_begin_svt
--π¶ƒ‹√Ë ˆ£∫“ª¥Œ–‘ÀÊ∞Ê±æVer1.10∏¸–¬¥¶¿Ì:∏˘æ›¿˙ ∑ ˝æ›»´≤ø÷ÿ–¬º∆À„¥¢÷µø®”‡∂Ó°¢Ωª“◊¥Œ ˝°¢Ω∂Óµ»
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ 
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú2014624
-------------------------------------------------------------------------------
as
  v_msg varchar(50);
   v_count int;
   v_balance_water_no varchar(10);
   v_begin_time date;
   v_mod_name char(50);
begin

--»°±æ¥Œ«ÂÀ„¡˜ÀÆ∫≈
  v_mod_name:='up_st_ist_settle_svt';

--¥¢÷µø®’ÀªßΩ®¡¢
 

--’Àªß±Ì¿€º∆ ˝æ›
 
   select max(balance_water_no) into v_balance_water_no from st_sys_flow_current;
 
   select  sysdate into v_begin_time from dual;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_svt_card≥‰÷µ'; 
   insert  into t#st_ist_settle_svt_card
   select v_balance_water_no,card_main_id,card_sub_id,card_logical_id,card_physical_id,
      count(*),0,sum(deal_fee),0,null
   from st_his_deal 
   where card_main_id='02' and card_sub_id!='03'  and pay_mode_id ='14'
   group by card_main_id,card_sub_id,card_logical_id,card_physical_id
         ,card_charge_seq ,card_consume_seq;
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,6,v_msg);
   
    select  sysdate into v_begin_time from dual;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_svt_card≥Â’˝';
   insert into t#st_ist_settle_svt_card
   select v_balance_water_no,card_main_id,card_sub_id,card_logical_id,card_physical_id,
      count(*)*-1,0,sum(deal_fee)*(-1),0,null
  from st_his_deal 
   where card_main_id='02' and card_sub_id!='03'and  pay_mode_id ='18'
   group by card_main_id,card_sub_id,card_logical_id,card_physical_id
   ,card_charge_seq ,card_consume_seq;
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,7,v_msg);
   
    select  sysdate into v_begin_time from dual;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_svt_cardœ˚∑—';
   insert into t#st_ist_settle_svt_card
   select v_balance_water_no,card_main_id,card_sub_id,card_logical_id,card_physical_id,
      0, count(*),0,sum(deal_fee),null  from st_his_deal
     where card_main_id='02' and card_sub_id!='03' and pay_mode_id in ('12','1C','1A')
   group by card_main_id,card_sub_id,card_logical_id,card_physical_id;
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,8,v_msg);

   select  sysdate into v_begin_time from dual;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_svt_card‘⁄π´Ωªœ˚∑—'; --2014-6-23‘ˆº”‘⁄π´ΩªµƒΩª“◊
   insert  into t#st_ist_settle_svt_card
   select v_balance_water_no,card_main_id,card_sub_id,card_logical_id,card_physical_id,
      0, count(*),0,sum(deal_fee),null
     from acc_st_his.st_ext_mtr_his_deal
     where card_main_id='02' and card_sub_id!='03' 
   group by card_main_id,card_sub_id,card_logical_id,card_physical_id;
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,9,v_msg);


    select  sysdate into v_begin_time from dual;
   v_msg := '≤Â»Î±Ìt#st_ist_settle_svt_result';
   insert into t#st_ist_settle_svt_result 
   select v_balance_water_no,card_main_id,card_sub_id,card_logical_id,'00000000000000',
      sum(charge_num), sum(consume_num),sum(charge_fee), sum(consume_fee) ,0,0,0,null,null
   from t#st_ist_settle_svt_card
   group by card_main_id,card_sub_id,card_logical_id;
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,10,v_msg);
   

      select  sysdate into v_begin_time from dual;
    v_msg := '∏¸–¬±Ìst_act_svt¿€º∆±æ¥ŒΩª“◊';
    update st_act_svt a set
    (total_charge_num,total_consume_num,total_charge_fee,total_consume_fee,system_balance_fee)
    =(select b.charge_num,b.consume_num,b.charge_fee,b.consume_fee,b.charge_fee-b.consume_fee
    from t#st_ist_settle_svt_result b  where a.card_logical_id=b.card_logical_id and rownum=1)
    where exists (select 1 from t#st_ist_settle_svt_result b  where a.card_logical_id=b.card_logical_id);
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,11,v_msg);
 
  
    select  sysdate into v_begin_time from dual;
    v_msg := '≤Â»Î±Ìst_act_svt';--Œﬁ’Àªß
    insert into   st_act_svt
    select card_main_id,card_sub_id,card_logical_id,card_physical_id,
    charge_num,consume_num,charge_fee,consume_fee,charge_fee-consume_fee,0,null,null,
    card_charge_seq ,card_consume_seq,v_balance_water_no,card_status_id,0,0,max_deal_time
    from t#st_ist_settle_svt_result 
    where card_logical_id not in (select card_logical_id from st_act_svt);
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,12,v_msg);


 
---…˙≥…√ø’≈ø®◊Ó∫Û“ªÃıΩª“◊º«¬º£¨∏¸∏ƒ’Àªß±Ì◊Ó–¬º«¬º
   select  sysdate into v_begin_time from dual;
   v_msg := '≤Â»Î±Ìt#st_svt_logic3√ø’≈ø®◊Ó¥ÛΩª“◊ ±º‰';
   delete t#st_svt_logic3 ;
   insert into  t#st_svt_logic3  
   select card_logical_id,max(max_deal_time)
   from (select card_logical_id,max(deal_datetime) as max_deal_time from st_his_deal 
              where card_main_id='02' and card_sub_id<>'03' group by card_logical_id
        union 
        select card_logical_id,max(deal_datetime) as max_deal_time from acc_st_his.st_ext_mtr_his_deal
              where card_main_id='02' and card_sub_id<>'03'  group by card_logical_id)
   group by card_logical_id ;
   insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,14,v_msg);

   select  sysdate into v_begin_time from dual;
    v_msg := '≤Â»Î±Ìt#st_svt_logic4◊Ó–¬º«¬º «µÿÃ˙œ˚∑—µƒ';
   insert into t#st_svt_logic4  --ver1.02 ‘ˆº”◊Ó¥ÛΩª“◊ ±º‰
   select  b.card_logical_id,b.deal_balance_fee,b.card_charge_seq ,
           b.card_consume_seq,b.card_status_id,a.max_datetime
   from t#st_svt_logic3 a,st_his_deal b
   where a.card_logical_id=b.card_logical_id and a.max_datetime=b.deal_datetime;

    v_msg := '≤Â»Î±Ìt#st_svt_logic4◊Ó–¬º«¬º «π´Ωªœ˚∑—µƒ';
   insert into t#st_svt_logic4  --ver1.02 ‘ˆº”◊Ó¥ÛΩª“◊ ±º‰
   select  b.card_logical_id,b.deal_balance_fee,b.card_charge_seq ,
           b.card_consume_seq,b.card_status_id,a.max_datetime
   from t#st_svt_logic3 a,acc_st_his.st_ext_mtr_his_deal b
   where a.card_logical_id=b.card_logical_id and a.max_datetime=b.deal_datetime;


   select count(*) into v_count from t#st_svt_logic4 ;v_msg:=v_msg||to_char(v_count);
  insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,15,v_msg);

   select count(*) into v_count from t#st_svt_logic4 a, t#st_svt_logic4 b --≈–∂œ «∑Ò¥Ê‘⁄œ‡Õ¨ ±º‰µƒ ˝æ›
      where a.card_logical_id=b.card_logical_id and  a.card_consume_seq!=b.card_consume_seq ;
   if v_count>0 then      
      select  sysdate into v_begin_time from dual;
      v_msg := '…æ≥˝±Ìt#st_svt_logic4œ‡Õ¨ ±º‰º«¬º÷–∑«◊Ó–¬µƒ'; 
      delete from  t#st_svt_logic4  a where card_consume_seq
      not in (select max(card_consume_seq) from t#st_svt_logic4 b 
          where a.card_logical_id=b.card_logical_id group by card_logical_id);
    select count(*) into v_count from t#st_svt_logic4 ;v_msg:=v_msg||to_char(v_count);
     insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,16,v_msg);
   end if;      


    v_msg := '∏¸–¬±Ìst_act_svtø®”‡∂Óµ»';--“—”–’Àªß
    update st_act_svt a set
     (card_balance_fee,card_charge_seq,card_consume_seq,card_status_id,max_deal_time)
    =(select deal_balance_fee,b.card_charge_seq,b.card_consume_seq,b.card_status_id,b.max_deal_time
     from t#st_svt_logic4 b 
     where a.card_logical_id=b.card_logical_id and rownum=1)
    where exists (select 1 from t#st_svt_logic4 b  where a.card_logical_id=b.card_logical_id  );
  
  
  update st_act_svt set deposit_fee=17 where   deposit_fee=0;
  ---------…˙≥…¥¢÷µø®–£—È“Ï≥£Õ≥º∆±Ìst_card_check_result
  
    delete st_card_check_result;
    select  sysdate into v_begin_time from dual;
    v_msg := '≤Â»Î±Ìst_card_check_result';
    insert into st_card_check_result (card_main_id ,card_sub_id,card_logical_id ,card_physical_id,total_charge_num ,
       total_consume_num ,total_charge_fee,total_consume_fee,card_charge_seq ,card_consume_seq ,
       system_balance_fee ,card_balance_fee,diff_card_sys_fee ,diff_card_sys_num,balance_water_no,card_money)
    select card_main_id ,card_sub_id,card_logical_id ,card_physical_id,total_charge_num ,total_consume_num,
        total_charge_fee,total_consume_fee,card_charge_seq ,card_consume_seq ,system_balance_fee ,
        card_balance_fee,card_balance_fee-system_balance_fee-card_money,
        (card_charge_seq+card_consume_seq-total_charge_num-total_consume_num),v_balance_water_no,card_money
     from st_act_svt  where card_balance_fee-system_balance_fee-card_money>0;
    insert into st_log_balnce_detail values(v_balance_water_no,v_mod_name,v_begin_time,sysdate,18,v_msg);

  
  
  
   commit;
   out_msg :='success';
   out_retresult:=0;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_TMP_SVT to ACC_ST_DEV;


prompt
prompt Creating procedure UP_ST_TMP_UPDATE
prompt ===================================
prompt
create or replace procedure acc_st.up_st_tmp_update(
 out_retresult out integer, --∑µªÿΩ·π˚
   out_msg out varchar2, --∑µªÿ–≈œ¢
  begin_water_no in varchar2,
  end_water_no in varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_tmp_update
--π¶ƒ‹√Ë ˆ£∫“ª¥Œ–‘ÀÊ∞Ê±æVer1.10∏¸–¬¥¶¿Ì£∫∑«œ÷Ω∏¸–¬»´≤ø∏ƒŒ™¥”deal±Ì»°
-- ‰≥ˆ≤Œ ˝  £∫out_retresult ƒ£øÈ∑µªÿ÷µ out_msg ∑µªÿ–≈œ¢ 
--∑µªÿ÷µ    £∫0£∫≤Ÿ◊˜≥…π¶£ª∆‰À˚£∫≤Ÿ◊˜ ß∞‹£ª
--¥¥Ω®’ﬂ£∫  ¿Ó¿Ú2014624
-------------------------------------------------------------------------------
as
  v_msg varchar(50);
 v_balance_water_no char(10);


begin

 
   v_balance_water_no:=begin_water_no;
   WHILE v_balance_water_no<=end_water_no LOOP 
       v_msg :='ø™ º¡Ÿ ±«ÂÀ„:¡˜ÀÆ∫≈: ' ||v_balance_water_no;
       insert into st_log_balance values(seq_st_log_balance.nextval,v_balance_water_no,'up_st_tmp_update','0',
                  v_msg,'',sysdate) ; 
                  
    --ƒ⁄≤ø«ÂÀ„
        delete st_list_balance_trx;
        delete st_list_balance_contc;
        delete st_list_balance_line;
        delete st_sts_income_contc_card where balance_water_no=v_balance_water_no;
        delete st_sts_dispart_contc where  balance_water_no=v_balance_water_no;
        delete st_sts_dispart_line where  balance_water_no=v_balance_water_no;
        delete st_sts_balance_contc_trd where  balance_water_no=v_balance_water_no;
        delete st_sts_balance_line_trd where  balance_water_no=v_balance_water_no;
        delete st_sts_balance_contc_inc where  balance_water_no=v_balance_water_no;
        delete st_sts_balance_line_inc where  balance_water_no=v_balance_water_no;

    -- ’“Ê
      delete st_sts_inc_update where  balance_water_no=v_balance_water_no;
      delete st_sts_inc_consume where  balance_water_no=v_balance_water_no;
      delete st_sts_inc_charge where  balance_water_no=v_balance_water_no;
      delete st_sts_inc_station where  balance_water_no=v_balance_water_no;
                  
         v_msg:='data_queue1';
        up_st_ist_settle_data_queue1(out_retresult,out_msg,v_balance_water_no)  ;
        if out_retresult<>0 then
           out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
           insert into st_log_balance  values(seq_st_log_balance.nextval,v_balance_water_no,'','1',out_msg,'',sysdate);
           commit;
          return;
        end if;
        v_msg:='data_mid';
        up_st_ist_settle_data_mid(out_retresult,out_msg)  ;
        if out_retresult<>0 then
           out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
           insert into st_log_balance  values(seq_st_log_balance.nextval,v_balance_water_no,'','1',out_msg,'',sysdate);
           commit;
          return;
        end if;
        v_msg:='data_max';
        up_st_ist_settle_data_max(out_retresult,out_msg)  ;
        if out_retresult<>0 then
           out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
           insert into st_log_balance  values(seq_st_log_balance.nextval,v_balance_water_no,'','1',out_msg,'',sysdate);
           commit;
          return;
        end if;
        v_msg:='data1';
        up_st_ist_settle_data1(out_retresult,out_msg,v_balance_water_no)  ;
        if out_retresult<>0 then
           out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
           insert into st_log_balance  values(seq_st_log_balance.nextval,v_balance_water_no,'','1',out_msg,'',sysdate);
           commit;
          return;
        end if;
        v_msg:='income1';
        up_st_ist_settle_income1(out_retresult,out_msg,v_balance_water_no)  ;
        if out_retresult<>0 then
           out_msg := v_msg||'≥ˆ¥Ì:'||out_msg;
           insert into st_log_balance  values(seq_st_log_balance.nextval,v_balance_water_no,'','1',out_msg,'',sysdate);
           commit;
          return;
        end if;
      v_balance_water_no:=to_char(to_date(substr(v_balance_water_no,1,8),'yyyymmdd')+1,'yyyymmdd')||'01'; 
      delete st_list_balance_trx;
      delete st_list_balance_contc;
      delete st_list_balance_line;
   end loop;
   commit;
    exception
    when others then
     begin
       rollback;
       out_msg:=v_msg||'¥ÌŒÛ£∫'|| sqlerrm ||',∑¢…˙‘⁄µ⁄['||dbms_utility.format_error_backtrace()||']––';
       out_retresult := sqlcode;
       return;
     end;
end ;
/
grant execute on ACC_ST.UP_ST_TMP_UPDATE to ACC_ST_DEV;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_ADMIN
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_admin
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_admin
--π¶ƒ‹√Ë ˆ£∫–£—È––’˛¥¶¿Ìª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130810
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ 
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
-------------------------------------------------------------------------------
is
rowCount int;
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='61';
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_ADMIN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_ADMIN 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢¥¶¿Ì ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_ADMIN
						   );
--µ±«∞¿˙ ∑±Ì≤È÷ÿ
--ACC_ST_HIS.
insert into T#ST_BUF_ADMIN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_ADMIN 
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢¥¶¿Ì ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_HIS_ADMIN
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from st_buf_admin
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           admin_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into T#ST_BUF_ADMIN_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_ADMIN 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          admin_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_ADMIN_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.admin_datetime >= b.begin_date and 
                                                                   a.admin_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.admin_datetime >= b.begin_date and 
                                                                   a.admin_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_ADMIN_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_ADMIN_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_ADMIN
         
         execute immediate
         'insert into T#ST_BUF_ADMIN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					
					FROM T#ST_BUF_ADMIN_CHK
                    WHERE TABLE_NAME= :x AND
                          LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
				  SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
                           
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------                       
                           
                           
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_ADMIN;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_ADMIN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_ADMIN;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_ADMIN
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢¥¶¿Ì ±º‰
					       LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(ADMIN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_ADMIN
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_ADMIN( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select     DISTINCT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,ADMIN_DATETIME,ADMIN_WAY_ID,CARD_MAIN_ID,
							 CARD_SUB_ID,RETURN_FEE,PENALTY_FEE,ADMIN_REASON_ID,DESCRIBE,PASSENGER_NAME,OPERATOR_ID,SHIFT_ID,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_ADMIN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_ADMIN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_ADMIN to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_AGM_CDDATA
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_agm_cddata
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_agm_cddata
--π¶ƒ‹√Ë ˆ£∫–£—ÈAGM∆±œ‰ ˝æ›ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_AGM_CARD_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,
							 BOX_ID,WATER_NO_OP,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,
							 BOX_ID,WATER_NO_OP,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
					FROM ST_BUF_AGM_CARD_DATA 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                          
						   FROM ST_QUE_AGM_CARD_DATA
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_AGM_CARD_DATA;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_AGM_CARD_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,
							 BOX_ID,WATER_NO_OP,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,
							 BOX_ID,WATER_NO_OP,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_AGM_CARD_DATA;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_AGM_CARD_DATA
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢»°≥ˆ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                              IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                                  
						   FROM T#ST_BUF_AGM_CARD_DATA
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_AGM_CARD_DATA( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,
							 BOX_ID,WATER_NO_OP,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,
							 BOX_ID,WATER_NO_OP,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_AGM_CARD_DATA
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_AGM_CARD_DATA where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_AGM_CDDATA to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_AGM_CUTOFF
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_agm_cutoff
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_agm_cutoff
--π¶ƒ‹√Ë ˆ£∫–£—ÈAGM…Ûº∆ ˝æ›ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_AGM_CUTOFF_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,BOX_POP_NUM,
							 TOTAL_NUM,TOTAL_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,BOX_POP_NUM,
							 TOTAL_NUM,TOTAL_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_AGM_CUTOFF_TOTAL 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢µ±«∞ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						     IN
						  (
					       SELECT   LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						   
						   FROM ST_QUE_AGM_CUTOFF_TOTAL
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_AGM_CUTOFF_TOTAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_AGM_CUTOFF_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,BOX_POP_NUM,
							 TOTAL_NUM,TOTAL_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,BOX_POP_NUM,
							 TOTAL_NUM,TOTAL_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_AGM_CUTOFF_TOTAL;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_AGM_CUTOFF_TOTAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					     ----–£—È÷˜–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢µ±«∞ ±º‰
					        LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						     IN
						  (
					       SELECT 
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						    
						   FROM T#ST_BUF_AGM_CUTOFF_TOTAL
						   );
	-------------------------------------------◊”º«¬º----------------------------------------------------------------					   
	 --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
  
        INSERT INTO ST_ERR_AGM_CUTOFF_DTL(WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
                                    BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
							        BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_AGM_CUTOFF_DTL
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND WATER_NO IN
							       (SELECT WATER_NO FROM T#ST_BUF_AGM_CUTOFF_TOTAL);
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_AGM_CUTOFF_DTL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND WATER_NO IN
							       (SELECT WATER_NO FROM T#ST_BUF_AGM_CUTOFF_TOTAL);
	---------------------------------------------------------------------------------------------------------------------
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_AGM_CUTOFF_TOTAL( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,BOX_POP_NUM,
							 TOTAL_NUM,TOTAL_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,BOX_POP_NUM,
							 TOTAL_NUM,TOTAL_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_AGM_CUTOFF_TOTAL
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_AGM_CUTOFF_TOTAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  --µº»Î◊”∂”¡–±Ì
  
  INSERT INTO ST_QUE_AGM_CUTOFF_DTL(WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
                                    BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
							        BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_AGM_CUTOFF_DTL
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_AGM_CUTOFF_DTL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
-------------------------------------------------------------------------------------------------------------------------  
 
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_AGM_CUTOFF to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_BOM_SHIFT
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_bom_shift
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_bom_shift
--π¶ƒ‹√Ë ˆ£∫–£—ÈBOM∞‡¥Œª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_BOM_SHIFT_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,SHIFT_ID,START_TIME,END_TIME,
							 SALE_TOTAL_NUM,SALE_TOTAL_FEE,CHARGE_TOTAL_NUM,CHARGE_TOTAL_FEE,UPDATE_TOTAL_NUM,UPDATE_TOTAL_FEE,
							 UPDATE_TOTAL_FEE_CASH,ADMIN_TOTAL_NUM,ADMIN_TOTAL_FEE_RETURN,ADMIN_TOTAL_FEE_INCOME,DELAY_TOTAL_NUM,
							 RETURN_TOTAL_NUM,RETURN_TOTAL_FEE,RETURN_NON_TOTAL_NUM,RETURN_NON_TOTAL_FEE,RETURN_NON_APP_TOTAL_NUM,
							 CHARGE_UPDATE_TOTAL_NUM,CHARGE_UPDATE_TOTAL_FEE,UNLOCK_TOTAL_NUM,TOTAL_FEE_NOCASH,TOTAL_FEE_CASH,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,SHIFT_ID,START_TIME,END_TIME,
							 SALE_TOTAL_NUM,SALE_TOTAL_FEE,CHARGE_TOTAL_NUM,CHARGE_TOTAL_FEE,UPDATE_TOTAL_NUM,UPDATE_TOTAL_FEE,
							 UPDATE_TOTAL_FEE_CASH,ADMIN_TOTAL_NUM,ADMIN_TOTAL_FEE_RETURN,ADMIN_TOTAL_FEE_INCOME,DELAY_TOTAL_NUM,
							 RETURN_TOTAL_NUM,RETURN_TOTAL_FEE,RETURN_NON_TOTAL_NUM,RETURN_NON_TOTAL_FEE,RETURN_NON_APP_TOTAL_NUM,
							 CHARGE_UPDATE_TOTAL_NUM,CHARGE_UPDATE_TOTAL_FEE,UNLOCK_TOTAL_NUM,TOTAL_FEE_NOCASH,TOTAL_FEE_CASH,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_BOM_SHIFT_TOTAL 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢∞‡¥Œ∫≈°¢∞‡¥Œø™ ºº∞Ω· ¯ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||OPERATOR_ID||SHIFT_ID||TO_CHAR(START_TIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(END_TIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||OPERATOR_ID||SHIFT_ID||TO_CHAR(START_TIME,'YYYYMMDDHH24MISS')
						           ||TO_CHAR(END_TIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_BOM_SHIFT_TOTAL
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_BOM_SHIFT_TOTAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_BOM_SHIFT_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,SHIFT_ID,START_TIME,END_TIME,
							 SALE_TOTAL_NUM,SALE_TOTAL_FEE,CHARGE_TOTAL_NUM,CHARGE_TOTAL_FEE,UPDATE_TOTAL_NUM,UPDATE_TOTAL_FEE,
							 UPDATE_TOTAL_FEE_CASH,ADMIN_TOTAL_NUM,ADMIN_TOTAL_FEE_RETURN,ADMIN_TOTAL_FEE_INCOME,DELAY_TOTAL_NUM,
							 RETURN_TOTAL_NUM,RETURN_TOTAL_FEE,RETURN_NON_TOTAL_NUM,RETURN_NON_TOTAL_FEE,RETURN_NON_APP_TOTAL_NUM,
							 CHARGE_UPDATE_TOTAL_NUM,CHARGE_UPDATE_TOTAL_FEE,UNLOCK_TOTAL_NUM,TOTAL_FEE_NOCASH,TOTAL_FEE_CASH,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,SHIFT_ID,START_TIME,END_TIME,
							 SALE_TOTAL_NUM,SALE_TOTAL_FEE,CHARGE_TOTAL_NUM,CHARGE_TOTAL_FEE,UPDATE_TOTAL_NUM,UPDATE_TOTAL_FEE,
							 UPDATE_TOTAL_FEE_CASH,ADMIN_TOTAL_NUM,ADMIN_TOTAL_FEE_RETURN,ADMIN_TOTAL_FEE_INCOME,DELAY_TOTAL_NUM,
							 RETURN_TOTAL_NUM,RETURN_TOTAL_FEE,RETURN_NON_TOTAL_NUM,RETURN_NON_TOTAL_FEE,RETURN_NON_APP_TOTAL_NUM,
							 CHARGE_UPDATE_TOTAL_NUM,CHARGE_UPDATE_TOTAL_FEE,UNLOCK_TOTAL_NUM,TOTAL_FEE_NOCASH,TOTAL_FEE_CASH,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_BOM_SHIFT_TOTAL;
	
		
		
		
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_BOM_SHIFT_TOTAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					     ----–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢∞‡¥Œ∫≈°¢∞‡¥Œø™ ºº∞Ω· ¯ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||OPERATOR_ID||SHIFT_ID||TO_CHAR(START_TIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(END_TIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT 
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||OPERATOR_ID||SHIFT_ID||TO_CHAR(START_TIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(END_TIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_BOM_SHIFT_TOTAL
						   );
---------------------◊”º«¬º≤Â»Î¥ÌŒÛ±Ì------------------------------------------------------------------------------------------------------						   
						   
	      --∑¢ €
        INSERT INTO ST_ERR_BOM_SHIFT_SALE(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_SALE
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_BOM_SHIFT_SALE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
-------------------------------------------------------------------------------------------------------------------------  
  --≥‰÷µ
        INSERT INTO ST_ERR_BOM_SHIFT_CHARGE(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_CHARGE
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_BOM_SHIFT_CHARGE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  ----------------------------------------------------------------------------------------------------------------------------
  --∏¸–¬
        INSERT INTO ST_ERR_BOM_SHIFT_UPDATE(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,UPDATE_REASON,PAY_TYPE,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG ,ERR_CODE)
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,UPDATE_REASON,PAY_TYPE,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_UPDATE
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
         DELETE FROM ST_BUF_BOM_SHIFT_UPDATE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  -----------------------------------------------------------------------------------------------------------------------------
  --––’˛¥¶¿Ì
         INSERT INTO ST_ERR_BOM_SHIFT_ADMIN(WATER_NO,ADMIN_WAY_ID,ADMIN_REASON_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG ,ERR_CODE)
                             SELECT  WATER_NO,ADMIN_WAY_ID,ADMIN_REASON_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_ADMIN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
         DELETE FROM ST_BUF_BOM_SHIFT_ADMIN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  ------------------------------------------------------------------------------------------------------------------------------
  --—”∆⁄
         INSERT INTO ST_ERR_BOM_SHIFT_DELAY(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG ,ERR_CODE)
                             SELECT  WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_DELAY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
         DELETE FROM ST_BUF_BOM_SHIFT_DELAY where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  --------------------------------------------------------------------------------------------------------------------------------
  --º¥ ±ÕÀøÓ
         INSERT INTO ST_ERR_BOM_SHIFT_RETURN(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
                                      RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG ,ERR_CODE)
                             SELECT WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
							        RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_BOM_SHIFT_RETURN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  ----------------------------------------------------------------------------------------------------------------------------
  --∑«º¥ ±ÕÀøÓ
        INSERT INTO ST_ERR_BOM_SHIFT_RTN_NON(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
                                       RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
							           RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_RTN_NON
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
         DELETE FROM ST_BUF_BOM_SHIFT_RTN_NON where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  ----------------------------------------------------------------------------------------------------------------------------
  --∑«º¥ ±ÕÀøÓ…Í«Î
        INSERT INTO ST_ERR_BOM_SHIFT_RTN_APP(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_RTN_APP
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_BOM_SHIFT_RTN_APP where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  -----------------------------------------------------------------------------------------------------------------------------
  --≥‰’˝
         INSERT INTO ST_ERR_BOM_SHIFT_CHG_UPD(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT    WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_CHG_UPD
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
         DELETE FROM ST_BUF_BOM_SHIFT_CHG_UPD where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  -----------------------------------------------------------------------------------------------------------------------------
  --À¯ø®
        INSERT INTO ST_ERR_BOM_SHIFT_UNLOCK(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_BOM_SHIFT_UNLOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							 (
							    SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							 )
							 ;
  --	…æ≥˝÷ÿ∏¥º«¬º					  
         DELETE FROM ST_BUF_BOM_SHIFT_UNLOCK where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and WATER_NO IN
							             (
							               SELECT WATER_NO FROM  T#ST_BUF_BOM_SHIFT_TOTAL
							              )
							              ;
  ----------------------------------------------------------------------------------------------------------------------------
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_BOM_SHIFT_TOTAL( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,SHIFT_ID,START_TIME,END_TIME,
							 SALE_TOTAL_NUM,SALE_TOTAL_FEE,CHARGE_TOTAL_NUM,CHARGE_TOTAL_FEE,UPDATE_TOTAL_NUM,UPDATE_TOTAL_FEE,
							 UPDATE_TOTAL_FEE_CASH,ADMIN_TOTAL_NUM,ADMIN_TOTAL_FEE_RETURN,ADMIN_TOTAL_FEE_INCOME,DELAY_TOTAL_NUM,
							 RETURN_TOTAL_NUM,RETURN_TOTAL_FEE,RETURN_NON_TOTAL_NUM,RETURN_NON_TOTAL_FEE,RETURN_NON_APP_TOTAL_NUM,
							 CHARGE_UPDATE_TOTAL_NUM,CHARGE_UPDATE_TOTAL_FEE,UNLOCK_TOTAL_NUM,TOTAL_FEE_NOCASH,TOTAL_FEE_CASH,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,SHIFT_ID,START_TIME,END_TIME,
							 SALE_TOTAL_NUM,SALE_TOTAL_FEE,CHARGE_TOTAL_NUM,CHARGE_TOTAL_FEE,UPDATE_TOTAL_NUM,UPDATE_TOTAL_FEE,
							 UPDATE_TOTAL_FEE_CASH,ADMIN_TOTAL_NUM,ADMIN_TOTAL_FEE_RETURN,ADMIN_TOTAL_FEE_INCOME,DELAY_TOTAL_NUM,
							 RETURN_TOTAL_NUM,RETURN_TOTAL_FEE,RETURN_NON_TOTAL_NUM,RETURN_NON_TOTAL_FEE,RETURN_NON_APP_TOTAL_NUM,
							 CHARGE_UPDATE_TOTAL_NUM,CHARGE_UPDATE_TOTAL_FEE,UNLOCK_TOTAL_NUM,TOTAL_FEE_NOCASH,TOTAL_FEE_CASH,
							 BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_BOM_SHIFT_TOTAL
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_TOTAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  --µº»Î◊”∂”¡–±Ì
  --∑¢ €
  INSERT INTO ST_QUE_BOM_SHIFT_SALE(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_SALE
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_SALE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
-------------------------------------------------------------------------------------------------------------------------  
  --≥‰÷µ
  INSERT INTO ST_QUE_BOM_SHIFT_CHARGE(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_CHARGE
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_CHARGE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  ----------------------------------------------------------------------------------------------------------------------------
  --∏¸–¬
  INSERT INTO ST_QUE_BOM_SHIFT_UPDATE(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,UPDATE_REASON,PAY_TYPE,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,UPDATE_REASON,PAY_TYPE,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_UPDATE
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_UPDATE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  -----------------------------------------------------------------------------------------------------------------------------
  --––’˛¥¶¿Ì
  INSERT INTO ST_QUE_BOM_SHIFT_ADMIN(WATER_NO,ADMIN_WAY_ID,ADMIN_REASON_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT  WATER_NO,ADMIN_WAY_ID,ADMIN_REASON_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_ADMIN
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_ADMIN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  ------------------------------------------------------------------------------------------------------------------------------
  --—”∆⁄
  INSERT INTO ST_QUE_BOM_SHIFT_DELAY(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT  WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_DELAY
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_DELAY where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --------------------------------------------------------------------------------------------------------------------------------
  --º¥ ±ÕÀøÓ
  INSERT INTO ST_QUE_BOM_SHIFT_RETURN(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
                                      RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
							        RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_RETURN
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_RETURN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  ----------------------------------------------------------------------------------------------------------------------------
  --∑«º¥ ±ÕÀøÓ
  INSERT INTO ST_QUE_BOM_SHIFT_RTN_NON(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
                                       RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,RETURN_BALANCE_FEE,RETURN_DEPOSIT_FEE,
							           RETURN_TYPE,IS_BROKEN,PENALTY_FEE,PENALTY_REASON,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_RTN_NON
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_RTN_NON where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  ----------------------------------------------------------------------------------------------------------------------------
  --∑«º¥ ±ÕÀøÓ…Í«Î
  INSERT INTO ST_QUE_BOM_SHIFT_RTN_APP(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_RTN_APP
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_RTN_APP where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  -----------------------------------------------------------------------------------------------------------------------------
  --≥‰’˝
  INSERT INTO ST_QUE_BOM_SHIFT_CHG_UPD(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT    WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_CHG_UPD
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_CHG_UPD where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  -----------------------------------------------------------------------------------------------------------------------------
  --À¯ø®
  INSERT INTO ST_QUE_BOM_SHIFT_UNLOCK(WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT   WATER_NO,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_BOM_SHIFT_UNLOCK
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_BOM_SHIFT_UNLOCK where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  ----------------------------------------------------------------------------------------------------------------------------
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_BOM_SHIFT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_CARD_APP
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_card_app
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_card_app
--π¶ƒ‹√Ë ˆ£∫–£—Èº«√˚ø®ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130810
--–ﬁ∏ƒ»’∆⁄: 20140415
--–ﬁ∏ƒ’ﬂ: HEJJ
--–ﬁ∏ƒ√Ë ˆ£∫À˘”–¥¶¿Ì‘ˆº”CARD_MAIN_ID,CARD_SUB_ID◊÷∂Œ 
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_SIGN_CARD_APPLY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID
					FROM ST_BUF_SIGN_CARD_APPLY
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸÷§º˛¿‡–Õ°¢÷§º˛∫≈¬Î°¢…Í«Î ±º‰
					      IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') 
						   FROM ST_QUE_SIGN_CARD_APPLY
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_SIGN_CARD_APPLY;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_SIGN_CARD_APPLY(
                            WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,CARD_MAIN_ID,CARD_SUB_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',CARD_MAIN_ID,CARD_SUB_ID
					FROM T#ST_BUF_SIGN_CARD_APPLY;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_SIGN_CARD_APPLY
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_SIGN_CARD_APPLY
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ST_QUE_SIGN_CARD_APPLY(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID
							  from ST_BUF_SIGN_CARD_APPLY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
       insert into      ST_QUE_SIGN_CARD_APPLY(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID
							  from ST_BUF_SIGN_CARD_APPLY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
       insert into      ST_TST_SIGN_CARD_APPLY(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID
							  from ST_BUF_SIGN_CARD_APPLY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
   
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_SIGN_CARD_APPLY where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_CARD_APP to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_DEAL
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_deal
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_deal
--π¶ƒ‹√Ë ˆ£∫–£—È«Æ∞¸Ωª“◊ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ»’∆⁄: 20140415
--–ﬁ∏ƒ’ﬂ: HEJJ
--–ﬁ∏ƒ√Ë ˆ£∫À˘”–¥¶¿Ì‘ˆº”WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE◊÷∂Œ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
--–ﬁ∏ƒ»’∆⁄: 201405015
--–ﬁ∏ƒ√Ë ˆ£∫≤È÷ÿπ¶ƒ‹πÿº¸◊÷‘ˆº”Ωª“◊Ω∂Ó°¢Ωª“◊”‡∂Ó
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140808
--–ﬁ∏ƒ√Ë ˆ£∫¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹£∫Ωˆ≤ÈΩª“◊ ±º‰–°”⁄µ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒº«¬º
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20150302
--–ﬁ∏ƒ√Ë ˆ£∫µ±«∞¿˙ ∑±Ì≤È÷ÿ–¥∑®∏ƒŒ™÷±Ω” π”√À˜“˝
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160120
--–ﬁ∏ƒ√Ë ˆ£∫µº≥ˆ ÷ª˙∆± ˝æ›
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160520
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160823
--–ﬁ∏ƒ√Ë ˆ£∫ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ∏ƒŒ™◊Óœ»µΩ¥Ôº«¬º±£¡Ù
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20161130
--–ﬁ∏ƒ√Ë ˆ£∫◊‘…Ì°¢∂”¡–°¢¿˙ ∑°¢∑÷±Ì≤È÷ÿ∑Ω∑®”…◊÷∂Œ¥Æ¡™∏ƒŒ™◊÷∂Œ∂‘”¶≈–∂œ
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
---
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from ACC_ST.st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='54';
---
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
--ª∫¥ÊTAC–£—È≤ªÕ®π˝º«¬º
INSERT INTO ACC_ST.T#ST_ERR_DEAL(CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,DEAL_DATETIME,FILE_NAME,BALANCE_WATER_NO,ERR_CODE)
                   SELECT CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,DEAL_DATETIME,FILE_NAME,
                          BALANCE_WATER_NO,ERR_CODE
           FROM ACC_ST.ST_ERR_DEAL WHERE
           FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41';
DELETE FROM ACC_ST.ST_BUF_DEAL A
                         WHERE
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(
                    SELECT 1 FROM ACC_ST.T#ST_ERR_DEAL B
                             WHERE B.FILE_NAME=piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND
                                   B.ERR_CODE='41' AND
                                   A.CARD_MAIN_ID =B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                   A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                   A.DEAL_DATETIME =B.DEAL_DATETIME
                );
----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ∏ƒŒ™◊Óœ»µΩ¥Ôº«¬º±£¡Ù
insert into ACC_ST.T#ST_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_DEAL A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(
                    SELECT 1 FROM ACC_ST.ST_BUF_DEAL B
                             WHERE B.FILE_NAME <> piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND
                                   A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                   A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                   A.DEAL_DATETIME=B.DEAL_DATETIME AND A.DEAL_FEE=B.DEAL_FEE AND
                                   A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE
                );
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_DEAL A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(
                    SELECT 1 FROM ACC_ST.ST_QUE_DEAL B
                             WHERE B.FILE_NAME <> piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND
                                   A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                   A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                   A.DEAL_DATETIME=B.DEAL_DATETIME AND A.DEAL_FEE=B.DEAL_FEE AND
                                   A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE
                );
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
  insert into ACC_ST.T#ST_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_DEAL a
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
               DEAL_DATETIME < TO_DATE(SUBSTR(piBalanceWaterNo,1,8),'yyyymmdd')  AND
               exists(
                     select * from acc_st_his.st_his_deal b
                              where a.card_main_id = b.card_main_id and a.card_sub_id = b.card_sub_id and
                                    a.sam_logical_id = b.sam_logical_id and a.sam_trade_seq = b.sam_trade_seq and
                                    a.deal_datetime = b.deal_datetime and a.deal_fee =b.deal_fee and
                                    a.deal_balance_fee = b.deal_balance_fee
               )
               ;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.st_buf_deal
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           deal_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
dbms_output.put_line('isNeedCheckHisSub='||isNeedCheckHisSub);
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    insert into ACC_ST.T#ST_BUF_DEAL_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          deal_datetime <= dateMaxHis;
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_BUF_DEAL_CHK a set a.table_name = (select trim(b.table_name) from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_BUF_DEAL_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         dbms_output.put_line('tableName='||tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_DEAL_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_DEAL
         dbms_output.put_line('execute immediate begin');
         execute immediate
         'insert into ACC_ST.T#ST_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.T#ST_BUF_DEAL_CHK A
                    WHERE TABLE_NAME= :x AND
                    EXISTS(
                    SELECT 1 FROM ACC_ST_HIS.'||tableName||' B
                             WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                   A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                   A.DEAL_DATETIME=B.DEAL_DATETIME AND A.DEAL_FEE=B.DEAL_FEE AND
                                   A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE
                )'
         using tableName;
         dbms_output.put_line('execute immediate end');
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_DEAL;
  dbms_output.put_line('T#ST_BUF_DEAL count='||to_char(rowCount));
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_ERR_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.T#ST_BUF_DEAL;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_BUF_DEAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS') IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(DEAL_DATETIME,'YYYYMMDDHH24MISS')
               FROM ACC_ST.T#ST_BUF_DEAL
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ìº∞Œƒº˛ƒ⁄≤È÷ÿ
        insert into ACC_ST.ST_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select    DISTINCT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into ACC_ST.ST_TST_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select     DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
 --µº≥ˆOCT ˝æ›
 insert into ACC_ST.ST_QUE_DEAL_OCT(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND
                      CARD_MAIN_ID='06' ;
 --µº≥ˆ ÷ª˙∆± ˝æ›add by hejj 20160120
 --≈–∂œ£∫∆±ø® «02ªÚ08 £ª¬ﬂº≠ø®∫≈‘⁄∂®“Â∑∂Œßƒ⁄
 insert into ACC_ST.ST_MB_EXT_QUE_DEAL_LINE(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,A.CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_BUF_DEAL A ,ACC_ST.ST_COD_LOGICAL_CARD B
                where A.BALANCE_WATER_NO=piBalanceWaterNo and A.FILE_NAME=piFileName AND
                      A.CARD_MAIN_ID IN('02','08') AND B.CARD_MAIN_ID='08' AND
                      A.CARD_LOGICAL_ID BETWEEN B.CARD_LOGICAL_ID_START AND B.CARD_LOGICAL_ID_END;
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_BUF_DEAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_DEAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_DEAL_MTR
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_deal_mtr
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_deal_mtr
--π¶ƒ‹√Ë ˆ£∫–£—Èπ´Ωªœ˚∑—«Æ∞¸Ωª“◊ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20140423
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140504
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140808
--–ﬁ∏ƒ√Ë ˆ£∫¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹£∫Ωˆ≤ÈΩª“◊ ±º‰–°”⁄µ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒº«¬º
--–ﬁ∏ƒ»’∆⁄: 20160120
--–ﬁ∏ƒ√Ë ˆ£∫µº≥ˆ ÷ª˙∆± ˝æ›
--–ﬁ∏ƒ»’∆⁄: 20160203
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”Ωª“◊º«¬ºµƒ∫⁄√˚µ•°¢“—ÕÀøÓ–£—È
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20170228
--–ﬁ∏ƒ√Ë ˆ£∫∂”¡–°¢¿˙ ∑°¢”…◊÷∂Œ¥Æ¡™∏ƒŒ™◊÷∂Œ∂‘”¶≈–∂œ;‘ˆº”∑÷±Ì≤È÷ÿ∑Ω∑®£ª
--–ﬁ∏ƒ»’∆⁄: 20170321
--–ﬁ∏ƒ√Ë ˆ£∫≤È÷ÿÃıº˛‘ˆº”∆±ø®¬ﬂº≠ø®∫≈;µ±«∞¿˙ ∑±Ì≤È÷ÿ‘ˆº” ±º‰π˝¬À
--–ﬁ∏ƒ»’∆⁄: 20170324
--–ﬁ∏ƒ√Ë ˆ£∫ª∫¥Ê±Ìº«¬ºΩˆ≈–∂œ1÷÷¥ÌŒÛ£¨≤ª‘Ÿ≈–∂œ∆‰À˚¥ÌŒÛ£¨±‹√‚¥ÌŒÛ±Ì¥Ê‘⁄∂‡Ãıº«¬ºœ÷œÛ£¨‘Ï≥…Õ≥º∆”–ŒÛ
--–ﬁ∏ƒ»’∆⁄: 2017926
--–ﬁ∏ƒ√Ë ˆ£∫¥ÌŒÛ±Ì÷–µƒdeal_datetime°¢last_deal_datetime°¢entry_datetime°¢tct_activate_datetime¿‡–Õ”…date∏ƒŒ™varchar2(20)
-------------------------------------------------------------------------------
is
rowCount int;
daysDelayBlacklist int;--∫⁄√˚µ•◊Ó¥Û÷Õ¡ÙÃÏ ˝
daysDelayReturn int;--ÕÀøÓ◊Ó¥Û÷Õ¡ÙÃÏ ˝
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
dateMaxHisCur date;--µ±«∞¿˙ ∑±Ìµƒ◊Ó¥ÛΩª“◊ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
select to_number(CHK_VALUE) into daysDelayBlacklist
                       from acc_st.ST_SYS_CHK_LIMIT where CHK_ID='47' and CHK_KEY='chk.days.blacklist';

select to_number(CHK_VALUE) into daysDelayReturn
                       from acc_st.ST_SYS_CHK_LIMIT where CHK_ID='48' and CHK_KEY='chk.days.return';

---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='94';

----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
DELETE FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A
                         WHERE
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          --MODIFIED BY HEJJ 20170228
                          EXISTS(
                              SELECT 1 FROM ACC_ST.ST_EXT_MTR_ERR_DEAL B WHERE
                                       B.FILE_NAME=piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND B.ERR_CODE='41'
                                       AND
                                       A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                       A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                       A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                       A.DEAL_DATETIME=to_date(B.DEAL_DATETIME,'yyyy-mm-dd hh24:mi:ss')

                          );

----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,ERR_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,'42'
          FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          --MODIFIED BY HEJJ 20170228
                          EXISTS(
                              SELECT 1 FROM ACC_ST.ST_EXT_MTR_QUE_DEAL B WHERE

                                       A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                       A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                       A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                       A.DEAL_DATETIME=B.DEAL_DATETIME

                          );

  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
  SELECT MAX(A.DEAL_DATETIME) INTO dateMaxHisCur  FROM ACC_ST_HIS.ST_EXT_MTR_HIS_DEAL A;
  IF ( dateMaxHisCur IS NOT NULL ) THEN
     insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,ERR_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,'42'
          FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                         -- TO_CHAR(DEAL_DATETIME,'YYYYMMDD') < SUBSTR(piBalanceWaterNo,1,8)  AND   --ADD BY HEJJ 20140808
                         --MODIFIED BY HEJJ 20170228
                         A.DEAL_DATETIME<=dateMaxHisCur AND
                         EXISTS(
                              SELECT 1 FROM ACC_ST_HIS.ST_EXT_MTR_HIS_DEAL B WHERE

                                       A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                       A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                       A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                       A.DEAL_DATETIME=B.DEAL_DATETIME

                          );
  END IF;
 --MODIFIED BY HEJJ 20170228
  ---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.ST_EXT_MTR_BUF_DEAL
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           deal_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
dbms_output.put_line('isNeedCheckHisSub='||isNeedCheckHisSub);
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.ST_EXT_MTR_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          deal_datetime <= dateMaxHis;
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_EXT_MTR_BUF_DEAL_CHK a set a.table_name = (select trim(b.table_name)
                                                             from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.deal_datetime >= b.begin_date and
                                                                   a.deal_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_EXT_MTR_BUF_DEAL_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         dbms_output.put_line('tableName='||tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_EXT_MTR_BUF_DEAL_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_EXT_MTR_BUF_DEAL
         dbms_output.put_line('execute immediate begin');
         execute immediate
         'insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,ERR_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,TO_CHAR(42)
          FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL_CHK A
                    WHERE TABLE_NAME= :x AND
                    EXISTS(
                    SELECT 1 FROM ACC_ST_HIS.'||tableName||' B
                             WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                   A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                   A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                   A.DEAL_DATETIME=B.DEAL_DATETIME AND A.DEAL_FEE=B.DEAL_FEE AND
                                   A.DEAL_BALANCE_FEE=B.DEAL_BALANCE_FEE
                )'
         using tableName;
         dbms_output.put_line('execute immediate end');
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------

--ª∫¥Ê±Ì…æ≥˝÷ÿ∏¥º«¬º
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL;
  IF rowCount != 0 THEN
     --ª∫¥Ê±Ì…æ≥˝÷ÿ∏¥º«¬º£¨÷ÿ∏¥º«¬º≤ª‘ŸΩ¯––∆‰À˚¥ÌŒÛ–£—È
        DELETE FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                              SELECT 1 FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL B WHERE

                                       A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                       A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                       A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                       A.DEAL_DATETIME=B.DEAL_DATETIME

                          );
  END IF;


  --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  --–£—È «∑ÒŒ™∫⁄√˚µ•ø®--47
  --1£©‘⁄ÀÕ≥ˆµƒ∫⁄√˚µ•÷–2£© ±º‰ «5ÃÏ∫Û£¨∞¸∫¨ÀÕ≥ˆµƒµ±ÃÏ
  --µ•∏ˆ∫⁄√˚µ•
  insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,ERR_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,'47'
          FROM ACC_ST.ST_EXT_MTR_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È¬ﬂº≠ø®∫≈ «∑Ò‘⁄µ•∏ˆ∫⁄√˚µ•
                CARD_LOGICAL_ID IN
              (
                 SELECT CARD_LOGICAL_ID_START
               FROM ACC_ST.ST_EXT_MTR_BLACKLIST_TOTAL
                           where SECT_FLAG='0' and
                                 to_date(to_char(sysdate,'YYYYMMDD'),'YYYYMMDD')-
                                 to_date(to_char(send_datetime,'YYYYMMDD'),'YYYYMMDD')+1>daysDelayBlacklist
               ) ;
  --∫⁄√˚µ•∂Œ
   insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,ERR_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,'47'
          FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A,ACC_ST.ST_EXT_MTR_BLACKLIST_TOTAL B
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                          B.SECT_FLAG='1' AND
                          to_date(to_char(sysdate,'YYYYMMDD'),'YYYYMMDD')-
                                 to_date(to_char(B.send_datetime,'YYYYMMDD'),'YYYYMMDD')+1>daysDelayBlacklist                          AND
                          A.CARD_LOGICAL_ID BETWEEN B.CARD_LOGICAL_ID_START AND
                          B.CARD_LOGICAL_ID_END;

  --ª∫¥Ê±Ì…æ≥˝∫⁄√˚µ•º«¬º
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL;
  IF rowCount != 0 THEN
     --ª∫¥Ê±Ì…æ≥˝∫⁄√˚µ•º«¬º£¨∫⁄√˚µ•º«¬º≤ª‘ŸΩ¯––∆‰À˚¥ÌŒÛ–£—È
        DELETE FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                              SELECT 1 FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL B WHERE

                                       A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                       A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                       A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                       A.DEAL_DATETIME=B.DEAL_DATETIME

                          );
  END IF;


  --–£—È «∑Ò «“—ÕÀø®--48
  --1£©‘⁄ÕÀøÓ…Í«Î÷– 2£© ±º‰ «7ÃÏ∫Û£¨∞¸∫¨…Í«Îµƒµ±ÃÏ
  insert into ACC_ST.T#ST_EXT_MTR_BUF_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,ERR_CODE
                            )
          SELECT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE,'48'
          FROM ACC_ST.ST_EXT_MTR_BUF_DEAL
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È¬ﬂº≠ø®∫≈ «∑Ò‘⁄ÕÀøÓ…Í«Î
                CARD_LOGICAL_ID IN
              (
                 SELECT CARD_LOGICAL_ID
               FROM ACC_ST_HIS.ST_HIS_NON_RTN_APP
                           where
                                 to_date(to_char(sysdate,'YYYYMMDD'),'YYYYMMDD')-
                                 to_date(to_char(APPLY_DATETIME,'YYYYMMDD'),'YYYYMMDD')+1>daysDelayReturn
               ) ;





  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥°¢∫⁄√˚µ•°¢“—ÕÀøÓº«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_EXT_MTR_ERR_DEAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               to_char(DEAL_DATETIME,'yyyy-mm-dd hh24:mi:ss'),CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               to_char(ENTRY_DATETIME,'yyyy-mm-dd hh24:mi:ss'),OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,to_char(LAST_DEAL_DATETIME,'yyyy-mm-dd hh24:mi:ss'),
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,to_char(TCT_ACTIVATE_DATETIME,'yyyy-mm-dd hh24:mi:ss'),LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
          FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL;
  --…æ≥˝÷ÿ∏¥°¢∫⁄√˚µ•°¢“—ÕÀøÓº«¬º£® µº Ωˆ £“—ÕÀøÓº«¬º£©
        DELETE FROM ACC_ST.ST_EXT_MTR_BUF_DEAL A
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                              SELECT 1 FROM ACC_ST.T#ST_EXT_MTR_BUF_DEAL B WHERE

                                       A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                       A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                       A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                       A.DEAL_DATETIME=B.DEAL_DATETIME

                          );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------

--µº»Î∂”¡–±Ì/Œƒº˛ƒ⁄≤È÷ÿ
  insert into ACC_ST.ST_EXT_MTR_QUE_DEAL(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_EXT_MTR_BUF_DEAL
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;

--µº≥ˆ ÷ª˙∆± ˝æ›add by hejj 20160120
 --≈–∂œ£∫∆±ø® «02ªÚ08 £ª¬ﬂº≠ø®∫≈‘⁄∂®“Â∑∂Œßƒ⁄

 insert into ACC_ST.ST_MB_EXT_QUE_DEAL_BUS(WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,
               DEAL_DATETIME,A.CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,
               CARD_STATUS_ID,DEAL_FEE,DEAL_BALANCE_FEE,CARD_CHARGE_SEQ,CARD_CONSUME_SEQ,
               PAY_MODE_ID,RECEIPT_ID,TAC,ENTRY_LINE_ID,ENTRY_STATION_ID,ENTRY_SAM_LOGICAL_ID,
               ENTRY_DATETIME,OPERATOR_ID,SHIFT_ID,LAST_SAM_LOGICAL_ID,LAST_DEAL_DATETIME,
               DEAL_NO_DISCOUNT_FEE,UNION_YEAR_MONTH,UNION_BUS_NUM,UNION_METRO_NUM,
               UNION_TOTAL_NUM,TRADE_SORT,CARD_AREA_CODE,CARD_AREA_TYPE,OVERDRAFT_FEE,
               CARD_CPU_FLAG,CARD_EXPIRED_FLAG,TCT_VALID_DAYS,TCT_ACTIVATE_DATETIME,LIMIT_MODE,
               LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CITY_CODE,BUSINESS_CODE,TAC_DEAL_TYPE,TAC_DEV_ID,CARD_APP_MODE
                from ACC_ST.ST_EXT_MTR_BUF_DEAL A ,ACC_ST.ST_COD_LOGICAL_CARD B
                where A.BALANCE_WATER_NO=piBalanceWaterNo and A.FILE_NAME=piFileName AND
                      A.CARD_MAIN_ID IN('02','08') AND B.CARD_MAIN_ID='08' AND
                      A.CARD_LOGICAL_ID BETWEEN B.CARD_LOGICAL_ID_START AND B.CARD_LOGICAL_ID_END;


 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_EXT_MTR_BUF_DEAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;




   COMMIT;


   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_DEAL_MTR to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_DELAY
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_delay
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_delay
--π¶ƒ‹√Ë ˆ£∫–£—È—”∆⁄ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹ 
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='55';
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into T#ST_BUF_DELAY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_DELAY
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_DELAY
						   );
                           
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
--
insert into T#ST_BUF_DELAY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_DELAY
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_HIS_DELAY
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from st_buf_delay
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           operate_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into T#ST_BUF_DELAY_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_DELAY 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          operate_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_DELAY_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.operate_datetime >= b.begin_date and 
                                                                   a.operate_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.operate_datetime >= b.begin_date and 
                                                                   a.operate_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_DELAY_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_DEAL_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_DEAL
         
         execute immediate
         'insert into T#ST_BUF_DELAY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					
					FROM T#ST_BUF_DELAY_CHK
                    WHERE TABLE_NAME= :x AND
                          CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
                           
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------                         
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_DELAY;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_DELAY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_DELAY;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_DELAY
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(OPERATE_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_DELAY
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ST_QUE_DELAY(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select     DISTINCT  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_DELAY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ST_QUE_DELAY(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_DELAY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ST_TST_DELAY(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,OLD_EXPIRE_DATETIME,NEW_EXPIRE_DATETIME,
							 OPERATE_DATETIME,OPERATOR_ID,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_DELAY
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
   
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_DELAY where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_DELAY to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_ENTRY
prompt ============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_entry
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_entry
--π¶ƒ‹√Ë ˆ£∫–£—ÈΩ¯’æª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ»’∆⁄: 20140415
--–ﬁ∏ƒ’ﬂ: HEJJ
--–ﬁ∏ƒ√Ë ˆ£∫À˘”–¥¶¿Ì‘ˆº”WORK_MODE,CARD_APP_MODE◊÷∂Œ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
--–ﬁ∏ƒ»’∆⁄: 201405015
--–ﬁ∏ƒ√Ë ˆ£∫≤È÷ÿπ¶ƒ‹÷˜º¸‘ˆº”ø®¬ﬂº≠ø®∫≈
--–ﬁ∏ƒ»’∆⁄: 20140808
--–ﬁ∏ƒ√Ë ˆ£∫¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹£∫Ωˆ≤ÈΩª“◊ ±º‰–°”⁄µ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒº«¬º
--–ﬁ∏ƒ»’∆⁄: 20150302
--–ﬁ∏ƒ√Ë ˆ£∫¿˙ ∑±Ì≤È÷ÿ∏ƒŒ™÷±Ω” π”√À˜“˝œÓ
--–ﬁ∏ƒ»’∆⁄: 20161130
--–ﬁ∏ƒ√Ë ˆ£∫◊‘…Ì°¢∂”¡–°¢¿˙ ∑°¢∑÷±Ì≤È÷ÿ∑Ω∑®”…◊÷∂Œ¥Æ¡™∏ƒŒ™◊÷∂Œ∂‘”¶≈–∂œ
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='53';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_BUF_ENTRY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                            WORK_MODE,CARD_APP_MODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_ENTRY A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                          EXISTS(
                             SELECT 1 FROM ACC_ST.ST_QUE_ENTRY B
                                      WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                            A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                            A.ENTRY_DATETIME=B.ENTRY_DATETIME
                          );
--µ±«∞¿˙ ∑±Ì≤È÷ÿ
insert into ACC_ST.T#ST_BUF_ENTRY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                            WORK_MODE,CARD_APP_MODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_ENTRY a
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          TO_CHAR(ENTRY_DATETIME+7,'YYYYMMDD') < SUBSTR(piBalanceWaterNo,1,8)  AND   --ADD BY HEJJ 20140808
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
               ENTRY_DATETIME <TO_DATE(SUBSTR(piBalanceWaterNo,1,8),'YYYYMMDD') AND
               exists(
                       select * from acc_st_his.st_his_entry b
                                where a.card_main_id = b.card_main_id and a.card_sub_id = b.card_sub_id and
                                      a.sam_logical_id = b.sam_logical_id and a.sam_trade_seq = b.sam_trade_seq and
                                      a.entry_datetime = b.entry_datetime and a.card_logical_id = b.card_logical_id
               )
               ;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.st_buf_entry
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           entry_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
    insert into ACC_ST.T#ST_BUF_ENTRY_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                            WORK_MODE,CARD_APP_MODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE
          FROM ACC_ST.ST_BUF_ENTRY
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          entry_datetime <= dateMaxHis;
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_BUF_ENTRY_CHK a set a.table_name = (select trim(b.table_name) from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.entry_datetime >= b.begin_date and
                                                                   a.entry_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.entry_datetime >= b.begin_date and
                                                                   a.entry_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_BUF_ENTRY_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_ENTRY_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_ENTRY
         execute immediate
         'insert into ACC_ST.T#ST_BUF_ENTRY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                            WORK_MODE,CARD_APP_MODE
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                            WORK_MODE,CARD_APP_MODE
          FROM ACC_ST.T#ST_BUF_ENTRY_CHK A
                    WHERE TABLE_NAME= :x AND
                    EXISTS(
                             SELECT 1 FROM ACC_ST_HIS.'||tableName||' B
                                      WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                            A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                            A.ENTRY_DATETIME=B.ENTRY_DATETIME
                          )'
         using tableName;
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_ENTRY;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_ERR_ENTRY(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,ERR_CODE,
                             WORK_MODE,CARD_APP_MODE
                            )
          SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,'42',
                             WORK_MODE,CARD_APP_MODE
          FROM T#ST_BUF_ENTRY;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_BUF_ENTRY A
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(
                  SELECT 1 FROM ACC_ST.T#ST_BUF_ENTRY B
                           WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                 A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                 A.ENTRY_DATETIME=B.ENTRY_DATETIME
                );

     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_QUE_ENTRY( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE
                from ST_BUF_ENTRY
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_QUE_ENTRY( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE
                from ST_BUF_ENTRY
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ACC_ST.ST_TST_ENTRY( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE)
    select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
               CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,ENTRY_DATETIME,CARD_STATUS_ID,BALANCE_FEE,
               LIMIT_MODE,LIMIT_ENTRY_STATION,LIMIT_EXIT_STATION,BALANCE_WATER_NO,CARD_APP_FLAG,FILE_NAME,CHECK_FLAG,
                             WORK_MODE,CARD_APP_MODE
                from ST_BUF_ENTRY
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ST_BUF_ENTRY where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_ENTRY to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_LOCK
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_lock
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_lock
--π¶ƒ‹√Ë ˆ£∫–£—ÈÀ¯ø®ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ»’∆⁄: 20140415
--–ﬁ∏ƒ’ﬂ: HEJJ
--–ﬁ∏ƒ√Ë ˆ£∫À˘”–¥¶¿Ì‘ˆº”CARD_APP_MODE◊÷∂Œ
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹ 
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='59';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into T#ST_BUF_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
					FROM ST_BUF_LOCK
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_LOCK
						   );
  
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
--ACC_ST_HIS.
insert into T#ST_BUF_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
					FROM ST_BUF_LOCK
					WHERE ---FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_HIS_LOCK
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from st_buf_lock
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           lock_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£© 
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into T#ST_BUF_LOCK_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
					FROM ST_BUF_LOCK 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          lock_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_LOCK_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.lock_datetime >= b.begin_date and 
                                                                   a.lock_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.lock_datetime >= b.begin_date and 
                                                                   a.lock_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_LOCK_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_LOCK_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_LOCK
         
         execute immediate
         'insert into T#ST_BUF_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
					
					FROM T#ST_BUF_LOCK_CHK
                    WHERE TABLE_NAME= :x AND
                          CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
                          
                           
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_LOCK;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_LOCK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,CARD_APP_MODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',CARD_APP_MODE
					FROM T#ST_BUF_LOCK;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_LOCK
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(LOCK_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_LOCK
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ST_QUE_LOCK(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
							  from ST_BUF_LOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ST_QUE_LOCK(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE)
		select     DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
							  from ST_BUF_LOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ST_TST_LOCK(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,LOCK_FLAG,LOCK_DATETIME,OPERATOR_ID,
							 SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_APP_MODE
							  from ST_BUF_LOCK
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
  
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_LOCK where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_LOCK to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_REG_TOTAL
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_reg_total
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_reg_total
--π¶ƒ‹√Ë ˆ£∫–£—Èºƒ¥Ê∆˜ ˝æ›ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_REG_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COMMU_DATETIME,GEN_DATETIME,
							 TOTAL_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COMMU_DATETIME,GEN_DATETIME,
							 TOTAL_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_REG_TOTAL 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢Õ®—∂ ±º‰°¢…˙≥… ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(COMMU_DATETIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(GEN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT   LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(COMMU_DATETIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(GEN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_REG_TOTAL
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_REG_TOTAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_REG_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COMMU_DATETIME,GEN_DATETIME,
							 TOTAL_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COMMU_DATETIME,GEN_DATETIME,
							 TOTAL_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_REG_TOTAL;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_REG_TOTAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					     ----–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢Õ®—∂ ±º‰°¢…˙≥… ±º‰
					        LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(COMMU_DATETIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(GEN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT 
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(COMMU_DATETIME,'YYYYMMDDHH24MISS')
						    ||TO_CHAR(GEN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_REG_TOTAL
						   );
		--------------------------------------◊”º«¬º-----------------------------------------------------
						   
	     --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
  
        INSERT INTO ST_ERR_REG_DTL(WATER_NO,DATA_CODE,DATA_VALUE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT WATER_NO,DATA_CODE,DATA_VALUE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_REG_DTL
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND WATER_NO IN
							       (SELECT WATER_NO FROM T#ST_BUF_REG_TOTAL);
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_REG_DTL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND WATER_NO IN
							       (SELECT WATER_NO FROM T#ST_BUF_REG_TOTAL);
  
  
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_REG_TOTAL( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COMMU_DATETIME,GEN_DATETIME,
							 TOTAL_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COMMU_DATETIME,GEN_DATETIME,
							 TOTAL_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_REG_TOTAL
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_REG_TOTAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  --µº»Î◊”∂”¡–±Ì
  
  INSERT INTO ST_QUE_REG_DTL(WATER_NO,DATA_CODE,DATA_VALUE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT WATER_NO,DATA_CODE,DATA_VALUE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_REG_DTL
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_REG_DTL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
-------------------------------------------------------------------------------------------------------------------------  
 
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_REG_TOTAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_RETURN
prompt =============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_return
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_return
--π¶ƒ‹√Ë ˆ£∫–£—ÈÕÀøÓª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ»’∆⁄: 20140415
--–ﬁ∏ƒ’ﬂ: HEJJ
--–ﬁ∏ƒ√Ë ˆ£∫À˘”–¥¶¿Ì‘ˆº”TAC_DEAL_TYPE,TAC_DEV_ID◊÷∂Œ
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹ 
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='57';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
DELETE FROM ST_BUF_RETURN 
                         WHERE 
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_ERR_RETURN WHERE 
						        FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41'
						   );
						   
----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into T#ST_BUF_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
					FROM ST_BUF_RETURN
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_RETURN
						   );
                           
--µ±«∞¿˙ ∑±Ì≤È÷ÿ
--ACC_ST_HIS.
insert into T#ST_BUF_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
					FROM ST_BUF_RETURN
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST_HIS.ST_HIS_RETURN
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from st_buf_return
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           return_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into T#ST_BUF_RETURN_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
					FROM ST_BUF_RETURN 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          return_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_RETURN_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.return_datetime >= b.begin_date and 
                                                                   a.return_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.return_datetime >= b.begin_date and 
                                                                   a.return_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_RETURN_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_RETURN_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_RETURN
         
         execute immediate
         'insert into T#ST_BUF_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
					
					FROM T#ST_BUF_RETURN_CHK
                    WHERE TABLE_NAME= :x AND
                          CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,''YYYYMMDDHH24MISS'') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,''YYYYMMDDHH24MISS'')
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
  
                           
                           
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
                           
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_RETURN;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_RETURN(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',TAC_DEAL_TYPE,TAC_DEV_ID
					FROM T#ST_BUF_RETURN;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_RETURN
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(RETURN_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_RETURN
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ST_QUE_RETURN(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
							  from ST_BUF_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ST_QUE_RETURN(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
							  from ST_BUF_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ST_TST_RETURN(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,CARD_MAIN_ID,
							 CARD_SUB_ID,CARD_LOGICAL_ID,CARD_PHYSICAL_ID,CARD_STATUS_ID,RETURN_BALANCE_FEE,
							 RETURN_DEPOSIT_FEE,PENALTY_FEE,PENALTY_REASON_ID,CARD_CONSUME_SEQ,RETURN_TYPE,
							 RETURN_DATETIME,RECEIPT_ID,APPLY_DATETIME,TAC,OPERATOR_ID,SHIFT_ID,AUXI_FEE,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
							  from ST_BUF_RETURN
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
  
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_RETURN where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_RETURN to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_RPT_LOSS
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_rpt_loss
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_rpt_loss
--π¶ƒ‹√Ë ˆ£∫–£—Èπ“ ßΩ‚π“ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160126
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
--–ﬁ∏ƒ√Ë ˆ£∫
--–ﬁ∏ƒ’ﬂ: 
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ√Ë ˆ£∫
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from ACC_ST.st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_BUF_REPORT_LOSS(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
					FROM ACC_ST.ST_BUF_REPORT_LOSS
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸÷§º˛¿‡–Õ°¢÷§º˛∫≈¬Î°¢…Í«Î ±º‰
					      IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') 
						   FROM ACC_ST.ST_QUE_REPORT_LOSS
						   );
                           
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
  insert into ACC_ST.T#ST_BUF_REPORT_LOSS(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
					FROM ACC_ST.ST_BUF_REPORT_LOSS
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸÷§º˛¿‡–Õ°¢÷§º˛∫≈¬Î°¢…Í«Î ±º‰
					      IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') 
						   FROM ACC_ST_HIS.ST_HIS_REPORT_LOSS
						   );
                           
  
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_REPORT_LOSS;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_ERR_REPORT_LOSS(
                            WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42',CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
					FROM ACC_ST.T#ST_BUF_REPORT_LOSS;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_BUF_REPORT_LOSS
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
					      IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT IDENTITY_TYPE||IDENTITY_ID||TO_CHAR(APPLY_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_BUF_REPORT_LOSS
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ACC_ST.ST_QUE_REPORT_LOSS(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
							  from ACC_ST.ST_BUF_REPORT_LOSS
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
       insert into      ACC_ST.ST_QUE_REPORT_LOSS(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
							  from ACC_ST.ST_BUF_REPORT_LOSS
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
       insert into      ACC_ST.ST_TST_REPORT_LOSS(  WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,APPLY_NAME,APPLY_SEX,IDENTITY_TYPE,
							 IDENTITY_ID,EXPIRED_DATE,TEL_NO,FAX,ADDRESS,OPERATOR_ID,APPLY_DATETIME,SHIFT_ID,
							 CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,CARD_MAIN_ID,CARD_SUB_ID,
                             APPLY_BUSINESS_TYPE,RECEIPT_ID
							  from ACC_ST.ST_BUF_REPORT_LOSS
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
   
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_BUF_REPORT_LOSS where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_RPT_LOSS to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_RTN_APP
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_rtn_app
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_non_rtn_app
--π¶ƒ‹√Ë ˆ£∫–£—È∑«º¥ ±ÕÀøÓ…Í«Îª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj  
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
--–ﬁ∏ƒ»’∆⁄: 20150910
--–ﬁ∏ƒ√Ë ˆ£∫≤È÷ÿπ¶ƒ‹≈–∂œ◊÷∂Œ»•µÙ…Í«Î ±º‰£¨∏ƒŒ™¬ﬂº≠ø®∫≈
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base 
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='58';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into T#ST_BUF_NON_RTN_APP(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_NON_RTN_APP 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢”°øÃ∫≈°¢¬ﬂº≠ø®∫≈
					      
                          CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID IN --modified by hejj 20150910
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID
						   FROM ST_QUE_NON_RTN_APP
						   );
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
--ACC_ST_HIS.
insert into T#ST_BUF_NON_RTN_APP(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_NON_RTN_APP 
					WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢”°øÃ∫≈°¢¬ﬂº≠ø®∫≈
					      CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID IN --modified by hejj 20150910 
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID|| CARD_LOGICAL_ID
						   FROM ACC_ST_HIS.ST_HIS_NON_RTN_APP
						   );
                           
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
                       
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from st_buf_non_rtn_app
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           apply_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    --CHK
    --deal_datetime <= dateMaxHis;
      insert into T#ST_BUF_NON_RTN_APP_CHK(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG                            
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_NON_RTN_APP 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          apply_datetime <= dateMaxHis;
                          
    
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_NON_RTN_APP_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.apply_datetime >= b.begin_date and 
                                                                   a.apply_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and 
                                                                   a.apply_datetime >= b.begin_date and 
                                                                   a.apply_datetime <= b.end_date);
                                                                   
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_NON_RTN_APP_CHK 
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         
         exit when csr%notfound;
         
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_NON_RTN_APP_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_NON_RTN_APP
         --modified by hejj 20150910 –ﬁ∏ƒ≤È÷ÿ◊÷∂Œ
         execute immediate
         'insert into T#ST_BUF_NON_RTN_APP(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                             
                            )
                      SELECT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					
					FROM T#ST_BUF_NON_RTN_APP_CHK
                    WHERE TABLE_NAME= :x AND
                           CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID IN
						  (
					SELECT CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID
						   FROM ACC_ST_HIS.'||tableName||
						   ')'
         using tableName;
         
      end loop;                                              
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©                                                            
end if;
                     
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------                          
                          
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------                         
                           
                           
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_NON_RTN_APP;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_NON_RTN_APP(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_NON_RTN_APP;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_NON_RTN_APP
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢”°øÃ∫≈°¢¬ﬂº≠ø®∫≈
					      CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID IN  --modified by hejj 20150910
						  (
					       SELECT CARD_MAIN_ID||CARD_SUB_ID||CARD_PRINT_ID||CARD_LOGICAL_ID
						   FROM T#ST_BUF_NON_RTN_APP
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into      ST_QUE_NON_RTN_APP( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_NON_RTN_APP
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
  
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into      ST_QUE_NON_RTN_APP( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_NON_RTN_APP
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
        insert into      ST_TST_NON_RTN_APP( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select      DISTINCT WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID,CARD_SUB_ID,CARD_LOGICAL_ID,
							 CARD_PHYSICAL_ID,CARD_PRINT_ID,APPLY_DATETIME,RECEIPT_ID,OPERATOR_ID,APPLY_NAME,TEL_NO,
							 IDENTITY_TYPE,IDENTITY_ID,IS_BROKEN,SHIFT_ID,CARD_APP_FLAG,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_NON_RTN_APP
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
  
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
  
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_NON_RTN_APP where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_RTN_APP to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_SALE
prompt ===========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST."UP_ST_TRF_BUF_QUEUE_SALE"
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_sale
--π¶ƒ‹√Ë ˆ£∫–£—È∑¢ €ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130807
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160801
--–ﬁ∏ƒ√Ë ˆ£∫º«¬º÷ÿ∏¥∏ƒŒ™“µŒÒ÷ÿ∏¥£¨¥ÌŒÛ¥˙¬Î42∏ƒŒ™50
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20160815
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20170418
--–ﬁ∏ƒ√Ë ˆ:(1)¿˙ ∑±Ì°¢¿˙ ∑±Ì∑÷±Ì≤È÷ÿ«¯∑÷÷ÿ±‡¬Îæ…ø®°¢–¬ø®°¢∑«÷ÿ±‡¬Îø®
--         £®2£©“µŒÒ≤È÷ÿ◊÷∂Œ”…¬ﬂº≠ø®∫≈∏ƒŒ™¬ﬂº≠ø®∫≈+ŒÔ¿Ìø®∫≈
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
isNeedCheckAgain varchar2(1);-- «∑Ò–Ë“™≤È—Ø÷ÿ±‡¬Î±Ì±Í ∂
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
---÷ÿ±‡¬Î±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È
isNeedCheckAgain :='0';
payModeId :='51';
----------------------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞ª∫¥Ê±Ì◊‘…Ì≤È÷ÿ
--”ÎŒƒº˛√˚≥∆–°µƒº«¬º±»Ωœ£¨’‚—˘Œƒº˛√˚≥∆–°µƒ÷ÿ∏¥º«¬º±£¡Ù£¨Œƒº˛√˚≥∆¥Ûµƒ÷ÿ∏¥º«¬º…æ≥˝
insert into T#ST_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM ST_BUF_SALE A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                          --∏ƒŒ™“µŒÒ÷ÿ∏¥≈–∂œ20160801
                          EXISTS
              (
                           SELECT 1
               FROM ST_BUF_SALE B
                           WHERE B.FILE_NAME < piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND
                                 A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND A.CARD_PHYSICAL_ID=B.CARD_PHYSICAL_ID
               );
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into T#ST_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM ST_BUF_SALE A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          --∏ƒŒ™“µŒÒ÷ÿ∏¥≈–∂œ20160801
                          EXISTS
              (
               SELECT 1
               FROM ST_QUE_SALE B
                           WHERE B.FILE_NAME < piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND
                                 A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND A.CARD_PHYSICAL_ID=B.CARD_PHYSICAL_ID
               );




--¥¢÷µ∆±∑÷÷ÿ±‡¬Î¥¢÷µ∆±°¢∑«÷ÿ±‡¬Î¥¢÷µ∆± 20170418
----∑«÷ÿ±‡¬Î¥¢÷µ∆±
insert into T#ST_BUF_SALE_AGAIN_NON(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM ST_BUF_SALE A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                not exists(
                           SELECT 1 FROM ACC_ST.ST_ACT_SVT_AGAIN B
                                                  WHERE A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID
                                                  AND A.CARD_PHYSICAL_ID =B.CARD_PHYSICAL_ID) ;
----÷ÿ±‡¬Îæ…¥¢÷µ∆±
insert into T#ST_BUF_SALE_AGAIN_NON(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM ST_BUF_SALE A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                 exists(
                           SELECT 1 FROM ACC_ST.ST_ACT_SVT_AGAIN B
                                                  WHERE A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                                   A.CARD_PHYSICAL_ID =B.CARD_PHYSICAL_ID AND
                                                  A.SALE_DATETIME <= B.AGAIN_TIME) ;

----÷ÿ±‡¬Î–¬¥¢÷µ∆±
insert into T#ST_BUF_SALE_AGAIN(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM ST_BUF_SALE A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                 exists(
                           SELECT 1 FROM ACC_ST.ST_ACT_SVT_AGAIN B
                                                  WHERE A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
                                                        A.CARD_PHYSICAL_ID =B.CARD_PHYSICAL_ID ) ;
--∑«÷ÿ±‡¬Î¥¢÷µ∆±
--µ±«∞¿˙ ∑±Ì≤È÷ÿ
insert into T#ST_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM T#ST_BUF_SALE_AGAIN_NON A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
               EXISTS
              (
                 SELECT 1 FROM ACC_ST_HIS.ST_HIS_SALE B
                          WHERE A.CARD_LOGICAL_ID = B.CARD_LOGICAL_ID AND A.CARD_PHYSICAL_ID=B.CARD_PHYSICAL_ID
               );
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from T#ST_BUF_SALE_AGAIN_NON
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           sale_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
       insert into T#ST_BUF_SALE_CHK(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM T#ST_BUF_SALE_AGAIN_NON A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                          A.sale_datetime <= dateMaxHis ;--∑«÷ÿ±‡¬Îø®
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_SALE_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_SALE_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_SALE_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_SALE
         execute immediate
         'insert into T#ST_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM T#ST_BUF_SALE_CHK A
          WHERE TABLE_NAME= :x AND
                EXISTS
              (
                 SELECT 1
               FROM ACC_ST_HIS.'||tableName||
               ' B WHERE A.CARD_LOGICAL_ID = B.CARD_LOGICAL_ID AND A.CARD_PHYSICAL_ID=B.CARD_PHYSICAL_ID )'
         using tableName;
      end loop;
      --∑«÷ÿ±‡¬Î¥¢÷µ∆±∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
 END IF;


--÷ÿ±‡¬Î¥¢÷µ∆±
--÷ÿ±‡¬Î¥¢÷µ∆±µ±«∞¿˙ ∑±Ì≤È÷ÿ
--≈–∂œ «∑Ò–Ë“™ π”√÷ÿ±‡¬Î±Ì≤È÷ÿ
SELECT COUNT(*) INTO rowcount FROM T#ST_BUF_SALE_AGAIN A;
IF( rowcount > 0 ) THEN--¥Ê‘⁄÷ÿ±‡¬Îø®
   insert into T#ST_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM T#ST_BUF_SALE_AGAIN A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo  and
                exists --»°¿˙ ∑±Ìµƒ∑¢ €º«¬º ±º‰¥Û”⁄÷ÿ±‡¬Î ±º‰º«¬º±»Ωœ
              (
                 SELECT 1 FROM ACC_ST_HIS.ST_HIS_SALE C WHERE A.CARD_LOGICAL_ID=C.CARD_LOGICAL_ID AND
                    EXISTS(SELECT 1 FROM ACC_ST.ST_ACT_SVT_AGAIN D WHERE C.CARD_LOGICAL_ID=D.CARD_LOGICAL_ID AND
                            A.CARD_PHYSICAL_ID=D.CARD_PHYSICAL_ID AND C.SALE_DATETIME>D.AGAIN_TIME )
               );


---------------------÷ÿ±‡¬Î¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from T#ST_BUF_SALE_AGAIN A
                     where A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo and
                           A.sale_datetime <= dateMaxHis ;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
       insert into T#ST_BUF_SALE_CHK(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM T#ST_BUF_SALE_AGAIN A
          WHERE A.FILE_NAME=piFileName AND A.BALANCE_WATER_NO=piBalanceWaterNo AND
                          A.sale_datetime <= dateMaxHis ;--÷ÿ±‡¬Îø®
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update T#ST_BUF_SALE_CHK a set a.table_name = (select trim(b.table_name) from st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date )
                                  where exists(select b.table_name from st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from T#ST_BUF_SALE_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_SALE_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_SALE
         execute immediate
         'insert into T#ST_BUF_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
          FROM T#ST_BUF_SALE_CHK A
          WHERE A.TABLE_NAME= :x AND
                EXISTS
              (
                 SELECT 1
               FROM ACC_ST_HIS.'||tableName||' B WHERE  A.CARD_LOGICAL_ID=B.CARD_LOGICAL_ID AND
               A.CARD_PHYSICAL_ID=B.CARD_PHYSICAL_ID AND EXISTS(SELECT 1 FROM ACC_ST.ST_ACT_SVT_AGAIN C
               WHERE A.CARD_LOGICAL_ID=C.CARD_LOGICAL_ID AND A.CARD_PHYSICAL_ID=C.CARD_PHYSICAL_ID AND
                            A.SALE_DATETIME>C.AGAIN_TIME )'||
               ')'
         using tableName;
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
END IF;--∞¥÷ÿ±‡¬Î¥¢÷µø®≤È÷ÿ£®Ω· ¯£©
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------
 --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_SALE;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ST_ERR_SALE(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG,'50'
          FROM T#ST_BUF_SALE;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ST_BUF_SALE
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                --CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||
                          --TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS') IN
                          --∏ƒŒ™“µŒÒ÷ÿ∏¥≈–∂œ20160801
                          CARD_LOGICAL_ID IN
              (
                 SELECT
--                           CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||
--                           TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS')
                             CARD_LOGICAL_ID
               FROM T#ST_BUF_SALE
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
  --≤ª∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '0'  then
     begin
        --À˘”–µº»Î∂”¡–±Ì
        insert into      ST_QUE_SALE( WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG)
     select    DISTINCT  WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                from ST_BUF_SALE
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
       --µº»Î∂”¡–±Ì
       insert into      ST_QUE_SALE( WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG)
    select      DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                from ST_BUF_SALE
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and
                                    CARD_APP_FLAG='0';
         --µº»Î≤‚ ‘±Ì
         insert into         ST_TST_SALE( WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG)
     select       DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,CARD_MAIN_ID ,CARD_SUB_ID,CARD_LOGICAL_ID,
               CARD_PHYSICAL_ID ,CARD_STATUS_ID ,WATER_NO_BUSINESS,SAM_LOGICAL_ID ,SAM_TRADE_SEQ,DEPOSIT_TYPE ,
               DEPOSIT_FEE,SALE_DATETIME,RECEIPT_ID ,OPERATOR_ID,SHIFT_ID ,AUXI_FEE ,CARD_APP_FLAG,BALANCE_WATER_NO ,
               FILE_NAME,CHECK_FLAG
                from ST_BUF_SALE
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and
                                    CARD_APP_FLAG='1';
      end;
  end if;
  ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ST_BUF_SALE where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_SALE to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_SALE_SJT
prompt ===============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_sale_sjt
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_sale_sjt
--π¶ƒ‹√Ë ˆ£∫–£—Èµ•≥Ã∆±∑¢ €ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130807
--–ﬁ∏ƒ’ﬂ:
--–ﬁ∏ƒ»’∆⁄: 20140415
--–ﬁ∏ƒ’ﬂ: HEJJ
--–ﬁ∏ƒ√Ë ˆ£∫À˘”–¥¶¿Ì‘ˆº”TAC_DEAL_TYPE,TAC_DEV_ID◊÷∂Œ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140430
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”≤‚ ‘∆±¥¶¿Ìπ¶ƒ‹
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”µ±«∞¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹/Œƒº˛ƒ⁄≤È÷ÿ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20140501
--–ﬁ∏ƒ√Ë ˆ£∫‘ˆº”¿˙ ∑±Ì∑÷±Ì≤È÷ÿπ¶ƒ‹
--–ﬁ∏ƒ»’∆⁄: 20140808
--–ﬁ∏ƒ√Ë ˆ£∫¿˙ ∑±Ì≤È÷ÿπ¶ƒ‹£∫Ωˆ≤ÈΩª“◊ ±º‰–°”⁄µ±«∞«ÂÀ„¡˜ÀÆ∫≈µƒº«¬º
--–ﬁ∏ƒ»’∆⁄: 20150302
--–ﬁ∏ƒ√Ë ˆ£∫µ±«∞¿˙ ∑±Ì≤È÷ÿ∏ƒŒ™÷±Ω” π”√À˜“˝œÓ
--–ﬁ∏ƒ’ﬂ: hejj
--–ﬁ∏ƒ»’∆⁄: 20161130
--–ﬁ∏ƒ√Ë ˆ£∫◊‘…Ì°¢∂”¡–°¢¿˙ ∑°¢∑÷±Ì≤È÷ÿ∑Ω∑®”…◊÷∂Œ¥Æ¡™∏ƒŒ™◊÷∂Œ∂‘”¶≈–∂œ
-------------------------------------------------------------------------------
is
rowCount int;
testControl varchar(1);
---¿˙ ∑∑÷±Ì≤È÷ÿ
tableName varchar(30);--∑÷±Ì√˚≥∆
dateMaxHis date;--∑÷±Ìµƒ◊Ó¥ÛΩ· ¯ ±º‰
isNeedCheckHisSub varchar2(1);-- «∑Ò–Ë“™≤È—Ø∑÷±Ì±Í ∂
payModeId  varchar(2);---Ωª“◊¿‡–Õ
csr sys_refcursor;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--ªÒ»°≤‚ ‘∆±øÿ÷∆±Í ∂
select cfg_value into testControl from ACC_ST.st_cfg_sys_base
                                  where cfg_key='business.test.control' and record_flag='0';
--…Ë÷√»± °÷µ
if testControl ='' then
   testControl :='1';
end if;
---¿˙ ∑∑÷±Ì≤È÷ÿ »± °÷µ≤ª–Ë≤È÷ÿ
isNeedCheckHisSub :='0';
payModeId :='50';
----------------------------------------------------------------------------------
----------------------------------TAC–£—È¥¶¿Ì----------------------------------------------------------------------
--ª∫¥ÊTAC¥ÌŒÛº«¬º
insert into ACC_ST.T#ST_ERR_SALE_SJT(CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,SALE_DATETIME,FILE_NAME,BALANCE_WATER_NO,ERR_CODE)
                select        CARD_MAIN_ID,CARD_SUB_ID,SAM_LOGICAL_ID,SAM_TRADE_SEQ,SALE_DATETIME,FILE_NAME,BALANCE_WATER_NO,ERR_CODE
                       FROM ACC_ST.ST_ERR_SALE_SJT
                       WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND ERR_CODE='41';
--¥”ª∫¥Ê±Ì÷–…æ≥˝TAC–£—È≤ªÕ®π˝µƒº«¬º
DELETE FROM ACC_ST.ST_BUF_SALE_SJT A
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(
                       SELECT 1 FROM ACC_ST.T#ST_ERR_SALE_SJT B
                                WHERE B.FILE_NAME=piFileName AND B.BALANCE_WATER_NO=piBalanceWaterNo AND B.ERR_CODE='41' AND
                                      A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                      A.SAM_LOGICAL_ID =B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                      A.SALE_DATETIME=B.SALE_DATETIME
                );
----------------------------------TAC–£—È¥¶¿ÌΩ· ¯----------------------------------------------------------------------
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
--µ±«∞∂”¡–±Ì≤È÷ÿ
insert into ACC_ST.T#ST_BUF_SALE_SJT(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
          FROM ACC_ST.ST_BUF_SALE_SJT A
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                EXISTS(
                   SELECT 1 FROM ACC_ST.ST_QUE_SALE_SJT B
                            WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                  A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                  A.SALE_DATETIME=B.SALE_DATETIME
                );
  --µ±«∞¿˙ ∑±Ì≤È÷ÿ
insert into ACC_ST.T#ST_BUF_SALE_SJT(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
          FROM ACC_ST.ST_BUF_SALE_SJT a
          WHERE --FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰

               SALE_DATETIME<TO_DATE(SUBSTR(piBalanceWaterNo,1,8),'YYYYMMDD') AND
               exists(
                   select * from acc_st_his.st_his_sale_sjt b
                            where a.card_main_id = b.card_main_id and a.card_sub_id = b.card_sub_id and
                                  a.sam_logical_id = b.sam_logical_id and a.sam_trade_seq = b.sam_trade_seq and
                                  a.sale_datetime = b.sale_datetime
               );
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ---------------------
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ(1°¢À˜“˝±Ì”–º«¬º 2°¢¥Ê‘⁄Ωª“◊ ±º‰–°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰÷Õ¡Ù ˝æ›)
select max(end_date) into dateMaxHis from ACC_ST.st_idx_trx_history
                       where recd_type=payModeId;
--ª∫¥Ê±Ì÷Õ¡Ù ˝æ› «∑Ò”––°”⁄◊Ó¥ÛÀ˜“˝±Ì ±º‰µƒ ˝æ›
if dateMaxHis is not null then
   select count(*) into rowcount from ACC_ST.st_buf_sale_sjt
                     where FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo and
                           sale_datetime <= dateMaxHis;
   if rowcount > 0 then
      isNeedCheckHisSub :='1';--–Ë“™‘⁄¿˙ ∑±Ì∑÷±Ì≤È÷ÿ
   end if;
end if;
----------≈–∂œ «∑Ò–Ë“™≤È÷ÿ£®Ω· ¯£©
if isNeedCheckHisSub = '1' then
    --–Ë“™≤È÷ÿ ˝æ›∑≈»Î¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©
    insert into ACC_ST.T#ST_BUF_SALE_SJT_CHK(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
          FROM ACC_ST.ST_BUF_SALE_SJT
                    WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                          sale_datetime <= dateMaxHis;
       ---»∑∂®≤È÷ÿ ˝æ› π”√µƒ∑÷±Ì√˚≥∆,∏˘æ›Ωª“◊ ±º‰‘⁄∑÷±Ìµƒ ±º‰«¯∂Œ
       update ACC_ST.T#ST_BUF_SALE_SJT_CHK a set a.table_name = (select trim(b.table_name) from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date )
                                  where exists(select b.table_name from ACC_ST.st_idx_trx_history b
                                                             where b.recd_type=payModeId and
                                                                   a.sale_datetime >= b.begin_date and
                                                                   a.sale_datetime <= b.end_date);
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ
      open csr for select distinct table_name from ACC_ST.T#ST_BUF_SALE_SJT_CHK
                                              where table_name is not null
                                              order by table_name;
      loop
         fetch csr into tableName;
         tableName :=trim(tableName);
         exit when csr%notfound;
         --¡Ÿ ±±Ì£®∑÷±Ì≤È÷ÿ£©T#ST_BUF_SALE_SJT_CHK÷ÿ∏¥º«¬º∑≈»Î¡Ÿ ±±Ì£®÷ÿ∏¥£©T#ST_BUF_SALE_SJT
         execute immediate
         'insert into ACC_ST.T#ST_BUF_SALE_SJT(
                              WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
                    SELECT    WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
          FROM ACC_ST.T#ST_BUF_SALE_SJT_CHK A
                    WHERE TABLE_NAME= :x AND
                    EXISTS(
                   SELECT 1 FROM ACC_ST_HIS.'||tableName||' B
                            WHERE A.CARD_MAIN_ID=B.CARD_MAIN_ID AND A.CARD_SUB_ID=B.CARD_SUB_ID AND
                                  A.SAM_LOGICAL_ID=B.SAM_LOGICAL_ID AND A.SAM_TRADE_SEQ=B.SAM_TRADE_SEQ AND
                                  A.SALE_DATETIME=B.SALE_DATETIME
                )'
         using tableName;
      end loop;
      --∞¥∑÷±Ì√˚≥∆≤È÷ÿ£®Ω· ¯£©
end if;
---------------------¿˙ ∑±Ì∑÷±Ì≤È÷ÿ£®Ω· ¯£©---------------------
  --------------------------------------------------Ω· ¯∂‘¡–±Ì°¢¿˙ ∑±Ì≤È÷ÿ-----------------------------------------------------------------
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_SALE_SJT;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ACC_ST.ST_ERR_SALE_SJT(
                             WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,ERR_CODE,TAC_DEAL_TYPE,TAC_DEV_ID
                            )
          SELECT   WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,'42',TAC_DEAL_TYPE,TAC_DEV_ID
          FROM ACC_ST.T#ST_BUF_SALE_SJT;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ACC_ST.ST_BUF_SALE_SJT
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢SAM¬ﬂº≠ø®∫≈°¢SAMø®Ωª“◊¡˜ÀÆ°¢Ωª“◊ ±º‰
                CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS') IN
              (
                 SELECT CARD_MAIN_ID||CARD_SUB_ID||SAM_LOGICAL_ID||SAM_TRADE_SEQ||TO_CHAR(SALE_DATETIME,'YYYYMMDDHH24MISS')
               FROM ACC_ST.T#ST_BUF_SALE_SJT
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
--µº»Î∂”¡–±Ì
if testControl = '0'  then
     begin
     --À˘”–µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_QUE_SALE_SJT(WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID)
    select       DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,--SALE_DATETIME
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                from ACC_ST.ST_BUF_SALE_SJT
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
     end;
  end if;
   --∂‘≤‚ ‘∆±Ãÿ ‚¥¶¿Ì
  if testControl = '1'  then
     begin
     --’˝ Ω∆±µº»Î∂”¡–±Ì
        insert into ACC_ST.ST_QUE_SALE_SJT(WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID)
    select        DISTINCT WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,--SALE_DATETIME
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                from ACC_ST.ST_BUF_SALE_SJT
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='0';
     --≤‚ ‘∆±µº»Î≤‚ ‘±Ì
      insert into ACC_ST.ST_TST_SALE_SJT(WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID)
    select    DISTINCT    WATER_NO ,LINE_ID,STATION_ID ,DEV_TYPE_ID,DEVICE_ID,
                              SAM_LOGICAL_ID ,SAM_TRADE_SEQ,SALE_DATETIME,PAY_TYPE ,CARD_LOGICAL_ID_PAY,--SALE_DATETIME
                CARD_TRADE_SEQ ,CARD_LOGICAL_ID,CARD_PHYSICAL_ID ,SALE_FEE ,CARD_MAIN_ID ,
                CARD_SUB_ID,ZONE_ID,TAC,DEPOSIT_TYPE ,DEPOSIT_FEE,OPERATOR_ID,SHIFT_ID ,
                BALANCE_WATER_NO ,FILE_NAME,CHECK_FLAG ,CARD_STATUS_ID ,AUXI_FEE ,CARD_COUNT_USED,
                CARD_APP_FLAG,TAC_DEAL_TYPE,TAC_DEV_ID
                from ACC_ST.ST_BUF_SALE_SJT
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName and CARD_APP_FLAG='1';
      end;
  end if;
   ------------------------------------------------Ω· ¯µº»Î∂”¡–±Ì--------------------------------------------------------
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ACC_ST.ST_BUF_SALE_SJT where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
   COMMIT;
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_SALE_SJT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_STL
prompt ==========================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_stl
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_stl
--π¶ƒ‹√Ë ˆ£∫–£—ÈLCC∂‘’À ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20131020
--–ﬁ∏ƒ’ﬂ:  hejj
--–ﬁ∏ƒ»’∆⁄: 20140622
--–ﬁ∏ƒ√Ë ˆ: ÷ÿ∏¥≈–∂œ‘ˆº”«ÂÀ„¡˜ÀÆ∫≈
--–ﬁ∏ƒ’ﬂ:hejj
--–ﬁ∏ƒ»’∆⁄: 20150410
--–ﬁ∏ƒ√Ë ˆ: ÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆£¨¥¶¿ÌLCC÷Õ¡Ù…œ¥´∂‘’ÀŒƒº˛Œ Ã‚°£
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_LCC(
                             WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,BOM_SALE_SJT_NUM,BOM_SALE_SJT_FEE,TVM_SALE_SJT_NUM,
               TVM_SALE_SJT_FEE,BOM_SALE_NUM,BOM_SALE_DEPOSIT_FEE,BOM_CHARGE_FEE,TVM_CHARGE_NUM,TVM_CHARGE_FEE,
               RETURN_NUM,RETURN_FEE,NON_RETURN_NUM,NON_RET_DEPOSIT_FEE,NON_RET_ACTUAL_RET_BALA,
               NEGATIVE_CHARGE_NUM,NEGATIVE_CHARGE_FEE,DEAL_NUM,DEAL_FEE,UPDATE_CASH_NUM,UPDATE_CASH_FEE,
               UPDATE_NONCASH_NUM,UPDATE_NONCASH_FEE,ADMIN_NUM,ADMIN_RETURN_FEE,ADMIN_PENALTY_FEE,FILE_NAME,CHECK_FLAG
                            )
          SELECT   WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,BOM_SALE_SJT_NUM,BOM_SALE_SJT_FEE,TVM_SALE_SJT_NUM,
               TVM_SALE_SJT_FEE,BOM_SALE_NUM,BOM_SALE_DEPOSIT_FEE,BOM_CHARGE_FEE,TVM_CHARGE_NUM,TVM_CHARGE_FEE,
               RETURN_NUM,RETURN_FEE,NON_RETURN_NUM,NON_RET_DEPOSIT_FEE,NON_RET_ACTUAL_RET_BALA,
               NEGATIVE_CHARGE_NUM,NEGATIVE_CHARGE_FEE,DEAL_NUM,DEAL_FEE,UPDATE_CASH_NUM,UPDATE_CASH_FEE,
               UPDATE_NONCASH_NUM,UPDATE_NONCASH_FEE,ADMIN_NUM,ADMIN_RETURN_FEE,ADMIN_PENALTY_FEE,FILE_NAME,CHECK_FLAG
          FROM ST_BUF_LCC
          WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸œﬂ¬∑°¢≥µ’æ°¢«ÂÀ„¡˜ÀÆ∫≈°¢Œƒº˛√˚≥∆
                LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME IN   --÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆20150410 by hejj
              (
                 SELECT LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME
               FROM ST_QUE_LCC
               );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_LCC;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
        insert into ST_ERR_LCC(
                             WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,BOM_SALE_SJT_NUM,BOM_SALE_SJT_FEE,TVM_SALE_SJT_NUM,
               TVM_SALE_SJT_FEE,BOM_SALE_NUM,BOM_SALE_DEPOSIT_FEE,BOM_CHARGE_FEE,TVM_CHARGE_NUM,TVM_CHARGE_FEE,
               RETURN_NUM,RETURN_FEE,NON_RETURN_NUM,NON_RET_DEPOSIT_FEE,NON_RET_ACTUAL_RET_BALA,
               NEGATIVE_CHARGE_NUM,NEGATIVE_CHARGE_FEE,DEAL_NUM,DEAL_FEE,UPDATE_CASH_NUM,UPDATE_CASH_FEE,
               UPDATE_NONCASH_NUM,UPDATE_NONCASH_FEE,ADMIN_NUM,ADMIN_RETURN_FEE,ADMIN_PENALTY_FEE,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
          SELECT   WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,BOM_SALE_SJT_NUM,BOM_SALE_SJT_FEE,TVM_SALE_SJT_NUM,
               TVM_SALE_SJT_FEE,BOM_SALE_NUM,BOM_SALE_DEPOSIT_FEE,BOM_CHARGE_FEE,TVM_CHARGE_NUM,TVM_CHARGE_FEE,
               RETURN_NUM,RETURN_FEE,NON_RETURN_NUM,NON_RET_DEPOSIT_FEE,NON_RET_ACTUAL_RET_BALA,
               NEGATIVE_CHARGE_NUM,NEGATIVE_CHARGE_FEE,DEAL_NUM,DEAL_FEE,UPDATE_CASH_NUM,UPDATE_CASH_FEE,
               UPDATE_NONCASH_NUM,UPDATE_NONCASH_FEE,ADMIN_NUM,ADMIN_RETURN_FEE,ADMIN_PENALTY_FEE,FILE_NAME,CHECK_FLAG,'42'
          FROM T#ST_BUF_LCC;
  --…æ≥˝÷ÿ∏¥º«¬º
        DELETE FROM ST_BUF_LCC
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
                ----–£—È÷˜º¸œﬂ¬∑°¢≥µ’æ°¢«ÂÀ„¡˜ÀÆ∫≈°¢Œƒº˛√˚≥∆
                LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME IN  --÷ÿ∏¥≈–∂œ‘ˆº”Œƒº˛√˚≥∆20150410 by hejj
              (
                 SELECT LINE_ID||STATION_ID||BALANCE_WATER_NO ||FILE_NAME
               FROM T#ST_BUF_LCC
               );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------

--µº»Î∂”¡–±Ì
  insert into      ST_QUE_LCC( WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,BOM_SALE_SJT_NUM,BOM_SALE_SJT_FEE,TVM_SALE_SJT_NUM,
               TVM_SALE_SJT_FEE,BOM_SALE_NUM,BOM_SALE_DEPOSIT_FEE,BOM_CHARGE_FEE,TVM_CHARGE_NUM,TVM_CHARGE_FEE,
               RETURN_NUM,RETURN_FEE,NON_RETURN_NUM,NON_RET_DEPOSIT_FEE,NON_RET_ACTUAL_RET_BALA,
               NEGATIVE_CHARGE_NUM,NEGATIVE_CHARGE_FEE,DEAL_NUM,DEAL_FEE,UPDATE_CASH_NUM,UPDATE_CASH_FEE,
               UPDATE_NONCASH_NUM,UPDATE_NONCASH_FEE,ADMIN_NUM,ADMIN_RETURN_FEE,ADMIN_PENALTY_FEE,FILE_NAME,CHECK_FLAG)
    select               WATER_NO,BALANCE_WATER_NO,LINE_ID,STATION_ID,BOM_SALE_SJT_NUM,BOM_SALE_SJT_FEE,TVM_SALE_SJT_NUM,
               TVM_SALE_SJT_FEE,BOM_SALE_NUM,BOM_SALE_DEPOSIT_FEE,BOM_CHARGE_FEE,TVM_CHARGE_NUM,TVM_CHARGE_FEE,
               RETURN_NUM,RETURN_FEE,NON_RETURN_NUM,NON_RET_DEPOSIT_FEE,NON_RET_ACTUAL_RET_BALA,
               NEGATIVE_CHARGE_NUM,NEGATIVE_CHARGE_FEE,DEAL_NUM,DEAL_FEE,UPDATE_CASH_NUM,UPDATE_CASH_FEE,
               UPDATE_NONCASH_NUM,UPDATE_NONCASH_FEE,ADMIN_NUM,ADMIN_RETURN_FEE,ADMIN_PENALTY_FEE,FILE_NAME,CHECK_FLAG
                from ST_BUF_LCC
                where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --  «Â≥˝ª∫¥Ê±Ì ˝æ›
  DELETE FROM ST_BUF_LCC where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;




   COMMIT;


   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_STL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_AUTBAL
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_autbal
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_autobal
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM◊‘∂ØΩ·¥Êª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160622
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_BUF_TVM_AUTO_BAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG               
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
					FROM ACC_ST.ST_BUF_TVM_AUTO_BAL 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢Ω·¥Êø™ º°¢Ω· ¯ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||
                           TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_QUE_TVM_AUTO_BAL
						   );
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_TVM_AUTO_BAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_ERR_TVM_AUTO_BAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG,'42'
					FROM ACC_ST.T#ST_BUF_TVM_AUTO_BAL;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_BUF_TVM_AUTO_BAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢Ω·¥Êø™ º°¢Ω· ¯ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||
                           TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||
                           TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_BUF_TVM_AUTO_BAL
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_QUE_TVM_AUTO_BAL( 
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
							  from ACC_ST.ST_BUF_TVM_AUTO_BAL
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_BUF_TVM_AUTO_BAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_AUTBAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_BAL
prompt ==============================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_bal
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_bal
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVMΩ·’Àª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160622
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_BUF_TVM_BAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG               
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
					FROM ACC_ST.ST_BUF_TVM_BAL 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢Ω·¥Êø™ º°¢Ω· ¯ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||
                           TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_QUE_TVM_BAL
						   );
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_TVM_BAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_ERR_TVM_BAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG,'42'
					FROM ACC_ST.T#ST_BUF_TVM_BAL;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_BUF_TVM_BAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢Ω·¥Êø™ º°¢Ω· ¯ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||
                           TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||
                           TO_CHAR(AUTO_BAL_DATETIME_BEGIN,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(AUTO_BAL_DATETIME_END,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_BUF_TVM_BAL
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_QUE_TVM_BAL( 
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,AUTO_BAL_DATETIME_BEGIN,
                             AUTO_BAL_DATETIME_END,SJT_SALE_FEE_TOTAL_1,SJT_SALE_FEE_TOTAL_2,CHARGE_FEE_TOTAL, 
                             NOTE_RECV_FEE_TOTAL,COIN_RECV_FEE_TOTAL,NOTE_RECV_FEE_REP_TOTAL,COIN_RECV_FEE_REP_TOTAL,
                             COIN_BAL_FEE_TOTAL,NOTE_BAL_FEE_TOTAL,NOTE_CHG_FEE_PUT_TOTAL_1,NOTE_CHG_FEE_PUT_TOTAL_2,
                             COIN_CHG_FEE_PUT_TOTAL_1,COIN_CHG_FEE_PUT_TOTAL_2,COIN_CHG_FEE_TOTAL_1,COIN_CHG_FEE_POP_TOTAL_2
                             ,NOTE_CHG_FEE_TOTAL_1,NOTE_CHG_FEE_TOTAL_2,COIN_CHG_FEE_BAL_TOTAL_1,COIN_CHG_FEE_BAL_TOTAL_2,
                             NOTE_CHG_FEE_BAL_TOTAL_1,NOTE_CHG_FEE_BAL_TOTAL_2,COIN_CHG_FEE_CLEAR_TOTAL_1,
                             COIN_CHG_FEE_CLEAR_TOTAL_2,COIN_CHG_FEE_BAL_SUM_TOTAL_1,COIN_CHG_FEE_BAL_SUM_TOTAL_2,
                             NOTE_RECAIM_CHG_NUM,NOTE_RECAIM_BAL_NUM,SJT_NUM_PUT_TOTAL_1,SJT_NUM_PUT_TOTAL_2,
                             SJT_NUM_SALE_TOTAL_1,SJT_NUM_SALE_TOTAL_2,SJT_NUM_CLEAR_TOTAL_1,SJT_NUM_CLEAR_TOTAL_2,
                             SJT_NUM_BAL_TOTAL_1,SJT_NUM_BAL_TOTAL_2,SJT_NUM_WASTE_TOTAL,TVM_BAL_FEE_TOTAL,BALANCE_WATER_NO,
                             FILE_NAME,CHECK_FLAG
							  from ACC_ST.ST_BUF_TVM_BAL
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_BUF_TVM_BAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_BAL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_CDCLR
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_cdclr
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_cdclr
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM∆±ø®«Âø’ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_CARD_CLEAR(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,CLEAR_DATETIME,WATER_NO_OP,
							 CARD_MAIN_ID_HOPPER_1,CARD_SUB_ID_HOPPER_1,CARD_MAIN_ID_HOPPER_2,CARD_SUB_ID_HOPPER_2,
							 HOPPER_1_NUM,HOPPER_2_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,CLEAR_DATETIME,WATER_NO_OP,
							 CARD_MAIN_ID_HOPPER_1,CARD_SUB_ID_HOPPER_1,CARD_MAIN_ID_HOPPER_2,CARD_SUB_ID_HOPPER_2,
							 HOPPER_1_NUM,HOPPER_2_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
					FROM ST_BUF_TVM_CARD_CLEAR 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢«Âø’ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                          
						   FROM ST_QUE_TVM_CARD_CLEAR
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_CARD_CLEAR;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_CARD_CLEAR(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,CLEAR_DATETIME,WATER_NO_OP,
							 CARD_MAIN_ID_HOPPER_1,CARD_SUB_ID_HOPPER_1,CARD_MAIN_ID_HOPPER_2,CARD_SUB_ID_HOPPER_2,
							 HOPPER_1_NUM,HOPPER_2_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,CLEAR_DATETIME,WATER_NO_OP,
							 CARD_MAIN_ID_HOPPER_1,CARD_SUB_ID_HOPPER_1,CARD_MAIN_ID_HOPPER_2,CARD_SUB_ID_HOPPER_2,
							 HOPPER_1_NUM,HOPPER_2_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_CARD_CLEAR;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_CARD_CLEAR
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢«Âø’ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                              IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                                  
						   FROM T#ST_BUF_TVM_CARD_CLEAR
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_CARD_CLEAR( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,CLEAR_DATETIME,WATER_NO_OP,
							 CARD_MAIN_ID_HOPPER_1,CARD_SUB_ID_HOPPER_1,CARD_MAIN_ID_HOPPER_2,CARD_SUB_ID_HOPPER_2,
							 HOPPER_1_NUM,HOPPER_2_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select              WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,CLEAR_DATETIME,WATER_NO_OP,
							 CARD_MAIN_ID_HOPPER_1,CARD_SUB_ID_HOPPER_1,CARD_MAIN_ID_HOPPER_2,CARD_SUB_ID_HOPPER_2,
							 HOPPER_1_NUM,HOPPER_2_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_CARD_CLEAR
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_CARD_CLEAR where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_CDCLR to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_CDPUT
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_cdput
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_cdput
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM∆±ø®¥Ê»Îª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_CARD_PUT(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,PUT_DATETIME,WATER_NO_OP,
							 BOX_ID,HOPPER_ID,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,PUT_DATETIME,WATER_NO_OP,
							 BOX_ID,HOPPER_ID,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
					FROM ST_BUF_TVM_CARD_PUT 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢∑≈»Î ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          
						   FROM ST_QUE_TVM_CARD_PUT
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_CARD_PUT;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_CARD_PUT(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,PUT_DATETIME,WATER_NO_OP,
							 BOX_ID,HOPPER_ID,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,PUT_DATETIME,WATER_NO_OP,
							 BOX_ID,HOPPER_ID,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_CARD_PUT;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_CARD_PUT
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢∑≈»Î ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                              IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                                  
						   FROM T#ST_BUF_TVM_CARD_PUT
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_CARD_PUT( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,PUT_DATETIME,WATER_NO_OP,
							 BOX_ID,HOPPER_ID,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,PUT_DATETIME,WATER_NO_OP,
							 BOX_ID,HOPPER_ID,CARD_MAIN_ID,CARD_SUB_ID,NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_CARD_PUT
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_CARD_PUT where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_CDPUT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_COCLR
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_coclr
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_coclear
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM”≤±“«Âø’ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_COIN_CLEAR(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,CLEAR_DATETIME,
							 WATER_NO_OP,HOPPER_1_UNIT_FEE,HOPPER_1_UNIT_NUM,HOPPER_2_UNIT_FEE,HOPPER_2_UNIT_NUM,
							 COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,COIN_FEE_7,COIN_FEE_8,
							 COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,COIN_NUM_7,COIN_NUM_8,
							 COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,CLEAR_DATETIME,
							 WATER_NO_OP,HOPPER_1_UNIT_FEE,HOPPER_1_UNIT_NUM,HOPPER_2_UNIT_FEE,HOPPER_2_UNIT_NUM,
							 COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,COIN_FEE_7,COIN_FEE_8,
							 COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,COIN_NUM_7,COIN_NUM_8,
							 COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
					FROM ST_BUF_TVM_COIN_CLEAR 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                          
						   FROM ST_QUE_TVM_COIN_CLEAR
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_COIN_CLEAR;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_COIN_CLEAR(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,CLEAR_DATETIME,
							 WATER_NO_OP,HOPPER_1_UNIT_FEE,HOPPER_1_UNIT_NUM,HOPPER_2_UNIT_FEE,HOPPER_2_UNIT_NUM,
							 COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,COIN_FEE_7,COIN_FEE_8,
							 COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,COIN_NUM_7,COIN_NUM_8,
							 COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,CLEAR_DATETIME,
							 WATER_NO_OP,HOPPER_1_UNIT_FEE,HOPPER_1_UNIT_NUM,HOPPER_2_UNIT_FEE,HOPPER_2_UNIT_NUM,
							 COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,COIN_FEE_7,COIN_FEE_8,
							 COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,COIN_NUM_7,COIN_NUM_8,
							 COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_COIN_CLEAR;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_COIN_CLEAR
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢»°≥ˆ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                              IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(CLEAR_DATETIME,'YYYYMMDDHH24MISS')
                                  
						   FROM T#ST_BUF_TVM_COIN_CLEAR
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_COIN_CLEAR( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,CLEAR_DATETIME,
							 WATER_NO_OP,HOPPER_1_UNIT_FEE,HOPPER_1_UNIT_NUM,HOPPER_2_UNIT_FEE,HOPPER_2_UNIT_NUM,
							 COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,COIN_FEE_7,COIN_FEE_8,
							 COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,COIN_NUM_7,COIN_NUM_8,
							 COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,CLEAR_DATETIME,
							 WATER_NO_OP,HOPPER_1_UNIT_FEE,HOPPER_1_UNIT_NUM,HOPPER_2_UNIT_FEE,HOPPER_2_UNIT_NUM,
							 COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,COIN_FEE_7,COIN_FEE_8,
							 COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,COIN_NUM_7,COIN_NUM_8,
							 COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_COIN_CLEAR
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_COIN_CLEAR where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_COCLR to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_CODATA
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_codata
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_codata
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM”≤±“œ‰ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_COIN_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,
							 COIN_FEE_7,COIN_FEE_8,COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,
							 COIN_NUM_7,COIN_NUM_8,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,
							 COIN_FEE_7,COIN_FEE_8,COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,
							 COIN_NUM_7,COIN_NUM_8,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_TVM_COIN_DATA 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢∑≈»Î°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_TVM_COIN_DATA
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_COIN_DATA;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_COIN_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,
							 COIN_FEE_7,COIN_FEE_8,COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,
							 COIN_NUM_7,COIN_NUM_8,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,
							 COIN_FEE_7,COIN_FEE_8,COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,
							 COIN_NUM_7,COIN_NUM_8,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_COIN_DATA;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_COIN_DATA
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢∑≈»Î°¢»°≥ˆ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                             ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||COIN_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                                  ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_TVM_COIN_DATA
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_COIN_DATA( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,
							 COIN_FEE_7,COIN_FEE_8,COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,
							 COIN_NUM_7,COIN_NUM_8,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,COIN_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,COIN_FEE_1,COIN_FEE_2,COIN_FEE_3,COIN_FEE_4,COIN_FEE_5,COIN_FEE_6,
							 COIN_FEE_7,COIN_FEE_8,COIN_NUM_1,COIN_NUM_2,COIN_NUM_3,COIN_NUM_4,COIN_NUM_5,COIN_NUM_6,
							 COIN_NUM_7,COIN_NUM_8,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_COIN_DATA
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_COIN_DATA where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_CODATA to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_COPUT
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_coput
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_coput
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM”≤±“¥Ê»Îª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_COIN_PUT(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,HOPPER_ID,OPERATOR_ID,PUT_DATETIME,
							 WATER_NO_OP,COIN_UNIT_FEE,COIN_NUM,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,HOPPER_ID,OPERATOR_ID,PUT_DATETIME,
							 WATER_NO_OP,COIN_UNIT_FEE,COIN_NUM,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
					FROM ST_BUF_TVM_COIN_PUT 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢∑≈»Î°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||HOPPER_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||HOPPER_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          
						   FROM ST_QUE_TVM_COIN_PUT
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_COIN_PUT;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_COIN_PUT(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,HOPPER_ID,OPERATOR_ID,PUT_DATETIME,
							 WATER_NO_OP,COIN_UNIT_FEE,COIN_NUM,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,HOPPER_ID,OPERATOR_ID,PUT_DATETIME,
							 WATER_NO_OP,COIN_UNIT_FEE,COIN_NUM,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_COIN_PUT;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_COIN_PUT
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢∑≈»Î°¢»°≥ˆ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||HOPPER_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                              IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||HOPPER_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                                  
						   FROM T#ST_BUF_TVM_COIN_PUT
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_COIN_PUT( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,HOPPER_ID,OPERATOR_ID,PUT_DATETIME,
							 WATER_NO_OP,COIN_UNIT_FEE,COIN_NUM,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,HOPPER_ID,OPERATOR_ID,PUT_DATETIME,
							 WATER_NO_OP,COIN_UNIT_FEE,COIN_NUM,COIN_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_COIN_PUT
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_COIN_PUT where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_COPUT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_CUTOFF
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_cutoff
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_cutoff
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM…Ûº∆ ˝æ›ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130809
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_CUTOFF_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,
							 CARD_PUT_NUM,CARD_CLEAR_NUM,COIN_PUT_NUM,COIN_PUT_FEE,COIN_CLEAR_NUM,
							 COIN_CLEAR_FEE,COIN_RECLAIM_NUM,COIN_RECLAIM_FEE,NOTE_RECLAIM_NUM,
							 NOTE_RECLAIM_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,
							 CARD_PUT_NUM,CARD_CLEAR_NUM,COIN_PUT_NUM,COIN_PUT_FEE,COIN_CLEAR_NUM,
							 COIN_CLEAR_FEE,COIN_RECLAIM_NUM,COIN_RECLAIM_FEE,NOTE_RECLAIM_NUM,
							 NOTE_RECLAIM_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_TVM_CUTOFF_TOTAL 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢µ±«∞ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						     IN
						  (
					       SELECT   LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						   
						   FROM ST_QUE_TVM_CUTOFF_TOTAL
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_CUTOFF_TOTAL;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_CUTOFF_TOTAL(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,
							 CARD_PUT_NUM,CARD_CLEAR_NUM,COIN_PUT_NUM,COIN_PUT_FEE,COIN_CLEAR_NUM,
							 COIN_CLEAR_FEE,COIN_RECLAIM_NUM,COIN_RECLAIM_FEE,NOTE_RECLAIM_NUM,
							 NOTE_RECLAIM_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,
							 CARD_PUT_NUM,CARD_CLEAR_NUM,COIN_PUT_NUM,COIN_PUT_FEE,COIN_CLEAR_NUM,
							 COIN_CLEAR_FEE,COIN_RECLAIM_NUM,COIN_RECLAIM_FEE,NOTE_RECLAIM_NUM,
							 NOTE_RECLAIM_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_CUTOFF_TOTAL;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_CUTOFF_TOTAL
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					     ----–£—È÷˜–£—È÷˜œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢µ±«∞ ±º‰
					        LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						     IN
						  (
					       SELECT 
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(CUR_DATETIME,'YYYYMMDDHH24MISS')
						    
						   FROM T#ST_BUF_TVM_CUTOFF_TOTAL
						   );
-----------------------------------------◊”º«¬º-----------------------------------------------------------------------						   
--÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì
  
        INSERT INTO ST_ERR_TVM_CUTOFF_DTL(WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
                                    BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE )
                             SELECT WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
							        BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
							 FROM ST_BUF_TVM_CUTOFF_DTL
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND WATER_NO IN
							       (SELECT WATER_NO FROM T#ST_BUF_TVM_CUTOFF_TOTAL);
  --	…æ≥˝÷ÿ∏¥º«¬º					  
        DELETE FROM ST_BUF_TVM_CUTOFF_DTL where  BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName AND WATER_NO IN
							       (SELECT WATER_NO FROM T#ST_BUF_TVM_CUTOFF_TOTAL);
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_CUTOFF_TOTAL( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,
							 CARD_PUT_NUM,CARD_CLEAR_NUM,COIN_PUT_NUM,COIN_PUT_FEE,COIN_CLEAR_NUM,
							 COIN_CLEAR_FEE,COIN_RECLAIM_NUM,COIN_RECLAIM_FEE,NOTE_RECLAIM_NUM,
							 NOTE_RECLAIM_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OP_DATE,CUR_DATETIME,
							 CARD_PUT_NUM,CARD_CLEAR_NUM,COIN_PUT_NUM,COIN_PUT_FEE,COIN_CLEAR_NUM,
							 COIN_CLEAR_FEE,COIN_RECLAIM_NUM,COIN_RECLAIM_FEE,NOTE_RECLAIM_NUM,
							 NOTE_RECLAIM_FEE,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_CUTOFF_TOTAL
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_CUTOFF_TOTAL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  --µº»Î◊”∂”¡–±Ì
  
  INSERT INTO ST_QUE_TVM_CUTOFF_DTL(WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
                                    BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG )
                             SELECT WATER_NO,TRADE_TYPE_ID,PAY_MODE_ID,CARD_MAIN_ID,CARD_SUB_ID,DEAL_NUM,DEAL_FEE,
							        BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							 FROM ST_BUF_TVM_CUTOFF_DTL
							 where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_CUTOFF_DTL where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
-------------------------------------------------------------------------------------------------------------------------  
 
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_CUTOFF to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_NTDATA
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_ntdata
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_ntdata
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM÷Ω±“œ‰ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_NOTE_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_FEE_2,NOTE_FEE_3,NOTE_FEE_4,NOTE_FEE_5,NOTE_FEE_6,
							 NOTE_FEE_7,NOTE_FEE_8,NOTE_FEE_9,NOTE_FEE_10,NOTE_FEE_11,NOTE_FEE_12,NOTE_FEE_13,NOTE_NUM_1,
							 NOTE_NUM_2,NOTE_NUM_3,NOTE_NUM_4,NOTE_NUM_5,NOTE_NUM_6,NOTE_NUM_7,NOTE_NUM_8,NOTE_NUM_9,
							 NOTE_NUM_10,NOTE_NUM_11,NOTE_NUM_12,NOTE_NUM_13,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_FEE_2,NOTE_FEE_3,NOTE_FEE_4,NOTE_FEE_5,NOTE_FEE_6,
							 NOTE_FEE_7,NOTE_FEE_8,NOTE_FEE_9,NOTE_FEE_10,NOTE_FEE_11,NOTE_FEE_12,NOTE_FEE_13,NOTE_NUM_1,
							 NOTE_NUM_2,NOTE_NUM_3,NOTE_NUM_4,NOTE_NUM_5,NOTE_NUM_6,NOTE_NUM_7,NOTE_NUM_8,NOTE_NUM_9,
							 NOTE_NUM_10,NOTE_NUM_11,NOTE_NUM_12,NOTE_NUM_13,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
					FROM ST_BUF_TVM_NOTE_DATA 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢∑≈»Î°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||NOTE_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||NOTE_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ST_QUE_TVM_NOTE_DATA
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_NOTE_DATA;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_NOTE_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_FEE_2,NOTE_FEE_3,NOTE_FEE_4,NOTE_FEE_5,NOTE_FEE_6,
							 NOTE_FEE_7,NOTE_FEE_8,NOTE_FEE_9,NOTE_FEE_10,NOTE_FEE_11,NOTE_FEE_12,NOTE_FEE_13,NOTE_NUM_1,
							 NOTE_NUM_2,NOTE_NUM_3,NOTE_NUM_4,NOTE_NUM_5,NOTE_NUM_6,NOTE_NUM_7,NOTE_NUM_8,NOTE_NUM_9,
							 NOTE_NUM_10,NOTE_NUM_11,NOTE_NUM_12,NOTE_NUM_13,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_FEE_2,NOTE_FEE_3,NOTE_FEE_4,NOTE_FEE_5,NOTE_FEE_6,
							 NOTE_FEE_7,NOTE_FEE_8,NOTE_FEE_9,NOTE_FEE_10,NOTE_FEE_11,NOTE_FEE_12,NOTE_FEE_13,NOTE_NUM_1,
							 NOTE_NUM_2,NOTE_NUM_3,NOTE_NUM_4,NOTE_NUM_5,NOTE_NUM_6,NOTE_NUM_7,NOTE_NUM_8,NOTE_NUM_9,
							 NOTE_NUM_10,NOTE_NUM_11,NOTE_NUM_12,NOTE_NUM_13,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_NOTE_DATA;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_NOTE_DATA
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸∆±ø®÷˜¿‡–Õ°¢◊”¿‡–Õ°¢œ‰∫≈°¢∑≈»Î°¢»°≥ˆ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||NOTE_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                             ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||NOTE_BOX_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                                  ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM T#ST_BUF_TVM_NOTE_DATA
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_NOTE_DATA( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_FEE_2,NOTE_FEE_3,NOTE_FEE_4,NOTE_FEE_5,NOTE_FEE_6,
							 NOTE_FEE_7,NOTE_FEE_8,NOTE_FEE_9,NOTE_FEE_10,NOTE_FEE_11,NOTE_FEE_12,NOTE_FEE_13,NOTE_NUM_1,
							 NOTE_NUM_2,NOTE_NUM_3,NOTE_NUM_4,NOTE_NUM_5,NOTE_NUM_6,NOTE_NUM_7,NOTE_NUM_8,NOTE_NUM_9,
							 NOTE_NUM_10,NOTE_NUM_11,NOTE_NUM_12,NOTE_NUM_13,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,PUT_DATETIME,
							 POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_FEE_2,NOTE_FEE_3,NOTE_FEE_4,NOTE_FEE_5,NOTE_FEE_6,
							 NOTE_FEE_7,NOTE_FEE_8,NOTE_FEE_9,NOTE_FEE_10,NOTE_FEE_11,NOTE_FEE_12,NOTE_FEE_13,NOTE_NUM_1,
							 NOTE_NUM_2,NOTE_NUM_3,NOTE_NUM_4,NOTE_NUM_5,NOTE_NUM_6,NOTE_NUM_7,NOTE_NUM_8,NOTE_NUM_9,
							 NOTE_NUM_10,NOTE_NUM_11,NOTE_NUM_12,NOTE_NUM_13,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_NOTE_DATA
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_NOTE_DATA where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_NTDATA to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_NTPOP
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_ntpop
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_ntpop
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM÷Ω±“’“¡„œ‰»°≥ˆª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160622
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_BUF_TVM_NOTE_CHG_POP(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,POP_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM_PUT,NOTE_NUM_CHG,NOTE_NUM_BAL,
                             NOTE_FEE_TOTAL_PUT,NOTE_FEE_TOTAL_CHG,NOTE_FEE_TOTAL_BAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG               
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,POP_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM_PUT,NOTE_NUM_CHG,NOTE_NUM_BAL,
                             NOTE_FEE_TOTAL_PUT,NOTE_FEE_TOTAL_CHG,NOTE_FEE_TOTAL_BAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG
					FROM ACC_ST.ST_BUF_TVM_NOTE_CHG_POP 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢¥Ê»Î ±º‰°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                                  ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_QUE_TVM_NOTE_CHG_POP
						   );
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_TVM_NOTE_CHG_POP;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_ERR_TVM_NOTE_CHG_POP(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,POP_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM_PUT,NOTE_NUM_CHG,NOTE_NUM_BAL,
                             NOTE_FEE_TOTAL_PUT,NOTE_FEE_TOTAL_CHG,NOTE_FEE_TOTAL_BAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,POP_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM_PUT,NOTE_NUM_CHG,NOTE_NUM_BAL,
                             NOTE_FEE_TOTAL_PUT,NOTE_FEE_TOTAL_CHG,NOTE_FEE_TOTAL_BAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG,'42'
					FROM ACC_ST.T#ST_BUF_TVM_NOTE_CHG_POP;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_BUF_TVM_NOTE_CHG_POP
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢¥Ê»Î ±º‰°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                                   ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_BUF_TVM_NOTE_CHG_POP
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_QUE_TVM_NOTE_CHG_POP( 
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,POP_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM_PUT,NOTE_NUM_CHG,NOTE_NUM_BAL,
                             NOTE_FEE_TOTAL_PUT,NOTE_FEE_TOTAL_CHG,NOTE_FEE_TOTAL_BAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,POP_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM_PUT,NOTE_NUM_CHG,NOTE_NUM_BAL,
                             NOTE_FEE_TOTAL_PUT,NOTE_FEE_TOTAL_CHG,NOTE_FEE_TOTAL_BAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG
							  from ACC_ST.ST_BUF_TVM_NOTE_CHG_POP
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_BUF_TVM_NOTE_CHG_POP where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_NTPOP to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_NTPUT
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_ntput
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_ntput
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM÷Ω±“œ‰¥Ê»Îª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160622
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_BUF_TVM_NOTE_CHG_PUT(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG               
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG
					FROM ACC_ST.ST_BUF_TVM_NOTE_CHG_PUT 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢¥Ê»Î ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_QUE_TVM_NOTE_CHG_PUT
						   );
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_TVM_NOTE_CHG_PUT;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_ERR_TVM_NOTE_CHG_PUT(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG,'42'
					FROM ACC_ST.T#ST_BUF_TVM_NOTE_CHG_PUT;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_BUF_TVM_NOTE_CHG_PUT
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢¥Ê»Î ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||TO_CHAR(PUT_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_BUF_TVM_NOTE_CHG_PUT
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_QUE_TVM_NOTE_CHG_PUT( 
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_TYPE,NOTE_BOX_ID,OPERATOR_ID,
                             PUT_DATETIME,WATER_NO_OP,NOTE_FEE,NOTE_NUM,NOTE_FEE_TOTAL,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG
							  from ACC_ST.ST_BUF_TVM_NOTE_CHG_PUT
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_BUF_TVM_NOTE_CHG_PUT where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_NTPUT to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_NTRCL
prompt ================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_ntrcl
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_ntrcl
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM÷Ω±“ªÿ ’œ‰»°≥ˆª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20160622
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into ACC_ST.T#ST_BUF_TVM_NOTE_RECLAIM(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,
                             POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_NUM_RECLAIM_1,NOTE_FEE_2,NOTE_NUM_RECLAIM_2,
                             NOTE_FEE_3,NOTE_NUM_RECLAIM_3,NOTE_FEE_4,NOTE_NUM_RECLAIM_4,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG               
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,
                             POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_NUM_RECLAIM_1,NOTE_FEE_2,NOTE_NUM_RECLAIM_2,
                             NOTE_FEE_3,NOTE_NUM_RECLAIM_3,NOTE_FEE_4,NOTE_NUM_RECLAIM_4,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG
					FROM ACC_ST.ST_BUF_TVM_NOTE_RECLAIM 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢¥Ê»Î ±º‰°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID
                                  ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.ST_QUE_TVM_NOTE_RECLAIM
						   );
  SELECT COUNT(*) INTO rowCount FROM ACC_ST.T#ST_BUF_TVM_NOTE_RECLAIM;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ACC_ST.ST_ERR_TVM_NOTE_RECLAIM(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,
                             POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_NUM_RECLAIM_1,NOTE_FEE_2,NOTE_NUM_RECLAIM_2,
                             NOTE_FEE_3,NOTE_NUM_RECLAIM_3,NOTE_FEE_4,NOTE_NUM_RECLAIM_4,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,
                             POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_NUM_RECLAIM_1,NOTE_FEE_2,NOTE_NUM_RECLAIM_2,
                             NOTE_FEE_3,NOTE_NUM_RECLAIM_3,NOTE_FEE_4,NOTE_NUM_RECLAIM_4,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG,'42'
					FROM ACC_ST.T#ST_BUF_TVM_NOTE_RECLAIM;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ACC_ST.ST_BUF_TVM_NOTE_RECLAIM
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸…Ë±∏±Í ∂°¢¥Ê»Î ±º‰°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID
                          ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS') IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID
                                   ||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
						   FROM ACC_ST.T#ST_BUF_TVM_NOTE_RECLAIM
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ACC_ST.ST_QUE_TVM_NOTE_RECLAIM( 
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,
                             POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_NUM_RECLAIM_1,NOTE_FEE_2,NOTE_NUM_RECLAIM_2,
                             NOTE_FEE_3,NOTE_NUM_RECLAIM_3,NOTE_FEE_4,NOTE_NUM_RECLAIM_4,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,NOTE_BOX_ID,OPERATOR_ID,
                             POP_DATETIME,WATER_NO_OP,NOTE_FEE_1,NOTE_NUM_RECLAIM_1,NOTE_FEE_2,NOTE_NUM_RECLAIM_2,
                             NOTE_FEE_3,NOTE_NUM_RECLAIM_3,NOTE_FEE_4,NOTE_NUM_RECLAIM_4,BALANCE_WATER_NO,FILE_NAME,
                             CHECK_FLAG
							  from ACC_ST.ST_BUF_TVM_NOTE_RECLAIM
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ACC_ST.ST_BUF_TVM_NOTE_RECLAIM where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_NTRCL to ACC_ST_APP;


prompt
prompt Creating procedure UP_ST_TRF_BUF_QUEUE_TVM_WCDDAT
prompt =================================================
prompt
CREATE OR REPLACE PROCEDURE ACC_ST.up_st_trf_buf_queue_tvm_wcddat
(
piBalanceWaterNo in varchar2,
piFileName in varchar2,
poRetCode out int,
 poRetMsg out varchar2 
)
---------------------------------------------------------------------------------
--π˝≥Ã√˚£∫  up_st_trf_buf_queue_tvm_wcddata
--π¶ƒ‹√Ë ˆ£∫–£—ÈTVM∑œ∆±œ‰ ˝æ›ª∫¥Ê±Ì ˝æ›º∞µº»ÎµΩ∂‘”¶µƒ∂”¡–±Ì
--≤Œ ˝£∫piBalanceWaterNo£∫«ÂÀ„¡˜ÀÆ∫≈
--      piFileName:Ωª“◊Œƒº˛√˚≥∆
--      poRetCode£∫0£∫≥…π¶ -1£∫ ß∞‹ 
--      poRetMsg£∫∑µªÿ¥˙¬ÎÀµ√˜
--¥¥Ω®’ﬂ£∫  hejj
--¥¥Ω®»’∆⁄£∫20130813
--–ﬁ∏ƒ’ﬂ:   
--–ﬁ∏ƒ»’∆⁄: 
--–ﬁ∏ƒ’ﬂ: 
-------------------------------------------------------------------------------
is
rowCount int;
begin
poRetCode :=0;
poRetMsg :='÷¥––≥…π¶'||'«ÂÀ„¡˜ÀÆ£∫'||piBalanceWaterNo||' Œƒº˛√˚≥∆:'||piFileName;
--–£—È
--÷ÿ∏¥–‘–£—È
--”Î∂”¡–±Ìº«¬º
--≈–∂œ «∑Ò”–÷ÿ∏¥º«¬º
-------------------------------------÷ÿ∏¥–£—È------------------------------------------------------------------------
insert into T#ST_BUF_TVM_WASTE_CARD_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,WATER_NO_OP,
							 SJT_NUM,SJT_DISCOUNT_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,WATER_NO_OP,
							 SJT_NUM,SJT_DISCOUNT_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG 
					FROM ST_BUF_TVM_WASTE_CARD_DATA 
					WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢»°≥ˆ ±º‰
					      LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                           IN
						  (
					       SELECT LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                          
						   FROM ST_QUE_TVM_WASTE_CARD_DATA
						   );
  SELECT COUNT(*) INTO rowCount FROM T#ST_BUF_TVM_WASTE_CARD_DATA;
  IF rowCount != 0 THEN
     BEGIN
  --÷ÿ∏¥º«¬º≤Â»Î¥ÌŒÛ±Ì					   
        insert into ST_ERR_TVM_WASTE_CARD_DATA(
                             WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,WATER_NO_OP,
							 SJT_NUM,SJT_DISCOUNT_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,ERR_CODE
                            )
					SELECT   WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,WATER_NO_OP,
							 SJT_NUM,SJT_DISCOUNT_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG,'42'
					FROM T#ST_BUF_TVM_WASTE_CARD_DATA;
  --…æ≥˝÷ÿ∏¥º«¬º				
        DELETE FROM ST_BUF_TVM_WASTE_CARD_DATA
                         WHERE FILE_NAME=piFileName AND BALANCE_WATER_NO=piBalanceWaterNo AND
					      ----–£—È÷˜º¸œﬂ¬∑≥µ’æ°¢…Ë±∏¿‡–Õ°¢…Ë±∏±‡¬Î°¢≤Ÿ◊˜¡˜ÀÆ°¢»°≥ˆ ±º‰
					         LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                              IN
						  (
					       SELECT  LINE_ID||STATION_ID||DEV_TYPE_ID||DEVICE_ID||WATER_NO_OP||TO_CHAR(POP_DATETIME,'YYYYMMDDHH24MISS')
                                  
						   FROM T#ST_BUF_TVM_WASTE_CARD_DATA
						   );
     END;
  END IF;
  -------------------------------------÷ÿ∏¥–£—ÈΩ· ¯------------------------------------------------------------------------------
  
--µº»Î∂”¡–±Ì
  insert into      ST_QUE_TVM_WASTE_CARD_DATA( WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,WATER_NO_OP,
							 SJT_NUM,SJT_DISCOUNT_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG)
		select               WATER_NO,LINE_ID,STATION_ID,DEV_TYPE_ID,DEVICE_ID,OPERATOR_ID,POP_DATETIME,WATER_NO_OP,
							 SJT_NUM,SJT_DISCOUNT_NUM,BALANCE_WATER_NO,FILE_NAME,CHECK_FLAG
							  from ST_BUF_TVM_WASTE_CARD_DATA
							  where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
 --	«Â≥˝ª∫¥Ê±Ì ˝æ›					  
  DELETE FROM ST_BUF_TVM_WASTE_CARD_DATA where BALANCE_WATER_NO=piBalanceWaterNo and FILE_NAME=piFileName;
  
  
  
  
   COMMIT;
   
   
   EXCEPTION
   WHEN OTHERS THEN
   BEGIN
      poRetCode :=-1;
      poRetMsg :='¥ÌŒÛ¥˙¬Î£∫'||sqlcode||' ¥ÌŒÛœ˚œ¢£∫'||sqlerrm;
      ROLLBACK;
   END;
end;
/
grant execute on ACC_ST.UP_ST_TRF_BUF_QUEUE_TVM_WCDDAT to ACC_ST_APP;



spool off

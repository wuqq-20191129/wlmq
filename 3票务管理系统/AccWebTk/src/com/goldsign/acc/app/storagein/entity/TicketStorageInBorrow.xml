<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.goldsign.acc.app.storagein.mapper.TicketStorageInBorrowMapper">
    <resultMap id="rmBorrowInBill" type="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBill" >
        <result column="bill_no" property="bill_no" /> 
        <result column="in_bill_no" property="in_bill_no" /> 
        <result column="lend_bill_no" property="lend_bill_no" /> 
        <result column="bill_date" property="bill_date" /> 
        <result column="return_man" property="return_man" /> 
        <result column="receive_man" property="receive_man" /> 
        <result column="unit_id" property="unit_id" /> 
        <result column="remark" property="remark" /> 
        <result column="record_flag" property="record_flag" /> 
        <result column="verify_date" property="verify_date" /> 
        <result column="verify_person" property="verify_person" /> 
        <result column="record_in_flag" property="record_in_flag" />  
    </resultMap>
    <resultMap id="rmBorrowInBillDetail" type="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail" >
        <result column="bill_no" property="bill_no" /> 
        <result column="water_no" property="water_no" />
        <result column="lend_water_no" property="lend_water_no" />
        <result column="record_flag" property="record_flag" />
        <result column="storage_id" property="storage_id" /> 
        <result column="area_id" property="area_id" /> 
        <result column="ic_main_type" property="ic_main_type" /> 
        <result column="ic_sub_type" property="ic_sub_type" /> 
        <result column="start_box_id" property="start_box_id" /> 
        <result column="end_box_id" property="end_box_id" /> 
        <result column="start_logical_id" property="start_logical_id" /> 
        <result column="end_logical_id" property="end_logical_id" /> 
        <result column="valid_date" property="valid_date" /> 
        <result column="card_money" property="card_money" /> 
        <result column="line_id" property="line_id" /> 
        <result column="station_id" property="station_id" /> 
        <result column="return_quantity" property="return_quantity" /> 
        <result column="not_quantity" property="not_quantity" /> 
        <result column="exit_line_id" property="exit_line_id" /> 
        <result column="exit_station_id" property="exit_station_id" /> 
        <result column="model" property="model" /> 
    </resultMap>
    <resultMap id="rmBorrowInDetail" type="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowInDetail" >
        <result column="bill_no" property="bill_no" /> 
        <result column="water_no" property="water_no" />
        <result column="record_flag" property="record_flag" />
        <result column="storage_id" property="storage_id" /> 
        <result column="area_id" property="area_id" /> 
        <result column="ic_main_type" property="ic_main_type" /> 
        <result column="ic_sub_type" property="ic_sub_type" /> 
        <result column="TICKETTYPE_ID" property="TICKETTYPE_ID" /> 
        <result column="detail_place" property="detail_place" /> 
        <result column="start_box_id" property="start_box_id" /> 
        <result column="end_box_id" property="end_box_id" /> 
        <result column="start_logical_id" property="start_logical_id" /> 
        <result column="end_logical_id" property="end_logical_id" /> 
        <result column="valid_date" property="valid_date" /> 
        <result column="card_money" property="card_money" /> 
        <result column="line_id" property="line_id" /> 
        <result column="station_id" property="station_id" /> 
        <result column="in_num" property="in_num" />
        <result column="use_flag" property="use_flag" />  
        <result column="report_date" property="report_date" />  
        <result column="card_ava_days" property="card_ava_days" />  
        <result column="exit_line_id" property="exit_line_id" /> 
        <result column="exit_station_id" property="exit_station_id" /> 
        <result column="model" property="model" /> 
        <result column="line_id_reclaim" property="line_id_reclaim" /> 
        <result column="station_id_reclaim" property="station_id_reclaim" />
    </resultMap>
    <parameterMap type="map" id="AddInBillMap">  
        <parameter property="pi_lend_bill_no" jdbcType="VARCHAR" mode="IN"/>  
        <parameter property="pi_in_type" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="pi_receive_man" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="pi_return_man" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="pi_remark" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="po_bill_no" jdbcType="VARCHAR" mode="OUT"/> 
        <parameter property="po_errmsg" jdbcType="VARCHAR" mode="OUT"/>  
        <parameter property="po_result" jdbcType="INTEGER" mode="OUT"/>  
        <parameter property="po_memo" jdbcType="VARCHAR" mode="OUT"/>  
    </parameterMap>
    <parameterMap type="map" id="getMaxReturnNumMap">  
        <parameter property="pi_waterNo" jdbcType="INTEGER" mode="IN"/>  
        <parameter property="po_result" jdbcType="INTEGER" mode="OUT"/>  
    </parameterMap>
    <parameterMap type="map" id="AuditInBorrowBillMap">  
        <parameter property="pi_type" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="pi_related_bill_no" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="pi_operator_id" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="po_bill_no" jdbcType="VARCHAR" mode="OUT"/> 
        <parameter property="po_errmsg" jdbcType="VARCHAR" mode="OUT"/>  
        <parameter property="po_result" jdbcType="INTEGER" mode="OUT"/>  
        <parameter property="po_memo" jdbcType="VARCHAR" mode="OUT"/>  
    </parameterMap>
    <parameterMap type="map" id="AuditInBillMap">  
        <parameter property="pi_bill_no" jdbcType="VARCHAR" mode="IN"/> 
        <parameter property="pi_operator_id" jdbcType="VARCHAR" mode="IN"/>  
        <parameter property="po_errmsg" jdbcType="VARCHAR" mode="OUT"/> 
        <parameter property="po_result" jdbcType="INTEGER" mode="OUT"/>  
        <parameter property="po_memo" jdbcType="VARCHAR" mode="OUT"/>   
        <parameter property="po_bill_no" jdbcType="VARCHAR" mode="OUT"/> 
    </parameterMap>
     <resultMap type="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowInDetail" id="rmIcIdxHistory">
         <result column="bill_no" property="bill_no" /> 
         <result column="record_flag" property="record_flag" />
        <result column="his_table" property="his_table" />  
    </resultMap>
    <select id="queryBorrowBill"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBill" resultMap="rmBorrowInBill">
        select a.bill_no,a.lend_bill_no,a.in_bill_no ,a.bill_date,a.return_man,a.receive_man ,a.unit_id,a.remark,
        a.record_flag,a.verify_person ,a.verify_date,b.record_flag record_in_flag 
        from w_acc_tk.w_ic_in_return_bill a , w_acc_tk.w_ic_in_store_bill b
        where a.in_bill_no=b.bill_no(+) and delete_flag = '0'
        <!--主表查询条件-->
        <if test="bill_no !=null and bill_no !=''">
            and A.bill_no like '%${bill_no}%'
        </if>  
        <if test="lend_bill_no !=null and lend_bill_no !=''">
            and A.lend_bill_no like '%${lend_bill_no}%'
        </if>
        <if test="in_bill_no !=null and in_bill_no !=''">
            and A.in_bill_no like '%${in_bill_no}%'
        </if>         
        <if test="record_flag !=null and record_flag !=''">
            and A.record_flag =#{record_flag}
        </if>
        <if test="bill_date_begin !=null and bill_date_begin !=''">
            and A.bill_date &gt;= to_date(#{bill_date_begin},'yyyy-mm-dd  hh24:mi:ss')
        </if>
        <if test="bill_date_end !=null and bill_date_end !=''">
            and A.bill_date &lt;= to_date(#{bill_date_end},'yyyy-mm-dd  hh24:mi:ss')
        </if>

        and exists(select c.bill_no from w_acc_tk.w_ic_in_return_bill_detail c
        where c.bill_no=a.bill_no  
        <if test="ic_main_type !=null and ic_main_type !=''">
            and trim(c.ic_main_type) =#{ic_main_type}
        </if>
        
        <if test="ic_sub_type !=null and ic_sub_type !=''">
            and trim(c.ic_sub_type) =#{ic_sub_type}
        </if>
        and c.storage_id  in
        <foreach item="storageId" index="index" collection="storageIdList" open="(" separator="," close=")">
            #{storageId}
        </foreach> 
        )
        order by A.bill_no desc
    </select>
    <select id="queryBorrowBillDetail"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail" resultMap="rmBorrowInBillDetail">
        select bill_no, water_no,lend_water_no,'${record_flag}' record_flag,storage_id,area_id,ic_main_type,
        ic_sub_type, start_box_id, end_box_id,start_logical_id,end_logical_id, case when to_char(valid_date,'yyyy-mm-dd')  = '1970-01-01' then '' 
        else to_char(valid_date,'yyyy-mm-dd') end valid_date,
        card_money, line_id, station_id,return_quantity, not_quantity,lost_quantity,
        exit_line_id,exit_station_id,model
        from w_acc_tk.w_ic_in_return_bill_detail
        where bill_no = #{bill_no}
        and delete_flag = '0'
        order by lend_water_no
    </select>  
    <select id="addInBill" parameterMap="AddInBillMap" statementType="CALLABLE">
        {call w_acc_tk.W_UP_IC_IN_ADD_GH(?,?,?,?,?,?,?,?,?)}
    </select>
    <select id="getDetailRecordNum"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBill" resultType="java.lang.String">
        select  count(1)  from w_acc_tk.W_ic_in_return_bill_detail
        where bill_no=#{bill_no} and delete_flag = '0' 
    </select>
    <update id="updateReturnFlag"  parameterType="java.lang.String">
        update w_acc_tk.w_ic_out_lend_bill a 
        set a.return_flag = '0'
        where a.bill_no = (select b.lend_bill_no
        from w_acc_tk.w_ic_in_return_bill b
        where b.bill_no = '${value}'
        group by b.lend_bill_no)
    </update>
    <update id="updateDeleteFlag"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBill">
        update w_acc_tk.w_ic_in_return_bill 
        set delete_flag = '1'
        where bill_no =  #{bill_no}
    </update>
    <select id="getMaxReturnNum" parameterMap="getMaxReturnNumMap" statementType="CALLABLE">
        {call w_acc_tk.W_UP_IC_IN_RETURN_MAX(?,?)}
    </select>
    <select id="getCurrentData"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail" resultMap="rmBorrowInBillDetail">
        select water_no,start_logical_id,end_logical_id  from w_acc_tk.w_ic_in_return_bill_detail
        where water_no=#{water_no}
    </select>
    <update id="modifyPlanDetailForId"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail">
        update w_acc_tk.w_ic_in_return_bill_detail
        set sum_quantity     = #{return_quantity},
        notback_quantity = 0,
        return_quantity  = #{return_quantity},
        area_id          = #{area_id},
        not_quantity     = #{not_quantity},
        lost_quantity    = #{lost_quantity},
        start_logical_id = #{start_logical_id},
        end_logical_id   = #{end_logical_id}
        where water_no = #{water_no}
    </update>
    <update id="modifyPlanDetail"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail">
        update w_acc_tk.w_ic_in_return_bill_detail
        set notback_quantity = sum_quantity - #{return_quantity} - #{not_quantity} - #{lost_quantity},
        return_quantity  = #{return_quantity},
        area_id          = #{area_id},
        not_quantity     = #{not_quantity},
        lost_quantity    = #{lost_quantity},
        start_logical_id = #{start_logical_id},
        end_logical_id   = #{end_logical_id}
        where water_no = #{water_no}
    </update>
    <insert id="insertNewStartSectionForDetail" parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail">
        insert into w_acc_tk.w_ic_in_return_bill_detail
        (water_no, bill_no,storage_id,area_id,ic_main_type,
        ic_sub_type, return_quantity,not_quantity,lost_quantity, sum_quantity,
        notback_quantity, card_money,valid_date, line_id,station_id,
        start_box_id, end_box_id,  start_logical_id, end_logical_id, lend_water_no,
        box_flag, exit_line_id, exit_station_id, model,delete_flag)
        select 
        w_acc_tk.w_seq_w_ic_in_return_bill_dtl.nextval,bill_no,storage_id,area_id, ic_main_type,
        ic_sub_type, #{return_quantity}, 0, 0, #{sum_quantity}, 
        0, card_money,valid_date, line_id, station_id,
        start_box_id, end_box_id,#{start_logical_id},end_logical_id,lend_water_no,
        box_flag,exit_line_id,exit_station_id, model, '0'  
        from w_acc_tk.w_ic_in_return_bill_detail where water_no = #{water_no}
    </insert>
    <insert id="insertNewEndSectionForDetail" parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail">
        insert into w_acc_tk.w_ic_in_return_bill_detail
        (water_no, bill_no,storage_id,area_id,ic_main_type,
        ic_sub_type, return_quantity,not_quantity,lost_quantity, sum_quantity,
        notback_quantity, card_money,valid_date, line_id,station_id,
        start_box_id, end_box_id,  start_logical_id, end_logical_id, lend_water_no,
        box_flag, exit_line_id, exit_station_id, model,delete_flag)
        select 
        w_acc_tk.w_seq_w_ic_in_return_bill_dtl.nextval,bill_no,storage_id,area_id, ic_main_type,
        ic_sub_type, #{return_quantity}, 0, 0, #{sum_quantity}, 
        0, card_money,valid_date, line_id, station_id,
        start_box_id, end_box_id,start_logical_id,#{end_logical_id},lend_water_no,
        box_flag,exit_line_id,exit_station_id, model, '0'  
        from w_acc_tk.w_ic_in_return_bill_detail where water_no = #{water_no}
    </insert>
    <select id="getLendQuantity"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail" resultType="int">
        select nvl(sum(lend_quantity), 0)  
        from w_acc_tk.w_ic_in_return_bill b, w_acc_tk.w_ic_out_lend_bill_detail c
        where b.bill_no = #{bill_no}
        and b.lend_bill_no = c.bill_no
    </select>
    <select id="getLendBillNo"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail" resultType="java.lang.String">
        select lend_bill_no
        from w_acc_tk.w_ic_in_return_bill b, w_acc_tk.w_ic_out_lend_bill_detail c
        where b.bill_no = #{bill_no}
        and b.lend_bill_no = c.bill_no
        group by lend_bill_no
    </select>
    <select id="getReturnQuantity"  parameterType="java.lang.String" resultType="int">
        select nvl(sum(return_quantity + not_quantity + lost_quantity), 0) 
        from w_acc_tk.w_ic_in_return_bill_detail a, w_acc_tk.w_ic_in_return_bill b
        where a.bill_no = b.bill_no
        and b.lend_bill_no = #{value}
        
    </select>
    <update id="updateReturnFlagTrue"  parameterType="java.lang.String">
        update w_acc_tk.w_ic_out_lend_bill set return_flag='1' where bill_no='${value}'
    </update>
    <update id="updateReturnFlagFalse"  parameterType="java.lang.String">
        update w_acc_tk.w_ic_out_lend_bill set return_flag='0' where bill_no='${value}'
    </update>
    <select id="getBoxFlag"  parameterType="java.lang.String" resultType="java.lang.String">
        select box_flag from w_acc_tk.w_ic_in_return_bill_detail where  water_no = #{value}
    </select>
    <select id="getLendNumFromDetailBox"  parameterType="java.lang.String" resultType="int">
        select section_num as lend_num from w_acc_tk.w_ic_out_bill_detail_box where water_no_pk = #{value}
    </select>
    <select id="getLendNumFromDetail"  parameterType="java.lang.String" resultType="int">
        select out_num as lend_num from w_acc_tk.w_ic_out_bill_detail where water_no = #{value}
    </select>
    <select id="getRetunTotal"  parameterType="java.lang.String" resultType="int">
        select sum(return_quantity+not_quantity+lost_quantity)  from w_acc_tk.w_ic_in_return_bill_detail where lend_water_no = #{value}
        and delete_flag = '0'
    </select>
    <select id="queryReturnDetail"  parameterType="java.lang.String" resultMap="rmBorrowInBillDetail">
        select bill_no,water_no,lend_water_no,storage_id  ,area_id ,ic_main_type ,
        ic_sub_type ,start_box_id,end_box_id ,start_logical_id ,end_logical_id ,
        case when to_char(valid_date,'yyyy-mm-dd')  = '1970-01-01' then '' 
        else to_char(valid_date,'yyyy-mm-dd') end valid_date,card_money ,line_id ,station_id ,return_quantity,not_quantity,
        lost_quantity,exit_line_id,exit_station_id,model 
        from w_acc_tk.w_ic_in_return_bill_detail 
        where lend_water_no = #{value}
        and delete_flag = '0' order by lend_water_no
    </select> 
    <update id="deletePlanDetail"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail">
        update w_acc_tk.w_ic_in_return_bill_detail 
        set 
        notback_quantity = return_quantity+not_quantity+lost_quantity,
        delete_flag = '1',
        return_quantity=0,
        not_quantity=0,
        lost_quantity=0
        where water_no =  #{water_no}
    </update>
    <select id="getReturnNum"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowBillDetail" resultType="int">
        select nvl(sum(notback_quantity),0) 
        from w_acc_tk.w_ic_in_return_bill_detail 
        where  bill_no=#{bill_no}
    </select> 
    <select id="auditInBorrowBill" parameterMap="AuditInBorrowBillMap" statementType="CALLABLE">
        {call w_acc_tk.W_UP_IC_IN_AUDIT_GH(?,?,?,?,?,?,?)}
    </select>
    <select id="getInBillDetail"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowInDetail" resultMap="rmBorrowInDetail">
        select water_no, bill_no,reason_id,'${record_flag}' record_flag,storage_id, area_id,
        ic_main_type,ic_sub_type,TICKETTYPE_ID, detail_place,start_box_id,
        end_box_id,start_logical_id,end_logical_id,
        case when to_char(valid_date,'yyyy-mm-dd')  = '1970-01-01' then '' 
        else to_char(valid_date,'yyyy-mm-dd') end valid_date,
        card_money,
        line_id, station_id,in_num, use_flag,report_date,
        card_ava_days,exit_line_id,  exit_station_id, model, line_id_reclaim,
        station_id_reclaim
        from w_acc_tk. w_ic_in_store_detail
        where bill_no = #{bill_no}
        order by water_no,bill_no,use_flag, start_box_id,end_box_id,
        start_logical_id,end_logical_id
    </select>  
    <select id="auditInBill" parameterMap="AuditInBillMap" statementType="CALLABLE">
        {call w_acc_tk.W_UP_IC_IN_AUDIT_JR(?,?,?,?,?,?)}
    </select>
    <select id="getHistory"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowInDetail" resultMap="rmIcIdxHistory">
        select his_table ,'${bill_no}' bill_no,'0' record_flag from w_acc_tk.w_ic_idx_history where origin_table_name='w_ic_in_store_detail' and 
        substr('${bill_no}',3,10) between begin_recd and end_recd
    </select>  
    <select id="getQueryHis"  parameterType="com.goldsign.acc.app.storagein.entity.TicketStorageInBorrowInDetail" resultMap="rmBorrowInDetail">
        select water_no, bill_no,reason_id,'${record_flag}' record_flag,storage_id, area_id,
        ic_main_type,ic_sub_type,TICKETTYPE_ID, detail_place,start_box_id,
        end_box_id,start_logical_id,end_logical_id,
        case when to_char(valid_date,'yyyy-mm-dd')  = '1970-01-01' then '' 
        else to_char(valid_date,'yyyy-mm-dd') end valid_date,
        card_money,
        line_id, station_id,in_num, use_flag,report_date,
        card_ava_days,exit_line_id,  exit_station_id, model, line_id_reclaim,
        station_id_reclaim
        from w_acc_tk.${his_table}
        where bill_no = #{bill_no}
        order by water_no,bill_no,use_flag, start_box_id,end_box_id,
        start_logical_id,end_logical_id
    </select>  
</mapper>
